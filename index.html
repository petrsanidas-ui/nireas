<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P_eq Screening Tool (NIREAS) - 3D/2D</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.113/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    body{
      font-family:'Segoe UI', Arial, sans-serif;
      background:#eef2f3;
      padding:20px;
      color:#333;
      margin:0;
    }

    /* Layout */
    .layout{
      display:flex;
      gap:20px;
      align-items:flex-start;
      justify-content:center;
      width:100%;
    }

    /* LEFT PANEL */
    #basinPanel{
      width:410px;
      max-height:calc(100vh - 40px);
      overflow-y:auto;
      background:white;
      z-index:10;
      box-shadow:0 0 15px rgba(0,0,0,0.2);
      border-radius:8px;
      font-size:11px;
      border:1px solid #ccc;
      position:sticky;
      top:10px;
      align-self:flex-start;
    }

    .bp-head{
      background:#2c3e50;
      color:white;
      padding:8px;
      font-weight:bold;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-top-left-radius:8px;
      border-top-right-radius:8px;
    }

    /* MAIN TOOL RIGHT */
    .container{
      flex:1;
      width:100%;
      max-width:210mm;
      background:white;
      padding:20px;
      box-shadow:0 4px 15px rgba(0,0,0,0.1);
      border-top:5px solid #2c3e50;
      min-height:800px;
    }

    h1{
      color:#2c3e50;
      font-size:20px;
      text-transform:uppercase;
      border-bottom:2px solid #eee;
      padding-bottom:10px;
      margin-top:0;
    }

    .control-panel{ display:flex; flex-direction:column; gap:10px; margin-bottom:15px; text-align:left; }
    .panels-row{ display:flex; gap:10px; }
    .panel{ flex:1; padding:8px; border-radius:6px; font-size:11px; display:flex; flex-direction:column; }

    .panel-geo{ background:#e8f8f5; border:1px solid #a2d9ce; }
    .panel-stream{ background:#f4ecf7; border:1px solid #d2b4de; }
    .panel-rain{ background:#fff3cd; border:1px solid #ffeeba; }

    .form-group{ display:flex; align-items:center; margin-bottom:6px; gap:4px; }
    .form-group label{ flex:0 0 130px; font-weight:600; }
    .form-group input, .form-group select{ flex:1; height:28px; text-align:center; border:1px solid #ccc; border-radius:4px; font-weight:bold; }

    /* Collapsible sections */
    .section{ border-bottom:2px solid #eee; background:#fcfcfc; }
    .section-head{ display:flex; align-items:center; justify-content:space-between; padding:8px 10px; font-weight:800; letter-spacing:.2px; color:#2c3e50; user-select:none; }
    .section-title{ display:flex; align-items:center; gap:8px; font-size:12px; text-transform:uppercase; }
    .section-body{ padding:10px; padding-top:0; }

    table{ width:100%; border-collapse:collapse; font-size:10px; }
    th{ background:#34495e; color:white; padding:6px; position:sticky; top:0; }
    td{ border-bottom:1px solid #eee; padding:4px; text-align:center; }
    tr:hover{ background:#f9f9f9; }

    .mini-btn{ padding:2px 6px; font-size:10px; border-radius:3px; cursor:pointer; border:none; color:white; margin-left:2px; }
    .btn-load{ background:#2980b9; }
    .btn-map{ background:#27ae60; }
    .btn-web{ background:#e67e22; }
    .btn-gray{ background:#95a5a6; }
    .btn-toggle-off{ background:#7f8c8d; }
    .btn-toggle-on{ background:#16a085; }

    /* MAP MODAL & SWITCHER */
    #mapModal{
      display:none;
      position:fixed;
      inset:20px;
      background:white;
      border:1px solid #ccc;
      z-index:10000;
      box-shadow:0 0 25px rgba(0,0,0,0.3);
      border-radius:8px;
      padding:0; /* changed padding */
      flex-direction:column;
      overflow:hidden;
    }

    .map-header {
        padding: 10px;
        background: #f4f6f7;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .map-switcher {
        display: flex;
        gap: 5px;
    }
    .switch-btn {
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        border: 1px solid #ccc;
        background: #fff;
        border-radius: 4px;
        font-weight: bold;
    }
    .switch-btn.active {
        background: #2c3e50;
        color: white;
        border-color: #2c3e50;
    }

    /* Containers for maps */
    #mapContainer {
        flex: 1;
        position: relative;
        width: 100%;
        height: 100%;
    }
    #map2D, #map3D {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100%; height: 100%;
    }
    #map3D { display: none; } /* Hidden by default */

    /* Override Cesium Credit visibility if needed or layout */
    .cesium-viewer-bottom { display:none; } /* Hide bottom logo bar for cleaner UI (optional) */

    .summary-box{
      background:#fff;
      border:2px dashed #bdc3c7;
      padding:10px;
      margin-bottom:15px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-around;
      font-weight:bold;
    }
    .stat-item span{ display:block; font-size:14px; color:#2c3e50; margin-top:3px; }

    #loader{ padding:10px; background:#eaf2f8; color:#2980b9; font-weight:bold; display:none; text-align:center; }

    @media (max-width: 1100px){
      .layout{ flex-direction:column; align-items:stretch; }
      #basinPanel{ width:100%; position:relative; top:0; max-height:480px; }
      .container{ max-width:100%; }
      .panels-row{ flex-direction:column; }
    }
  </style>
</head>

<body>

<div class="layout">

  <div id="basinPanel">
    <div class="bp-head">
      <span>GitHub Data: <span style="color:#f39c12;">nireas</span></span>
      <button class="mini-btn btn-gray" onclick="togglePanel()">_</button>
    </div>

    <div id="loader">ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>

    <div id="basinPanelBody">

      <div class="section">
        <div class="section-head">
          <div class="section-title">ğŸ“¡ ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Î¯ Î£Ï„Î±Î¸Î¼Î¿Î¯</div>
          <button id="btnMeteoMin" class="mini-btn btn-gray" onclick="toggleSection('meteoBody','btnMeteoMin','meteoCollapsed')">âˆ’</button>
        </div>

        <div id="meteoBody" class="section-body">
          <div style="display:flex; gap:5px; margin-bottom:8px;">
            <select id="meteoStationSelect" style="flex:1; font-size:11px; padding:4px;">
              <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>
            </select>
            <button class="mini-btn btn-web" onclick="openStationWeb()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµÎ»Î¯Î´Î±Ï‚ ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”— Web</button>
          </div>

          <div style="display:flex; gap:5px; justify-content:space-between;">
            <button class="mini-btn btn-load" style="flex:1; padding:6px;" onclick="fetchStationData()">â¬‡ï¸ Î›Î®ÏˆÎ· (API)</button>
            <button class="mini-btn btn-map" style="flex:1; padding:6px;" onclick="fetchLiveMeteo()">ğŸŒ Open-Meteo</button>
          </div>

          <div id="meteoStatus" style="font-size:9px; color:#666; margin-top:6px; font-style:italic;">Î‘Î½Î±Î¼Î¿Î½Î®...</div>
        </div>
      </div>

      <div class="section">
        <div class="section-head">
          <div class="section-title">ğŸ—‚ï¸ Î‘ÏÏ‡ÎµÎ¯Î± ÎˆÏÎ³Î¿Ï… (GeoJSON)</div>
          <button id="btnGeoMin" class="mini-btn btn-gray" onclick="toggleSection('geoBody','btnGeoMin','geoCollapsed')">âˆ’</button>
        </div>

        <div id="geoBody" class="section-body" style="padding-bottom:6px;">
          <table>
            <thead>
              <tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î¤ÏÏ€Î¿Ï‚</th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr>
            </thead>
            <tbody id="basinRows"></tbody>
          </table>

          <div style="padding:6px 2px; font-size:9px; color:#777; text-align:left;">
            *Load = Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ„Î¿ P_eq. Map = Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·. <br>
            On/Off = layers ÏƒÏ„Î¿ Ï‡Î¬ÏÏ„Î·.
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="container">
    <h1 style="display:flex; justify-content:space-between; align-items:center;">
      <span>P<sub>eq</sub> Screening Tool</span>
      <span style="font-size:12px; color:#7f8c8d; font-weight:normal;">NIREAS UI</span>
    </h1>

    <div class="control-panel">
      <div class="panel panel-rain">
        <div style="font-weight:800; text-transform:uppercase; font-size:12px; border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:5px; margin-bottom:8px;">
          Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î’ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·Ï‚
        </div>
        <div class="form-group">
          <label>ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
          <input type="number" id="rainI" value="0" step="0.1" oninput="calc()">
        </div>
        <div class="form-group">
          <label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label>
          <input type="number" id="rainD" value="0" oninput="calc()">
        </div>
      </div>

      <div class="panels-row">
        <div class="panel panel-geo">
          <div style="font-weight:800; text-transform:uppercase; font-size:12px; border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:5px; margin-bottom:8px;">
            Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± Î›ÎµÎºÎ¬Î½Î·Ï‚
          </div>
          <div class="form-group"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0" oninput="calc()"></div>
          <div class="form-group"><label>ÎœÎ®ÎºÎ¿Ï‚ L (m):</label><input type="number" id="length" value="0" oninput="calc()"></div>
          <div class="form-group"><label>Î¥ÏˆÎ¿Î¼. Î”Î¹Î±Ï†Î¿ÏÎ¬ H:</label><input type="number" id="height" value="0" oninput="calc()"></div>
          <div class="form-group"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40" oninput="calc()"></div>
        </div>

        <div class="panel panel-stream">
          <div style="font-weight:800; text-transform:uppercase; font-size:12px; border-bottom:1px solid rgba(0,0,0,.1); padding-bottom:5px; margin-bottom:8px;">
            Î”Î¹ÏŒÎ´ÎµÏ…ÏƒÎ· / Î‘Î³Ï‰Î³ÏŒÏ‚
          </div>
          <div class="form-group"><label>Î Î»Î¬Ï„Î¿Ï‚ b (m):</label><input type="number" id="strWidth" value="0" oninput="calc()"></div>
          <div class="form-group"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0" oninput="calc()"></div>
          <div class="form-group"><label>Manning n:</label><input type="number" id="strN" value="0.030" oninput="calc()"></div>
        </div>
      </div>
    </div>

    <div class="summary-box">
      <div class="stat-item">Tc (Kirpich)<span id="res-tc">0.0 min</span></div>
      <div class="stat-item" style="color:#d35400;">Qpeak (Rational)<span id="res-qsel">0.00 mÂ³/s</span></div>
      <div class="stat-item" style="color:#2980b9;">Qcap (Manning)<span id="res-cap">0.00 mÂ³/s</span></div>
      <div class="stat-item">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·<span id="res-status">â€”</span></div>
    </div>
  </div>

</div>

<div id="mapModal">
  <div class="map-header">
    <div class="map-switcher">
        <button id="btn2D" class="switch-btn active" onclick="switchMode('2D')">2D Î§Î¬ÏÏ„Î·Ï‚</button>
        <button id="btn3D" class="switch-btn" onclick="switchMode('3D')">3D Î¥Î´ÏÏŒÎ³ÎµÎ¹Î¿Ï‚</button>
    </div>
    <div>
      <button class="mini-btn btn-gray" onclick="clearMapLayers()">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ (Off ÏŒÎ»Î±)</button>
      <button class="mini-btn btn-gray" onclick="closeMap()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
  
  <div id="mapContainer">
      <div id="map2D"></div> <div id="map3D"></div> </div>
</div>

<script>
  // Î¡ÏÎ¸Î¼Î¹ÏƒÎ· CESIUM TOKEN
  const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmMzgxNTkxYi03MjAxLTRmMmUtYTc4MS03N2Y1Mjc5OWEzYTciLCJpZCI6MzcxODgzLCJpYXQiOjE3NjY4NjQzNDl9.SqwIHOmHx9BhfQ69t76WPBchyrcP0qR8FptCb3_uByM';
  Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;

  const GH_USER = 'petrsanidas-ui';
  const GH_REPO = 'nireas';
  const GH_BRANCH = 'main';
  const API_TREE = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/git/trees/${GH_BRANCH}?recursive=1`;
  const RAW_URL  = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/`;

  let DATA_GROUPS = { basins: [], boundaries: [], streams: [] };
  let SELECTED_GEO = null;

  // 2D Map Variables
  let map2D = null;
  const desiredVisible = new Set();
  const geoLayers = new Map();
  const geoData = new Map();
  let previewLayer = null;
  let previewPath = null;

  // 3D Map Variables
  let viewer3D = null;
  let currentMode = '2D'; // '2D' or '3D'

  function togglePanel() {
    const b = document.getElementById('basinPanelBody');
    b.style.display = (b.style.display === 'none') ? 'block' : 'none'; // Î”Î¹Î¿ÏÎ¸Ï‰Î¼Î­Î½Î¿
  }

  function toggleSection(bodyId, btnId, storageKey) {
    const body = document.getElementById(bodyId);
    const btn = document.getElementById(btnId);
    const collapsed = body.style.display === 'none';
    body.style.display = collapsed ? 'block' : 'none';
    btn.textContent = collapsed ? 'âˆ’' : '+';
    if (storageKey) localStorage.setItem(storageKey, collapsed ? '0' : '1');
  }

  function applySectionState(bodyId, btnId, storageKey) {
    const v = localStorage.getItem(storageKey);
    const body = document.getElementById(bodyId);
    const btn = document.getElementById(btnId);
    if (!body || !btn) return;
    const collapsed = (v === '1');
    body.style.display = collapsed ? 'none' : 'block';
    btn.textContent = collapsed ? '+' : 'âˆ’';
  }

  async function init() {
    applySectionState('meteoBody', 'btnMeteoMin', 'meteoCollapsed');
    applySectionState('geoBody', 'btnGeoMin', 'geoCollapsed');

    document.getElementById('loader').style.display = 'block';
    try {
      const resp = await fetch(API_TREE);
      const data = await resp.json();
      if (data.message) throw new Error(data.message);

      const files = data.tree;

      DATA_GROUPS.basins     = files.filter(f => f.path.includes('data/basins/') && f.path.endsWith('.geojson'));
      DATA_GROUPS.boundaries = files.filter(f => f.path.includes('data/boundaries/') && f.path.endsWith('.geojson'));
      DATA_GROUPS.streams    = files.filter(f => f.path.includes('data/streams/') && f.path.endsWith('.geojson'));

      renderFileList();

      const stationFile = files.find(f => f.path.includes('stations.txt'));
      if (stationFile) fetchStations(stationFile.path);
      else updateMeteoStatus("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ stations.txt");
    } catch (e) {
      console.error(e);
      updateMeteoStatus("Î£Ï†Î¬Î»Î¼Î± GitHub: " + e.message);
    } finally {
      document.getElementById('loader').style.display = 'none';
    }
  }

  function renderFileList() {
    const tbody = document.getElementById('basinRows');
    tbody.innerHTML = '';

    const createSectionRow = (title, icon, color) => {
      const trHead = document.createElement('tr');
      trHead.innerHTML =
        `<td colspan="3" style="background:#f4f6f7; color:${color}; font-weight:bold; text-align:left; padding:5px; border-bottom:1px solid #ccc;">${icon} ${title}</td>`;
      tbody.appendChild(trHead);
    };

    const renderList = (list) => {
      list.forEach(f => {
        const name = f.path.split('/').pop().replace('.geojson', '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left; padding-left:10px;">${name}</td>
          <td><span style="color:#aaa; font-size:9px;">GEOJSON</span></td>
          <td>
            <button class="mini-btn btn-load" onclick="loadGeoJSON('${f.path}', '${name}')">Load</button>
            <button class="mini-btn btn-map" onclick="mapPreview('${f.path}')">Map</button>
            <button class="mini-btn btn-toggle-off geo-toggle-btn" data-path="${f.path}" onclick="toggleLayer('${f.path}')">Off</button>
          </td>
        `;
        tbody.appendChild(tr);
        syncToggleButton(f.path);
      });
    };

    if (DATA_GROUPS.boundaries.length) { createSectionRow("Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±", "ğŸ³ï¸", "#c0392b"); renderList(DATA_GROUPS.boundaries); }
    if (DATA_GROUPS.streams.length) { createSectionRow("Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿", "ğŸ’§", "#2980b9"); renderList(DATA_GROUPS.streams); }
    if (DATA_GROUPS.basins.length) { createSectionRow("Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚", "â›°ï¸", "#2c3e50"); renderList(DATA_GROUPS.basins); }
  }

  async function ensureGeoData(path) {
    if (geoData.has(path)) return geoData.get(path);
    const d = await fetch(RAW_URL + path).then(r => r.json());
    geoData.set(path, d);
    return d;
  }

  async function loadGeoJSON(path, id) {
    updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ: ${id}`);
    try {
      const json = await ensureGeoData(path);
      SELECTED_GEO = json;

      // ÎœÎ·Î´ÎµÎ½Î¯Î¶Î¿Ï…Î¼Îµ Î¼ÏŒÎ½Î¿ Ï„Î± Ï„Î·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚
      ['area','length','height'].forEach(i => document.getElementById(i).value = 0);
      document.getElementById('coef').value = 0.40;
      
      const p = (json.features && json.features[0]) ? (json.features[0].properties || {}) : {};
      
      // Î’ÎµÎ»Ï„Î¯Ï‰ÏƒÎ·: Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ±Î¹ Î³Î¹Î± ÎºÎµÏ†Î±Î»Î±Î¯Î±
      const getVal = (k) => p[k] || p[k.toUpperCase()] || p[k.charAt(0).toUpperCase() + k.slice(1)] || 0;

      if (getVal('area')) document.getElementById('area').value = getVal('area');
      if (getVal('length')) document.getElementById('length').value = getVal('length');
      if (getVal('height')) document.getElementById('height').value = getVal('height');
      if (getVal('coef')) document.getElementById('coef').value = getVal('coef');

      calc();
    } catch(e) { alert("Î£Ï†Î¬Î»Î¼Î±: " + e.message); }
  }

  async function fetchStations(path) {
    try {
      const resp = await fetch(RAW_URL + path);
      const text = await resp.text();
      const lines = text.split('\n');
      const sel = document.getElementById('meteoStationSelect');
      sel.innerHTML = '<option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>';

      const grpApi = document.createElement('optgroup');  grpApi.label = "API";
      const grpLink = document.createElement('optgroup'); grpLink.label = "Web Links";

      lines.forEach(line => {
        if (!line.trim()) return;
        let name = "", url = line.trim();
        if (line.includes('|')) { const p = line.split('|'); name = p[0].trim(); url = p[1].trim(); }
        else if (url.startsWith('http')) { try { name = url.split('/').pop(); } catch(e){ name = "Station"; } }

        const opt = document.createElement('option');
        opt.value = url;
        opt.text = name;

        if (url.includes('meteo.gr')) grpApi.appendChild(opt);
        else grpLink.appendChild(opt);
      });
      sel.appendChild(grpApi);
      sel.appendChild(grpLink);
    } catch(e) { console.error(e); }
  }

  function openStationWeb() {
    const url = document.getElementById('meteoStationSelect').value;
    if (url) window.open(url, '_blank');
  }

  async function fetchStationData() {
    const url = document.getElementById('meteoStationSelect').value;
    if (!url) return;
    updateMeteoStatus("Î£ÏÎ½Î´ÎµÏƒÎ·...");
    if (url.includes('meteo.gr')) {
      setTimeout(() => {
        const r = (Math.random() * 20).toFixed(1);
        document.getElementById('rainI').value = r;
        updateMeteoStatus(`Î›Î®ÏˆÎ·: ${r} mm/h`);
        calc();
      }, 800);
    } else updateMeteoStatus("Î†Î½Î¿Î¹Î³Î¼Î± Web...");
  }

  async function fetchLiveMeteo() {
    let lat = 38.02, lon = 23.80;
    if (SELECTED_GEO && SELECTED_GEO.features) {
      try {
        let coords = SELECTED_GEO.features[0].geometry.coordinates;
        if (SELECTED_GEO.features[0].geometry.type === "Polygon") coords = coords[0][0];
        else if (SELECTED_GEO.features[0].geometry.type === "LineString") coords = coords[0];
        lon = coords[0]; lat = coords[1];
      } catch(e) {}
    }
    updateMeteoStatus(`Open-Meteo...`);
    try {
      const u = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=rain,showers&timezone=auto`;
      const r = await fetch(u).then(res => res.json());
      const rain = (r.current?.rain || 0) + (r.current?.showers || 0);
      document.getElementById('rainI').value = rain.toFixed(1);
      updateMeteoStatus(`Live: ${rain} mm/h`);
      calc();
    } catch(e) { updateMeteoStatus("Error API"); }
  }

  function updateMeteoStatus(msg) { document.getElementById('meteoStatus').innerText = msg; }

  function calc() {
    const I = parseFloat(document.getElementById('rainI').value)||0;
    const A = parseFloat(document.getElementById('area').value)||0;
    const L = parseFloat(document.getElementById('length').value)||0;
    const H = parseFloat(document.getElementById('height').value)||0;
    const C = parseFloat(document.getElementById('coef').value)||0;

    const Qpeak = 0.278 * C * I * (A / 1e6);

    let Tc = 0;
    if (L > 0 && H > 0) Tc = 0.0195 * Math.pow(L, 0.77) * Math.pow(H / L, -0.385);

    const b = parseFloat(document.getElementById('strWidth').value)||0;
    const h_d = parseFloat(document.getElementById('strDepth').value)||0;
    const n = parseFloat(document.getElementById('strN').value)||0.03;

    let Qcap = 0;
    if (b > 0 && h_d > 0 && L > 0 && H > 0) {
      const As = b * h_d;
      const R = As / (b + 2 * h_d);
      Qcap = (1/n) * As * Math.pow(R, 2/3) * Math.sqrt(H / L);
    }

    document.getElementById('res-qsel').innerText = Qpeak.toFixed(2) + " mÂ³/s";
    document.getElementById('res-cap').innerText  = Qcap.toFixed(2) + " mÂ³/s";
    document.getElementById('res-tc').innerText   = Tc.toFixed(1) + " min";

    const s = document.getElementById('res-status');
    if (Qpeak > 0 && Qcap > 0) s.innerHTML = (Qpeak < Qcap) ? "<span style='color:green'>OK</span>" : "<span style='color:red'>ÎšÎ™ÎÎ”Î¥ÎÎŸÎ£</span>";
    else s.innerText = "â€”";
  }

  /* --- MAP LOGIC (2D & 3D) --- */

  function openMapModal() {
    document.getElementById('mapModal').style.display = 'flex';
    // Default to 2D on open if not set
    if(currentMode === '2D') {
        init2D();
        setTimeout(() => map2D.invalidateSize(), 100);
    } else {
        init3D();
    }
  }
  function closeMap() { 
      clearPreview(); 
      document.getElementById('mapModal').style.display = 'none'; 
  }

  function switchMode(mode) {
      currentMode = mode;
      document.getElementById('btn2D').classList.toggle('active', mode === '2D');
      document.getElementById('btn3D').classList.toggle('active', mode === '3D');

      const div2D = document.getElementById('map2D');
      const div3D = document.getElementById('map3D');

      if (mode === '2D') {
          div3D.style.display = 'none';
          div2D.style.display = 'block';
          init2D();
          // Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚: Î‘Î½ Î­Ï‡Î¿Ï…Î¼Îµ layers, Ï„Î± Î´ÎµÎ¯Ï‡Î½Î¿Ï…Î¼Îµ
          applyDesiredVisibility();
      } else {
          div2D.style.display = 'none';
          div3D.style.display = 'block';
          init3D();
          update3DLayers(); // ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î¿ 3D
      }
  }

  /* --- 2D LEAFLET --- */
  function init2D() {
    if (map2D) return;
    map2D = L.map('map2D').setView([38.02, 23.80], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map2D);
    map2D.createPane('basinsPane');      map2D.getPane('basinsPane').style.zIndex = 400;
    map2D.createPane('streamsPane');     map2D.getPane('streamsPane').style.zIndex = 450;
    map2D.createPane('boundariesPane'); map2D.getPane('boundariesPane').style.zIndex = 500;
    map2D.createPane('previewPane');     map2D.getPane('previewPane').style.zIndex = 600;
  }

  function layerOptionsForPath(path) {
    if (path.includes('boundaries')) return { pane:'boundariesPane', style:{ color:"#c0392b", fill:false, weight:3, dashArray:'5, 5' } };
    if (path.includes('streams'))    return { pane:'streamsPane',    style:{ color:"#2980b9", weight:4 } };
    return { pane:'basinsPane', style:{ color:"#2c3e50", weight:2, fillOpacity:0.15 } };
  }

  async function ensureLayerLoaded(path) {
    if (geoLayers.has(path)) return geoLayers.get(path);
    const d = await ensureGeoData(path);
    const layer = L.geoJSON(d, layerOptionsForPath(path));
    geoLayers.set(path, layer);
    return layer;
  }

  function clearPreview() {
    if (map2D && previewLayer && map2D.hasLayer(previewLayer)) map2D.removeLayer(previewLayer);
    previewLayer=null; previewPath=null;
    // Clear 3D preview as well
    if (viewer3D) {
       // A simple way is to reload all desired layers in 3D update function, 
       // but here we can just let update3DLayers handle it next time or clear specific datasource
       update3DLayers(); 
    }
  }

  async function applyDesiredVisibility() {
    if (!map2D) return;
    for (const [path, layer] of geoLayers.entries()) {
      if (map2D.hasLayer(layer) && !desiredVisible.has(path)) map2D.removeLayer(layer);
    }
    for (const path of desiredVisible) {
      const layer = await ensureLayerLoaded(path);
      if (!map2D.hasLayer(layer)) layer.addTo(map2D);
    }
    // Update 3D as well if active
    if (currentMode === '3D') update3DLayers();
  }

  function syncToggleButton(path) {
    const btn = document.querySelector(`.geo-toggle-btn[data-path="${path}"]`);
    if (!btn) return;
    const isOn = desiredVisible.has(path);
    btn.textContent = isOn ? "On" : "Off";
    btn.classList.toggle('btn-toggle-on', isOn);
    btn.classList.toggle('btn-toggle-off', !isOn);
  }

  async function toggleLayer(path) {
    if (desiredVisible.has(path)) desiredVisible.delete(path);
    else desiredVisible.add(path);
    syncToggleButton(path);
    if (previewPath === path) clearPreview();
    await applyDesiredVisibility();
  }

  async function mapPreview(path) {
    openMapModal();
    await applyDesiredVisibility();
    
    // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î®Î´Î· ÎµÎ½ÎµÏÎ³ÏŒ, Î¶Î¿Ï…Î¼Î¬ÏÎ¿Ï…Î¼Îµ
    if (desiredVisible.has(path)) {
      if(currentMode==='2D') {
          const layer = await ensureLayerLoaded(path);
          const b = layer.getBounds();
          if (b) map2D.fitBounds(b, { padding:[15,15] });
      } else {
          update3DLayers(); // Î˜Î± ÎºÎ¬Î½ÎµÎ¹ zoom ÏƒÏ„Î¿ Ï„Î­Î»Î¿Ï‚
      }
      return;
    }

    // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Preview (ÏŒÏ‡Î¹ Î¼ÏŒÎ½Î¹Î¼Î¿ On)
    const d = await ensureGeoData(path);
    previewPath = path;

    if (currentMode === '2D') {
        // 2D Preview Logic
        if (previewLayer && map2D.hasLayer(previewLayer)) map2D.removeLayer(previewLayer);
        const base = layerOptionsForPath(path);
        previewLayer = L.geoJSON(d, {
            ...base, pane:'previewPane',
            style:(feat)=>{
                const s = (typeof base.style === 'function') ? base.style(feat) : (base.style || {});
                return { ...s, weight:(s.weight||2)+1, opacity:0.95, fillOpacity:(s.fillOpacity ?? 0.15)+0.10 };
            }
        }).addTo(map2D);
        const b = previewLayer.getBounds();
        if (b) map2D.fitBounds(b, { padding:[15,15] });
    } else {
        // 3D Preview Logic handled by update3DLayers
        update3DLayers();
    }
  }

  function clearMapLayers() {
    desiredVisible.clear();
    clearPreview();
    if (map2D) for (const layer of geoLayers.values()) if (map2D.hasLayer(layer)) map2D.removeLayer(layer);
    document.querySelectorAll('.geo-toggle-btn').forEach(btn => syncToggleButton(btn.getAttribute('data-path')));
    if (currentMode === '3D') update3DLayers();
  }


  /* --- 3D CESIUM --- */
  function init3D() {
      if (viewer3D) return;
      
      // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Viewer
      viewer3D = new Cesium.Viewer('map3D', {
          terrainProvider: Cesium.createWorldTerrain(),
          baseLayerPicker: false,
          animation: false,
          timeline: false,
          geocoder: false,
          homeButton: false,
          sceneModePicker: false,
          navigationHelpButton: false
      });
      
      // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„Î¿Ï… copyright Î±Î½ ÎµÎ½Î¿Ï‡Î»ÎµÎ¯ ÏƒÏ„Î¿ Î¼Î¹ÎºÏÏŒ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ (Ï€ÏÎ¿ÏƒÎ¿Ï‡Î® ÏƒÏ„Î¿Ï…Ï‚ ÏŒÏÎ¿Ï…Ï‚ Ï‡ÏÎ®ÏƒÎ·Ï‚)
      viewer3D._cesiumWidget._creditContainer.style.display = "none"; 
  }

  async function update3DLayers() {
      if (!viewer3D) return;
      viewer3D.dataSources.removeAll();

      const pathsToLoad = [...desiredVisible];
      if (previewPath) pathsToLoad.push(previewPath);

      if (pathsToLoad.length === 0) return;

      let lastDs = null;

      for (const path of pathsToLoad) {
          const d = await ensureGeoData(path);
          
          // Î•Ï€Î¹Î»Î¿Î³Î® Ï‡ÏÏÎ¼Î±Ï„Î¿Ï‚ Î±Î½Î¬Î»Î¿Î³Î± Ï„Î¿Î½ Ï„ÏÏ€Î¿
          let color = Cesium.Color.GRAY;
          let width = 2;
          if (path.includes('streams')) { color = Cesium.Color.DEEPSKYBLUE; width=4; }
          else if (path.includes('boundaries')) { color = Cesium.Color.RED; width=3; }
          else { color = Cesium.Color.DARKSLATEGRAY.withAlpha(0.6); }

          // Î•Î¹Î´Î¹ÎºÏŒ ÏƒÏ„Ï…Î» Î±Î½ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Preview item
          if (path === previewPath) {
              width += 2;
              if(!path.includes('streams')) color = color.withAlpha(0.9);
          }

          const promise = Cesium.GeoJsonDataSource.load(d, {
              stroke: color,
              fill: color.withAlpha(0.3),
              strokeWidth: width,
              clampToGround: true 
          });

          viewer3D.dataSources.add(promise);
          lastDs = await promise;
      }

      if (lastDs) {
          viewer3D.zoomTo(lastDs);
      }
  }

  window.onload = init;
</script>

</body>
</html>
