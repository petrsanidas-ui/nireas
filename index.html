<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P_eq Screening Tool (GitHub Connected)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- CSS ΑΠΟ VER 14 (Αυτούσιο) --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }

    .container {
      width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 297mm; border-top: 5px solid #2c3e50;
    }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }

    .control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; text-align: left; }
    .panels-row { display: flex; gap: 10px; align-items: stretch; }
    .panels-row .panel { flex: 1; }
    .panel-rain { width: 100%; }
    @media (max-width: 950px) { .panels-row { flex-direction: column; } }

    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }
    .panel-rain { background: #fff3cd; border: 1px solid #ffeeba; flex: 0 0 auto; }

    /* Forms */
    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { font-size: 11px; font-weight: 600; flex: 0 0 135px; text-align: left; cursor: help; line-height: 1.1; }
    .form-group input, .form-group select {
      flex: 1; min-width: 0; height: 28px; padding: 0 2px; text-align: center;
      border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; font-size: 12px; width: 100%;
    }
    .rain-input-group { background: #fff3cd; padding: 5px; border-radius: 3px; border: 1px solid #ffeeba; }
    .rain-input-group input { border: 2px solid #f1c40f; }

    /* Buttons */
    .mini-go-btn, .mini-del-btn, .mini-btn {
      padding: 4px 6px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 10px; font-weight: bold; color: #fff;
    }
    .mini-go-btn { background: #2c3e50; }
    .mini-go-btn:hover { background: #34495e; }
    .mini-btn { background: #2c3e50; border: 1px solid #ccd1d1; }

    /* Visualizers */
    .visualizer-box { margin: 8px 0; background: #fff; border: 1px solid #d2b4de; border-radius: 4px; text-align: center; padding: 5px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    .visualizer-box.basin { border: 1px solid #a2d9ce; background: #e8f8f5; }

    /* Summary & Table */
    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: space-around; font-size: 11px; font-weight: bold; }
    .stat-item { text-align: center; min-width: 100px; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    th { background: #34495e; color: white; padding: 6px 2px; border: 1px solid #34495e; position: sticky; top: 0; }
    td { border: 1px solid #ddd; padding: 4px 2px; text-align: center; }

    /* Risk Colors */
    .risk-safe { background-color: #d4edda; color: #155724; }
    .risk-warn { background-color: #fff3cd; color: #856404; }
    .risk-orange { background-color: #ffe5d0; color: #d35400; font-weight: bold; }
    .risk-red { background-color: #f5c6cb; color: #721c24; font-weight: bold; }
    .risk-extreme { background-color: #922b21; color: #fff; font-weight: bold; }
    .status-ok { color: #27ae60; font-weight: bold; }
    .status-fail { color: #c0392b; font-weight: bold; }

    /* Side Panel */
    #basinPanel {
      position: fixed; top: 10px; left: 10px; z-index: 10000;
      width: 380px; max-height: calc(100vh - 20px); overflow-y: auto;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-align: left; color: #2c3e50;
    }
    .bp-head { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eef2f3; font-weight: bold; font-size: 13px; background: #f8f9f9;}
    .bp-body { padding: 0; font-size: 12px; }
    
    /* Meteo Panel inside Side Panel */
    #meteoPanel .mp-head { padding:8px 10px; background:#f4f6f7; border-bottom:1px solid #eee; font-weight:bold; font-size:11px; display:flex; justify-content:space-between; align-items:center; }
    #meteoBody { padding:10px; background:#fff; }
    #meteoStationSelect { width:100%; margin-bottom:5px; height: 30px; }

    /* Map Modal */
    #mapModal { display:none; position:fixed; inset:20px; background:#fff; border:1px solid #ccc; z-index:20000; box-shadow:0 0 20px rgba(0,0,0,0.3); }
    #mapBox { width:100%; height:calc(100% - 40px); }

    .qbadge { padding: 2px 6px; border-radius: 10px; color: #fff; font-weight: bold; font-size: 10px; display:inline-block; min-width:50px; text-align:center; }
    .qb-gray { background: #bdc3c7; } .qb-green { background: #27ae60; } .qb-red { background: #c0392b; } .qb-yellow { background: #f1c40f; color:#333; }
    
    #gh-loader { padding:10px; text-align:center; color:#2980b9; background:#ebf5fb; font-weight:bold; font-size:11px; display:none; }
  </style>
</head>
<body>

<div id="basinPanel">
  <div class="bp-head">
    <span>P<sub>eq</sub> Screening Tool <span style="font-size:10px; color:#d35400;">(GitHub: nireas)</span></span>
    <button type="button" class="mini-btn" onclick="document.getElementById('basinPanelBody').style.display = document.getElementById('basinPanelBody').style.display==='none'?'block':'none'">–</button>
  </div>
  
  <div id="gh-loader">⏳ Ανάκτηση δεδομένων από GitHub...</div>

  <div id="basinPanelBody" class="bp-body">
    
    <div id="meteoPanel">
      <div class="mp-head">
         <span>Μετεωρολογικοί Σταθμοί</span>
      </div>
      <div id="meteoBody">
         <select id="meteoStationSelect"></select>
         <div style="display:flex; gap:5px; margin-top:5px;">
            <select id="meteoAggSelect" style="width:60px;"><option value="max">MAX</option></select>
            <button class="mini-btn" onclick="fetchLiveMeteo()">Auto i</button>
            <button class="mini-btn" onclick="openStationUrl()">Άνοιγμα</button>
         </div>
         <div id="meteoMsg" style="font-size:9px; color:#777; margin-top:4px; text-align:right;"></div>
      </div>
    </div>

    <table>
      <thead>
        <tr style="background:#f8f9f9; color:#566573;">
          <th style="width:40%;">Λεκάνη</th>
          <th style="width:20%;">P<sub>eq</sub></th>
          <th style="width:40%; text-align:right;">Επιλογή</th>
        </tr>
      </thead>
      <tbody id="basinRows"></tbody>
    </table>
    <div style="padding:10px; font-size:10px; color:#566573; background:#fdfefe; border-top:1px solid #eee;">
      Τα δεδομένα φορτώνονται δυναμικά από το <b>petrsanidas-ui/nireas</b>.
    </div>
  </div>
</div>

<div class="container">
  <h1>Δείκτες Απόκρισης Τοπικών Λεκανών Απορροής</h1>
  
  <div style="text-align:left; font-size:11px; margin:6px 0 10px; color:#2c3e50;">
    <b>Επιλεγμένη Λεκάνη:</b> <span id="selectedBasin" style="font-size:14px; font-weight:bold; color:#d35400;">—</span>
  </div>

  <div class="control-panel">
    <div class="panel panel-rain">
        <h3>Σενάριο Βροχής</h3>
        <div class="form-group rain-input-group">
            <label>⚠️ Ένταση i (mm/h):</label>
            <input type="number" id="rainI" value="0" min="0">
            <button class="mini-btn" style="margin-left:4px;" onclick="fetchLiveMeteo()">Live</button>
        </div>
        <div class="form-group rain-input-group">
            <label>⚠️ Διάρκεια D (min):</label>
            <input type="number" id="rainD" value="0" min="0">
        </div>
    </div>

    <div class="panels-row">
      <div class="panel panel-geo">
        <h3>1. Γεωμετρία</h3>
        <div class="form-group"><label>Εμβαδόν A (m²):</label><input type="number" id="area" value="0"></div>
        <div class="form-group"><label>Μήκος ροής L (m):</label><input type="number" id="length" value="0"></div>
        <div class="form-group"><label>Υψομ. διαφορά H (m):</label><input type="number" id="height" value="0"></div>
        <div class="form-group"><label>Συντελεστής C:</label><input type="number" id="coef" value="0.40" step="0.01"></div>
        <div class="visualizer-box basin">
            <canvas id="basinCanvas" width="180" height="150"></canvas>
            <div style="font-size:9px; color:#666;">Οπτικοποίηση Λεκάνης</div>
        </div>
      </div>

      <div class="panel panel-net">
        <h3>2. Συλλογή</h3>
        <div class="form-group"><label>Πλήθος φρεατίων:</label><input type="number" id="drains" value="0"></div>
        <div class="form-group"><label>Ικανότητα/τεμ (m³/s):</label><input type="number" id="drainCap" value="0.10"></div>
      </div>

      <div class="panel panel-stream">
        <h3>3. Διόδευση</h3>
        <div class="form-group"><label>Πλάτος b (m):</label><input type="number" id="strWidth" value="0"></div>
        <div class="form-group"><label>Πρανές z:</label><input type="number" id="strZ" value="0"></div>
        <div class="form-group"><label>Βάθος h (m):</label><input type="number" id="strDepth" value="0"></div>
        <div class="form-group"><label>Manning n:</label><input type="number" id="strN" value="0.030"></div>
        <div class="visualizer-box">
            <canvas id="channelCanvas" width="180" height="120"></canvas>
            <div style="font-size:9px; color:#666;">Οπτικοποίηση Διατομής</div>
        </div>
      </div>
    </div>
  </div>

  <div id="summary" class="summary-box">
    <div class="stat-item" style="color:#d35400;">Tc (Kirpich)<span id="res-tc">0.0 min</span></div>
    <div class="stat-item" style="color:#16a085;">Qpeak (Rational)<span id="res-qsel">0.00 m³/s</span></div>
    <div class="stat-item" style="color:#2980b9;">Qcap (Stream)<span id="res-stream">0.00 m³/s</span></div>
    <div class="stat-item">Επάρκεια<span id="res-adequacy">—</span></div>
  </div>

  <table style="margin-top:20px;">
    <thead>
      <tr>
        <th width="10%">i (mm/h)</th><th width="10%">D (min)</th><th width="10%">P (mm)</th>
        <th width="15%">Qpeak (m³/s)</th><th width="15%">P<sub>eq</sub></th><th width="20%">Κατάσταση</th>
      </tr>
    </thead>
    <tbody id="riskTableBody">
      </tbody>
  </table>

</div>

<div id="mapModal">
  <div style="padding:10px; background:#f8f9f9; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;">
    <b id="mapTitle">Χάρτης</b>
    <button onclick="document.getElementById('mapModal').style.display='none'">Κλείσιμο</button>
  </div>
  <div id="mapBox"></div>
</div>

<script>
  // --- CONFIG GITHUB ---
  const GH = { user: 'petrsanidas-ui', repo: 'nireas', branch: 'main' };
  const RAW_URL = `https://raw.githubusercontent.com/${GH.user}/${GH.repo}/${GH.branch}/`;
  const API_TREE = `https://api.github.com/repos/${GH.user}/${GH.repo}/git/trees/${GH.branch}?recursive=1`;

  // --- STATE ---
  let BASINS = [];
  let SELECTED_BASIN_GEOM = null; // GeoJSON geometry for meteo
  let STATION_URLS = {}; // Map name -> url

  // --- INIT ---
  async function initApp() {
    const loader = document.getElementById('gh-loader');
    loader.style.display = 'block';

    try {
        // 1. Get File Tree
        const resp = await fetch(API_TREE);
        const data = await resp.json();
        if(data.message) throw new Error(data.message);
        
        const files = data.tree.filter(f => f.type === 'blob');

        // 2. Process Basins
        BASINS = files.filter(f => f.path.includes('data/basins/') && f.path.endsWith('.geojson')).map(f => ({
            path: f.path,
            name: f.path.split('/').pop().replace('.geojson', '')
        }));
        renderBasinTable();

        // 3. Process Stations
        const stFile = files.find(f => f.path.includes('stations.txt'));
        if(stFile) loadStations(stFile.path);

    } catch(e) {
        alert("GitHub Error: " + e.message);
    } finally {
        loader.style.display = 'none';
    }
  }

  // --- STATIONS LOGIC ---
  async function loadStations(path) {
      try {
          const res = await fetch(RAW_URL + path);
          const text = await res.text();
          const lines = text.split('\n');
          const sel = document.getElementById('meteoStationSelect');
          sel.innerHTML = '';
          
          lines.forEach(line => {
              const trim = line.trim();
              if(!trim) return;
              // Format assumption: "Name|URL" or just "Name" (fallback)
              // If simple text file with names, we just show names.
              // If user provided URLs in ver14 style, they might be complex.
              // Here we assume simple lines.
              
              let name = trim;
              let url = ""; 
              
              // Basic detection if line has a URL
              const urlMatch = trim.match(/(https?:\/\/[^\s]+)/);
              if(urlMatch) {
                  url = urlMatch[0];
                  name = trim.replace(url, '').trim() || "Station";
              }

              const opt = document.createElement('option');
              opt.value = url; // Store URL in value if exists
              opt.text = name;
              sel.add(opt);
              
              if(url) STATION_URLS[name] = url;
          });
      } catch(e) { console.error(e); }
  }

  function openStationUrl() {
      const sel = document.getElementById('meteoStationSelect');
      const url = sel.value;
      if(url && url.startsWith('http')) {
          window.open(url, '_blank');
      } else {
          alert("Δεν βρέθηκε URL για αυτόν τον σταθμό.");
      }
  }

  async function fetchLiveMeteo() {
      const msg = document.getElementById('meteoMsg');
      msg.innerText = "Λήψη δεδομένων (Open-Meteo)...";
      
      let lat = 38.02, lon = 23.80; // Default Athens
      if(SELECTED_BASIN_GEOM) {
          try {
             // Take first coord of polygon as approximation
             const c = SELECTED_BASIN_GEOM.features[0].geometry.coordinates[0][0]; 
             lon = c[0]; lat = c[1];
          } catch(e) {}
      }

      try {
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=rain,showers&timezone=auto`;
          const r = await fetch(url);
          const d = await r.json();
          const rain = (d.current.rain || 0) + (d.current.showers || 0);
          
          document.getElementById('rainI').value = rain.toFixed(1);
          msg.innerText = `OK: ${rain} mm/h (${d.current.time})`;
          calcMaster(); // Recalculate
      } catch(e) {
          msg.innerText = "Error: " + e.message;
      }
  }

  // --- BASIN LOGIC ---
  function renderBasinTable() {
      const tbody = document.getElementById('basinRows');
      tbody.innerHTML = '';
      BASINS.forEach(b => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${b.name}</td>
            <td style="text-align:center;"><span id="badge_${b.name}" class="qbadge qb-gray">-</span></td>
            <td style="text-align:right;">
               <button class="mini-go-btn" onclick="loadBasin('${b.path}', '${b.name}')">Load</button>
               <button class="mini-btn" onclick="openMap('${b.path}')">Map</button>
            </td>
          `;
          tbody.appendChild(tr);
      });
  }

  async function loadBasin(path, name) {
      document.getElementById('selectedBasin').innerText = "Φόρτωση...";
      try {
          const res = await fetch(RAW_URL + path);
          const geojson = await res.json();
          SELECTED_BASIN_GEOM = geojson;
          
          // Try extract properties
          const p = geojson.features?.[0]?.properties || {};
          const getP = (k) => p[k] || 0;
          
          if(p.area) document.getElementById('area').value = p.area;
          if(p.length) document.getElementById('length').value = p.length;
          if(p.height) document.getElementById('height').value = p.height;
          if(p.coef) document.getElementById('coef').value = p.coef;

          document.getElementById('selectedBasin').innerText = name;
          calcMaster();

      } catch(e) {
          alert("Error loading basin");
      }
  }

  // --- CALCULATIONS & VISUALIZATION (VER 14 ENGINE) ---
  function calcMaster() {
      const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
      
      const A = getVal('area'), L = getVal('length'), H = getVal('height'), C = getVal('coef');
      const I = getVal('rainI'), D = getVal('rainD');
      const drains = getVal('drains'), drainCap = getVal('drainCap');
      const b = getVal('strWidth'), z = getVal('strZ'), h = getVal('strDepth'), n = getVal('strN');

      // 1. Calculations
      const Akm2 = A / 1e6;
      const Qpeak = 0.278 * C * I * Akm2;
      const Tc = (L>0 && H>0) ? 0.0195 * Math.pow(L, 0.77) * Math.pow(H/L, -0.385) : 0;
      
      // Stream Capacity (Manning)
      let Qstr = 0;
      if(b>0 && h>0 && L>0 && H>0) {
          const Slope = H/L;
          const Area = (b + z*h)*h;
          const Perim = b + 2*h*Math.sqrt(1+z*z);
          const Rh = Area/Perim;
          Qstr = (1/n) * Area * Math.pow(Rh, 2/3) * Math.sqrt(Slope);
      }

      // 2. Update Summary
      document.getElementById('res-tc').innerText = Tc.toFixed(1) + " min";
      document.getElementById('res-qsel').innerText = Qpeak.toFixed(2) + " m³/s";
      document.getElementById('res-stream').innerText = Qstr.toFixed(2) + " m³/s";
      
      // Adequacy
      let adq = "—";
      if(Qstr > Qpeak) adq = "<span class='status-ok'>OK</span>";
      else if(Qpeak > 0) adq = "<span class='status-fail'>Υπέρβαση</span>";
      document.getElementById('res-adequacy').innerHTML = adq;

      // 3. Update Visualizers
      drawBasin(A, L);
      drawChannel(b, h, z, h*0.7); // dummy water level

      // 4. Update Risk Table
      updateRiskTable(Akm2, C, D || Math.max(5, Tc));
      
      // 5. Update Badge in sidebar
      const basinName = document.getElementById('selectedBasin').innerText;
      if(basinName !== "—") {
          const badge = document.getElementById(`badge_${basinName}`);
          if(badge) {
              const Peq = I * ((D||Tc)/60) * C;
              badge.innerText = Peq.toFixed(1);
              badge.className = Peq > 20 ? "qbadge qb-red" : "qbadge qb-green";
          }
      }
  }

  function drawBasin(A, L) {
      const ctx = document.getElementById('basinCanvas').getContext('2d');
      ctx.clearRect(0,0,180,150);
      if(A<=0 || L<=0) return;
      
      // Simplified Rectangle representation
      const W = A/L;
      const scale = Math.min(160/L, 130/W);
      const dw = L*scale, dh = W*scale;
      
      ctx.fillStyle = "#e8f8f5"; ctx.fillRect(10, 10, dw, dh);
      ctx.strokeStyle = "#16a085"; ctx.strokeRect(10, 10, dw, dh);
      ctx.fillStyle = "#333"; ctx.fillText(`L=${L}m`, 10+dw/2-20, 10+dh+10);
  }

  function drawChannel(b, h, z, y) {
      const ctx = document.getElementById('channelCanvas').getContext('2d');
      ctx.clearRect(0,0,180,120);
      if(b<=0) return;
      
      const cx = 90, cy = 100;
      const scale = 50 / (h || 1);
      const topW = b + 2*z*h;
      
      // Draw Bank
      ctx.beginPath();
      ctx.moveTo(cx - topW*scale/2, cy - h*scale);
      ctx.lineTo(cx - b*scale/2, cy);
      ctx.lineTo(cx + b*scale/2, cy);
      ctx.lineTo(cx + topW*scale/2, cy - h*scale);
      ctx.strokeStyle = "#5d4037"; ctx.stroke();
      
      // Draw Water
      if(y>0) {
          const wy = Math.min(y, h);
          const wtop = b + 2*z*wy;
          ctx.beginPath();
          ctx.moveTo(cx - wtop*scale/2, cy - wy*scale);
          ctx.lineTo(cx - b*scale/2, cy);
          ctx.lineTo(cx + b*scale/2, cy);
          ctx.lineTo(cx + wtop*scale/2, cy - wy*scale);
          ctx.fillStyle = "rgba(52,152,219,0.5)"; ctx.fill();
      }
  }

  function updateRiskTable(Akm2, C, D) {
      const tb = document.getElementById('riskTableBody');
      tb.innerHTML = '';
      // Generate rows for intensities 20, 40, ... 100
      for(let i=20; i<=140; i+=20) {
          const Q = 0.278 * C * i * Akm2;
          const P = i * (D/60);
          const Peq = P * C;
          let cls = "risk-safe";
          if(Peq > 20) cls = "risk-warn";
          if(Peq > 40) cls = "risk-red";

          tb.innerHTML += `<tr class="${cls}">
            <td>${i}</td><td>${D.toFixed(1)}</td><td>${P.toFixed(1)}</td>
            <td>${Q.toFixed(2)}</td><td>${Peq.toFixed(1)}</td>
            <td>${cls==='risk-safe'?'Χαμηλή':(cls==='risk-warn'?'Μέτρια':'Υψηλή')}</td>
          </tr>`;
      }
  }

  // --- MAP ---
  let map;
  async function openMap(path) {
      document.getElementById('mapModal').style.display='block';
      if(!map) {
          map = L.map('mapBox').setView([38.02, 23.80], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      }
      
      // Clear prev layers
      map.eachLayer(l => { if(l instanceof L.GeoJSON) map.removeLayer(l); });

      const r = await fetch(RAW_URL + path);
      const g = await r.json();
      const l = L.geoJSON(g).addTo(map);
      map.fitBounds(l.getBounds());
  }

  // LISTENERS
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calcMaster));
  window.onload = initApp;

</script>
</body>
</html>
