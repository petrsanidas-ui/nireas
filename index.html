
<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P_eq Screening Tool (GitHub + Live Meteo)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- CSS Styles --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }
    .container { width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid #2c3e50; }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }
    
    .control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; text-align: left; }
    .panels-row { display: flex; gap: 10px; }
    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }
    .panel-rain { background: #fff3cd; border: 1px solid #ffeeba; }

    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { flex: 0 0 130px; font-weight: 600; }
    .form-group input, .form-group select { flex: 1; height: 28px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }

    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; font-weight: bold; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    /* Meteo Panel & List */
    #meteoPanel { background: #fdfefe; border: 1px solid #dcdcdc; border-radius: 6px; margin-bottom: 10px; }
    .mp-head { background: #f4f6f7; padding: 5px 10px; font-weight: bold; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .mp-body { padding: 8px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 10px; }
    th { background: #34495e; color: white; padding: 6px; }
    td { border: 1px solid #ddd; padding: 4px; text-align: center; }
    .qbadge { padding: 2px 6px; border-radius: 10px; color: #fff; font-weight: bold; font-size: 10px; }
    .qb-gray { background: #bdc3c7; } .qb-green { background: #27ae60; } .qb-red { background: #c0392b; }

    /* Map Modal */
    #mapModal { display: none; position: fixed; inset: 20px; background: white; border: 1px solid #ccc; z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.3); border-radius: 8px; }
    #mapBox { width: 100%; height: calc(100% - 40px); }
    #loader { display:none; background:#eaf2f8; color:#2980b9; padding:5px; font-size:11px; font-weight:bold; }
    
    button { cursor: pointer; }
    .mini-btn { padding: 2px 6px; font-size: 10px; background: #2c3e50; color: white; border: none; border-radius: 3px; }
  </style>
</head>
<body>

<div id="basinPanel" style="position:fixed; top:10px; left:10px; width:360px; max-height:90vh; overflow-y:auto; background:white; z-index:9000; box-shadow:0 0 10px rgba(0,0,0,0.2); border-radius:8px;">
  <div class="mp-head">
     <span>GitHub Data: <span style="color:#e67e22;">nireas</span></span>
     <button class="mini-btn" onclick="document.getElementById('basinPanelBody').style.display = document.getElementById('basinPanelBody').style.display==='none'?'block':'none'">Toggle</button>
  </div>
  <div id="loader">ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
  
  <div id="basinPanelBody">
    <div id="meteoPanel">
      <div class="mp-head">ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Î¯ Î£Ï„Î±Î¸Î¼Î¿Î¯ (Î‘Ï€ÏŒ stations.txt)</div>
      <div class="mp-body">
         <select id="meteoStationSelect" style="width:100%; height:30px; margin-bottom:5px; font-size:11px;"></select>
         <div style="font-size:9px; color:#7f8c8d; margin-bottom:5px;">
           *Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± live Î»Î±Î¼Î²Î¬Î½Î¿Î½Ï„Î±Î¹ Î¼Î­ÏƒÏ‰ Open-Meteo API Î³Î¹Î± Ï„Î·Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Ï„Î·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚.
         </div>
      </div>
    </div>

    <table>
      <thead><tr><th>Î›ÎµÎºÎ¬Î½Î·</th><th>P<sub>eq</sub></th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr></thead>
      <tbody id="basinRows"></tbody>
    </table>
  </div>
</div>

<div class="container">
  <h1>P<sub>eq</sub> Screening Tool</h1>
  
  <div class="control-panel">
    <div class="panel panel-rain">
      <h3>Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î’ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·Ï‚</h3>
      <div class="form-group">
        <label>ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
        <input type="number" id="rainI" value="0" step="0.1">
        <button class="mini-btn" style="margin-left:5px; background:#d35400;" onclick="fetchLiveMeteo()">Auto i (Live)</button>
      </div>
      <div class="form-group"><label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label><input type="number" id="rainD" value="0"></div>
      <div style="font-size:10px; color:#555; margin-top:4px;" id="meteoStatus">Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î»Î®ÏˆÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
    </div>

    <div class="panels-row">
      <div class="panel panel-geo">
         <h3>Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± (A, L, H, C)</h3>
         <div class="form-group"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0"></div>
         <div class="form-group"><label>ÎœÎ®ÎºÎ¿Ï‚ L (m):</label><input type="number" id="length" value="0"></div>
         <div class="form-group"><label>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿ H (m):</label><input type="number" id="height" value="0"></div>
         <div class="form-group"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40"></div>
      </div>
      <div class="panel panel-stream">
         <h3>Î¡Î­Î¼Î± / Î‘Î³Ï‰Î³ÏŒÏ‚</h3>
         <div class="form-group"><label>Î Î»Î¬Ï„Î¿Ï‚ b (m):</label><input type="number" id="strWidth" value="0"></div>
         <div class="form-group"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0"></div>
         <div class="form-group"><label>Manning n:</label><input type="number" id="strN" value="0.030"></div>
      </div>
    </div>
  </div>

  <div class="summary-box">
     <div class="stat-item">Qpeak (Rational)<span id="res-qsel">0.00</span></div>
     <div class="stat-item">Qcap (Manning)<span id="res-cap">0.00</span></div>
     <div class="stat-item">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·<span id="res-status">â€”</span></div>
  </div>
</div>

<div id="mapModal">
  <div style="padding:10px; background:#eee; display:flex; justify-content:space-between;">
    <b>Î§Î¬ÏÏ„Î·Ï‚</b> <button onclick="document.getElementById('mapModal').style.display='none'">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>
  <div id="mapBox"></div>
</div>

<script>
  // --- CONFIG (GitHub Pages-first) ---
  // Î£Ï„ÏŒÏ‡Î¿Ï‚: ÎšÎ‘ÎÎ•ÎÎ‘ embedded dataset Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ HTML. ÎŒÎ»Î± Ï„ÏÎ±Î²Î¹Î¿ÏÎ½Ï„Î±Î¹ live Î±Ï€ÏŒ Ï„Î¿ repo.
  const GH_USER   = 'petrsanidas-ui';
  const GH_REPO   = 'nireas';
  const GH_BRANCH = 'main';

  // 1) Directory listing Î³Î¹Î± basins Î¼Î­ÏƒÏ‰ GitHub API (Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î¿ Ï€Î»Î®Î¸Î¿Ï‚ Î±ÏÏ‡ÎµÎ¯Ï‰Î½)
  const API_BASINS_DIR = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/data/basins?ref=${GH_BRANCH}`;

  // 2) Î£Ï„Î±Ï„Î¹ÎºÏŒ site: Ï„Î± Î¯Î´Î¹Î± Î±ÏÏ‡ÎµÎ¯Î± ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÎºÎ±Î¹ Î±Ï€ÏŒ Ï„Î¿ GitHub Pages (same-origin)
  //    Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿Ï„Î¹Î¼ÏŒÏ„ÎµÏÎ¿ Î³Î¹Î± fetch Ï„Ï‰Î½ Î¯Î´Î¹Ï‰Î½ Ï„Ï‰Î½ GeoJSON (Ï€Î¹Î¿ Î³ÏÎ®Î³Î¿ÏÎ¿, Ï‡Ï‰ÏÎ¯Ï‚ API limits).
  const PAGES_BASE = './'; // ÎµÎ¯Î¼Î±ÏƒÏ„Îµ ÏƒÏ„Î¿ root Ï„Î¿Ï… GitHub Pages project
  const RAW_BASE   = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/`; // fallback

  // Optional: stations.txt path (same-origin)
  const STATIONS_PATH = 'data/weblinks/stations.txt';

  let BASINS = [];
  let SELECTED_BASIN = null; // { name, path, download_url }
  let SELECTED_BASIN_GEOMETRY = null; // GeoJSON Ï„Î·Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚

  function safeEncodePath(p) {
    // ÎšÏÎ±Ï„Î¬ÎµÎ¹ Ï„Î± / Î±Î»Î»Î¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹ÎµÎ¯ ÏƒÏ‰ÏƒÏ„Î¬ ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬/ÎºÎµÎ½Î¬
    return p.split('/').map(encodeURIComponent).join('/');
  }

  async function fetchWithFallback(relativePath, downloadUrl, asJson = true) {
    // 1) Î ÏÎ¿ÏƒÏ€Î¬Î¸ÎµÎ¹Î± Î±Ï€ÏŒ GitHub Pages (same-origin)
    const rel = PAGES_BASE + safeEncodePath(relativePath);
    try {
      const r1 = await fetch(rel, { cache: 'no-store' });
      if (r1.ok) return asJson ? await r1.json() : await r1.text();
      throw new Error('Pages fetch failed');
    } catch (_) {
      // 2) Fallback Î±Ï€ÏŒ raw.githubusercontent.com
      const raw = downloadUrl || (RAW_BASE + safeEncodePath(relativePath));
      const r2 = await fetch(raw, { cache: 'no-store' });
      if (!r2.ok) throw new Error(`Fetch failed: ${relativePath}`);
      return asJson ? await r2.json() : await r2.text();
    }
  }

  async function listBasinsFromGitHub() {
    const resp = await fetch(API_BASINS_DIR, {
      cache: 'no-store',
      headers: { 'Accept': 'application/vnd.github+json' }
    });
    if (!resp.ok) throw new Error(`GitHub API error (${resp.status})`);
    const items = await resp.json();
    // items: [{name, path, type, download_url, ...}]
    return items
      .filter(x => x.type === 'file' && (x.name || '').toLowerCase().endsWith('.geojson'))
      .map(x => ({
        name: x.name,
        path: x.path, // e.g. data/basins/map_2.geojson
        download_url: x.download_url
      }));
  }

  async function init() {
    const loader = document.getElementById('loader');
    loader.style.display = 'block';

    try {
      // 1) Basins (auto-discovery)
      BASINS = await listBasinsFromGitHub();
      renderBasinList();

      // 2) Stations
      await fetchStations(STATIONS_PATH);

    } catch (e) {
      console.error(e);
      alert("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±Ï€ÏŒ GitHub: " + (e.message || e));
    } finally {
      loader.style.display = 'none';
    }
  }

  // --- STATIONS LOGIC ---
  async function fetchStations(path) {
    try {
      const text = await fetchWithFallback(path, null, false);
      const lines = text.split('
');
      const sel = document.getElementById('meteoStationSelect');
      sel.innerHTML = '';

      let count = 0;
      lines.forEach(line => {
        if (!line.trim()) return;
        const opt = document.createElement('option');
        opt.text = line.trim();
        opt.value = line.trim();
        sel.add(opt);
        count++;
      });
      if (count === 0) sel.innerHTML = '<option>Î†Î´ÎµÎ¹Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ stations.txt</option>';
    } catch (e) {
      console.error("Error reading stations.txt", e);
      document.getElementById('meteoStationSelect').innerHTML = '<option>Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ/Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Ï„Î¿ stations.txt</option>';
    }
  }

  // --- LIVE METEO (Open-Meteo API) ---
  function getGeoJsonBboxCenter(geojson) {
    // Î¥Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÎ¹ ÎºÎ­Î½Ï„ÏÎ¿ Î±Ï€ÏŒ bbox (min/max lon/lat) Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ· ÏƒÏ„Î±Î¸ÎµÏÏŒÏ„Î·Ï„Î± Î±Ï€ÏŒ "Ï€ÏÏÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿"
    let minLon =  180, minLat =  90;
    let maxLon = -180, maxLat = -90;

    function walkCoords(coords) {
      if (typeof coords[0] === 'number' && typeof coords[1] === 'number') {
        const lon = coords[0], lat = coords[1];
        if (lon < minLon) minLon = lon;
        if (lat < minLat) minLat = lat;
        if (lon > maxLon) maxLon = lon;
        if (lat > maxLat) maxLat = lat;
        return;
      }
      coords.forEach(walkCoords);
    }

    try {
      if (geojson.type === 'FeatureCollection') {
        geojson.features.forEach(f => walkCoords(f.geometry.coordinates));
      } else if (geojson.type === 'Feature') {
        walkCoords(geojson.geometry.coordinates);
      } else if (geojson.coordinates) {
        walkCoords(geojson.coordinates);
      }
    } catch (e) {
      // ignore
    }

    if (minLon > maxLon || minLat > maxLat) return { lat: 38.02, lon: 23.80 }; // fallback
    return { lat: (minLat + maxLat) / 2, lon: (minLon + maxLon) / 2 };
  }

  async function fetchLiveMeteo() {
    const status = document.getElementById('meteoStatus');

    // Default: Î§Î±Î»Î¬Î½Î´ÏÎ¹
    let lat = 38.02, lon = 23.80;

    if (SELECTED_BASIN_GEOMETRY) {
      const c = getGeoJsonBboxCenter(SELECTED_BASIN_GEOMETRY);
      lat = c.lat; lon = c.lon;
    }

    status.innerText = `Î›Î®ÏˆÎ· Î±Ï€ÏŒ Open-Meteo (${lat.toFixed(3)}, ${lon.toFixed(3)})...`;

    try {
      // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ precipitation (Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ±) Ï‰Ï‚ proxy Î³Î¹Î± Î­Î½Ï„Î±ÏƒÎ· (mm/h)
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=precipitation&timezone=auto`;
      const resp = await fetch(url, { cache: 'no-store' });
      const data = await resp.json();

      const p = (data && data.current && typeof data.current.precipitation === 'number')
        ? data.current.precipitation
        : 0;

      document.getElementById('rainI').value = Number(p).toFixed(1);
      status.innerText = `Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±! Precipitation Ï„ÏÏÎ±: ${p} mm/h (ÏÏÎ±: ${data?.current?.time || '-'})`;

      calc();

    } catch (e) {
      status.innerText = "Î£Ï†Î¬Î»Î¼Î± Open-Meteo: " + (e.message || e);
    }
  }

  // --- BASINS LOGIC ---
  function renderBasinList() {
    const tbody = document.getElementById('basinRows');
    tbody.innerHTML = '';

    if (!BASINS.length) {
      tbody.innerHTML = '<tr><td colspan="3">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î»ÎµÎºÎ¬Î½ÎµÏ‚ (geojson) ÏƒÏ„Î¿ data/basins/</td></tr>';
      return;
    }

    BASINS.forEach(b => {
      const name = b.name;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${name}</td>
        <td><span id="badge_${cssSafeId(name)}" class="qbadge qb-gray">-</span></td>
        <td>
          <button class="mini-btn" onclick="loadBasin('${escapeJs(b.path)}','${escapeJs(name)}')">Load</button>
          <button class="mini-btn" onclick="showMap('${escapeJs(b.path)}')">Map</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function cssSafeId(s) {
    return String(s).replace(/[^a-zA-Z0-9_\-]/g, '_');
  }
  function escapeJs(s) {
    return String(s).replace(/\/g,'\\').replace(/'/g,"\'");
  }

  async function loadBasin(path, name) {
    const basin = BASINS.find(x => x.path === path) || { name, path, download_url: null };
    SELECTED_BASIN = basin;

    const json = await fetchWithFallback(basin.path, basin.download_url, true);
    SELECTED_BASIN_GEOMETRY = json;

    // Auto-fill inputs from properties (Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½)
    const p = (json.features && json.features[0]) ? (json.features[0].properties || {}) : {};

    if (p.area != null)   document.getElementById('area').value   = p.area;
    if (p.length != null) document.getElementById('length').value = p.length;
    if (p.height != null) document.getElementById('height').value = p.height;
    if (p.coef != null)   document.getElementById('coef').value   = p.coef;

    document.getElementById('meteoStatus').innerText = `Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Î· Î»ÎµÎºÎ¬Î½Î·: ${name}`;
    calc();
  }

  // --- CALCULATION ENGINE ---
  function calc() {
    const I = parseFloat(document.getElementById('rainI').value) || 0;
    const A = parseFloat(document.getElementById('area').value) || 0;
    const C = parseFloat(document.getElementById('coef').value) || 0;

    // Rational Method: Q = 0.278 * C * I * A(km2)
    const Akm2 = A / 1_000_000;
    const Qpeak = 0.278 * C * I * Akm2;

    document.getElementById('res-qsel').innerText = Qpeak.toFixed(2) + " mÂ³/s";
  }

  // Listeners
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calc));

  // --- MAP ---
  let map, lyr;
  async function showMap(path) {
    document.getElementById('mapModal').style.display='block';
    if (!map) {
      map = L.map('mapBox').setView([38.02, 23.80], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }
    if (lyr) lyr.remove();

    const basin = BASINS.find(x => x.path === path) || { path, download_url: null };
    const json = await fetchWithFallback(basin.path, basin.download_url, true);
    lyr = L.geoJSON(json).addTo(map);
    map.fitBounds(lyr.getBounds());
  }

  // Init
  window.onload = init;</script>
</body>
</html>
