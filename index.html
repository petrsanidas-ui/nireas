<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nireas Geo Data Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Ρυθμίσεις εμφάνισης */
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100%; width: 100%; }

        /* Οθόνη Φόρτωσης (Loading Screen) */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-text { font-size: 14px; color: #555; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status-text">Ανάκτηση δεδομένων από GitHub...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. ΡΥΘΜΙΣΕΙΣ (CONFIG) ---
        const REPO_OWNER = 'petrsanidas-ui'; 
        const REPO_NAME = 'nireas';
        const BRANCH = 'main';

        // --- 2. ΣΤΗΣΙΜΟ ΧΑΡΤΗ ---
        const map = L.map('map').setView([38.02, 23.80], 13); // Κέντρο: Αττική

        // Υπόβαθρο χάρτη (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Layers (για να τα ανοιγοκλείνουμε από το μενού)
        const layerGroups = {
            basins: L.layerGroup().addTo(map),     // Λεκάνες
            boundaries: L.layerGroup().addTo(map), // Όρια
            streams: L.layerGroup().addTo(map)     // Ρέματα
        };

        // Μενού ελέγχου Layers (πάνω δεξιά)
        L.control.layers(null, {
            "<span style='color:green'>Λεκάνες</span>": layerGroups.basins,
            "<span style='color:red'>Όρια Δήμου</span>": layerGroups.boundaries,
            "<span style='color:blue'>Ρέματα</span>": layerGroups.streams
        }).addTo(map);


        // --- 3. ΚΥΡΙΑ ΛΕΙΤΟΥΡΓΙΑ (AUTOMATION) ---
        async function loadData() {
            const status = document.getElementById('status-text');
            
            try {
                // Βήμα Α: Ρωτάμε το GitHub τι αρχεία υπάρχουν
                const treeUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${BRANCH}?recursive=1`;
                const response = await fetch(treeUrl);
                const data = await response.json();

                if (data.message) throw new Error("GitHub Error: " + data.message);

                // Βήμα Β: Ξεχωρίζουμε τα αρχεία που θέλουμε
                const files = data.tree.filter(f => f.type === 'blob'); // Μόνο αρχεία, όχι φάκελοι
                
                const targets = {
                    basins: files.filter(f => f.path.includes('data/basins/') && f.path.endsWith('.geojson')),
                    boundaries: files.filter(f => f.path.includes('data/boundaries/') && f.path.endsWith('.geojson')),
                    streams: files.filter(f => f.path.includes('data/streams/') && f.path.endsWith('.geojson'))
                };

                status.innerText = `Βρέθηκαν: ${targets.basins.length} λεκάνες, ${targets.streams.length} ρέματα...`;

                // Βήμα Γ: Κατεβάζουμε και εμφανίζουμε τα δεδομένα
                const rawBaseUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/`;

                // --- Φόρτωση Λεκανών (Πράσινο) ---
                await fetchAndMap(targets.basins, rawBaseUrl, layerGroups.basins, {
                    style: { color: 'green', weight: 1, fillOpacity: 0.2 }
                });

                // --- Φόρτωση Ορίων (Κόκκινο Διακεκομμένο) ---
                await fetchAndMap(targets.boundaries, rawBaseUrl, layerGroups.boundaries, {
                    style: { color: 'red', weight: 2, dashArray: '5, 5', fill: false }
                });

                // --- Φόρτωση Ρεμάτων (Μπλε) ---
                await fetchAndMap(targets.streams, rawBaseUrl, layerGroups.streams, {
                    style: { color: 'blue', weight: 3 }
                });

                // Απόκρυψη φόρτωσης
                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                console.error(error);
                status.innerText = "Σφάλμα: " + error.message;
                status.style.color = "red";
            }
        }

        // --- ΒΟΗΘΗΤΙΚΗ ΣΥΝΑΡΤΗΣΗ ---
        async function fetchAndMap(fileList, baseUrl, layerGroup, options) {
            const promises = fileList.map(file => 
                fetch(baseUrl + file.path)
                    .then(res => res.json())
                    .then(geoJson => {
                        // Προσθήκη στον χάρτη
                        L.geoJSON(geoJson, {
                            style: options.style,
                            onEachFeature: (feature, layer) => {
                                // Popup με το όνομα του αρχείου ή properties
                                let txt = `<strong>Αρχείο:</strong> ${file.path.split('/').pop()}`;
                                if (feature.properties && feature.properties.name) {
                                    txt += `<br><strong>Όνομα:</strong> ${feature.properties.name}`;
                                }
                                layer.bindPopup(txt);
                            }
                        }).addTo(layerGroup);
                    })
                    .catch(err => console.error("Error loading file:", file.path, err))
            );
            await Promise.all(promises);
        }

        // Εκκίνηση όταν φορτώσει η σελίδα
        window.onload = loadData;

    </script>
</body>
</html>
