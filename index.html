<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P_eq Screening Tool (GitHub + Live Meteo)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- CSS Styles --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }
    .container { width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 5px solid #2c3e50; }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }
    
    .control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; text-align: left; }
    .panels-row { display: flex; gap: 10px; }
    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }
    .panel-rain { background: #fff3cd; border: 1px solid #ffeeba; }

    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { flex: 0 0 130px; font-weight: 600; }
    .form-group input, .form-group select { flex: 1; height: 28px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }

    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; font-weight: bold; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    /* Meteo Panel & List */
    #meteoPanel { background: #fdfefe; border: 1px solid #dcdcdc; border-radius: 6px; margin-bottom: 10px; }
    .mp-head { background: #f4f6f7; padding: 5px 10px; font-weight: bold; font-size: 11px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .mp-body { padding: 8px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 10px; }
    th { background: #34495e; color: white; padding: 6px; }
    td { border: 1px solid #ddd; padding: 4px; text-align: center; }
    .qbadge { padding: 2px 6px; border-radius: 10px; color: #fff; font-weight: bold; font-size: 10px; }
    .qb-gray { background: #bdc3c7; } .qb-green { background: #27ae60; } .qb-red { background: #c0392b; }

    /* Map Modal */
    #mapModal { display: none; position: fixed; inset: 20px; background: white; border: 1px solid #ccc; z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.3); border-radius: 8px; }
    #mapBox { width: 100%; height: calc(100% - 40px); }
    #loader { display:none; background:#eaf2f8; color:#2980b9; padding:5px; font-size:11px; font-weight:bold; }
    
    button { cursor: pointer; }
    .mini-btn { padding: 2px 6px; font-size: 10px; background: #2c3e50; color: white; border: none; border-radius: 3px; }
  </style>
</head>
<body>

<div id="basinPanel" style="position:fixed; top:10px; left:10px; width:360px; max-height:90vh; overflow-y:auto; background:white; z-index:9000; box-shadow:0 0 10px rgba(0,0,0,0.2); border-radius:8px;">
  <div class="mp-head">
     <span>GitHub Data: <span style="color:#e67e22;">nireas</span></span>
     <button class="mini-btn" onclick="document.getElementById('basinPanelBody').style.display = document.getElementById('basinPanelBody').style.display==='none'?'block':'none'">Toggle</button>
  </div>
  <div id="loader">ğŸ”„ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
  
  <div id="basinPanelBody">
    <div id="meteoPanel">
      <div class="mp-head">ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Î¯ Î£Ï„Î±Î¸Î¼Î¿Î¯ (Î‘Ï€ÏŒ stations.txt)</div>
      <div class="mp-body">
         <select id="meteoStationSelect" style="width:100%; height:30px; margin-bottom:5px; font-size:11px;"></select>
         <div style="font-size:9px; color:#7f8c8d; margin-bottom:5px;">
           *Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± live Î»Î±Î¼Î²Î¬Î½Î¿Î½Ï„Î±Î¹ Î¼Î­ÏƒÏ‰ Open-Meteo API Î³Î¹Î± Ï„Î·Î½ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î± Ï„Î·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚.
         </div>
      </div>
    </div>

    <table>
      <thead><tr><th>Î›ÎµÎºÎ¬Î½Î·</th><th>P<sub>eq</sub></th><th>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th></tr></thead>
      <tbody id="basinRows"></tbody>
    </table>
  </div>
</div>

<div class="container">
  <h1>P<sub>eq</sub> Screening Tool</h1>
  
  <div class="control-panel">
    <div class="panel panel-rain">
      <h3>Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î’ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·Ï‚</h3>
      <div class="form-group">
        <label>ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
        <input type="number" id="rainI" value="0" step="0.1">
        <button class="mini-btn" style="margin-left:5px; background:#d35400;" onclick="fetchLiveMeteo()">Auto i (Live)</button>
      </div>
      <div class="form-group"><label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label><input type="number" id="rainD" value="0"></div>
      <div style="font-size:10px; color:#555; margin-top:4px;" id="meteoStatus">Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Î»Î®ÏˆÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
    </div>

    <div class="panels-row">
      <div class="panel panel-geo">
         <h3>Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± (A, L, H, C)</h3>
         <div class="form-group"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0"></div>
         <div class="form-group"><label>ÎœÎ®ÎºÎ¿Ï‚ L (m):</label><input type="number" id="length" value="0"></div>
         <div class="form-group"><label>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿ H (m):</label><input type="number" id="height" value="0"></div>
         <div class="form-group"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40"></div>
      </div>
      <div class="panel panel-stream">
         <h3>Î¡Î­Î¼Î± / Î‘Î³Ï‰Î³ÏŒÏ‚</h3>
         <div class="form-group"><label>Î Î»Î¬Ï„Î¿Ï‚ b (m):</label><input type="number" id="strWidth" value="0"></div>
         <div class="form-group"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0"></div>
         <div class="form-group"><label>Manning n:</label><input type="number" id="strN" value="0.030"></div>
      </div>
    </div>
  </div>

  <div class="summary-box">
     <div class="stat-item">Qpeak (Rational)<span id="res-qsel">0.00</span></div>
     <div class="stat-item">Qcap (Manning)<span id="res-cap">0.00</span></div>
     <div class="stat-item">ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·<span id="res-status">â€”</span></div>
  </div>
</div>

<div id="mapModal">
  <div style="padding:10px; background:#eee; display:flex; justify-content:space-between;">
    <b>Î§Î¬ÏÏ„Î·Ï‚</b> <button onclick="document.getElementById('mapModal').style.display='none'">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  </div>
  <div id="mapBox"></div>
</div>

<script>
  // --- CONFIG ---
  const GH_USER = 'petrsanidas-ui';
  const GH_REPO = 'nireas';
  const GH_BRANCH = 'main';
  const API_TREE = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/git/trees/${GH_BRANCH}?recursive=1`;
  const RAW_URL = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/`;

  let BASINS = [];
  let SELECTED_BASIN_GEOMETRY = null; // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î¿ GeoJSON Ï„Î·Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚ Î³Î¹Î± ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚

  async function init() {
    const loader = document.getElementById('loader');
    loader.style.display='block';
    
    try {
       // 1. Fetch File Tree
       const resp = await fetch(API_TREE);
       const data = await resp.json();
       if(data.message) throw new Error(data.message);
       
       const files = data.tree;

       // 2. Find Basins (.geojson)
       BASINS = files.filter(f => f.path.includes('data/basins/') && f.path.endsWith('.geojson'));
       renderBasinList();

       // 3. Find Stations (stations.txt)
       const stationFile = files.find(f => f.path.includes('stations.txt'));
       if(stationFile) {
          fetchStations(stationFile.path);
       } else {
          document.getElementById('meteoStationSelect').innerHTML = '<option>Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ stations.txt</option>';
       }

    } catch(e) {
       console.error(e);
       alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ GitHub: " + e.message);
    } finally {
       loader.style.display='none';
    }
  }

  // --- STATIONS LOGIC ---
  async function fetchStations(path) {
     try {
       const resp = await fetch(RAW_URL + path);
       const text = await resp.text();
       const lines = text.split('\n');
       const sel = document.getElementById('meteoStationSelect');
       sel.innerHTML = '';
       
       let count = 0;
       lines.forEach(line => {
          if(!line.trim()) return;
          // Î¥Ï€Î¿Î¸Î­Ï„Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Ï„Î¿ txt Î­Ï‡ÎµÎ¹ ÎµÎ¯Ï„Îµ ÏƒÎºÎ­Ï„Î± Î¿Î½ÏŒÎ¼Î±Ï„Î± ÎµÎ¯Ï„Îµ Î¼Î¿ÏÏ†Î® "ÎŒÎ½Î¿Î¼Î±|URL" Î® JSON
          // Î“Î¹Î± Î±Ï€Î»ÏŒÏ„Î·Ï„Î±, Î²Î¬Î¶Î¿Ï…Î¼Îµ ÏŒÎ»Î· Ï„Î· Î³ÏÎ±Î¼Î¼Î®
          const opt = document.createElement('option');
          opt.text = line.trim();
          opt.value = line.trim();
          sel.add(opt);
          count++;
       });
       if(count===0) sel.innerHTML = '<option>Î†Î´ÎµÎ¹Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ stations.txt</option>';
     } catch(e) {
       console.error("Error reading stations.txt", e);
     }
  }

  // --- LIVE METEO (Open-Meteo API) ---
  async function fetchLiveMeteo() {
      const status = document.getElementById('meteoStatus');
      
      // Î§ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚. Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î»ÎµÎºÎ¬Î½Î·, Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ ÎºÎ­Î½Ï„ÏÎ¿ Î‘Î¸Î®Î½Î±Ï‚
      let lat = 38.02, lon = 23.80; // Default: Î§Î±Î»Î¬Î½Î´ÏÎ¹/Î‘Î³.Î Î±ÏÎ±ÏƒÎºÎµÏ…Î®

      if (SELECTED_BASIN_GEOMETRY) {
          // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ­Î½Ï„ÏÎ¿Ï… (Centroid) Î±Ï€ÏŒ Ï„Î¿ GeoJSON Î±Ï€Î»Î¿ÏŠÎºÎ¬
          // (Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Ï€ÏÏÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ Ï„Î¿Ï… Ï€Î¿Î»Ï…Î³ÏÎ½Î¿Ï…)
          try {
             const coords = SELECTED_BASIN_GEOMETRY.features[0].geometry.coordinates[0][0];
             // GeoJSON is [lon, lat], OpenMeteo needs lat, lon
             lon = coords[0];
             lat = coords[1];
          } catch(e) { console.warn("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚, Ï‡ÏÎ®ÏƒÎ· Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚"); }
      }

      status.innerText = `Î›Î®ÏˆÎ· Î±Ï€ÏŒ Open-Meteo (${lat.toFixed(3)}, ${lon.toFixed(3)})...`;
      
      try {
          // Open-Meteo API Call (Current Weather)
          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=rain,showers&timezone=auto`;
          const resp = await fetch(url);
          const data = await resp.json();
          
          const rain = data.current.rain + data.current.showers; // mm
          
          // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ Î­Î½Ï„Î±ÏƒÎ· ÏÏÎ±Ï‚ (Ï€ÎµÏÎ¯Ï€Î¿Ï…) Î® Î»Î®ÏˆÎ· Î±ÎºÏÎ¹Î²Î¿ÏÏ‚ Ï„Î¹Î¼Î®Ï‚
          // Î¤Î¿ open-meteo Î´Î¯Î½ÎµÎ¹ rain rate Ï„Î· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î· ÏƒÏ„Î¹Î³Î¼Î®
          document.getElementById('rainI').value = rain.toFixed(1);
          status.innerText = `Î•Ï€Î¹Ï„Ï…Ï‡Î¯Î±! Î’ÏÎ¿Ï‡Î® Ï„ÏÏÎ±: ${rain} mm (ÏÏÎ±: ${data.current.time})`;
          
          calc(); // Î•Ï€Î±Î½Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚

      } catch(e) {
          status.innerText = "Î£Ï†Î¬Î»Î¼Î± Open-Meteo: " + e.message;
      }
  }

  // --- BASINS LOGIC ---
  function renderBasinList() {
     const tbody = document.getElementById('basinRows');
     tbody.innerHTML = '';
     BASINS.forEach(b => {
        const name = b.path.split('/').pop();
        const tr = document.createElement('tr');
        tr.innerHTML = `
           <td>${name}</td>
           <td><span id="badge_${name}" class="qbadge qb-gray">-</span></td>
           <td>
             <button class="mini-btn" onclick="loadBasin('${b.path}', '${name}')">Load</button>
             <button class="mini-btn" onclick="showMap('${b.path}')">Map</button>
           </td>
        `;
        tbody.appendChild(tr);
     });
  }

  async function loadBasin(path, id) {
     const resp = await fetch(RAW_URL + path);
     const json = await resp.json();
     SELECTED_BASIN_GEOMETRY = json; // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î³Î¹Î± Ï„Î¿ Meteo API
     
     // Try to auto-fill inputs from properties
     const p = json.features && json.features[0] ? json.features[0].properties : {};
     if(p.area) document.getElementById('area').value = p.area;
     if(p.length) document.getElementById('length').value = p.length;
     if(p.height) document.getElementById('height').value = p.height;
     if(p.coef) document.getElementById('coef').value = p.coef;
     
     document.getElementById('meteoStatus').innerText = `Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ Î· Î»ÎµÎºÎ¬Î½Î·: ${id}`;
     calc();
  }

  // --- CALCULATION ENGINE ---
  function calc() {
     const I = parseFloat(document.getElementById('rainI').value)||0;
     const A = parseFloat(document.getElementById('area').value)||0;
     const C = parseFloat(document.getElementById('coef').value)||0;
     
     // Rational Method: Q = 0.278 * C * I * A(km2)
     const Akm2 = A / 1000000;
     const Qpeak = 0.278 * C * I * Akm2;
     
     document.getElementById('res-qsel').innerText = Qpeak.toFixed(2) + " mÂ³/s";
     
     // Update Badges in Table
     if(SELECTED_BASIN_GEOMETRY) {
        // Find current basin ID name (a bit hacky, normally we'd store ID)
        // Just generic update
     }
  }
  
  // Listeners
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calc));

  // --- MAP ---
  let map, lyr;
  async function showMap(path) {
     document.getElementById('mapModal').style.display='block';
     if(!map) {
       map = L.map('mapBox').setView([38.02, 23.80], 13);
       L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
     }
     if(lyr) lyr.remove();
     
     const resp = await fetch(RAW_URL + path);
     const json = await resp.json();
     lyr = L.geoJSON(json).addTo(map);
     map.fitBounds(lyr.getBounds());
  }

  // Init
  window.onload = init;
</script>
</body>
</html>
