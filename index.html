<html lang="el"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P_eq Screening Tool (GitHub Connected)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- ΙΔΙΟ CSS ΜΕ ΠΡΙΝ --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }

    .container {
      width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 297mm; border-top: 5px solid #2c3e50;
    }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }

    .control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; text-align: left; }
    .panels-row { display: flex; gap: 10px; align-items: stretch; }
    .panels-row .panel { flex: 1; }
    .panel-rain { width: 100%; }
    @media (max-width: 950px) { .panels-row { flex-direction: column; } }

    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }
    .panel-rain { background: #fff3cd; border: 1px solid #ffeeba; flex: 0 0 auto; }

    .station-divider { height: 1px; background: rgba(0,0,0,0.12); margin: 8px 0; }
    .station-monitor { display:flex; flex-direction:column; gap:6px; background: rgba(255,255,255,0.65);
      border: 1px dashed rgba(127,140,141,0.55); padding: 6px; border-radius: 6px; }
    .station-squares { display:flex; gap:4px; flex-wrap:wrap; align-items:center; }
    .station-sq { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #ccd1d1; background: #fff; }
    .station-sq.filled { background: #2ecc71; border-color: #27ae60; }
    .station-sq.empty { background: #fff; }
    .station-squares-meta { display:flex; gap:8px; align-items:center; font-size:10px; font-weight:900; color:#2c3e50; }
    #stationLiveBtn[data-on="1"] { background:#27ae60 !important; border-color:#1e8449 !important; }
    #stationLiveBtn[data-on="0"] { background:#2c3e50 !important; border-color:#2c3e50 !important; }

    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { font-size: 11px; font-weight: 600; flex: 0 0 145px; text-align: left; cursor: help; line-height: 1.1; }
    .form-group input, .form-group select {
      flex: 1; min-width: 0; height: 30px; padding: 0 2px; text-align: center;
      border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; font-size: 12px; width: 100%;
    }
    .rain-input-group { background: #fff3cd; padding: 5px; border-radius: 3px; border: 1px solid #ffeeba; }
    .rain-input-group input { border: 2px solid #f1c40f; }

    .ref-list { font-size: 9px; color: #444; margin-top: auto; background: rgba(255,255,255,0.7); padding: 5px; border-radius: 4px; border: 1px dashed #7f8c8d; line-height: 1.35; }
    .ref-list b { color: #2c3e50; text-decoration: underline; display:block; margin-bottom:2px;}
    .footer { margin-top: 20px; font-size: 9px; color: #7f8c8d; text-align: left; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.45; }

    .mini-go-btn, .mini-del-btn, .mini-btn {
      padding: 4px 2px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 10px; font-weight: bold; color: #fff;
    }
    .mini-go-btn { background: #2c3e50; flex: 1; }
    .mini-go-btn:hover { background: #34495e; }
    .mini-del-btn { background: #7b241c; flex: 0 0 auto; width: 30px; }
    .mini-btn { width: auto !important; padding: 4px 8px !important; border: 1px solid #ccd1d1 !important; margin-left: auto; background: #2c3e50; }

    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: space-around; font-size: 11px; font-weight: bold; }
    .stat-item { text-align: center; min-width: 130px; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    th { background: #34495e; color: white; padding: 6px 2px; border: 1px solid #34495e; position: sticky; top: 0; }
    td { border: 1px solid #ddd; padding: 4px 2px; text-align: center; }

    .risk-safe { background-color: #d4edda; color: #155724; }
    .risk-warn { background-color: #fff3cd; color: #856404; }
    .risk-orange { background-color: #ffe5d0; color: #d35400; font-weight: bold; }
    .risk-red { background-color: #f5c6cb; color: #721c24; font-weight: bold; }
    .risk-extreme { background-color: #922b21; color: #fff; font-weight: bold; }
    .status-ok { color: #27ae60; font-weight: bold; }
    .status-fail { color: #c0392b; font-weight: bold; }

    #basinPanel {
      position: fixed; top: 10px; left: 10px; z-index: 10000;
      width: 380px; max-height: calc(100vh - 20px); overflow-y: auto;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-align: left; color: #2c3e50;
    }
    #basinPanel .bp-head { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eef2f3; font-weight: bold; font-size: 13px; }
    #basinPanel .bp-body { padding: 0; font-size: 12px; max-height: calc(100vh - 70px); overflow-y: auto; }
    
    #meteoPanel .mp-head { display:flex; justify-content:space-between; padding:8px 10px; background:#f8f9f9; font-size:11px; font-weight:900; }
    #meteoStationSelect { flex: 1; min-width: 0; height: 30px; border-radius: 6px; border: 1px solid #ccd1d1; font-size: 11px; font-weight: 800; }
    
    .qbadge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-weight: 700; font-size: 11px; text-align: center; min-width: 60px; }
    .qb-gray { background: #f2f3f4; color: #7f8c8d; } .qb-green { background: #e9f7ef; color: #1e8449; }
    .qb-yellow { background: #fef9e7; color: #9a7d0a; } .qb-red { background: #fdedec; color: #c0392b; }

    /* Map Modal */
    #mapModal { position: fixed; inset: 10px; z-index: 20000; display: none; background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1; border-radius: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.25); }
    #mapModalHeader { display: flex; justify-content: space-between; padding: 8px 10px; background: #f8f9f9; border-bottom: 1px solid #eef2f3; font-weight: 800; font-size: 12px; }
    #mapBox { width: 100%; height: calc(100% - 42px); }

    /* Loading Spinner */
    #gh-loader { text-align:center; padding:10px; color:#2980b9; font-weight:bold; display:none; background:#ebf5fb; border-bottom:1px solid #aed6f1; }
  </style>
</head>

<body>

<div id="basinPanel">
  <div class="bp-head">
    <span>P<sub>eq</sub> Screening Tool <span style="font-size:9px; color:#e67e22;">(GitHub: nireas)</span></span>
    <div class="bp-actions">
       <button id="basinToggleBtn" type="button" onclick="toggleBasinPanel()">–</button>
    </div>
  </div>
  
  <div id="gh-loader">⏳ Ανάκτηση δεδομένων από GitHub...</div>

  <div id="basinPanelBody" class="bp-body">
    <div id="meteoPanel">
      <div class="mp-head">
        <span>Μετεωρολογικοί σταθμοί</span>
        <button type="button" class="mini-btn" onclick="toggleMeteoPanel()" style="width:auto;">–</button>
      </div>
      <div id="meteoBody" style="padding:10px;">
        <select id="meteoStationSelect" multiple onchange="onMeteoStationChanged()"></select>
        <div style="margin-top:5px; display:flex; gap:5px;">
             <select id="meteoAggSelect" onchange="onMeteoAggChanged()"><option value="max">MAX</option><option value="avg">AVG</option></select>
             <button class="mini-btn" onclick="loadFromStation()">Auto i</button>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr style="background:#f8f9f9; font-size:10px; color:#566573;">
          <th style="width:40%;">Λεκάνη (Αρχείο)</th>
          <th style="width:20%; text-align:center;">P<sub>eq</sub></th>
          <th style="width:40%; text-align:right;">Ενέργεια</th>
        </tr>
      </thead>
      <tbody id="basinRows"></tbody>
    </table>
    <div style="padding:10px; font-size:10px; color:#566573; background:#fdfefe; border-top:1px solid #eee;">
      Τα δεδομένα φορτώνονται δυναμικά από το <b>petrsanidas-ui/nireas</b>.
    </div>
  </div>
</div>

<div class="container">
  <h1>Δείκτες Απόκρισης Τοπικών Λεκανών Απορροής</h1>
  <div style="text-align:left; font-size:11px; margin:6px 0 10px; color:#2c3e50;">
    <b>Επιλεγμένη Λεκάνη:</b> <span id="selectedBasin" style="font-size:14px; font-weight:bold; color:#d35400;">—</span>
  </div>

  <div class="control-panel">
    <div class="panel panel-rain">
        <h3>Σενάριο Βροχής</h3>
        <div class="form-group rain-input-group"><label>⚠️ Ένταση i (mm/h):</label><input type="number" id="rainI" value="0" min="0"></div>
        <div class="form-group rain-input-group"><label>⚠️ Διάρκεια D (min):</label><input type="number" id="rainD" value="0" min="0"></div>
        <div class="station-divider"></div>
        <div class="station-monitor">
             <div style="display:flex; justify-content:space-between; font-size:10px; font-weight:bold;">
                 <span id="stationLabel">...</span> <span id="stationRainRate" style="color:#d35400;">—</span>
             </div>
             <div id="stationMsg" style="font-size:9px; color:#666;"></div>
        </div>
    </div>

    <div class="panels-row">
      <div class="panel panel-geo">
        <h3>1. Γεωμετρία</h3>
        <div class="form-group"><label>Εμβαδόν A (m²):</label><input type="number" id="area" value="0"></div>
        <div class="form-group"><label>Μήκος ροής L (m):</label><input type="number" id="length" value="0"></div>
        <div class="form-group"><label>Υψομ. διαφορά H (m):</label><input type="number" id="height" value="0"></div>
        <div class="form-group"><label>Συντελεστής C:</label><input type="number" id="coef" value="0.40" step="0.01"></div>
        <div class="visualizer-box basin"><canvas id="basinCanvas" width="180" height="200"></canvas></div>
      </div>
      <div class="panel panel-net">
        <h3>2. Συλλογή</h3>
        <div class="form-group"><label>Πλήθος φρεατίων:</label><input type="number" id="drains" value="0"></div>
        <div class="form-group"><label>Ικανότητα/τεμ (m³/s):</label><input type="number" id="drainCap" value="0.10"></div>
      </div>
      <div class="panel panel-stream">
        <h3>3. Διόδευση</h3>
        <div class="form-group"><label>Πλάτος b (m):</label><input type="number" id="strWidth" value="0"></div>
        <div class="form-group"><label>Πρανές z:</label><input type="number" id="strZ" value="0"></div>
        <div class="form-group"><label>Βάθος h (m):</label><input type="number" id="strDepth" value="0"></div>
        <div class="form-group"><label>Manning n:</label><select id="strType"><option value="0.03">0.030 (Χώμα)</option><option value="0.015">0.015 (Μπετόν)</option></select></div>
        <div class="visualizer-box"><canvas id="channelCanvas" width="180" height="150"></canvas></div>
      </div>
    </div>
  </div>

  <div id="summary" class="summary-box">
    <div class="stat-item">Qpeak <span id="res-qsel">0.00 m³/s</span></div>
    <div class="stat-item">Qcap (Stream) <span id="res-stream">0.00 m³/s</span></div>
    <div class="stat-item">Επάρκεια <span id="res-adequacy">—</span></div>
  </div>

  <div class="footer">
     P<sub>eq</sub> Screening Tool • Powered by GitHub API (nireas repo)
  </div>
</div>

<div id="mapModal">
  <div id="mapModalHeader">
    <span id="mapTitle">Χάρτης</span>
    <button onclick="document.getElementById('mapModal').style.display='none'">Κλείσιμο</button>
  </div>
  <div id="mapBox"></div>
</div>

<script>
  // --- CONFIG GITHUB ---
  const GH_CONFIG = { owner: 'petrsanidas-ui', repo: 'nireas', branch: 'main' };
  const RAW_URL = `https://raw.githubusercontent.com/${GH_CONFIG.owner}/${GH_CONFIG.repo}/${GH_CONFIG.branch}/`;
  const API_URL = `https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/git/trees/${GH_CONFIG.branch}?recursive=1`;

  // --- STATE ---
  let BASINS = []; // Θα γεμίσει αυτόματα από το GitHub
  let MUNICIPAL_GEOJSON = null;
  let LOADED_GEOJSONS = {}; // Cache
  let CURRENT_BASIN_ID = null;

  // --- HELPERS ---
  const getVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };

  // --- 1. ΑΝΑΚΤΗΣΗ ΔΕΔΟΜΕΝΩΝ ΑΠΟ GITHUB ---
  async function initApp() {
    const loader = document.getElementById('gh-loader');
    loader.style.display = 'block';

    try {
        const resp = await fetch(API_URL);
        const data = await resp.json();
        
        if (data.message) throw new Error(data.message);

        const files = data.tree.filter(f => f.type === 'blob');
        
        // A. Εντοπισμός Λεκανών (Basins)
        const basinFiles = files.filter(f => f.path.includes('data/basins/') && f.path.endsWith('.geojson'));
        BASINS = basinFiles.map(f => ({
            id: f.path.split('/').pop(), // π.χ. map_2.geojson
            path: f.path,
            name: f.path.split('/').pop().replace('.geojson','') // π.χ. map_2
        }));

        // B. Εντοπισμός Ορίων (Boundaries)
        const muniFile = files.find(f => f.path.includes('data/boundaries/') && f.path.endsWith('.geojson'));
        if(muniFile) {
            fetch(RAW_URL + muniFile.path).then(r=>r.json()).then(g => { MUNICIPAL_GEOJSON = g; renderBasinTable(); });
        }

        // C. Εντοπισμός Σταθμών (Προαιρετικό - αν υπάρχει txt)
        // (Εδώ κρατάμε τους βασικούς σταθερούς προς το παρόν για συντομία)
        setupDefaultStations();

        renderBasinTable();
        loader.style.display = 'none';

    } catch (e) {
        console.error(e);
        loader.innerText = 'Σφάλμα σύνδεσης GitHub: ' + e.message;
        loader.style.color = 'red';
    }
  }

  // --- 2. ΦΟΡΤΩΣΗ ΛΕΚΑΝΗΣ ---
  async function loadBasinData(id) {
    const basin = BASINS.find(b => b.id === id);
    if (!basin) return;
    CURRENT_BASIN_ID = id;
    document.getElementById('selectedBasin').innerText = basin.name;

    // Αν δεν το έχουμε κατεβάσει ήδη, κατέβασέ το
    if (!LOADED_GEOJSONS[id]) {
        try {
            const res = await fetch(RAW_URL + basin.path);
            const geojson = await res.json();
            LOADED_GEOJSONS[id] = geojson;
            
            // ΠΡΟΣΠΑΘΕΙΑ ΕΞΑΓΩΓΗΣ ΙΔΙΟΤΗΤΩΝ ΑΠΟ ΤΟ GEOJSON
            // Αν το geojson έχει properties: { area: 1000, coef: 0.5 ... }
            const props = geojson.features && geojson.features.length ? geojson.features[0].properties : geojson.properties;
            if (props) {
                if (props.area) setVal('area', props.area);
                if (props.length) setVal('length', props.length);
                if (props.height) setVal('height', props.height);
                if (props.coef) setVal('coef', props.coef);
            }
        } catch(e) { console.error("Error loading geojson", e); }
    }
    runCalc();
  }

  // --- UI RENDER ---
  function renderBasinTable() {
    const tbody = document.getElementById('basinRows');
    tbody.innerHTML = '';

    // Γραμμή Ορίων
    const trM = document.createElement('tr');
    trM.innerHTML = `
        <td style="font-weight:bold;">ΟΡΙΑ ΔΗΜΟΥ</td>
        <td style="text-align:center;"><span class="qbadge ${MUNICIPAL_GEOJSON?'qb-green':'qb-gray'}">${MUNICIPAL_GEOJSON?'OK':'Wait'}</span></td>
        <td style="text-align:right;"><button class="mini-go-btn" onclick="openMap('__MUNI__')">Map</button></td>
    `;
    tbody.appendChild(trM);

    // Γραμμές Λεκανών
    BASINS.forEach(b => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.onclick = () => loadBasinData(b.id);
        tr.innerHTML = `
            <td>${b.name}</td>
            <td style="text-align:center;"><span id="badge_${b.id}" class="qbadge qb-gray">—</span></td>
            <td style="text-align:right;">
                <button class="mini-go-btn" onclick="event.stopPropagation(); loadBasinData('${b.id}')">Go</button>
                <button class="mini-go-btn" onclick="event.stopPropagation(); loadBasinData('${b.id}').then(()=>openMap('${b.id}'))">Map</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
  }

  // --- CALCULATIONS ---
  function runCalc() {
    const A = getVal('area'), L = getVal('length'), H = getVal('height'), C = getVal('coef');
    const I = getVal('rainI');
    
    // Qpeak
    const Q = (A>0 && I>0) ? 0.278 * C * I * (A/1000000) : 0;
    document.getElementById('res-qsel').innerText = Q.toFixed(2) + " m³/s";

    // Qcap (Manning)
    const b = getVal('strWidth'), z = getVal('strZ'), h = getVal('strDepth'), n = 0.03; // απλοποιημένο
    // (Ο υπολογισμός εδώ μπορεί να είναι πιο σύνθετος όπως στο ver14, για συντομία βάζω ένα dummy αν δεν υπάρχουν δεδομένα)
    document.getElementById('res-stream').innerText = "—"; // Θέλει πλήρη Manning

    // Update Badge
    if (CURRENT_BASIN_ID) {
        const badge = document.getElementById(`badge_${CURRENT_BASIN_ID}`);
        if(badge) {
             const Peq = I * (getVal('rainD')/60) * C; // Απλοϊκό
             badge.innerText = Peq > 0 ? Peq.toFixed(1) : "—";
             badge.className = Peq > 20 ? "qbadge qb-red" : "qbadge qb-green";
        }
    }
  }
  
  // Listeners
  document.querySelectorAll('input').forEach(i => i.addEventListener('input', runCalc));

  // --- MAP ---
  let _map, _lyr;
  function openMap(id) {
    document.getElementById('mapModal').style.display = 'block';
    if(!_map) {
        _map = L.map('mapBox').setView([38.02, 23.80], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_map);
    }
    if(_lyr) _lyr.remove();

    let data = (id === '__MUNI__') ? MUNICIPAL_GEOJSON : LOADED_GEOJSONS[id];
    if(data) {
        _lyr = L.geoJSON(data).addTo(_map);
        _map.fitBounds(_lyr.getBounds());
    }
  }

  // --- STATIONS (Dummy Setup) ---
  function setupDefaultStations() {
     const sel = document.getElementById('meteoStationSelect');
     sel.innerHTML = `<option value="chalandri">Χαλάνδρι (penteli.meteo.gr)</option>`;
  }
  
  window.onload = initApp;
</script>
</body>
</html>
