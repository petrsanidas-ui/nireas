<html lang="el"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Î”ÎµÎ¯ÎºÏ„ÎµÏ‚ Î‘Ï€ÏŒÎºÏÎ¹ÏƒÎ·Ï‚ Î¤Î¿Ï€Î¹ÎºÏÎ½ Î›ÎµÎºÎ±Î½ÏÎ½ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚ (P_eq Screening Tool)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- GENERAL & LAYOUT --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }

    .container {
      width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 297mm; border-top: 5px solid #2c3e50;
    }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }

    /* --- PANELS --- */
    .control-panel { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; text-align: left; }
  .panels-row { display: flex; gap: 10px; align-items: stretch; }
  .panels-row .panel { flex: 1; }
  .panel-rain { width: 100%; }
  @media (max-width: 950px) { .panels-row { flex-direction: column; } }

    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }
    /* --- RAIN PANEL (GLOBAL) --- */
    .right-col { flex: 2; display: flex; flex-direction: column; gap: 10px; }
    .right-row { flex: 1; display: flex; gap: 10px; align-items: stretch; }
    .panel-rain { background: #fff3cd; border: 1px solid #ffeeba; flex: 0 0 auto; }

    /* --- STATION MONITOR (MAIN PANEL) --- */
    .station-divider { height: 1px; background: rgba(0,0,0,0.12); margin: 8px 0; }
    .station-monitor { display:flex; flex-direction:column; gap:6px; background: rgba(255,255,255,0.65);
      border: 1px dashed rgba(127,140,141,0.55); padding: 6px; border-radius: 6px; }
    .station-squares { display:flex; gap:4px; flex-wrap:wrap; align-items:center; }
    .station-sq { width: 14px; height: 14px; border-radius: 3px; border: 1px solid #ccd1d1; background: #fff; }
    .station-sq.filled { background: #2ecc71; border-color: #27ae60; }
    .station-sq.empty { background: #fff; }
    .station-squares-meta { display:flex; gap:8px; align-items:center; font-size:10px; font-weight:900; color:#2c3e50; }
    #stationLiveBtn[data-on="1"] { background:#27ae60 !important; border-color:#1e8449 !important; }
    #stationLiveBtn[data-on="0"] { background:#2c3e50 !important; border-color:#2c3e50 !important; }



    /* --- FORMS --- */
    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { font-size: 11px; font-weight: 600; flex: 0 0 145px; text-align: left; cursor: help; line-height: 1.1; }
    .form-group input, .form-group select {
      flex: 1; min-width: 0; height: 30px; padding: 0 2px; text-align: center;
      border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; font-size: 12px; width: 100%;
    }
    .form-group select { font-size: 11px; text-align: left; padding-left: 4px; }

    .rain-input-group { background: #fff3cd; padding: 5px; border-radius: 3px; border: 1px solid #ffeeba; }
    .rain-input-group input { border: 2px solid #f1c40f; }

    /* --- TEXT & REFS --- */
    .ref-list { font-size: 9px; color: #444; margin-top: auto; background: rgba(255,255,255,0.7); padding: 5px; border-radius: 4px; border: 1px dashed #7f8c8d; line-height: 1.35; }
    .ref-list b { color: #2c3e50; text-decoration: underline; display:block; margin-bottom:2px;}
    .footer { margin-top: 20px; font-size: 9px; color: #7f8c8d; text-align: left; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.45; }

    /* --- BUTTONS --- */
    button.main-action { width: 100%; padding: 10px; background: #c0392b; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
    button.main-action:hover { background: #a93226; }

    /* --- CSS FIX: Removed @extend logic and used standard grouping --- */
    .mini-go-btn, .mini-del-btn, .mini-btn {
      padding: 4px 2px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 10px; font-weight: bold; color: #fff;
    }
    
    .mini-go-btn { background: #2c3e50; flex: 1; }
    .mini-go-btn:hover { background: #34495e; }
    
    .mini-del-btn { background: #7b241c; flex: 0 0 auto; width: 30px; }
    .mini-del-btn:hover { background: #922b21; }
    
    .mini-btn { width: auto !important; padding: 4px 8px !important; border: 1px solid #ccd1d1 !important; margin-left: auto; background: #2c3e50; }
    .mini-btn:hover { background: #34495e; }

    /* --- TABLES & SUMMARY --- */
    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: space-around; font-size: 11px; font-weight: bold; }
    .stat-item { text-align: center; min-width: 130px; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    th { background: #34495e; color: white; padding: 6px 2px; border: 1px solid #34495e; position: sticky; top: 0; word-wrap: break-word; }
    td { border: 1px solid #ddd; padding: 4px 2px; text-align: center; word-wrap: break-word; }

    /* --- COLORS & STATUS --- */
    .risk-safe { background-color: #d4edda; color: #155724; }
    .risk-warn { background-color: #fff3cd; color: #856404; }
    .risk-orange { background-color: #ffe5d0; color: #d35400; font-weight: bold; }
    .risk-red { background-color: #f5c6cb; color: #721c24; font-weight: bold; }
    .risk-extreme { background-color: #922b21; color: #fff; font-weight: bold; }

    .status-ok { color: #27ae60; font-weight: bold; }
    .status-warn { color: #d35400; font-weight: bold; }
    .status-fail { color: #c0392b; font-weight: bold; }
    tr.risk-extreme .status-fail, tr.risk-extreme .status-warn, tr.risk-extreme .status-ok { color: #fff !important; }

    /* --- SIDE PANEL (BASINS) --- */
    #basinPanel {
      position: fixed; top: 10px; left: 10px; z-index: 10000;
      width: 380px; max-height: calc(100vh - 20px); overflow-y: auto;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-align: left; color: #2c3e50;
    }
    #basinPanel .bp-head { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eef2f3; font-weight: bold; font-size: 13px; }
    #basinPanel .bp-body { padding: 0; font-size: 12px; max-height: calc(100vh - 70px); overflow-y: auto; overflow-x: hidden; }
    #basinPanel .bp-actions { display:flex; gap:8px; align-items:center; }
    
    #exportHtmlBtn, #autoSaveBtn { width:auto; padding:4px 10px; font-size:11px; font-weight:800; border-radius:6px; cursor:pointer; }
    #exportHtmlBtn { background:#2c3e50; color:#fff; border:1px solid #2c3e50; }
    #exportHtmlBtn:hover { background:#34495e; }
    
    #autoSaveBtn { background:#ecf0f1; color:#2c3e50; border:1px solid #ccd1d1; }
    #autoSaveBtn:hover { background:#f8f9f9; }
    #autoSaveBtn[data-mode="on"] { background:#d5f5e3; border-color:#82e0aa; }
    #autoSaveBtn[data-mode="off"] { opacity:0.75; }

    #basinToggleBtn { width:auto; padding:4px 10px; font-size:14px; font-weight:900; background:#f7f9f9; color:#2c3e50; border:1px solid #ccc; border-radius:6px; cursor:pointer; }

    #basinPanel table { table-layout: auto; }
    #basinPanel th, #basinPanel td { overflow: visible; vertical-align: middle; }


    /* --- METEO STATIONS (SIDE PANEL) --- */
    #meteoPanel { border-bottom: 1px solid #eef2f3; }
    #meteoPanel .mp-head {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px; background:#f8f9f9; border-bottom: 1px solid #eef2f3;
      font-size: 11px; font-weight: 900;
    }
    #meteoPanel .mp-head-actions { display:flex; gap:6px; align-items:center; }
    #meteoPanel .mp-icon-btn {
      width: 30px; height: 28px; border-radius: 6px; border: 1px solid #ccd1d1;
      background: #fff; cursor: pointer; font-weight: 900; color: #2c3e50;
    }
    #meteoPanel .mp-icon-btn:hover { background:#f2f3f4; }
    #meteoPanel .mp-body { padding: 8px 10px 10px; background: rgba(255,255,255,0.55); }
    #meteoPanel .mp-row { display:flex; gap:6px; align-items:center; }
    #meteoStationSelect {
      flex: 1; min-width: 0; height: 30px; border-radius: 6px; border: 1px solid #ccd1d1;
      font-size: 11px; font-weight: 800; padding: 0 6px; background: #fff;
    }
        #meteoPanel .mp-row-top { align-items: flex-start; }
    #meteoStationSelect[multiple] { height: 86px; padding: 4px 6px; font-weight: 700; }

    /* Highlight selected meteo stations inside the list (space-saving, no pills below) */
    #meteoStationSelect option:checked {
      background-color: #d4f7df !important;
      color: #1e5631 !important;
    }
    #meteoFavs { display: none !important; } /* hide the green pills row */
    .mp-selected-summary { margin-top: 6px; font-size: 11px; font-weight: 800; color: #2e4053; }

    #meteoAggSelect {
      width: 60px; height: 30px; border-radius: 6px; border: 1px solid #ccd1d1;
      font-size: 11px; font-weight: 900; padding: 0 6px; background: #fff;
    }
#meteoPanel .mp-body .mini-btn { margin-left: 0; padding: 4px 10px !important; }
    #meteoPanel .mp-msg { font-size: 9px; color: #566573; text-align: right; margin-top: 6px; }
    #meteoPanel .mp-favs { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
    #meteoPanel .mp-fav {
      font-size: 10px; padding: 4px 8px; border-radius: 12px; border: 1px solid #ccd1d1;
      background: #fff; cursor: pointer; font-weight: 900; color: #2c3e50;
    }
    #meteoPanel .mp-fav:hover { background:#f8f9f9; }
    #meteoPanel .mp-fav.active { background:#d5f5e3; border-color:#82e0aa; }
    
    /* Badges */
    .qbadge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-weight: 700; font-size: 11px; text-align: center; min-width: 60px; border: 1px solid transparent; }
    .qb-gray { background: #f2f3f4; color: #7f8c8d; border-color: #d5d8dc; }
    .qb-green { background: #e9f7ef; color: #1e8449; border-color: #abebc6; }
    .qb-yellow { background: #fef9e7; color: #9a7d0a; border-color: #f9e79f; }
    .qb-orange { background: #fbeee6; color: #d35400; border-color: #edbb99; }
    .qb-red { background: #fdedec; color: #c0392b; border-color: #fadbd8; }
    .qb-extreme { background: #922b21; color: #fff; border-color: #7b241c; }

    /* --- LEGEND --- */
    .footer-grid { display: flex; gap: 14px; align-items: flex-start; }
    .footer-left { flex: 1; }
    #severityLegend { width: 290px; flex: 0 0 290px; background: #fbfcfc; border: 1px solid #ccd1d1; border-radius: 6px; overflow: hidden; }
    #severityLegend .legend-title { background: #f2f3f4; border-bottom: 1px solid #e5e7e9; padding: 6px 8px; font-weight: 900; font-size: 10px; text-align: center; }
    #severityLegend td.key { width: 92px; white-space: nowrap; font-weight: 900; background: #f8f9f9; }

    /* --- VISUALIZER --- */
    .visualizer-box { margin: 8px 0; background: #fff; border: 1px solid #d2b4de; border-radius: 4px; text-align: center; padding: 5px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

    
    .visualizer-box.basin { border: 1px solid #a2d9ce; background: #e8f8f5; }

    /* Basin legend moved outside canvas (so the basin drawing stays fully visible) */
    #basinLegend.basin-legend {
      margin: 4px auto 2px;
      padding: 4px 6px;
      background: rgba(255,255,255,0.86);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 6px;
      font-size: 9px;
      color: #2c3e50;
      display: inline-block;
      text-align: left;
      max-width: 170px;
      box-sizing: border-box;
    }
    #basinLegend .bl-row { display: flex; align-items: center; gap: 6px; }
    #basinLegend .bl-row + .bl-row { margin-top: 2px; }
    #basinLegend .bl-swatch {
      width: 14px; height: 14px; border: 1px solid rgba(0,0,0,0.20);
      display: inline-block; border-radius: 3px; flex: 0 0 14px;
    }
    #basinLegend .bl-line {
      width: 14px; height: 0; border-top: 3px solid #7f8c8d;
      display: inline-block; border-radius: 3px; flex: 0 0 14px;
    }
    #basinLegend .bl-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
/* --- PRINT & MAP --- */
    #printFrame {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      border: 2px solid red; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); 
      z-index: 10000; pointer-events: none; transition: width 0.3s, height 0.3s; display: none;
    }
    #printFrame::after { content: "Î ÎµÏÎ¹Î¿Ï‡Î® Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚"; position: absolute; top: -20px; left: 0; color: white; background: red; font-size: 10px; padding: 2px 5px; font-weight: bold; }

    /* Responsive */
    :root{ --bp-w: 380px; --bp-gap: 30px; }
    @media (min-width: 1250px){
      body{ padding-left: calc(20px + var(--bp-w) + var(--bp-gap)); }
      .container{ margin-left: auto; margin-right: auto; }
    }
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; margin: 0; width: 100%; border: none; padding: 0; }
      .no-print { display: none !important; }
      body.print-map-mode #mapModal.no-print { display: block !important; position: fixed !important; inset: 0 !important; border: none !important; border-radius: 0 !important; box-shadow: none !important; background: #fff !important; }
      body.print-map-mode #mapModalHeader { display: none !important; }
      body.print-map-mode #mapBox { height: 100vh !important; }
      body.print-map-mode .container, body.print-map-mode #basinPanel { display: none !important; }
    }
    @media (max-width: 1100px) {
      .container { width: 100%; min-height: auto; }
      .control-panel { flex-wrap: wrap; }
      .panel { min-width: 100%; }
      .right-col { flex: 1 1 100%; }
      .right-row { flex-direction: column; }
      #basinPanel { width: 95vw; left: 2.5vw; }
      .footer-grid { flex-wrap: wrap; }
      #severityLegend { width: 100%; flex: 1 1 100%; }
      .form-group label { flex: 0 0 140px; }
    }

    /* Map Modal */
    #mapModal {
      position: fixed; inset: 10px; z-index: 20000; display: none;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1;
      border-radius: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.25); overflow: hidden; text-align: left;
    }
    #mapModalHeader {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-bottom: 1px solid #eef2f3; background: #f8f9f9;
      font-weight: 800; font-size: 12px; color: #2c3e50;
    }
    #mapBox { width: 100%; height: calc(100% - 42px); position: relative; }
    #mapCloseBtn, #mapPrintBtn { width: auto; padding: 4px 10px; font-size: 11px; background: #2c3e50; border-radius: 6px; color: #fff; border: none; cursor: pointer; }
    #mapHeaderActions { display:flex; gap:8px; align-items:center; }
    
    /* Hints */
    .zero-hint-wrap { position: relative; flex: 1; min-width: 0; }
    .zero-hint-wrap .zero-hint {
      position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
      text-align: center; color: #666; font-weight: normal; font-size: 12px;
      pointer-events: none; display: none; z-index: 2;
    }
    .zero-hint-wrap.show-hint .zero-hint { display: block; }
    .zero-hint-wrap input { position: relative; z-index: 1; }
    .zero-hint-wrap.show-hint input { color: transparent; -webkit-text-fill-color: transparent; }
  </style>
</head>

<body>

<div id="basinPanel" class="no-print">
  <div class="bp-head">
    <span>Î¤Î±Ï‡ÎµÎ¯Î± Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·<br>P<sub>eq</sub> = PÂ·C (mm)</span>
    <div class="bp-actions">
      <button id="exportHtmlBtn" type="button" onclick="exportHtmlWithEmbeddedGeoJSON()">Export HTML</button>
      <button id="autoSaveBtn" type="button" onclick="toggleAutoSaveMode()" title="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·" data-mode="ask">AutoSave: ASK</button>
      <button id="basinToggleBtn" type="button" onclick="toggleBasinPanel()">â€“</button>
    </div>
  </div>
  <div id="basinPanelBody" class="bp-body">

    <div id="meteoPanel">
      <div class="mp-head">
        <span>ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Î¯ ÏƒÏ„Î±Î¸Î¼Î¿Î¯</span>
        <div class="mp-head-actions">
          <button type="button" class="mp-icon-btn" onclick="addMeteoStation()" title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î±Î¸Î¼Î¿Ï">+</button>
          <button type="button" class="mp-icon-btn" onclick="deleteSelectedMeteoStation()" title="Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ—‘</button>
          <button type="button" class="mp-icon-btn" id="meteoToggleBtn" onclick="toggleMeteoPanel()" title="Î‘Î½Î¬Ï€Ï„Ï…Î¾Î·/ÏƒÏÎ¼Ï€Ï„Ï…Î¾Î·">â€“</button>
        </div>
      </div>
      <div id="meteoBody" class="mp-body" style="display: block;">
        <div class="mp-row mp-row-top">
          <select id="meteoStationSelect" multiple="" size="4" onchange="onMeteoStationChanged()" title="Ctrl/âŒ˜ Î³Î¹Î± Ï€Î¿Î»Î»Î±Ï€Î»Î® ÎµÏ€Î¹Î»Î¿Î³Î®"><option value="chalandri">Î§Î±Î»Î¬Î½Î´ÏÎ¹ (penteli.meteo.gr)</option><option value="S1766645340857">ÎÎŸÎœÎ™Î£ÎœÎ‘Î¤ÎŸÎšÎŸÎ Î•Î™ÎŸ</option><option value="S1766645582266">Î•Î›Î›Î—ÎÎŸÎ“Î‘Î›Î›Î™ÎšÎŸ Î‘Î“Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—</option><option value="S1766645619060">Î‘Î“Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—</option><option value="S1766645721457">Î Î‘Î›Î‘Î™ÎŸÎ¥ Î¨Î¥Î§Î™ÎšÎŸÎ¥ / ÎšÎŸÎ›Î›Î•Î“Î™ÎŸ</option><option value="S1766645789407">Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î / ÎšÎ‘ÎÎ¤Î‘</option><option value="S1766645834676">Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î 1Î¿ Î“Î¥ÎœÎÎ‘Î£Î™ÎŸ</option><option value="S1766645935205">Î Î‘Î Î‘Î“ÎŸÎ¥/Î‘Î¤Î¤Î™ÎšÎ— ÎŸÎ”ÎŸÎ£</option><option value="S1766645962108">Î“Î•Î¡Î‘ÎšÎ‘Î£ / 2Î¿ Î“Î¥ÎœÎÎ‘Î£Î™ÎŸ</option><option value="S1766647246784">ÎœÎ‘Î¡ÎŸÎ¥Î£Î™/ Î£Î§ÎŸÎ›Î— ursulines</option></select>
          <select id="meteoAggSelect" onchange="onMeteoAggChanged()" title="Î£Ï…Î½Î´Ï…Î±ÏƒÎ¼ÏŒÏ‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Ï€Î¿Î»Î»Î¿Î¯ ÏƒÏ„Î±Î¸Î¼Î¿Î¯)">
            <option value="max">MAX</option>
            <option value="avg">AVG</option>
            <option value="min">MIN</option>
          </select>
          <button type="button" class="mini-btn" onclick="loadFromStation()" title="Î›Î®ÏˆÎ· Î­Î½Ï„Î±ÏƒÎ·Ï‚ i (mm/h)">Auto i</button>
          <button type="button" class="mini-btn" onclick="openSelectedStation()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÏ„Î±Î¸Î¼Î¿Ï ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±">Î†Î½Î¿Î¹Î³Î¼Î±</button>
        </div>
        <div id="meteoSelectedSummary" class="mp-selected-summary">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Î¹: 3 (MAX)</div>
        <div id="meteoMsg" class="mp-msg">Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚: ÎÎŸÎœÎ™Î£ÎœÎ‘Î¤ÎŸÎšÎŸÎ Î•Î™ÎŸ</div>
        <div id="meteoFavs" class="mp-favs"><button type="button" class="mp-fav" title="https://penteli.meteo.gr/stations/chalandri/">Î§Î±Î»Î¬Î½Î´ÏÎ¹ (penteli.mâ€¦</button><button type="button" class="mp-fav" title="https://penteli.meteo.gr/stations/delacroix-attiki/">Î‘Î“Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—</button><button type="button" class="mp-fav active" title="https://penteli.meteo.gr/stations/nomismatokopeio/">ÎÎŸÎœÎ™Î£ÎœÎ‘Î¤ÎŸÎšÎŸÎ Î•Î™ÎŸ</button></div>
      </div>
    </div>
    <table>
      <thead>
        <tr style="background:#f8f9f9; font-size:10px; color:#566573;">
          <th style="width:35%;">Î›ÎµÎºÎ¬Î½Î·</th>
          <th style="width:20%; text-align:center;">P<sub>eq</sub></th>
          <th style="width:45%; text-align:right;">Î•Ï€Î¹Î»Î¿Î³Î®</th>
        </tr>
      </thead>
      <tbody id="basinRows"><tr><td style="font-weight:900;font-size:10px">ÎŸÎ¡Î™Î‘ Î”Î—ÎœÎŸÎ¥</td><td style="text-align:center"><span class="qbadge qb-green">OK</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;"><input type="file" id="f_muni" style="display:none" onchange="onMunicipalSelected(this.files[0])" accept=".json,.geojson">
      <button type="button" class="mini-go-btn" onclick="openMapModal('__MUNICIPAL__')" style="">Map</button> <button type="button" class="mini-go-btn" onclick="document.getElementById('f_muni').click()" style="color:#82e0aa">JSON</button>
      <button type="button" class="mini-del-btn" onclick="if(confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÏÎ¯Ï‰Î½;')){delgeojson('municipal',null);renderbasintable();}" style="">ğŸ—‘</button></td></tr><tr><td style="font-weight:900;font-size:10px">â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— Î›Î•ÎšÎ‘ÎÎ—Î£</td><td style="text-align:center"><span class="qbadge qb-gray">+</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;"><input type="file" id="f_add" style="display:none" onchange="onAddBasinSelected(this.files[0])" accept=".json,.geojson">
      <button type="button" class="mini-go-btn" onclick="document.getElementById('f_add').click()" style="">JSON</button>
      <button type="button" class="mini-go-btn" onclick="if(confirm('Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏÏ…Î¼Î¼Î­Î½Ï‰Î½;')){lshelper.del(keys.hidden);rebuildbasins();renderbasintable();}" style="">â†º</button></td></tr><tr style="cursor: pointer;"><td style="font-size:10px">U5118 â€” map (2)</td>
        <td style="text-align:center"><span id="badge_U5118" class="qbadge qb-yellow">19.5 mm</span></td>
        <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;"><input type="file" id="f_U5118" style="display:none" onchange="onGeoJsonSelected('U5118',this.files[0])" accept=".json,.geojson">
        <button type="button" class="mini-go-btn" onclick="event.stopPropagation();loadBasin(0,true)" style="">Go</button> <button type="button" class="mini-go-btn" onclick="event.stopPropagation();openMapModal('U5118')" style="">Map</button>
        <button type="button" class="mini-go-btn" onclick="event.stopPropagation();document.getElementById('f_U5118').click()" style="color:#82e0aa">JSON</button>
        <button type="button" class="mini-del-btn" onclick="event.stopPropagation();deleteBasinById('U5118')" style="">ğŸ—‘</button></td></tr><tr style="cursor: pointer;"><td style="font-size:10px">U2907 â€” map (1)</td>
        <td style="text-align:center"><span id="badge_U2907" class="qbadge qb-yellow">19.5 mm</span></td>
        <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;"><input type="file" id="f_U2907" style="display:none" onchange="onGeoJsonSelected('U2907',this.files[0])" accept=".json,.geojson">
        <button type="button" class="mini-go-btn" onclick="event.stopPropagation();loadBasin(1,true)" style="">Go</button> <button type="button" class="mini-go-btn" onclick="event.stopPropagation();openMapModal('U2907')" style="">Map</button>
        <button type="button" class="mini-go-btn" onclick="event.stopPropagation();document.getElementById('f_U2907').click()" style="color:#82e0aa">JSON</button>
        <button type="button" class="mini-del-btn" onclick="event.stopPropagation();deleteBasinById('U2907')" style="">ğŸ—‘</button></td></tr></tbody>
    </table>
    <div style="padding:10px; font-size:11px; color:#566573; background:#fdfefe; border-top:1px solid #eee;">
      <b>ÎŸÎ´Î·Î³Î¯Î±:</b> Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ <b>ÎˆÎ½Ï„Î±ÏƒÎ· (i)</b> ÎºÎ±Î¹ <b>Î”Î¹Î¬ÏÎºÎµÎ¹Î± (D)</b> ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ Ï€Î¬Î½ÎµÎ».<br>â€¢ Î‘Î½ D=0, Ï…Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Ï„Î¿ Tc ÎºÎ¬Î¸Îµ Î»ÎµÎºÎ¬Î½Î·Ï‚ (min 5').
    </div>
  </div>
</div>

<div class="container">
  <h1 style="display:flex; justify-content:space-between; align-items:center;">
    <span>Î”ÎµÎ¯ÎºÏ„ÎµÏ‚ Î‘Ï€ÏŒÎºÏÎ¹ÏƒÎ·Ï‚ Î¤Î¿Ï€Î¹ÎºÏÎ½ Î›ÎµÎºÎ±Î½ÏÎ½ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</span>
    <button onclick="openPrintView()" class="no-print" style="background:#2c3e50; color:#fff; border:none; font-size:12px; font-weight:bold; padding:6px 14px; border-radius:4px; cursor:pointer;">Î•ÎšÎ¤Î¥Î Î©Î£Î—</button>
  </h1>
  <div style="text-align:left; font-size:11px; margin:6px 0 10px; color:#2c3e50;">
    <b>Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î›ÎµÎºÎ¬Î½Î·:</b> <span id="selectedBasin" style="font-size:14px; font-weight:bold; color:#d35400;">U2907 â€” map (1)</span>
  </div>

  <div class="control-panel">
    <div class="panel panel-rain">
        <h3>Î£ÎµÎ½Î¬ÏÎ¹Î¿ Î’ÏÎ¿Ï‡Î®Ï‚</h3>
        <div class="form-group rain-input-group">
          <label title="Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î·Î½ Î­Î½Ï„Î±ÏƒÎ· Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ Î¤Î±Ï‡ÎµÎ¯Î± Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·.">âš ï¸ ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
          <input type="number" id="rainI" value="0" min="0" step="1">
        </div>
        <div class="form-group rain-input-group">
          <label title="Î‘Î½ 0, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ Tc ÎºÎ¬Î¸Îµ Î»ÎµÎºÎ¬Î½Î·Ï‚ (Min 5 min).">âš ï¸ Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label>
          <input type="number" id="rainD" value="0" min="0" step="1">
        </div>

        <div class="station-divider"></div>

        <h3>ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚</h3>
        <div class="form-group" style="margin-top:2px;">
          <label>Î£Ï„Î±Î¸Î¼ÏŒÏ‚:</label>
          <div style="flex:1; display:flex; gap:6px; align-items:center; min-width:0;">
            <span id="stationLabel" style="flex:1; font-weight:900; font-size:11px; color:#2c3e50; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">3 ÏƒÏ„Î±Î¸Î¼Î¿Î¯ (MAX)</span>
            <button type="button" class="mini-btn" onclick="loadFromStation()">Auto i</button>
            <button type="button" class="mini-btn" id="stationLiveBtn" data-on="0" onclick="toggleStationLive()">Live</button>
            <button type="button" class="mini-btn" onclick="openSelectedStation()">Î†Î½Î¿Î¹Î³Î¼Î±</button>
          </div>
        </div>

        <div class="form-group" style="margin-top:0;">
          <label title="Î— ÏÏÎ±/Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Ï„Î·Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î±Ï‚ Î¼Î­Ï„ÏÎ·ÏƒÎ·Ï‚ ÏŒÏ€Ï‰Ï‚ Ï„Î· Î´Î¯Î½ÎµÎ¹ Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚.">Timestamp:</label>
          <div style="flex:1; text-align:left; font-weight:900; color:#2c3e50;">
            <span id="stationTimestamp">â€”</span>
            <span id="stationAge" style="font-weight:800; color:#566573; margin-left:8px; font-size:10px;"></span>
          </div>
        </div>

        <div class="form-group" style="margin-top:-2px;">
          <label title="Î£ÏÎ½Î¿ÏˆÎ· Î²ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î±Ï€ÏŒ Ï„Î¿Î½ ÏƒÏ„Î±Î¸Î¼ÏŒ. Î¤Î¿ Î”P ÎºÎ±Î¹ Ï„Î¿ R60â€² Î²Î±ÏƒÎ¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î· Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬ Ï€Î¿Ï… Ï‡Ï„Î¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ station timestamp.">Î’ÏÎ¿Ï‡Î®:</label>
          <div style="flex:1; text-align:left; font-weight:900; color:#2c3e50; display:flex; flex-wrap:wrap; gap:10px; align-items:baseline;">
            <span title="Rain Rate / Î¡Î±Î³Î´Î±Î¹ÏŒÏ„Î·Ï„Î± (mm/h).">i: <span id="stationRainRate">â€”</span> mm/h</span>
            <span title="Î”P = Î´Î¹Î±Ï†Î¿ÏÎ¬ ÏƒÏ‰ÏÎµÏ…Ï„Î¹ÎºÎ®Ï‚ Î²ÏÎ¿Ï‡Î®Ï‚ (Storm Total Î® Today's Rain) Î¼ÎµÏ„Î±Î¾Ï Î´ÏÎ¿ Î´Î¹Î±Î´Î¿Ï‡Î¹ÎºÏÎ½ station timestamps.">Î”P: <span id="stationDeltaP">â€”</span> mm</span>
            <span title="R60â€² = Î¬Î¸ÏÎ¿Î¹ÏƒÎ¼Î± Î”P Ï„Ï‰Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ 60â€² (Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î± station timestamps).">R60â€²: <span id="stationR60">â€”</span> mm</span>
            <span title="Today's Rain / Î£Î·Î¼ÎµÏÎ¹Î½ÏŒÏ‚ Î¥ÎµÏ„ÏŒÏ‚ (mm).">Î£Î®Î¼ÎµÏÎ±: <span id="stationToday">â€”</span> mm</span>
            <span title="Storm Total / Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎºÎ±ÎºÎ¿ÎºÎ±Î¹ÏÎ¯Î± (mm).">Storm: <span id="stationStorm">â€”</span> mm</span>
            <span id="stationTotalSrc" style="font-size:10px; color:#566573; font-weight:800;"></span>
          </div>
        </div>

        <div class="station-monitor" aria-label="Î Î±ÏÎ¬Î¸Ï…ÏÎ¿ Î´ÎµÎ¹Î³Î¼Î¬Ï„Ï‰Î½ (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ 12 ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹Ï‚)">
          <div class="station-squares" id="stationSquares">
            <span class="station-sq empty" title="1"></span><span class="station-sq empty" title="2"></span><span class="station-sq empty" title="3"></span><span class="station-sq empty" title="4"></span>
            <span class="station-sq empty" title="5"></span><span class="station-sq empty" title="6"></span><span class="station-sq empty" title="7"></span><span class="station-sq empty" title="8"></span>
            <span class="station-sq empty" title="9"></span><span class="station-sq empty" title="10"></span><span class="station-sq empty" title="11"></span><span class="station-sq empty" title="12"></span>
          </div>
          <div class="station-squares-meta">
            <span id="stationSeriesMeta">Î”ÎµÎ¯Î³Î¼Î±Ï„Î±: 0/12</span>
            <span style="color:#566573; font-weight:800;">(ÎÎ­Î¿ Î´ÎµÎ¯Î³Î¼Î± Î¼ÏŒÎ½Î¿ ÏŒÏ„Î±Î½ Î±Î»Î»Î¬Î¾ÎµÎ¹ Ï„Î¿ station timestamp)</span>
            <button type="button" class="mini-btn" style="margin-left:auto;" onclick="clearStationSeries()">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
          </div>
        </div>

        <div id="stationMsg" style="font-size:9px; color:#666; text-align:right;">Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚: ÎÎŸÎœÎ™Î£ÎœÎ‘Î¤ÎŸÎšÎŸÎ Î•Î™ÎŸ</div>
      </div>
    <div class="panels-row">
      <div class="panel panel-geo">
      <h3>1. Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± </h3>
      <div class="form-group"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0" min="0"></div>
      <div class="form-group"><label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ¿Î®Ï‚ L (m):</label><input type="number" id="length" value="0" min="0"></div>
      <div class="form-group"><label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†Î¿ÏÎ¬ H (m):</label><input type="number" id="height" value="0" min="0"></div>
      <div class="form-group"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40" step="0.01" min="0" max="1"></div>

      <div class="visualizer-box basin" title="Î£Ï‡Î·Î¼Î±Ï„Î¹ÎºÎ® (Î® Î±Ï€ÏŒ GeoJSON) Î¿Ï€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· ÎºÎ¬Ï„Î¿ÏˆÎ·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚">
        <canvas id="basinCanvas" width="180" height="280"></canvas>
        <div id="basinLegend" class="basin-legend" aria-label="Î¥Ï€ÏŒÎ¼Î½Î·Î¼Î± Î¿Ï€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ Î»ÎµÎºÎ¬Î½Î·Ï‚"><div class="bl-row">
          <span class="bl-swatch" style="background:rgba(243,156,18,0.28);"></span>
          <span class="bl-text" title="C=0.40 (Î¼Î­Ï„ÏÎ¹Î±)">C=0.40 (Î¼Î­Ï„ÏÎ¹Î±)</span>
        </div>
        <div class="bl-row">
          <span class="bl-line" style="border-top-color:#27ae60;"></span>
          <span class="bl-text" title="ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: OK (49.17/9.50)">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: OK (49.17/9.50)</span>
        </div></div>
        <div style="font-size: 9px; color: #666; font-style: italic;"><b>ÎŸÏ€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î›ÎµÎºÎ¬Î½Î·Ï‚</b></div>
      </div>
      
      <div class="ref-list">
        <b>Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ­Ï‚ Î¤Î¹Î¼Î­Ï‚ C:</b> 1.00: Î†ÏƒÏ†Î±Î»Ï„Î¿Ï‚/ÎœÏ€ÎµÏ„ÏŒÎ½<br>0.70â€“0.90: Î Ï…ÎºÎ½Î® Î±ÏƒÏ„Î¹ÎºÎ® Î´ÏŒÎ¼Î·ÏƒÎ·<br>
        0.40â€“0.60: Î‘ÏÎ±Î¹Î® Î´ÏŒÎ¼Î·ÏƒÎ· / Ï€ÎµÏ„ÏÏÎ´ÎµÏ‚<br>0.15â€“0.35: Î¦Ï…ÏƒÎ¹ÎºÏŒ Î­Î´Î±Ï†Î¿Ï‚ / Î´Î¬ÏƒÎ¿Ï‚
      </div>
    </div>
      <div class="panel panel-net">
      <h3>2. Î£Ï…Î»Î»Î¿Î³Î® (Î¦ÏÎµÎ¬Ï„Î¹Î±)</h3>
      <div class="form-group"><label>Î Î»Î®Î¸Î¿Ï‚:</label><input type="number" id="drains" value="0" min="0"></div>
      <div class="form-group"><label>Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿ (mÂ³/s):</label><input type="number" id="drainCap" value="0.10" step="0.01" min="0"></div>
      <div class="ref-list">
        <b>Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ¬ (mÂ³/s Î±Î½Î¬ Ï†ÏÎµÎ¬Ï„Î¹Î¿):</b> 0.15â€“0.20: ÎœÎµÎ³Î¬Î»Î· ÏƒÏ‡Î¬ÏÎ±<br>0.10: Î¤Ï…Ï€Î¹ÎºÎ® ÏƒÏ‡Î¬ÏÎ± Î´ÏÏŒÎ¼Î¿Ï…<br>
        0.05: ÎœÎµÏÎ¹ÎºÏÏ‚ Ï†ÏÎ±Î³Î¼Î­Î½Î·<br>0.00: Î¦ÏÎ±Î³Î¼Î­Î½Î·
        <b>Î ÏÎ¿ÎºÎ±Ï„Î±ÏÎºÏ„Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ (screening):</b>Î•Î»Î­Î³Ï‡ÎµÎ¹ Î±Î½ Ï„Î¿ Î´Î¯ÎºÏ„Ï…Î¿ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±Î»Î¬Î²ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ¿Ï‡Î® Î±Î¹Ï‡Î¼Î®Ï‚ (Inlet Control).
      </div>
    </div>
      <div class="panel panel-stream">
      <h3>3. Î”Î¹ÏŒÎ´ÎµÏ…ÏƒÎ· (Î¡Î­Î¼Î±)</h3>
      <div class="form-group"><label title="Î Î»Î¬Ï„Î¿Ï‚ Ï€Ï…Î¸Î¼Î­Î½Î±">Î Î»Î¬Ï„Î¿Ï‚ b (m) :</label><input type="number" id="strWidth" value="0" min="0" step="0.1"></div>
      <div class="form-group"><label title="z = ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± / ÎšÎ¬Î¸ÎµÏ„Î· (0 = ÎŸÏÎ¸Î¿Î³Ï‰Î½Î¹ÎºÎ®)">Î ÏÎ±Î½Î­Ï‚ z (H:V):</label><input type="number" id="strZ" value="0" min="0" step="0.1" placeholder="0 = Box"></div>
      <div class="form-group"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0" min="0" step="0.1"></div>
      <div class="form-group">
        <label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ­Î¼Î±Ï„Î¿Ï‚ (m):</label>
        <div class="zero-hint-wrap show-hint"><span class="zero-hint">0 = L</span><input type="number" id="strLen" value="0" min="0" placeholder="0 = L"></div>
      </div>
      <div class="form-group">
        <label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†. (m):</label>
        <div class="zero-hint-wrap show-hint"><span class="zero-hint">0 = H</span><input type="number" id="strDrop" value="0" min="0"></div>
      </div>
      <div class="form-group">
        <label style="flex: 0 0 100px;">n (Manning):</label>
        <select id="strType">
          <option value="0.015">ÎœÏ€ÎµÏ„ÏŒÎ½ (0.015)</option>
          <option value="0.03" selected="">Î§ÏÎ¼Î± (0.030)</option>
          <option value="0.05">Î Î­Ï„ÏÎµÏ‚ (0.050)</option>
        </select>
      </div>
      <div class="form-group" style="background:#eaf2f8; padding:2px; border-radius:4px; border:1px dashed #aed6f1; margin-bottom:4px;">
        <label style="color:#2980b9; flex: 0 0 115px;">ÎÏˆÎ¿Ï‚ Î½ÎµÏÎ¿Ï y:</label>
        <button type="button" onclick="resetStrY()" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¿ Auto" style="width:26px; height:26px; padding:0; border:1px solid #aed6f1; background:#fff; color:#2980b9; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:4px; font-size:12px; line-height: 1;">â†º</button>
        <input type="number" id="strY" step="0.01" min="0" placeholder="Auto" oninput="if(this.value===''){ delete this.dataset.manual; } else { this.dataset.manual='true'; } runMasterCalculation();" style="font-weight:bold; color:#2980b9;">
      </div>
      <div class="visualizer-box">
        <canvas id="channelCanvas" width="180" height="220"></canvas>
        <div style="font-size: 9px; color: #666; font-style: italic;"><b>ÎŸÏ€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î”Î¹Î±Ï„Î¿Î¼Î®Ï‚</b></div>
      </div>
      <div class="ref-list" style="margin-top:auto;">
        <b>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</b>â€¢ Î‘Î½ b=0 Î® h=0: Î†Î³Î½Ï‰ÏƒÏ„Î¿ Qcap.<br>â€¢ Î”Î¹Î±Ï„Î¿Î¼Î®: Î¤ÏÎ±Ï€ÎµÎ¶Î¿ÎµÎ¹Î´Î®Ï‚ (z=0: ÎŸÏÎ¸Î¿Î³).<br>â€¢ Î‘Î½ Î¥ÏˆÎ¿Î¼. Î”Î¹Î±Ï†.=0: Î§ÏÎ®ÏƒÎ· ÎºÎ»Î¯ÏƒÎ·Ï‚ Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î±Ï‚.
      </div>
    </div>
  </div>

<div id="summary" class="summary-box">
    <div class="stat-item" style="color:#d35400;">ÎœÎ­ÏƒÎ· ÎºÎ»Î¯ÏƒÎ·<span id="res-slope">7.5 %</span></div>
    <div class="stat-item">Tc (Kirpich)<span id="res-tc">18.8 min</span></div>
    <div class="stat-item" style="color:#16a085;">Qpeak (Rational)<span id="res-qsel">9.50 mÂ³/s</span></div>
    <div class="stat-item">kQ (mÂ³/s)/(mm/h)<span id="res-kq">0.130</span></div>
    <div class="stat-item" style="color:#2980b9;">Qcap ÏƒÏ…Î»Î»Î¿Î³Î®Ï‚<span id="res-drains">0.00 mÂ³/s</span></div>
    <div class="stat-item" style="color:#8e44ad;">Qcap Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·Ï‚<span id="res-stream">49.17 mÂ³/s</span></div>
    <div class="stat-item">kV (mÂ³/mm)<span id="res-kv">468</span></div>
    <div class="stat-item">Î•Ï€Î¬ÏÎºÎµÎ¹Î±<span id="res-adequacy"><span class="status-fail">ÎœÏŒÎ½Î¿ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·</span></span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th width="8%">i (mm/h)</th><th width="8%">D (min)</th><th width="10%">P (mm)</th><th width="12%">Qpeak (mÂ³/s)</th>
        <th width="14%">V Î±Ï€Î¿ÏÏÎ¿Î®Ï‚ (mÂ³)</th><th width="14%">Î”ÎµÎ¯ÎºÏ„Î·Ï‚ P<sub>eq</sub></th><th width="17%">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î»Î»Î¿Î³Î®Ï‚</th><th width="17%">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·Ï‚</th>
      </tr>
    </thead>
    <tbody id="tableBody"><tr class="risk-safe"><td><b>5</b></td><td>40.0</td><td>3.3</td><td>0.65</td>
         <td>1.560</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=1.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>10</b></td><td>40.0</td><td>6.7</td><td>1.30</td>
         <td>3.120</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=2.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>15</b></td><td>40.0</td><td>10.0</td><td>1.95</td>
         <td>4.680</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=4.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>20</b></td><td>40.0</td><td>13.3</td><td>2.60</td>
         <td>6.240</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=5.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>25</b></td><td>40.0</td><td>16.7</td><td>3.25</td>
         <td>7.800</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=6.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>30</b></td><td>40.0</td><td>20.0</td><td>3.90</td>
         <td>9.360</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=8.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-safe"><td><b>35</b></td><td>40.0</td><td>23.3</td><td>4.55</td>
         <td>10.920</td><td>Î§Î±Î¼Î·Î»Î®<br><span style="font-size:10px;">Peq=9.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>40</b></td><td>40.0</td><td>26.7</td><td>5.20</td>
         <td>12.480</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=10.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>45</b></td><td>40.0</td><td>30.0</td><td>5.85</td>
         <td>14.040</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=12.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>50</b></td><td>40.0</td><td>33.3</td><td>6.51</td>
         <td>15.600</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=13.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>55</b></td><td>40.0</td><td>36.7</td><td>7.16</td>
         <td>17.160</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=14.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>60</b></td><td>40.0</td><td>40.0</td><td>7.81</td>
         <td>18.720</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=16.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>65</b></td><td>40.0</td><td>43.3</td><td>8.46</td>
         <td>20.280</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=17.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>70</b></td><td>40.0</td><td>46.7</td><td>9.11</td>
         <td>21.840</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=18.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>75</b></td><td>40.0</td><td>50.0</td><td>9.76</td>
         <td>23.400</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=20.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>80</b></td><td>40.0</td><td>53.3</td><td>10.41</td>
         <td>24.960</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=21.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>85</b></td><td>40.0</td><td>56.7</td><td>11.06</td>
         <td>26.520</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=22.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-warn"><td><b>90</b></td><td>40.0</td><td>60.0</td><td>11.71</td>
         <td>28.080</td><td>ÎœÎ­Ï„ÏÎ¹Î±<br><span style="font-size:10px;">Peq=24.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>95</b></td><td>40.0</td><td>63.3</td><td>12.36</td>
         <td>29.640</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=25.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>100</b></td><td>40.0</td><td>66.7</td><td>13.01</td>
         <td>31.200</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=26.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>105</b></td><td>40.0</td><td>70.0</td><td>13.66</td>
         <td>32.760</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=28.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>110</b></td><td>40.0</td><td>73.3</td><td>14.31</td>
         <td>34.320</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=29.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>115</b></td><td>40.0</td><td>76.7</td><td>14.96</td>
         <td>35.880</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=30.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>120</b></td><td>40.0</td><td>80.0</td><td>15.61</td>
         <td>37.440</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=32.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>125</b></td><td>40.0</td><td>83.3</td><td>16.26</td>
         <td>39.000</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=33.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>130</b></td><td>40.0</td><td>86.7</td><td>16.91</td>
         <td>40.560</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=34.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>135</b></td><td>40.0</td><td>90.0</td><td>17.56</td>
         <td>42.120</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=36.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>140</b></td><td>40.0</td><td>93.3</td><td>18.21</td>
         <td>43.680</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=37.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-orange"><td><b>145</b></td><td>40.0</td><td>96.7</td><td>18.87</td>
         <td>45.240</td><td>Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=38.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>150</b></td><td>40.0</td><td>100.0</td><td>19.52</td>
         <td>46.800</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=40.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>155</b></td><td>40.0</td><td>103.3</td><td>20.17</td>
         <td>48.360</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=41.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>160</b></td><td>40.0</td><td>106.7</td><td>20.82</td>
         <td>49.920</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=42.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>165</b></td><td>40.0</td><td>110.0</td><td>21.47</td>
         <td>51.480</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=44.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>170</b></td><td>40.0</td><td>113.3</td><td>22.12</td>
         <td>53.040</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=45.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>175</b></td><td>40.0</td><td>116.7</td><td>22.77</td>
         <td>54.600</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=46.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>180</b></td><td>40.0</td><td>120.0</td><td>23.42</td>
         <td>56.160</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=48.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>185</b></td><td>40.0</td><td>123.3</td><td>24.07</td>
         <td>57.720</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=49.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>190</b></td><td>40.0</td><td>126.7</td><td>24.72</td>
         <td>59.280</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=50.7</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>195</b></td><td>40.0</td><td>130.0</td><td>25.37</td>
         <td>60.840</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=52.0</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr><tr class="risk-red"><td><b>200</b></td><td>40.0</td><td>133.3</td><td>26.02</td>
         <td>62.400</td><td>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®<br><span style="font-size:10px;">Peq=53.3</span></td>
         <td><span class="status-fail" style="font-size:9px;">â€”</span></td><td><span class="status-ok">OK</span></td></tr></tbody>
  </table>

  <div class="footer footer-grid">
    <div class="footer-left">
      <b>ÎœÎµÎ¸Î¿Î´Î¿Î»Î¿Î³Î¯Î± Ï„Î±Ï‡ÎµÎ¯Î±Ï‚ Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·Ï‚ (screening):</b><br>
      1) <b>Tc (Kirpich):</b> Tc = 0.0195 Â· L<sup>0.77</sup> Â· S<sup>-0.385</sup> (min). <b>Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±:</b> Î§ÏÎ®ÏƒÎ· min Tc = 5 min.<br>
      2) <b>Rational (Q<sub>peak</sub>):</b> Q<sub>peak</sub> = 0.278 Â· C Â· i Â· A (i ÏƒÎµ mm/h, A ÏƒÎµ kmÂ², Q ÏƒÎµ mÂ³/s).<br>
      3) <b>P<sub>eq</sub> (Effective Rainfall Depth):</b> P<sub>eq</sub> = P Â· C (mm) â€” Â«ÎµÎ½ÎµÏÎ³ÏŒ ÏÏˆÎ¿Ï‚ Î²ÏÎ¿Ï‡Î®Ï‚Â», Î´Î·Î». Ï„Î¿ Î¼Î­ÏÎ¿Ï‚ Ï€Î¿Ï… Î³Î¯Î½ÎµÏ„Î±Î¹ Î¬Î¼ÎµÏƒÎ· Î±Ï€Î¿ÏÏÎ¿Î®.<br>
      4) <b>ÎŒÎ³ÎºÎ¿Ï‚ Î±Ï€Î¿ÏÏÎ¿Î®Ï‚:</b> V = A Â· (P/1000) Â· C (mÂ³) (A ÏƒÎµ mÂ², P ÏƒÎµ mm).<br>
    </div>
    <div id="severityLegend">
      <div class="legend-title">Î’Î±Î¸Î¼Î¯Î´Î± ÏƒÎ¿Î²Î±ÏÏŒÏ„Î·Ï„Î±Ï‚ (P<sub>eq</sub>)</div>
      <table>
        <tbody>
          <tr><td class="key" style="background:#d4edda; color:#155724;">&lt; 10 mm</td><td><b>Î§Î±Î¼Î·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#fff3cd; color:#856404;">10 â€“ 25 mm</td><td><b>ÎœÎ­Ï„ÏÎ¹Î±</b></td></tr>
          <tr><td class="key" style="background:#ffe5d0; color:#d35400;">25 â€“ 40 mm</td><td><b>Î¥ÏˆÎ·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#f5c6cb; color:#721c24;">40 â€“ 60 mm</td><td><b>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#922b21; color:#fff;">&gt; 60 mm</td><td><b>Î‘ÎºÏÎ±Î¯Î±</b></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="mapModal" class="no-print">
  <div id="mapModalHeader">
    <span id="mapTitle" style="margin-right:10px;">Î§Î¬ÏÏ„Î·Ï‚</span>
    <div style="display:flex; gap:5px; align-items:center;">
      <select id="paperSize" onchange="updatePrintFrame()" style="font-size:11px; padding:2px;"><option value="a4">A4</option><option value="a3">A3</option></select>
      <select id="paperLayout" onchange="updatePrintFrame()" style="font-size:11px; padding:2px;"><option value="landscape">ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± (Land)</option><option value="portrait">ÎšÎ¬Î¸ÎµÏ„Î± (Port)</option></select>
    </div>
    <div id="mapHeaderActions">
      <button id="mapPrintBtn" type="button" onclick="printMap()">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
      <button id="mapCloseBtn" type="button" onclick="closeMapModal()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
  <div id="mapBox"><div id="printFrame"></div></div>
</div>

<script>
  // --- HELPERS ---
  const isFiniteNumber = (x) => typeof x === "number" && isFinite(x);
  const _pf = (v) => { const n = parseFloat(String(v).replace(",", ".")); return Number.isFinite(n) ? n : undefined; };
  const getVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const setInputValue = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  
  // Promisified File Reader
  function readJsonFile(file, callback) {
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      try { callback(JSON.parse(r.result)); } 
      catch (e) { alert("Invalid JSON"); }
    };
    r.readAsText(file);
  }

  // LocalStorage Helper (with in-memory fallback for Web sandboxed contexts)
  const __PEQ_MEMSTORE = window.__PEQ_MEMSTORE || (window.__PEQ_MEMSTORE = {});
  const LSHelper = {
    get: (key, def = []) => {
      try {
        const t = localStorage.getItem(key);
        if (t === null || t === undefined) return (key in __PEQ_MEMSTORE ? __PEQ_MEMSTORE[key] : def);
        return JSON.parse(t);
      } catch (e) {
        return (key in __PEQ_MEMSTORE ? __PEQ_MEMSTORE[key] : def);
      }
    },
    set: (key, val) => {
      // Always keep an in-memory copy so exports work even if localStorage is blocked
      __PEQ_MEMSTORE[key] = val;
      try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) {}
    },
    del: (key) => {
      try { delete __PEQ_MEMSTORE[key]; } catch (e) {}
      try { localStorage.removeItem(key); } catch (e) {}
    }
  };

  // Warn once if localStorage is unavailable (common in some Web/iframe contexts)
  (function(){
    try{
      const k="__peq_ls_test__";
      localStorage.setItem(k,"1");
      localStorage.removeItem(k);
    }catch(e){
      console.warn("âš ï¸ localStorage is not available in this context. Changes will persist only for this session, but Export will still include them.");
    }
  })();

  // --- EMBEDDED DATA PLACEHOLDERS ---
  /*__EMBEDDED_GEOJSON_START__*/
const EMBEDDED_GEOJSON_BY_BASIN = {"U5118":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[23.87465342060495,38.04934812546696,0],[23.87187330384627,38.05009184256284,0],[23.87073092195488,38.05017754228732,0],[23.8692046555466,38.0493454506673,0],[23.86791684043581,38.04821106502155,0],[23.86526593468037,38.04721316359,0],[23.86461373660416,38.04589653585673,0],[23.86312448811635,38.04509799812622,0],[23.85932772404777,38.04311280027395,0],[23.85887839812492,38.04195262115586,0],[23.8573671667487,38.04230971730302,0],[23.85685053951153,38.03798060139901,0],[23.85722452250506,38.03475370569436,0],[23.86034458072453,38.03677447498595,0],[23.86151029657844,38.03859822107724,0],[23.86883546999552,38.04038542650644,0],[23.87043159126159,38.04283508643211,0],[23.87303636019929,38.04481508782511,0],[23.87422872604208,38.04822416290789,0],[23.87465342060495,38.04934812546696,0]]]},"properties":{"name":"Î›Î•ÎšÎ‘ÎÎ— Î¡Î•ÎœÎ‘Î¤ÎŸÎ£ Î Î¡ÎŸÎ£ ÎšÎ›Î¡Î™Î£Î˜Î•ÎÎŸÎ¥Î£","open":1,"description":"area=1170000;\nlength=2050;\nheight=153;\ncoef=0.40;\n","styleUrl":"#msn_ylw-pushpin1","fill-opacity":0.6,"fill":"#ffff00","stroke-opacity":0,"stroke":"#ffffff","icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"},"id":0},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[23.85213009196283,38.03845374593019,0],[23.85969800625714,38.03925802824327,0]]},"properties":{"name":"Î¡Î•ÎœÎ‘ Î Î¡ÎŸÎ£ Î Î•ÎÎ¤Î•Î›Î— Î“Î•Î¡Î‘ÎšÎ‘ ÎšÎ›Î•Î™Î£Î˜Î•ÎÎŸÎ¥Î£ 1","open":1,"styleUrl":"#msn_ylw-pushpin7","stroke-opacity":1,"stroke":"#00aa00","stroke-width":10,"icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[23.85725613316993,38.03468353108903,0],[23.85736474683805,38.0354718288196,0],[23.85741096964167,38.03549646541966,0],[23.85800563227687,38.0364912627497,0],[23.85889840329227,38.03803718638793,0],[23.85975510733503,38.03936470129903,0],[23.86027746798356,38.03979315041443,0],[23.86115328475847,38.04029535096195,0],[23.86161708693543,38.04074622251252,0],[23.86268148118537,38.04096032902012,0],[23.86285866223496,38.04102082919073,0],[23.86306977896238,38.04110580355066,0],[23.86356454723066,38.04130755043838,0],[23.8639425275003,38.04132851014199,0],[23.8642613281295,38.04144552823067,0],[23.864438865874,38.04168962618552,0],[23.86511250728198,38.0417175227991,0],[23.86561462880668,38.04196758427809,0],[23.86620875646669,38.04188502345048,0],[23.8668788432602,38.04240741974889,0],[23.86741430337729,38.04260779003332,0],[23.86779578264378,38.04282680375135,0],[23.86928288223337,38.0438465363412,0],[23.87118854695164,38.04759061065926,0],[23.87221667012172,38.04829175819438,0],[23.87411960545291,38.04942959904688,0]]},"properties":{"name":"Î¡Î•ÎœÎ‘ Î Î¡ÎŸÎ£ Î Î•ÎÎ¤Î•Î›Î— Î“Î•Î¡Î‘ÎšÎ‘ ÎšÎ›Î•Î™Î£Î˜Î•ÎÎŸÎ¥Î£","open":1,"styleUrl":"#msn_ylw-pushpin24","stroke-opacity":1,"stroke":"#00aa00","stroke-width":10,"icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"}}]},"U2907":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[23.87465342060495,38.04934812546696,0],[23.87187330384627,38.05009184256284,0],[23.87073092195488,38.05017754228732,0],[23.8692046555466,38.0493454506673,0],[23.86791684043581,38.04821106502155,0],[23.86526593468037,38.04721316359,0],[23.86461373660416,38.04589653585673,0],[23.86312448811635,38.04509799812622,0],[23.85932772404777,38.04311280027395,0],[23.85887839812492,38.04195262115586,0],[23.8573671667487,38.04230971730302,0],[23.85685053951153,38.03798060139901,0],[23.85722452250506,38.03475370569436,0],[23.86034458072453,38.03677447498595,0],[23.86151029657844,38.03859822107724,0],[23.86883546999552,38.04038542650644,0],[23.87043159126159,38.04283508643211,0],[23.87303636019929,38.04481508782511,0],[23.87422872604208,38.04822416290789,0],[23.87465342060495,38.04934812546696,0]]]},"properties":{"name":"Î›Î•ÎšÎ‘ÎÎ— Î¡Î•ÎœÎ‘Î¤ÎŸÎ£ Î Î¡ÎŸÎ£ ÎšÎ›Î¡Î™Î£Î˜Î•ÎÎŸÎ¥Î£","open":1,"description":"area=1170000;\nlength=2050;\nheight=153;\ncoef=0.40;\n","styleUrl":"#msn_ylw-pushpin1","fill-opacity":0.6,"fill":"#ffff00","stroke-opacity":0,"stroke":"#ffffff","icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"},"id":0},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[23.85213009196283,38.03845374593019,0],[23.85969800625714,38.03925802824327,0]]},"properties":{"name":"Î¡Î•ÎœÎ‘ Î Î¡ÎŸÎ£ Î Î•ÎÎ¤Î•Î›Î— Î“Î•Î¡Î‘ÎšÎ‘ ÎšÎ›Î•Î™Î£Î˜Î•ÎÎŸÎ¥Î£ 1","open":1,"styleUrl":"#msn_ylw-pushpin7","stroke-opacity":1,"stroke":"#00aa00","stroke-width":10,"icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[23.85725613316993,38.03468353108903,0],[23.85736474683805,38.0354718288196,0],[23.85741096964167,38.03549646541966,0],[23.85800563227687,38.0364912627497,0],[23.85889840329227,38.03803718638793,0],[23.85975510733503,38.03936470129903,0],[23.86027746798356,38.03979315041443,0],[23.86115328475847,38.04029535096195,0],[23.86161708693543,38.04074622251252,0],[23.86268148118537,38.04096032902012,0],[23.86285866223496,38.04102082919073,0],[23.86306977896238,38.04110580355066,0],[23.86356454723066,38.04130755043838,0],[23.8639425275003,38.04132851014199,0],[23.8642613281295,38.04144552823067,0],[23.864438865874,38.04168962618552,0],[23.86511250728198,38.0417175227991,0],[23.86561462880668,38.04196758427809,0],[23.86620875646669,38.04188502345048,0],[23.8668788432602,38.04240741974889,0],[23.86741430337729,38.04260779003332,0],[23.86779578264378,38.04282680375135,0],[23.86928288223337,38.0438465363412,0],[23.87118854695164,38.04759061065926,0],[23.87221667012172,38.04829175819438,0],[23.87411960545291,38.04942959904688,0]]},"properties":{"name":"Î¡Î•ÎœÎ‘ Î Î¡ÎŸÎ£ Î Î•ÎÎ¤Î•Î›Î— Î“Î•Î¡Î‘ÎšÎ‘ ÎšÎ›Î•Î™Î£Î˜Î•ÎÎŸÎ¥Î£","open":1,"styleUrl":"#msn_ylw-pushpin24","stroke-opacity":1,"stroke":"#00aa00","stroke-width":10,"icon-scale":1.1,"icon-offset":[20,2],"icon-offset-units":["pixels","pixels"],"icon":"http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png"}}]}};
/*__EMBEDDED_GEOJSON_END__*/
  /*__EMBEDDED_MUNICIPAL_START__*/
const EMBEDDED_MUNICIPAL_GEOJSON = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[23.78003862096978,38.00994668585535,0],[23.78041578222688,38.00982447233078,0],[23.78294961363283,38.00982128682027,0],[23.78619017056575,38.00858990850592,0],[23.79225512416031,38.00324330220917,0],[23.79569653172669,38.00570417111404,0],[23.7987847585621,38.00687467064319,0],[23.80079712247625,38.00725256543455,0],[23.80441567588299,38.00844942967458,0],[23.80983386589945,38.01103771837862,0],[23.81153579445544,38.01151113515974,0],[23.81179078569558,38.01218254275266,0],[23.81455029362099,38.01455371174351,0],[23.81543739816397,38.01579186025759,0],[23.81903491251694,38.01958682028392,0],[23.81977614778337,38.01999381854444,0],[23.82285357362175,38.02127048162174,0],[23.82429313201658,38.02175467410904,0],[23.82493138055392,38.02188344646585,0],[23.82615118090241,38.02188103571668,0],[23.82721617453993,38.02208586142691,0],[23.82788378804265,38.02239921677047,0],[23.82992873196904,38.02300394211722,0],[23.83134557971949,38.02308075499543,0],[23.83323643169482,38.0235129667713,0],[23.83402521629183,38.0230919659063,0],[23.83548074072172,38.0217737608768,0],[23.83574072969921,38.0219614132985,0],[23.83801283760787,38.01956226507092,0],[23.83892496543476,38.02096438103701,0],[23.83857508158834,38.02142338209332,0],[23.83984178476695,38.02179847882621,0],[23.83928689959344,38.02198720057599,0],[23.84009024083351,38.02319836506381,0],[23.84155356320321,38.02307513160651,0],[23.85750744910535,38.0401343490834,0],[23.85705100981687,38.04038963602715,0],[23.85725506260805,38.04051179219732,0],[23.85619750248598,38.04101379195141,0],[23.85629381201221,38.04132409706096,0],[23.85607872120073,38.04180345279721,0],[23.85622181008247,38.04206512236549,0],[23.85514231913752,38.04242646035193,0],[23.85514191028479,38.04253454729179,0],[23.85461217815109,38.04249015519576,0],[23.85450141684554,38.04237870866344,0],[23.85407323120344,38.04243597503543,0],[23.85400935586318,38.04236819660768,0],[23.85386221071743,38.0424085254762,0],[23.85377321567774,38.04218891331323,0],[23.85282191581395,38.04259700272709,0],[23.85386492247643,38.04403922589184,0],[23.85434085566711,38.04597417611858,0],[23.85340354960988,38.0462384744138,0],[23.85330818566846,38.04610504480154,0],[23.85223636126039,38.0463249841051,0],[23.85174114915055,38.04587546225684,0],[23.85124854606971,38.0452317333013,0],[23.85104761743016,38.04503175552546,0],[23.84970986677495,38.04410055428198,0],[23.8494761406476,38.04383062897453,0],[23.84825443114713,38.04164246420179,0],[23.84727675506048,38.0404419354,0],[23.84727461210463,38.03989456161164,0],[23.84711010543568,38.03950831398657,0],[23.84714730428461,38.03918555709183,0],[23.84696685548306,38.03883809589433,0],[23.84688142137923,38.038320890371,0],[23.84671168269296,38.03808217408284,0],[23.84629641002367,38.03770220204882,0],[23.84550405932138,38.0372776557445,0],[23.84499130482682,38.0371802159517,0],[23.84495081702982,38.03706585498458,0],[23.84507912500197,38.03681981008358,0],[23.84461856422367,38.035932335613,0],[23.84468154198832,38.0357877174171,0],[23.8446777622672,38.03566414026729,0],[23.84458162362415,38.03548930444828,0],[23.84442375126345,38.03539621628023,0],[23.84432711369037,38.03528665287155,0],[23.84395796295423,38.03507592298684,0],[23.84370025459781,38.03510195234919,0],[23.84205492119849,38.03377622294497,0],[23.84084758801328,38.03468404094527,0],[23.84077218913315,38.03462287484361,0],[23.84019130644635,38.0340551150633,0],[23.83901949399378,38.0323615320706,0],[23.8379060076396,38.03055685983941,0],[23.8360505047562,38.02799715279735,0],[23.83463296501167,38.02648479886405,0],[23.83422132427271,38.02615644167899,0],[23.83403617537756,38.02591837310648,0],[23.83396690698941,38.02566760242661,0],[23.83391126207419,38.02512966238962,0],[23.83363403219774,38.0247653395083,0],[23.83298516980113,38.02445152423208,0],[23.82767558216165,38.02842913783574,0],[23.82796961679208,38.02858453678863,0],[23.82467652284027,38.03157708705629,0],[23.82608622230401,38.03279484172576,0],[23.82363020773863,38.03465895983441,0],[23.82199780076941,38.03347985656364,0],[23.821399414422,38.0343604618836,0],[23.82121240072337,38.03426569506342,0],[23.82126496274075,38.03337543367883,0],[23.82102679898877,38.03321526857587,0],[23.82065913464666,38.03326706007206,0],[23.82017238854467,38.03364660204914,0],[23.81982907482972,38.03348005364941,0],[23.81969971561194,38.03319830230718,0],[23.81953491731779,38.03303504899183,0],[23.81914419447177,38.03321794543368,0],[23.81856798519028,38.032612589487,0],[23.81833672980358,38.03248051709523,0],[23.81782277961641,38.0323320604932,0],[23.81693027497632,38.03198725036744,0],[23.8164850131412,38.0320984144591,0],[23.81574827703432,38.03181919670952,0],[23.81456844219817,38.03179082424859,0],[23.8142571666555,38.0316650658115,0],[23.81398117947877,38.03127766807164,0],[23.81396040957504,38.03105548326467,0],[23.81354756745585,38.03123819503154,0],[23.8134574269874,38.03080291931515,0],[23.81045576663976,38.03198721445264,0],[23.81002200627157,38.03129624207443,0],[23.80896058610957,38.03175592227042,0],[23.80867593447555,38.03130719790069,0],[23.80747637262094,38.03179085955121,0],[23.80689728908012,38.03102568978729,0],[23.80370371780719,38.0324472532411,0],[23.80236268569423,38.03054631264043,0],[23.80216466720531,38.03149974300274,0],[23.79974899291425,38.03249624801138,0],[23.79915971045476,38.03169268923807,0],[23.79900415689465,38.03176032346438,0],[23.79905267188745,38.03188561482292,0],[23.79822551001755,38.03221313184028,0],[23.79784772756829,38.03176660081368,0],[23.79722743239444,38.03197956504579,0],[23.79752397852659,38.03248984425162,0],[23.79521623674128,38.03346666537696,0],[23.78949657577567,38.02667103760238,0],[23.7892323147377,38.02133073543028,0],[23.78826375078284,38.01924970071023,0],[23.78016837214614,38.01017123973663,0],[23.78003862096978,38.00994668585535,0]]]},"properties":{"name":"Î”Î—ÎœÎŸÎ£ Î§Î‘Î›Î‘ÎÎ”Î¡Î™ÎŸÎ¥","styleUrl":"#__managed_style_00A9028084351F5E84C7","fill-opacity":0,"fill":"#000000","stroke-opacity":1,"stroke":"#000000","stroke-width":5},"id":"08A95369C1351F58C9EB"}]};
/*__EMBEDDED_MUNICIPAL_END__*/
  /*__EMBEDDED_CUSTOM_BASINS_START__*/
const EMBEDDED_CUSTOM_BASINS = [{"id":"U5118","name":"map (2)","values":{"area":1170000,"length":2050,"height":153,"coef":0.4}},{"id":"U2907","name":"map (1)","values":{"area":1170000,"length":2050,"height":153,"coef":0.4}}];
/*__EMBEDDED_CUSTOM_BASINS_END__*/
  /*__EMBEDDED_HIDDEN_BASINS_START__*/
const EMBEDDED_HIDDEN_BASINS = [];
/*__EMBEDDED_HIDDEN_BASINS_END__*/
  /*__EMBEDDED_CUSTOM_METEO_START__*/
const EMBEDDED_CUSTOM_METEO_STATIONS = [{"id":"S1766645340857","name":"ÎÎŸÎœÎ™Î£ÎœÎ‘Î¤ÎŸÎšÎŸÎ Î•Î™ÎŸ","url":"https://penteli.meteo.gr/stations/nomismatokopeio/"},{"id":"S1766645582266","name":"Î•Î›Î›Î—ÎÎŸÎ“Î‘Î›Î›Î™ÎšÎŸ Î‘Î“Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—","url":"https://penteli.meteo.gr/stations/delacroix-attiki/"},{"id":"S1766645619060","name":"Î‘Î“Î™Î‘ Î Î‘Î¡Î‘Î£ÎšÎ•Î¥Î—","url":"https://penteli.meteo.gr/stations/agiaparaskevi/"},{"id":"S1766645721457","name":"Î Î‘Î›Î‘Î™ÎŸÎ¥ Î¨Î¥Î§Î™ÎšÎŸÎ¥ / ÎšÎŸÎ›Î›Î•Î“Î™ÎŸ","url":"https://penteli.meteo.gr/stations/psychico/"},{"id":"S1766645789407","name":"Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î / ÎšÎ‘ÎÎ¤Î‘","url":"https://penteli.meteo.gr/stations/vrilissia/"},{"id":"S1766645834676","name":"Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î 1Î¿ Î“Î¥ÎœÎÎ‘Î£Î™ÎŸ","url":"https://penteli.meteo.gr/stations/vrilissia2/"},{"id":"S1766645935205","name":"Î Î‘Î Î‘Î“ÎŸÎ¥/Î‘Î¤Î¤Î™ÎšÎ— ÎŸÎ”ÎŸÎ£","url":"https://penteli.meteo.gr/stations/papagou/"},{"id":"S1766645962108","name":"Î“Î•Î¡Î‘ÎšÎ‘Î£ / 2Î¿ Î“Î¥ÎœÎÎ‘Î£Î™ÎŸ","url":"https://penteli.meteo.gr/stations/gerakas/"},{"id":"S1766647246784","name":"ÎœÎ‘Î¡ÎŸÎ¥Î£Î™/ Î£Î§ÎŸÎ›Î— ursulines","url":"https://penteli.meteo.gr/stations/ursulines/"}];
/*__EMBEDDED_CUSTOM_METEO_END__*/
  /*__EMBEDDED_METEO_SELECTED_START__*/
const EMBEDDED_METEO_SELECTED_IDS = ["S1766645582266","S1766645619060","S1766645721457"];
/*__EMBEDDED_METEO_SELECTED_END__*/
  /*__EMBEDDED_METEO_AGG_START__*/
const EMBEDDED_METEO_AGG = "max";
/*__EMBEDDED_METEO_AGG_END__*/

  // --- BASIN MANAGEMENT ---
  const DEFAULT_BASINS = [];
  // --- REPO AUTO-LOAD (GitHub Pages) ---
  // Î£Ï„ÏŒÏ‡Î¿Ï‚: Î½Î± Â«Î´Î¿Ï…Î»ÎµÏÎµÎ¹Â» ÏƒÏ‰ÏƒÏ„Î¬ ÏƒÏ„Î¿ https://petrsanidas-ui.github.io/nireas/
  // Î¦Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î±: (Î±) ÎŒÏÎ¹Î± Î”Î®Î¼Î¿Ï…, (Î²) Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î±Ï€ÏŒ /data/basins/
  const REPO_DATA_CFG = {
    enabled: true,
    municipalUrl: "data/boundaries/geojson/municipal_chalandriou.geojson",
    // Î ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½Î¿ manifest (ÏÏƒÏ„Îµ Î½Î± Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹Ï‚ Ï€Î¿Î»Î»Î­Ï‚ Î»ÎµÎºÎ¬Î½ÎµÏ‚ Ï‡Ï‰ÏÎ¯Ï‚ GitHub API):
    // data/basins/basins.json  Î®  data/basins/index.json
    basinsManifestUrls: ["data/basins/basins.json", "data/basins/index.json"],
    basinsDir: "data/basins/",
    // Î‘Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½ÎµÎ²Î¬ÏƒÎµÎ¹ Î´Î¹ÎºÎ¬ Ï„Î¿Ï… ÏŒÏÎ¹Î± (cache), Ï€ÏÎ¿Ï„Î¹Î¼Î¬Î¼Îµ Î½Î± Ï€Î¬ÏÎ¿Ï…Î¼Îµ Ï„Î± repo ÏŒÏÎ¹Î±.
    preferRepoMunicipalIfNoUserOverride: true,
  };

  function _safeRelUrl(u){ return String(u||"").replace(/^\//,''); }

  function _deriveIdFromFile(file){
    const base = String(file||"").split('/').pop().replace(/\.[^/.]+$/,'');
    // Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Î»Î±Ï„Î¹Î½Î¹ÎºÎ¬/ÎµÎ»Î»Î·Î½Î¹ÎºÎ¬ Î³ÏÎ¬Î¼Î¼Î±Ï„Î±, ÏˆÎ·Ï†Î¯Î±, _ ÎºÎ±Î¹ -
    return base.replace(/\s+/g,'_').replace(/[^\w\u0370-\u03FF\u1F00-\u1FFF_-]/g,'') || ("B"+Date.now());
  }

  async function _fetchJson(url){
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return await r.json();
  }

  async function _tryFetchJson(urls){
    for(const u of (urls||[])){
      const url = _safeRelUrl(u);
      try { return await _fetchJson(url); } catch(e) {}
    }
    return null;
  }

  async function _listBasinsViaGithubApi(){
    try {
      // Fallback Î±Î½ Î”Î•Î Î­Ï‡ÎµÎ¹Ï‚ manifest. Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î­Ï‡ÎµÎ¹ rate-limit.
      if(!/github\.io$/i.test(location.hostname)) return null;
      const owner = location.hostname.split('.')[0];
      const parts = location.pathname.split('/').filter(Boolean);
      const repo = parts[0];
      if(!owner || !repo) return null;

      const api = `https://api.github.com/repos/${owner}/${repo}/contents/data/basins`;
      const r = await fetch(api, { headers: { "Accept": "application/vnd.github+json" }, cache: "no-store" });
      if(!r.ok) return null;

      const js = await r.json();
      if(!Array.isArray(js)) return null;

      return js
        .filter(x => x && x.type === "file" && /\.geojson$/i.test(x.name))
        .map(x => x.name);
    } catch(e){ return null; }
  }

  function _normalizeBasinsManifest(man){
    if(!man) return [];
    if(Array.isArray(man)) return man;
    if(Array.isArray(man.basins)) return man.basins;
    if(Array.isArray(man.files)) return man.files;
    return [];
  }

  function _normalizeBasinEntry(ent){
    if(!ent) return null;
    if(typeof ent === "string") return { file: ent };
    if(typeof ent !== "object") return null;
    return ent;
  }

  async function bootstrapGeoFromRepo(){
    try {
      if(!REPO_DATA_CFG.enabled) return;
      if(!(location.protocol === "http:" || location.protocol === "https:")) return;

      // (1) ÎŒÏÎ¹Î± Î”Î®Î¼Î¿Ï…: Î¼ÏŒÎ½Î¿ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· cache (Î´Î·Î». Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î­Î²ÎµÎ¹/ÏƒÏ‰Î¸ÎµÎ¯ Î±Ï€ÏŒ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·)
      if(REPO_DATA_CFG.preferRepoMunicipalIfNoUserOverride && !MUNICIPAL_CACHE){
        try {
          const muni = await _fetchJson(_safeRelUrl(REPO_DATA_CFG.municipalUrl));
          if(muni) saveGeoJson("municipal", null, muni);
        } catch(e) {}
      }

      // (2) Manifest Î»ÎµÎºÎ±Î½ÏÎ½
      let manifest = await _tryFetchJson(REPO_DATA_CFG.basinsManifestUrls);
      let entries = _normalizeBasinsManifest(manifest);

      // Fallback: GitHub API listing (Î±Î½ Î»ÎµÎ¯Ï€ÎµÎ¹ manifest)
      if(!entries.length){
        const files = await _listBasinsViaGithubApi();
        if(Array.isArray(files) && files.length) entries = files;
      }
      if(!entries.length) return;

      const exists = new Set(DEFAULT_BASINS.map(b => String(b.id)));
      let changed = false;

      for(const raw of entries){
        const ent = _normalizeBasinEntry(raw);
        if(!ent) continue;

        const file = ent.file || ent.filename || ent.path || ent.name;
        if(!file) continue;

        const id = String(ent.id || _deriveIdFromFile(file)).trim();
        if(!id || exists.has(id)) continue;
        exists.add(id);

        const name = String(ent.name || id);
        const v = ent.values || ent;

        DEFAULT_BASINS.push({
          id, name,
          values: {
            area: _pf(v.area) || 0,
            length: _pf(v.length) || 0,
            height: _pf(v.height) || 0,
            coef: _pf(v.coef) || 0.6
          }
        });
        changed = true;

        // Î¦Î¿ÏÏ„ÏÎ½Î¿Ï…Î¼Îµ GeoJSON Î¼ÏŒÎ½Î¿ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î· cached Î±Ï€ÏŒ IDB
        if(!GEOJSON_CACHE[id]){
          const url = _safeRelUrl(ent.url || (REPO_DATA_CFG.basinsDir + file));
          try {
            const gj = await _fetchJson(url);
            if(gj) saveGeoJson("basin", id, gj);
          } catch(e) {}
        }
      }

      if(changed){
        rebuildBasins();
        renderBasinTable();
      }
    } catch(e) { /* ignore */ }
  }

  const KEYS = { CUSTOM: "peq_custom_basins_v1", HIDDEN: "peq_hidden_basins_v1", GLOBAL: "peq_global_v1", BASIN_PFX: "peq_basin_v1_", AUTO: "peq_autosave_mode_v1", METEO: "peq_meteo_station_v1", METEO_CUSTOM: "peq_custom_meteo_stations_v1", METEO_UI: "peq_meteo_ui_v1",  METEO_MULTI: "peq_meteo_station_multi_v1", METEO_AGG: "peq_meteo_agg_v1" };
  let BASINS = [], CURRENT_BASIN_ID = null;

  function bootstrapHiddenBasins() {
    if (!localStorage.getItem(KEYS.HIDDEN) && EMBEDDED_HIDDEN_BASINS.length) LSHelper.set(KEYS.HIDDEN, EMBEDDED_HIDDEN_BASINS);
  }

  function rebuildBasins() {
    const hidden = new Set(LSHelper.get(KEYS.HIDDEN));
    const seen = new Set();
    const out = [];
    const process = (list) => (list || []).forEach(b => {
      if (!b || !b.id) return;
      const id = String(b.id).trim();
      if (hidden.has(id) || !id || seen.has(id)) return;
      seen.add(id);
      const v = b.values || {};
      out.push({
        id, name: String(b.name || id),
        values: {
          area: _pf(v.area ?? b.area) || 0, length: _pf(v.length ?? b.length) || 0,
          height: _pf(v.height ?? b.height) || 0, coef: _pf(v.coef ?? b.coef) || 0.6
        }
      });
    });
    process(DEFAULT_BASINS);
    process(EMBEDDED_CUSTOM_BASINS);
    process(LSHelper.get(KEYS.CUSTOM));
    BASINS = out;
  }

  bootstrapHiddenBasins();
  rebuildBasins();

  function basinLabel(b){ return (b.id ? `${b.id} â€” ${b.name}` : (b.name || "â€”")); }
  
  // --- GEOJSON STORAGE (IndexedDB) ---
  const GEOJSON_CACHE = Object.create(null);
  let MUNICIPAL_CACHE = null;
  const IDB_CFG = { NAME: "peq_geojson_db_v1", VER: 1, STORE: "kv" };
  let _idb = null, _idbReady = false, _idbQueue = [];

  function _idbOp(mode, fn) {
    if(!_idb || !_idbReady) return Promise.resolve(false);
    return new Promise(r => { const tx=_idb.transaction(IDB_CFG.STORE, mode); fn(tx.objectStore(IDB_CFG.STORE)); tx.oncomplete=()=>r(true); tx.onerror=()=>r(false); });
  }

  async function initGeojsonStorage() {
    if(!window.indexedDB) return;
    try {
      _idb = await new Promise((res, rej) => {
        const req = indexedDB.open(IDB_CFG.NAME, IDB_CFG.VER);
        req.onupgradeneeded = () => { if(!req.result.objectStoreNames.contains(IDB_CFG.STORE)) req.result.createObjectStore(IDB_CFG.STORE, { keyPath: "k" }); };
        req.onsuccess = () => res(req.result);
        req.onerror = rej;
      });
      _idbReady = true;
      const all = await new Promise(r => { const q=_idb.transaction(IDB_CFG.STORE).objectStore(IDB_CFG.STORE).getAll(); q.onsuccess=()=>r(q.result||[]); });
      all.forEach(rec => {
        if(String(rec.k).startsWith("basin:")) GEOJSON_CACHE[String(rec.k).slice(6)] = rec.v;
        else if(rec.k === "municipal") MUNICIPAL_CACHE = rec.v;
      });
      while(_idbQueue.length) _idbQueue.shift()();
    } catch(e) { console.warn("IDB Failed", e); }
  }

  function saveGeoJson(type, id, obj) {
    const key = type==="municipal" ? "municipal" : "basin:"+id;
    if(type==="basin") GEOJSON_CACHE[id] = obj; else MUNICIPAL_CACHE = obj;
    if(_idbReady) _idbOp("readwrite", s => s.put({k:key, v:obj}));
  }
  
  function getGeoJson(type, id) {
    if(type==="municipal") return MUNICIPAL_CACHE || EMBEDDED_MUNICIPAL_GEOJSON;
    return GEOJSON_CACHE[id] || EMBEDDED_GEOJSON_BY_BASIN[id] || null;
  }
  
  function delGeoJson(type, id) {
    const key = type==="municipal" ? "municipal" : "basin:"+id;
    if(type==="basin") delete GEOJSON_CACHE[id]; else MUNICIPAL_CACHE = null;
    if(_idbReady) _idbOp("readwrite", s => s.delete(key));
  }

  // --- EXPORT & AUTOSAVE ---
  function exportHtmlWithEmbeddedGeoJSON() {
  // Î£Ï…Î»Î»Î¿Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Ï€ÏÎ¿Ï‚ ÎµÎ½ÏƒÏ‰Î¼Î¬Ï„Ï‰ÏƒÎ· (ÏÏƒÏ„Îµ Î½Î± Â«Î¼Î­Î½Î¿Ï…Î½Â» Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ exported HTML)
  const gjMap = {};
  BASINS.forEach(b => { const g = getGeoJson('basin', b.id); if (g) gjMap[b.id] = g; });

  // Î¤Î¹ Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± Â«Î³ÏÎ¬ÏˆÎ¿Ï…Î¼ÎµÂ» Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ Î½Î­Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
  const blocks = [
    { m: "__EMBEDDED_GEOJSON",        v: "EMBEDDED_GEOJSON_BY_BASIN",     val: gjMap },
    { m: "__EMBEDDED_MUNICIPAL",     v: "EMBEDDED_MUNICIPAL_GEOJSON",     val: getGeoJson('municipal') },
    { m: "__EMBEDDED_CUSTOM_BASINS", v: "EMBEDDED_CUSTOM_BASINS",        val: BASINS},
    { m: "__EMBEDDED_HIDDEN_BASINS", v: "EMBEDDED_HIDDEN_BASINS",         val: LSHelper.get(KEYS.HIDDEN) },

    // âœ… Meteo: custom stations + multi-selection + aggregation
    { m: "__EMBEDDED_CUSTOM_METEO",  v: "EMBEDDED_CUSTOM_METEO_STATIONS", val: _cleanStations(LSHelper.get(KEYS.METEO_CUSTOM, [])) },
    { m: "__EMBEDDED_METEO_SELECTED",v: "EMBEDDED_METEO_SELECTED_IDS",    val: getSelectedMeteoStationIds() },
    { m: "__EMBEDDED_METEO_AGG",     v: "EMBEDDED_METEO_AGG",             val: getMeteoAgg() }
  ];

  let html = document.documentElement.outerHTML;

  // Î‘Î½ ÎºÎ¬Ï€Î¿Î¹Î¿Ï‚ server/minifier Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÎ¹ Ï„Î± JS comments, Ï„Î± /*__..._START__*/ blocks Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î»ÎµÎ¯Ï€Î¿Ï…Î½.
  // Î“Î¹â€™ Î±Ï…Ï„ÏŒ ÎºÎ¬Î½Î¿Ï…Î¼Îµ 2-Î²Î®Î¼Î±: (A) Î¼Îµ markers, (B) fallback Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î¿ "const VAR = ...;"
  const missed = [];
  blocks.forEach(b => {
    const json = JSON.stringify(b.val);
    let replaced = false;

    // (A) Î ÏÎ¿Ï„Î¹Î¼Î¬Î¼Îµ markers Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ (ÎºÏÎ±Ï„Î¬Î¼Îµ ÎºÎ±Î¹ Ï„Î· Î´Î¿Î¼Î® Î³Î¹Î± Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ¬ exports)
    const reBlock = new RegExp(`\\/\\*${b.m}_START(?:__)?\\*\\/[\\s\\S]*?\\/\\*${b.m}_END(?:__)?\\*\\/`);
    if (reBlock.test(html)) {
      html = html.replace(reBlock, `/*${b.m}_START__*/\nconst ${b.v} = ${json};\n/*${b.m}_END__*/`);
      replaced = true;
    } else {
      // (B) Fallback: Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î²Î¬ÏƒÎµÎ¹ Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®Ï‚
      const safeVar = b.v.replace(/[.*+?^${}()|[\\]\\]/g, "\\$&");
      const reVar = new RegExp(`(?:const|let|var)\\s+${safeVar}\\s*=\\s*[\\s\\S]*?;`);
      if (reVar.test(html)) {
        html = html.replace(reVar, `const ${b.v} = ${json};`);
        replaced = true;
      }
    }

    if (!replaced) missed.push(b.v);
  });

  if (missed.length) {
    console.warn("Export: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ placeholders/vars Î³Î¹Î±:", missed);
    alert("Î ÏÎ¿ÏƒÎ¿Ï‡Î®: Î£Ï„Î¿ export Î´ÎµÎ½ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎ±Î½ ÎºÎ¬Ï€Î¿Î¹Î± blocks:\n- " + missed.join("\n- ") + "\n\n(Î´ÎµÏ‚ Console Î³Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚)");
  }

  const blob = new Blob([html], { type: "text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `peq_export_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.html`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}


  function getAutoSaveMode() { return localStorage.getItem(KEYS.AUTO) || "ask"; }
  function updateAutoSaveBtn() {
    const btn = document.getElementById("autoSaveBtn"), m = getAutoSaveMode();
    if(btn) { btn.dataset.mode = m; btn.textContent = `AutoSave: ${m.toUpperCase()}`; }
  }
  function toggleAutoSaveMode() {
    const m = getAutoSaveMode(), next = (m==="off"?"ask":(m==="ask"?"on":"off"));
    localStorage.setItem(KEYS.AUTO, next); updateAutoSaveBtn();
    alert("AutoSave: " + next.toUpperCase());
  }
  function maybeAutoSave() {
    const m = getAutoSaveMode();
    if(m==="on" || (m==="ask" && confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î¿ HTML (AutoSave);"))) exportHtmlWithEmbeddedGeoJSON();
  }

  // --- MAP ---
  let _map=null, _geoLayer=null, _muniLayer=null, CURRENT_MAP_BASIN_ID=null;
  const PAPER_DIMS = { a4: {w:297,h:210}, a3: {w:420,h:297} };

  function updatePrintFrame() {
    const size = document.getElementById("paperSize").value, layout = document.getElementById("paperLayout").value;
    const frame = document.getElementById("printFrame"), mapBox = document.getElementById("mapBox");
    if(!frame || !mapBox) return;
    let pw = PAPER_DIMS[size].w, ph = PAPER_DIMS[size].h;
    if(layout === "portrait") { [pw, ph] = [ph, pw]; }
    const scale = Math.min((mapBox.clientWidth-40)/pw, (mapBox.clientHeight-40)/ph);
    frame.style.width = (pw*scale)+"px"; frame.style.height = (ph*scale)+"px"; frame.style.display = "block";
    if(_map) _map.invalidateSize();
  }

  function openMapModal(basinId) {
    CURRENT_MAP_BASIN_ID = basinId;
    const isMuni = (basinId === "__MUNICIPAL__");
    const muni = getGeoJson('municipal'), gj = isMuni ? null : getGeoJson('basin', basinId);
    if(!muni && !gj) { alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ GeoJSON."); return; }

    document.getElementById("mapModal").style.display = "block";
    document.getElementById("mapTitle").textContent = isMuni ? "Î§Î¬ÏÏ„Î·Ï‚ â€” ÎŒÏÎ¹Î± Î”Î®Î¼Î¿Ï…" : "Î§Î¬ÏÏ„Î·Ï‚ â€” "+basinId;

    if(!_map) {
      _map = L.map("mapBox", { zoomSnap:0, zoomDelta:0.05 }).setView([37.98, 23.73], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:20 }).addTo(_map);
    }
    if(_geoLayer) _geoLayer.remove(); if(_muniLayer) _muniLayer.remove();

    const style = (f) => { const p=f.properties||{}, c=p.stroke||p.color||"#2c3e50"; return {color:c, weight:3, opacity:1, fillColor:p.fill||c, fillOpacity:0.25}; };
    if(muni) _muniLayer = L.geoJSON(muni, { style:{color:"#000",weight:4,fillOpacity:0} }).addTo(_map);
    if(gj) _geoLayer = L.geoJSON(gj, { style }).addTo(_map);

    try {
      const b = (_geoLayer || _muniLayer).getBounds();
      if(b.isValid()) _map.fitBounds(b, {padding:[20,20]});
    } catch(e){}
    setTimeout(() => { _map.invalidateSize(); updatePrintFrame(); }, 120);
  }
  function closeMapModal(){ document.getElementById("mapModal").style.display="none"; }
  
  /// --- ÎÎ•Î‘ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘ Î•ÎšÎ¤Î¥Î Î©Î£Î—Î£ (RESTORED FROM OLD VERSION) ---
  function printMap() {
    if (!_map) { alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï‡Î¬ÏÏ„Î·Ï‚."); return; }

    const size = document.getElementById("paperSize").value;
    const layout = document.getElementById("paperLayout").value;
    
    // 1. Î’ÏÎ¯ÏƒÎºÎ¿Ï…Î¼Îµ Ï„Î± ÏŒÏÎ¹Î± (Bounds) Ï„Î¿Ï… ÎºÏŒÎºÎºÎ¹Î½Î¿Ï… Ï€Î»Î±Î¹ÏƒÎ¯Î¿Ï…
    const frame = document.getElementById("printFrame");
    const rect = frame.getBoundingClientRect();
    const mapRect = document.getElementById("mapBox").getBoundingClientRect();

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï„Ï‰Î½ pixels Ï„Î¿Ï… Ï€Î»Î±Î¹ÏƒÎ¯Î¿Ï… ÏƒÎµ Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÎ­Ï‚ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚
    const tl = _map.containerPointToLatLng([rect.left - mapRect.left, rect.top - mapRect.top]);
    const br = _map.containerPointToLatLng([rect.right - mapRect.left, rect.bottom - mapRect.top]);
    const printBounds = L.latLngBounds(tl, br);

    // 2. Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿Î³Î® Î³Î¹Î± ver4: Ï‡ÏÎ®ÏƒÎ· getGeoJson)
    const titleEl = document.getElementById("mapTitle");
    const title = (titleEl && titleEl.textContent) ? titleEl.textContent : "Î§Î¬ÏÏ„Î·Ï‚";
    
    const muni = getGeoJson('municipal');
    const basinId = (typeof CURRENT_MAP_BASIN_ID !== "undefined") ? CURRENT_MAP_BASIN_ID : null;
    const basin = (basinId && basinId !== "__MUNICIPAL__") ? getGeoJson('basin', basinId) : null;

    // 3. Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î±ÏƒÏ„Î¬ÏƒÎµÏ‰Î½ (Pixels @ 96dpi)
    let pxW, pxH;
    if (size === "a4") { pxW = 1123; pxH = 794; } // A4
    else { pxW = 1587; pxH = 1123; } // A3

    if (layout === "portrait") {
      const t = pxW; pxW = pxH; pxH = t; // Swap
    }

    // 4. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÏÏ…Ï†Î¿Ï Iframe
    const iframe = document.createElement("iframe");
    iframe.style.position = "fixed"; 
    iframe.style.left = "-15000px";
    iframe.style.width = pxW + "px"; 
    iframe.style.height = pxH + "px";
    iframe.style.border = "0";
    document.body.appendChild(iframe);

    const cleanup = () => { try { iframe.remove(); } catch(e){} };
    const idoc = iframe.contentWindow.document;

    // 5. HTML Iframe Î¼Îµ CSS Î³Î¹Î± Î¼Î·Î´ÎµÎ½Î¹ÎºÎ¬ Ï€ÎµÏÎ¹Î¸ÏÏÎ¹Î±
    const cssPage = `@page { size: ${size} ${layout}; margin: 0mm; }`;
    
    idoc.open();
    idoc.write(`
      <!doctype html><html><head>
      <meta charset='utf-8'>
      <style>
        ${cssPage}
        html, body { margin: 0 !important; padding: 0 !important; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #hdr { position: absolute; top: 20px; left: 20px; z-index: 9999; background: rgba(255,255,255,0.9); padding: 8px 12px; border: 2px solid #2c3e50; border-radius: 4px; font-family: sans-serif; font-weight: bold; font-size: 18px; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .leaflet-control-container { display: none !important; } 
      </style>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      </head><body>
      <div id="hdr">${title}</div>
      <div id="map"></div>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
      </body></html>
    `);
    idoc.close();

    // 6. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‡Î¬ÏÏ„Î·
    iframe.onload = () => {
      const win = iframe.contentWindow;
      const L = win.L;
      if (!L) { alert("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Leaflet ÏƒÏ„Î¿ iframe."); cleanup(); return; }

      const map = L.map(win.document.getElementById("map"), { 
          zoomControl: false, 
          attributionControl: false,
          zoomSnap: 0,
          zoomDelta: 0.1
      });
      
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19, attribution: ""
      }).addTo(map);

      // Styles
      const muniStyle = { color:"#000", weight:4, fillOpacity:0 };
      const basinStyle = (feature) => {
          const p = (feature && feature.properties) ? feature.properties : {};
          const n = (v) => { const x=parseFloat(v); return Number.isFinite(x)?x:1; }; 
          const color = p.stroke || p.color || "#2c3e50"; // Default color updated to match ver4 style
          const weight = n(p["stroke-width"] ?? p.strokeWidth ?? 3);
          const opacity = n(p["stroke-opacity"] ?? p.strokeOpacity ?? 1);
          const fillColor = p.fill || p.fillColor || color;
          const fo = p["fill-opacity"] ?? p.fillOpacity;
          const fillOpacity = (fo===undefined||fo===null||fo==="")? 0.25 : parseFloat(fo);
          return { color, weight, opacity, fillColor, fillOpacity };
      };

      if (muni) L.geoJSON(muni, { style: muniStyle }).addTo(map);
      if (basin) L.geoJSON(basin, { style: basinStyle }).addTo(map);

      // Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¿ÏÎ¯Ï‰Î½ Î¼Îµ Î¼Î·Î´ÎµÎ½Î¹ÎºÏŒ padding Î³Î¹Î± Î±Ï€ÏŒÎ»Ï…Ï„Î· Ï„Î±ÏÏ„Î¹ÏƒÎ· Î¼Îµ Ï„Î¿ ÎºÏŒÎºÎºÎ¹Î½Î¿ Ï€Î»Î±Î¯ÏƒÎ¹Î¿
      map.fitBounds([
        [printBounds.getSouth(), printBounds.getWest()],
        [printBounds.getNorth(), printBounds.getEast()]
      ], { padding: [0, 0] });

      // Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ· tiles
      setTimeout(() => {
        win.focus();
        win.print();
        setTimeout(cleanup, 5000); 
      }, 1200);
    };
  }

  // --- FILE HANDLERS ---
  function extractParams(gj) {
    const tryProps = (p) => {
      const out={}; if(!p) return out;
      ["area","length","height","coef","drains","drainCap","strWidth","strZ","strDepth","strDrop","strLen","strType"].forEach(k => {
        if(p[k]!=null) out[k]=_pf(p[k]);
        else { // regex fallback
            const m = JSON.stringify(p).match(new RegExp(`${k}\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)`, "i"));
            if(m) out[k]=_pf(m[1]);
        }
      });
      return out;
    };
    if(gj.type==="FeatureCollection" && gj.features.length) return tryProps(gj.features[0].properties);
    return tryProps(gj.properties || (gj.type==="Feature"?gj.properties:null));
  }

  function onGeoJsonSelected(basinId, file) {
    readJsonFile(file, (o) => {
       if(!o.type) throw 1;
       saveGeoJson('basin', basinId, o);
       const p = extractParams(o);
       if(Object.keys(p).length) {
         LSHelper.set(KEYS.BASIN_PFX+basinId, {...LSHelper.get(KEYS.BASIN_PFX+basinId), ...p});
         if(CURRENT_BASIN_ID === basinId) loadBasin(BASINS.findIndex(b=>b.id===basinId), true);
       }
       renderBasinTable(); updateBasinBadges();
    });
  }

  function onAddBasinSelected(file) {
    readJsonFile(file, (o) => {
        const id = "U"+String(Date.now()).slice(-4), name = file.name.replace(/\.[^/.]+$/, "");
        const p = extractParams(o);
        const vals = { area:p.area||0, length:p.length||0, height:p.height||0, coef:p.coef||0.6 };
        
        const list = LSHelper.get(KEYS.CUSTOM); list.push({id, name, values:vals}); LSHelper.set(KEYS.CUSTOM, list);
        saveGeoJson('basin', id, o);
        LSHelper.set(KEYS.BASIN_PFX+id, {...vals, ...p});
        
        rebuildBasins(); renderBasinTable(); loadBasin(BASINS.findIndex(b=>b.id===id));
        maybeAutoSave();
    });
  }

  function onMunicipalSelected(file) {
    readJsonFile(file, (o) => { saveGeoJson('municipal', null, o); renderBasinTable(); });
  }

  function deleteBasinById(id) {
    if(!confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® Î»ÎµÎºÎ¬Î½Î·Ï‚ "+id+";")) return;
    delGeoJson('basin', id); LSHelper.del(KEYS.BASIN_PFX+id);
    if(DEFAULT_BASINS.find(b=>b.id===id)) {
        const h = new Set(LSHelper.get(KEYS.HIDDEN)); h.add(id); LSHelper.set(KEYS.HIDDEN, Array.from(h));
    } else {
        LSHelper.set(KEYS.CUSTOM, LSHelper.get(KEYS.CUSTOM).filter(b=>b.id!==id));
    }
    rebuildBasins(); renderBasinTable(); if(CURRENT_BASIN_ID===id) loadBasin(0); maybeAutoSave();
  }

  // --- UI & CALC ---
  const DEFAULT_PROPS = { rainI: 0, rainD: 0, drains: 0, drainCap: 0, strWidth: 0, strZ: 0, strDepth: 0, strDrop: 0, strLen: 0, strType: "0.030" };


  // --- METEO STATIONS (Side Panel) ---
  const DEFAULT_METEO_STATIONS = [
    { id: "chalandri", name: "Î§Î±Î»Î¬Î½Î´ÏÎ¹ (penteli.meteo.gr)", url: "https://penteli.meteo.gr/stations/chalandri/" }
  ];

    function bootstrapMeteoFromEmbedded() {
    try {
      // 1. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï…Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½ Î±Ï€ÏŒ Ï„Î· Î¼Î½Î®Î¼Î· (LocalStorage)
      let lsStations = LSHelper.get(KEYS.METEO_CUSTOM, []);
      const lsIds = new Set(lsStations.map(s => s.id));
      let changed = false;

      // 2. Î£Ï…Î³Ï‡ÏÎ½ÎµÏ…ÏƒÎ·: ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï„Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½ Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ HTML
      if (Array.isArray(EMBEDDED_CUSTOM_METEO_STATIONS) && EMBEDDED_CUSTOM_METEO_STATIONS.length) {
        EMBEDDED_CUSTOM_METEO_STATIONS.forEach(embSt => {
          // Î‘Î½ Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚ Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î· Î¼Î½Î®Î¼Î·, Ï„Î¿Î½ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ
          if (!lsIds.has(embSt.id)) {
            lsStations.push(embSt);
            lsIds.add(embSt.id); // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï… Set Î³Î¹Î± Î±Ï€Î¿Ï†Ï…Î³Î® Î´Î¹Ï€Î»Î¿ÎµÎ³Î³ÏÎ±Ï†ÏÎ½
            changed = true;
          }
        });
      }

      // 3. Î‘Î½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î½Î­Î¿Î¹ ÏƒÏ„Î±Î¸Î¼Î¿Î¯ ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿, ÎµÎ½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ Ï„Î· Î¼Î½Î®Î¼Î·
      if (changed) {
        LSHelper.set(KEYS.METEO_CUSTOM, lsStations);
      } else if (!localStorage.getItem(KEYS.METEO_CUSTOM) && lsStations.length > 0) {
        // Î ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… Î· Î¼Î½Î®Î¼Î· Î®Ï„Î±Î½ Î¬Î´ÎµÎ¹Î±
        LSHelper.set(KEYS.METEO_CUSTOM, lsStations);
      }

      // --- Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Ï€Î¹Î»Î¿Î³ÏÎ½ (Selections) ---
      if (!localStorage.getItem(KEYS.METEO_MULTI) && Array.isArray(EMBEDDED_METEO_SELECTED_IDS) && EMBEDDED_METEO_SELECTED_IDS.length) {
        LSHelper.set(KEYS.METEO_MULTI, EMBEDDED_METEO_SELECTED_IDS);
      }
      if (!localStorage.getItem(KEYS.METEO_AGG) && typeof EMBEDDED_METEO_AGG === "string" && EMBEDDED_METEO_AGG) {
        localStorage.setItem(KEYS.METEO_AGG, EMBEDDED_METEO_AGG);
      }
      // Fallback Î³Î¹Î± Ï€Î±Î»Î¹Î¬ single selection
      if (!localStorage.getItem(KEYS.METEO)) {
        const ids = (Array.isArray(EMBEDDED_METEO_SELECTED_IDS) ? EMBEDDED_METEO_SELECTED_IDS : []);
        if (ids.length) localStorage.setItem(KEYS.METEO, String(ids[0]));
      }

    } catch(e) { console.error("Meteo Bootstrap Error:", e); }
  }


  function _cleanStations(list){
    return (list || []).filter(s => s && s.id && s.name && s.url).map(s => ({
      id: String(s.id).trim(),
      name: String(s.name).trim(),
      url: String(s.url).trim()
    })).filter(s => s.id && s.name && /^https?:\/\//i.test(s.url));
  }

  function getAllMeteoStations(){
    const custom = _cleanStations(LSHelper.get(KEYS.METEO_CUSTOM, []));
    const merged = [...DEFAULT_METEO_STATIONS, ...custom];
    const seen = new Set();
    return merged.filter(s => (seen.has(s.id) ? false : (seen.add(s.id), true)));
  }

  function getMeteoAgg(){
    const v = (localStorage.getItem(KEYS.METEO_AGG) || "max").toLowerCase();
    return (v === "avg" || v === "min" || v === "max") ? v : "max";
  }
  function setMeteoAgg(v){
    const vv = String(v || "max").toLowerCase();
    localStorage.setItem(KEYS.METEO_AGG, (vv === "avg" || vv === "min" || vv === "max") ? vv : "max");
    const sel = document.getElementById("meteoAggSelect");
    if(sel) sel.value = getMeteoAgg();
    updateStationLabelFromSelection();
  }

  function getSelectedMeteoStationIds(){
    const stations = getAllMeteoStations();
    const valid = new Set(stations.map(s => s.id));
    let ids = LSHelper.get(KEYS.METEO_MULTI, []);
    if(!Array.isArray(ids)) ids = [];
    ids = Array.from(new Set(ids.map(x => String(x).trim()).filter(Boolean))).filter(id => valid.has(id));

    const single = localStorage.getItem(KEYS.METEO);
    if(!ids.length && single && valid.has(single)) ids = [single];

    if(!ids.length && stations[0]) ids = [stations[0].id];
    return ids;
  }

  function setSelectedMeteoStationIds(ids){
    const stations = getAllMeteoStations();
    const valid = new Set(stations.map(s => s.id));
    let out = Array.from(new Set((ids || []).map(x => String(x).trim()).filter(Boolean))).filter(id => valid.has(id));
    if(!out.length && stations[0]) out = [stations[0].id];

    LSHelper.set(KEYS.METEO_MULTI, out);
    localStorage.setItem(KEYS.METEO, out[0]);

    const sel = document.getElementById("meteoStationSelect");
    if(sel){
      Array.from(sel.options).forEach(o => { o.selected = out.includes(o.value); });
    }
    updateStationLabelFromSelection();
    renderMeteoStationsUI();
  }

  function getSelectedMeteoStationId(){
    const ids = getSelectedMeteoStationIds();
    return ids[0] || null;
  }

  function setSelectedMeteoStationId(id){
    if(!id) return;
    setSelectedMeteoStationIds([id]);
  }

  function getSelectedMeteoStation(){
    const stations = getAllMeteoStations();
    const id = getSelectedMeteoStationId();
    return stations.find(s => s.id === id) || stations[0] || null;
  }

  function updateStationLabelFromSelection(){
    const ids = getSelectedMeteoStationIds();
    const stations = getAllMeteoStations();
    const st0 = stations.find(s => s.id === ids[0]) || stations[0] || null;
    const lab = document.getElementById("stationLabel");
    if(!lab) return;
    if(ids.length <= 1) lab.textContent = st0 ? st0.name : "â€”";
    else lab.textContent = `${ids.length} ÏƒÏ„Î±Î¸Î¼Î¿Î¯ (${getMeteoAgg().toUpperCase()})`;
  }

  function setMeteoMsg(txt){
    const a = document.getElementById("stationMsg");
    const b = document.getElementById("meteoMsg");
    if(a) a.textContent = txt;
    if(b) b.textContent = txt;
  }

  function renderMeteoStationsUI(){
    const stations = getAllMeteoStations();
    const selectedIds = getSelectedMeteoStationIds();

    const sel = document.getElementById("meteoStationSelect");
    if(sel){
      sel.innerHTML = stations.map(s => `<option value="${s.id}">${s.name}</option>`).join("");
      Array.from(sel.options).forEach(o => { o.selected = selectedIds.includes(o.value); });
    }

    const aggSel = document.getElementById("meteoAggSelect");
    if(aggSel) aggSel.value = getMeteoAgg();

    updateStationLabelFromSelection();

    // Space-saving: show selection summary inside panel, hide the pills row
    const summary = document.getElementById("meteoSelectedSummary");
    if(summary){
      if(selectedIds.length <= 1){
        const st0 = stations.find(s => s.id === (selectedIds[0] || "")) || stations[0] || null;
        summary.textContent = st0 ? `Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚: ${st0.name}` : "Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚: â€”";
      } else {
        summary.textContent = `Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Î¹: ${selectedIds.length} (${getMeteoAgg().toUpperCase()})`;
      }
    }
    // (meteoFavs pills intentionally disabled)
    }

  function onMeteoStationChanged(){
    const sel = document.getElementById("meteoStationSelect");
    if(!sel) return;
    const ids = Array.from(sel.selectedOptions || []).map(o => o.value);
    setSelectedMeteoStationIds(ids);
    try { clearStationSeries(); setLiveBtn(); } catch(e) {}
  }

  function onMeteoAggChanged(){
    const sel = document.getElementById("meteoAggSelect");
    if(sel) setMeteoAgg(sel.value);
    try { clearStationSeries(); } catch(e) {}
  }

  function openSelectedStation(){
    const ids = getSelectedMeteoStationIds();
    const stations = getAllMeteoStations();
    const chosen = ids.map(id => stations.find(s => s.id === id)).filter(Boolean);
    if(!chosen.length) { alert("Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯ URL ÏƒÏ„Î±Î¸Î¼Î¿Ï."); return; }

    if(chosen.length === 1) {
      window.open(chosen[0].url, "_blank");
      return;
    }

    const ok = confirm(`Î†Î½Î¿Î¹Î³Î¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½ (${chosen.length} ÎºÎ±ÏÏ„Î­Î»ÎµÏ‚);`);
    if(ok) chosen.forEach(s => s.url && window.open(s.url, "_blank"));
    else window.open(chosen[0].url, "_blank");
  }

  function addMeteoStation(){
    const name = prompt("ÎŒÎ½Î¿Î¼Î± ÏƒÏ„Î±Î¸Î¼Î¿Ï (Ï€.Ï‡. Î§Î±Î»Î¬Î½Î´ÏÎ¹ - ÎšÎµÎ½Ï„ÏÎ¹ÎºÏŒ):");
    if(!name) return;
    const url = prompt("URL ÏƒÏ„Î±Î¸Î¼Î¿Ï (Ï€.Ï‡. https://...):");
    if(!url || !/^https?:\/\//i.test(url.trim())) { alert("ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ URL."); return; }

    const list = _cleanStations(LSHelper.get(KEYS.METEO_CUSTOM, []));
    const id = "S" + String(Date.now());
    list.push({ id, name: name.trim(), url: url.trim() });
    LSHelper.set(KEYS.METEO_CUSTOM, list);

    setSelectedMeteoStationIds([id]);
    setMeteoMsg("Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚: " + name.trim());
  }

  function deleteSelectedMeteoStation(){
    const st = getSelectedMeteoStation();
    if(!st) return;
    if(DEFAULT_METEO_STATIONS.some(d => d.id === st.id)) { alert("ÎŸ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚ Î´ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹."); return; }
    if(!confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï: " + st.name + ";")) return;

    const list = _cleanStations(LSHelper.get(KEYS.METEO_CUSTOM, [])).filter(s => s.id !== st.id);
    LSHelper.set(KEYS.METEO_CUSTOM, list);

    // Remove from multi selection too
    const nextSel = getSelectedMeteoStationIds().filter(id => id !== st.id);
    setSelectedMeteoStationIds(nextSel);

    setMeteoMsg("Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ: " + st.name);
  }

  function toggleMeteoPanel(){
    const body = document.getElementById("meteoBody");
    const btn = document.getElementById("meteoToggleBtn");
    if(!body || !btn) return;
    const open = (body.style.display === "none");
    body.style.display = open ? "block" : "none";
    btn.textContent = open ? "â€“" : "+";
    localStorage.setItem(KEYS.METEO_UI, open ? "open" : "closed");
  }

  function initMeteoPanel(){
    bootstrapMeteoFromEmbedded();
    const state = localStorage.getItem(KEYS.METEO_UI) || "open";
    const body = document.getElementById("meteoBody");
    const btn = document.getElementById("meteoToggleBtn");
    if(body && btn){
      const open = (state !== "closed");
      body.style.display = open ? "block" : "none";
      btn.textContent = open ? "â€“" : "+";
    }
    renderMeteoStationsUI();
  }

function calculateTc(L, H) { return (!L || !H) ? 10 : 0.0195 * Math.pow(L, 0.77) * Math.pow((H/L), -0.385); }

  function updateBasinBadges(){
    const i = getVal('rainI'), dInput = getVal('rainD');
    BASINS.forEach(b => {
      const el = document.getElementById(`badge_${b.id}`); if(!el) return;
      if(i <= 0) { el.className = "qbadge qb-gray"; el.textContent = "â€”"; return; }
      const Tc = calculateTc(b.values.length, b.values.height), D = dInput > 0 ? dInput : Math.max(5, Tc);
      const Peq = i * (D/60) * b.values.coef;
      let cls = "qb-gray";
      if(Peq>=60) cls="qb-extreme"; else if(Peq>=40) cls="qb-red"; else if(Peq>=25) cls="qb-orange"; else if(Peq>=10) cls="qb-yellow"; else cls="qb-green";
      el.className = `qbadge ${cls}`; el.textContent = Peq.toFixed(1) + " mm";
    });
  }

  function renderBasinTable() {
    const tbody = document.getElementById("basinRows"); tbody.innerHTML = "";
    const hasMuni = !!getGeoJson('municipal');
    
    // Rows Helper
    const addRow = (html) => { const tr=document.createElement('tr'); tr.innerHTML=html; tbody.appendChild(tr); return tr; };

    const escAttr = (s) => String(s)
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    const btnHtml = (lbl, clk, cls="mini-go-btn", style="") =>
      `<button type="button" class="${cls}" onclick="${escAttr(clk)}" style="${escAttr(style)}">${lbl}</button>`;

    const fileIn = (id, chg) =>
      `<input type="file" id="${id}" style="display:none" onchange="${escAttr(chg)}" accept=".json,.geojson">`;


    // Muni Row
    addRow(`<td style="font-weight:900;font-size:10px">ÎŸÎ¡Î™Î‘ Î”Î—ÎœÎŸÎ¥</td><td style="text-align:center"><span class="qbadge ${hasMuni?'qb-green':'qb-gray'}">${hasMuni?'OK':'â€”'}</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_muni','onMunicipalSelected(this.files[0])')}
      ${btnHtml('Map',"openMapModal('__MUNICIPAL__')")} ${btnHtml('JSON',"document.getElementById('f_muni').click()","mini-go-btn",hasMuni?'color:#82e0aa':'')}
      ${btnHtml('ğŸ—‘','if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÏÎ¯Ï‰Î½;")){delGeoJson("municipal",null);renderBasinTable();}','mini-del-btn')}</td>`);

    // Add Row
    addRow(`<td style="font-weight:900;font-size:10px">â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— Î›Î•ÎšÎ‘ÎÎ—Î£</td><td style="text-align:center"><span class="qbadge qb-gray">+</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_add','onAddBasinSelected(this.files[0])')}
      ${btnHtml('JSON',"document.getElementById('f_add').click()")}
      ${btnHtml('â†º','if(confirm("Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏÏ…Î¼Î¼Î­Î½Ï‰Î½;")){LSHelper.del(KEYS.HIDDEN);rebuildBasins();renderBasinTable();}','mini-go-btn')}</td>`);

    // Basins
    BASINS.forEach((b, idx) => {
      const hasG = !!getGeoJson('basin', b.id);
      const tr = addRow(`<td style="font-size:10px">${basinLabel(b)}</td>
        <td style="text-align:center"><span id="badge_${b.id}" class="qbadge qb-gray">â€”</span></td>
        <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_'+b.id,`onGeoJsonSelected('${b.id}',this.files[0])`)}
        ${btnHtml('Go',`event.stopPropagation();loadBasin(${idx},true)`)} ${btnHtml('Map',`event.stopPropagation();openMapModal('${b.id}')`)}
        ${btnHtml('JSON',`event.stopPropagation();document.getElementById('f_${b.id}').click()`,"mini-go-btn",hasG?'color:#82e0aa':'')}
        ${btnHtml('ğŸ—‘',`event.stopPropagation();deleteBasinById('${b.id}')`,'mini-del-btn')}</td>`);
      tr.style.cursor="pointer"; tr.onclick=()=>loadBasin(idx);
    });
  }
  function toggleBasinPanel() { const b=document.getElementById("basinPanelBody"); b.style.display=(b.style.display==="none"?"block":"none"); document.getElementById("basinToggleBtn").textContent=(b.style.display==="none"?"+":"â€“"); }

  function loadBasin(idx, force=false) {
    if(!BASINS[idx]) return;
    const b = BASINS[idx]; CURRENT_BASIN_ID = b.id;
    const saved = LSHelper.get(KEYS.BASIN_PFX+b.id, {});
    const fromGJ = getGeoJson('basin', b.id) ? extractParams(getGeoJson('basin', b.id)) : {};
    
    // Priority: Saved > GeoJSON > Default. Force: GeoJSON > Saved
    const vals = force ? { ...DEFAULT_PROPS, ...b.values, ...saved, ...fromGJ } : { ...DEFAULT_PROPS, ...b.values, ...fromGJ, ...saved };
    Object.keys(vals).forEach(k => { if(!['rainI','rainD'].includes(k)) setInputValue(k, vals[k]); });
    document.getElementById("selectedBasin").textContent = basinLabel(b);
    runMasterCalculation();
  }
  // --- BASIN VISUALIZER (schematic or GeoJSON outline) ---
  function geojsonToRings(gj) {
    const rings = [];
    const addGeom = (g) => {
      if(!g) return;
      if(g.type === "Feature") return addGeom(g.geometry);
      if(g.type === "FeatureCollection") return (g.features||[]).forEach(f => addGeom(f));
      if(g.type === "GeometryCollection") return (g.geometries||[]).forEach(addGeom);
      if(g.type === "Polygon") return (g.coordinates||[]).forEach(r => rings.push(r));
      if(g.type === "MultiPolygon") return (g.coordinates||[]).forEach(p => (p||[]).forEach(r => rings.push(r)));
      if(g.type === "LineString") return rings.push(g.coordinates||[]);
      if(g.type === "MultiLineString") return (g.coordinates||[]).forEach(r => rings.push(r));
      if(g.type === "Point") return rings.push([g.coordinates]);
      if(g.type === "MultiPoint") return rings.push(g.coordinates||[]);
    };
    addGeom(gj);
    return rings.filter(r => Array.isArray(r) && r.length);
  }

  function drawGeoRings(ctx, rings, w, h, style) {
    // Padding: Î»Î¯Î³Î¿ Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ· Î±Ï€ÏŒÎ´Î¿ÏƒÎ· Ï„Î¿Ï… Ï€ÎµÏÎ¹Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Î±ÎºÎ¿Ï…Î¼Ï€Î¬ ÏƒÏ„Î¿ Ï€Î»Î±Î¯ÏƒÎ¹Î¿)
    const padX = 0;      // Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬/Î´ÎµÎ¾Î¹Î¬
    const padTop = 4;   // Î±Ï†Î®Î½ÎµÎ¹ Ï‡ÏÏÎ¿ Î³Î¹Î± Ï„Î¿Î½ Ï„Î¯Ï„Î»Î¿
    const padBottom = 4; // Î»Î¯Î³Î¿ Â«Î±Î­ÏÎ±Ï‚Â» ÎºÎ¬Ï„Ï‰
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    rings.forEach(r => (r||[]).forEach(p => {
      if(!p || p.length < 2) return;
      const x = p[0], y = p[1];
      if(x < minX) minX = x; if(x > maxX) maxX = x;
      if(y < minY) minY = y; if(y > maxY) maxY = y;
    }));
    if(!isFinite(minX) || !isFinite(maxX) || maxX === minX || maxY === minY) return false;

    const availW = w - 2*padX;
    const availH = h - padTop - padBottom;
    if(availW <= 0 || availH <= 0) return false;

    const sx = availW / (maxX - minX);
    const sy = availH / (maxY - minY);
    const s = Math.min(sx, sy);

    const boxW = (maxX - minX) * s, boxH = (maxY - minY) * s;
    const ox = padX + (availW - boxW) / 2 - minX * s;
    const oy = padTop + (availH - boxH) / 2 + maxY * s; // flip y so "north" is up

    const st = style || {};
    ctx.lineWidth = st.lineWidth || 2;
    ctx.strokeStyle = st.stroke || "#16a085";
    ctx.fillStyle = st.fill || "rgba(26,188,156,0.22)";
rings.forEach(r => {
      if(!r || r.length < 2) return;
      ctx.beginPath();
      r.forEach((p, i) => {
        const x = ox + p[0]*s;
        const y = oy - p[1]*s;
        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });

      const closed = (r.length > 3 && r[0][0] === r[r.length-1][0] && r[0][1] === r[r.length-1][1]);
      if(closed) ctx.closePath();

      if(closed) ctx.fill();
      ctx.stroke();
    });

    return true;
  }

  function roundRect(ctx, x, y, w, h, r) {
    const rr = Math.max(0, Math.min(r, w/2, h/2));
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawArrow(ctx, x1, y1, x2, y2, color) {
    const ang = Math.atan2(y2-y1, x2-x1);
    const head = 6;
    const c = color || "#16a085";
    ctx.strokeStyle = c; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    ctx.fillStyle = c;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - head*Math.cos(ang - Math.PI/6), y2 - head*Math.sin(ang - Math.PI/6));
    ctx.lineTo(x2 - head*Math.cos(ang + Math.PI/6), y2 - head*Math.sin(ang + Math.PI/6));
    ctx.closePath(); ctx.fill();
  }

  // Basin coloring helpers (Fill: runoff coefficient C, Outline: screening Qcap vs Qpeak)
  function basinFillByC(C) {
    if(!(C > 0)) return { fill: "rgba(149,165,166,0.18)", label: "C=â€”" };
    if(C <= 0.35) return { fill: "rgba(26,188,156,0.30)", label: `C=${C.toFixed(2)} (Ï‡Î±Î¼Î·Î»Î®)` };
    if(C <= 0.60) return { fill: "rgba(243,156,18,0.28)", label: `C=${C.toFixed(2)} (Î¼Î­Ï„ÏÎ¹Î±)` };
    return { fill: "rgba(231,76,60,0.26)", label: `C=${C.toFixed(2)} (Ï…ÏˆÎ·Î»Î®)` };
  }

  function basinStrokeByScreen(Qpeak, Qcap) {
    // More informative "unknown" states
    if(!(Qpeak > 0) || !isFinite(Qpeak)) {
      return { stroke: "#7f8c8d", lineWidth: 2, label: "ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ A & I" };
    }
    if(!(Qcap > 0) || !isFinite(Qcap)) {
      return { stroke: "#7f8c8d", lineWidth: 2, label: "ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ÏƒÏ…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Î´Î¯ÎºÏ„Ï…Î¿/ÏÎ­Î¼Î±" };
    }
    const ok = (Qcap >= Qpeak);
    const s = ok ? "#27ae60" : "#c0392b";
    const tag = ok ? "OK" : "ÎŸÎ§Î™";
    const ratio = ` (${Qcap.toFixed(2)}/${Qpeak.toFixed(2)})`;
    return { stroke: s, lineWidth: 2.5, label: `ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ${tag}${ratio}` };
  }
  function ellipsizeCanvasText(ctx, text, maxWidth) {
    if(!text) return "";
    if(ctx.measureText(text).width <= maxWidth) return text;
    const ell = "â€¦";
    let t = String(text);
    while(t.length > 0 && ctx.measureText(t + ell).width > maxWidth) t = t.slice(0, -1);
    return t.length ? (t + ell) : ell;
  }

  function drawBasinLegend(ctx, fillInfo, strokeInfo) {
    // Prefer DOM legend (outside the canvas), so it does not cover the basin drawing.
    const el = document.getElementById('basinLegend');
    if(el) {
      const esc = (s) => String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");

      const fill = fillInfo?.fill || "rgba(149,165,166,0.18)";
      const stroke = strokeInfo?.stroke || "#7f8c8d";
      const fillLbl = esc(fillInfo?.label || "");
      const strokeLbl = esc(strokeInfo?.label || "");

      el.innerHTML = `
        <div class="bl-row">
          <span class="bl-swatch" style="background:${fill};"></span>
          <span class="bl-text" title="${fillLbl}">${fillLbl}</span>
        </div>
        <div class="bl-row">
          <span class="bl-line" style="border-top-color:${stroke};"></span>
          <span class="bl-text" title="${strokeLbl}">${strokeLbl}</span>
        </div>
      `.trim();
      return; // do NOT draw on canvas
    }

    // Fallback: draw inside canvas (legacy)
    const pad = 6;
    const x = pad, y = 18;
    const w = Math.max(100, ctx.canvas.width - pad*2);
    const h = 44;

    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.86)";
    ctx.strokeStyle = "rgba(0,0,0,0.12)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect ? ctx.roundRect(x, y, w, h, 6) : ctx.rect(x, y, w, h);
    ctx.fill(); ctx.stroke();

    // Fill sample
    ctx.fillStyle = fillInfo.fill;
    ctx.fillRect(x+8, y+8, 14, 14);
    ctx.strokeStyle = "rgba(0,0,0,0.20)";
    ctx.strokeRect(x+8, y+8, 14, 14);

    // Stroke sample
    ctx.strokeStyle = strokeInfo.stroke;
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(x+8, y+32); ctx.lineTo(x+22, y+32); ctx.stroke();

    ctx.fillStyle = "#2c3e50";
    ctx.font = "9px Arial";
    ctx.textAlign = "left";

    const textX = x + 28;
    const maxTextW = (x + w) - textX - 6;

    ctx.fillText(ellipsizeCanvasText(ctx, fillInfo.label, maxTextW), textX, y+18);
    ctx.fillText(ellipsizeCanvasText(ctx, strokeInfo.label, maxTextW), textX, y+34);

    ctx.restore();
  }

  function drawBasinPlan() {
    const canvas = document.getElementById('basinCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);


    // Styles based on C (fill) & screening (outline)
    const C = getVal('coef');
    const fillInfo = basinFillByC(C);

    // Peak discharge (Rational method)
    const area = getVal('area');
    const I = getVal('rainI');
    const A_km2 = (area > 0) ? area / 1e6 : 0;
    const Qpeak = (C > 0 && I > 0 && A_km2 > 0) ? (0.278 * C * I * A_km2) : NaN;

    // Capacity: prefer network (inlets), fallback to channel (Manning) if available
    const drains = getVal('drains'), drainCap = getVal('drainCap');
    let Qcap = (drains > 0 && drainCap > 0) ? (drains * drainCap) : NaN;

    if(!isFinite(Qcap) || !(Qcap > 0)) {
      const bw = getVal('strWidth'), z = getVal('strZ'), H = getVal('strDepth'), n = getVal('strType');
      const sLen = getVal('strLen') || getVal('length');
      const sDrop = getVal('strDrop') || getVal('height');
      const sSlope = (sLen > 0) ? (sDrop / sLen) : 0;
      if(bw > 0 && H > 0 && n > 0 && sSlope > 0) {
        const Asec = (bw + z*H) * H;
        const Pwet = bw + 2*H*Math.sqrt(1 + z*z);
        Qcap = (1/n) * Math.pow(Asec, 5/3) * Math.pow(Pwet, -2/3) * Math.sqrt(sSlope);
      }
    }

    const strokeInfo = basinStrokeByScreen(Qpeak, Qcap);
    const style = { fill: fillInfo.fill, stroke: strokeInfo.stroke, lineWidth: strokeInfo.lineWidth };
    // Prefer actual outline if GeoJSON exists for current basin
    const gj = (typeof CURRENT_BASIN_ID !== "undefined" && CURRENT_BASIN_ID) ? getGeoJson('basin', CURRENT_BASIN_ID) : null;
    const rings = gj ? geojsonToRings(gj) : [];
    const hasGeo = rings && rings.length && rings.some(r => (r||[]).length > 2);
    if(hasGeo && drawGeoRings(ctx, rings, w, h, style)) {
      ctx.fillStyle = "#2c3e50"; ctx.font = "bold 9px Arial"; ctx.textAlign = "left";
      ctx.fillText("Î ÎµÏÎ¯Î³ÏÎ±Î¼Î¼Î± (GeoJSON)", 6, 12);
      drawBasinLegend(ctx, fillInfo, strokeInfo);
      return;
    }

    // Fallback: schematic based on A & L (Wâ‰ˆA/L)
    const A = getVal('area'), L = getVal('length');
    if(!(A>0) || !(L>0)) {
      ctx.fillStyle="#999"; ctx.font="10px Arial"; ctx.textAlign="center";
      ctx.fillText("ÎŸÏÎ¯ÏƒÏ„Îµ A & L", w/2, h/2);
      // Keep legend visible even when the schematic cannot be computed.
      drawBasinLegend(ctx, fillInfo, strokeInfo);
      return;
    }
    const W = A / L;
    const pad = 12, maxW = w - 2*pad, maxH = h - 2*pad;
    const scale = Math.min(maxW / L, maxH / (W || 1));
    const Ls = L * scale, Ws = (W || 1) * scale;

    const x = (w - Ls) / 2;
    const y = (h - Ws) / 2;

    roundRect(ctx, x, y, Ls, Ws, Math.min(12, Ws/2, Ls/8));
    ctx.fillStyle = style.fill; ctx.fill();
    ctx.strokeStyle = style.stroke; ctx.lineWidth = style.lineWidth; ctx.stroke();
drawArrow(ctx, x+6, y+Ws/2, x+Ls-6, y+Ws/2, style.stroke);

    ctx.fillStyle="#000"; ctx.font="bold 9px Arial"; ctx.textAlign="center";
    ctx.fillText(`Lâ‰ˆ${Math.round(L)} m`, w/2, h-4);

    ctx.save();
    ctx.translate(10, h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign="center";
    ctx.fillText(`Wâ‰ˆ${Math.round(W)} m`, 0, 0);
    ctx.restore();

    drawBasinLegend(ctx, fillInfo, strokeInfo);
  }


  function drawChannel(y_real) {
    const canvas = document.getElementById('channelCanvas'), ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height; ctx.clearRect(0, 0, w, h);
    
    const [b, z, H, y] = [getVal('strWidth'), getVal('strZ'), getVal('strDepth'), y_real];
    if(b<=0 && H<=0) { ctx.fillStyle="#ccc"; ctx.font="10px Arial"; ctx.textAlign="center"; ctx.fillText("ÎŸÏÎ¯ÏƒÏ„Îµ b & h", w/2, h/2); return; }

    const maxH = Math.max(H, y), topW = b + 2*(z*maxH), pad=20;
    const scale = Math.min((w-pad)/(topW||1), (h-pad)/(maxH||1));
    const cx = w/2, cy = h-15, gx = (wd) => (wd*scale)/2, gy = (d) => cy - (d*scale);

    const drawPoly = (tw, d, fill, str, dash=[]) => {
        ctx.beginPath(); ctx.moveTo(cx-gx(tw), gy(d)); ctx.lineTo(cx-gx(b), cy); ctx.lineTo(cx+gx(b), cy); ctx.lineTo(cx+gx(tw), gy(d));
        if(fill){ ctx.fillStyle=fill; ctx.fill(); } if(str){ ctx.strokeStyle=str; ctx.setLineDash(dash); ctx.stroke(); ctx.setLineDash([]); }
    };

    if(H>0) {
        drawPoly(b+2*z*H, H, null, "#5D4037");
        ctx.fillStyle="#5D4037"; ctx.textAlign="left"; ctx.font="bold 10px Arial";
        ctx.fillText(`h=${H}m`, cx-gx(b+2*z*H)+8, gy(H)+10);
    }
    if(y>0) {
        const isOver = (H>0 && y>H);
        drawPoly(b+2*z*Math.min(y, H*1.5||y), Math.min(y, H*1.5||y), isOver?"rgba(231,76,60,0.6)":"rgba(52,152,219,0.6)", isOver?"#c0392b":"#2980b9", isOver?[]:[]);
        ctx.closePath(); ctx.beginPath(); ctx.moveTo(cx-gx(b+2*z*y), gy(y)); ctx.lineTo(cx+gx(b+2*z*y), gy(y)); ctx.stroke();
        ctx.fillStyle="#000"; ctx.textAlign="center"; ctx.font="bold 10px Arial"; ctx.fillText(`y=${y.toFixed(2)}m`, cx, cy-(y*scale)/2+4);
    }
    if(b>0) { ctx.fillStyle="#000"; ctx.textAlign="center"; ctx.font="bold 10px Arial"; ctx.fillText(`b=${b}m`, cx, cy+12); }
  }
  
  function resetStrY() { const el=document.getElementById('strY'); el.value=""; delete el.dataset.manual; runMasterCalculation(); }

  function runMasterCalculation() {
    // Collect Inputs
    const inputs = {};
    ['area','length','height','coef','rainI','rainD','drains','drainCap','strWidth','strZ','strDepth','strDrop','strLen','strType','strY'].forEach(k => inputs[k] = getVal(k));
    
    if(!isFiniteNumber(inputs.area)) return;
    const A_km2 = inputs.area / 1e6, S = (inputs.length>0&&inputs.height>0) ? inputs.height/inputs.length : 0.01;
    const Tc = calculateTc(inputs.length, inputs.height);
    const Dused = (inputs.rainD > 0) ? inputs.rainD : Math.max(5.0, Tc);
    
    // Results
    const Qsel = 0.278 * inputs.coef * inputs.rainI * A_km2;
    const CapNet = inputs.drains * inputs.drainCap;
    
    const sLen = inputs.strLen || inputs.length, sDrop = inputs.strDrop || inputs.height;
    const sSlope = sLen>0 ? sDrop/sLen : 0;
    
    let CapStr = 0, yCalc = 0;
    if(inputs.strWidth>0 && inputs.strDepth>0 && sSlope>0) {
       const calcQ = (d) => {
         const A = (inputs.strWidth + inputs.strZ*d)*d, P = inputs.strWidth + 2*d*Math.sqrt(1+inputs.strZ**2);
         return (1/inputs.strType) * Math.pow(A, 5/3) * Math.pow(P, -2/3) * Math.sqrt(sSlope);
       };
       CapStr = calcQ(inputs.strDepth);
       
       // Calc Normal Depth (Iterative)
       if(Qsel > 0) {
          let low=0, high=(inputs.strDepth*2)||20;
          for(let i=0;i<20;i++){ const mid=(low+high)/2; if(calcQ(mid)<Qsel) low=mid; else high=mid; }
          yCalc = (low+high)/2;
       }
    }

    // Render Stats
    const setText = (id, txt) => document.getElementById(id).innerHTML = txt;
    setText('res-slope', (S*100).toFixed(1)+" %");
    setText('res-qsel', Qsel.toFixed(2)+" mÂ³/s");
    setText('res-kq', (0.278*inputs.coef*A_km2).toFixed(3));
    setText('res-kv', Math.round(inputs.area*inputs.coef/1000).toLocaleString('el-GR'));
    setText('res-drains', CapNet.toFixed(2)+" mÂ³/s");
    setText('res-stream', CapStr.toFixed(2)+" mÂ³/s");
    
    // Tc Dual Display
    const tcEl = document.getElementById('res-tc');
    if((!inputs.rainD || inputs.rainD<=0) && Tc < 5) {
       tcEl.innerHTML = `<div title="ÎŒÏÎ¹Î¿ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ (5 min)" style="line-height:1.1;cursor:help;"><span style="color:#d35400;font-weight:bold;">5.0 min</span><div style="font-size:10px;color:#7f8c8d;">(calc: ${Tc.toFixed(2)})</div></div>`;
    } else { tcEl.innerHTML = Tc.toFixed(1) + " min"; }

    // Adequacy
    let adq = "<span style='color:#7f8c8d'>Î§Ï‰ÏÎ¯Ï‚ Qcap</span>";
    if(CapNet>0 && CapStr>0) adq = "<span class='status-ok'>Î”Î¹Ï€Î»ÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚</span>";
    else if(CapNet>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ ÏƒÏ…Î»Î»Î¿Î³Î®</span>";
    else if(CapStr>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·</span>";
    setText('res-adequacy', adq);

    // Table
    const tbody = document.getElementById('tableBody'); tbody.innerHTML="";
    const status = (Q, Cap) => Cap<=0 ? "<span class='status-fail' style='font-size:9px;'>â€”</span>" : (Q<=Cap*0.85 ? "<span class='status-ok'>OK</span>" : (Q<=Cap ? "<span class='status-warn'>ÎŸÏÎ¹Î±ÎºÏŒ</span>" : "<span class='status-fail'>Î¥Ï€Î­ÏÎ²Î±ÏƒÎ·</span>"));
    
    for(let i=5; i<=200; i+=5) {
       const P = i*(Dused/60), Q=0.278*inputs.coef*i*A_km2, V=inputs.area*(P/1000)*inputs.coef, Peq=P*inputs.coef;
       let cls="risk-safe", txt="Î§Î±Î¼Î·Î»Î®";
       if(Peq>=60){cls="risk-extreme";txt="Î‘ÎºÏÎ±Î¯Î±";} else if(Peq>=40){cls="risk-red";txt="Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®";} else if(Peq>=25){cls="risk-orange";txt="Î¥ÏˆÎ·Î»Î®";} else if(Peq>=10){cls="risk-warn";txt="ÎœÎ­Ï„ÏÎ¹Î±";}
       
       const row = document.createElement('tr'); row.className = cls;
       row.innerHTML = `<td><b>${i}</b></td><td>${Dused.toFixed(1)}</td><td>${P.toFixed(1)}</td><td>${Q.toFixed(2)}</td>
         <td>${Math.round(V).toLocaleString('el-GR')}</td><td>${txt}<br><span style="font-size:10px;">Peq=${Peq.toFixed(1)}</span></td>
         <td>${status(Q,CapNet)}</td><td>${status(Q,CapStr)}</td>`;
       tbody.appendChild(row);
    }
    
    // Visualizer & FIXED Manual Y logic
    const yMan = document.getElementById('strY');
    const isManual = yMan.dataset.manual === 'true';
    const finalY = isManual ? (parseFloat(yMan.value)||0) : yCalc;
    
    // Only overwrite if not manual and not currently focused
    if(!isManual && document.activeElement !== yMan) {
       yMan.value = yCalc > 0 ? yCalc.toFixed(2) : "";
    }

    drawChannel(finalY);
    drawBasinPlan();
    updateBasinBadges();
    
    if(CURRENT_BASIN_ID) LSHelper.set(KEYS.BASIN_PFX+CURRENT_BASIN_ID, inputs);
    LSHelper.set(KEYS.GLOBAL, {rainI:inputs.rainI, rainD:inputs.rainD, lastBasinId:CURRENT_BASIN_ID});
  }

  function openPrintView() { window.print(); }

  // --- Station monitor (12-sample window, timestamp-based) ---
  const STATION_SERIES_MAX = 12;
  // Samples: {key, tsText, val, label, today, storm, total, totalSrc, dp, dateMs}
  let stationSeries = [];
  let stationLastKey = null;
  let stationLiveOn = false;
  let stationLiveTimer = null;

  function _num(x){
    if(x==null) return null;
    if(typeof x === 'number') return isFiniteNumber(x) ? x : null;
    const s = String(x).trim().replace(',', '.').replace(/[^\d.\-]/g,'');
    const n = parseFloat(s);
    return isFiniteNumber(n) ? n : null;
  }

  function extractStationTimestamp(obj) {
    if(!obj || typeof obj !== 'object') return null;
    const keys = ['station_ts','stationTimestamp','station_time','stationTime','station_datetime','stationDatetime','dateTime','datetime','dt','ts','timestamp','time','lastUpdate','last_update','latest_values_ts','latestValuesTs'];
    for(const k of keys) {
      if(obj[k]) return String(obj[k]).trim();
    }
    return null;
  }

  function extractNumber(obj, keys){
    if(!obj || typeof obj !== 'object') return null;
    for(const k of keys){
      if(obj[k]==null) continue;
      const n = _num(obj[k]);
      if(n!=null) return n;
    }
    return null;
  }

  const ST_KEYS_TODAY = ['rainToday_mm','rain_today_mm','rainDay_mm','rain_day_mm','todayRain_mm','todayRain','rain_today','todays_rain','todaysRain','rain_today_total'];
  const ST_KEYS_STORM = ['stormTotal_mm','storm_total_mm','stormTotal','storm_total','rainStorm_mm','rainStorm','rainTotal_mm','rain_total_mm','rainTotal','totalRain','total_rain'];

  function extractStationTotals(obj){
    const today = extractNumber(obj, ST_KEYS_TODAY);
    const storm = extractNumber(obj, ST_KEYS_STORM);
    let total = null;
    let totalSrc = null;
    if(storm!=null) { total = storm; totalSrc = 'storm'; }
    else if(today!=null) { total = today; totalSrc = 'today'; }
    return { today, storm, total, totalSrc };
  }

  function parseStationTsToDate(ts) {
    if(!ts) return null;
    const s = String(ts).trim();
    // Accept: dd/mm/yyyy HH:MM (optionally with seconds)
    const m = s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?/);
    if(!m) return null;
    const dd = Number(m[1]), mm = Number(m[2]), yyyy = Number(m[3]);
    const HH = Number(m[4]), MN = Number(m[5]), SS = m[6]!=null ? Number(m[6]) : 0;
    if(!dd||!mm||!yyyy||HH<0||HH>23||MN<0||MN>59||SS<0||SS>59) return null;
    return new Date(yyyy, mm-1, dd, HH, MN, SS, 0);
  }

  function fmt(x, dec=1){
    const n = _num(x);
    return (n==null) ? 'â€”' : n.toFixed(dec);
  }

  function setTxt(id, val){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = val;
  }

  function updateStationAge(tsText) {
    const el = document.getElementById('stationAge');
    if(!el) return;
    const d = parseStationTsToDate(tsText);
    if(!d) { el.textContent = ''; return; }
    const diffMs = Date.now() - d.getTime();
    const diffMin = Math.round(diffMs / 60000);
    if(!isFinite(diffMin)) { el.textContent=''; return; }
    el.textContent = diffMin >= 0 ? `(Î·Î»Î¹ÎºÎ¯Î± ~${diffMin}â€²)` : '';
    // subtle warning if stale
    el.style.color = (diffMin >= 20) ? '#b03a2e' : '#566573';
  }

  function computeR60(){
    if(!stationSeries.length) return null;
    const last = stationSeries[stationSeries.length-1];
    const refMs = (last && last.dateMs) ? last.dateMs : Date.now();
    const cutoff = refMs - 60*60000;
    let sum = 0;
    let any = false;
    for(const s of stationSeries){
      const t = s.dateMs || 0;
      if(t >= cutoff && s.dp!=null && isFiniteNumber(s.dp)){
        sum += s.dp; any = true;
      }
    }
    return any ? sum : 0;
  }

  function updateStationReadouts(r60Override=null){
    const latest = stationSeries.length ? stationSeries[stationSeries.length-1] : null;
    const r60 = (r60Override!=null) ? r60Override : computeR60();

    if(latest){
      setTxt('stationRainRate', fmt(latest.val, 1));
      setTxt('stationDeltaP', (latest.dp==null) ? 'â€”' : fmt(latest.dp, 1));
      setTxt('stationR60', (r60==null) ? 'â€”' : fmt(r60, 1));
      setTxt('stationToday', (latest.today==null) ? 'â€”' : fmt(latest.today, 1));
      setTxt('stationStorm', (latest.storm==null) ? 'â€”' : fmt(latest.storm, 1));

      const srcEl = document.getElementById('stationTotalSrc');
      if(srcEl){
        if(latest.totalSrc === 'storm') srcEl.textContent = '(Î”P Î±Ï€ÏŒ Storm Total)';
        else if(latest.totalSrc === 'today') srcEl.textContent = '(Î”P Î±Ï€ÏŒ Î£Î®Î¼ÎµÏÎ±)';
        else srcEl.textContent = '';
      }
    } else {
      setTxt('stationRainRate', 'â€”');
      setTxt('stationDeltaP', 'â€”');
      setTxt('stationR60', 'â€”');
      setTxt('stationToday', 'â€”');
      setTxt('stationStorm', 'â€”');
      const srcEl = document.getElementById('stationTotalSrc');
      if(srcEl) srcEl.textContent = '';
    }

    const meta = document.getElementById('stationSeriesMeta');
    if(meta){
      const n = stationSeries.length;
      const r60Txt = (r60==null) ? '' : ` â€¢ R60â€²: ${fmt(r60, 1)} mm`;
      meta.textContent = `Î”ÎµÎ¯Î³Î¼Î±Ï„Î±: ${n}/${STATION_SERIES_MAX}${r60Txt}`;
    }
  }

  function renderStationSquares() {
    const wrap = document.getElementById('stationSquares');
    if(!wrap) return;
    const sqs = Array.from(wrap.querySelectorAll('.station-sq'));
    for(let i=0;i<sqs.length;i++) {
      const sq = sqs[i];
      const item = stationSeries[i];
      if(item) {
        sq.classList.add('filled');
        sq.classList.remove('empty');
        const parts = [
          `${item.tsText}`,
          `i=${fmt(item.val,1)} mm/h`,
          (item.dp!=null ? `Î”P=${fmt(item.dp,1)} mm` : null),
          (item.total!=null ? `Î£=${fmt(item.total,1)} mm` : null),
          (item.label ? `(${item.label})` : null)
        ].filter(Boolean);
        sq.title = parts.join(' â€” ');
      } else {
        sq.classList.remove('filled');
        sq.classList.add('empty');
        sq.title = String(i+1);
      }
    }
    updateStationReadouts();
  }

  function clearStationSeries() {
    stationSeries = [];
    stationLastKey = null;
    const ts = document.getElementById('stationTimestamp');
    if(ts) ts.textContent = 'â€”';
    updateStationAge(null);
    renderStationSquares();
  }

  function setLiveBtn() {
    const b = document.getElementById('stationLiveBtn');
    if(!b) return;
    b.dataset.on = stationLiveOn ? '1' : '0';
    b.textContent = stationLiveOn ? 'Live âœ“' : 'Live';
  }

  function toggleStationLive() {
    stationLiveOn = !stationLiveOn;
    setLiveBtn();
    if(stationLiveOn) {
      if(stationLiveTimer) clearInterval(stationLiveTimer);
      // check every 1 minute; save sample only when station timestamp changes
      stationLiveTimer = setInterval(() => { try { loadFromStation({silent:true}); } catch(e){} }, 60000);
      // immediate tick
      try { loadFromStation({silent:true}); } catch(e){}
    } else {
      if(stationLiveTimer) { clearInterval(stationLiveTimer); stationLiveTimer = null; }
    }
  }

  function updateStationMonitorDisplay(tsText) {
    const el = document.getElementById('stationTimestamp');
    if(el) el.textContent = tsText || 'â€”';
    const ageRef = (tsText && tsText.includes('â€“')) ? tsText.split('â€“').pop().trim() : tsText;
    updateStationAge(ageRef);
  }

  // Update UI instantly (even if timestamp hasn't changed)
  function updateStationInstant(rainRate, totals){
    const latest = stationSeries.length ? stationSeries[stationSeries.length-1] : null;
    if(rainRate!=null){
      setTxt('stationRainRate', fmt(rainRate, 1));
    } else if(latest) {
      setTxt('stationRainRate', fmt(latest.val, 1));
    }

    if(totals){
      if(totals.today!=null) setTxt('stationToday', fmt(totals.today, 1));
      if(totals.storm!=null) setTxt('stationStorm', fmt(totals.storm, 1));
      const srcEl = document.getElementById('stationTotalSrc');
      if(srcEl){
        if(totals.totalSrc === 'storm') srcEl.textContent = '(Î”P Î±Ï€ÏŒ Storm Total)';
        else if(totals.totalSrc === 'today') srcEl.textContent = '(Î”P Î±Ï€ÏŒ Î£Î®Î¼ÎµÏÎ±)';
        else srcEl.textContent = '';
      }
    } else if(!latest) {
      const srcEl = document.getElementById('stationTotalSrc');
      if(srcEl) srcEl.textContent = '';
    }

    // Keep dp/r60 consistent with current series
    updateStationReadouts();
  }

  function onNewStationSample(sampleKey, tsText, val, label, totals) {
    if(!sampleKey) return;
    if(sampleKey === stationLastKey) return; // no new station timestamp
    stationLastKey = sampleKey;

    const tinfo = totals || { today:null, storm:null, total:null, totalSrc:null };
    const prev = stationSeries.length ? stationSeries[stationSeries.length-1] : null;

    let dp = null;
    if(tinfo.total!=null && prev && prev.total!=null && prev.totalSrc && (prev.totalSrc === tinfo.totalSrc)) {
      dp = tinfo.total - prev.total;
      if(dp < 0) dp = tinfo.total; // reset or new event
    }

    const d = parseStationTsToDate(tsText) || new Date();
    stationSeries.push({
      key: sampleKey,
      tsText: tsText || sampleKey,
      val,
      label,
      today: tinfo.today,
      storm: tinfo.storm,
      total: tinfo.total,
      totalSrc: tinfo.totalSrc,
      dp,
      dateMs: d.getTime()
    });

    if(stationSeries.length > STATION_SERIES_MAX) stationSeries = stationSeries.slice(-STATION_SERIES_MAX);
    renderStationSquares();
  }

  // --- Station monitor end ---

  function loadFromStation(opts={}) {
    const silent = !!opts.silent;
    const ids = getSelectedMeteoStationIds();
    const stations = getAllMeteoStations();
    const chosen = ids.map(id => stations.find(s => s.id === id)).filter(Boolean);
    if(!chosen.length) { setMeteoMsg("Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚."); return; }

    const agg = getMeteoAgg();
    const aggLabel = agg.toUpperCase();
    const aggFn = (arr) => {
      if(!arr.length) return null;
      if(agg === "avg") return arr.reduce((a,b)=>a+b,0) / arr.length;
      if(agg === "min") return Math.min(...arr);
      return Math.max(...arr); // max
    };
    const toNum = (x) => {
      if(x==null) return null;
      if(typeof x === 'number') return isFiniteNumber(x) ? x : null;
      const s = String(x).trim().replace(',', '.').replace(/[^\d.\-]/g,'');
      const n = parseFloat(s);
      return isFiniteNumber(n) ? n : null;
    };

    // Google Apps Script Web App (optional)
    if(typeof google !== 'undefined' && google.script && google.script.run) {
      try {
        // Single station (backwards compatible)
        if(chosen.length === 1) {
          const st = chosen[0];
          if(!silent) setMeteoMsg("Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦ (" + st.name + ")");

          if(google.script.run.getMeteoLatest) {
            google.script.run.withSuccessHandler(d => {
              const v = d && d.rainRate_mmh!=null ? toNum(d.rainRate_mmh) : null;
              if(v!=null) {
                setInputValue('rainI', v);
                setMeteoMsg(`Î›Î®ÏˆÎ· OK (${st.name}): ${v.toFixed(1)} mm/h`);
                const tsText = extractStationTimestamp(d);
                updateStationMonitorDisplay(tsText);
                const totals = extractStationTotals(d);
                updateStationInstant(v, totals);
                if(tsText) onNewStationSample(tsText, tsText, v, st.name, totals);
                else if(!silent) setMeteoMsg(`Î›Î®ÏˆÎ· OK (${st.name}) Î±Î»Î»Î¬ Ï‡Ï‰ÏÎ¯Ï‚ timestamp (Î´ÎµÎ½ Ï‡Ï„Î¯Î¶ÎµÏ„Î±Î¹ Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬).`);

                runMasterCalculation();
              } else {
                setMeteoMsg(`Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (${st.name}).`);
              }
            }).withFailureHandler(() => setMeteoMsg("Î£Ï†Î¬Î»Î¼Î± Î»Î®ÏˆÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.")).getMeteoLatest(st);
            return;
          }

          if(st.id === "chalandri" && google.script.run.getChalandriLatest) {
            google.script.run.withSuccessHandler(d => {
              const v = d && d.rainRate_mmh!=null ? toNum(d.rainRate_mmh) : null;
              if(v!=null) {
                setInputValue('rainI', v);
                setMeteoMsg(`Î›Î®ÏˆÎ· OK (${st.name}): ${v.toFixed(1)} mm/h`);
                const tsText = extractStationTimestamp(d);
                updateStationMonitorDisplay(tsText);
                const totals = extractStationTotals(d);
                updateStationInstant(v, totals);
                if(tsText) onNewStationSample(tsText, tsText, v, st.name, totals);
                else if(!silent) setMeteoMsg(`Î›Î®ÏˆÎ· OK (${st.name}) Î±Î»Î»Î¬ Ï‡Ï‰ÏÎ¯Ï‚ timestamp (Î´ÎµÎ½ Ï‡Ï„Î¯Î¶ÎµÏ„Î±Î¹ Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬).`);

                runMasterCalculation();
              } else {
                setMeteoMsg(`Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (${st.name}).`);
              }
            }).withFailureHandler(() => setMeteoMsg("Î£Ï†Î¬Î»Î¼Î± Î»Î®ÏˆÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.")).getChalandriLatest();
            return;
          }

          setMeteoMsg("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Web App Î³Î¹Î± Ï„Î¿Î½ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒ.");
          return;
        }

        // Multi station mode
        if(!google.script.run.getMeteoLatest) {
          setMeteoMsg("Î¤Î¿ Web App Î´ÎµÎ½ Î´Î¹Î±Î¸Î­Ï„ÎµÎ¹ getMeteoLatest Î³Î¹Î± Ï€Î¿Î»Î»Î±Ï€Î»Î¿ÏÏ‚ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚.");
          return;
        }

        setMeteoMsg(`Î¦ÏŒÏÏ„Ï‰ÏƒÎ·â€¦ (${chosen.length} ÏƒÏ„Î±Î¸Î¼Î¿Î¯, ${aggLabel})`);

        const runPromise = (st) => new Promise((resolve, reject) => {
          const runner = google.script.run.withSuccessHandler(resolve).withFailureHandler(reject);
          runner.getMeteoLatest(st);
        });

        Promise.allSettled(chosen.map(runPromise)).then(res => {
          const vals = [];
          let okCount = 0;

          res.forEach((r) => {
            if(r.status === "fulfilled") {
              const v = r.value && r.value.rainRate_mmh!=null ? toNum(r.value.rainRate_mmh) : null;
              if(v!=null) { vals.push(v); okCount++; }
            }
          });

          if(!vals.length) { setMeteoMsg("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ„Î¿Ï…Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï…Ï‚ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚."); return; }

          const out = aggFn(vals);
          if(out==null) { setMeteoMsg("Î‘Î´Ï…Î½Î±Î¼Î¯Î± Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï."); return; }

          setInputValue('rainI', out);
          setMeteoMsg(`Î›Î®ÏˆÎ· OK: ${aggLabel}=${out.toFixed(1)} mm/h (${okCount}/${chosen.length})`);
          // station timestamps (if provided by Web App)
          try {
            const tsList = res.map(r => r.status==='fulfilled' ? extractStationTimestamp(r.value) : null).filter(Boolean);
            const parsed = tsList.map(t => ({t, d: parseStationTsToDate(t)})).filter(x => x.d);
            parsed.sort((a,b)=>a.d-b.d);
            let displayTs = null;
            let sampleKey = null;
            if(parsed.length) {
              const minT = parsed[0].t;
              const maxT = parsed[parsed.length-1].t;
              displayTs = (minT===maxT) ? maxT : `${minT} â€“ ${maxT}`;
              sampleKey = maxT; // use latest as change detector
            } else if(tsList.length) {
              displayTs = tsList[0];
              sampleKey = tsList[0];
            }
            updateStationMonitorDisplay(displayTs);
            updateStationInstant(out, null);
            if(sampleKey) onNewStationSample(sampleKey, displayTs || sampleKey, out, `${aggLabel}/${okCount}`, null);
            else if(!silent) setMeteoMsg(`Î›Î®ÏˆÎ· OK Î±Î»Î»Î¬ Ï‡Ï‰ÏÎ¯Ï‚ timestamp (Î´ÎµÎ½ Ï‡Ï„Î¯Î¶ÎµÏ„Î±Î¹ Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬).`);
          } catch(e) {}

          runMasterCalculation();
        }).catch(() => setMeteoMsg("Î£Ï†Î¬Î»Î¼Î± Î»Î®ÏˆÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½."));
        return;

      } catch(e) {
        setMeteoMsg("Î£Ï†Î¬Î»Î¼Î±: " + (e && e.message ? e.message : "â€”"));
        return;
      }
    }

    // Offline fallback (demo)
    const vals = chosen.map(() => Math.floor(Math.random()*80) + 10);
    const out = aggFn(vals);
    setInputValue('rainI', out || 0);
    setMeteoMsg(`Offline (Test): ${aggLabel}=${(out||0).toFixed(1)} mm/h (${chosen.length} ÏƒÏ„Î±Î¸Î¼Î¿Î¯)`);
    runMasterCalculation();
  }


  // --- INIT ---
  (async function(){
    await initGeojsonStorage();
        await bootstrapGeoFromRepo();
initMeteoPanel();
    renderBasinTable(); updateAutoSaveBtn();
    
    const ctrls = document.querySelectorAll('.control-panel input, .control-panel select');
    ctrls.forEach(c => { c.addEventListener('input', runMasterCalculation); c.addEventListener('change', runMasterCalculation); });
    
    const g = LSHelper.get(KEYS.GLOBAL, {});
    setInputValue('rainI', g.rainI||0); setInputValue('rainD', g.rainD||0);
    if(g.lastBasinId && BASINS.some(b=>b.id===g.lastBasinId)) loadBasin(BASINS.findIndex(b=>b.id===g.lastBasinId));
    else if(BASINS.length) loadBasin(0);

    const hint = (id, txt) => {
        const el = document.getElementById(id), w = el?.closest('.zero-hint-wrap');
        if(!w) return;
        w.querySelector('.zero-hint').textContent = txt;
        const upd = () => w.classList.toggle('show-hint', (Number(el.value)||0)===0 && document.activeElement!==el);
        ['input','change','focus','blur'].forEach(e => el.addEventListener(e, upd)); upd();
    };
    hint('strDrop','0 = H'); hint('strLen','0 = L');
  })();
</script>

</div></body></html>
