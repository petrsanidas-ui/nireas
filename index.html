<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Î”ÎµÎ¯ÎºÏ„ÎµÏ‚ Î‘Ï€ÏŒÎºÏÎ¹ÏƒÎ·Ï‚ Î¤Î¿Ï€Î¹ÎºÏÎ½ Î›ÎµÎºÎ±Î½ÏÎ½ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚ (P_eq Screening Tool)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- GENERAL & LAYOUT --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #eef2f3; padding: 20px; text-align: center; color: #333; }

    .container {
      width: 100%; max-width: 210mm; margin: 0 auto; background: white; padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-height: 297mm; border-top: 5px solid #2c3e50;
    }
    h1 { margin-top: 0; color: #2c3e50; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    h3 { margin: 0 0 10px 0; font-size: 12px; color: #444; text-transform: uppercase; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; font-weight: bold; }

    /* --- PANELS --- */
    .control-panel { display: flex; gap: 10px; margin-bottom: 10px; text-align: left; flex-wrap: nowrap; align-items: stretch; }
    .panel { flex: 1; padding: 6px; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; }
    .panel-geo { background: #e8f8f5; border: 1px solid #a2d9ce; }
    .panel-net { background: #ebf5fb; border: 1px solid #aed6f1; }
    .panel-stream { background: #f4ecf7; border: 1px solid #d2b4de; }

    /* --- FORMS --- */
    .form-group { display: flex; align-items: center; margin-bottom: 6px; gap: 4px; width: 100%; }
    .form-group label { font-size: 11px; font-weight: 600; flex: 0 0 145px; text-align: left; cursor: help; line-height: 1.1; }
    .form-group input, .form-group select {
      flex: 1; min-width: 0; height: 30px; padding: 0 2px; text-align: center;
      border: 1px solid #ccc; border-radius: 4px; font-weight: bold; background: #fff; font-size: 12px; width: 100%;
    }
    .form-group select { font-size: 11px; text-align: left; padding-left: 4px; }

    .rain-input-group { background: #fff3cd; padding: 5px; border-radius: 3px; border: 1px solid #ffeeba; }
    .rain-input-group input { border: 2px solid #f1c40f; }

    /* --- TEXT & REFS --- */
    .ref-list { font-size: 9px; color: #444; margin-top: auto; background: rgba(255,255,255,0.7); padding: 5px; border-radius: 4px; border: 1px dashed #7f8c8d; line-height: 1.35; }
    .ref-list b { color: #2c3e50; text-decoration: underline; display:block; margin-bottom:2px;}
    .footer { margin-top: 20px; font-size: 9px; color: #7f8c8d; text-align: left; border-top: 1px solid #eee; padding-top: 10px; line-height: 1.45; }

    /* --- BUTTONS --- */
    button.main-action { width: 100%; padding: 10px; background: #c0392b; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
    button.main-action:hover { background: #a93226; }

    /* Consolidated Mini Buttons */
    .mini-btn-base {
      padding: 4px 2px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 10px; font-weight: bold; color: #fff;
    }
    .mini-go-btn { @extend .mini-btn-base; background: #2c3e50; flex: 1; } 
    .mini-go-btn, .mini-btn { background: #2c3e50; color: #fff; }
    .mini-go-btn:hover, .mini-btn:hover { background: #34495e; }
    
    .mini-del-btn { background: #7b241c; flex: 0 0 auto; width: 30px; }
    .mini-del-btn:hover { background: #922b21; }
    
    .mini-btn { width: auto !important; padding: 4px 8px !important; border: 1px solid #ccd1d1 !important; margin-left: auto; }

    /* Applying base styles to classes manually for standard CSS support */
    .mini-go-btn, .mini-del-btn, .mini-btn {
      padding: 4px 2px; border-radius: 4px; border: none; cursor: pointer;
      font-size: 10px; font-weight: bold; color: #fff;
    }
    .mini-go-btn { flex: 1; }

    /* --- TABLES & SUMMARY --- */
    .summary-box { background: #fff; border: 2px dashed #bdc3c7; padding: 10px; margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: space-around; font-size: 11px; font-weight: bold; }
    .stat-item { text-align: center; min-width: 130px; }
    .stat-item span { display: block; font-size: 14px; color: #2c3e50; margin-top: 3px; }

    table { width: 100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
    th { background: #34495e; color: white; padding: 6px 2px; border: 1px solid #34495e; position: sticky; top: 0; word-wrap: break-word; }
    td { border: 1px solid #ddd; padding: 4px 2px; text-align: center; word-wrap: break-word; }

    /* --- COLORS & STATUS --- */
    .risk-safe { background-color: #d4edda; color: #155724; }
    .risk-warn { background-color: #fff3cd; color: #856404; }
    .risk-orange { background-color: #ffe5d0; color: #d35400; font-weight: bold; }
    .risk-red { background-color: #f5c6cb; color: #721c24; font-weight: bold; }
    .risk-extreme { background-color: #922b21; color: #fff; font-weight: bold; }

    .status-ok { color: #27ae60; font-weight: bold; }
    .status-warn { color: #d35400; font-weight: bold; }
    .status-fail { color: #c0392b; font-weight: bold; }
    tr.risk-extreme .status-fail, tr.risk-extreme .status-warn, tr.risk-extreme .status-ok { color: #fff !important; }

    /* --- SIDE PANEL (BASINS) --- */
    #basinPanel {
      position: fixed; top: 10px; left: 10px; z-index: 10000;
      width: 380px; max-height: calc(100vh - 20px); overflow-y: auto;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1; border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18); text-align: left; color: #2c3e50;
    }
    #basinPanel .bp-head { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eef2f3; font-weight: bold; font-size: 13px; }
    #basinPanel .bp-body { padding: 0; font-size: 12px; max-height: calc(100vh - 70px); overflow-y: auto; overflow-x: hidden; }
    #basinPanel .bp-actions { display:flex; gap:8px; align-items:center; }
    
    #exportHtmlBtn, #autoSaveBtn { width:auto; padding:4px 10px; font-size:11px; font-weight:800; border-radius:6px; cursor:pointer; }
    #exportHtmlBtn { background:#2c3e50; color:#fff; border:1px solid #2c3e50; }
    #exportHtmlBtn:hover { background:#34495e; }
    
    #autoSaveBtn { background:#ecf0f1; color:#2c3e50; border:1px solid #ccd1d1; }
    #autoSaveBtn:hover { background:#f8f9f9; }
    #autoSaveBtn[data-mode="on"] { background:#d5f5e3; border-color:#82e0aa; }
    #autoSaveBtn[data-mode="off"] { opacity:0.75; }

    #basinToggleBtn { width:auto; padding:4px 10px; font-size:14px; font-weight:900; background:#f7f9f9; color:#2c3e50; border:1px solid #ccc; border-radius:6px; cursor:pointer; }

    #basinPanel table { table-layout: auto; }
    #basinPanel th, #basinPanel td { overflow: visible; vertical-align: middle; }
    
    /* Badges */
    .qbadge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-weight: 700; font-size: 11px; text-align: center; min-width: 60px; border: 1px solid transparent; }
    .qb-gray { background: #f2f3f4; color: #7f8c8d; border-color: #d5d8dc; }
    .qb-green { background: #e9f7ef; color: #1e8449; border-color: #abebc6; }
    .qb-yellow { background: #fef9e7; color: #9a7d0a; border-color: #f9e79f; }
    .qb-orange { background: #fbeee6; color: #d35400; border-color: #edbb99; }
    .qb-red { background: #fdedec; color: #c0392b; border-color: #fadbd8; }
    .qb-extreme { background: #922b21; color: #fff; border-color: #7b241c; }

    /* --- LEGEND --- */
    .footer-grid { display: flex; gap: 14px; align-items: flex-start; }
    .footer-left { flex: 1; }
    #severityLegend { width: 290px; flex: 0 0 290px; background: #fbfcfc; border: 1px solid #ccd1d1; border-radius: 6px; overflow: hidden; }
    #severityLegend .legend-title { background: #f2f3f4; border-bottom: 1px solid #e5e7e9; padding: 6px 8px; font-weight: 900; font-size: 10px; text-align: center; }
    #severityLegend td.key { width: 92px; white-space: nowrap; font-weight: 900; background: #f8f9f9; }

    /* --- VISUALIZER --- */
    .visualizer-box { margin: 8px 0; background: #fff; border: 1px solid #d2b4de; border-radius: 4px; text-align: center; padding: 5px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }

    /* --- PRINT & MAP --- */
    #printFrame {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      border: 2px solid red; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); 
      z-index: 10000; pointer-events: none; transition: width 0.3s, height 0.3s; display: none;
    }
    #printFrame::after { content: "Î ÎµÏÎ¹Î¿Ï‡Î® Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·Ï‚"; position: absolute; top: -20px; left: 0; color: white; background: red; font-size: 10px; padding: 2px 5px; font-weight: bold; }

    /* Responsive */
    :root{ --bp-w: 380px; --bp-gap: 30px; }
    @media (min-width: 1250px){
      body{ padding-left: calc(20px + var(--bp-w) + var(--bp-gap)); }
      .container{ margin-left: auto; margin-right: auto; }
    }
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; margin: 0; width: 100%; border: none; padding: 0; }
      .no-print { display: none !important; }
      body.print-map-mode #mapModal.no-print { display: block !important; position: fixed !important; inset: 0 !important; border: none !important; border-radius: 0 !important; box-shadow: none !important; background: #fff !important; }
      body.print-map-mode #mapModalHeader { display: none !important; }
      body.print-map-mode #mapBox { height: 100vh !important; }
      body.print-map-mode .container, body.print-map-mode #basinPanel { display: none !important; }
    }
    @media (max-width: 1100px) {
      .container { width: 100%; min-height: auto; }
      .control-panel { flex-wrap: wrap; }
      .panel { min-width: 100%; }
      #basinPanel { width: 95vw; left: 2.5vw; }
      .footer-grid { flex-wrap: wrap; }
      #severityLegend { width: 100%; flex: 1 1 100%; }
      .form-group label { flex: 0 0 140px; }
    }

    /* Map Modal */
    #mapModal {
      position: fixed; inset: 10px; z-index: 20000; display: none;
      background: rgba(255,255,255,0.98); border: 1px solid #ccd1d1;
      border-radius: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.25); overflow: hidden; text-align: left;
    }
    #mapModalHeader {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-bottom: 1px solid #eef2f3; background: #f8f9f9;
      font-weight: 800; font-size: 12px; color: #2c3e50;
    }
    #mapBox { width: 100%; height: calc(100% - 42px); position: relative; }
    #mapCloseBtn, #mapPrintBtn { width: auto; padding: 4px 10px; font-size: 11px; background: #2c3e50; border-radius: 6px; color: #fff; border: none; cursor: pointer; }
    #mapHeaderActions { display:flex; gap:8px; align-items:center; }
    
    /* Hints */
    .zero-hint-wrap { position: relative; flex: 1; min-width: 0; }
    .zero-hint-wrap .zero-hint {
      position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
      text-align: center; color: #666; font-weight: normal; font-size: 12px;
      pointer-events: none; display: none; z-index: 2;
    }
    .zero-hint-wrap.show-hint .zero-hint { display: block; }
    .zero-hint-wrap input { position: relative; z-index: 1; }
    .zero-hint-wrap.show-hint input { color: transparent; -webkit-text-fill-color: transparent; }
  </style>
</head>

<body>

<div id="basinPanel" class="no-print">
  <div class="bp-head">
    <span>Î¤Î±Ï‡ÎµÎ¯Î± Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·<br>P<sub>eq</sub> = PÂ·C (mm)</span>
    <div class="bp-actions">
      <button id="exportHtmlBtn" type="button" onclick="exportHtmlWithEmbeddedGeoJSON()">Export HTML</button>
      <button id="autoSaveBtn" type="button" onclick="toggleAutoSaveMode()" title="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·" data-mode="on">AutoSave: ON</button>
      <button id="basinToggleBtn" type="button" onclick="toggleBasinPanel()">â€“</button>
    </div>
  </div>
  <div id="basinPanelBody" class="bp-body">
    <table>
      <thead>
        <tr style="background:#f8f9f9; font-size:10px; color:#566573;">
          <th style="width:35%;">Î›ÎµÎºÎ¬Î½Î·</th>
          <th style="width:20%; text-align:center;">P<sub>eq</sub></th>
          <th style="width:45%; text-align:right;">Î•Ï€Î¹Î»Î¿Î³Î®</th>
        </tr>
      </thead>
      <tbody id="basinRows"></tbody>
    </table>
    <div style="padding:10px; font-size:11px; color:#566573; background:#fdfefe; border-top:1px solid #eee;">
      <b>ÎŸÎ´Î·Î³Î¯Î±:</b> Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ <b>ÎˆÎ½Ï„Î±ÏƒÎ· (i)</b> ÎºÎ±Î¹ <b>Î”Î¹Î¬ÏÎºÎµÎ¹Î± (D)</b> ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ Ï€Î¬Î½ÎµÎ».<br>â€¢ Î‘Î½ D=0, Ï…Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Ï„Î¿ Tc ÎºÎ¬Î¸Îµ Î»ÎµÎºÎ¬Î½Î·Ï‚ (min 5').
    </div>
  </div>
</div>

<div class="container">
  <h1 style="display:flex; justify-content:space-between; align-items:center;">
    <span>Î”ÎµÎ¯ÎºÏ„ÎµÏ‚ Î‘Ï€ÏŒÎºÏÎ¹ÏƒÎ·Ï‚ Î¤Î¿Ï€Î¹ÎºÏÎ½ Î›ÎµÎºÎ±Î½ÏÎ½ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</span>
    <button onclick="openPrintView()" class="no-print" style="background:#2c3e50; color:#fff; border:none; font-size:12px; font-weight:bold; padding:6px 14px; border-radius:4px; cursor:pointer;">Î•ÎšÎ¤Î¥Î Î©Î£Î—</button>
  </h1>
  <div style="text-align:left; font-size:11px; margin:6px 0 10px; color:#2c3e50;">
    <b>Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î›ÎµÎºÎ¬Î½Î·:</b> <span id="selectedBasin" style="font-size:14px; font-weight:bold; color:#d35400;">â€”</span>
  </div>

  <div class="control-panel">
    <div class="panel panel-geo">
      <h3>1. Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± </h3>
      <div class="form-group"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0" min="0"></div>
      <div class="form-group"><label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ¿Î®Ï‚ L (m):</label><input type="number" id="length" value="0" min="0"></div>
      <div class="form-group"><label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†Î¿ÏÎ¬ H (m):</label><input type="number" id="height" value="0" min="0"></div>
      <div class="form-group"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40" step="0.01" min="0" max="1"></div>
      
      <div class="ref-list" style="margin-top: 4px; margin-bottom: 8px;">
        <b>Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ­Ï‚ Î¤Î¹Î¼Î­Ï‚ C:</b> 1.00: Î†ÏƒÏ†Î±Î»Ï„Î¿Ï‚/ÎœÏ€ÎµÏ„ÏŒÎ½<br>0.70â€“0.90: Î Ï…ÎºÎ½Î® Î±ÏƒÏ„Î¹ÎºÎ® Î´ÏŒÎ¼Î·ÏƒÎ·<br>
        0.40â€“0.60: Î‘ÏÎ±Î¹Î® Î´ÏŒÎ¼Î·ÏƒÎ· / Ï€ÎµÏ„ÏÏÎ´ÎµÏ‚<br>0.15â€“0.35: Î¦Ï…ÏƒÎ¹ÎºÏŒ Î­Î´Î±Ï†Î¿Ï‚ / Î´Î¬ÏƒÎ¿Ï‚
      </div>
      <hr style="border:none;border-top:1px dashed rgba(0,0,0,0.15); margin:8px 0;">
      
      <h3>Î£ÎµÎ½Î¬ÏÎ¹Î¿ Î’ÏÎ¿Ï‡Î®Ï‚</h3>
      <div class="form-group rain-input-group">
        <label title="Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î·Î½ Î­Î½Ï„Î±ÏƒÎ· Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î·Î½ Î¤Î±Ï‡ÎµÎ¯Î± Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·.">âš ï¸ ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
        <input type="number" id="rainI" value="0" min="0" step="1">
      </div>
      <div class="form-group rain-input-group">
        <label title="Î‘Î½ 0, Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ Tc ÎºÎ¬Î¸Îµ Î»ÎµÎºÎ¬Î½Î·Ï‚ (Min 5 min).">âš ï¸ Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label>
        <input type="number" id="rainD" value="0" min="0" step="1">
      </div>
      <div class="form-group" style="margin-top:5px;">
        <label>Î£Ï„Î±Î¸Î¼ÏŒÏ‚ Î§Î±Î»Î±Î½Î´ÏÎ¯Î¿Ï…:</label>
        <button type="button" class="mini-btn" onclick="loadFromStation()">Auto i</button>
        <button type="button" class="mini-btn" onclick="window.open('https://penteli.meteo.gr/stations/chalandri/','_blank')">Î†Î½Î¿Î¹Î³Î¼Î±</button>
      </div>
      <div id="stationMsg" style="font-size:9px; color:#666; text-align:right;">Î— Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î»Î®ÏˆÎ· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ ÏŒÏ„Î±Î½ Ï„ÏÎ­Ï‡ÎµÎ¹ Ï‰Ï‚ <b>Apps Script Web App</b>.</div>
    </div>

    <div class="panel panel-net">
      <h3>2. Î£Ï…Î»Î»Î¿Î³Î® (Î¦ÏÎµÎ¬Ï„Î¹Î±)</h3>
      <div class="form-group"><label>Î Î»Î®Î¸Î¿Ï‚:</label><input type="number" id="drains" value="0" min="0"></div>
      <div class="form-group"><label>Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿ (mÂ³/s):</label><input type="number" id="drainCap" value="0.10" step="0.01" min="0"></div>
      <div class="ref-list">
        <b>Î•Î½Î´ÎµÎ¹ÎºÏ„Î¹ÎºÎ¬ (mÂ³/s Î±Î½Î¬ Ï†ÏÎµÎ¬Ï„Î¹Î¿):</b> 0.15â€“0.20: ÎœÎµÎ³Î¬Î»Î· ÏƒÏ‡Î¬ÏÎ±<br>0.10: Î¤Ï…Ï€Î¹ÎºÎ® ÏƒÏ‡Î¬ÏÎ± Î´ÏÏŒÎ¼Î¿Ï…<br>
        0.05: ÎœÎµÏÎ¹ÎºÏÏ‚ Ï†ÏÎ±Î³Î¼Î­Î½Î·<br>0.00: Î¦ÏÎ±Î³Î¼Î­Î½Î·
        <b>Î ÏÎ¿ÎºÎ±Ï„Î±ÏÎºÏ„Î¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ (screening):</b><br>Î•Î»Î­Î³Ï‡ÎµÎ¹ Î±Î½ Ï„Î¿ Î´Î¯ÎºÏ„Ï…Î¿ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï€Î±ÏÎ±Î»Î¬Î²ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ¿Ï‡Î® Î±Î¹Ï‡Î¼Î®Ï‚ (Inlet Control).
      </div>
    </div>

    <div class="panel panel-stream">
      <h3>3. Î”Î¹ÏŒÎ´ÎµÏ…ÏƒÎ· (Î¡Î­Î¼Î±)</h3>
      <div class="form-group"><label title="Î Î»Î¬Ï„Î¿Ï‚ Ï€Ï…Î¸Î¼Î­Î½Î±">Î Î»Î¬Ï„Î¿Ï‚ b (m) :</label><input type="number" id="strWidth" value="0" min="0" step="0.1"></div>
      <div class="form-group"><label title="z = ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± / ÎšÎ¬Î¸ÎµÏ„Î· (0 = ÎŸÏÎ¸Î¿Î³Ï‰Î½Î¹ÎºÎ®)">Î ÏÎ±Î½Î­Ï‚ z (H:V):</label><input type="number" id="strZ" value="0" min="0" step="0.1" placeholder="0 = Box"></div>
      <div class="form-group"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0" min="0" step="0.1"></div>
      <div class="form-group">
        <label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ­Î¼Î±Ï„Î¿Ï‚ (m):</label>
        <div class="zero-hint-wrap"><span class="zero-hint">0 = L</span><input type="number" id="strLen" value="0" min="0" placeholder="0 = L"></div>
      </div>
      <div class="form-group">
        <label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†. (m):</label>
        <div class="zero-hint-wrap"><span class="zero-hint">0 = H</span><input type="number" id="strDrop" value="0" min="0"></div>
      </div>
      <div class="form-group">
        <label style="flex: 0 0 100px;">n (Manning):</label>
        <select id="strType">
          <option value="0.015">ÎœÏ€ÎµÏ„ÏŒÎ½ (0.015)</option>
          <option value="0.03" selected>Î§ÏÎ¼Î± (0.030)</option>
          <option value="0.05">Î Î­Ï„ÏÎµÏ‚ (0.050)</option>
        </select>
      </div>
      <div class="form-group" style="background:#eaf2f8; padding:2px; border-radius:4px; border:1px dashed #aed6f1; margin-bottom:4px;">
        <label style="color:#2980b9; flex: 0 0 115px;">ÎÏˆÎ¿Ï‚ Î½ÎµÏÎ¿Ï y:</label>
        <button type="button" onclick="resetStrY()" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¿ Auto" 
                style="width:26px; height:26px; padding:0; border:1px solid #aed6f1; background:#fff; color:#2980b9; border-radius:4px; cursor:pointer; font-weight:bold; margin-right:4px; font-size:12px; line-height: 1;">â†º</button>
        <input type="number" id="strY" step="0.01" min="0" placeholder="Auto" 
               oninput="if(this.value===''){ delete this.dataset.manual; } else { this.dataset.manual='true'; } runMasterCalculation();"
               style="font-weight:bold; color:#2980b9;">
      </div>
      <div class="visualizer-box">
        <canvas id="channelCanvas" width="180" height="90"></canvas>
        <div style="font-size: 9px; color: #666; font-style: italic;"><b>ÎŸÏ€Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î”Î¹Î±Ï„Î¿Î¼Î®Ï‚</b></div>
      </div>
      <div class="ref-list" style="margin-top:auto;">
        <b>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</b><br>â€¢ Î‘Î½ b=0 Î® h=0: Î†Î³Î½Ï‰ÏƒÏ„Î¿ Qcap.<br>â€¢ Î”Î¹Î±Ï„Î¿Î¼Î®: Î¤ÏÎ±Ï€ÎµÎ¶Î¿ÎµÎ¹Î´Î®Ï‚ (z=0: ÎŸÏÎ¸Î¿Î³).<br>â€¢ Î‘Î½ Î¥ÏˆÎ¿Î¼. Î”Î¹Î±Ï†.=0: Î§ÏÎ®ÏƒÎ· ÎºÎ»Î¯ÏƒÎ·Ï‚ Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î±Ï‚.
      </div>
    </div>
  </div>
  <div id="summary" class="summary-box">
    <div class="stat-item" style="color:#d35400;">ÎœÎ­ÏƒÎ· ÎºÎ»Î¯ÏƒÎ·<span id="res-slope">0.0 %</span></div>
    <div class="stat-item">Tc (Kirpich)<span id="res-tc">0.0 min</span></div>
    <div class="stat-item" style="color:#16a085;">Qpeak (Rational)<span id="res-qsel">0.00 mÂ³/s</span></div>
    <div class="stat-item">kQ (mÂ³/s)/(mm/h)<span id="res-kq">0.000</span></div>
    <div class="stat-item" style="color:#2980b9;">Qcap ÏƒÏ…Î»Î»Î¿Î³Î®Ï‚<span id="res-drains">0.00 mÂ³/s</span></div>
    <div class="stat-item" style="color:#8e44ad;">Qcap Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·Ï‚<span id="res-stream">0.00 mÂ³/s</span></div>
    <div class="stat-item">kV (mÂ³/mm)<span id="res-kv">0</span></div>
    <div class="stat-item">Î•Ï€Î¬ÏÎºÎµÎ¹Î±<span id="res-adequacy"><span style="color:#7f8c8d">Î§Ï‰ÏÎ¯Ï‚ Qcap</span></span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th width="8%">i (mm/h)</th><th width="8%">D (min)</th><th width="10%">P (mm)</th><th width="12%">Qpeak (mÂ³/s)</th>
        <th width="14%">V Î±Ï€Î¿ÏÏÎ¿Î®Ï‚ (mÂ³)</th><th width="14%">Î”ÎµÎ¯ÎºÏ„Î·Ï‚ P<sub>eq</sub></th><th width="17%">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏ…Î»Î»Î¿Î³Î®Ï‚</th><th width="17%">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·Ï‚</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="footer footer-grid">
    <div class="footer-left">
      <b>ÎœÎµÎ¸Î¿Î´Î¿Î»Î¿Î³Î¯Î± Ï„Î±Ï‡ÎµÎ¯Î±Ï‚ Ï€ÏÎ¿ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·Ï‚ (screening):</b><br>
      1) <b>Tc (Kirpich):</b> Tc = 0.0195 Â· L<sup>0.77</sup> Â· S<sup>-0.385</sup> (min). <b>Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±:</b> Î§ÏÎ®ÏƒÎ· min Tc = 5 min.<br>
      2) <b>Rational (Q<sub>peak</sub>):</b> Q<sub>peak</sub> = 0.278 Â· C Â· i Â· A (i ÏƒÎµ mm/h, A ÏƒÎµ kmÂ², Q ÏƒÎµ mÂ³/s).<br>
      3) <b>P<sub>eq</sub> (Effective Rainfall Depth):</b> P<sub>eq</sub> = P Â· C (mm) â€” Â«ÎµÎ½ÎµÏÎ³ÏŒ ÏÏˆÎ¿Ï‚ Î²ÏÎ¿Ï‡Î®Ï‚Â», Î´Î·Î». Ï„Î¿ Î¼Î­ÏÎ¿Ï‚ Ï€Î¿Ï… Î³Î¯Î½ÎµÏ„Î±Î¹ Î¬Î¼ÎµÏƒÎ· Î±Ï€Î¿ÏÏÎ¿Î®.<br>
      4) <b>ÎŒÎ³ÎºÎ¿Ï‚ Î±Ï€Î¿ÏÏÎ¿Î®Ï‚:</b> V = A Â· (P/1000) Â· C (mÂ³) (A ÏƒÎµ mÂ², P ÏƒÎµ mm).<br>
    </div>
    <div id="severityLegend">
      <div class="legend-title">Î’Î±Î¸Î¼Î¯Î´Î± ÏƒÎ¿Î²Î±ÏÏŒÏ„Î·Ï„Î±Ï‚ (P<sub>eq</sub>)</div>
      <table>
        <tbody>
          <tr><td class="key" style="background:#d4edda; color:#155724;">< 10 mm</td><td><b>Î§Î±Î¼Î·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#fff3cd; color:#856404;">10 â€“ 25 mm</td><td><b>ÎœÎ­Ï„ÏÎ¹Î±</b></td></tr>
          <tr><td class="key" style="background:#ffe5d0; color:#d35400;">25 â€“ 40 mm</td><td><b>Î¥ÏˆÎ·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#f5c6cb; color:#721c24;">40 â€“ 60 mm</td><td><b>Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®</b></td></tr>
          <tr><td class="key" style="background:#922b21; color:#fff;">> 60 mm</td><td><b>Î‘ÎºÏÎ±Î¯Î±</b></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="mapModal" class="no-print">
  <div id="mapModalHeader">
    <span id="mapTitle" style="margin-right:10px;">Î§Î¬ÏÏ„Î·Ï‚</span>
    <div style="display:flex; gap:5px; align-items:center;">
      <select id="paperSize" onchange="updatePrintFrame()" style="font-size:11px; padding:2px;"><option value="a4">A4</option><option value="a3">A3</option></select>
      <select id="paperLayout" onchange="updatePrintFrame()" style="font-size:11px; padding:2px;"><option value="landscape">ÎŸÏÎ¹Î¶ÏŒÎ½Ï„Î¹Î± (Land)</option><option value="portrait">ÎšÎ¬Î¸ÎµÏ„Î± (Port)</option></select>
    </div>
    <div id="mapHeaderActions">
      <button id="mapPrintBtn" type="button" onclick="printMap()">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·</button>
      <button id="mapCloseBtn" type="button" onclick="closeMapModal()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
  <div id="mapBox"><div id="printFrame"></div></div>
</div>

<script>
  // --- HELPERS ---
  const isFiniteNumber = (x) => typeof x === "number" && isFinite(x);
  const _pf = (v) => { const n = parseFloat(String(v).replace(",", ".")); return Number.isFinite(n) ? n : undefined; };
  const getVal = (id) => parseFloat(document.getElementById(id)?.value) || 0;
  const setInputValue = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  
  // Promisified File Reader
  function readJsonFile(file, callback) {
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
      try { callback(JSON.parse(r.result)); } 
      catch (e) { alert("Invalid JSON"); }
    };
    r.readAsText(file);
  }

  // LocalStorage Helper
  const LSHelper = {
    get: (key, def = []) => { try { const t = localStorage.getItem(key); return t ? JSON.parse(t) : def; } catch { return def; } },
    set: (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} },
    del: (key) => localStorage.removeItem(key)
  };

  // --- EMBEDDED DATA PLACEHOLDERS ---
  /*__EMBEDDED_GEOJSON_START__*/ const EMBEDDED_GEOJSON_BY_BASIN = {}; /*__EMBEDDED_GEOJSON_END__*/
  /*__EMBEDDED_MUNICIPAL_START__*/ const EMBEDDED_MUNICIPAL_GEOJSON = null; /*__EMBEDDED_MUNICIPAL_END__*/
  /*__EMBEDDED_CUSTOM_BASINS_START__*/ const EMBEDDED_CUSTOM_BASINS = []; /*__EMBEDDED_CUSTOM_BASINS_END__*/
  /*__EMBEDDED_HIDDEN_BASINS_START__*/ const EMBEDDED_HIDDEN_BASINS = []; /*__EMBEDDED_HIDDEN_BASINS_END__*/

  // --- BASIN MANAGEMENT ---
  const DEFAULT_BASINS = [];
  const KEYS = { CUSTOM: "peq_custom_basins_v1", HIDDEN: "peq_hidden_basins_v1", GLOBAL: "peq_global_v1", BASIN_PFX: "peq_basin_v1_", AUTO: "peq_autosave_mode_v1" };
  let BASINS = [], CURRENT_BASIN_ID = null;

  function bootstrapHiddenBasins() {
    if (!localStorage.getItem(KEYS.HIDDEN) && EMBEDDED_HIDDEN_BASINS.length) LSHelper.set(KEYS.HIDDEN, EMBEDDED_HIDDEN_BASINS);
  }

  function rebuildBasins() {
    const hidden = new Set(LSHelper.get(KEYS.HIDDEN));
    const seen = new Set();
    const out = [];
    const process = (list) => (list || []).forEach(b => {
      if (!b || !b.id) return;
      const id = String(b.id).trim();
      if (hidden.has(id) || !id || seen.has(id)) return;
      seen.add(id);
      const v = b.values || {};
      out.push({
        id, name: String(b.name || id),
        values: {
          area: _pf(v.area ?? b.area) || 0, length: _pf(v.length ?? b.length) || 0,
          height: _pf(v.height ?? b.height) || 0, coef: _pf(v.coef ?? b.coef) || 0.6
        }
      });
    });
    process(DEFAULT_BASINS);
    process(EMBEDDED_CUSTOM_BASINS);
    process(LSHelper.get(KEYS.CUSTOM));
    BASINS = out;
  }

  bootstrapHiddenBasins();
  rebuildBasins();

  function basinLabel(b){ return (b.id ? `${b.id} â€” ${b.name}` : (b.name || "â€”")); }
  
  // --- GEOJSON STORAGE (IndexedDB) ---
  const GEOJSON_CACHE = Object.create(null);
  let MUNICIPAL_CACHE = null;
  const IDB_CFG = { NAME: "peq_geojson_db_v1", VER: 1, STORE: "kv" };
  let _idb = null, _idbReady = false, _idbQueue = [];

  function _idbOp(mode, fn) {
    if(!_idb || !_idbReady) return Promise.resolve(false);
    return new Promise(r => { const tx=_idb.transaction(IDB_CFG.STORE, mode); fn(tx.objectStore(IDB_CFG.STORE)); tx.oncomplete=()=>r(true); tx.onerror=()=>r(false); });
  }

  async function initGeojsonStorage() {
    if(!window.indexedDB) return;
    try {
      _idb = await new Promise((res, rej) => {
        const req = indexedDB.open(IDB_CFG.NAME, IDB_CFG.VER);
        req.onupgradeneeded = () => { if(!req.result.objectStoreNames.contains(IDB_CFG.STORE)) req.result.createObjectStore(IDB_CFG.STORE, { keyPath: "k" }); };
        req.onsuccess = () => res(req.result);
        req.onerror = rej;
      });
      _idbReady = true;
      const all = await new Promise(r => { const q=_idb.transaction(IDB_CFG.STORE).objectStore(IDB_CFG.STORE).getAll(); q.onsuccess=()=>r(q.result||[]); });
      all.forEach(rec => {
        if(String(rec.k).startsWith("basin:")) GEOJSON_CACHE[String(rec.k).slice(6)] = rec.v;
        else if(rec.k === "municipal") MUNICIPAL_CACHE = rec.v;
      });
      while(_idbQueue.length) _idbQueue.shift()();
    } catch(e) { console.warn("IDB Failed", e); }
  }

  function saveGeoJson(type, id, obj) {
    const key = type==="municipal" ? "municipal" : "basin:"+id;
    if(type==="basin") GEOJSON_CACHE[id] = obj; else MUNICIPAL_CACHE = obj;
    if(_idbReady) _idbOp("readwrite", s => s.put({k:key, v:obj}));
  }
  
  function getGeoJson(type, id) {
    if(type==="municipal") return MUNICIPAL_CACHE || EMBEDDED_MUNICIPAL_GEOJSON;
    return GEOJSON_CACHE[id] || EMBEDDED_GEOJSON_BY_BASIN[id] || null;
  }
  
  function delGeoJson(type, id) {
    const key = type==="municipal" ? "municipal" : "basin:"+id;
    if(type==="basin") delete GEOJSON_CACHE[id]; else MUNICIPAL_CACHE = null;
    if(_idbReady) _idbOp("readwrite", s => s.delete(key));
  }

  // --- EXPORT & AUTOSAVE ---
  function exportHtmlWithEmbeddedGeoJSON() {
    const embed = (marker, data) => {
      const src = document.documentElement.outerHTML;
      const re = new RegExp(`/\\*${marker}_START\\*/[\\s\\S]*?/\\*${marker}_END\\*/`);
      return src.replace(re, `/*${marker}_START*/\nconst ${data.var} = ${JSON.stringify(data.val)};\n/*${marker}_END*/`);
    };
    
    // Fill data
    const gjMap = {}; BASINS.forEach(b => { const g = getGeoJson('basin', b.id); if(g) gjMap[b.id] = g; });
    
    let html = document.documentElement.outerHTML; // Start fresh
    // Note: We need to do replacements sequentially on the string, not recursively calling simple function
    const replacements = [
        {m: "__EMBEDDED_GEOJSON", v: {var: "EMBEDDED_GEOJSON_BY_BASIN", val: gjMap}},
        {m: "__EMBEDDED_MUNICIPAL", v: {var: "EMBEDDED_MUNICIPAL_GEOJSON", val: getGeoJson('municipal')}},
        {m: "__EMBEDDED_CUSTOM_BASINS", v: {var: "EMBEDDED_CUSTOM_BASINS", val: BASINS.filter(b => !DEFAULT_BASINS.some(d=>d.id===b.id))}},
        {m: "__EMBEDDED_HIDDEN_BASINS", v: {var: "EMBEDDED_HIDDEN_BASINS", val: LSHelper.get(KEYS.HIDDEN)}}
    ];

    replacements.forEach(r => {
        const re = new RegExp(`/\\*${r.m}_START\\*/[\\s\\S]*?/\\*${r.m}_END\\*/`);
        html = html.replace(re, `/*${r.m}_START*/\nconst ${r.v.var} = ${JSON.stringify(r.v.val)};\n/*${r.m}_END*/`);
    });

    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `peq_export_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.html`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  function getAutoSaveMode() { return localStorage.getItem(KEYS.AUTO) || "ask"; }
  function updateAutoSaveBtn() {
    const btn = document.getElementById("autoSaveBtn"), m = getAutoSaveMode();
    if(btn) { btn.dataset.mode = m; btn.textContent = `AutoSave: ${m.toUpperCase()}`; }
  }
  function toggleAutoSaveMode() {
    const m = getAutoSaveMode(), next = (m==="off"?"ask":(m==="ask"?"on":"off"));
    localStorage.setItem(KEYS.AUTO, next); updateAutoSaveBtn();
    alert("AutoSave: " + next.toUpperCase());
  }
  function maybeAutoSave() {
    const m = getAutoSaveMode();
    if(m==="on" || (m==="ask" && confirm("Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎµÏ„Îµ ÎµÎ½Î·Î¼ÎµÏÏ‰Î¼Î­Î½Î¿ HTML (AutoSave);"))) exportHtmlWithEmbeddedGeoJSON();
  }

  // --- MAP ---
  let _map=null, _geoLayer=null, _muniLayer=null, CURRENT_MAP_BASIN_ID=null;
  const PAPER_DIMS = { a4: {w:297,h:210}, a3: {w:420,h:297} };

  function updatePrintFrame() {
    const size = document.getElementById("paperSize").value, layout = document.getElementById("paperLayout").value;
    const frame = document.getElementById("printFrame"), mapBox = document.getElementById("mapBox");
    if(!frame || !mapBox) return;
    let pw = PAPER_DIMS[size].w, ph = PAPER_DIMS[size].h;
    if(layout === "portrait") { [pw, ph] = [ph, pw]; }
    const scale = Math.min((mapBox.clientWidth-40)/pw, (mapBox.clientHeight-40)/ph);
    frame.style.width = (pw*scale)+"px"; frame.style.height = (ph*scale)+"px"; frame.style.display = "block";
    if(_map) _map.invalidateSize();
  }

  function openMapModal(basinId) {
    CURRENT_MAP_BASIN_ID = basinId;
    const isMuni = (basinId === "__MUNICIPAL__");
    const muni = getGeoJson('municipal'), gj = isMuni ? null : getGeoJson('basin', basinId);
    if(!muni && !gj) { alert("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ GeoJSON."); return; }

    document.getElementById("mapModal").style.display = "block";
    document.getElementById("mapTitle").textContent = isMuni ? "Î§Î¬ÏÏ„Î·Ï‚ â€” ÎŒÏÎ¹Î± Î”Î®Î¼Î¿Ï…" : "Î§Î¬ÏÏ„Î·Ï‚ â€” "+basinId;

    if(!_map) {
      _map = L.map("mapBox", { zoomSnap:0, zoomDelta:0.05 }).setView([37.98, 23.73], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:20 }).addTo(_map);
    }
    if(_geoLayer) _geoLayer.remove(); if(_muniLayer) _muniLayer.remove();

    const style = (f) => { const p=f.properties||{}, c=p.stroke||p.color||"#2c3e50"; return {color:c, weight:3, opacity:1, fillColor:p.fill||c, fillOpacity:0.25}; };
    if(muni) _muniLayer = L.geoJSON(muni, { style:{color:"#000",weight:4,fillOpacity:0} }).addTo(_map);
    if(gj) _geoLayer = L.geoJSON(gj, { style }).addTo(_map);

    try {
      const b = (_geoLayer || _muniLayer).getBounds();
      if(b.isValid()) _map.fitBounds(b, {padding:[20,20]});
    } catch(e){}
    setTimeout(() => { _map.invalidateSize(); updatePrintFrame(); }, 120);
  }
  function closeMapModal(){ document.getElementById("mapModal").style.display="none"; }
  
  /// --- ÎÎ•Î‘ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î‘ Î•ÎšÎ¤Î¥Î Î©Î£Î—Î£ (RESTORED FROM OLD VERSION) ---
  function printMap() {
    if (!_map) { alert("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï‡Î¬ÏÏ„Î·Ï‚."); return; }

    const size = document.getElementById("paperSize").value;
    const layout = document.getElementById("paperLayout").value;
    
    // 1. Î’ÏÎ¯ÏƒÎºÎ¿Ï…Î¼Îµ Ï„Î± ÏŒÏÎ¹Î± (Bounds) Ï„Î¿Ï… ÎºÏŒÎºÎºÎ¹Î½Î¿Ï… Ï€Î»Î±Î¹ÏƒÎ¯Î¿Ï…
    const frame = document.getElementById("printFrame");
    const rect = frame.getBoundingClientRect();
    const mapRect = document.getElementById("mapBox").getBoundingClientRect();

    // ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï„Ï‰Î½ pixels Ï„Î¿Ï… Ï€Î»Î±Î¹ÏƒÎ¯Î¿Ï… ÏƒÎµ Î³ÎµÏ‰Î³ÏÎ±Ï†Î¹ÎºÎ­Ï‚ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚
    const tl = _map.containerPointToLatLng([rect.left - mapRect.left, rect.top - mapRect.top]);
    const br = _map.containerPointToLatLng([rect.right - mapRect.left, rect.bottom - mapRect.top]);
    const printBounds = L.latLngBounds(tl, br);

    // 2. Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î ÏÎ¿ÏƒÎ±ÏÎ¼Î¿Î³Î® Î³Î¹Î± ver4: Ï‡ÏÎ®ÏƒÎ· getGeoJson)
    const titleEl = document.getElementById("mapTitle");
    const title = (titleEl && titleEl.textContent) ? titleEl.textContent : "Î§Î¬ÏÏ„Î·Ï‚";
    
    const muni = getGeoJson('municipal');
    const basinId = (typeof CURRENT_MAP_BASIN_ID !== "undefined") ? CURRENT_MAP_BASIN_ID : null;
    const basin = (basinId && basinId !== "__MUNICIPAL__") ? getGeoJson('basin', basinId) : null;

    // 3. Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î±ÏƒÏ„Î¬ÏƒÎµÏ‰Î½ (Pixels @ 96dpi)
    let pxW, pxH;
    if (size === "a4") { pxW = 1123; pxH = 794; } // A4
    else { pxW = 1587; pxH = 1123; } // A3

    if (layout === "portrait") {
      const t = pxW; pxW = pxH; pxH = t; // Swap
    }

    // 4. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÏÏ…Ï†Î¿Ï Iframe
    const iframe = document.createElement("iframe");
    iframe.style.position = "fixed"; 
    iframe.style.left = "-15000px";
    iframe.style.width = pxW + "px"; 
    iframe.style.height = pxH + "px";
    iframe.style.border = "0";
    document.body.appendChild(iframe);

    const cleanup = () => { try { iframe.remove(); } catch(e){} };
    const idoc = iframe.contentWindow.document;

    // 5. HTML Iframe Î¼Îµ CSS Î³Î¹Î± Î¼Î·Î´ÎµÎ½Î¹ÎºÎ¬ Ï€ÎµÏÎ¹Î¸ÏÏÎ¹Î±
    const cssPage = `@page { size: ${size} ${layout}; margin: 0mm; }`;
    
    idoc.open();
    idoc.write(`
      <!doctype html><html><head>
      <meta charset='utf-8'>
      <style>
        ${cssPage}
        html, body { margin: 0 !important; padding: 0 !important; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #hdr { position: absolute; top: 20px; left: 20px; z-index: 9999; background: rgba(255,255,255,0.9); padding: 8px 12px; border: 2px solid #2c3e50; border-radius: 4px; font-family: sans-serif; font-weight: bold; font-size: 18px; color: #2c3e50; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .leaflet-control-container { display: none !important; } 
      </style>
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      </head><body>
      <div id="hdr">${title}</div>
      <div id="map"></div>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
      </body></html>
    `);
    idoc.close();

    // 6. Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï‡Î¬ÏÏ„Î·
    iframe.onload = () => {
      const win = iframe.contentWindow;
      const L = win.L;
      if (!L) { alert("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Leaflet ÏƒÏ„Î¿ iframe."); cleanup(); return; }

      const map = L.map(win.document.getElementById("map"), { 
          zoomControl: false, 
          attributionControl: false,
          zoomSnap: 0,
          zoomDelta: 0.1
      });
      
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19, attribution: ""
      }).addTo(map);

      // Styles
      const muniStyle = { color:"#000", weight:4, fillOpacity:0 };
      const basinStyle = (feature) => {
          const p = (feature && feature.properties) ? feature.properties : {};
          const n = (v) => { const x=parseFloat(v); return Number.isFinite(x)?x:1; }; 
          const color = p.stroke || p.color || "#2c3e50"; // Default color updated to match ver4 style
          const weight = n(p["stroke-width"] ?? p.strokeWidth ?? 3);
          const opacity = n(p["stroke-opacity"] ?? p.strokeOpacity ?? 1);
          const fillColor = p.fill || p.fillColor || color;
          const fo = p["fill-opacity"] ?? p.fillOpacity;
          const fillOpacity = (fo===undefined||fo===null||fo==="")? 0.25 : parseFloat(fo);
          return { color, weight, opacity, fillColor, fillOpacity };
      };

      if (muni) L.geoJSON(muni, { style: muniStyle }).addTo(map);
      if (basin) L.geoJSON(basin, { style: basinStyle }).addTo(map);

      // Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¿ÏÎ¯Ï‰Î½ Î¼Îµ Î¼Î·Î´ÎµÎ½Î¹ÎºÏŒ padding Î³Î¹Î± Î±Ï€ÏŒÎ»Ï…Ï„Î· Ï„Î±ÏÏ„Î¹ÏƒÎ· Î¼Îµ Ï„Î¿ ÎºÏŒÎºÎºÎ¹Î½Î¿ Ï€Î»Î±Î¯ÏƒÎ¹Î¿
      map.fitBounds([
        [printBounds.getSouth(), printBounds.getWest()],
        [printBounds.getNorth(), printBounds.getEast()]
      ], { padding: [0, 0] });

      // Î‘Î½Î±Î¼Î¿Î½Î® Î³Î¹Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ· tiles
      setTimeout(() => {
        win.focus();
        win.print();
        setTimeout(cleanup, 5000); 
      }, 1200);
    };
  }

  // --- FILE HANDLERS ---
  function extractParams(gj) {
    const tryProps = (p) => {
      const out={}; if(!p) return out;
      ["area","length","height","coef","drains","drainCap","strWidth","strZ","strDepth","strDrop","strLen","strType"].forEach(k => {
        if(p[k]!=null) out[k]=_pf(p[k]);
        else { // regex fallback
            const m = JSON.stringify(p).match(new RegExp(`${k}\\s*[:=]\\s*([0-9]+(?:\\.[0-9]+)?)`, "i"));
            if(m) out[k]=_pf(m[1]);
        }
      });
      return out;
    };
    if(gj.type==="FeatureCollection" && gj.features.length) return tryProps(gj.features[0].properties);
    return tryProps(gj.properties || (gj.type==="Feature"?gj.properties:null));
  }

  function onGeoJsonSelected(basinId, file) {
    readJsonFile(file, (o) => {
       if(!o.type) throw 1;
       saveGeoJson('basin', basinId, o);
       const p = extractParams(o);
       if(Object.keys(p).length) {
         LSHelper.set(KEYS.BASIN_PFX+basinId, {...LSHelper.get(KEYS.BASIN_PFX+basinId), ...p});
         if(CURRENT_BASIN_ID === basinId) loadBasin(BASINS.findIndex(b=>b.id===basinId), true);
       }
       renderBasinTable(); updateBasinBadges();
    });
  }

  function onAddBasinSelected(file) {
    readJsonFile(file, (o) => {
        const id = "U"+String(Date.now()).slice(-4), name = file.name.replace(/\.[^/.]+$/, "");
        const p = extractParams(o);
        const vals = { area:p.area||0, length:p.length||0, height:p.height||0, coef:p.coef||0.6 };
        
        const list = LSHelper.get(KEYS.CUSTOM); list.push({id, name, values:vals}); LSHelper.set(KEYS.CUSTOM, list);
        saveGeoJson('basin', id, o);
        LSHelper.set(KEYS.BASIN_PFX+id, {...vals, ...p});
        
        rebuildBasins(); renderBasinTable(); loadBasin(BASINS.findIndex(b=>b.id===id));
        maybeAutoSave();
    });
  }

  function onMunicipalSelected(file) {
    readJsonFile(file, (o) => { saveGeoJson('municipal', null, o); renderBasinTable(); });
  }

  function deleteBasinById(id) {
    if(!confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® Î»ÎµÎºÎ¬Î½Î·Ï‚ "+id+";")) return;
    delGeoJson('basin', id); LSHelper.del(KEYS.BASIN_PFX+id);
    if(DEFAULT_BASINS.find(b=>b.id===id)) {
        const h = new Set(LSHelper.get(KEYS.HIDDEN)); h.add(id); LSHelper.set(KEYS.HIDDEN, Array.from(h));
    } else {
        LSHelper.set(KEYS.CUSTOM, LSHelper.get(KEYS.CUSTOM).filter(b=>b.id!==id));
    }
    rebuildBasins(); renderBasinTable(); if(CURRENT_BASIN_ID===id) loadBasin(0); maybeAutoSave();
  }

  // --- UI & CALC ---
  const DEFAULT_PROPS = { rainI: 0, rainD: 0, drains: 0, drainCap: 0, strWidth: 0, strZ: 0, strDepth: 0, strDrop: 0, strLen: 0, strType: "0.030" };
  
  function calculateTc(L, H) { return (!L || !H) ? 10 : 0.0195 * Math.pow(L, 0.77) * Math.pow((H/L), -0.385); }

  function updateBasinBadges(){
    const i = getVal('rainI'), dInput = getVal('rainD');
    BASINS.forEach(b => {
      const el = document.getElementById(`badge_${b.id}`); if(!el) return;
      if(i <= 0) { el.className = "qbadge qb-gray"; el.textContent = "â€”"; return; }
      const Tc = calculateTc(b.values.length, b.values.height), D = dInput > 0 ? dInput : Math.max(5, Tc);
      const Peq = i * (D/60) * b.values.coef;
      let cls = "qb-gray";
      if(Peq>=60) cls="qb-extreme"; else if(Peq>=40) cls="qb-red"; else if(Peq>=25) cls="qb-orange"; else if(Peq>=10) cls="qb-yellow"; else cls="qb-green";
      el.className = `qbadge ${cls}`; el.textContent = Peq.toFixed(1) + " mm";
    });
  }

  function renderBasinTable() {
    const tbody = document.getElementById("basinRows"); tbody.innerHTML = "";
    const hasMuni = !!getGeoJson('municipal');
    
    // Rows Helper
    const addRow = (html) => { const tr=document.createElement('tr'); tr.innerHTML=html; tbody.appendChild(tr); return tr; };
    const btnHtml = (lbl, clk, cls="mini-go-btn", style="") => `<button type="button" class="${cls}" onclick="${clk}" style="${style}">${lbl}</button>`;
    const fileIn = (id, chg) => `<input type="file" id="${id}" style="display:none" onchange="${chg}" accept=".json,.geojson">`;

    // Muni Row
    addRow(`<td style="font-weight:900;font-size:10px">ÎŸÎ¡Î™Î‘ Î”Î—ÎœÎŸÎ¥</td><td style="text-align:center"><span class="qbadge ${hasMuni?'qb-green':'qb-gray'}">${hasMuni?'OK':'â€”'}</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_muni','onMunicipalSelected(this.files[0])')}
      ${btnHtml('Map',"openMapModal('__MUNICIPAL__')")} ${btnHtml('JSON',"document.getElementById('f_muni').click()","mini-go-btn",hasMuni?'color:#82e0aa':'')}
      ${btnHtml('ğŸ—‘','if(confirm("Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŸÏÎ¯Ï‰Î½;")){delGeoJson("municipal",null);renderBasinTable();}','mini-del-btn')}</td>`);

    // Add Row
    addRow(`<td style="font-weight:900;font-size:10px">â• Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— Î›Î•ÎšÎ‘ÎÎ—Î£</td><td style="text-align:center"><span class="qbadge qb-gray">+</span></td>
      <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_add','onAddBasinSelected(this.files[0])')}
      ${btnHtml('JSON',"document.getElementById('f_add').click()")}
      ${btnHtml('â†º','if(confirm("Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏÏ…Î¼Î¼Î­Î½Ï‰Î½;")){LSHelper.del(KEYS.HIDDEN);rebuildBasins();renderBasinTable();}','mini-go-btn')}</td>`);

    // Basins
    BASINS.forEach((b, idx) => {
      const hasG = !!getGeoJson('basin', b.id);
      const tr = addRow(`<td style="font-size:10px">${basinLabel(b)}</td>
        <td style="text-align:center"><span id="badge_${b.id}" class="qbadge qb-gray">â€”</span></td>
        <td style="text-align:right; display:flex; gap:4px; justify-content:flex-end;">${fileIn('f_'+b.id,`onGeoJsonSelected('${b.id}',this.files[0])`)}
        ${btnHtml('Go',`event.stopPropagation();loadBasin(${idx},true)`)} ${btnHtml('Map',`event.stopPropagation();openMapModal('${b.id}')`)}
        ${btnHtml('JSON',`event.stopPropagation();document.getElementById('f_${b.id}').click()`,"mini-go-btn",hasG?'color:#82e0aa':'')}
        ${btnHtml('ğŸ—‘',`event.stopPropagation();deleteBasinById('${b.id}')`,'mini-del-btn')}</td>`);
      tr.style.cursor="pointer"; tr.onclick=()=>loadBasin(idx);
    });
  }
  function toggleBasinPanel() { const b=document.getElementById("basinPanelBody"); b.style.display=(b.style.display==="none"?"block":"none"); document.getElementById("basinToggleBtn").textContent=(b.style.display==="none"?"+":"â€“"); }

  function loadBasin(idx, force=false) {
    if(!BASINS[idx]) return;
    const b = BASINS[idx]; CURRENT_BASIN_ID = b.id;
    const saved = LSHelper.get(KEYS.BASIN_PFX+b.id, {});
    const fromGJ = getGeoJson('basin', b.id) ? extractParams(getGeoJson('basin', b.id)) : {};
    
    // Priority: Saved > GeoJSON > Default. Force: GeoJSON > Saved
    const vals = force ? { ...DEFAULT_PROPS, ...b.values, ...saved, ...fromGJ } : { ...DEFAULT_PROPS, ...b.values, ...fromGJ, ...saved };
    Object.keys(vals).forEach(k => { if(!['rainI','rainD'].includes(k)) setInputValue(k, vals[k]); });
    document.getElementById("selectedBasin").textContent = basinLabel(b);
    runMasterCalculation();
  }

  function drawChannel(y_real) {
    const canvas = document.getElementById('channelCanvas'), ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height; ctx.clearRect(0, 0, w, h);
    
    const [b, z, H, y] = [getVal('strWidth'), getVal('strZ'), getVal('strDepth'), y_real];
    if(b<=0 && H<=0) { ctx.fillStyle="#ccc"; ctx.font="10px Arial"; ctx.textAlign="center"; ctx.fillText("ÎŸÏÎ¯ÏƒÏ„Îµ b & h", w/2, h/2); return; }

    const maxH = Math.max(H, y), topW = b + 2*(z*maxH), pad=20;
    const scale = Math.min((w-pad)/(topW||1), (h-pad)/(maxH||1));
    const cx = w/2, cy = h-15, gx = (wd) => (wd*scale)/2, gy = (d) => cy - (d*scale);

    const drawPoly = (tw, d, fill, str, dash=[]) => {
        ctx.beginPath(); ctx.moveTo(cx-gx(tw), gy(d)); ctx.lineTo(cx-gx(b), cy); ctx.lineTo(cx+gx(b), cy); ctx.lineTo(cx+gx(tw), gy(d));
        if(fill){ ctx.fillStyle=fill; ctx.fill(); } if(str){ ctx.strokeStyle=str; ctx.setLineDash(dash); ctx.stroke(); ctx.setLineDash([]); }
    };

    if(H>0) {
        drawPoly(b+2*z*H, H, null, "#5D4037");
        ctx.fillStyle="#5D4037"; ctx.textAlign="left"; ctx.font="bold 10px Arial";
        ctx.fillText(`h=${H}m`, cx-gx(b+2*z*H)+8, gy(H)+10);
    }
    if(y>0) {
        const isOver = (H>0 && y>H);
        drawPoly(b+2*z*Math.min(y, H*1.5||y), Math.min(y, H*1.5||y), isOver?"rgba(231,76,60,0.6)":"rgba(52,152,219,0.6)", isOver?"#c0392b":"#2980b9", isOver?[]:[]);
        ctx.closePath(); ctx.beginPath(); ctx.moveTo(cx-gx(b+2*z*y), gy(y)); ctx.lineTo(cx+gx(b+2*z*y), gy(y)); ctx.stroke();
        ctx.fillStyle="#000"; ctx.textAlign="center"; ctx.font="bold 10px Arial"; ctx.fillText(`y=${y.toFixed(2)}m`, cx, cy-(y*scale)/2+4);
    }
    if(b>0) { ctx.fillStyle="#000"; ctx.textAlign="center"; ctx.font="bold 10px Arial"; ctx.fillText(`b=${b}m`, cx, cy+12); }
  }
  
  function resetStrY() { const el=document.getElementById('strY'); el.value=""; delete el.dataset.manual; runMasterCalculation(); }

  function runMasterCalculation() {
    // Collect Inputs
    const inputs = {};
    ['area','length','height','coef','rainI','rainD','drains','drainCap','strWidth','strZ','strDepth','strDrop','strLen','strType','strY'].forEach(k => inputs[k] = getVal(k));
    
    if(!isFiniteNumber(inputs.area)) return;
    const A_km2 = inputs.area / 1e6, S = (inputs.length>0&&inputs.height>0) ? inputs.height/inputs.length : 0.01;
    const Tc = calculateTc(inputs.length, inputs.height);
    const Dused = (inputs.rainD > 0) ? inputs.rainD : Math.max(5.0, Tc);
    
    // Results
    const Qsel = 0.278 * inputs.coef * inputs.rainI * A_km2;
    const CapNet = inputs.drains * inputs.drainCap;
    
    const sLen = inputs.strLen || inputs.length, sDrop = inputs.strDrop || inputs.height;
    const sSlope = sLen>0 ? sDrop/sLen : 0;
    
    let CapStr = 0, yCalc = 0;
    if(inputs.strWidth>0 && inputs.strDepth>0 && sSlope>0) {
       const calcQ = (d) => {
         const A = (inputs.strWidth + inputs.strZ*d)*d, P = inputs.strWidth + 2*d*Math.sqrt(1+inputs.strZ**2);
         return (1/inputs.strType) * Math.pow(A, 5/3) * Math.pow(P, -2/3) * Math.sqrt(sSlope);
       };
       CapStr = calcQ(inputs.strDepth);
       
       // Calc Normal Depth (Iterative)
       if(Qsel > 0) {
          let low=0, high=(inputs.strDepth*2)||20;
          for(let i=0;i<20;i++){ const mid=(low+high)/2; if(calcQ(mid)<Qsel) low=mid; else high=mid; }
          yCalc = (low+high)/2;
       }
    }

    // Render Stats
    const setText = (id, txt) => document.getElementById(id).innerHTML = txt;
    setText('res-slope', (S*100).toFixed(1)+" %");
    setText('res-qsel', Qsel.toFixed(2)+" mÂ³/s");
    setText('res-kq', (0.278*inputs.coef*A_km2).toFixed(3));
    setText('res-kv', Math.round(inputs.area*inputs.coef/1000).toLocaleString('el-GR'));
    setText('res-drains', CapNet.toFixed(2)+" mÂ³/s");
    setText('res-stream', CapStr.toFixed(2)+" mÂ³/s");
    
    // Tc Dual Display
    const tcEl = document.getElementById('res-tc');
    if((!inputs.rainD || inputs.rainD<=0) && Tc < 5) {
       tcEl.innerHTML = `<div title="ÎŒÏÎ¹Î¿ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ (5 min)" style="line-height:1.1;cursor:help;"><span style="color:#d35400;font-weight:bold;">5.0 min</span><div style="font-size:10px;color:#7f8c8d;">(calc: ${Tc.toFixed(2)})</div></div>`;
    } else { tcEl.innerHTML = Tc.toFixed(1) + " min"; }

    // Adequacy
    let adq = "<span style='color:#7f8c8d'>Î§Ï‰ÏÎ¯Ï‚ Qcap</span>";
    if(CapNet>0 && CapStr>0) adq = "<span class='status-ok'>Î”Î¹Ï€Î»ÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚</span>";
    else if(CapNet>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ ÏƒÏ…Î»Î»Î¿Î³Î®</span>";
    else if(CapStr>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·</span>";
    setText('res-adequacy', adq);

    // Table
    const tbody = document.getElementById('tableBody'); tbody.innerHTML="";
    const status = (Q, Cap) => Cap<=0 ? "<span class='status-fail' style='font-size:9px;'>â€”</span>" : (Q<=Cap*0.85 ? "<span class='status-ok'>OK</span>" : (Q<=Cap ? "<span class='status-warn'>ÎŸÏÎ¹Î±ÎºÏŒ</span>" : "<span class='status-fail'>Î¥Ï€Î­ÏÎ²Î±ÏƒÎ·</span>"));
    
    for(let i=5; i<=200; i+=5) {
       const P = i*(Dused/60), Q=0.278*inputs.coef*i*A_km2, V=inputs.area*(P/1000)*inputs.coef, Peq=P*inputs.coef;
       let cls="risk-safe", txt="Î§Î±Î¼Î·Î»Î®";
       if(Peq>=60){cls="risk-extreme";txt="Î‘ÎºÏÎ±Î¯Î±";} else if(Peq>=40){cls="risk-red";txt="Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®";} else if(Peq>=25){cls="risk-orange";txt="Î¥ÏˆÎ·Î»Î®";} else if(Peq>=10){cls="risk-warn";txt="ÎœÎ­Ï„ÏÎ¹Î±";}
       
       const row = document.createElement('tr'); row.className = cls;
       row.innerHTML = `<td><b>${i}</b></td><td>${Dused.toFixed(1)}</td><td>${P.toFixed(1)}</td><td>${Q.toFixed(2)}</td>
         <td>${Math.round(V).toLocaleString('el-GR')}</td><td>${txt}<br><span style="font-size:10px;">Peq=${Peq.toFixed(1)}</span></td>
         <td>${status(Q,CapNet)}</td><td>${status(Q,CapStr)}</td>`;
       tbody.appendChild(row);
    }
    
    // Visualizer & FIXED Manual Y logic
    const yMan = document.getElementById('strY');
    const isManual = yMan.dataset.manual === 'true';
    const finalY = isManual ? (parseFloat(yMan.value)||0) : yCalc;
    
    // Only overwrite if not manual and not currently focused
    if(!isManual && document.activeElement !== yMan) {
       yMan.value = yCalc > 0 ? yCalc.toFixed(2) : "";
    }

    drawChannel(finalY);
    updateBasinBadges();
    
    if(CURRENT_BASIN_ID) LSHelper.set(KEYS.BASIN_PFX+CURRENT_BASIN_ID, inputs);
    LSHelper.set(KEYS.GLOBAL, {rainI:inputs.rainI, rainD:inputs.rainD, lastBasinId:CURRENT_BASIN_ID});
  }

  function openPrintView() { window.print(); }
  
  function loadFromStation() {
    const msg = document.getElementById('stationMsg');
    if(typeof google !== 'undefined' && google.script && google.script.run) {
        msg.textContent = 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...';
        google.script.run.withSuccessHandler(d => {
            if(d && d.rainRate_mmh!=null) { setInputValue('rainI', d.rainRate_mmh); msg.textContent=`Î›Î®ÏˆÎ· OK: ${d.rainRate_mmh} mm/h`; runMasterCalculation(); }
        }).withFailureHandler(() => msg.textContent='Î£Ï†Î¬Î»Î¼Î±').getChalandriLatest();
    } else {
        const val = Math.floor(Math.random()*80)+10; setInputValue('rainI', val); msg.textContent=`Offline (Test): ${val} mm/h`; runMasterCalculation();
    }
  }

  // --- INIT ---
  (async function(){
    await initGeojsonStorage();
    renderBasinTable(); updateAutoSaveBtn();
    
    const ctrls = document.querySelectorAll('.control-panel input, .control-panel select');
    ctrls.forEach(c => { c.addEventListener('input', runMasterCalculation); c.addEventListener('change', runMasterCalculation); });
    
    const g = LSHelper.get(KEYS.GLOBAL, {});
    setInputValue('rainI', g.rainI||0); setInputValue('rainD', g.rainD||0);
    if(g.lastBasinId && BASINS.some(b=>b.id===g.lastBasinId)) loadBasin(BASINS.findIndex(b=>b.id===g.lastBasinId));
    else if(BASINS.length) loadBasin(0);

    const hint = (id, txt) => {
        const el = document.getElementById(id), w = el?.closest('.zero-hint-wrap');
        if(!w) return;
        w.querySelector('.zero-hint').textContent = txt;
        const upd = () => w.classList.toggle('show-hint', (Number(el.value)||0)===0 && document.activeElement!==el);
        ['input','change','focus','blur'].forEach(e => el.addEventListener(e, upd)); upd();
    };
    hint('strDrop','0 = H'); hint('strLen','0 = L');
  })();
</script>
</body>
</html>
