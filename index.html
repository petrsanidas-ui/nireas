
<!DOCTYPE html>

<html lang="el">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>NIREAS</title>
<link href="nireas_logo.png" rel="icon" type="image/png"/>
<!-- Leaflet -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
// Ensure collapsed cards have unified rounded headers
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.section-body.collapsed').forEach(body => {
    const card = body.closest('.panel-card');
    if(card) card.classList.add('is-collapsed');
  });
});
</script>
<style>
    :root{
      --bg:#eef2f5;
      --panel:#ffffff;
      --ink:#2c3e50;
      --muted:#6b7a86;
      --line:#d6dde4;
      --hdr:#2c3e50;

      --btn-blue:#2980b9;
      --btn-green:#27ae60;
      --btn-gray:#7f8c8d;
      --btn-yellow:#f1c40f;

      --danger:#c0392b;
      --warn:#d35400;
      --ok:#27ae60;

      --shadow:0 10px 24px rgba(0,0,0,.12);
      --radius:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --topbar-h:44px;
      --topbar-pad-x:12px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
    }

    /* ====== Layout (side-by-side, no overlap) ====== */
    .app-shell{
      display:flex;
      flex-wrap:nowrap;
      gap:14px;
      padding:14px;
      align-items:flex-start;
    }
    @media (max-width: 760px){
      .app-shell{flex-direction:column}
    }

    .side-panel{
      width:390px;
      max-width:100%;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    .main-panel{
      flex:1 1 0;
      min-width:320px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    /* ====== Panel headers & collapsibles ====== */
    .panel-topbar{
      background:var(--hdr);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 var(--topbar-pad-x);
      height:var(--topbar-h);
      box-sizing:border-box;
      font-weight:700;
      font-size:14px;
      border-bottom:1px solid rgba(255,255,255,.14);
      border-top-left-radius:var(--radius);
      border-top-right-radius:var(--radius);
}
    .icon-btn{
      border:none;
      background:rgba(255,255,255,.14);
      color:currentColor; /* inherits from parent (white on dark topbar, dark on light headers) */
      width:30px;height:26px;
      border-radius:6px;
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }
    .icon-btn:hover{background:rgba(255,255,255,.22)} 

    /* Make collapse/minimize buttons visible on light section headers */
    .section-hdr .icon-btn{
      background:rgba(44,62,80,.10);
      border:1px solid rgba(0,0,0,.10);
    }
    .section-hdr .icon-btn:hover{background:rgba(44,62,80,.16)}
    .section{
      border-top:1px solid rgba(255,255,255,.08);
    }
    .section-hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:nowrap;
      padding:10px 12px;
      border-top:1px solid var(--line);
      background:#f7f9fb;
      font-weight:800;
      color:var(--ink);
    }
    .section-hdr .hdr-left{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .section-hdr .hdr-right{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      flex:0 0 auto;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .section-body{
      padding:10px 12px;
    }
    .collapsed{display:none!important}

    /* ====== Buttons ====== */
    .mini-btn{
      border:none;
      border-radius:4px;
      padding:4px 8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      font-size:11px;
      cursor:pointer;
      color:#fff;
      font-weight:800;
      line-height:1.1;
      user-select:none;
    }
    .btn-load{background:var(--btn-blue)}
    .btn-map{background:var(--btn-green)}
    .btn-gray{background:var(--btn-gray)}
    .btn-on{background:var(--btn-green)}
    .btn-off{background:var(--btn-gray)}
    .btn-warn{background:var(--btn-yellow); color:#1f2a33}

    /* ====== Map-only action groups (side panel + GeoJSON) ====== */
    .station-row-hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin:2px 0 6px;
      min-width:0;
    }
    .station-row-label{
      font-size:11px;
      color:#6b7a86;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      flex:1 1 auto;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .station-row-body{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .map-btns{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:nowrap;
      white-space:nowrap;
      overflow:visible; /* avoid horizontal auto-scroll jump on click */
    }

    /* prevent tiny layout shifts when labels toggle (Off/On) */
    .map-btns .mini-btn{flex:0 0 auto; justify-content:center;}
    .map-btns .mini-btn.btn-map.map-only-btn{min-width:76px;}
    .map-btns .mini-btn.btn-off.map-only-btn,
    .map-btns .mini-btn.btn-on.map-only-btn{min-width:72px;}

    .map-only-btn{
      font-weight:900;
      font-family:var(--sans);
      letter-spacing:.1px;
    }
    .ico-map{
      font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol";
      font-weight:400;
      line-height:1;
      font-size:13px;
      width:14px;
      height:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 14px;
      vertical-align:-1px;
    }

    
    .ico-eye{
      font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Segoe UI Symbol";
      font-weight:400;
      line-height:1;
      font-size:13px;
      width:14px;
      height:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 14px;
      vertical-align:-1px;
    }
.th-ic{margin-right:6px}


    /* Station monitor button states */
    .btn-auto-default{background:var(--btn-blue)}
    .btn-auto-live{background:var(--btn-green)}
    .btn-live-off{background:var(--danger)}
    .btn-live-on{background:var(--btn-green)}
    .temp-green{background:var(--btn-green)!important}

    /* Data panel above Monitor (scenario + live + AI etc.) */
    .data-panel{margin:0}
    .data-box{margin-bottom:10px}
    .data-hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
    }
    .data-panel-body{ margin-top:6px; }

    .data-title{font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .data-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .data-actions::-webkit-scrollbar{height:6px}
    .data-actions::-webkit-scrollbar-thumb{background:rgba(0,0,0,.22);border-radius:6px}

    /* Monitor title row */
    .monitor-head{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin-bottom:8px;
    }
    .monitor-head h3{white-space:nowrap}

    /* ===== Monitor panel (collapse entire Monitor) ===== */
    .monitor-panel-summary{
      font-size:13px;
      font-weight:900;
      color:var(--ink);
      margin:0 0 8px 0;
      list-style-position: inside;
    }
    #monitorPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    /* Keep the Data panel header the exact same height when collapsed */
    #dataPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    .monitor-panel-body{margin-top:0}

/* Parameters (Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹) â€” header row aligned like the other section headers */
.param-summary{
  /* Native disclosure triangle like Monitor; keep marker visible */
  list-style-position: inside;
  position: relative;
  padding-right: 44px; /* space for reset button */
}
.param-summary .param-title{
  display:inline-block;
}
.param-summary .param-reset-btn{
  position:absolute;
  right:0;
  top:50%;
  transform:translateY(-50%);
}
.param-caret{
  width:30px;
  height:26px;
  border-radius:6px;
  background:rgba(44,62,80,.10);
  border:1px solid rgba(0,0,0,.10);
  color:#1f2a33;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  line-height:1;
  flex:0 0 auto;
  transition:transform .15s ease;
}
.param-reset-btn{
  border:1px solid rgba(0,0,0,.10);
  background:rgba(44,62,80,.10);
  color:#1f2a33;
  width:30px;
  height:26px;
  border-radius:6px;
  cursor:pointer;
  font-weight:900;
  line-height:1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.param-reset-btn:hover{background:rgba(44,62,80,.16)}

    /* Coâ€‘Hazards panel (collapsible like Monitor/Data) */
    #coHazardsPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    /* Admin boundaries panel (collapsible like Monitor/Data) */
    #boundariesPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    .cohazards-panel-body{margin-top:0}
    .cohazards-panel-inner{
      margin-top:6px;
      padding:8px 10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
    }



    /* Coâ€‘Hazards contextual box inside Scenario panels */
    .cohazards-context-box{margin:10px 0 12px 0}
    /* Scenario contextual Coâ€‘Hazards collapsible (like DB History) */
    
    /* Scenario CoHazards (inside Scenario) â€” match DB collapse look */
    .scenario-cohazards-details > summary{
      cursor:pointer;
      margin-bottom:6px;
      /* keep native â–¶/â–¼ marker; avoid absolute layouts that break alignment */
      padding-right:0;
    }
    .scenario-cohazards-details > summary .cohazards-badges{
      position:static;
      margin-right:6px;
    }

.cohazards-context-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cohazards-context-title{font-weight:900;color:#1f2a33}
/* ===== Coâ€‘Hazards (secondary hazards) ===== */
    /* Standardize Coâ€‘Hazards buttons to match header controls (same size/radius) */
    .cohazards{
      display:flex;
      gap:6px;
      align-items:center;
      margin-left:6px;
      flex:0 0 auto
    }
    .cohazards .cohz{
      background:#ffffff;
      border:1px solid #cfe0ea;
      color:#1f2a33;
      font-weight:800;
      padding:6px 12px;      /* match .hdr-btn */
      border-radius:6px;     /* match .hdr-btn */
      line-height:1;
      font-size:12px;        /* match .hdr-btn */
      white-space:nowrap;
    }
    .cohazards .cohz:hover{filter:brightness(0.98)}
    .cohazards .cohz:disabled{opacity:0.45;cursor:not-allowed}
/* Active (ON) state â€“ green outline + hazardâ€‘coded colors (clear selection) */
.cohazards .cohz.cohz-on{
  color:#1f2a33;
  box-shadow:0 0 0 3px var(--btn-green);  /* green outline */
  position:relative;
  z-index:1;
}
/* Color meaning:
   - Î’ÏÎ¿Ï‡Î®: Î¼Ï€Î»Îµ
   - Î†Î½ÎµÎ¼Î¿Ï‚: Î¿Ï…Î´Î­Ï„ÎµÏÎ¿/Î³ÎºÏÎ¹
   - ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚: Ï€Î¿ÏÏ„Î¿ÎºÎ±Î»Î¯/ÎºÏŒÎºÎºÎ¹Î½Î¿
   - Î Î±Î³ÎµÏ„ÏŒÏ‚/Î§Î¹ÏŒÎ½Î¹: Î³Î±Î»Î¬Î¶Î¹Î¿
*/
.cohazards .cohz-rain.cohz-on{background:#e7f6ff;border-color:#b6e6ff}
.cohazards .cohz-wind.cohz-on{background:#f3f5f7;border-color:#d6dde4}
.cohazards .cohz-heatwave.cohz-on{background:#fff1e6;border-color:#ffd1a6}
.cohazards .cohz-frost_snow.cohz-on{background:#eef6ff;border-color:#cfe3ff}

    /* Global summary box */
    .cohazards-global{margin-top:0;background:transparent;border:0;padding:0}
    .cohazards-global-head{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:6px}
    .cohazards-global-title{font-weight:900;color:#1f2a33}
    .cohazards-badges{display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end}
    .cohazards-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border:1px solid #dfe7ee;
      border-radius:999px;
      background:#f8fbff;
      font-weight:800;
      color:#24323d;
      font-size:12px
    }
    .cohazards-badge.cohz-badge-rain{background:#e7f6ff;border-color:#b6e6ff}
.cohazards-badge.cohz-badge-wind{background:#f3f5f7;border-color:#d6dde4}
.cohazards-badge.cohz-badge-heatwave{background:#fff1e6;border-color:#ffd1a6}
.cohazards-badge.cohz-badge-frost_snow{background:#eef6ff;border-color:#cfe3ff}

    .cohazards-metrics{font-size:13px;color:#1f2a33}
    .cohazards-metrics ul{margin:6px 0 0 18px}
    .cohazards-note{margin-top:6px;font-size:11px;color:#6b7a86}

    /* ===== Monitor section titles & freshness indicator ===== */
    .monitor-section-title{
      font-size:11px;
      font-weight:800;
      color:var(--ink);
      letter-spacing:0.2px;
      list-style-position: inside;
    }

    /* ===== DB History (Firestore) ===== */
    .db-controls{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      margin:8px 0 6px;
    }
    .db-limit{
      width:78px;
      height:28px;
      border:1px solid #d6dde4;
      border-radius:10px;
      padding:0 8px;
      font-weight:900;
      background:#fff;
    }
    .db-status{
      font-size:11px;
      color:#6b7a86;
      font-weight:900;
      margin-left:auto;
    }
    .db-table-wrap{
      border:1px solid #dfe7ee;
      border-radius:12px;
      overflow:auto;
      max-height:240px;
      background:#fff;
    }
    .db-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .db-table th,.db-table td{
      padding:6px 8px;
      border-bottom:1px solid #eef2f6;
      text-align:right;
      white-space:nowrap;
    }
    .db-table th{
      background:#f7f9fb;
      color:#2c3e50;
      font-weight:900;
      position:sticky;
      top:0;
      z-index:1;
    }
    .db-table td:first-child,.db-table th:first-child{ text-align:left; }
    .db-table td.col-wind, .db-table th.col-wind{
      text-align:left;
      white-space:normal;
      min-width:140px;
    }

    /* DB filter row (Excel-like) */
    .db-filter-row th{
      background:#ffffff;
      position:sticky;
      top:28px;
      z-index:1;
      padding:4px 6px;
      border-bottom:1px solid #eef2f6;
      text-align:right;
      white-space:nowrap;
    }
    .db-filter-row th:first-child{ text-align:left; }
    .db-filter-row th.col-wind{ text-align:left; }
    .db-filter-row input,
    .db-filter-row select{
      width:100%;
      min-width:64px;
      height:24px;
      border:1px solid #d6dde4;
      border-radius:8px;
      padding:0 6px;
      font-size:11px;
      font-weight:700;
      background:#fff;
      color:#2c3e50;
      box-sizing:border-box;
    }
    .db-icon-btn{
      border:1px solid #d6dde4;
      background:#fff;
      border-radius:8px;
      width:26px;
      height:24px;
      cursor:pointer;
      font-weight:900;
      line-height:22px;
      padding:0;
    }
    .db-icon-btn:hover{ background:#f7f9fb; }
    .db-col-icon{ text-align:center !important; }


    .latest-ts{
      margin-left:10px;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }
    #stationName.age-fresh{ color:#1b8f3a; font-weight:800; }
    #stationName.age-warn{  color:#b58900; font-weight:800; }
    #stationName.age-stale{ color:#b00020; font-weight:800; }
    #stationName.age-unknown{ color:var(--ink); font-weight:700; }
    .multi-name.age-fresh{ color:#1b8f3a; font-weight:800; }
    .multi-name.age-warn{  color:#b58900; font-weight:800; }
    .multi-name.age-stale{ color:#b00020; font-weight:800; }
    .multi-name.age-unknown{ color:var(--ink); font-weight:700; }

    .monitor-controls{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;        /* keep buttons/select in one row */
      flex:0 0 auto
    }
    .hdr-btn{padding:6px 12px;font-size:12px;border-radius:6px; white-space:nowrap}
    /* Make <select> look like button */
    select.mini-btn{
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      padding-right:28px;
      background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
                        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position: calc(100% - 14px) calc(50% - 2px), calc(100% - 9px) calc(50% - 2px);
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }
    
    /* Keep dropdown list neutral (not green) even when the select itself becomes active */
    select.mini-btn option{
      background: var(--btn-gray);
      color:#fff;
    }
.btn-scenario{background:var(--btn-gray); color:#fff}
    .btn-scenario.scenario-active{background:var(--btn-green); color:#fff; border-color:rgba(0,0,0,.12)}
.btn-local-off{background:var(--danger)}
    .btn-local-on{background:var(--btn-green)}
.btn-ai{background:#4b57c2}
#btnAIAnalysis{display:inline-flex;align-items:center}

/* AI provider toggle (ChatGPT / Gemini) */

/* AI provider dropdown (AI: ChatGPT/Gemini) */
.ai-dd{
  display:flex;
  align-items:center;
  flex:0 0 auto;
}
.ai-select{
  flex:0 0 auto;
  min-width:132px;
  padding:5px 10px;
  padding-right:28px; /* keep room for the arrow */
  font-size:11px;
  color:#fff;
  border:1px solid rgba(255,255,255,.35);
  border-radius:10px;
  background-color:#111827; /* default ChatGPT */
}
.ai-select.ai-gemini{
  background-color:#6d28d9;
}
/* keep arrow visible on colored background */
.ai-select{
  background-clip: padding-box;
}
.ai-target{
  display:flex;
  align-items:center;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,.35);
  border-radius:10px;
  overflow:hidden;
  background:rgba(0,0,0,.10);
}
.ai-label{
  flex:0 0 auto;
  padding:6px 8px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.4px;
  color:#fff;
  background:rgba(0,0,0,.22);
  line-height:1;
  user-select:none;
}
.ai-pill{
  flex:0 0 auto;              /* prevent shrinking/truncation */
  border:none;
  background:rgba(255,255,255,.14);
  color:#fff;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
  line-height:1;
  white-space:nowrap;
}
.ai-pill + .ai-pill{border-left:1px solid rgba(255,255,255,.22)}
.ai-label + .ai-pill{border-left:1px solid rgba(255,255,255,.22)}
.ai-pill[data-ai="chatgpt"].active{background:#111827}
.ai-pill[data-ai="gemini"].active{background:#6d28d9}
.ai-pill.active{box-shadow:inset 0 0 0 1px rgba(255,255,255,.35); opacity:1; border-bottom:2px solid rgba(255,255,255,.75)}
.ai-pill:not(.active){opacity:.82}
.ai-pill:hover{filter:brightness(.97)}
.ai-pill:active{transform:translateY(1px)}
.ai-pill:focus-visible{outline:2px solid rgba(255,255,255,.65); outline-offset:-2px}
/* subtle horizontal scrollbar for monitor header (only if needed) */
.monitor-head::-webkit-scrollbar{height:6px}
.monitor-head::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:10px}
.monitor-head::-webkit-scrollbar-track{background:transparent}

/* Station time-series list */
.series-list{margin-top:6px;border:1px solid #dfe7ee;border-radius:10px;padding:6px;background:#fff;max-height:160px;overflow:auto;font-size:11px}
.series-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px dashed #e6eef5}
.series-row:last-child{border-bottom:none}
.series-ts{color:var(--muted);min-width:125px}
.series-val{font-weight:700;white-space:nowrap}
.series-dp{color:var(--muted);white-space:nowrap}

    .mini-btn:hover{filter:brightness(.95)}
    .mini-btn:active{transform:translateY(1px)}

    /* ====== Side table ====== */
    table{border-collapse:collapse;width:100%}
    th,td{padding:6px;border-bottom:1px solid #e9eef3;text-align:center;font-size:12px}
    th{background:#34495e;color:#fff;font-size:12px}
    .cat-row td{
      background:#f3f6f8;
      font-weight:900;
      text-align:left;
      padding:7px 10px;
      border-bottom:1px solid #dfe7ee;
    }
    .cat-head{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .cat-actions{display:flex;align-items:center;gap:6px;}
    .cat-actions .mini-btn{padding:3px 7px;font-size:11px;border-radius:4px;}
    .cat-title{display:flex;align-items:center;gap:6px;}
    .type-cell{
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      letter-spacing:.06em;
      font-family:var(--mono);
      white-space:nowrap;
      opacity:.95;
    }

    /* Keep each file row on a single line (Name | Actions) */
    #filesBody{ overflow-x:auto; }  /* fallback on very narrow screens */
    #filesBody{ overflow-x:auto; }  /* fallback on very narrow screens */
    #filesBody table{ table-layout:fixed; }
    #filesBody th:nth-child(1), #filesBody td:nth-child(1){ width:68%; text-align:left; }
    #filesBody th:nth-child(2), #filesBody td:nth-child(2){ width:32%; text-align:right; padding-right:10px; }
    #filesBody td:nth-child(1){ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #filesBody th, #filesBody td{ vertical-align:middle; }

    #filesBody .actions-row{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:nowrap;
      white-space:nowrap;
    }
    #filesBody .actions-row .mini-btn{ padding:4px 8px; font-size:11px; }

    .hint{
      font-size:10px;
      color:var(--muted);
      padding:10px 12px;
      border-top:1px solid var(--line);
    }

    /* ====== Main tool ====== */
    .tool-wrap{padding:12px 0 0 0}
    .tool-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 var(--topbar-pad-x);
      height:var(--topbar-h);
      box-sizing:border-box;
      border-bottom:1px solid var(--line);
      background:#fbfcfe;
    }
    .tool-header h1{
      margin:0;
      font-size:14px;
      line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .print-btn{
      border:none;
      background:#2c3e50;
      color:#fff;
      border-radius:6px;
      padding:7px 10px;
      font-size:12px;
      cursor:pointer;
      font-weight:800;
    }
    .print-btn:hover{filter:brightness(.95)}

    .sel-basin{
      margin:10px 0 0 0;
      font-size:12px;
      color:#2c3e50;
      font-weight:800;
    }
    .sel-basin span{
      font-weight:900;
      color:#d35400;
    }

    .grid-2{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .grid-2{grid-template-columns:1fr}
    }

    .box{
      border:1px solid #dfe7ee;
      background:#fff;
      border-radius:10px;
      padding:10px;
    }
    .top-panel-box{margin:0 0 10px 0}

    .box h3{
      margin:0 0 8px 0;
      font-size:13px;
      font-weight:900;
    }
    .row{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:8px;
      align-items:center;
      margin:6px 0;
    }
    .row label{
      font-size:12px;
      color:#2c3e50;
      font-weight:800;
    }
    input,select{
      width:100%;
      font-size:12px;
      padding:6px 8px;
      border:1px solid #d6dde4;
      border-radius:6px;
      outline:none;
      background:#fff;
    }

    .panels-row{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 1150px){
      .panels-row{grid-template-columns:1fr}
    }

    canvas{
      width:100%;
      border:1px dashed #cfd8e3;
      border-radius:8px;
      background:#fff;
    }

    .summary-box{
      display:grid;
      grid-template-columns:repeat(6, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 1150px){
      .summary-box{grid-template-columns:repeat(2,1fr)}
    }
    
    /* ===== Scenario-based panels (Rain / Wind / Heatwave / Frost) ===== */
    .scenario-panel{display:none;}
    .scenario-panel.active{display:block;}
    .ro{
      font-weight:800;
      color:var(--ink);
      padding:4px 0;
      user-select:text;
    }
    .ops-list{
      font-size:12px;
      color:#243342;
      line-height:1.35;
    }
    .ops-list ul{margin:6px 0 0 18px; padding:0;}
    .ops-list li{margin:3px 0;}
    .stat{
      border:1px solid #e6edf3;
      background:#fbfdff;
      border-radius:10px;
      padding:8px;
      text-align:center;
    }
    .stat .k{font-size:11px;color:#6b7a86;font-weight:800}
    .stat .v{font-size:14px;font-weight:900;margin-top:4px}

    .status-ok{color:var(--ok);font-weight:900}
    .status-warn{color:var(--warn);font-weight:900}
    .status-fail{color:var(--danger);font-weight:900}

    /* Scenario table + risk colors */
    .table-wrap{
      margin-top:12px;
      border:1px solid #e6edf3;
      border-radius:10px;
      overflow:hidden;
    }
    .table-wrap table{width:100%}
    .table-wrap th{background:#34495e}
    .risk-safe{background:#eafaf1}
    .risk-warn{background:#fff7e6}
    .risk-orange{background:#ffe9d6}
    .risk-red{background:#ffe0e0}
    .risk-extreme{background:#ffd1d1}

    .footer-grid{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .footer-grid{grid-template-columns:1fr}
    }
    .legend{
      border:1px solid #e6edf3;
      border-radius:10px;
      padding:10px;
      background:#fff;
    }
    .legend h4{margin:0 0 8px 0;font-size:12px;font-weight:900}
    .legend .item{
      display:flex;
      align-items:center;
      gap:8px;
      margin:6px 0;
      font-size:12px;
      font-weight:800;
      color:#2c3e50;
    }
    .swatch{
      width:18px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.12);
    }

    .station-mini{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 900px){
      .station-mini{grid-template-columns:1fr}
    }
    .station-card{
      border:1px solid #e6edf3;
      border-radius:10px;
      padding:8px;
      background:#fbfdff;
    }
    .station-card .t{font-size:11px;color:#6b7a86;font-weight:900}
    .station-card .v{font-size:14px;font-weight:900;margin-top:3px}
    .station-actions{
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }

    /* ====== Map modal ====== */
    #mapModal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    #mapCard{
      width:min(1100px, 96vw);
      height:min(700px, 88vh);
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    #mapTop{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#fbfcfe;
      font-weight:900;
    }
    #mapBox{flex:1}

    /* ====== Loader ====== */
    #loader{
      display:none;
      font-size:12px;
      color:var(--muted);
      padding:8px 12px;
      border-top:1px solid var(--line);
    }

    /* ====== Print ====== */
    @media print{
      body{background:#fff}
      .side-panel{display:none!important}
      .app-shell{padding:0}
      .main-panel{box-shadow:none;border:none;border-radius:0}
      #mapModal{display:none!important}
      .no-print{display:none!important}
    }
  
  /* Watchlist chips + multi-station list */
  .chip{ display:inline-flex; align-items:center; gap:3px; padding:4px 8px; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; font-size:11px; cursor:pointer; }
  .chip b{ font-weight:600; }
  .chip button{ border:0; background:transparent; cursor:pointer; font-size:12px; line-height:1; color:#64748b; padding:0; }

  .chip.watch{ background:#fff7e6; border-color:#f1d27a; }
  .status-pill{ margin-top:8px; font-size:11px; font-weight:900; padding:7px 10px; border-radius:10px; border:1px solid #dfe7ee; background:#f8fafc; color:#475569; }
  .status-pill.status-ok{ background:#eafaf1; border-color:#bfe7cb; color:#1f7a3a; }
  .status-pill.status-warn{ background:#fff7e6; border-color:#f1d27a; color:#b35300; }
  .status-pill.status-neutral{ background:#f8fafc; border-color:#dfe7ee; color:#475569; }

  .meteo-msg{ display:none; font-size:10px; color:var(--muted); margin-top:4px; font-style:italic; }

  #primaryStatusWrap .status-pill, #meteoStatusWrap .status-pill{ margin-top:0; padding:6px 10px; }

  .multi-table{ width:100%; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; background:#fff; }
  .multi-row{
    padding:6px 8px;
    border-top:1px solid #e2e8f0;
    font-size:11px;
  }
  .multi-row:first-child{ border-top:0; }
  .multi-name{ min-width:0; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;  display:inline-block; max-width:260px; vertical-align:baseline;}
  .multi-ts{ justify-self:center; text-align:center; color:#64748b; font-variant-numeric: tabular-nums; white-space:nowrap; }
  .multi-spacer{ }

    /* Multi-station extra list: include latest values chips */
    .multi-block{ border-top:1px solid #e2e8f0; padding:6px 8px; }
    .multi-block:first-child{ border-top:0; }
    .multi-block .multi-row{ padding:0; border-top:0; }
    .multi-latest{ margin-top:4px; }

    /* Compact chips for extra stations */
    .latest-chips.multi{ gap:2px; padding:0 0 2px 0; }
    .latest-chips.multi .chip{
      height:66px;
      padding:3px 2px;
      border-radius:12px;
    }
    .latest-chips.multi .chip .el{ font-size:8.8px; height:20px; }
    .latest-chips.multi .chip .en{ font-size:8.2px; height:18px; }
    .latest-chips.multi .chip .val{ font-size:10px; height:18px; }

    /* ====== NIREAS brand/logo ====== */
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .nireas-logo{
      height:42px;
      width:auto;
      border-radius:10px;
      background:#fff;
      padding:2px;
      border:1px solid #dfe7ee;
      box-shadow:0 6px 14px rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

        /* Latest values chips (station monitor) */

    /* Station meta line (one-line header) */
    .station-meta-line{
      display:inline-flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:baseline;
      font-size:12px;
      margin:0;
    }
    .station-meta-line .meta-item{ white-space:nowrap; }
    .station-meta-line #stationName{ font-weight:800; }

    .station-meta-line .name-item{ display:inline-flex; align-items:center; gap:6px; }

    /* Collapsible: Primary station (triangle like other sections) */
    .station-summary{ font-size:11px; font-weight:400; color:var(--ink);
      list-style-position: inside;}
    #primaryStationDetails > summary::marker{ font-size:11px; }
    #dataPanelDetails > summary::marker{ font-size:13px; }



    /* Small icon buttons for station actions (open URL / refresh) */
    .meta-icon-btn{
      border:1px solid rgba(0,0,0,.08);
      background:rgba(44,62,80,.08);
      color:#1f2a33;
      width:24px;
      height:22px;
      border-radius:8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      vertical-align:middle;
      line-height:1;
      font-size:14px;
      padding:0;
    }
    
    /* Unified summary row with right-aligned actions (keeps native <summary> triangle) */
    .summary-flex{
      display:inline-flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:calc(100% - 1.6em);
      box-sizing:border-box;
    }
    .summary-flex .summary-left{
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .summary-flex .summary-left > *{min-width:0;}
    .summary-flex .summary-right{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    /* Reset icon inside summaries (use same visual language as meta-icon-btn) */
    .summary-reset-btn{
      border:1px solid rgba(0,0,0,.08);
      background:rgba(44,62,80,.08);
      color:#1f2a33;
      width:24px;
      height:22px;
      border-radius:8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      vertical-align:middle;
      line-height:1;
      font-size:14px;
      padding:0;
    }
    .summary-reset-btn:hover{filter:brightness(0.98)}
.meta-icon-btn:hover{ background:rgba(44,62,80,.14); }
    .meta-icon-btn:disabled{ opacity:.6; cursor:default; }
    .meta-icon-btn.spinning{ animation: spin 0.9s linear infinite; }
    @keyframes spin{ from{ transform:rotate(0deg);} to{ transform:rotate(360deg);} }

    /* Extra stations: meta line */
    .multi-meta-line{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;           /* visual alignment with main station line */
      font-size:11px;
      line-height:1.2;
    }
    .multi-meta-line .meta-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .multi-meta-line .meta-label{
      font-weight:800;
    }
    .multi-meta-line .multi-name{ font-weight:700; }
    .multi-meta-line .multi-ts{ color:#64748b; font-variant-numeric: tabular-nums; }
    .multi-meta-line .meta-val{ font-variant-numeric: tabular-nums; }
    .latest-row{
      margin-top:6px;
      font-size:11px;
      line-height:1.2;
      color:#1f2a33;
      display:flex;
      flex-direction:column;   /* label on top, chips below */
      align-items:stretch;
      gap:2px;
    }

    .latest-head{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .latest-head .latest-ts{ margin-left:0; }

    .latest-row > b{
      display:block;
      white-space:nowrap;
      padding-top:0;
      flex:0 0 auto;
    }

/* Fit ALL chips inside the frame (no horizontal scrollbar) */
    .latest-chips{
      width:100%;
      flex:1 1 auto;
      display:grid;
      grid-template-columns: repeat(var(--chip-count, 14), minmax(0, 1fr));
      gap:3px;
      overflow:hidden;          /* no scrollbar */
      padding:1px 0 3px 0;
      max-width:100%;
      align-items:stretch;
    }

    /* Symmetric chip layout: Greek (top) / English (middle) / Value (bottom) */
    .latest-chips .chip{
      min-width:0;
      height:78px;              /* fixed height so values align */
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:4px 3px;
      background:rgba(255,255,255,.92);
      border:1px solid #dfe7ee;
      border-radius:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      text-align:center;
    }

    .latest-chips .chip .el,
    .latest-chips .chip .en,
    .latest-chips .chip .val{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 2px;
      word-break:break-word;
      hyphens:auto;
    }

    .latest-chips .chip .el{
      font-weight:900;
      font-size:9.6px;
      line-height:1.1;
      height:24px;              /* reserve space: keep symmetry */
    }
    .latest-chips .chip .en{
      font-weight:700;
      font-size:9.2px;
      line-height:1.1;
      height:20px;
      color:#6b7a86;
      margin-top:1px;
    }
    .latest-chips .chip .val{
      font-weight:900;
      font-size:11px;
      line-height:1.1;
      height:20px;
      font-variant-numeric:tabular-nums;
      margin-top:auto;          /* push value to bottom consistently */
      padding-bottom:1px;
    }

    /* De-emphasize empty/missing metrics while preserving alignment */
    .latest-chips .chip.empty{
      opacity:.55;
    }
    .latest-chips .chip.empty .val{
      font-weight:800;
    }

    /* Keep a hidden plain-text version (for copy/debug) */
    .latest-text{ display:none; }
    .nireas-text-logo{
      display:inline-block;
      font-weight:900;
      letter-spacing:.08em;
      font-size:12px;
      padding:4px 10px;
      border-radius:10px;
      background:rgba(255,255,255,.9);
      border:1px solid #dfe7ee;
      color:#0f172a;
    }

.status-stack{display:flex;flex-direction:column;gap:6px;margin-top:8px;}

/* ====== Header alignment fix (side + main top bars) ====== */
:root{
  --appHeaderH: 44px;
  --appHeaderPadY: 8px;
}
.panel-topbar,
.tool-header{
  min-height: var(--appHeaderH);
  padding-top: var(--appHeaderPadY);
  padding-bottom: var(--appHeaderPadY);
  align-items:center;
}
/* Prevent the logo <img> baseline gap from pushing the bar height */
.panel-topbar img.nireas-logo,
.tool-header img.nireas-logo{
  height: 22px !important;
  width: auto !important;
  padding: 1px !important;
  border-radius: 6px !important;
  display: block !important;
  box-shadow: none !important;
}
/* Keep title vertically centered without increasing bar height */
.tool-header h1{
  line-height: 1.15;
  margin: 0;
}

    /* ===== Meteo stations (selected only) markers ===== */
    .station-pin{width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.35);}
    .station-pin.primary{width:16px;height:16px;border-radius:2px;background:#e53935;transform:rotate(45deg);}
    .station-pin-wrap{display:flex;align-items:center;justify-content:center;}

    .scenario-area-body{margin-top:6px;}


/* ============================================================
   Layout update: 3 cards (left) + Data & Scenario (right)
   ============================================================ */

.tool-header.global-topbar{
  width:100%;
  border-radius:0;
}

/* Turn columns into card stacks */
.side-panel{
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  overflow:visible !important;
  display:flex !important;
  flex-direction:column !important;
  gap:12px !important;
}
.main-panel{
  background:transparent !important;
  border:none !important;
  box-shadow:none !important;
  overflow:visible !important;
  display:flex !important;
  flex-direction:column !important;
  gap:12px !important;
}

/* Reusable card wrapper */
.panel-card{
  background:var(--panel);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  border:1px solid rgba(0,0,0,.06);
}


/* When a card body is collapsed, round the header bottom corners too (unified look) */
.panel-card.is-collapsed .panel-topbar{
  border-bottom-left-radius:var(--radius);
  border-bottom-right-radius:var(--radius);
  border-bottom:none;
}
/* Card bodies */
#mainDataBody, #scenarioCardBody{
  padding:12px;
}

/* Tool wrap now lives inside a card body */
.tool-wrap{padding:0 !important}

/* Headers inside dark topbars */
.panel-topbar .hdr-left{
  color:#fff;
  font-weight:900;
  white-space:nowrap;
}
.panel-topbar .hdr-right{
  display:flex;
  align-items:center;
  gap:6px;
  margin-left:auto;
}

/* Scenario card highlight */
.scenario-card{
  border-color:rgba(104,64,168,.28);
}
.scenario-card .panel-topbar{
  background:#6840a8;
}
.scenario-card #scenarioCardBody{
  background:#fbf8ff;
}

/* Make nested .section behave nicely inside cards */
.side-card .section{border-top:none}
.side-card .panel-topbar{border-bottom:1px solid rgba(255,255,255,.12)}

/* Side panels: standardize table typography to match other menus */
.side-card table{font-size:12px;}
.side-card table th,.side-card table td{font-size:12px; padding:7px 8px;}
/* Data Source contains nested sub-menus */
#dataSourceBody{ padding:10px; }
#dataSourceBody > .nested-panels{ margin-top:10px; }
.nested-panels{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.nested-panels .panel-card{ margin:0; }



/* Intro text inside Data Source */
#dataSourceBody .source-intro > div{ padding:0 !important; } /* neutralize old inline padding wrappers */
#dataSourceBody .source-intro{ font-size:12px; color:#2b3a44; line-height:1.35; margin-bottom:6px; }
</style>
</head>
<body>
<!--
===================== NIREAS (Readable copy) =====================
Î£Ï„ÏŒÏ‡Î¿Ï‚: ÎµÏ…ÎºÎ¿Î»ÏŒÏ„ÎµÏÎ· Ï€Î»Î¿Î®Î³Î·ÏƒÎ·/Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚. Î¤Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿ (Î´ÎµÎ½ Î¬Î»Î»Î±Î¾Î±Î½ Î»Î¿Î³Î¹ÎºÎ­Ï‚/Ï„Î¹Î¼Î­Ï‚).

Î“ÏÎ®Î³Î¿ÏÎ· Ï€Î»Î¿Î®Î³Î·ÏƒÎ· (Ctrl+F):
  [LAYOUT/CSS]     :root  | .app-shell | .side-panel | .main-panel | .panel-topbar | .tool-header
  [LEFT PANEL]     id="sideBody" | id="meteoBody" | id="filesBody" | id="fileRows"
  [STATIONS/UI]    meteoStationSelect | monitorStationSelect | watchlist | stationMultiList
  [MAP]            mapModal | mapBox | openMapModal() | Leaflet (L.map)
  [CALC ENGINE]    runMasterCalculation() | kirpich | qpeak | qcap
  [LIVE]           toggleLive() | fetchStationData()
  [AI ANALYSIS]    initAIAnalysisUI() | buildAIPrompt() | btnAIAnalysis
  [FIREBASE LOG]   fbLogSample() | fbFetchRecentSamples() | fbFetchRecentSamplesAll()
  [DB READER]      dbTable | btnDbLoad | btnDbImport | btnDbExport | filters
===============================================================
-->
<div class="tool-header global-topbar">
<div class="brand">
<img alt="ÎÎ—Î¡Î•Î‘Î£" class="nireas-logo" onerror="this.outerHTML='&lt;span class=nireas-text-logo&gt;NIREAS&lt;/span&gt;'" src="nireas_logo.png"/>
<h1>Î£ÏÏƒÏ„Î·Î¼Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎˆÎ³ÎºÎ±Î¹ÏÎ·Ï‚ Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (Monitoring &amp; Early Warning System)</h1>
</div>
<button class="print-btn no-print" onclick="window.print()">Î•ÎšÎ¤Î¥Î Î©Î£Î—</button>
</div><div class="app-shell">
<!-- ================= LEFT: GitHub Data panel ================= -->
<aside class="side-panel">

<section class="panel-card side-card source-card"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left"><div style="display:flex;align-items:center;gap:10px;white-space:nowrap;">
  Î Î·Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ : <img alt="ÎÎ—Î¡Î•Î‘Î£" class="nireas-logo" onerror="this.outerHTML='&lt;span class=nireas-text-logo&gt;NIREAS&lt;/span&gt;'" src="nireas_logo.png" style="height:22px;padding:1px;border-radius:6px;"/>
</div></div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('dataSourceBody', this)" style="width:28px;height:24px">âˆ’</button>
    </div>
  </div>
  <div class="section-body" id="dataSourceBody"><div class="source-intro"><div style="padding:10px 12px;font-size:12px;color:#2b3a44;line-height:1.35;">Î Î·Î³Î®: NIREAS (UI) â€” Î¸Î± ÎµÎ¼Ï€Î»Î¿Ï…Ï„Î¹ÏƒÏ„ÎµÎ¯ Î¼Îµ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚/Î¼ÎµÏ„Î±Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î·Î³ÏÎ½ ÏƒÏ„Î· ÏƒÏ…Î½Î­Ï‡ÎµÎ¹Î±.</div></div>

<div class="nested-panels">
<section class="panel-card side-card nested-card hr-card"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">ğŸ‘¥ Î‘Î½Î¸ÏÏÏ€Î¹Î½Î¿ Î”Ï…Î½Î±Î¼Î¹ÎºÏŒ</div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('hrBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="hrBody">
    <div style="font-size:12px;color:#2b3a44;line-height:1.35;">
      (Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ) Î˜Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ Î±ÏÎ³ÏŒÏ„ÎµÏÎ± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±/Ï†ÏŒÏÎ¼ÎµÏ‚ Î³Î¹Î± Î±Î½Î¸ÏÏÏ€Î¹Î½Î¿ Î´Ï…Î½Î±Î¼Î¹ÎºÏŒ.
    </div>
  </div>
</div></section>


<section class="panel-card side-card nested-card vehicles-card"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">ğŸšš Î¤ÎµÏ‡Î½Î¹ÎºÎ¬ ÎœÎ­ÏƒÎ± / ÎŸÏ‡Î®Î¼Î±Ï„Î±</div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('vehiclesBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="vehiclesBody">
    <div style="font-size:12px;color:#2b3a44;line-height:1.35;">
      (Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ) Î˜Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ Î±ÏÎ³ÏŒÏ„ÎµÏÎ± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î­Ï‚/Ï€Î¯Î½Î±ÎºÎµÏ‚ Î³Î¹Î± Î¿Ï‡Î®Î¼Î±Ï„Î± ÎºÎ±Î¹ Ï„ÎµÏ‡Î½Î¹ÎºÎ¬ Î¼Î­ÏƒÎ±.
    </div>
  </div>
</div></section>


<section class="panel-card side-card nested-card materials-card"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">ğŸ§° Î¤ÎµÏ‡Î½Î¹ÎºÎ¬ ÎœÎ­ÏƒÎ± / Î¥Î»Î¹ÎºÎ¬</div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('materialsBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="materialsBody">
    <div style="font-size:12px;color:#2b3a44;line-height:1.35;">
      (Î ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ) Î˜Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ Î±ÏÎ³ÏŒÏ„ÎµÏÎ± ÎºÎ±Ï„Î±Î³ÏÎ±Ï†Î­Ï‚/Ï€Î¯Î½Î±ÎºÎµÏ‚ Î³Î¹Î± Ï…Î»Î¹ÎºÎ¬ ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î­Î¼Î±Ï„Î±.
    </div>
  </div>
</div></section>

<section class="panel-card side-card nested-card meteo-card"><div class="section">
<div class="panel-topbar">
<div class="hdr-left">ğŸ“¡ ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Î¯ Î£Ï„Î±Î¸Î¼Î¿Î¯</div>
<div class="hdr-right"><button class="icon-btn" onclick="toggleCollapse('meteoBody', this)" style="width:28px;height:24px">âˆ’</button>
</div>
</div>
<div class="section-body" id="meteoBody">

<div class="station-row-hdr">
  <div class="station-row-label">ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚</div>
  <div class="map-btns" title="ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ Ï‡Î¬ÏÏ„Î· (Î¼ÏŒÎ½Î¿ Ï‡Î¬ÏÏ„Î·Ï‚)">
<button class="mini-btn btn-map map-only-btn" onclick="meteoPrimaryMap()" title="Î§Î¬ÏÏ„Î·Ï‚: Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· (zoom) Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î® On/Off"><span class="ico-map">ğŸ—º</span> Map</button>
    <button class="mini-btn btn-off map-only-btn" id="btn-onoff-meteoStations-2" onclick="toggleMeteoPrimaryLayer()" title="Î§Î¬ÏÏ„Î·Ï‚: On/Off markers ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½"><span class="ico-eye">ğŸ‘</span> Off</button>
  </div>
</div>
<div class="station-row-body">
  <select id="meteoStationSelect" style="flex:1">
    <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>
  </select>
  <button class="mini-btn btn-on" onclick="setPrimaryStation()" title="ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï‰Ï‚ ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚ &amp; Î¬Î¼ÎµÏƒÎ· Î»Î®ÏˆÎ·">â•</button>
  <button class="mini-btn btn-gray" onclick="clearPrimaryStation()" title="Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ§¹</button>
  <button class="mini-btn btn-map" onclick="openPrimaryWeb()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±">ğŸ”— Web</button>
</div>
<div class="status-stack" id="primaryStatusWrap" style="margin-top:2px;">
<div class="status-pill status-neutral" id="primaryStatus">ÎšÏÏÎ¹Î¿Ï‚: Î‘Î½Î±Î¼Î¿Î½Î®â€¦</div>
</div>

<div class="station-row-hdr" style="margin-top:10px;">
  <div class="station-row-label">Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· (Ï€Î¿Î»Î»Î±Ï€Î»Î¿Î¯ ÏƒÏ„Î±Î¸Î¼Î¿Î¯)</div>
  <div class="map-btns" title="ÎšÎ¿Ï…Î¼Ï€Î¹Î¬ Ï‡Î¬ÏÏ„Î· (Î¼ÏŒÎ½Î¿ Ï‡Î¬ÏÏ„Î·Ï‚)">
<button class="mini-btn btn-map map-only-btn" onclick="meteoWatchMap()" title="Î§Î¬ÏÏ„Î·Ï‚: Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· (zoom) Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î® On/Off"><span class="ico-map">ğŸ—º</span> Map</button>
    <button class="mini-btn btn-off map-only-btn" id="btn-onoff-meteoStations" onclick="toggleMeteoWatchLayer()" title="Î§Î¬ÏÏ„Î·Ï‚: On/Off markers ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½"><span class="ico-eye">ğŸ‘</span> Off</button>
  </div>
</div>
<div class="station-row-body">
  <select id="monitorStationSelect" style="flex:1">
    <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚...</option>
  </select>
  <button class="mini-btn btn-on" onclick="addToWatchlistFromMonitor()" title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿Ï…Ï‚ Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚ &amp; Î¬Î¼ÎµÏƒÎ· Î»Î®ÏˆÎ·">â•</button>
  <button class="mini-btn btn-gray" onclick="clearWatchlist()" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚">ğŸ§¹</button>
  <button class="mini-btn btn-map" onclick="openMonitorWeb()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±">ğŸ”— Web</button>
</div>
<div class="status-stack" id="meteoStatusWrap" style="margin-top:2px;">
<div class="status-pill status-neutral" id="extrasStatus">Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î‘Î½Î±Î¼Î¿Î½Î®â€¦</div>
</div>
<div class="meteo-msg" id="meteoMsg" style="display:none"></div>
<details class="no-print" style="margin-top:8px;">
<summary style="cursor:pointer;font-size:11px;color:#6b7a86;">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· custom ÏƒÏ„Î±Î¸Î¼Î¿Ï (Î¼Îµ URL)</summary>
<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; align-items:center;">
<input id="customStationName" placeholder="ÎŒÎ½Î¿Î¼Î± (Ï€.Ï‡. Î§Î‘Î›Î‘ÎÎ”Î¡Î™)" style="flex:1; min-width:220px; padding:8px; border:1px solid #dfe7ee; border-radius:10px; font-size:12px;"/>
<input id="customStationUrl" placeholder="URL (Openâ€‘Meteo API Î® penteli link)" style="flex:2; min-width:320px; padding:8px; border:1px solid #dfe7ee; border-radius:10px; font-size:12px;"/>
<button class="mini-btn btn-on" onclick="addCustomStation()" title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· custom ÏƒÏ„Î±Î¸Î¼Î¿Ï">â•</button>
</div>
<div id="customStationMsg" style="font-size:10px;color:#6b7a86;margin-top:6px;font-style:italic;">Î‘Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Ï„Î¿Ï€Î¹ÎºÎ¬ ÏƒÏ„Î¿Î½ browser.</div>
</details>
<div class="no-print" id="watchlistWrap" style="margin-top:6px;">
<div id="watchlist" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
</div>
</div>
</div></section>

<section class=\"panel-card side-card nested-card geo-card is-collapsed"><div class="section">
<div class="panel-topbar">
  <div class="hdr-left">ğŸ“ Î‘ÏÏ‡ÎµÎ¯Î± ÎˆÏÎ³Î¿Ï… (GeoJSON)</div>
  <div class="hdr-right"><button class="icon-btn" onclick="toggleCollapse('filesBody', this)" style="width:28px;height:24px">+</button></div>
</div>
<div class="section-body collapsed" id="filesBody" style="padding:0">
<div id="loader">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Ï€ÏŒ GitHubâ€¦</div>
<table>
<thead>
<tr>
<th style="text-align:left;padding-left:10px;"><span class="th-ic">ğŸ“„</span>ÎŒÎ½Î¿Î¼Î±</th>
<th style="text-align:right;padding-right:10px;"><span class="th-ic ico-map">ğŸ—º</span>Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
</tr>
</thead>
<tbody id="fileRows"></tbody>
</table>
<div class="hint" id="filesHint">
<b><span class="ico-map">ğŸ—º</span> Map</b> = Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· (zoom) <b>Ï‡Ï‰ÏÎ¯Ï‚</b> Î±Î»Î»Î±Î³Î® On/Off.<br/>
<b>ğŸ‘ On/Off</b> = ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹/ÎºÏÏÎ²ÎµÎ¹ layer (Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚).<br/>
<b>â• / ğŸ§¹</b> (Î±Î½Î¬ Î±ÏÏ‡ÎµÎ¯Î¿) = Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·/ÎµÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ ÏƒÏ„Î¿ <b>ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ panel</b>.<br/>
</div>
<div class="hint" id="filesMsg" style="display:none;margin-top:6px"></div>
</div>
</div></section>
</div>
</div>
</div></section>
<section class="panel-card side-card forecast-card is-collapsed"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">ğŸŒ¤ Forecast Source</div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('forecastSourceBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="forecastSourceBody">
    <div id="forecastLoader" class="hint" style="margin:0;border-radius:0;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï€Î·Î³ÏÎ½ Ï€ÏÏŒÎ³Î½Ï‰ÏƒÎ·Ï‚â€¦</div>
    <table style="margin-top:0;">
      <thead>
        <tr>
          <th style="text-align:left;padding-left:10px;"><span class="th-ic">ğŸŒ</span>Î Î·Î³Î®</th>
          <th style="text-align:right;padding-right:10px;"><span class="th-ic">ğŸ”—</span>Web</th>
        </tr>
      </thead>
      <tbody id="forecastRows"></tbody>
    </table>
    <div class="hint" id="forecastHint" style="margin-top:0;">
      <b>ğŸ”— Web</b> = Î¬Î½Î¿Î¹Î³Î¼Î± Ï„Î·Ï‚ Ï€Î·Î³Î®Ï‚ Ï€ÏÏŒÎ³Î½Ï‰ÏƒÎ·Ï‚ ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±.
    </div>
    <div class="hint" id="forecastMsg" style="display:none;margin-top:6px"></div>
  </div>
</div></section>

<section class="panel-card side-card waterlevel-card is-collapsed"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">ğŸ“ Î£Ï„Î¬Î¸Î¼Î· Î¡ÎµÎ¼Î¬Ï„Ï‰Î½ <span style="opacity:.85;font-weight:600;">(Water Level Sensors)</span></div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('waterLevelBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="waterLevelBody">
    <div id="waterLevelLoader" class="hint" style="margin:0;border-radius:0;">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î¹ÏƒÎ¸Î·Ï„Î®ÏÏ‰Î½ ÏƒÏ„Î¬Î¸Î¼Î·Ï‚â€¦</div>

    <table style="margin-top:0;">
      <thead>
        <tr>
          <th style="text-align:left;padding-left:10px;"><span class="th-ic">ğŸŒŠ</span>Î‘Î¹ÏƒÎ¸Î·Ï„Î®ÏÎ±Ï‚</th>
          <th style="text-align:right;padding-right:10px;"><span class="th-ic">ğŸ”—</span>Web</th>
        </tr>
      </thead>
      <tbody id="waterLevelRows"></tbody>
    </table>

    <div class="hint" id="waterLevelHint" style="margin-top:0;">
      <b>ğŸ”— Web</b> = Î¬Î½Î¿Î¹Î³Î¼Î± Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Ï„Î¿Ï… Î±Î¹ÏƒÎ¸Î·Ï„Î®ÏÎ± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±.
    </div>
    <div class="hint" id="waterLevelMsg" style="display:none;margin-top:6px"></div>
  </div>
</div></section>

<section class="panel-card side-card idf-card is-collapsed"><div class="section">
  <div class="panel-topbar">
    <div class="hdr-left">â˜” ÎšÎ±Î¼Ï€ÏÎ»ÎµÏ‚ ÎŒÎ¼Î²ÏÎ¹Ï‰Î½ <span style="opacity:.85;font-weight:600;">(IDF Curves)</span></div>
    <div class="hdr-right">
      <button class="icon-btn" onclick="toggleCollapse('idfBody', this)" style="width:28px;height:24px">+</button>
    </div>
  </div>
  <div class="section-body collapsed" id="idfBody">
    <div class="hint" style="margin:0;border-radius:0;">Î•Î´Ï Î¸Î± Ï€ÏÎ¿ÏƒÏ„ÎµÎ¸Î¿ÏÎ½ Ï€Î·Î³Î­Ï‚/Î±ÏÏ‡ÎµÎ¯Î± IDF (ÎºÎ±Î¼Ï€ÏÎ»ÎµÏ‚ ÏŒÎ¼Î²ÏÎ¹Ï‰Î½) Î³Î¹Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ Ï€ÎµÏÎ¹Î¿Ï‡Î­Ï‚.</div>
    <div class="hint" style="margin-top:6px;">(Î ÏÎ¿ÏƒÎµÏ‡ÏÏ‚) ğŸ”— Web / ğŸ“„ Î±ÏÏ‡ÎµÎ¯Î± / ÎµÏ€Î¹Î»Î¿Î³Î® ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ panel.</div>
  </div>
</div></section>

</aside>
<!-- ================= RIGHT: Î£ÏÏƒÏ„Î·Î¼Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎˆÎ³ÎºÎ±Î¹ÏÎ·Ï‚ Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (Monitoring & Early Warning System) ================= -->
<main class="main-panel">







<section class="panel-card main-data-card"><div class="panel-topbar"><div style="display:flex;align-items:center;gap:10px;white-space:nowrap;">Î”ÎµÎ´Î¿Î¼Î­Î½Î±</div><button class="icon-btn" onclick="toggleCollapse('mainDataBody', this)">âˆ’</button></div><div id="mainDataBody"><div class="tool-wrap">
<div class="box data-box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="dataPanelDetails" open="" style="margin:0;">
<summary class="monitor-panel-summary param-summary" style="cursor:pointer;">
<span class="param-title">Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</span>
<button class="param-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetParametersToDefaults();" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÏ‰Î½ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚" type="button">âŸ²</button>
</summary>
<div class="data-panel-body">
<div class="data-hdr">
<div class="data-actions no-print">
<select class="mini-btn hdr-btn btn-scenario" id="modelScenario" onchange="onScenarioChange(this)" title="Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…">
<option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…</option>
<option value="wind">Î†Î½ÎµÎ¼Î¿Ï‚</option>
<option value="rain">Î’ÏÎ¿Ï‡Î®</option>
<option value="heatwave">ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</option>
<option value="frost_snow">Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±</option>
</select>
<div class="cohazards" id="coHazards" title="Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Ï†Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Î´ÎµÏ…Ï„ÎµÏÎµÏÎ¿Î½Ï„Î±). Î”ÎµÎ½ Î±Î»Î»Î¬Î¶Î¿Ï…Î½ Ï„Î¿Ï…Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚ Ï„Î¿Ï… ÎºÏÏÎ¹Î¿Ï… ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï….">
<button class="mini-btn hdr-btn cohz cohz-wind" data-hz="wind" onclick="toggleCoHazard('wind')" type="button">+Î†Î½ÎµÎ¼Î¿Ï‚</button>
<button class="mini-btn hdr-btn cohz cohz-rain" data-hz="rain" onclick="toggleCoHazard('rain')" type="button">+Î’ÏÎ¿Ï‡Î®</button>
<button class="mini-btn hdr-btn cohz cohz-heatwave" data-hz="heatwave" onclick="toggleCoHazard('heatwave')" type="button">+ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</button>
<button class="mini-btn hdr-btn cohz cohz-frost_snow" data-hz="frost_snow" onclick="toggleCoHazard('frost_snow')" type="button">+Î Î±Î³ÎµÏ„ÏŒÏ‚</button>
</div>
<button class="mini-btn hdr-btn btn-live-off" id="btnLiveStation" onclick="toggleLive()" title="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Î±Î½Î¬ 90s">Live OFF</button>
<button class="mini-btn hdr-btn btn-local-off" id="btnLocalScenario" onclick="toggleLocalScenario()" title="Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÎ¿Ï ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…">Local Scenario OFF</button>
<div class="ai-dd" id="aiTargetGroup" title="AI Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ (Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹)">
<select class="mini-btn hdr-btn ai-select ai-chatgpt" id="aiProviderSelect" onchange="setAITarget(this.value)" title="AI: ChatGPT/Gemini (Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹)">
<option value="chatgpt">AI: ChatGPT</option>
<option value="gemini">AI: Gemini</option>
</select>
</div>
<button class="mini-btn hdr-btn btn-ai" id="btnAIAnalysis" onclick="runAIAnalysis(event)" title="Î£Ï…Î»Î»Î¿Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ &amp; Î±Î½Î¬Î»Ï…ÏƒÎ· Î¼Îµ AI (Shift+Click = EXTRA FULL)">AI analysis</button>
<input id="localScenarioToggle" style="display:none" type="checkbox">
</input></div>
</div>
</div>
</details>
</div>
</div><div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="monitorPanelDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;">
              ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚ (Monitor)
            </summary>
<div class="monitor-panel-body">
<details id="primaryStationDetails" style="margin:0;">
<summary class="station-summary" id="stationSummary" style="cursor:pointer;margin-bottom:6px;">
<span class="station-meta-line" id="stationMetaLine">
<span class="meta-item name-item"><span id="stationName">â€”</span><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveUrl()" title="Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”—</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveMap()" title="Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·">ğŸ“</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();refreshPrimaryOnly(this)" title="Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï)">âŸ³</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetPrimaryStationQuick()" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï">âŸ²</button></span>
<span class="meta-item"><b>Timestamp:</b> <span id="stationTimestampInline">â€”</span></span>
<span class="meta-item"><b>LAT:</b> <span id="stationLat">â€”</span></span>
<span class="meta-item"><b>LON:</b> <span id="stationLon">â€”</span></span>
<span class="meta-item"><b>ELEV:</b> <span id="stationElev">â€”</span></span>
<span style="display:none"><b>Timestamp:</b> <span id="stationTimestamp">â€”</span></span>
</span>
</summary>
<div id="primaryStationContent">
<div class="latest-row" id="stationLatestRow">
<div class="latest-chips" id="stationLatestChips">â€”</div>
<span class="latest-text" id="stationLatestValues">â€”</span>
</div>
<div class="station-mini">
<div class="station-card">
<div class="t">Î’ÏÎ¿Ï‡Î® (mm/h)</div>
<div class="v"><span id="stationRainRate">â€”</span></div>
</div>
<div class="station-card">
<div class="t">Î”P (mm) <span id="stationTotalSrc" style="font-size:10px;color:#6b7a86"></span></div>
<div class="v"><span id="stationDP">â€”</span></div>
</div>
<div class="station-card">
<div class="t">R60 (mm)</div>
<div class="v"><span id="stationR60">â€”</span></div>
</div>
</div>
<div class="station-actions no-print">
<button class="mini-btn btn-auto-default" id="btnAutoStation" onclick="applyAutoI()">Load</button>
<button class="mini-btn btn-gray" id="btnClearStation" onclick="clearStationSeries()">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
</div>
<div id="stationMsg" style="font-size:10px;color:#6b7a86;margin-top:6px;font-style:italic;">â€”</div>
</div>
</details>
<div id="stationMultiList" style="margin-top:10px; display:none;"></div>
<details id="seriesDetails" style="margin-top:10px;">
<summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;">
<span>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï</span>
<span id="seriesStationName" style="font-weight:800;color:#b03030;margin-left:6px;">â€”</span>
<button class="meta-icon-btn no-print" id="btnSeriesOpenPrimary" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveUrl()" title="Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”—</button>
<button class="meta-icon-btn no-print" id="btnSeriesMapPrimary" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveMap()" title="Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·">ğŸ“</button>
<button class="meta-icon-btn no-print" id="btnSeriesRefreshPrimary" onclick="event.preventDefault();event.stopPropagation();refreshPrimaryOnly(this)" title="Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï)">âŸ³</button>
<span style="margin-left:6px;"><b>Timestamp:</b> <span id="seriesTimestampInline">â€”</span></span>
<span style="margin-left:6px;"><b>LAT:</b> <span id="seriesLat">â€”</span></span>
<span style="margin-left:6px;"><b>LON:</b> <span id="seriesLon">â€”</span></span>
<span style="margin-left:6px;"><b>ELEV:</b> <span id="seriesElev">â€”</span></span>
</summary>
<div class="db-controls no-print" id="seriesControls" style="margin:8px 0 10px">
<span style="font-weight:700">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚:</span>
<input class="db-limit" id="seriesLimit" max="500" min="1" type="number" value="50"/>
<button class="mini-btn btn-gray" id="btnSeriesLoad" title="Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ N ÎµÎ³Î³ÏÎ±Ï†ÏÎ½ Î±Ï€ÏŒ DB ÎºÎ±Î¹ ÏƒÏ…Î³Ï‡ÏÎ½ÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ monitoring">Load DB</button>
<button class="mini-btn btn-gray" id="btnSeriesExport" title="Î•Î¾Î±Î³Ï‰Î³Î® CSV (Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î· Ï€ÏÎ¿Î²Î¿Î»Î®)">Export CSV</button>
<button class="mini-btn btn-gray" id="btnSeriesView" title="Î•Î½Î±Î»Î»Î±Î³Î® Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ ÏƒÏ„Î·Î»ÏÎ½ (ÎºÎ¿Î¹Î½Î® Î¼Îµ DB)">Î ÏÎ¿Î²Î¿Î»Î®: BASIC</button>
<button class="mini-btn btn-gray" id="btnSeriesFilters" title="Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï†Î¯Î»Ï„ÏÏ‰Î½">Î¦Î¯Î»Ï„ÏÎ¿: ON</button>
<button class="mini-btn btn-gray" id="btnSeriesClearFilters" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï†Î¯Î»Ï„ÏÏ‰Î½" type="button">Clear</button>
<span class="db-status" id="seriesStatus" style="margin-left:auto">â€”</span>
</div>
<div class="db-table-wrap">
<table class="db-table" id="seriesTable">
<thead>
<tr id="seriesHeadRow"></tr>
<tr class="db-filter-row" id="seriesFilterRow"></tr>
</thead>
<tbody id="seriesRows">
<tr><td colspan="99" style="color:#6b7a86;font-style:italic">â€”</td></tr>
</tbody>
</table>
</div>
</details>
<details id="dbSeriesDetails" style="margin-top:10px;">
<summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;">
<span>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Î’Î¬ÏƒÎ· (DB)</span>
<span id="dbSeriesSummaryName" style="color:#6b7a86;margin-left:6px"></span>
</summary>
<div class="db-controls no-print">
<label style="font-size:11px;color:#6b7a86;font-weight:800">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚:</label>
<input class="db-limit" id="dbLimit" max="500" min="1" type="number" value="50">
<button class="mini-btn btn-gray" id="btnDbLoad" title="Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ Firestore">Load DB</button>
<button class="mini-btn btn-gray" id="btnDbImport" title="Î“Î­Î¼Î¹ÏƒÎµ Ï„Î¿ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ (buffer) Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·">Import â†’ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</button>
<button class="mini-btn btn-gray" id="btnDbExport" title="Î•Î¾Î±Î³Ï‰Î³Î® CSV">Export CSV</button>
<button class="mini-btn btn-gray" id="btnDbView" title="Î•Î½Î±Î»Î»Î±Î³Î® Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ ÏƒÏ„Î·Î»ÏÎ½">Î ÏÎ¿Î²Î¿Î»Î®: BASIC</button>
<button class="mini-btn btn-gray" id="btnDbFilters" title="Excel-style Ï†Î¯Î»Ï„ÏÎ± Î±Î½Î¬ ÏƒÏ„Î®Î»Î·">Î¦Î¯Î»Ï„ÏÎ¿: ON</button>
<button class="mini-btn btn-gray" id="btnDbClearFilters" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï†Î¯Î»Ï„ÏÏ‰Î½" type="button">Clear</button>
<span class="db-status" id="dbStatus">â€”</span>
</input></div>
<div class="db-table-wrap">
<table class="db-table" id="dbTable">
<thead>
<tr id="dbHeadRow"></tr>
<tr class="db-filter-row" id="dbFilterRow"></tr>
</thead>
<tbody id="dbRows"><tr><td colspan="8" style="color:#6b7a86;font-style:italic">â€”</td></tr></tbody>
</table>
</div>
</details>
</div>
</details>
</div><div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="coHazardsPanelDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;">
<span class="summary-flex">
<span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span>
<span class="summary-right">
<span class="cohazards-badges" id="coHazardsBadges"></span>
<button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½" type="button">âŸ²</button>
</span>
</span>
</summary>
<div class="cohazards-panel-body">
<div class="cohazards-global" id="coHazardsGlobal">
<div class="cohazards-panel-inner">
<div class="cohazards-metrics" id="coHazardsMetrics">â€”</div>
<div class="cohazards-note">*Î¤Î± ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î¼Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÎ¬. ÎŸÎ¹ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯/Ï€Î¯Î½Î±ÎºÎµÏ‚ ÎºÎ¬Ï„Ï‰ Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ½ Ï„Î¿ <b>ÎšÏÏÎ¹Î¿ Î£ÎµÎ½Î¬ÏÎ¹Î¿</b>.</div>
</div>
</div>
</div>
</details>
</div><div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="boundariesPanelDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±: <span id="selectedBoundaryName">â€”</span></span><span class="summary-right"><button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedBoundary()" title="Reset" type="button">âŸ²</button></span></span></summary>
<div class="monitor-panel-body" style="margin-top:0">
<div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î”Î¹Î¬Î»ÎµÎ¾Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±</b> (<span class="ico-map">ğŸ—º</span> Map Î® ğŸ‘ On) ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ <b>â•</b> ÏƒÏ„Î·Î½ ÎºÎµÏ†Î±Î»Î¯Î´Î± Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
</div>
</details>
</div><div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="streamsPanelDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿: <span id="selectedStreamName">â€”</span></span><span class="summary-right"><button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedStream()" title="Reset" type="button">âŸ²</button></span></span></summary>
<div class="monitor-panel-body" style="margin-top:0">
<div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î”Î¹Î¬Î»ÎµÎ¾Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿</b> (<span class="ico-map">ğŸ—º</span> Map Î® ğŸ‘ On) ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ <b>â•</b> ÏƒÏ„Î·Î½ ÎºÎµÏ†Î±Î»Î¯Î´Î± Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
</div>
</details>
</div><div class="box top-panel-box scenario-area-panel" style="background:#97c9d1;border-color:#dfe7ee">
<details id="selectedZoneDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;">
<span class="summary-flex">
<span class="summary-left">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·: <span id="selectedBasinName">â€”</span></span>
<span class="summary-right">
<button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedZone()" title="Reset" type="button">âŸ²</button>
</span>
</span>
</summary>
<div class="monitor-panel-body" style="margin-top:0">
<div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.6);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î”Î¹Î¬Î»ÎµÎ¾Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</b> (<span class="ico-map">ğŸ—º</span> Map Î® ğŸ‘ On) ÎºÎ±Î¹ Ï€Î¬Ï„Î·ÏƒÎµ <b>â•</b> ÏƒÏ„Î·Î½ ÎºÎµÏ†Î±Î»Î¯Î´Î± Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
</div>
</details>
</div></div></section><section class="panel-card scenario-card"><div class="panel-topbar"><div style="display:flex;align-items:center;gap:10px;white-space:nowrap;">Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÏŒ Î£ÎµÎ½Î¬ÏÎ¹Î¿</div><button class="icon-btn" onclick="toggleCollapse('scenarioCardBody', this)">âˆ’</button></div><div id="scenarioCardBody"><div id="scenarioArea">
<div class="scenario-panel" id="panel_rain">
<div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="rainScenarioDetails" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="Î’ÏÎ¿Ï‡Î®">Î’ÏÎ¿Ï‡Î®</span></span></span></summary>
<div class="scenario-area-body">
<details class="scenario-cohazards-details" open="">
<summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span class="cohazards-badges" id="coHazardsBadges_ctx_rain"></span><button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½" type="button">âŸ²</button></span></span></summary>
<div class="cohazards-context-box">
<div class="cohazards-panel-inner">
<div class="cohazards-metrics" id="coHazardsMetrics_ctx_rain">â€”</div>
<div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
</div>
</div>
</details>
<div class="grid-2">
<div class="box" style="background:#fff3cd;border-color:#f1d27a">
<div class="row">
<label>ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
<input id="rainI" step="0.1" type="number" value="0"/>
</div>
<div class="row">
<label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label>
<input id="rainD" step="0.1" type="number" value="0"/>
</div>
<div style="font-size:11px;color:#6b7a86;text-align:right;">
            *Î‘Î½ D=0 â†’ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Tc (ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ 5 min)
          </div>
</div>
<div class="box" style="background:#f8fbff;border-color:#d6e6ff">
<h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
<div class="row"><label>ÎˆÎ½Ï„Î±ÏƒÎ· i:</label><div class="ro" id="rainSumI">â€”</div></div>
<div class="row"><label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼ÎµÎ½Î·):</label><div class="ro" id="rainSumDused">â€”</div></div>
<div class="row"><label>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Ï…ÎµÏ„ÏŒÏ‚ (mm):</label><div class="ro" id="rainSumP">â€”</div></div>
<div class="row"><label>Qpeak:</label><div class="ro" id="rainSumQpeak">â€”</div></div>
<div class="row"><label>ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î­Î½Î±Î½Ï„Î¹ Qcap:</label><div class="ro" id="rainSumRisk">â€”</div></div>
</div>
</div>
<div class="panels-row">
<div class="box" style="background:#eaf7ff;border-color:#bfe4ff">
<h3>1. Î“Î•Î©ÎœÎ•Î¤Î¡Î™Î‘</h3>
<div class="row"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input id="area" step="1" type="number" value="0"/></div>
<div class="row"><label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ¿Î®Ï‚ L (m):</label><input id="length" step="1" type="number" value="0"/></div>
<div class="row"><label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†Î¿ÏÎ¬ H (m):</label><input id="height" step="0.1" type="number" value="0"/></div>
<div class="row"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input id="coef" step="0.01" type="number" value="0.40"/></div>
<div style="margin-top:10px">
<canvas height="180" id="basinCanvas" width="340"></canvas>
</div>
</div>
<div class="box" style="background:#eef9f1;border-color:#cfeee0">
<h3>2. Î£Î¥Î›Î›ÎŸÎ“Î— (Î¦Î¡Î•Î‘Î¤Î™Î‘)</h3>
<div class="row"><label>Î Î»Î®Î¸Î¿Ï‚:</label><input id="drains" step="1" type="number" value="0"/></div>
<div class="row"><label>Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿ (mÂ³/s):</label><input id="drainCap" step="0.01" type="number" value="0"/></div>
<div style="font-size:11px;color:#6b7a86;margin-top:6px">
            *Qcap_Î´Î¹ÎºÏ„ÏÎ¿Ï… = Ï€Î»Î®Î¸Î¿Ï‚ Ã— Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿
          </div>
</div>
<div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
<h3>3. Î”Î™ÎŸÎ”Î•Î¥Î£Î— (Î¡Î•ÎœÎ‘)</h3>
<div class="row"><label>Î Î»Î¬Ï„Î¿Ï‚ Ï€Ï…Î¸Î¼Î­Î½Î± b (m):</label><input id="strWidth" step="0.1" type="number" value="0"/></div>
<div class="row"><label>Î Î»Î¬Î³Î¹ÎµÏ‚ ÎºÎ»Î¯ÏƒÎµÎ¹Ï‚ z (H:V):</label><input id="strZ" step="0.1" type="number" value="0"/></div>
<div class="row"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input id="strDepth" step="0.1" type="number" value="0"/></div>
<div class="row">
<label>n (Manning):</label>
<select id="strType">
<option value="0.030">0.030 (Î£ÎºÏ…ÏÏŒÎ´ÎµÎ¼Î±)</option>
<option value="0.035">0.035 (ÎœÎµÎ¹ÎºÏ„ÏŒ/Î¤ÏÎ±Ï‡Ï)</option>
<option value="0.045">0.045 (Î¦Ï…ÏƒÎ¹ÎºÎ® ÎºÎ¿Î¯Ï„Î·)</option>
<option value="0.060">0.060 (Î Î¿Î»Ï Ï„ÏÎ±Ï‡Ï)</option>
</select>
</div>
<div class="row"><label>ÎœÎ®ÎºÎ¿Ï‚ (m) (0=L):</label><input id="strLen" step="1" type="number" value="0"/></div>
<div class="row"><label>Î Ï„ÏÏƒÎ· (m) (0=H):</label><input id="strDrop" step="0.1" type="number" value="0"/></div>
<div class="row">
<label>ÎÏˆÎ¿Ï‚ Î½ÎµÏÎ¿Ï y (m):</label>
<input id="strY" placeholder="Auto" step="0.01" type="number" value=""/>
</div>
<div class="station-actions no-print" style="margin-top:6px">
<button class="mini-btn btn-gray" onclick="resetStrY()">Auto y</button>
<button class="mini-btn btn-map" onclick="openMapModal()">Î§Î¬ÏÏ„Î·Ï‚</button>
</div>
<div style="margin-top:10px">
<canvas height="180" id="channelCanvas" width="340"></canvas>
</div>
</div>
</div>
<div class="summary-box">
<div class="stat"><div class="k">ÎšÎ»Î¯ÏƒÎ· S</div><div class="v" id="res-slope">â€”</div></div>
<div class="stat"><div class="k">Tc (Kirpich)</div><div class="v" id="res-tc">â€”</div></div>
<div class="stat"><div class="k" style="color:#d35400">Qpeak</div><div class="v" id="res-qsel">â€”</div></div>
<div class="stat"><div class="k">Qcap Î”Î¹ÎºÏ„ÏÎ¿Ï…</div><div class="v" id="res-drains">â€”</div></div>
<div class="stat"><div class="k">Qcap Î¡Î­Î¼Î±Ï„Î¿Ï‚</div><div class="v" id="res-stream">â€”</div></div>
<div class="stat"><div class="k">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</div><div class="v" id="res-adequacy">â€”</div></div>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>i (mm/h)</th>
<th>D (min)</th>
<th>P (mm)</th>
<th>Qpeak (mÂ³/s)</th>
<th>V (mÂ³)</th>
<th>Î•Ï€Î¹ÎºÎ¹Î½Î´Ï…Î½ÏŒÏ„Î·Ï„Î±</th>
<th>Î”Î¯ÎºÏ„Ï…Î¿</th>
<th>Î¡Î­Î¼Î±</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
<div class="footer-grid">
<div class="legend">
<h4>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</h4>
<div style="font-size:12px;color:#2c3e50;font-weight:800;line-height:1.35">
            â€¢ Qpeak: ÎœÎ­Î¸Î¿Î´Î¿Ï‚ Rational (0.278Â·CÂ·iÂ·A_kmÂ²)<br/>
            â€¢ Tc: Kirpich (min) â€¢ D: Î±Î½ D=0 â†’ D= max(5, Tc)<br/>
            â€¢ Î¡Î­Î¼Î±: Manning ÏƒÎµ Ï„ÏÎ±Ï€ÎµÎ¶Î¿ÎµÎ¹Î´Î® Î´Î¹Î±Ï„Î¿Î¼Î® (b, z, h)<br/>
</div>
</div>
<div class="legend">
<h4>Î¥Ï€ÏŒÎ¼Î½Î·Î¼Î± (Peq = PÂ·C)</h4>
<div class="item"><span class="swatch" style="background:#eafaf1"></span> Î§Î±Î¼Î·Î»Î® (&lt;10 mm)</div>
<div class="item"><span class="swatch" style="background:#fff7e6"></span> ÎœÎ­Ï„ÏÎ¹Î± (10â€“25 mm)</div>
<div class="item"><span class="swatch" style="background:#ffe9d6"></span> Î¥ÏˆÎ·Î»Î® (25â€“40 mm)</div>
<div class="item"><span class="swatch" style="background:#ffe0e0"></span> Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î® (40â€“60 mm)</div>
<div class="item"><span class="swatch" style="background:#ffd1d1"></span> Î‘ÎºÏÎ±Î¯Î± (â‰¥60 mm)</div>
</div>
</div>
</div>
</details>
</div>
</div>
<div class="scenario-panel" id="panel_wind">
<div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="windScenarioDetails" open="" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="Î†Î½ÎµÎ¼Î¿Ï‚">Î†Î½ÎµÎ¼Î¿Ï‚</span></span></span></summary>
<div class="scenario-area-body">
<details class="scenario-cohazards-details" open="">
<summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span class="cohazards-badges" id="coHazardsBadges_ctx_wind"></span><button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½" type="button">âŸ²</button></span></span></summary>
<div class="cohazards-context-box">
<div class="cohazards-panel-inner">
<div class="cohazards-metrics" id="coHazardsMetrics_ctx_wind">â€”</div>
<div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
</div>
</div>
</details>
<div class="grid-2">
<div class="box" style="background:#e7f6ff;border-color:#b6e6ff">
<div class="row"><label>ÎŒÏÎ¹Î¿ Ï€ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (km/h):</label><input id="windWarnKmh" step="1" type="number" value="50"/></div>
<div class="row"><label>ÎŒÏÎ¹Î¿ Ï…ÏˆÎ·Î»Î¿Ï ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (km/h):</label><input id="windHighKmh" step="1" type="number" value="70"/></div>
<div style="font-size:11px;color:#6b7a86;text-align:right;">*Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î· Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î±Ï‡ÏÏ„Î·Ï„Î± (Î®/ÎºÎ±Î¹ ÏÎ¹Ï€Î® Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)</div>
</div>
<div class="box" style="background:#f8fbff;border-color:#d6e6ff">
<h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
<div class="row"><label>Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î±Ï‡ÏÏ„Î·Ï„Î±:</label><div class="ro" id="windNow">â€”</div></div>
<div class="row"><label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</label><div class="ro" id="windDir">â€”</div></div>
<div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</label><div class="ro" id="windRisk">â€”</div></div>
</div>
</div>
<div class="panels-row">
<div class="box" style="background:#f0fff4;border-color:#c9f2d5">
<h3>1. ÎˆÎºÎ¸ÎµÏƒÎ· / Î•Ï…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚</h3>
<div class="ops-list">
<ul>
<li>Î”Î­Î½Ï„ÏÎ±/ÎºÎ»Î±Î´Î¹Î¬ â€“ Ï€Î¬ÏÎºÎ±, Î´ÎµÎ½Î´ÏÎ¿ÏƒÏ„Î¿Î¹Ï‡Î¯ÎµÏ‚, ÏƒÏ‡Î¿Î»Î¹ÎºÎ­Ï‚ Î±Ï…Î»Î­Ï‚</li>
<li>Î Î¹Î½Î±ÎºÎ¯Î´ÎµÏ‚, ÏƒÏ„Î­Î³Î±ÏƒÏ„ÏÎ±, ÎºÎ¬Î´Î¿Î¹, Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î­Ï‚ ÎºÎ±Ï„Î±ÏƒÎºÎµÏ…Î­Ï‚</li>
<li>Î•ÏÎ³Î¿Ï„Î¬Î¾Î¹Î±/ÏƒÎºÎ±Î»Ï‰ÏƒÎ¹Î­Ï‚, ÎµÎ»Î±Ï†ÏÎ¹Î­Ï‚ ÏƒÏ„Î­Î³ÎµÏ‚, Ï…Î»Î¹ÎºÎ¬ ÏƒÏ„Î¿ ÏÏ€Î±Î¹Î¸ÏÎ¿</li>
</ul>
</div>
</div>
<div class="box" style="background:#fff7e6;border-color:#f2d3a0">
<h3>2. Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÎ­Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</h3>
<div class="ops-list">
<ul>
<li>Î ÎµÏÎ¹Ï€Î¿Î»Î¯ÎµÏ‚ ÏƒÎµ ÎµÏ…Ï€Î±Î¸Î® ÏƒÎ·Î¼ÎµÎ¯Î± (Î´Î­Î½Ï„ÏÎ±/Ï€Î¹Î½Î±ÎºÎ¯Î´ÎµÏ‚)</li>
<li>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÏÎ³Î¿Ï„Î±Î¾Î¯Ï‰Î½ Î³Î¹Î± Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ· Ï…Î»Î¹ÎºÏÎ½</li>
<li>Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± ÏƒÏ…Î½ÎµÏÎ³ÎµÎ¯Ï‰Î½ Î³Î¹Î± Ï€Ï„ÏÏƒÎµÎ¹Ï‚ ÎºÎ»Î±Î´Î¹ÏÎ½/Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Ï‰Î½</li>
</ul>
</div>
</div>
<div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
<h3>3. Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / Î¤Î¿Ï€Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</h3>
<div class="row"><label>Hotspot:</label><input id="windHotspot" placeholder="Ï€.Ï‡. Î Î¬ÏÎºÎ¿, ÎºÎµÎ½Ï„ÏÎ¹ÎºÎ­Ï‚ Î»ÎµÏ‰Ï†ÏŒÏÎ¿Î¹, ÎµÏÎ³Î¿Ï„Î¬Î¾Î¹Î¿â€¦"/></div>
<div class="row"><label>Î£Ï‡ÏŒÎ»Î¹Î¿:</label><input id="windNote" placeholder="ÏƒÏÎ½Ï„Î¿Î¼Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·â€¦"/></div>
</div>
</div>
</div>
</details>
</div>
</div>
<div class="scenario-panel" id="panel_heatwave">
<div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
<details id="heatwaveScenarioDetails" open="" style="margin:0;">
<summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚">ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</span></span></span></summary>
<div class="scenario-area-body">
<details class="scenario-cohazards-details" open="">
<summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span class="cohazards-badges" id="coHazardsBadges_ctx_heatwave"></span><button class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½" type="button">âŸ²</button></span></span></summary>
<div class="cohazards-context-box">
<div class="cohazards-panel-inner">
<div class="cohazards-metrics" id="coHazardsMetrics_ctx_heatwave">â€”</div>
<div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
</div>
</div>
</details>
<div class="grid-2">
<div class="box" style="background:#fff3cd;border-color:#f1d27a">
<div class="row"><label>ÎŒÏÎ¹Î¿ Î¼Î­Ï„ÏÎ¹Î¿Ï… ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Â°C HI):</label><input id="heatWarnHI" step="0.1" type="number" value="37"/></div>
<div class="row"><label>ÎŒÏÎ¹Î¿ Ï…ÏˆÎ·Î»Î¿Ï ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Â°C HI):</label><input id="heatHighHI" step="0.1" type="number" value="41"/></div>
<div style="font-size:11px;color:#6b7a86;text-align:right;">*HI = Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚/Heat Index (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)</div>
</div>
<div class="box" style="background:#fff7f7;border-color:#ffd1d1">
<h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
<div class="row"><label>Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±:</label><div class="ro" id="heatTempNow">â€”</div></div>
<div class="row"><label>Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚ (HI):</label><div class="ro" id="heatIndexNow">â€”</div></div>
<div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</label><div class="ro" id="heatRisk">â€”</div></div>
</div>
</div>
<div class="panels-row">
<div class="box" style="background:#f0fff4;border-color:#c9f2d5">
<h3>1. Î•Ï…Î¬Î»Ï‰Ï„Î¿Î¹ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Î¯ / ÏƒÎ·Î¼ÎµÎ¯Î±</h3>
<div class="ops-list">
<ul>
<li>Î—Î»Î¹ÎºÎ¹Ï‰Î¼Î­Î½Î¿Î¹, Ï€Î±Î¹Î´Î¹Î¬, Î¬Ï„Î¿Î¼Î± Î¼Îµ Ï‡ÏÏŒÎ½Î¹Î± Î½Î¿ÏƒÎ®Î¼Î±Ï„Î±</li>
<li>Î•ÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿Î¹ ÏƒÎµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¿ÏÏ‚ Ï‡ÏÏÎ¿Ï…Ï‚</li>
<li>Î ÎµÏÎ¹Î¿Ï‡Î­Ï‚ Î¼Îµ Ï‡Î±Î¼Î·Î»Î® ÏƒÎºÎ¯Î±ÏƒÎ·/Ï…ÏˆÎ·Î»Î® Î¸ÎµÏÎ¼Î¹ÎºÎ® Î½Î·ÏƒÎ¯Î´Î±</li>
</ul>
</div>
</div>
<div class="box" style="background:#e7f6ff;border-color:#b6e6ff">
<h3>2. ÎœÎ­Ï„ÏÎ± Î”Î®Î¼Î¿Ï…</h3>
<div class="ops-list">
<ul>
<li>Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±/ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ»Î¹Î¼Î±Ï„Î¹Î¶ÏŒÎ¼ÎµÎ½Ï‰Î½ Ï‡ÏÏÏ‰Î½ (cooling centers)</li>
<li>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î´Î·Î¼Î¿Ï„ÏÎ½ (ÎµÎ½Ï…Î´Î¬Ï„Ï‰ÏƒÎ·, Î±Ï€Î¿Ï†Ï…Î³Î® Î­ÎºÎ¸ÎµÏƒÎ·Ï‚ 12:00â€“17:00)</li>
<li>Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± Î³Î¹Î± ÎµÏ…Ï€Î±Î¸ÎµÎ¯Ï‚ Î´Î¿Î¼Î­Ï‚ (ÎšÎ‘Î Î—, ÏƒÏ‡Î¿Î»ÎµÎ¯Î±, Î´Î¿Î¼Î­Ï‚ Ï†Î¹Î»Î¿Î¾ÎµÎ½Î¯Î±Ï‚)</li>
</ul>
</div>
</div>
<div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
<h3>3. Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / Î¤Î¿Ï€Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</h3>
<div class="row"><label>Hotspot:</label><input id="heatHotspot" placeholder="Ï€.Ï‡. Ï€Î»Î±Ï„ÎµÎ¯ÎµÏ‚ Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÎºÎ¹Î¬, Î³ÎµÎ¹Ï„Î¿Î½Î¹Î­Ï‚â€¦"/></div>
<div class="row"><label>Î£Ï‡ÏŒÎ»Î¹Î¿:</label><input id="heatNote" placeholder="ÏƒÏÎ½Ï„Î¿Î¼Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·â€¦"/></div>
</div>
</div>
</div>
</details>
</div>
</div>

</div><div class="scenario-panel" id="panel_frost_snow">
</div></div></section></main>
</div>
<!-- ================= Map Modal ================= -->
<div class="no-print" id="mapModal">
<div id="mapCard">
<div id="mapTop">
<div><span class="ico-map">ğŸ—º</span> Î ÏÎ¿Î²Î¿Î»Î® Î§Î¬ÏÏ„Î· (Ï€Î¿Î»Î»Î±Ï€Î»Î¬ layers)</div>
<div style="display:flex; gap:8px; align-items:center;">
<button class="mini-btn btn-gray" onclick="turnAllOff()">Off ÏŒÎ»Î±</button>
<button class="mini-btn btn-gray" onclick="closeMapModal()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
</div>
</div>
<div id="mapBox"></div>
</div>

</div>


<script>
/* ===================== CONFIG ===================== */
const GH_USER   = 'petrsanidas-ui';
const GH_REPO   = 'nireas';
const GH_BRANCH = 'main';
const API_TREE  = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/git/trees/${GH_BRANCH}?recursive=1`;
const RAW_URL   = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/`;

let DATA_GROUPS = { boundaries: [], streams: [], basins: [] }; // NOTE ORDER
let SELECTED_GEO = null;
let SELECTED_BASIN_KEY = null;
let SELECTED_ZONE_KEY = null;
let SELECTED_ZONE_NAME = null;
let SELECTED_ZONE_KIND = null; // 'basin' | 'boundary'
let SELECTED_BOUNDARY_KEY = null;
let SELECTED_BOUNDARY_NAME = null;
let SELECTED_BOUNDARY_GEO = null;
let SELECTED_STREAM_KEY = null;
let SELECTED_STREAM_NAME = null;
let SELECTED_STREAM_GEO = null;
let STATION_SELECT_BOUND = false; // bind dropdown change listener once
let MULTI_DETAILS_OPEN = true; // remember collapse state for "Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯"


let MULTI_RESULTS_BY_URL = new Map(); // url -> last fetched result (for per-station refresh)
/* ===== Map state (multi-layer) ===== */
let map = null;
let baseLayer = null;
const GEO_CACHE = new Map();       // path -> geojson
const LAYER_CACHE = new Map();     // path -> leaflet layer
const VISIBLE = new Set();         // paths currently "On"
let PREVIEW_LAYER = null;          // temporary layer for Map button preview

/* ===== Selected Meteo Stations layer (map) ===== */
const STATIONS_META = new Map();   // url -> {name,url,lat,lon,elev}
let METEO_PRIMARY_VISIBLE = false;
let METEO_WATCH_VISIBLE = false;
let METEO_STATIONS_LAYER = null;  // persistent selected markers layer
let METEO_STATIONS_PREVIEW = null;// preview-only layer (Map button)
const METEO_MARKERS = new Map();  // url -> Leaflet marker (persistent)

function getSelectedStationUrls(){
  const out = [];
  const p = getPrimaryStationUrl ? getPrimaryStationUrl() : '';
  if(p) out.push(p);
  try{
    if(typeof watchlist !== 'undefined' && watchlist && watchlist.size){
      for(const u of watchlist.keys()) out.push(u);
    }
  }catch(_){}
  return Array.from(new Set(out));
}

function meteoIcons(){
  // cache once
  if(meteoIcons._cache) return meteoIcons._cache;
  const extra = L.divIcon({
    className:'station-divicon',
    html:'<div class="station-pin-wrap"><div class="station-pin"></div></div>',
    iconSize:[16,16],
    iconAnchor:[8,8]
  });
  const primary = L.divIcon({
    className:'station-divicon',
    html:'<div class="station-pin-wrap"><div class="station-pin primary"></div></div>',
    iconSize:[18,18],
    iconAnchor:[9,9]
  });
  meteoIcons._cache = { extra, primary };
  return meteoIcons._cache;
}

function ensureMeteoStationsLayer(){
  if(!METEO_STATIONS_LAYER) METEO_STATIONS_LAYER = L.layerGroup();
  return METEO_STATIONS_LAYER;
}

function clearMeteoStationsPreview(){
  if(METEO_STATIONS_PREVIEW && map && map.hasLayer(METEO_STATIONS_PREVIEW)){
    map.removeLayer(METEO_STATIONS_PREVIEW);
  }
  METEO_STATIONS_PREVIEW = null;
}

async function refreshSelectedMeteoMarkers(){
  // Build / update persistent marker cache for:
  // - Primary station (if selected)
  // - Watchlist stations
  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';

  // Watchlist URLs (exclude primary if duplicated)
  let watchUrls = [];
  try{
    if(watchlist && watchlist.size){
      watchUrls = Array.from(watchlist.keys()).filter(u => u && u !== primaryUrl);
    }
  }catch(_){}

  const urls = Array.from(new Set([ ...(primaryUrl ? [primaryUrl] : []), ...watchUrls ]));
  const keep = new Set(urls);

  // remove stale markers from cache + layer
  for(const [u, mk] of Array.from(METEO_MARKERS.entries())){
    if(!keep.has(u)){
      try{ ensureMeteoStationsLayer().removeLayer(mk); }catch(_){}
      METEO_MARKERS.delete(u);
    }
  }

  const icons = meteoIcons();

  // add missing markers to cache (NOT necessarily visible)
  for(const u of urls){
    if(METEO_MARKERS.has(u)) continue;

    // special fallback for Openâ€‘Meteo token (shows approx Chalandri)
    let meta = STATIONS_META.get(u);
    if(!meta && u === OPEN_METEO_TOKEN){
      meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
    }
    if(!meta || meta.lat == null || meta.lon == null) continue;

    const icon = (u === primaryUrl) ? icons.primary : icons.extra;
    const mk = L.marker([meta.lat, meta.lon], { icon });

    const elevTxt = (meta.elev != null && !Number.isNaN(meta.elev)) ? `${meta.elev} m` : 'â€”';
    mk.bindPopup(`<b>${meta.name || 'Î£Ï„Î±Î¸Î¼ÏŒÏ‚'}</b><br/>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿: ${elevTxt}<br/><a href="${meta.url === OPEN_METEO_TOKEN ? '#' : meta.url}" target="_blank">Î†Î½Î¿Î¹Î³Î¼Î± link</a>`);

    METEO_MARKERS.set(u, mk);
  }

  // sync marker membership inside the persistent layer (based on independent On/Off)
  const layer = ensureMeteoStationsLayer();
  for(const [u, mk] of METEO_MARKERS.entries()){
    const isPrimary = (primaryUrl && u === primaryUrl);
    const shouldShow = isPrimary ? !!METEO_PRIMARY_VISIBLE : !!METEO_WATCH_VISIBLE;
    try{
      if(shouldShow){
        if(!layer.hasLayer(mk)) layer.addLayer(mk);
      }else{
        if(layer.hasLayer(mk)) layer.removeLayer(mk);
      }
    }catch(_){}
  }

  // if map open, add/remove whole layer depending on any visibility
  if(map){
    const anyVisible = !!METEO_PRIMARY_VISIBLE || !!METEO_WATCH_VISIBLE;
    if(anyVisible){
      if(!map.hasLayer(layer)) layer.addTo(map);
    }else{
      if(map.hasLayer(layer)) map.removeLayer(layer);
    }
  }
}


function setOnOffBtn(btn, on){
  if(!btn) return;
  btn.innerHTML = `<span class="ico-eye">ğŸ‘</span> ${on ? "On" : "Off"}`;
  btn.classList.toggle("btn-on", !!on);
  btn.classList.toggle("btn-off", !on);
  btn.classList.add("map-only-btn");
}


  function updateMeteoPrimaryOnOffBtn(){
  const btn = document.getElementById('btn-onoff-meteoStations-2');
  if(btn) setOnOffBtn(btn, !!METEO_PRIMARY_VISIBLE);
}
function updateMeteoWatchOnOffBtn(){
  const btn = document.getElementById('btn-onoff-meteoStations');
  if(btn) setOnOffBtn(btn, !!METEO_WATCH_VISIBLE);
}

// Backward-compatible helper name used elsewhere
function updateMeteoStationsRowButton(){
  updateMeteoPrimaryOnOffBtn();
  updateMeteoWatchOnOffBtn();
}

function toggleMeteoPrimaryLayer(){
  METEO_PRIMARY_VISIBLE = !METEO_PRIMARY_VISIBLE;
  updateMeteoPrimaryOnOffBtn();
  if(map) refreshSelectedMeteoMarkers();
  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}

function toggleMeteoWatchLayer(){
  METEO_WATCH_VISIBLE = !METEO_WATCH_VISIBLE;
  updateMeteoWatchOnOffBtn();
  if(map) refreshSelectedMeteoMarkers();
  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}

async function meteoStationsLoad(){
  // Refresh markers cache; do not open map, do not change On/Off
  await refreshSelectedMeteoMarkers();
}

async function meteoPrimaryMap(){
  // Preview PRIMARY station on map WITHOUT changing On/Off
  openMapModal();
  clearMeteoStationsPreview();

  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';
  if(!primaryUrl){
    try{ setStationMsg('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)'); }catch(_){}
    return;
  }

  const icons = meteoIcons();
  const grp = L.layerGroup();
  const pts = [];

  let meta = STATIONS_META.get(primaryUrl);
  if(!meta && primaryUrl === OPEN_METEO_TOKEN){
    meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:primaryUrl, lat:38.0237, lon:23.8007, elev:null };
  }

  if(meta && meta.lat != null && meta.lon != null){
    const mk = L.marker([meta.lat, meta.lon], { icon: icons.primary });
    const elevTxt = (meta.elev != null && !Number.isNaN(meta.elev)) ? `${meta.elev} m` : 'â€”';
    mk.bindPopup(`<b>${meta.name || 'ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚'}</b><br/>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿: ${elevTxt}`);
    mk.addTo(grp);
    pts.push([meta.lat, meta.lon]);
  }

  METEO_STATIONS_PREVIEW = grp.addTo(map);

  if(map && pts.length){
    try{
      map.setView([pts[0][0], pts[0][1]], 13);
    }catch(_){}
  }
}

async function meteoWatchMap(){
  // Preview WATCHLIST stations on map WITHOUT changing On/Off
  openMapModal();
  clearMeteoStationsPreview();

  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';
  let urls = [];
  try{
    if(watchlist && watchlist.size){
      urls = Array.from(watchlist.keys()).filter(u => u && u !== primaryUrl);
    }
  }catch(_){}

  if(!urls.length){
    try{ setStationMsg('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: (ÎºÎ±Î½Î­Î½Î±Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚)'); }catch(_){}
    return;
  }

  const icons = meteoIcons();
  const grp = L.layerGroup();
  const pts = [];

  for(const u of urls){
    let meta = STATIONS_META.get(u);
    if(!meta && u === OPEN_METEO_TOKEN){
      meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
    }
    if(!meta || meta.lat == null || meta.lon == null) continue;

    const mk = L.marker([meta.lat, meta.lon], { icon: icons.extra });
    const elevTxt = (meta.elev != null && !Number.isNaN(meta.elev)) ? `${meta.elev} m` : 'â€”';
    mk.bindPopup(`<b>${meta.name || 'Î£Ï„Î±Î¸Î¼ÏŒÏ‚'}</b><br/>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿: ${elevTxt}`);
    mk.addTo(grp);
    pts.push([meta.lat, meta.lon]);
  }

  METEO_STATIONS_PREVIEW = grp.addTo(map);

  if(map && pts.length){
    try{
      const b = L.latLngBounds(pts.map(p=>L.latLng(p[0], p[1])));
      map.fitBounds(b, { padding:[20,20] });
    }catch(_){}
  }
}

async function meteoStationsMap(){
  // Preview selected stations on map WITHOUT changing On/Off
  openMapModal();
  clearMeteoStationsPreview();

  const urls = getSelectedStationUrls();
  const icons = meteoIcons();
  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';

  const grp = L.layerGroup();
  const pts = [];

  for(const u of urls){
    let meta = STATIONS_META.get(u);
    if(!meta && u === OPEN_METEO_TOKEN){
      meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
    }
    if(!meta || meta.lat == null || meta.lon == null) continue;

    const icon = (u === primaryUrl) ? icons.primary : icons.extra;
    const mk = L.marker([meta.lat, meta.lon], { icon });
    grp.addLayer(mk);
    pts.push([meta.lat, meta.lon]);
  }

  METEO_STATIONS_PREVIEW = grp;
  if(map && !map.hasLayer(grp)) grp.addTo(map);

  // fit to points if any
  if(map && pts.length){
    try{
      const b = L.latLngBounds(pts.map(p=>L.latLng(p[0], p[1])));
      map.fitBounds(b, { padding:[20,20] });
    }catch(_){}
  }
}

/* ===== End Meteo Stations layer ===== */

/* ===== Station monitor ===== */
const STATION_SERIES_DEFAULT = 50;
function getSeriesLimit(){
  const n = Number(document.getElementById('seriesLimit')?.value);
  const lim = (Number.isFinite(n) && n>0) ? n : STATION_SERIES_DEFAULT;
  return Math.max(1, Math.min(500, Math.floor(lim)));
}

// Per-station series contexts (do not mix histories across different primary stations)
const stationSeriesByKey  = Object.create(null);  // key -> array
const stationLastKeyByKey = Object.create(null);  // key -> last sample key
function trimAllStationSeriesToLimit(){
  const lim = getSeriesLimit();
  for(const k of Object.keys(stationSeriesByKey)){
    const arr = stationSeriesByKey[k];
    if(Array.isArray(arr) && arr.length > lim){
      arr.splice(0, arr.length - lim);
    }
  }
}
let currentStationKey = 'open-meteo';

let stationSeries = [];
let stationLastKey = null;

// initialize default context
stationSeriesByKey[currentStationKey] = stationSeries;
stationLastKeyByKey[currentStationKey] = stationLastKey;

let stationLiveOn = false;
const watchlist = new Map(); // url -> display name
let ACTIVE_PRIMARY_URL = '';
let ACTIVE_PRIMARY_NAME = '';

const LS_WATCHLIST_KEY = 'nireas_watchlist_v1';
const LS_CUSTOM_KEY   = 'nireas_customstations_v1';
const OPEN_METEO_TOKEN = '__OPEN_METEO__';
const ALL_API_TOKEN   = '__ALL_API__';
const ALL_WEB_TOKEN   = '__ALL_WEB__';
const ALL_ALL_TOKEN   = '__ALL_ALL__';

function getSelectGroupPairs(selectEl, groupLabel){
  const out = [];
  if(!selectEl) return out;
  const kids = Array.from(selectEl.children || []);
  for(const node of kids){
    if(node && node.tagName === 'OPTGROUP' && node.label === groupLabel){
      for(const opt of Array.from(node.children || [])){
        if(!opt || opt.tagName !== 'OPTION') continue;
        const url = String(opt.value || '').trim();
        if(!url) continue;
        if(url === ALL_API_TOKEN || url === ALL_WEB_TOKEN || url === ALL_ALL_TOKEN) continue;
        out.push({ url, name: String(opt.textContent || url).trim() });
      }
    }
  }
  return out;
}

/* ===== Model Scenario (for future model switching) ===== */
let MODEL_SCENARIO = ''; // rain | wind | heatwave | frost_snow | storm | dust_smoke | fog

function setModelScenario(val){
  MODEL_SCENARIO = (val == null) ? '' : String(val);
// reflect on UI (title only â€” calculations remain the same for now)
  const mapName = {
    rain:'Î’ÏÎ¿Ï‡Î®',
    wind:'Î†Î½ÎµÎ¼Î¿Ï‚',
    heatwave:'ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚',
    frost_snow:'Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±',
    storm:'ÎšÎ±Ï„Î±Î¹Î³Î¯Î´Î± / ÎšÎµÏÎ±Ï…Î½Î¿Î¯',
    dust_smoke:'Î£ÎºÏŒÎ½Î· / ÎšÎ±Ï€Î½ÏŒÏ‚',
    fog:'ÎŸÎ¼Î¯Ï‡Î»Î·'
  };
  const nice = mapName[MODEL_SCENARIO] || 'â€”';
  const t = document.getElementById('scenarioTitle');
  if(t) t.textContent = `Î£Î•ÎÎ‘Î¡Î™ÎŸ: ${nice}`;
  document.body.dataset.modelScenario = MODEL_SCENARIO || 'none';
  try{ applyScenarioUI(MODEL_SCENARIO); }catch(_){}

  try{ scheduleSaveUiState(); }catch(_){}

/* ===== Scenario-based UI: show only relevant panels (from 'Î›ÎµÎºÎ¬Î½Î· ÎºÎ±Î¹ ÎºÎ¬Ï„Ï‰') ===== */
function applyScenarioUI(scn){
  const val = (scn == null) ? '' : String(scn);

  const root = document.getElementById('scenarioArea');
  if(!root) return;

  const panels = root.querySelectorAll('.scenario-panel');

  // No scenario selected -> hide everything under "Î›ÎµÎºÎ¬Î½Î· ÎºÎ±Î¹ ÎºÎ¬Ï„Ï‰"
  if(!val){
    panels.forEach(p=>{
      p.classList.remove('active');
      try{ p.setAttribute('aria-hidden', 'true'); }catch(_){}
    });
    return;
  }

  const map = {
    rain: 'panel_rain',
    wind: 'panel_wind',
    heatwave: 'panel_heatwave',
    frost_snow: 'panel_frost_snow'
  };
  const target = map[val] || null;

  panels.forEach(p=>{
    const on = target ? (p.id === target) : false;
    p.classList.toggle('active', on);
    try{ p.setAttribute('aria-hidden', on ? 'false' : 'true'); }catch(_){}
  });

  // Keep "Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®" in sync with the currently selected basin (until we add dedicated area selection)
  try{
    const basin = document.getElementById('selectedBasinName')?.textContent?.trim() || 'â€”';
    const ids = ['selectedAreaName','selectedHeatAreaName','selectedFrostAreaName'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.textContent = basin;
    });
  }catch(_){}

  refreshScenarioPanels();
}

/* ===== Scenario mini-metrics (read-only) from latest primary sample ===== */
function __numFromText(txt){
  if(txt == null) return null;
  const s = String(txt).replace(',', '.');
  const m = s.match(/-?\d+(?:\.\d+)?/);
  return m ? Number(m[0]) : null;
}
function __fmt(v, unit=''){
  if(v==null || !Number.isFinite(v)) return 'â€”';
  const n = Math.round(v*10)/10;
  return `${n.toFixed(1)}${unit}`;
}
function __riskLabel(level, text){
  const map = {
    low:   "<span class='status-ok'>Î§Î±Î¼Î·Î»ÏŒÏ‚</span>",
    med:   "<span class='status-warn'>ÎœÎ­Ï„ÏÎ¹Î¿Ï‚</span>",
    high:  "<span class='status-fail'>Î¥ÏˆÎ·Î»ÏŒÏ‚</span>",
    ext:   "<span class='status-extreme'>Î‘ÎºÏÎ±Î¯Î¿Ï‚</span>",
    none:  "<span style='color:#6b7a86'>â€”</span>"
  };
  return map[level] ? map[level] + (text ? ` <span style="color:#6b7a86;font-weight:700">${text}</span>` : '') : (text || 'â€”');
}
function getLatestPrimarySample(){
  // Prefer the most recent snapshot (even if the history row was updated in-place).
  try{
    if(window.__PRIMARY_LATEST_SAMPLE && typeof window.__PRIMARY_LATEST_SAMPLE === 'object'){
      return window.__PRIMARY_LATEST_SAMPLE;
    }
  }catch(_){}

  try{
    if(typeof stationSeries !== 'undefined' && Array.isArray(stationSeries) && stationSeries.length){
      return stationSeries[stationSeries.length-1];
    }
    if(window.stationSeries && Array.isArray(window.stationSeries) && window.stationSeries.length){
      return window.stationSeries[window.stationSeries.length-1];
    }
  }catch(_){}
  return null;
}

function refreshScenarioPanels(){
  const s = getLatestPrimarySample();
  if(!s){
    // keep panels clean if nothing loaded yet
    ['windNow','windDir','windRisk','heatTempNow','heatIndexNow','heatRisk','frostTempNow','frostChillNow','frostRisk','iceRisk']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML='â€”'; });
    return;
  }

  // ---- WIND ----
  const windTxt = (s.wind != null) ? String(s.wind) : '';
  const wKmh = (typeof s.windKmh === 'number') ? s.windKmh
            : (typeof s.wind_kmh === 'number') ? s.wind_kmh
            : __numFromText(windTxt);
  let wDir = 'â€”';
  try{
    const toks = windTxt.trim().split(/\s+/);
    if(toks.length>=2){
      const last = toks[toks.length-1];
      if(/[NSEWÎ‘-Î©]/i.test(last)) wDir = last;
    }
  }catch(_){}

  const warnK = Number(document.getElementById('windWarnKmh')?.value);
  const highK = Number(document.getElementById('windHighKmh')?.value);

  let wLevel = 'none';
  if(Number.isFinite(wKmh)){
    if(Number.isFinite(highK) && wKmh >= highK) wLevel = 'high';
    else if(Number.isFinite(warnK) && wKmh >= warnK) wLevel = 'med';
    else wLevel = 'low';
  }

  const windNowEl = document.getElementById('windNow');
  if(windNowEl) windNowEl.textContent = Number.isFinite(wKmh) ? __fmt(wKmh, ' km/h') : (windTxt || 'â€”');
  const windDirEl = document.getElementById('windDir');
  if(windDirEl) windDirEl.textContent = wDir;
  const windRiskEl = document.getElementById('windRisk');
  if(windRiskEl) windRiskEl.innerHTML = __riskLabel(wLevel);

  // ---- HEATWAVE ----
  const t = (typeof s.temp === 'number') ? s.temp : ((typeof s.temperature === 'number') ? s.temperature : null);
  const hi = (typeof s.heat === 'number') ? s.heat : null;
  const warnHI = Number(document.getElementById('heatWarnHI')?.value);
  const highHI = Number(document.getElementById('heatHighHI')?.value);

  let hLevel = 'none';
  if(Number.isFinite(hi)){
    if(Number.isFinite(highHI) && hi >= highHI) hLevel = 'high';
    else if(Number.isFinite(warnHI) && hi >= warnHI) hLevel = 'med';
    else hLevel = 'low';
  }else if(Number.isFinite(t)){
    // fallback: use temp thresholds if HI missing
    if(t >= 40) hLevel = 'high';
    else if(t >= 35) hLevel = 'med';
    else hLevel = 'low';
  }

  const heatTempEl = document.getElementById('heatTempNow');
  if(heatTempEl) heatTempEl.textContent = Number.isFinite(t) ? __fmt(t,' Â°C') : 'â€”';
  const heatIdxEl = document.getElementById('heatIndexNow');
  if(heatIdxEl) heatIdxEl.textContent = Number.isFinite(hi) ? __fmt(hi,' Â°C') : 'â€”';
  const heatRiskEl = document.getElementById('heatRisk');
  if(heatRiskEl) heatRiskEl.innerHTML = __riskLabel(hLevel);

  // ---- FROST / SNOW ----
  const chill = (typeof s.chill === 'number') ? s.chill : null;
  const rr = (typeof s.rainRate === 'number') ? s.rainRate : ((typeof s.rr === 'number') ? s.rr : null);

  const t0 = Number(document.getElementById('frostTemp0')?.value);
  const tHigh = Number(document.getElementById('frostTempHigh')?.value);

  let fLevel = 'none';
  if(Number.isFinite(t)){
    if(Number.isFinite(tHigh) && t <= tHigh) fLevel = 'high';
    else if(Number.isFinite(t0) && t <= t0) fLevel = 'med';
    else if(t <= 2) fLevel = 'low';
    else fLevel = 'low';
  }

  let iceLevel = 'none';
  if(Number.isFinite(t) && t <= (Number.isFinite(t0) ? t0 : 0) && Number.isFinite(rr) && rr > 0){
    iceLevel = 'high';
  }else if(Number.isFinite(t) && t <= 1){
    iceLevel = 'med';
  }else{
    iceLevel = 'low';
  }

  const frostTempEl = document.getElementById('frostTempNow');
  if(frostTempEl) frostTempEl.textContent = Number.isFinite(t) ? __fmt(t,' Â°C') : 'â€”';
  const frostChillEl = document.getElementById('frostChillNow');
  if(frostChillEl) frostChillEl.textContent = Number.isFinite(chill) ? __fmt(chill,' Â°C') : 'â€”';
  const frostRiskEl = document.getElementById('frostRisk');
  if(frostRiskEl) frostRiskEl.innerHTML = __riskLabel(fLevel);
  const iceRiskEl = document.getElementById('iceRisk');
  if(iceRiskEl) iceRiskEl.innerHTML = __riskLabel(iceLevel, (Number.isFinite(rr) ? `(Ï…ÎµÏ„ÏŒÏ‚ ${__fmt(rr,' mm/h')})` : ''));
}
}


/* ====== Scenario UI helper: show 'â€”' when no scenario is selected (dropdown on placeholder) ====== */
function setScenarioSummaryPlaceholder(isPlaceholder){
  try{
    const root = document.getElementById('scenarioArea');
    if(!root) return;

    // restore default names
    root.querySelectorAll('.scenario-name[data-scn-name]').forEach(el=>{
      const base = (el.dataset && el.dataset.scnName) ? el.dataset.scnName : null;
      if(base != null) el.textContent = base;
    });

    if(isPlaceholder){
      const active = root.querySelector('.scenario-panel.active .scenario-name[data-scn-name]');
      if(active) active.textContent = 'â€”';
    }
  }catch(_){}
}

// ====== Scenario dropdown: becomes green only after user selection ======
const LS_MODEL_SCENARIO = 'NIREAS_MODEL_SCENARIO';
const LS_MODEL_SCENARIO_TOUCHED = 'NIREAS_MODEL_SCENARIO_TOUCHED';

function loadScenarioState(){
  const sel = document.getElementById('modelScenario');
  if(!sel) return;

  // Always start with the initial (placeholder) indication when NIREAS opens
  sel.value = '';
  sel.classList.remove('scenario-active');

  // Default scenario logic (keeps panels/outputs consistent) until user picks something
  setModelScenario('');

  
  try{ setScenarioSummaryPlaceholder(true); }catch(_){ }
// Clear persisted "touched/selected" so the dropdown stays neutral on every fresh open
  try{
    localStorage.removeItem(LS_MODEL_SCENARIO);
    localStorage.removeItem(LS_MODEL_SCENARIO_TOUCHED);
  }catch(e){}
}

function onScenarioChange(sel){
  if(!sel) return;

  const v = String(sel.value || '');

  // Placeholder selected -> keep initial (grey) look and clear persisted selection
  if(!v){
    setModelScenario('');
    sel.classList.remove('scenario-active');
    
    try{ setScenarioSummaryPlaceholder(true); }catch(_){ }
try{
      localStorage.removeItem(LS_MODEL_SCENARIO);
      localStorage.removeItem(LS_MODEL_SCENARIO_TOUCHED);
    }catch(e){}
    return;
  }

  setModelScenario(v);


  try{ setScenarioSummaryPlaceholder(false); }catch(_){ }

  // Turn green only after the user actively makes a choice
  sel.classList.add('scenario-active');
  try{
    localStorage.setItem(LS_MODEL_SCENARIO, v);
    localStorage.setItem(LS_MODEL_SCENARIO_TOUCHED, '1');
  }catch(e){}
}


/* ===== Local Scenario toggle (for future local parameters) ===== */
let LOCAL_SCENARIO_ON = false;

function updateLocalScenarioBtn(){
  const btn = document.getElementById('btnLocalScenario');
  const cb  = document.getElementById('localScenarioToggle');
  if(cb) LOCAL_SCENARIO_ON = !!cb.checked;

  if(btn){
    btn.classList.toggle('btn-local-on', LOCAL_SCENARIO_ON);
    btn.classList.toggle('btn-local-off', !LOCAL_SCENARIO_ON);
    btn.textContent = LOCAL_SCENARIO_ON ? 'Local Scenario ON' : 'Local Scenario OFF';
  }
  document.body.dataset.localScenario = LOCAL_SCENARIO_ON ? 'on' : 'off';
}

function toggleLocalScenario(){
  const cb  = document.getElementById('localScenarioToggle');
  if(cb){
    cb.checked = !cb.checked;
    try{ cb.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){}
  }else{
    LOCAL_SCENARIO_ON = !LOCAL_SCENARIO_ON;
  }
  updateLocalScenarioBtn();
  setStationMsg(LOCAL_SCENARIO_ON ? 'Local Scenario: ON' : 'Local Scenario: OFF');
}





/* ===== Reset Parameters (Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹) to defaults ===== */
function resetParametersToDefaults(){
  // 1) Scenario dropdown back to placeholder (keeps internal default scenario as rain)
  try{
    const sel = document.getElementById('modelScenario');
    if(sel){
      sel.value = '';
      onScenarioChange(sel);
    }else{
      try{ setModelScenario(''); }catch(_){}
    }
  }catch(_){}

  // 2) Clear Coâ€‘Hazards selections
  try{
    if(typeof window.clearCoHazards === 'function') window.clearCoHazards();
  }catch(_){}

  // 3) Live OFF
  try{
    if(typeof stationLiveOn !== 'undefined' && stationLiveOn) toggleLive();
  }catch(_){}

  // 4) Local Scenario OFF
  try{
    const cb = document.getElementById('localScenarioToggle');
    if(cb) cb.checked = false;
    LOCAL_SCENARIO_ON = false;
    updateLocalScenarioBtn();
  }catch(_){}

  // 5) AI provider back to ChatGPT
  try{ setAITarget('chatgpt'); }catch(_){}

  // Persist UI (if enabled)
  try{ scheduleSaveUiState(); }catch(_){}

  try{ setStationMsg('Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹: ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚.'); }catch(_){}
}


/* ===================== RESET HELPERS (per-line resets) ===================== */
function resetPrimaryStationQuick(){
  try{
    ACTIVE_PRIMARY_URL = '';
    ACTIVE_PRIMARY_NAME = '';
    try{ refreshSelectedMeteoMarkers(); }catch(_){ }
    const sel = document.getElementById('meteoStationSelect');
    if(sel){
      sel.value = '';
      sel.dispatchEvent(new Event('change'));
    }
    // Clear main station display
    setTxt('stationName','â€”');
    setTxt('stationTimestamp','â€”');
    setTxt('stationTimestampInline','â€”');
    try{ updateStationFreshnessUI(); }catch(_){}
    try{ updatePrimaryMetaCoords(); }catch(_){}
    setTxt('stationRainRate','â€”');
    setTxt('stationDP','â€”');
    setTxt('stationR60','â€”');
    try{ setLatestValuesDisplay(null,'â€”'); }catch(_){}
    try{ setStationMsg('â€”'); }catch(_){}
    try{ switchSeriesContext('open-meteo'); }catch(_){}
    try{
      if(typeof watchlist !== 'undefined' && watchlist && watchlist.size){
        updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ)', 'neutral');
      }else{
        updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
      }
    }catch(_){}
  }catch(e){
    console.warn('resetPrimaryStationQuick failed', e);
  }
}

function resetSelectedBoundary(){
  try{
    SELECTED_BOUNDARY_GEO = null;
    SELECTED_BOUNDARY_KEY = null;
    SELECTED_BOUNDARY_NAME = null;
    try{ setSelectedBoundaryLabel(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedBoundary failed', e); }
}

function resetSelectedStream(){
  try{
    SELECTED_STREAM_GEO = null;
    SELECTED_STREAM_KEY = null;
    SELECTED_STREAM_NAME = null;
    try{ setSelectedStreamLabel(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedStream failed', e); }
}

function resetSelectedZone(){
  try{
    SELECTED_BASIN_KEY = null;
    SELECTED_ZONE_KEY = null;
    SELECTED_ZONE_NAME = null;
    SELECTED_ZONE_KIND = null;
    try{ setSelectedZoneLabels(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedZone failed', e); }
}

function resetScenarioPanel(panelId){
  try{
    const root = document.getElementById(panelId);
    if(!root) return;

    // Reset standard form controls to their default values
    root.querySelectorAll('input, select, textarea').forEach(el=>{
      try{
        const tag = (el.tagName||'').toUpperCase();
        if(tag === 'SELECT'){
          const opts = Array.from(el.options||[]);
          const di = opts.findIndex(o=>o.defaultSelected);
          el.selectedIndex = (di>=0) ? di : 0;
        }else if(el.type === 'checkbox' || el.type === 'radio'){
          el.checked = el.defaultChecked;
        }else{
          el.value = el.defaultValue;
        }
        el.dispatchEvent(new Event('input', {bubbles:true}));
        el.dispatchEvent(new Event('change', {bubbles:true}));
      }catch(_){}
    });

    // Special: reset manual stream y (if present)
    try{ if(typeof resetStrY === 'function' && root.querySelector('#strY')) resetStrY(); }catch(_){}

    // Recompute / refresh UI
    try{ if(typeof runMasterCalculation==='function') runMasterCalculation(); }catch(_){}
    try{ if(typeof refreshScenarioPanels==='function') refreshScenarioPanels(); }catch(_){}
  }catch(e){
    console.warn('resetScenarioPanel failed', e);
  }
}
/* ===================== /RESET HELPERS ===================== */





/* ===================== UI PERSISTENCE (keep values on refresh) ===================== */
const LS_UI_STATE_KEY = 'nireas_ui_state_v1';

let __uiSaveTimer = null;
function scheduleSaveUiState(){
  if(__uiSaveTimer) clearTimeout(__uiSaveTimer);
  __uiSaveTimer = setTimeout(saveUiStateNow, 250); // debounce
}

function getSavedUiState(){
  try{
    const raw = localStorage.getItem(LS_UI_STATE_KEY);
    if(!raw) return null;
    const st = JSON.parse(raw);
    return (st && typeof st === 'object') ? st : null;
  }catch(_){
    return null;
  }
}

function saveUiStateNow(){
  try{
    const state = {};

    // Save all inputs/selects/textareas that have an id
    document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
      const tag = el.tagName.toLowerCase();
      const type = (el.type || '').toLowerCase();

      // skip buttons
      if(tag === 'input' && (type === 'button' || type === 'submit' || type === 'reset')) return;

      if(type === 'checkbox' || type === 'radio'){
        state[el.id] = { t: type, v: !!el.checked };
      }else{
        state[el.id] = { t: 'value', v: el.value };
      }

      // keep manual flag for strY
      if(el.id === 'strY'){
        state.__strYManual = (el.dataset.manual === 'true');
      }
    });

    // Save selected zone (basin/boundary) + visible layers (GeoJSON project state)
    state.__selectedZoneKey = SELECTED_BASIN_KEY || null;
    state.__selectedZoneName = SELECTED_ZONE_NAME || document.getElementById('selectedBasinName')?.innerText || null;
    state.__selectedZoneKind = (SELECTED_BASIN_KEY ? 'basin' : null);
    state.__selectedBoundaryKey = SELECTED_BOUNDARY_KEY || null;
    state.__selectedBoundaryName = SELECTED_BOUNDARY_NAME || document.getElementById('selectedBoundaryName')?.innerText || null;
    state.__selectedStreamKey = SELECTED_STREAM_KEY || null;
    state.__selectedStreamName = SELECTED_STREAM_NAME || document.getElementById('selectedStreamName')?.innerText || null;

    // backward compatibility (older state keys)
    state.__selectedBasinKey = SELECTED_BASIN_KEY || null;
    state.__selectedBasinName = document.getElementById('selectedBasinName')?.innerText || null;
    state.__visiblePaths = Array.from(VISIBLE || []);
    state.__meteoPrimaryVisible = !!METEO_PRIMARY_VISIBLE;
    state.__meteoWatchVisible = !!METEO_WATCH_VISIBLE;
    // backward compatibility (older single-toggle state)
    state.__meteoStationsVisible = !!(METEO_PRIMARY_VISIBLE || METEO_WATCH_VISIBLE);


    localStorage.setItem(LS_UI_STATE_KEY, JSON.stringify(state));
  }catch(_){}
}

function restoreUiStateEarly(){
  // Only things needed BEFORE renderFileList(): VISIBLE (On/Off buttons)
  const st = getSavedUiState();
  if(!st) return;

  if(Array.isArray(st.__visiblePaths)){
    try{
      VISIBLE.clear();
      st.__visiblePaths.forEach(p => { if(p) VISIBLE.add(String(p)); });
    }catch(_){}
  }
  // restore meteo layer states (independent)
  if(typeof st.__meteoPrimaryVisible === 'boolean') METEO_PRIMARY_VISIBLE = !!st.__meteoPrimaryVisible;
  if(typeof st.__meteoWatchVisible === 'boolean') METEO_WATCH_VISIBLE = !!st.__meteoWatchVisible;

  // backward compatibility: older single toggle
  if(typeof st.__meteoPrimaryVisible !== 'boolean' && typeof st.__meteoWatchVisible !== 'boolean' && typeof st.__meteoStationsVisible === 'boolean'){
    METEO_PRIMARY_VISIBLE = !!st.__meteoStationsVisible;
    METEO_WATCH_VISIBLE = !!st.__meteoStationsVisible;
  }
}

function restoreUiFieldsFromState(st){
  const pendingSelects = [];
  const selectsToNotify = [];

  for(const [id, pack] of Object.entries(st)){
    if(id.startsWith('__')) continue;

    const el = document.getElementById(id);
    if(!el) continue;

    const tag = el.tagName.toLowerCase();
    const type = (el.type || '').toLowerCase();

    const t = (pack && typeof pack === 'object' && 't' in pack) ? pack.t : 'value';
    const v = (pack && typeof pack === 'object' && 'v' in pack) ? pack.v : pack;

    if(t === 'checkbox' || t === 'radio'){
      el.checked = !!v;
    }else{
      const val = String(v ?? '');
      if(tag === 'select'){
        const hasOpt = Array.from(el.options).some(o => o.value === val);
        if(!hasOpt) pendingSelects.push({ el, val });
        else el.value = val;
        selectsToNotify.push(el);
      }else{
        el.value = val;
      }
    }

    if(id === 'strY'){
      if(st.__strYManual) el.dataset.manual = 'true';
      else delete el.dataset.manual;
    }
  }

  // apply deferred selects now, and later once options are populated
  window.__NIREAS_PENDING_SELECTS = pendingSelects;
  window.__NIREAS_SELECTS_TO_NOTIFY = selectsToNotify;
  applyPendingRestores();
}

function applyPendingRestores(retries=6){
  const pending = window.__NIREAS_PENDING_SELECTS || [];
  if(pending.length){
    window.__NIREAS_PENDING_SELECTS = pending.filter(({el, val}) => {
      const hasOpt = Array.from(el.options).some(o => o.value === val);
      if(hasOpt) el.value = val;
      return !hasOpt;
    });
  }

  const notify = window.__NIREAS_SELECTS_TO_NOTIFY || [];
  if(notify.length){
    notify.forEach(el => {
      try{ el.dispatchEvent(new Event('change', { bubbles:true })); }catch(_){}
    });
    window.__NIREAS_SELECTS_TO_NOTIFY = [];
  }

  // If selects weren't ready yet, retry a few times (stations/lists load async)
  const remaining = (window.__NIREAS_PENDING_SELECTS || []).length;
  if(remaining && retries > 0){
    setTimeout(()=> applyPendingRestores(retries-1), 350);
  }
}

async function restoreUiStateLate(){
  // Restore last selected basin (GeoJSON) + all fields
  const st = getSavedUiState();
  if(!st) return;

  // 1) Restore last selections:
  //    - "Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·" Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¹Î¼Î® ÎœÎŸÎÎŸ Î±Ï€ÏŒ basins
  //    - "Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±" Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¹Î¼Î® ÎœÎŸÎÎŸ Î±Ï€ÏŒ boundaries
  const basinKey = st.__selectedBasinKey
    || (st.__selectedZoneKey && String(st.__selectedZoneKey).includes('data/basins/') ? st.__selectedZoneKey : null);

  const basinName = st.__selectedBasinName || st.__selectedZoneName || null;

  if(basinKey){
    try{
      const key = String(basinKey);
      const name = basinName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedZoneLabels(name); }catch(_){}
        SELECTED_BASIN_KEY = key;
        SELECTED_ZONE_KEY = key;
        SELECTED_ZONE_NAME = name;
        SELECTED_ZONE_KIND = 'basin';
      }
    }catch(_){}
  } else if(basinName){
    try{ setSelectedZoneLabels(basinName); }catch(_){}
  }

  const boundaryKey = st.__selectedBoundaryKey
    || (st.__selectedZoneKey && String(st.__selectedZoneKey).includes('data/boundaries/') ? st.__selectedZoneKey : null);

  const boundaryName = st.__selectedBoundaryName || null;

  if(boundaryKey){
    try{
      const key = String(boundaryKey);
      const name = boundaryName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedBoundaryLabel(name); }catch(_){}
        SELECTED_BOUNDARY_KEY = key;
        SELECTED_BOUNDARY_NAME = name;
      }
    }catch(_){}
  } else if(boundaryName){
    try{ setSelectedBoundaryLabel(boundaryName); }catch(_){}
  }


  const streamKey = st.__selectedStreamKey || null;
  const streamName = st.__selectedStreamName || null;

  if(streamKey){
    try{
      const key = String(streamKey);
      const name = streamName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedStreamLabel(name); }catch(_){}
        SELECTED_STREAM_KEY = key;
        SELECTED_STREAM_NAME = name;
      }
    }catch(_){}
  } else if(streamName){
    try{ setSelectedStreamLabel(streamName); }catch(_){}
  }

  // Restore last selected administrative boundary (independent from the main zone)
  try{
    if(st.__selectedBoundaryKey){
      SELECTED_BOUNDARY_KEY = String(st.__selectedBoundaryKey);
      const nm = st.__selectedBoundaryName || SELECTED_BOUNDARY_KEY.split('/').pop().replace('.geojson','');
      SELECTED_BOUNDARY_NAME = nm;
      setSelectedBoundaryLabel(nm);
    }else if(st.__selectedBoundaryName){
      SELECTED_BOUNDARY_NAME = String(st.__selectedBoundaryName);
      setSelectedBoundaryLabel(SELECTED_BOUNDARY_NAME);
    }
  }catch(_){}




  // Restore last selected hydrographic network (independent)
  try{
    if(st.__selectedStreamKey){
      SELECTED_STREAM_KEY = String(st.__selectedStreamKey);
      const nm = st.__selectedStreamName || SELECTED_STREAM_KEY.split('/').pop().replace('.geojson','');
      SELECTED_STREAM_NAME = nm;
      setSelectedStreamLabel(nm);
    }else if(st.__selectedStreamName){
      SELECTED_STREAM_NAME = String(st.__selectedStreamName);
      setSelectedStreamLabel(SELECTED_STREAM_NAME);
    }
  }catch(_){}

  // 2) Restore all tool fields
  restoreUiFieldsFromState(st);

  // 3) Re-render file list so On/Off buttons match (in case state loaded after first render)
  try{ renderFileList(); }catch(_){}
  try{ updateMeteoStationsRowButton(); }catch(_){}

  // 4) Ensure calculations reflect restored values
  try{ runMasterCalculation(); }catch(_){}
  try{ drawBasinPlan(); }catch(_){}
}

function bindPersistenceOnce(){
  if(window.__NIREAS_PERSIST_BOUND) return;
  window.__NIREAS_PERSIST_BOUND = true;

  // Save on any field change (captures most UI)
  document.addEventListener('input', (ev)=>{ if(ev.target && ev.target.id) scheduleSaveUiState(); }, true);
  document.addEventListener('change', (ev)=>{ if(ev.target && ev.target.id) scheduleSaveUiState(); }, true);

  // Ensure strY becomes manual when user types (bound once)
  const strYEl = document.getElementById('strY');
  if(strYEl && strYEl.dataset.boundManual !== '1'){
    strYEl.dataset.boundManual = '1';
    strYEl.addEventListener('input', ()=>{ strYEl.dataset.manual = 'true'; scheduleSaveUiState(); });
  }
}
/* =================== /UI PERSISTENCE =================== */


function setCustomMsg(msg){
  const el = document.getElementById('customStationMsg');
  if(el) el.textContent = msg;
}

function saveWatchlist(){
  try{
    const arr = Array.from(watchlist.entries()).map(([url,name]) => ({url, name}));
    localStorage.setItem(LS_WATCHLIST_KEY, JSON.stringify(arr));
  }catch(e){}
}

function loadWatchlist(){
  try{
    const raw = localStorage.getItem(LS_WATCHLIST_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return;
    watchlist.clear();
    for(const it of arr){
      if(it && it.url){
        watchlist.set(String(it.url), String(it.name || it.url));
      }
    }
  }catch(e){}
}

function getCustomStations(){
  try{
    const raw = localStorage.getItem(LS_CUSTOM_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function saveCustomStations(arr){
  try{
    localStorage.setItem(LS_CUSTOM_KEY, JSON.stringify(arr || []));
  }catch(e){}
}

function ensureCustomOptgroup(selectEl){
  if(!selectEl) return null;
  // try to find existing optgroup by label
  const groups = Array.from(selectEl.querySelectorAll('optgroup'));
  let grp = groups.find(g => (g.label || '').toLowerCase().includes('custom'));
  if(!grp){
    grp = document.createElement('optgroup');
    grp.label = 'Custom (Local)';
    selectEl.appendChild(grp);
  }
  return grp;
}

function upsertCustomOption(name, url){
  const normalized = normalizeStationUrl(url);
  if(!normalized) return;

  const ids = ['meteoStationSelect','monitorStationSelect'];
  ids.forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;

    const existing = Array.from(sel.options).find(o => o.value === normalized);
    if(existing){
      if(name && existing.textContent !== name) existing.textContent = name;
      return;
    }

    const grp = ensureCustomOptgroup(sel);
    const opt = document.createElement('option');
    opt.value = normalized;
    opt.textContent = (name || normalized.replace(/^https?:\/\//i,'').slice(0,60));
    opt.dataset.from = 'local';
    grp.appendChild(opt);
  });
}

function loadCustomStationsIntoSelect(){
  const list = getCustomStations();
  if(!list.length) return;
  for(const it of list){
    if(!it || !it.url) continue;
    upsertCustomOption(it.name || '', it.url);
  }
}

function addCustomStation(){
  const nameEl = document.getElementById('customStationName');
  const urlEl  = document.getElementById('customStationUrl');
  const name = (nameEl?.value || '').trim();
  const urlRaw = (urlEl?.value || '').trim();
  if(!urlRaw){
    setCustomMsg('Î”ÏÏƒÎµ URL ÏƒÏ„Î±Î¸Î¼Î¿Ï.');
    return;
  }
  const url = normalizeStationUrl(urlRaw);
  if(!url){
    setCustomMsg('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ URL.');
    return;
  }

  // save to custom list
  const list = getCustomStations();
  const exists = list.some(x => String(x?.url||'') === url);
  if(!exists){
    list.push({name: name || url.replace(/^https?:\/\//i,'').slice(0,60), url});
    saveCustomStations(list);
  }

  // also add to dropdown + watchlist immediately
  upsertCustomOption(name, url);
  watchlist.set(url, name || url.replace(/^https?:\/\//i,'').slice(0,60));
  renderWatchlist();
  saveWatchlist();

  // clear inputs
  if(nameEl) nameEl.value = '';
  if(urlEl) urlEl.value = '';

  setCustomMsg('âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ (Ï„Î¿Ï€Î¹ÎºÎ¬).');

  // immediately fetch to show data (extras only)
  fetchStationData('extras');
}


let stationLiveTimer = null;
let stationFreshnessTimer = null;
let lastStationPayload = null;

// Hardening: clean up timers + catch unhandled async errors
window.addEventListener('pagehide', () => {
  try{ if(stationLiveTimer){ clearInterval(stationLiveTimer); stationLiveTimer = null; }
       if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); stationFreshnessTimer = null; }
  }catch(_){}
});
window.addEventListener('beforeunload', () => {
  try{ if(stationLiveTimer){ clearInterval(stationLiveTimer); stationLiveTimer = null; }
       if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); stationFreshnessTimer = null; }
  }catch(_){}
});
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  try{
    updateMeteoStatus('Î£Ï†Î¬Î»Î¼Î± (promise). Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.');
    setStationMsg('Î£Ï†Î¬Î»Î¼Î±: ' + (event.reason?.message || String(event.reason || 'unknown')));
  }catch(_){}
  event.preventDefault();
});

/* ===================== UI HELPERS ===================== */
function toggleCollapse(id, btn){
  const el = document.getElementById(id);
  if(!el) return;

  const isHidden = el.classList.toggle('collapsed');

  // Update the +/- glyph
  if(btn) btn.textContent = isHidden ? '+' : 'âˆ’';

  // Unified rounded-corner look when collapsed
  const card = (btn && btn.closest('.panel-card')) || el.closest('.panel-card');
  if(card){
    card.classList.toggle('is-collapsed', isHidden);
  }
}


function setStatusById(id, msg, level='neutral'){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerText = msg;
  el.classList.remove('status-ok','status-warn','status-neutral');
  if(level==='ok') el.classList.add('status-ok');
  else if(level==='warn') el.classList.add('status-warn');
  else el.classList.add('status-neutral');
}
function updatePrimaryStatus(msg, level='neutral'){
  setStatusById('primaryStatus', msg, level);
}
function updateExtrasStatus(msg, level='neutral'){
  setStatusById('extrasStatus', msg, level);
}
// backward compatibility (sets both)
function updateMeteoStatus(msg, level='neutral'){
  // Optional informational message area for the METEO section.
  // HIDDEN by default to avoid a lone "â€”" separator.
  // Shows only for warnings/errors (does NOT touch the two independent status pills).
  const el = document.getElementById('meteoMsg');
  if(!el) return;

  const t = (msg == null) ? '' : String(msg).trim();
  const shouldShow = !!t && t !== 'â€”' && (
    level === 'warn' ||
    /Î£Ï†Î¬Î»Î¼Î±/i.test(t) ||
    /Î”ÎµÎ½\s+Î²ÏÎ­Î¸Î·ÎºÎ±Î½/i.test(t) ||
    /promise/i.test(t)
  );

  if(shouldShow){
    el.textContent = t;
    el.style.display = 'block';
  }else{
    el.textContent = '';
    el.style.display = 'none';
  }
}
function setStationMsg(msg){
  const el = document.getElementById('stationMsg');
  if(el) el.innerText = msg;
}
function setTxt(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; if(id==='stationName'||id==='stationTimestampInline'||id==='stationLat'||id==='stationLon'||id==='stationElev') updateSeriesSummaryName(); }

/* ===== Clear/Reset confirmations (UI vs DB) =====
   Î£Ï„ÏŒÏ‡Î¿Ï‚: Î­Î½Î± "Clear" Î±Î½Î¬ section, Î¼Îµ Î¼Î¯Î½Î¹ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î¿Ï… ÎµÎ¾Î·Î³ÎµÎ¯ Î¤Î™ ÎºÎ±Î¸Î±ÏÎ¯Î¶ÎµÏ„Î±Î¹.
   Î£Î·Î¼.: Î¤Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î”Î•Î Î´Î¹Î±Î³ÏÎ¬Ï†Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Firestore. ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ UI/buffer/Ï€ÏÎ¿Î²Î¿Î»Î®. */
function __confirmClear(title, lines, note){
  const footer = note || "Î£Î·Î¼.: Î”ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î± Î±Ï€ÏŒ Ï„Î· Î’Î¬ÏƒÎ· (DB). ÎšÎ±Î¸Î±ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î· Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Î¼Î½Î®Î¼Î·/Ï€ÏÎ¿Î²Î¿Î»Î® ÏƒÏ„Î¿Î½ browser.";
  const body = (Array.isArray(lines) ? lines : [String(lines||'')]).join("\n");
  const msg = `${title}\n\n${body}\n\n${footer}`;
  return confirm(msg);
}

function confirmAndClearSeriesFiltersUI(){
  const ok = __confirmClear(
    "Clear â€“ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï (UI)",
    [
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î® Ï†Î¯Î»Ï„ÏÏ‰Î½.",
      "â€¢ Î˜Î± Î±Î´ÎµÎ¹Î¬ÏƒÎµÎ¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚.",
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„ÎµÎ¯ Î· Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬ (buffer) Ï„Î¿Ï… ÎµÎ½ÎµÏÎ³Î¿Ï ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï."
    ]
  );
  if(!ok) return;
  clearSeriesFiltersUI();
}

function confirmAndClearDbFiltersUI(){
  const ok = __confirmClear(
    "Clear â€“ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Î’Î¬ÏƒÎ· (DB) (Î ÏÎ¿Î²Î¿Î»Î®)",
    [
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î® Ï†Î¯Î»Ï„ÏÏ‰Î½.",
      "â€¢ Î˜Î± Î±Î´ÎµÎ¹Î¬ÏƒÎµÎ¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ (cached rows)."
    ],
    "Î£Î·Î¼.: Î”ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î± Î±Ï€ÏŒ Ï„Î· Î’Î¬ÏƒÎ· (DB). Î‘Ï€Î»ÏÏ‚ ÎºÎ±Î¸Î±ÏÎ¯Î¶ÎµÎ¹ Î· Ï€ÏÎ¿Î²Î¿Î»Î®/Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î¿ UI."
  );
  if(!ok) return;
  clearDbFiltersUI();
}



/* ===== Station freshness (timestamp age) ===== */
function parseGreekDateTime(ts){
  if(!ts) return null;
  const s = String(ts).trim();
  if(!s || s==='â€”') return null;
  const parts = s.split(',');
  const dpart = (parts[0]||'').trim();
  const tpart = (parts[1]||'').trim();
  const d = dpart.split('/').map(n=>parseInt(n,10));
  const t = tpart.split(':').map(n=>parseInt(n,10));
  if(d.length<3 || isNaN(d[0]) || isNaN(d[1]) || isNaN(d[2])) return null;
  const dd=d[0], mm=d[1], yy=d[2];
  const HH=t[0]||0, MM=t[1]||0, SS=t[2]||0;
  const dt = new Date(yy, mm-1, dd, HH, MM, SS);
  if(isNaN(dt.getTime())) return null;
  return dt;
}

function ageClassFromTimestamp(tsStr){
  const dt = parseGreekDateTime(tsStr);
  if(!dt) return 'age-unknown';
  let diffMin = (Date.now() - dt.getTime()) / 60000;
  if(diffMin < 0) diffMin = 0;
  if(diffMin < 5) return 'age-fresh';
  if(diffMin < 10) return 'age-warn';
  return 'age-stale';
}

function updateStationFreshnessUI(){
  const nameEl = document.getElementById('stationName');
  if(!nameEl) return;

  nameEl.classList.remove('age-fresh','age-warn','age-stale','age-unknown');

  const tsStr = (document.getElementById('stationTimestamp')?.textContent || '').trim();
  const dt = parseGreekDateTime(tsStr);
  if(!dt){
    nameEl.classList.add('age-unknown');
    return;
  }
  let diffMin = (Date.now() - dt.getTime()) / 60000;
  if(diffMin < 0) diffMin = 0;

  if(diffMin < 5) nameEl.classList.add('age-fresh');
  else if(diffMin < 10) nameEl.classList.add('age-warn');
  else nameEl.classList.add('age-stale')
  try{ refreshScenarioPanels(); }catch(_){}
;
}

function startStationFreshnessTimer(){
  try{
    if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); }
    updateStationFreshnessUI();
    stationFreshnessTimer = setInterval(updateStationFreshnessUI, 30*1000);
  }catch(_){}
}
function updateSeriesSummaryName(){
  // Keep the Primary History header (monitoring table) in sync with the active PRIMARY station
  const name = (document.getElementById('stationName')?.textContent || '').trim();
  setTxt('seriesStationName', (name && name!=='â€”') ? name : 'â€”');

  const ts = (document.getElementById('stationTimestampInline')?.textContent || '').trim();
  setTxt('seriesTimestampInline', (ts && ts!=='â€”') ? ts : 'â€”');

  const lat = (document.getElementById('stationLat')?.textContent || '').trim();
  const lon = (document.getElementById('stationLon')?.textContent || '').trim();
  const elev = (document.getElementById('stationElev')?.textContent || '').trim();
  setTxt('seriesLat',  (lat  && lat!=='â€”')  ? lat  : 'â€”');
  setTxt('seriesLon',  (lon  && lon!=='â€”')  ? lon  : 'â€”');
  setTxt('seriesElev', (elev && elev!=='â€”') ? elev : 'â€”');
}

// --- Station series context helpers (per *active* primary station) ---
// Active primary station applies ONLY after the user presses â•
function getPrimaryStationUrl(){
  return ACTIVE_PRIMARY_URL || '';
}
function getPrimaryStationName(){
  return ACTIVE_PRIMARY_NAME || '';
}
// Pending (dropdown) selection - not applied until â•
function getPendingPrimaryUrl(){
  return document.getElementById('meteoStationSelect')?.value || '';
}
function getPendingPrimaryName(){
  const sel = document.getElementById('meteoStationSelect');
  const url = sel?.value || '';
  if(!sel || !url) return '';
  return (sel.options[sel.selectedIndex]?.textContent || url).trim();
}
function getPrimaryStationKey(){
  const url = getPrimaryStationUrl();
  if(!url || url === OPEN_METEO_TOKEN) return 'open-meteo';
  return `url:${url}`;
}

function switchSeriesContext(newKey){
  const key = newKey || 'open-meteo';

  // save current context
  stationSeriesByKey[currentStationKey] = stationSeries;
  stationLastKeyByKey[currentStationKey] = stationLastKey;

  // load new context
  currentStationKey = key;
  stationSeries = stationSeriesByKey[currentStationKey] || [];
  stationLastKey = stationLastKeyByKey[currentStationKey]
    || (stationSeries.length ? stationSeries[stationSeries.length-1].key : null);

  // ensure stored
  stationSeriesByKey[currentStationKey] = stationSeries;
  stationLastKeyByKey[currentStationKey] = stationLastKey;

  // refresh readouts + list for the currently selected station
  updateStationReadouts();
}

function switchPrimarySeriesContext(){
  switchSeriesContext(getPrimaryStationKey());
}

function isFiniteNumber(x){ return typeof x === 'number' && isFinite(x); }
function num(val){
  if(val==null) return 0;
  const n = (typeof val === 'number') ? val : parseFloat(String(val).replace(',','.'));
  return isFiniteNumber(n) ? n : 0;
}
function getVal(id){ return num(document.getElementById(id)?.value); }
function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  el.value = (v==null) ? "" : v;
}

function debounce(fn, wait=150){
  let t = null;
  return function(...args){
    if(t) clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}


/* ===================== GITHUB LOAD ===================== */
async function init(){
  document.getElementById('loader').style.display = 'block';
  try{
    const resp = await fetch(API_TREE);
    const data = await resp.json();
    if(data.message) throw new Error(data.message);

    const files = data.tree || [];

    // IMPORTANT: paths based on your current repo layout (from previous versions)
    // data/boundaries, data/streams, data/basins
    DATA_GROUPS.boundaries = files.filter(f => f.path.includes('data/boundaries/') && f.path.endsWith('.geojson'));
    DATA_GROUPS.streams    = files.filter(f => (f.path.includes('data/streams/') || f.path.includes('streams/geojson/')) && f.path.endsWith('.geojson'));
    DATA_GROUPS.basins     = files.filter(f => f.path.includes('data/basins/')     && f.path.endsWith('.geojson'));

    restoreUiStateEarly();
    initAIAnalysisUI();
    updateMeteoStationsRowButton();
    renderFileList();

    // Forecast sources (web links) from repo folder: data/forecast/forecast.txt
    try{ await loadForecastSourcesFromTree(files); }catch(e){ console.warn('Forecast Source load failed:', e); }

    // Water level sensors (web links) from repo folder: data/WaterLevelSensors/WaterLevelSensors.txt
    try{ await loadWaterLevelSourcesFromTree(files); }catch(e){ console.warn('Water Level Sensors load failed:', e); }

    // Auto-populate stations dropdown from folder structure:
// - data/meteostations/api/*.txt      -> API / JSON
// - data/meteostations/weblinks/*.txt -> Web Links
const loaded = await fetchStationsFromFolders(files);

if(!loaded){
  // Backward-compatible fallback (older layouts)
  const stationFile =
    files.find(f => f.path === 'data/meteostations/weblinks/stations.txt') ||
    files.find(f => f.path.endsWith('/stations.txt') || f.path.endsWith('stations.txt')) ||
    files.find(f => f.path.endsWith('openmeteo.txt')) ||
    files.find(f => f.path.endsWith('ecmwf.txt'));

  if(stationFile) await fetchStations(stationFile.path);
  else {
    updateMeteoStatus("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î±Î¸Î¼ÏÎ½ (.txt) ÏƒÎµ data/meteostations/api Î® data/meteostations/weblinks");
    // safe fallback: keep dropdown empty
  }
}

    // Restore local custom stations + watchlist (no coding required)
    loadCustomStationsIntoSelect();
    loadWatchlist();
    renderWatchlist();

    // Keep values + selected GeoJSON after refresh
    bindPersistenceOnce();
    await restoreUiStateLate();

    bindInputs();
    runMasterCalculation();
    updateStationButtons();
    initMonitorContentToggle();
    loadScenarioState();
    try{ applyScenarioUI(MODEL_SCENARIO || (document.getElementById('modelScenario')?.value) || ''); }catch(_){}
    try{ refreshScenarioPanels(); }catch(_){}

    updateLocalScenarioBtn();
    startStationFreshnessTimer();

    // If dropdown has a pending selection (but no ACTIVE yet), show "Î±Î½Î±Î¼Î¿Î½Î®"
    const sel = document.getElementById('meteoStationSelect');
    if(sel && sel.value && !getPrimaryStationUrl()){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î‘Î½Î±Î¼Î¿Î½Î®â€¦', 'neutral');
    } else if(!getPrimaryStationUrl()){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
    }

    // If no ACTIVE primary but watchlist exists, fetch extras immediately to show values
    if(!getPrimaryStationUrl() && watchlist.size){
      fetchStationData('extras');
    }

  }catch(e){
    console.error(e);
    updateMeteoStatus("Î£Ï†Î¬Î»Î¼Î± GitHub: " + e.message);
  }finally{
    document.getElementById('loader').style.display = 'none';
  }
}

function renderFileList(){
  const tbody = document.getElementById('fileRows');
  tbody.innerHTML = '';
  const addCategory = (catKey, title, list, icon, color) => {
    const trHead = document.createElement('tr');
    trHead.className = 'cat-row';
    trHead.innerHTML = `
      <td colspan="2" class="cat-row">
        <div class="cat-head">
          <span class="cat-title">${icon} ${title}</span>
        </div>
      </td>`;
    tbody.appendChild(trHead);

    list.forEach(f=>{
      const name = f.path.split('/').pop().replace('.geojson','');
      const tr = document.createElement('tr');

      const on = VISIBLE.has(f.path);
      tr.innerHTML = `
        <td style="text-align:left;padding-left:10px;">${name}</td>
        <td><div class="actions-row">
          <button class="mini-btn btn-on" onclick="geoAddFromRow(\'${catKey}\', \'${f.path}\', \'${name}\')" title="â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ panel">â•</button>
          <button class="mini-btn btn-gray" onclick="geoClearCategory(\'${catKey}\')" title="ğŸ§¹ Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· Î±Ï€ÏŒ Ï„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ panel">ğŸ§¹</button>
          <button class="mini-btn btn-map" onclick="previewOnMap('${f.path}','${name}')" title="Î§Î¬ÏÏ„Î·Ï‚: Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· (zoom) Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î® On/Off"><span class="ico-map">ğŸ—º</span> Map</button>
          <button class="mini-btn map-only-btn ${on ? 'btn-on' : 'btn-off'}" id="btn-onoff-${cssSafe(f.path)}"
                  onclick="toggleLayer('${f.path}','${name}')"><span class="ico-eye">ğŸ‘</span> ${on ? 'On' : 'Off'}</button>
        </div></td>
      `;
      tbody.appendChild(tr);
    });
  };

  // ORDER REQUESTED: boundaries -> streams -> basins
  addCategory("boundaries", "Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±", DATA_GROUPS.boundaries, "ğŸ³ï¸", "#0f0f0f");
  addCategory("streams", "Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿", DATA_GROUPS.streams, "ğŸ’§", "#0f0f0f");
  addCategory("basins", "Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚", DATA_GROUPS.basins, "ğŸï¸", "#0f0f0f");
}

function cssSafe(s){
  return btoa(unescape(encodeURIComponent(s))).replace(/=+/g,'').replace(/[+/]/g,'_');
}

/* ===================== FORECAST SOURCES (WEB) ===================== */
function forecastLabelFromUrl(url){
  try{
    const u = new URL(url);
    const host = (u.hostname || '').replace(/^www\./i,'');
    if(/windy\./i.test(host)) return 'Windy';
    if(/poseidon\./i.test(host) || /hcmr\./i.test(host)) return 'Poseidon (HCMR)';
    if(/meteo\./i.test(host)) return 'Meteo';
    // default: show host
    return host || url;
  }catch(_){
    return String(url || '').replace(/^https?:\/\//i,'').slice(0, 60) || 'â€”';
  }
}

function parseForecastSources(text){
  const lines = String(text ?? '')
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l && !l.startsWith('#') && !l.startsWith('//'));
  return lines.map(url => ({
    url,
    name: forecastLabelFromUrl(url)
  }));
}

function openForecastWeb(url){
  if(!url) return;
  try{ window.open(url, '_blank', 'noopener'); }catch(_){ /* noop */ }
}

function renderForecastSources(list){
  const tbody = document.getElementById('forecastRows');
  if(!tbody) return;
  tbody.innerHTML = '';

  if(!Array.isArray(list) || !list.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" style="padding:10px;color:#6b7a86;">(Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï€Î·Î³Î­Ï‚)</td>`;
    tbody.appendChild(tr);
    return;
  }

  list.forEach(item => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td');
    tdName.style.textAlign = 'left';
    tdName.style.paddingLeft = '10px';
    tdName.textContent = item.name || 'â€”';

    const tdAct = document.createElement('td');
    const wrap = document.createElement('div');
    wrap.className = 'actions-row';
    wrap.style.justifyContent = 'flex-end';

    const btn = document.createElement('button');
    btn.className = 'mini-btn btn-map';
    btn.title = 'Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±';
    btn.textContent = 'ğŸ”— Web';
    btn.addEventListener('click', () => openForecastWeb(item.url));

    wrap.appendChild(btn);
    tdAct.appendChild(wrap);

    tr.appendChild(tdName);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
}

async function loadForecastSourcesFromTree(treeFiles){
  const loader = document.getElementById('forecastLoader');
  const msg = document.getElementById('forecastMsg');
  if(loader) loader.style.display = 'block';
  if(msg){ msg.style.display = 'none'; msg.textContent = ''; }

  try{
    const files = Array.isArray(treeFiles) ? treeFiles : [];
    const f =
      files.find(x => x.path === 'data/forecast/forecast.txt') ||
      files.find(x => /data\/forecast\/forecast\.txt$/i.test(x.path)) ||
      files.find(x => /forecast\/forecast\.txt$/i.test(x.path));

    if(!f) throw new Error('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ data/forecast/forecast.txt ÏƒÏ„Î¿ repo.');

    const resp = await fetch(RAW_URL + f.path, { cache: 'no-store' });
    if(!resp.ok) throw new Error('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î»Î®ÏˆÎ·Ï‚ forecast.txt (HTTP ' + resp.status + ')');

    const text = await resp.text();
    const list = parseForecastSources(text);
    renderForecastSources(list);
  }catch(e){
    console.warn('Forecast Source:', e);
    if(msg){
      msg.style.display = 'block';
      msg.textContent = 'Forecast Source: ' + (e?.message || String(e));
    }
    renderForecastSources([]);
  }finally{
    if(loader) loader.style.display = 'none';
  }
}

/* ===================== WATER LEVEL SENSORS (WEB SOURCES) ===================== */
function waterLevelLabelFromUrl(url){
  try{
    const u = new URL(url);
    const host = (u.hostname || '').replace(/^www\./,'');
    const last = (u.pathname || '').split('/').filter(Boolean).pop() || '';
    if(last && /^\d+$/.test(last)) return `${host} (${last})`;
    return host || url;
  }catch(_){
    return url || 'â€”';
  }
}

function parseWaterLevelSources(text){
  const lines = String(text || '')
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l && !l.startsWith('#') && !l.startsWith('//'));

  return lines
    .map(line => {
      const parts = line.split('|');
      if(parts.length >= 2){
        const name = parts[0].trim();
        const url = parts.slice(1).join('|').trim();
        return { name: name || waterLevelLabelFromUrl(url), url };
      }
      const url = line.trim();
      return { name: waterLevelLabelFromUrl(url), url };
    })
    .filter(x => x.url);
}

function openWaterLevelWeb(url){
  if(!url) return;
  try{ window.open(url, '_blank', 'noopener'); }catch(_){}
}

function renderWaterLevelSources(list){
  const tbody = document.getElementById('waterLevelRows');
  if(!tbody) return;
  tbody.innerHTML = '';

  if(!Array.isArray(list) || !list.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" style="padding:10px;color:#6b7a86;">(Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Î¹ÏƒÎ¸Î·Ï„Î®ÏÎµÏ‚)</td>`;
    tbody.appendChild(tr);
    return;
  }

  list.forEach(item => {
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    tdName.style.textAlign = 'left';
    tdName.style.paddingLeft = '10px';
    tdName.textContent = item.name || 'â€”';

    const tdAct = document.createElement('td');
    const wrap = document.createElement('div');
    wrap.className = 'actions-row';
    wrap.style.justifyContent = 'flex-end';

    const btn = document.createElement('button');
    btn.className = 'mini-btn btn-map';
    btn.title = 'Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±';
    btn.textContent = 'ğŸ”— Web';
    btn.addEventListener('click', () => openWaterLevelWeb(item.url));

    wrap.appendChild(btn);
    tdAct.appendChild(wrap);

    tr.appendChild(tdName);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
}

async function loadWaterLevelSourcesFromTree(treeFiles){
  const loader = document.getElementById('waterLevelLoader');
  const msg = document.getElementById('waterLevelMsg');
  if(loader) loader.style.display = 'block';
  if(msg){ msg.style.display = 'none'; msg.textContent = ''; }

  try{
    const files = Array.isArray(treeFiles) ? treeFiles : [];
    const f =
      files.find(x => x.path === 'data/WaterLevelSensors/WaterLevelSensors.txt') ||
      files.find(x => /data\/WaterLevelSensors\/WaterLevelSensors\.txt$/i.test(x.path)) ||
      files.find(x => /WaterLevelSensors\.txt$/i.test(x.path));

    if(!f) throw new Error('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ data/WaterLevelSensors/WaterLevelSensors.txt ÏƒÏ„Î¿ repo.');

    const resp = await fetch(RAW_URL + f.path, { cache: 'no-store' });
    if(!resp.ok) throw new Error('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î»Î®ÏˆÎ·Ï‚ WaterLevelSensors.txt (HTTP ' + resp.status + ')');

    const text = await resp.text();
    const list = parseWaterLevelSources(text);
    renderWaterLevelSources(list);
  }catch(e){
    console.warn('Water Level Sensors:', e);
    if(msg){
      msg.style.display = 'block';
      msg.textContent = 'Water Level Sensors: ' + (e?.message || String(e));
    }
    renderWaterLevelSources([]);
  }finally{
    if(loader) loader.style.display = 'none';
  }
}

async function fetchGeoJSON(path){
  if(GEO_CACHE.has(path)) return GEO_CACHE.get(path);
  const resp = await fetch(RAW_URL + path);
  if(!resp.ok) throw new Error("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ: " + path);
  const json = await resp.json();
  GEO_CACHE.set(path, json);
  return json;
}


function setSelectedZoneLabels(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const ids = ['selectedBasinName','selectedAreaName','selectedHeatAreaName','selectedFrostAreaName'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = v;
  });
}


function setSelectedBoundaryLabel(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const el = document.getElementById('selectedBoundaryName');
  if(el) el.textContent = v;
}


function setSelectedStreamLabel(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const el = document.getElementById('selectedStreamName');
  if(el) el.textContent = v;
}

/* ===================== LOAD / MAP / ON-OFF LOGIC ===================== */
async function loadToTool(path, name){
  updateMeteoStatus("Î¦ÏŒÏÏ„Ï‰ÏƒÎ·: " + name + "â€¦");
  try{
    const gj = await fetchGeoJSON(path);

    
    const isBasin = path.includes('data/basins/');
    const isBoundary = path.includes('data/boundaries/');
    const isStream = path.includes('data/streams/') || path.includes('streams/geojson/');

    // Î”Î™ÎŸÎ™ÎšÎ—Î¤Î™ÎšÎ‘ ÎŸÎ¡Î™Î‘: ÎµÎ½Î·Î¼ÎµÏÏÎ½Î¿Î½Ï„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ boundaries (Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Ï…Î½ Ï„Î·Î½ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·)
    if(isBoundary){
      SELECTED_BOUNDARY_GEO = gj;
      SELECTED_BOUNDARY_KEY = path;
      SELECTED_BOUNDARY_NAME = name;
      setSelectedBoundaryLabel(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±): ${name}`);
      return;
    }


    // Î¥Î”Î¡ÎŸÎ“Î¡Î‘Î¦Î™ÎšÎŸ Î”Î™ÎšÎ¤Î¥ÎŸ: ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ streams (Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î·Î½ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·)
    if(isStream){
      SELECTED_STREAM_GEO = gj;
      SELECTED_STREAM_KEY = path;
      SELECTED_STREAM_NAME = name;
      setSelectedStreamLabel(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿): ${name}`);
      return;
    }

// Î•Î Î™Î›Î•Î“ÎœÎ•ÎÎ— Î Î•Î¡Î™ÎŸÎ§Î—/Î–Î©ÎÎ—: ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ basins
    if(isBasin){
      SELECTED_GEO = gj;
      SELECTED_ZONE_KEY = path;
      SELECTED_ZONE_NAME = name;
      SELECTED_ZONE_KIND = 'basin';
      SELECTED_BASIN_KEY = path;

      setSelectedZoneLabels(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();

      // Populate tool inputs ONLY for basins (Ï…Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±)
      const p = getPropsMerged(gj);

      if(p.area!=null)   setVal('area', p.area);
      if(p.length!=null) setVal('length', p.length);
      if(p.height!=null) setVal('height', p.height);
      if(p.coef!=null)   setVal('coef', p.coef);

      if(p.drains!=null)   setVal('drains', p.drains);
      if(p.drainCap!=null) setVal('drainCap', p.drainCap);

      if(p.strWidth!=null) setVal('strWidth', p.strWidth);
      if(p.strZ!=null)     setVal('strZ', p.strZ);
      if(p.strDepth!=null) setVal('strDepth', p.strDepth);

      if(p.strLen!=null)   setVal('strLen', p.strLen);
      if(p.strDrop!=null)  setVal('strDrop', p.strDrop);

      if(p.strType!=null){
        const restoreSel = document.getElementById('strType');
        const val = String(p.strType);
        if(restoreSel && [...restoreSel.options].some(o=>String(o.value)===val)) restoreSel.value = val;
      }

      // IMPORTANT: do NOT auto-open map; do NOT change On/Off here
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ (Î»ÎµÎºÎ¬Î½Î·): ${name}`);

      // Recalculate + redraw (safe even if some values are missing)
      try{ runMasterCalculation(); }catch(_){}
      try{ drawBasinPlan(); }catch(_){}
    } else {
      // non-zone (streams etc): just cache + message
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (cache): ${name}`);
    }


  }catch(e){
    alert("Î£Ï†Î¬Î»Î¼Î±: " + e.message);
    updateMeteoStatus("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚.");
  }
}

// Map preview: opens map, zooms to that layer, WITHOUT changing On/Off
async function previewOnMap(path, name){
  try{
    noteGeoPick(path, name);
    openMapModal();
    const gj = await fetchGeoJSON(path);

    // remove old preview
    if(PREVIEW_LAYER && map){
      map.removeLayer(PREVIEW_LAYER);
      PREVIEW_LAYER = null;
    }

    const cat = categoryFromPath(path);
    PREVIEW_LAYER = L.geoJSON(gj, {
      style: styleForCategory(cat, true)
    }).addTo(map);

    try{
      map.fitBounds(PREVIEW_LAYER.getBounds(), { padding:[20,20] });
    }catch(_){}

    // ensure visible layers remain visible (do not alter VISIBLE)
    syncVisibleLayersToMap();
  }catch(e){
    console.error(e);
    alert("Map error: " + e.message);
  }
}

// On/Off toggle: NO map open; NO zoom; just state + map update if map is open
async function toggleLayer(path, name){
  try{ noteGeoPick(path, name); }catch(_){ }
  const btn = document.getElementById('btn-onoff-' + cssSafe(path));
  const turningOn = !VISIBLE.has(path);

  if(turningOn) VISIBLE.add(path);
  else VISIBLE.delete(path);

  if(btn){
    setOnOffBtn(btn, turningOn);
  }

  // only update map if already open
  if(map) syncVisibleLayersToMap();

  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}

// Turn everything off
function turnAllOff(){
  VISIBLE.clear();
  METEO_PRIMARY_VISIBLE = false;
  METEO_WATCH_VISIBLE = false;
  updateMeteoStationsRowButton();
  clearMeteoStationsPreview();

  // update buttons
  document.querySelectorAll('button[id^="btn-onoff-"]').forEach(b=>{
    setOnOffBtn(b, false);
  });
  if(map) syncVisibleLayersToMap();
}

/* ===================== MAP MODAL ===================== */
function openMapModal(){
  const modal = document.getElementById('mapModal');
  modal.style.display = 'flex';
  if(!map){
    map = L.map('mapBox', { zoomControl:true });
    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    map.setView([38.02, 23.80], 12);
  }
  setTimeout(()=>map.invalidateSize(), 80);
  syncVisibleLayersToMap();
}

function closeMapModal(){
  const modal = document.getElementById('mapModal');
  modal.style.display = 'none';
  // remove preview layer when closing (keeps On/Off layers persistent)
  if(PREVIEW_LAYER && map){
    map.removeLayer(PREVIEW_LAYER);
    PREVIEW_LAYER = null;
  }
  // remove meteo preview markers
  clearMeteoStationsPreview();
}

function categoryFromPath(path){
  if(path.includes('data/boundaries/')) return 'boundaries';
  if(path.includes('data/streams/') || path.includes('streams/geojson/')) return 'streams';
  return 'basins';
}

const LAST_GEO_PICK = { boundaries: null, streams: null, basins: null };

function noteGeoPick(path, name){
  try{
    const cat = categoryFromPath(path);
    if(!cat) return;
    LAST_GEO_PICK[cat] = { path, name, ts: Date.now() };
  }catch(_){}
}

function flashFilesMsg(text){
  try{
    const el = document.getElementById('filesMsg');
    if(!el) return;
    el.textContent = text;
    el.style.display = 'block';
    clearTimeout(window.__filesMsgT);
    window.__filesMsgT = setTimeout(()=>{ try{ el.style.display='none'; }catch(_){} }, 2600);
  }catch(_){}
}

function geoPickFromVisible(cat){
  try{
    for(const p of VISIBLE){
      if(categoryFromPath(p) === cat) return p;
    }
  }catch(_){}
  return null;
}

// Add a specific GeoJSON file to the main (data) panel (â• next to each file)
function geoAddFromRow(cat, path, name){
  try{
    // persist "last pick" for consistency with existing logic
    LAST_GEO_PICK[cat] = { path, name };
    geoAddFromCategory(cat);
  }catch(e){
    console.warn('geoAddFromRow failed', e);
  }
}


function geoAddFromCategory(cat){
  try{
    const last = LAST_GEO_PICK[cat];
    let path = last && last.path;
    let name = last && last.name;

    if(!path){
      const p = geoPickFromVisible(cat);
      if(p){
        path = p;
        name = p.split('/').pop().replace('.geojson','');
      }
    }

    if(!path){
      const label = (cat==='boundaries') ? 'Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±' : (cat==='streams' ? 'Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿' : 'Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚');
      flashFilesMsg(`Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ Î±ÏÏ‡ÎµÎ¯Î¿ Î³Î¹Î± ${label}. Î Î¬Ï„Î·ÏƒÎµ ğŸ—º Map Î® ğŸ‘ On ÏƒÎµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÏÏ„Î±.`);
      return;
    }

    loadToTool(path, name);
    flashFilesMsg(`â• Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎºÎµÎ½Ï„ÏÎ¹ÎºÏŒ panel: ${name}`);
  }catch(e){
    console.warn('geoAddFromCategory failed', e);
  }
}

function geoClearCategory(cat){
  try{
    if(cat === 'boundaries') resetSelectedBoundary();
    else if(cat === 'streams') resetSelectedStream();
    else resetSelectedZone();

    const label = (cat==='boundaries') ? 'Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±' : (cat==='streams' ? 'Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿' : 'Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚');
    flashFilesMsg(`ğŸ§¹ Î•ÎºÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚: ${label}`);
  }catch(e){
    console.warn('geoClearCategory failed', e);
  }
}

function styleForCategory(cat, preview=false){
  if(cat==='boundaries'){
    return { color: preview ? '#e74c3c' : '#c0392b', weight: preview ? 3 : 2, fill:false, dashArray: preview ? '6 4' : null };
  }
  if(cat==='streams'){
    return { color: preview ? '#2ecc71' : '#2980b9', weight: preview ? 4 : 3, fill:false, dashArray: preview ? '6 4' : null };
  }
  // basins
  return { color: preview ? '#27ae60' : '#d35400', weight: preview ? 2 : 2, fill:true, fillOpacity: preview ? 0.12 : 0.18, dashArray: preview ? '6 4' : null };
}

// Ensure map shows exactly all "On" layers (plus preview if present)
async function syncVisibleLayersToMap(){
  if(!map) return;

  // remove cached layers not in VISIBLE
  for(const [path, layer] of LAYER_CACHE.entries()){
    if(!VISIBLE.has(path) && map.hasLayer(layer)){
      map.removeLayer(layer);
    }
  }

  // add layers in VISIBLE
  for(const path of VISIBLE){
    let layer = LAYER_CACHE.get(path);
    if(!layer){
      const gj = await fetchGeoJSON(path);
      const cat = categoryFromPath(path);
      layer = L.geoJSON(gj, { style: styleForCategory(cat, false) });
      LAYER_CACHE.set(path, layer);
    }
    if(!map.hasLayer(layer)) layer.addTo(map);
  }

  // ğŸ“¡ Meteo stations (selected only)
  try{
    await refreshSelectedMeteoMarkers();
  }catch(_){ }

}

/* ===================== PROPERTIES EXTRACTION ===================== */
function getPropsMerged(gj){
  // merge props from FeatureCollection[0].properties or root.properties
  let p = {};
  try{
    if(gj && gj.features && gj.features[0] && gj.features[0].properties){
      p = {...gj.features[0].properties};
    } else if(gj && gj.properties){
      p = {...gj.properties};
    }
  }catch(_){}

  // normalize keys commonly used
  // area
  const area = pickNumber(p, ['A','a','area','Area','A_m2','area_m2','AREA_M2']);
  const length = pickNumber(p, ['L','l','length','Length','L_m','length_m','LEN_M']);
  const height = pickNumber(p, ['H','h','height','Height','H_m','height_m','DROP_M']);
  const coef = pickNumber(p, ['C','c','coef','Coef','runoff','runoff_coef']);

  const drains = pickNumber(p, ['drains','DrainCount','n_drains']);
  const drainCap = pickNumber(p, ['drainCap','DrainCap','drain_cap']);

  const strWidth = pickNumber(p, ['strWidth','b','width']);
  const strZ = pickNumber(p, ['strZ','z','side_slope']);
  const strDepth = pickNumber(p, ['strDepth','h_depth','depth']);

  const strLen = pickNumber(p, ['strLen','stream_len','channel_len']);
  const strDrop = pickNumber(p, ['strDrop','stream_drop','channel_drop']);
  const strType = pickNumber(p, ['strType','manning','n']);

  const out = {};
  if(area!=null) out.area = area;
  if(length!=null) out.length = length;
  if(height!=null) out.height = height;
  if(coef!=null) out.coef = coef;

  if(drains!=null) out.drains = drains;
  if(drainCap!=null) out.drainCap = drainCap;

  if(strWidth!=null) out.strWidth = strWidth;
  if(strZ!=null) out.strZ = strZ;
  if(strDepth!=null) out.strDepth = strDepth;

  if(strLen!=null) out.strLen = strLen;
  if(strDrop!=null) out.strDrop = strDrop;
  if(strType!=null) out.strType = strType;

  return out;
}

function pickNumber(obj, keys){
  for(const k of keys){
    if(obj && obj[k]!=null && String(obj[k]).trim()!==''){
      const n = parseFloat(String(obj[k]).replace(',','.'));
      if(isFiniteNumber(n)) return n;
    }
  }
  return null;
}

/* ===================== METEO: Stations list ===================== */

function normalizeStationUrl(u){
  u = (u || '').trim();
  if(!u) return '';
  // allow protocol-relative or missing scheme
  if(/^https?:\/\//i.test(u)) return u;
  if(/^\/\//.test(u)) return 'https:' + u;
  return 'https://' + u;
}

function parseStationsText(text, sourcePath){
  const entries = [];
  const lines = (text || '').split(/\r?\n/);
  for(const raw of lines){
    const line = (raw || '').trim();
    if(!line) continue;
    if(line.startsWith('#') || line.startsWith('//')) continue;

    let name = '';
    let url  = line;

    if(line.includes('|')){
      const parts = line.split('|');
      name = (parts.shift() || '').trim();
      url  = parts.join('|').trim();
    }else{
      name = url.replace(/^https?:\/\//i,'').slice(0, 60);
    }

    url = normalizeStationUrl(url);
    if(!url) continue;
    if(!name) name = url.replace(/^https?:\/\//i,'').slice(0, 60);

    entries.push({ name, url, from: sourcePath || '' });
  }
  return entries;
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
}

/* ===================== DATETIME: 24h formatting ===================== */
function pad2(n){ return String(n).padStart(2,'0'); }

function formatDateTime24(d){
  if(!(d instanceof Date) || isNaN(d.getTime())) return 'â€”';
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}, ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}

function parseAnyDateTime(ts, opts){
  if(ts == null) return null;
  if(ts instanceof Date) return ts;
  const assumeUTC = !!(opts && opts.assumeUTC);
  const s0 = String(ts).trim();
  if(!s0) return null;

  // Normalize ISO strings with space separator
  const s = s0.replace(/^(\d{4}-\d{2}-\d{2})\s+(\d{1,2}:\d{2})/, '$1T$2');

  // If ISO includes explicit timezone (Z or +/-hh:mm), let Date parse it.
  if(/^\d{4}-\d{2}-\d{2}T\d{1,2}:\d{2}/.test(s) && /(Z|[+-]\d{2}:?\d{2})$/i.test(s)){
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
  }

  // Greek / EU: dd/mm/yyyy, hh:mm(:ss) with optional Ï€.Î¼./Î¼.Î¼.
  if(s0.includes('/')){
    const m = s0.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:,)?\s*(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(Ï€\.Î¼\.|Î¼\.Î¼\.))?/i);
    if(m){
      const day = parseInt(m[1],10);
      const mon = parseInt(m[2],10) - 1;
      const year = parseInt(m[3],10);
      let hh = parseInt(m[4],10);
      const mi = parseInt(m[5],10);
      const ss = parseInt(m[6] || '0',10);
      const mer = (m[7] || '').toLowerCase();

      if(mer.includes('Î¼.Î¼') && hh < 12) hh += 12;
      if(mer.includes('Ï€.Î¼') && hh === 12) hh = 0;

      return new Date(year, mon, day, hh, mi, ss);
    }
  }

  // ISO-like without timezone: yyyy-mm-ddThh:mm(:ss)
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if(m2){
    const year = parseInt(m2[1],10);
    const mon = parseInt(m2[2],10) - 1;
    const day = parseInt(m2[3],10);
    const hh = parseInt(m2[4],10);
    const mi = parseInt(m2[5],10);
    const ss = parseInt(m2[6] || '0',10);
    return assumeUTC ? new Date(Date.UTC(year, mon, day, hh, mi, ss)) : new Date(year, mon, day, hh, mi, ss);
  }

  // Fallback: let Date try (RFC formats, etc.)
  const d = new Date(s0);
  if(!isNaN(d.getTime())) return d;

  return null;
}

function ts24(ts, opts){
  if(ts == null) return 'â€”';
  const d = parseAnyDateTime(ts, opts);
  return d ? formatDateTime24(d) : String(ts);
}

function nowTs24(){
  return formatDateTime24(new Date());
}



function fmtCoord(v, digits=4){
  if(v == null) return 'â€”';
  const n = Number(v);
  if(!isFinite(n)) return 'â€”';
  return n.toFixed(digits);
}
function fmtElev(v){
  if(v == null) return 'â€”';
  const n = Number(v);
  if(!isFinite(n)) return 'â€”';
  return `${Math.round(n)} m`;
}
function getStationMeta(url){
  if(!url) return null;
  if(url === OPEN_METEO_TOKEN){
    return { lat:38.0237, lon:23.8007, elev:null };
  }
  return STATIONS_META.get(url) || null;
}
function updatePrimaryMetaCoords(){
  const url = getPrimaryStationUrl();
  const meta = getStationMeta(url);
  setTxt('stationLat', (meta && meta.lat != null) ? fmtCoord(meta.lat, 4) : 'â€”');
  setTxt('stationLon', (meta && meta.lon != null) ? fmtCoord(meta.lon, 4) : 'â€”');
  setTxt('stationElev', (meta && meta.elev != null) ? fmtElev(meta.elev) : 'â€”');
}

function renderWatchlist(){
  const box = document.getElementById('watchlist');
  if(!box) return;
  box.innerHTML = '';
  if(!watchlist.size){
    box.innerHTML = '<span style="font-size:11px;color:#94a3b8;">(ÎºÎ±Î½Î­Î½Î±Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚)</span>';
    return;
  }
  for(const [url,name] of watchlist.entries()){
    const chip = document.createElement('span');
    chip.className = 'chip watch';
    chip.innerHTML = `<b>${escapeHtml(name)}</b><button title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·" aria-label="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·">âœ•</button>`;
    chip.querySelector('button').addEventListener('click', (e)=>{ 
      e.stopPropagation();
      watchlist.delete(url); 
      renderWatchlist(); 
      saveWatchlist();
      try{ refreshSelectedMeteoMarkers(); }catch(_){ }
      fetchStationData('extras');
    });
    chip.addEventListener('click', ()=>{
      const sel = document.getElementById('monitorStationSelect');
      if(!sel) return;
      const opt = Array.from(sel.options).find(o => o.value === url);
      if(opt){ sel.value = url; sel.dispatchEvent(new Event('change')); }
    });
    box.appendChild(chip);
  }
}

function setPrimaryStation(){
  const sel = document.getElementById('meteoStationSelect');
  if(!sel) return;

  const url = sel.value || '';
  if(!url){
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î•Ï€Î­Î»ÎµÎ¾Îµ ÎºÏÏÎ¹Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒ.', 'warn');
    return;
  }

  // Apply as ACTIVE primary (only on â•)
  const name = (sel.options[sel.selectedIndex]?.textContent || url).trim();
  ACTIVE_PRIMARY_URL = url;
  ACTIVE_PRIMARY_NAME = name;


  // Update meta line coords
  updatePrimaryMetaCoords();
  // update selected stations markers (if layer is On or map preview is used)
  try{ refreshSelectedMeteoMarkers(); }catch(_){ }

  // Make sure histories do not mix across different primary stations
  switchSeriesContext(url === OPEN_METEO_TOKEN ? 'open-meteo' : `url:${url}`);

  // Immediate fetch for active primary + any extras
  updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦', 'neutral');
  fetchStationData('primary');
}

function clearPrimaryStation(){
  const ok = __confirmClear("ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï (UI)", [
    "â€¢ Î˜Î± Î±Ï†Î±Î¹ÏÎµÎ¸ÎµÎ¯ Î¿ ÎºÏÏÎ¹Î¿Ï‚ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÏ€Î¹Î»Î¿Î³Î®.",
    "â€¢ Î˜Î± Î¼Î·Î´ÎµÎ½Î¹ÏƒÏ„Î¿ÏÎ½ Î¿Î¹ Ï„Î¹Î¼Î­Ï‚/ÎµÎ½Î´ÎµÎ¯Î¾ÎµÎ¹Ï‚ Ï„Î¿Ï… ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î·."
  ]);
  if(!ok) return;

  // Clear ACTIVE primary (and keep watchlist/extras intact)
  ACTIVE_PRIMARY_URL = '';
  ACTIVE_PRIMARY_NAME = '';

  try{ refreshSelectedMeteoMarkers(); }catch(_){ }

  const sel = document.getElementById('meteoStationSelect');
  if(sel){
    sel.value = '';
    sel.dispatchEvent(new Event('change'));
  }

  // Clear main station display on the right
  setTxt('stationName','â€”');
  setTxt('stationTimestamp', 'â€”');
  setTxt('stationTimestampInline', 'â€”');
  updateStationFreshnessUI();
  updatePrimaryMetaCoords();
  setTxt('stationRainRate','â€”');
  setTxt('stationDP','â€”');
  setTxt('stationR60','â€”');
  setLatestValuesDisplay(null,'â€”');
  setStationMsg('â€”');

  // Reset series context to default
  switchSeriesContext('open-meteo');

  // Update statuses
  if(watchlist.size){
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ)', 'neutral');
  } else {
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
  }
}

function addToWatchlistFromMonitor(){
  const sel = document.getElementById('monitorStationSelect');
  if(!sel) return;
  const v = String(sel.value || '').trim();

  if(!v){
    updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î•Ï€Î­Î»ÎµÎ¾Îµ ÏƒÏ„Î±Î¸Î¼ÏŒ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚.', 'warn');
    return;
  }

  // ALL ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚
  if(v === ALL_API_TOKEN || v === ALL_WEB_TOKEN || v === ALL_ALL_TOKEN){
    let label = '';
    let pairs = [];

    if(v === ALL_API_TOKEN){
      label = 'API / JSON';
      pairs = getSelectGroupPairs(sel, label);
    }else if(v === ALL_WEB_TOKEN){
      label = 'Web / Links';
      pairs = getSelectGroupPairs(sel, label);
    }else{
      label = 'API + Web';
      pairs = [
        ...getSelectGroupPairs(sel, 'API / JSON'),
        ...getSelectGroupPairs(sel, 'Web / Links')
      ];
    }

    if(!pairs.length){
      updateExtrasStatus(`Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯ Î³Î¹Î± ${label}.`, 'warn');
      return;
    }

    let added = 0;
    for(const {url, name} of pairs){
      if(!watchlist.has(url)) added++;
      watchlist.set(url, name || url);
    }

    renderWatchlist();
    saveWatchlist();
    try{ refreshSelectedMeteoMarkers(); }catch(_){ }
    fetchStationData('extras');
    updateExtrasStatus(`Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ ${added} ÏƒÏ„Î±Î¸Î¼Î¿Î¯ (${label}).`, 'ok');
    return;
  }

  const url = v;
  const name = (sel.options[sel.selectedIndex]?.textContent || url).trim();
  watchlist.set(url, name);

  renderWatchlist();
  saveWatchlist();
  try{ refreshSelectedMeteoMarkers(); }catch(_){ }
  fetchStationData('extras');
}

// backward compat (older UI)
function addToWatchlist(){
  return addToWatchlistFromMonitor();
}

function clearWatchlist(){
  const ok = __confirmClear("ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î•Ï€Î¹Ï€Î»Î­Î¿Î½ Î£Ï„Î±Î¸Î¼ÏÎ½ (Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·)", [
    "â€¢ Î˜Î± Î±Ï†Î±Î¹ÏÎµÎ¸Î¿ÏÎ½ ÎŸÎ›ÎŸÎ™ Î¿Î¹ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯ (watchlist).",
    "â€¢ Î˜Î± ÎºÎ»ÎµÎ¯ÏƒÎ¿Ï…Î½/ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Î¿Î¹ ÎºÎ¬ÏÏ„ÎµÏ‚ & Î¿Î¹ Ï„Î¹Î¼Î­Ï‚ Ï„Î¿Ï…Ï‚ ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î·."
  ]);
  if(!ok) return;

  watchlist.clear();
  renderWatchlist();
  saveWatchlist();
  try{ refreshSelectedMeteoMarkers(); }catch(_){ }

  // reset monitor dropdown back to placeholder
  const monSel = document.getElementById('monitorStationSelect');
  if(monSel){
    monSel.value = '';
    monSel.dispatchEvent(new Event('change'));
  }

  const multi = document.getElementById('stationMultiList');
  if(multi){ multi.style.display='none'; multi.innerHTML=''; }

  updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: (ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎ±Î½)', 'neutral');

  // also reset main station display if there is NO active primary
  if(!getPrimaryStationUrl()){
    setTxt('stationName','â€”');
    setTxt('stationTimestamp', 'â€”');
  setTxt('stationTimestampInline', 'â€”');
  updateStationFreshnessUI();
  setTxt('stationRainRate','â€”');
    setTxt('stationDP','â€”');
    setTxt('stationR60','â€”');
    setLatestValuesDisplay(null,'â€”');
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
  }
}

function getFetchTargets(){
  const primaryUrl = getPrimaryStationUrl();
  const primaryName = primaryUrl ? (getPrimaryStationName() || primaryUrl) : '';
  const targets = [];
  if(primaryUrl) targets.push({url: primaryUrl, name: primaryName, primary:true});
  for(const [url,name] of watchlist.entries()){
    if(url && url !== primaryUrl) targets.push({url, name, primary:false});
  }
  return targets;
}

function renderStationMultiList(results){
  const box = document.getElementById('stationMultiList');
  if(!box) return;
  const primaryUrl = getPrimaryStationUrl();
  const rest = (results||[]).filter(r => !primaryUrl || r.url !== primaryUrl);
  if(!rest.length){ box.style.display='none'; box.innerHTML=''; return; }

  // cache latest fetched results so we can refresh a single station without refetching all
  try{
    MULTI_RESULTS_BY_URL.clear();
    rest.forEach(r=>{ if(r && r.url) MULTI_RESULTS_BY_URL.set(r.url, r); });
  }catch(_){}


const rows = rest.map(r=>{
    const ts = ts24(r.tsText || 'â€”');
    const meta = getStationMeta(r.url);
    const latTxt = (meta && meta.lat != null) ? fmtCoord(meta.lat, 4) : 'â€”';
    const lonTxt = (meta && meta.lon != null) ? fmtCoord(meta.lon, 4) : 'â€”';
    const elevTxt = (meta && meta.elev != null) ? fmtElev(meta.elev) : 'â€”';

    const ageCls = ageClassFromTimestamp(ts);

    const items = makeLatestChipItems(r.latest);
    const chips = items.length
      ? items.map(it => `
          <div class="chip${it.v==='â€”' ? ' empty' : ''}">
            <div class="el">${escapeHtml(it.el)}</div>
            <div class="en">${escapeHtml(it.en)}</div>
            <div class="val">${escapeHtml(it.v)}</div>
          </div>`).join('')
      : `<div style="font-size:11px;color:#94a3b8;padding:4px 0;">â€”</div>`;

    const chipCount = items.length || 12;

    return `<div class="multi-block">
      <div class="multi-row">
        <div class="multi-meta-line">
          <span class="meta-item">
            <span class="multi-name ${ageCls}">${escapeHtml(r.name || 'â€”')}</span>
            <button class="meta-icon-btn no-print" data-u="${encodeURIComponent(r.url || '')}" onclick="event.preventDefault();event.stopPropagation();openStationUrl(decodeURIComponent(this.dataset.u))" title="Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”—</button>
            <button class="meta-icon-btn no-print" data-u="${encodeURIComponent(r.url || '')}" onclick="event.preventDefault();event.stopPropagation();focusStationOnMapByUrl(decodeURIComponent(this.dataset.u))" title="Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·">ğŸ“</button>
            <button class="meta-icon-btn no-print" data-u="${encodeURIComponent(r.url || '')}" onclick="event.preventDefault();event.stopPropagation();refreshExtraStation(decodeURIComponent(this.dataset.u), this)" title="Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï)">âŸ³</button>
          </span>
          <span class="meta-item"><span class="meta-label">Timestamp:</span><span class="multi-ts">${escapeHtml(ts)}</span></span>
          <span class="meta-item"><span class="meta-label">LAT:</span><span class="meta-val">${escapeHtml(latTxt)}</span></span>
          <span class="meta-item"><span class="meta-label">LON:</span><span class="meta-val">${escapeHtml(lonTxt)}</span></span>
          <span class="meta-item"><span class="meta-label">ELEV:</span><span class="meta-val">${escapeHtml(elevTxt)}</span></span>
        </div>
      </div>
      <div class="multi-latest">
        <div class="latest-chips multi" style="--chip-count:${chipCount}">
          ${chips}
        </div>
      </div>
    </div>`;
  }).join('');

  box.style.display = 'block';

  const openAttr = MULTI_DETAILS_OPEN ? 'open' : '';
  box.innerHTML = `
    <details id="multiDetails" ${openAttr} style="margin-top:0;">
      <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;">
        Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯
      </summary>
      <div class="multi-table">${rows}</div>
    </details>
  `;

  // persist open/closed state across re-renders (Load/Live refresh)
  const md = document.getElementById('multiDetails');
  if (md) {
    md.addEventListener('toggle', () => {
      MULTI_DETAILS_OPEN = md.open;
    }, { passive: true });
  }
}


async function readStationsFromTxt(path){
  const resp = await fetch(RAW_URL + path, { cache: 'no-store' });
  if(!resp.ok) throw new Error(`Î”ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ: ${path}`);
  const text = await resp.text();
  return parseStationsText(text, path);
}

function bindStationSelect(){
  if(STATION_SELECT_BOUND) return;
  const sel = document.getElementById('meteoStationSelect');
  if(!sel) return;

  sel.addEventListener('change', ()=>{
    const url = sel.value || '';
    if(!url){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
      return;
    }
    // A new selection is pending until the user presses â•
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î‘Î½Î±Î¼Î¿Î½Î®â€¦', 'neutral');
  });

  STATION_SELECT_BOUND = true;
}


let MONITOR_SELECT_BOUND = false;
function bindMonitorSelect(){
  if(MONITOR_SELECT_BOUND) return;
  const sel = document.getElementById('monitorStationSelect');
  if(!sel) return;

  sel.addEventListener('change', ()=>{
    const url = sel.value || '';
    if(!url){
      updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
      return;
    }
    // A new selection is pending until the user presses â•
    updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î‘Î½Î±Î¼Î¿Î½Î®â€¦', 'neutral');
  });

  MONITOR_SELECT_BOUND = true;
}

// New loader: populate dropdown from folder structure
async function fetchStationsFromFolders(files){
  try{
    const apiTxt = (files||[]).filter(p=>p.startsWith('data/meteostations/api/'));
    const webTxt = (files||[]).filter(p=>p.startsWith('data/meteostations/weblinks/'));
    if(apiTxt.length===0 && webTxt.length===0) return false;

    const apiItems = [];
    const webItems = [];
    const seen = new Set();

    const addItems = (arr, into)=>{
      for(const it of arr){
        const url = normalizeStationUrl(it.url || '');
        if(!url) continue;
        if(seen.has(url)) continue;
        seen.add(url);
        into.push({ name: (it.name||url).trim(), url, from: it.from || '' });
      }
    };

    for(const p of apiTxt){
      const items = await readStationsFromTxt(p);
      addItems(items.map(x=>({name:x.name,url:x.url,from:p})), apiItems);
    }
    for(const p of webTxt){
      const items = await readStationsFromTxt(p);
      addItems(items.map(x=>({name:x.name,url:x.url,from:p})), webItems);
    }

    const fill = (sel, placeholder)=>{
      if(!sel) return;
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      sel.appendChild(opt0);

      const grpApi  = document.createElement('optgroup'); grpApi.label  = 'API / JSON';
      const grpLink = document.createElement('optgroup'); grpLink.label = 'Web / Links';


      // Global/Quick ALL (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·)
      let grpAll = null;
      if(sel.id === 'monitorStationSelect'){
        grpAll = document.createElement('optgroup');
        grpAll.label = 'ALL';

        const optAll = document.createElement('option');
        optAll.value = ALL_ALL_TOKEN;
        optAll.textContent = 'ALL (API + Web)';
        grpAll.appendChild(optAll);

        const optAllApi = document.createElement('option');
        optAllApi.value = ALL_API_TOKEN;
        optAllApi.textContent = 'ALL (API / JSON)';
        grpApi.appendChild(optAllApi);

        const optAllWeb = document.createElement('option');
        optAllWeb.value = ALL_WEB_TOKEN;
        optAllWeb.textContent = 'ALL (Web / Links)';
        grpLink.appendChild(optAllWeb);
      }

      // Built-in Open-Meteo (no external file required)
      {
        const opt = document.createElement('option');
        opt.value = OPEN_METEO_TOKEN;
        opt.textContent = 'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)';
        grpApi.appendChild(opt);
      }

      for(const it of apiItems){
        const opt = document.createElement('option');
        opt.value = it.url;
        opt.textContent = it.name;
        if(it.from) opt.dataset.from = it.from;
        grpApi.appendChild(opt);
      }
      for(const it of webItems){
        const opt = document.createElement('option');
        opt.value = it.url;
        opt.textContent = it.name;
        if(it.from) opt.dataset.from = it.from;
        grpLink.appendChild(opt);
      }

      if(grpAll) sel.appendChild(grpAll);
      sel.appendChild(grpApi);
      sel.appendChild(grpLink);
    };

    fill(document.getElementById('meteoStationSelect'), 'Î•Ï€Î¹Î»Î¿Î³Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï...');
    fill(document.getElementById('monitorStationSelect'), 'Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚...');

    bindStationSelect();
    bindMonitorSelect();
    updateMeteoStatus(`Î£Ï„Î±Î¸Î¼Î¿Î¯: API ${apiItems.length}, Web ${webItems.length}`, 'neutral');
    return true;
  }catch(err){
    console.warn('stations from folders failed', err);
    return false;
  }
}


async function fetchStations(path){
  try{
    const resp = await fetch(RAW_URL + path);
    const text = await resp.text();
    const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);

    const apiItems = [];
    const webItems = [];

    for(const line of lines){
      let name="", url=line;
      let lat=null, lon=null, elev=null;

      if(line.includes('|')){
        const parts = line.split('|').map(p=>String(p||'').trim());
        name = (parts[0]||'').trim();
        url  = (parts[1]||'').trim();
        lat  = parts[2] ? parseFloat(parts[2]) : null;
        lon  = parts[3] ? parseFloat(parts[3]) : null;
        elev = parts[4] ? parseFloat(parts[4]) : null;
      }else{
        name = url.replace(/^https?:\/\//,'').slice(0,50);
      }

      url = normalizeStationUrl(url);

      if(!url) continue;

      // Store meta if provided (lat/lon/elev) - used for map markers (selected only)
      const latOk = Number.isFinite(lat);
      const lonOk = Number.isFinite(lon);
      const elevOk = Number.isFinite(elev);

      const prev = STATIONS_META.get(url);
      const prevHasCoords = prev && Number.isFinite(prev.lat) && Number.isFinite(prev.lon);

      // Prefer new coordinates when available; otherwise keep existing if any
      if(!prev || (latOk && lonOk) || !prevHasCoords){
        STATIONS_META.set(url, {
          name: name || (prev ? prev.name : 'Station'),
          url,
          lat: (latOk ? lat : (prev ? prev.lat : null)),
          lon: (lonOk ? lon : (prev ? prev.lon : null)),
          elev: (elevOk ? Math.round(elev) : (prev ? prev.elev : null))
        });
      }else if(name && prev && !prev.name){
        prev.name = name;
      }

      const isApi = /(exec|api|json|\?)/i.test(url) && !/penteli\.meteo\.gr\/stations/i.test(url);
      (isApi ? apiItems : webItems).push({name: name || 'Station', url, from: path});
    }

    const fill = (sel, placeholder)=>{
      if(!sel) return;
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      sel.appendChild(opt0);

      const grpApi  = document.createElement('optgroup'); grpApi.label  = 'API / JSON';
      const grpLink = document.createElement('optgroup'); grpLink.label = 'Web / Links';


      // Global/Quick ALL (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·)
      let grpAll = null;
      if(sel.id === 'monitorStationSelect'){
        grpAll = document.createElement('optgroup');
        grpAll.label = 'ALL';

        const optAll = document.createElement('option');
        optAll.value = ALL_ALL_TOKEN;
        optAll.textContent = 'ALL (API + Web)';
        grpAll.appendChild(optAll);

        const optAllApi = document.createElement('option');
        optAllApi.value = ALL_API_TOKEN;
        optAllApi.textContent = 'ALL (API / JSON)';
        grpApi.appendChild(optAllApi);

        const optAllWeb = document.createElement('option');
        optAllWeb.value = ALL_WEB_TOKEN;
        optAllWeb.textContent = 'ALL (Web / Links)';
        grpLink.appendChild(optAllWeb);
      }

      // Built-in Open-Meteo (no external file required)
      {
        const opt = document.createElement('option');
        opt.value = OPEN_METEO_TOKEN;
        opt.textContent = 'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)';
        grpApi.appendChild(opt);
      }

      for(const it of apiItems){
        const opt = document.createElement('option');
        opt.value = it.url;
        opt.textContent = it.name;
        opt.dataset.from = it.from;
        grpApi.appendChild(opt);
      }
      for(const it of webItems){
        const opt = document.createElement('option');
        opt.value = it.url;
        opt.textContent = it.name;
        opt.dataset.from = it.from;
        grpLink.appendChild(opt);
      }
      if(grpAll) sel.appendChild(grpAll);
      sel.appendChild(grpApi);
      sel.appendChild(grpLink);
    };

    fill(document.getElementById('meteoStationSelect'), 'Î•Ï€Î¹Î»Î¿Î³Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï...');
    fill(document.getElementById('monitorStationSelect'), 'Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚...');

    bindStationSelect();
    bindMonitorSelect();
  }catch(e){
    console.error(e);
  }
}

function openPrimaryWeb(){
  // Prefer pending selection (dropdown). If empty, fallback to active primary (if any).
  const url = getPendingPrimaryUrl() || getPrimaryStationUrl();
  if(!url){
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚.', 'warn');
    return;
  }
  if(url === OPEN_METEO_TOKEN) { window.open('https://open-meteo.com/', '_blank'); return; }
  window.open(normalizeStationUrl(url), '_blank');
}
function openMonitorWeb(){
  // Open ALL monitored (watchlist) stations
  if(watchlist && watchlist.size){
    let opened = 0;
    const primaryUrl = getPrimaryStationUrl();
    for(const [url] of watchlist.entries()){
      if(primaryUrl && url === primaryUrl) continue;
      if(!url) continue;
      if(url === OPEN_METEO_TOKEN) { window.open('https://open-meteo.com/', '_blank'); opened++; continue; }
      window.open(normalizeStationUrl(url), '_blank');
      opened++;
    }
    if(opened) updateExtrasStatus(`Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î†Î½Î¿Î¹Î¾Î±Î½ ${opened} ÏƒÏ„Î±Î¸Î¼Î¿Î¯ ÏƒÎµ Î½Î­ÎµÏ‚ ÎºÎ±ÏÏ„Î­Î»ÎµÏ‚.`, 'ok');
    else updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î³ÎºÏ…ÏÎ± URLs.', 'warn');
    return;
  }

  // Fallback: open currently selected option (if any)
  const sel = document.getElementById('monitorStationSelect');
  const url = String(sel?.value || '').trim();

  if(!url){
    updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î”ÎµÎ½ Î­Ï‡Î¿Ï…Î½ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÏƒÏ„Î±Î¸Î¼Î¿Î¯ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚.', 'warn');
    return;
  }

  // ALL ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚: Î¬Î½Î¿Î¹Î³Î¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ links Ï„Î·Ï‚ Î¿Î¼Î¬Î´Î±Ï‚ (Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ watchlist)
  if(url === ALL_API_TOKEN || url === ALL_WEB_TOKEN || url === ALL_ALL_TOKEN){
    let label = '';
    let pairs = [];

    if(url === ALL_API_TOKEN){
      label = 'API / JSON';
      pairs = getSelectGroupPairs(sel, label);
    }else if(url === ALL_WEB_TOKEN){
      label = 'Web / Links';
      pairs = getSelectGroupPairs(sel, label);
    }else{
      label = 'API + Web';
      pairs = [
        ...getSelectGroupPairs(sel, 'API / JSON'),
        ...getSelectGroupPairs(sel, 'Web / Links')
      ];
    }

    let opened = 0;
    for(const {url:u} of pairs){
      if(!u) continue;
      if(u === OPEN_METEO_TOKEN) { window.open('https://open-meteo.com/', '_blank'); opened++; continue; }
      window.open(normalizeStationUrl(u), '_blank');
      opened++;
    }

    if(opened) updateExtrasStatus(`Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î†Î½Î¿Î¹Î¾Î±Î½ ${opened} links (${label}).`, 'ok');
    else updateExtrasStatus(`Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î³ÎºÏ…ÏÎ± URLs Î³Î¹Î± ${label}.`, 'warn');
    return;
  }

  if(url === OPEN_METEO_TOKEN) { window.open('https://open-meteo.com/', '_blank'); return; }
  window.open(normalizeStationUrl(url), '_blank');
}

// backward compat
function openStationWeb(){ return openPrimaryWeb(); }

/* ===================== STATION ACTIONS (per station) ===================== */
function openStationUrl(url){
  const u = String(url || '').trim();
  if(!u) return;
  if(u === OPEN_METEO_TOKEN){ window.open('https://open-meteo.com/', '_blank'); return; }
  window.open(normalizeStationUrl(u), '_blank');
}

function openPrimaryActiveUrl(){
  const url = getPrimaryStationUrl();
  if(!url){
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚.', 'warn');
    return;
  }
  openStationUrl(url);
}

function focusStationOnMapByUrl(url){
  const u = String(url || '').trim();
  if(!u) return;
  let meta = null;
  try{ meta = getStationMeta(u); }catch(_){}
  // fallback for Openâ€‘Meteo token (approx Chalandri)
  if(!meta && u === OPEN_METEO_TOKEN){
    meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
  }
  if(meta && typeof meta.lat === 'number' && typeof meta.lon === 'number'){
    try{ __dbFocusMap(meta.lat, meta.lon, meta.name || 'Î£Ï„Î±Î¸Î¼ÏŒÏ‚'); }catch(_){}
  }else{
    try{
      if(typeof updatePrimaryStatus === 'function'){
        updatePrimaryStatus('Î§Î¬ÏÏ„Î·Ï‚: Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÏ…Î½Ï„ÎµÏ„Î±Î³Î¼Î­Î½ÎµÏ‚ Î³Î¹Î± Ï„Î¿Î½ ÏƒÏ„Î±Î¸Î¼ÏŒ.', 'warn');
      }
    }catch(_){}
  }
}

function openPrimaryActiveMap(){
  const url = getPrimaryStationUrl();
  if(!url){
    try{ if(typeof updatePrimaryStatus==='function') updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚.', 'warn'); }catch(_){}
    return;
  }
  focusStationOnMapByUrl(url);
}


function __setBtnBusy(btn, busy){
  if(!btn) return;
  btn.disabled = !!busy;
  btn.classList.toggle('spinning', !!busy);
}

function refreshPrimaryOnly(btn){
  __setBtnBusy(btn, true);
  Promise.resolve(fetchStationData('primary')).finally(()=> __setBtnBusy(btn, false));
}

async function refreshExtraStation(url, btn){
  const u0 = String(url || '').trim();
  if(!u0) return;
  const u = normalizeStationUrl(u0) || u0;
  const name = (watchlist && watchlist.get(u)) || (getStationMeta(u)?.name) || u;

  __setBtnBusy(btn, true);
  try{
    const r = await fetchStationDataSingle(u, name, false);
    if(r){
      MULTI_RESULTS_BY_URL.set(u, r);
      renderStationMultiList(Array.from(MULTI_RESULTS_BY_URL.values()));
    }
  }catch(e){
    console.error(e);
  }finally{
    __setBtnBusy(btn, false);
  }
}


/* ===================== METEO: Fetch (API button) ===================== */

async function fetchStationDataSingle(url, label, updatePrimary){
  if(!url) return null;

  if(updatePrimary){
    // Primary station has its own context (do not mix histories across different sources)
    switchSeriesContext(url === OPEN_METEO_TOKEN ? 'open-meteo' : `url:${url}`);
    updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦", "neutral");
    setTxt('stationName', label || 'â€”');
  }

  try{
    // 0) Built-in Openâ€‘Meteo (token)
    if(url === OPEN_METEO_TOKEN){
      const r = await fetchOpenMeteoPayload();
      lastStationPayload = r;

      const latest = parseOpenMeteoLatest(r);
      const rr = (latest && latest.rr!=null) ? latest.rr : null;

      const tsRaw = latest?.__openMeteo?.time || r?.current?.time || new Date().toISOString();
      const ts = ts24(tsRaw);

      const seriesKey = updatePrimary ? currentStationKey : (`url:${url}`);
      const totalsSeries = deriveCumulativeTotalsForKey(seriesKey, latest?.__openMeteo?.amount);

      if(updatePrimary){
        updateStationMonitor(rr!=null ? rr : null, ts, totalsSeries);
        setLatestValuesDisplay(latest, buildLatestLine(latest));
        setStationMsg('Î›Î®ÏˆÎ· Î±Ï€ÏŒ Openâ€‘Meteo.');

        if(rr!=null){
          onNewStationSample(String(ts), ts, rr, label || 'Openâ€‘Meteo', totalsSeries, latest);
          runMasterCalculation();
        }
      }

      if(!updatePrimary && rr!=null){
        storeSampleForKey(seriesKey, String(ts), ts, rr, label || 'Openâ€‘Meteo', totalsSeries, false, latest);
      }

      return { ok:true, url, name: label, rr, tsText: ts, latest: latest, latestLine: buildLatestLine(latest) };
    }

    // 1) If URL is a JSON endpoint
    if(/json|api|exec|\?/i.test(url) && !/penteli\.meteo\.gr\/stations/i.test(url)){
      const r = await fetch(url, {cache:'no-store'}).then(res=>res.json());
      lastStationPayload = r;

      // Openâ€‘Meteo payload: fill ALL latest chips from the API
      if(isOpenMeteoPayload(r)){
        const latest = parseOpenMeteoLatest(r);
        const rr = (latest && latest.rr!=null) ? latest.rr : null;

        const tsRaw = latest?.__openMeteo?.time || extractTimestamp(r) || new Date().toISOString();
        const ts = ts24(tsRaw);

        const seriesKey = updatePrimary ? currentStationKey : (`url:${url}`);
        const totalsSeries = deriveCumulativeTotalsForKey(seriesKey, latest?.__openMeteo?.amount);

        if(updatePrimary){
          updateStationMonitor(rr!=null ? rr : null, ts, totalsSeries);
          setLatestValuesDisplay(latest, buildLatestLine(latest));
setStationMsg("Î›Î®ÏˆÎ· Î±Ï€ÏŒ Openâ€‘Meteo endpoint.");

          // Î Î‘ÎÎ¤Î‘: ÎºÏÎ¬Ï„Î± Î´ÎµÎ¯Î³Î¼Î± Î³Î¹Î± Ï„Î¿ Monitoring/Scenario Î±ÎºÏŒÎ¼Î· ÎºÎ¹ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ RainRate (rr)
          onNewStationSample(String(ts), ts, (rr!=null ? rr : null), label || 'Openâ€‘Meteo', totalsSeries, latest);

          // ÎœÏŒÎ½Î¿ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ rr Î­Ï‡ÎµÎ¹ Î½ÏŒÎ·Î¼Î± Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹ Î¿ Ï…Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
          if(rr!=null){
            runMasterCalculation();
          }
        }

        if(!updatePrimary && rr!=null){
          storeSampleForKey(seriesKey, String(ts), ts, rr, label || 'Openâ€‘Meteo', totalsSeries, false, latest);
        }

        return { ok:true, url, name: label, rr, tsText: ts, latest: latest, latestLine: buildLatestLine(latest) };
      }


      const rr = extractRainRate(r);
      const tsRaw = extractTimestamp(r) || new Date().toISOString();
      const ts = ts24(tsRaw);
      const totals = extractTotals(r);

      if(updatePrimary){
        setTxt('stationTimestamp', ts);
  setTxt('stationTimestampInline', ts);
  updateStationFreshnessUI();
  setTxt('stationRainRate', (rr!=null && isFiniteNumber(rr)) ? rr.toFixed(1) : 'â€”');
        setTxt('stationTotalSrc', totals.totalSrc === 'storm' ? '(storm)' : totals.totalSrc === 'today' ? '(today)' : '');
        // compact Latest line for JSON endpoints (usually only rain metrics are available)
        {
          const parts = [];
          if(rr!=null && isFiniteNumber(rr)) parts.push(`Rate ${rr.toFixed(1)} mm/h`);
          if(totals && totals.today!=null) parts.push(`Today ${totals.today.toFixed(1)} mm`);
          if(totals && totals.storm!=null) parts.push(`Storm ${totals.storm.toFixed(1)} mm`);
          setLatestValuesDisplay({ rr: rr, today: (totals && totals.today!=null ? totals.today : null), storm: (totals && totals.storm!=null ? totals.storm : null) }, parts.length ? parts.join(' â€¢ ') : 'â€”');
        }
setStationMsg("Î›Î®ÏˆÎ· Î±Ï€ÏŒ endpoint.");

        // Î Î‘ÎÎ¤Î‘: ÎºÏÎ¬Ï„Î± Î´ÎµÎ¯Î³Î¼Î± Î³Î¹Î± Monitoring/Scenario Î±ÎºÏŒÎ¼Î· ÎºÎ¹ Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ RainRate (rr)
        onNewStationSample(String(ts), ts, (rr!=null ? rr : null), label || 'Station', totals, (parsed && parsed.latest) ? parsed.latest : null);

        runMasterCalculation();
      }

      if(!updatePrimary && rr!=null){
        // keep separate history for this station even when it is in "Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯"
        storeSampleForKey(`url:${url}`, String(ts), ts, rr, label || 'Station', totals, false, (parsed && parsed.latest) ? parsed.latest : null);
      }

      return { ok:true, url, name: label, rr, tsText: ts, latest: { rr: rr, today: (totals && totals.today!=null) ? totals.today : null, storm: (totals && totals.storm!=null) ? totals.storm : null }, latestLine: null };
    }

    // 2) If it's a meteo station page (Penteli)
    if(/penteli\.meteo\.gr\/stations/i.test(url)){
      const mirrorUrl = url.startsWith('https://') ? ('https://r.jina.ai/' + url) : ('https://r.jina.ai/https://' + url);
      const text = await fetch(mirrorUrl, {cache:'no-store'}).then(res=>res.text());

      const parsed = parseMeteoPageMinimal(text);
      const rr = parsed?.rr ?? null;
      const tsRaw = parsed?.timestamp ?? new Date().toISOString();
      const ts = ts24(tsRaw, {assumeUTC: !!parsed?.timestampIsUTC});
      const totals = parsed?.totals ?? null;

      if(updatePrimary){
        setTxt('stationTimestamp', ts);
  setTxt('stationTimestampInline', ts);
  updateStationFreshnessUI();
  setTxt('stationRainRate', (rr!=null && isFiniteNumber(rr)) ? rr.toFixed(1) : 'â€”');
        setTxt('stationTotalSrc', totals && totals.totalSrc === 'storm' ? '(storm)' : totals && totals.totalSrc === 'today' ? '(today)' : '');
        setLatestValuesDisplay((parsed && parsed.latest) ? parsed.latest : null, (parsed && parsed.latestLine) ? parsed.latestLine : 'â€”');
setStationMsg("Î›Î®ÏˆÎ· Î¼Î­ÏƒÏ‰ mirror (r.jina.ai).");

        // keep a sample for Monitoring/Scenario (primary) even if RainRate is missing
        onNewStationSample(String(ts), ts, (rr!=null ? rr : null), label || 'Station', totals, (parsed && parsed.latest) ? parsed.latest : null);

        // Only if there is a rain rate does the hydrology calculation add value
        if(rr!=null){
          runMasterCalculation();
        }
      }

      if(!updatePrimary && rr!=null){
        // keep separate history for this station even when it is in "Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯"
        storeSampleForKey(`url:${url}`, String(ts), ts, rr, label || 'Station', totals, false, (parsed && parsed.latest) ? parsed.latest : null);
      }

      return { ok:true, url, name: label, rr, tsText: ts, latest: (parsed && parsed.latest) ? parsed.latest : null, latestLine: (parsed && parsed.latestLine) ? parsed.latestLine : null };
    }

    if(updatePrimary){
      updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ API â€” Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿ Web.", "warn");
      setStationMsg("ÎœÎ·-API ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚.");
    }
    return { ok:false, url, name: label, rr: null, tsText: 'â€”', latest: null, latestLine: null, error: "ÎœÎ· Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î¿Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚ (ÏŒÏ‡Î¹ API)." };

  }catch(e){
    console.error(e);
    if(updatePrimary){
      updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î£Ï†Î¬Î»Î¼Î± Î»Î®ÏˆÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.", "warn");
      setStationMsg("Î£Ï†Î¬Î»Î¼Î±: " + e.message);
    }
    return { ok:false, url, name: label, rr: null, tsText: 'â€”', latest: null, latestLine: null, error: (e && e.message) ? e.message : String(e) };
  }
}

async function fetchStationData(mode='both'){
  const allTargets = getFetchTargets();
  const primaryTarget = allTargets.find(t => t.primary);
  const extrasTargetsAll = allTargets.filter(t => !t.primary);

  // Select targets based on mode
  let targets = allTargets;
  if(mode === 'primary'){
    targets = primaryTarget ? [primaryTarget] : [];
  } else if(mode === 'extras'){
    targets = extrasTargetsAll;
  }

  // Handle empty based on mode (do NOT touch the other status pill)
  if(mode === 'primary'){
    if(!primaryTarget){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î•Ï€Î­Î»ÎµÎ¾Îµ ÎºÏÏÎ¹Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒ.', 'warn');
      return;
    }
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦', 'neutral');
  } else if(mode === 'extras'){
    if(!extrasTargetsAll.length){
      updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚.', 'neutral');
      const multi = document.getElementById('stationMultiList');
      if(multi){ multi.style.display='none'; multi.innerHTML=''; }
      return;
    }
    updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î›Î®ÏˆÎ·â€¦', 'neutral');
  } else {
    if(!allTargets.length){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î•Ï€Î­Î»ÎµÎ¾Îµ ÎºÏÏÎ¹Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒ.', 'warn');
      updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚.', 'neutral');
      return;
    }

    if(primaryTarget) updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦', 'neutral');
    else updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');

    if(extrasTargetsAll.length) updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î›Î®ÏˆÎ·â€¦', 'neutral');
    else updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: (ÎºÎ±Î½Î­Î½Î±Ï‚)', 'neutral');
  }

  const settled = await Promise.allSettled(
    targets.map(t => fetchStationDataSingle(t.url, t.name, t.primary))
  );

  const results = [];
  let primaryErr = null;
  let primaryOk = false;
  const extrasErrors = [];

  settled.forEach((s, i)=>{
    const t = targets[i];
    if(s.status === 'fulfilled'){
      if(s.value) results.push(s.value);

      if(t.primary){
        if(s.value && s.value.ok === true){
          primaryOk = true;
        } else {
          const er = (s.value && s.value.error) ? s.value.error : 'Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±';
          primaryErr = `${t.name || t.url}: ${er}`;
        }
      } else {
        if(!(s.value && s.value.ok === true)){
          const nm = (s.value?.name || t.name || t.url);
          const er = (s.value?.error || 'Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±');
          extrasErrors.push(`${nm}: ${er}`);
        }
      }
    } else {
      const er = (s.reason && s.reason.message) ? s.reason.message : String(s.reason || 'ÏƒÏ†Î¬Î»Î¼Î±');
      if(t.primary){
        primaryErr = `${t.name || t.url}: ${er}`;
      } else {
        extrasErrors.push(`${t.name || t.url}: ${er}`);
      }
    }
  });

  // Update multi list only when we fetched extras (or both)
  if(mode !== 'primary'){
    renderStationMultiList(results);
  }

  // Primary status (only when we fetched primary, or both)
  if(mode !== 'extras' && primaryTarget){
    if(primaryOk && !primaryErr){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ· OK', 'ok');
    } else {
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·: ' + (primaryErr || 'Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±'), 'warn');
    }
  }

  // Extras status (only when we fetched extras, or both)
  if(mode !== 'primary' && extrasTargetsAll.length){
    if(extrasErrors.length){
      const short = extrasErrors.length <= 2
        ? extrasErrors.join(' â€¢ ')
        : (extrasErrors.slice(0,2).join(' â€¢ ') + ` â€¢ (+${extrasErrors.length-2} Î±ÎºÏŒÎ¼Î·)`);
      updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·: ' + short, 'warn');
    } else {
      updateExtrasStatus('Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î›Î®ÏˆÎ· OK', 'ok');
    }
  }
}



function getOpenMeteoCoords(){
  // default coords near Chalandri
  let lat = 38.02, lon = 23.80;

  // if selected basin exists, use first coordinate as quick proxy
  try{
    if(SELECTED_GEO && SELECTED_GEO.features && SELECTED_GEO.features[0]){
      const g = SELECTED_GEO.features[0].geometry;
      let c = null;
      if(g.type === 'Polygon') c = g.coordinates?.[0]?.[0];
      if(g.type === 'MultiPolygon') c = g.coordinates?.[0]?.[0]?.[0];
      if(g.type === 'LineString') c = g.coordinates?.[0];
      if(Array.isArray(c) && c.length>=2){
        lon = c[0]; lat = c[1];
      }
    }
  }catch(e){ /* ignore */ }

  return {lat, lon};
}

async function fetchOpenMeteoPayload(){
  const {lat, lon} = getOpenMeteoCoords();

  const currentVars = [
    'temperature_2m',
    'relative_humidity_2m',
    'apparent_temperature',
    'precipitation',
    'pressure_msl',
    'surface_pressure',
    'wind_speed_10m',
    'wind_direction_10m'
  ].join(',');

  const hourlyVars = ['dew_point_2m','precipitation'].join(',');
  const dailyVars  = ['rain_sum','precipitation_sum'].join(',');

  const u = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=${encodeURIComponent(dailyVars)}&hourly=${encodeURIComponent(hourlyVars)}&current=${encodeURIComponent(currentVars)}&timezone=Europe%2FAthens&forecast_days=1&forecast_hours=1&past_hours=1`;

  const r = await fetch(u, {cache:'no-store'}).then(res=>res.json());
  if(r && r.error) throw new Error(r.reason || 'Openâ€‘Meteo error');
  return r;
}

/* ===== Open-Meteo button (uses basin centroid if available) ===== */
async function fetchLiveMeteo(){
  updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦", "neutral");

  // Treat Open-Meteo as its own source/context
  switchSeriesContext('open-meteo');
  setTxt('stationName','Openâ€‘Meteo');

  try{
    const r = await fetchOpenMeteoPayload();

    const latest = parseOpenMeteoLatest(r);
    const rr = latest?.rr ?? null;
    const tsRaw = latest?.__openMeteo?.time || r?.current?.time || new Date().toISOString();
    const ts = ts24(tsRaw);

    // Build derived cumulative totals so Î”P/R60 work
    const totalsSeries = deriveCumulativeTotalsForKey(currentStationKey, latest?.__openMeteo?.amount);

    updateStationMonitor(rr!=null ? rr : null, ts, totalsSeries);
    setLatestValuesDisplay(latest, buildLatestLine(latest));
    updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ· OK", "ok");

    if(rr!=null){
      onNewStationSample(String(ts), ts, rr, 'Openâ€‘Meteo', totalsSeries, latest);
      setStationMsg("Live Î±Ï€ÏŒ Openâ€‘Meteo (current + hourly + daily).");
      runMasterCalculation();
    } else {
      setStationMsg("Openâ€‘Meteo: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Ï„Î¹Î¼Î® Î²ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·Ï‚.");
    }

  }catch(e){
    console.error(e);
    updatePrimaryStatus("ÎšÏÏÎ¹Î¿Ï‚: Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·: Î£Ï†Î¬Î»Î¼Î± Openâ€‘Meteo", "warn");
    setStationMsg("Î£Ï†Î¬Î»Î¼Î± Openâ€‘Meteo: " + e.message);
  }
}

/* ===================== Station monitor logic ===================== */
function extractRainRate(obj){
  // common keys (explicit mm/h)
  const keys = ['rainRate_mmh','rain_rate','rainRate','i','intensity','precipitation_rate','precip_rate'];
  for(const k of keys){
    if(obj && obj[k]!=null){
      const n = parseFloat(String(obj[k]).replace(',','.'));
      if(isFiniteNumber(n)) return n;
    }
  }

  // Open-Meteo: prefer an explicit rate if present
  const n2 = obj?.current?.precipitation_rate;
  if(isFiniteNumber(n2)) return n2;

  // Open-Meteo: derive rate from precipitation amount and interval (seconds)
  const p = obj?.current?.precipitation;
  const interval = obj?.current?.interval;
  if(isFiniteNumber(p) && isFiniteNumber(interval) && interval > 0){
    return (p * 3600) / interval;
  }

  // Fallback: use hourly precipitation at the nearest hour (treated as mm/h)
  const t = obj?.current?.time;
  if(t && Array.isArray(obj?.hourly?.time) && Array.isArray(obj?.hourly?.precipitation)){
    const idx = nearestTimeIndex(t, obj.hourly.time);
    const hp = obj.hourly.precipitation[idx];
    if(isFiniteNumber(hp)) return hp;
  }

  return null;
}
function extractTimestamp(obj){
  const keys = ['station_ts','timestamp','time','datetime','dateTime','lastUpdate','last_update'];
  for(const k of keys){
    if(obj && obj[k]) return String(obj[k]).trim();
  }
  // open-meteo
  if(obj?.current?.time) return String(obj.current.time);
  return null;
}
function extractTotals(obj){
  const t = {};
  t.today = pickNumber(obj, ['rainToday_mm','rain_today_mm','todayRain','today_rain']);
  t.storm = pickNumber(obj, ['stormTotal_mm','storm_total_mm','rainStorm','storm_total']);
  if(t.storm!=null){ t.total=t.storm; t.totalSrc='storm'; }
  else if(t.today!=null){ t.total=t.today; t.totalSrc='today'; }
  else { t.total=null; t.totalSrc=null; }
  return t;
}

/* ===================== Openâ€‘Meteo helpers ===================== */
function isOpenMeteoPayload(obj){
  return !!(obj && obj.current && (
    obj.current.temperature_2m != null ||
    obj.current.relative_humidity_2m != null ||
    obj.current.apparent_temperature != null ||
    obj.current.pressure_msl != null ||
    obj.current.wind_speed_10m != null
  ));
}

function degToCompass(deg){
  if(deg == null || !isFiniteNumber(deg)) return '';
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  const d = ((Number(deg) % 360) + 360) % 360;
  const i = Math.round(d / 22.5) % 16;
  return dirs[i];
}

function nearestTimeIndex(targetTs, timeArr){
  if(!Array.isArray(timeArr) || !timeArr.length) return 0;
  const t0 = parseAnyDateTime(targetTs);
  if(!t0) return 0;

  let bestI = 0;
  let best = Infinity;
  const t0ms = t0.getTime();

  for(let i=0;i<timeArr.length;i++){
    const d = parseAnyDateTime(timeArr[i]);
    if(!d) continue;
    const diff = Math.abs(d.getTime() - t0ms);
    if(diff < best){
      best = diff;
      bestI = i;
    }
  }
  return bestI;
}

function deriveCumulativeTotalsForKey(seriesKey, amount){
  // Builds a local (session-only) cumulative so Î”P/R60 can work even when the API
  // does not provide storm/today running totals.
  if(amount == null || !isFiniteNumber(amount)) return null;

  const key = seriesKey || currentStationKey || 'open-meteo';
  const series = stationSeriesByKey[key] || [];
  const prev = series.length ? series[series.length-1] : null;
  const prevTotal = (prev && prev.total!=null && isFiniteNumber(prev.total)) ? prev.total : 0;
  const newTotal = prevTotal + Number(amount);

  return { total: newTotal, totalSrc: 'storm', today: null, storm: null };
}

function parseOpenMeteoLatest(obj){
  const r = obj || {};
  const cur = r.current || {};
  const latest = {};

  latest.temp = isFiniteNumber(cur.temperature_2m) ? Number(cur.temperature_2m) : null;
  latest.hum  = isFiniteNumber(cur.relative_humidity_2m) ? Number(cur.relative_humidity_2m) : null;

  // Dew point: prefer current if present, else nearest hourly
  if(isFiniteNumber(cur.dew_point_2m)){
    latest.dew = Number(cur.dew_point_2m);
  } else if(Array.isArray(r?.hourly?.time) && Array.isArray(r?.hourly?.dew_point_2m)){
    const idx = nearestTimeIndex(cur.time || r.hourly.time[r.hourly.time.length-1], r.hourly.time);
    const v = r.hourly.dew_point_2m[idx];
    latest.dew = isFiniteNumber(v) ? Number(v) : null;
  } else {
    latest.dew = null;
  }

  // Wind: speed + compass from degrees
  const ws = isFiniteNumber(cur.wind_speed_10m) ? Number(cur.wind_speed_10m) : null;
  const wd = isFiniteNumber(cur.wind_direction_10m) ? Number(cur.wind_direction_10m) : null;
  if(ws != null){
    const dir = (wd != null) ? degToCompass(wd) : '';
    latest.wind = `${ws.toFixed(1)} km/h${dir ? (' ' + dir) : ''}`;
  }

  // Pressure
  latest.baro = isFiniteNumber(cur.pressure_msl) ? Number(cur.pressure_msl)
              : (isFiniteNumber(cur.surface_pressure) ? Number(cur.surface_pressure) : null);

  // Rain (day totals): use daily rain_sum (rain only) and precipitation_sum (all)
  const d = r.daily || {};
  const dayRain = (Array.isArray(d.rain_sum) && isFiniteNumber(d.rain_sum[0])) ? Number(d.rain_sum[0]) : null;
  const dayPrec = (Array.isArray(d.precipitation_sum) && isFiniteNumber(d.precipitation_sum[0])) ? Number(d.precipitation_sum[0]) : null;
  latest.today = (dayRain != null) ? dayRain : dayPrec;
  latest.storm = (dayPrec != null) ? dayPrec : latest.today;

  // Rain rate: derive from current precipitation amount + interval
  let rr = null;
  let amount = null;
  if(isFiniteNumber(cur.precipitation)){
    amount = Number(cur.precipitation);
    if(isFiniteNumber(cur.interval) && Number(cur.interval) > 0){
      rr = (amount * 3600) / Number(cur.interval);
    } else {
      rr = amount; // fallback (treat as mm/h)
    }
  }
  // fallback: use nearest hourly precipitation (treated as mm/h)
  if(rr == null && Array.isArray(r?.hourly?.time) && Array.isArray(r?.hourly?.precipitation)){
    const idx = nearestTimeIndex(cur.time || r.hourly.time[r.hourly.time.length-1], r.hourly.time);
    const hp = r.hourly.precipitation[idx];
    if(isFiniteNumber(hp)) rr = Number(hp);
  }
  latest.rr = rr;

  // Monthly / yearly not available from forecast endpoint by default
  latest.month = null;
  latest.year  = null;

  // Apparent temperature â†’ show as Wind Chill (cold) or Heat Index (warm)
  const app = isFiniteNumber(cur.apparent_temperature) ? Number(cur.apparent_temperature) : null;
  if(app != null){
    if(latest.temp != null && latest.temp >= 18){
      latest.heat = app;
      latest.chill = null;
    } else {
      latest.chill = app;
      latest.heat = null;
    }
  } else {
    latest.chill = null;
    latest.heat = null;
  }

  latest.__openMeteo = {
    time: cur.time || null,
    interval: isFiniteNumber(cur.interval) ? Number(cur.interval) : null,
    amount: amount
  };

  return latest;
}


function pickMatchFromText(text, rx, group=1){
  const m = text.match(rx);
  return m ? String(m[group]).trim() : null;
}
function pickNumFromText(text, rx, group=1){
  const s = pickMatchFromText(text, rx, group);
  if(s == null) return null;
  const n = parseFloat(String(s).replace(',','.'));
  return isFiniteNumber(n) ? n : null;
}
function fmtNum(n, dec=1){
  return (n!=null && isFiniteNumber(n)) ? Number(n).toFixed(dec) : null;
}
function buildLatestLine(lat){
  if(!lat) return null;
  const parts = [];
  if(lat.temp!=null) parts.push(`T ${fmtNum(lat.temp,1)}Â°C`);
  if(lat.hum!=null) parts.push(`RH ${fmtNum(lat.hum,0)}%`);
  if(lat.dew!=null) parts.push(`Td ${fmtNum(lat.dew,1)}Â°C`);
  if(lat.wind) parts.push(`Wind ${lat.wind}`);
  if(lat.baro!=null) parts.push(`P ${fmtNum(lat.baro,1)} hPa`);
  if(lat.today!=null) parts.push(`Today ${fmtNum(lat.today,1)} mm`);
  if(lat.rr!=null) parts.push(`Rate ${fmtNum(lat.rr,1)} mm/h`);
  if(lat.storm!=null) parts.push(`Storm ${fmtNum(lat.storm,1)} mm`);
  if(lat.month!=null) parts.push(`Month ${fmtNum(lat.month,1)} mm`);
  if(lat.year!=null) parts.push(`Year ${fmtNum(lat.year,1)} mm`);
  if(lat.chill!=null) parts.push(`Chill ${fmtNum(lat.chill,1)}Â°C`);
  if(lat.heat!=null) parts.push(`Heat ${fmtNum(lat.heat,1)}Â°C`);
return parts.length ? parts.join(' â€¢ ') : null;
}



function makeLatestChipItems(lat){
  // Return a FIXED, ordered set of chips so all station rows align perfectly.
  // If a metric is missing, we keep its slot and show "â€”" (styled as .empty).
  if(!lat || typeof lat !== 'object') return [];


  const vTemp  = (lat.temp  != null) ? `${fmtNum(lat.temp,1)} Â°C`  : 'â€”';
  const vHum   = (lat.hum   != null) ? `${fmtNum(lat.hum,0)} %`    : 'â€”';
  const vDew   = (lat.dew   != null) ? `${fmtNum(lat.dew,1)} Â°C`   : 'â€”';
  const vWind  = (lat.wind  != null && String(lat.wind).trim()) ? String(lat.wind).trim() : 'â€”';
  const vBaro  = (lat.baro  != null) ? `${fmtNum(lat.baro,1)} hPa` : 'â€”';

  const vToday = (lat.today != null) ? `${fmtNum(lat.today,1)} mm` : 'â€”';
  const vRr    = (lat.rr    != null) ? `${fmtNum(lat.rr,1)} mm/h`  : 'â€”';
  const vStorm = (lat.storm != null) ? `${fmtNum(lat.storm,1)} mm` : 'â€”';
  const vMonth = (lat.month != null) ? `${fmtNum(lat.month,1)} mm` : 'â€”';
  const vYear  = (lat.year  != null) ? `${fmtNum(lat.year,1)} mm`  : 'â€”';

  const vChill = (lat.chill != null) ? `${fmtNum(lat.chill,1)} Â°C` : 'â€”';
  const vHeat  = (lat.heat  != null) ? `${fmtNum(lat.heat,1)} Â°C`  : 'â€”';

  return [
    { el:'Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±',        en:'Temperature',  v: vTemp  },
    { el:'Î¥Î³ÏÎ±ÏƒÎ¯Î±',            en:'Humidity',     v: vHum   },
    { el:'Î£Î·Î¼ÎµÎ¯Î¿ Î”ÏÏŒÏƒÎ¿Ï…',      en:'Dew Point',    v: vDew   },
    { el:'Î†Î½ÎµÎ¼Î¿Ï‚',             en:'Wind',         v: vWind  },
    { el:'Î’Î±ÏÏŒÎ¼ÎµÏ„ÏÎ¿',          en:'Barometer',    v: vBaro  },

    { el:'Î£Î·Î¼ÎµÏÎ¹Î½ÏŒÏ‚ Î¥ÎµÏ„ÏŒÏ‚',    en:"Today's Rain", v: vToday },
    { el:'Î¡Î±Î³Î´Î±Î¹ÏŒÏ„Î·Ï„Î±',        en:'Rain Rate',    v: vRr    },
    { el:'Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎºÎ±ÎºÎ¿ÎºÎ±Î¹ÏÎ¯Î±',en:'Storm Total',  v: vStorm },
    { el:'ÎœÎ·Î½Î¹Î±Î¯Î¿Ï‚ Î¥ÎµÏ„ÏŒÏ‚',     en:'Monthly Rain', v: vMonth },
    { el:'Î•Ï„Î®ÏƒÎ¹Î¿Ï‚ Î¥ÎµÏ„ÏŒÏ‚',      en:'Yearly Rain',  v: vYear  },

    { el:'Î‘Î¯ÏƒÎ¸Î·ÏƒÎ· ÏˆÏÏ‡Î¿Ï…Ï‚',     en:'Wind Chill',   v: vChill },
    { el:'Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚',  en:'Heat Index',   v: vHeat  },
  ];
}


function setLatestValuesDisplay(lat, lineText){
  // hidden/plain text (for copy/debug)
  if(lineText != null) setTxt('stationLatestValues', lineText);
  else if(lat) setTxt('stationLatestValues', buildLatestLine(lat) || 'â€”');
  else setTxt('stationLatestValues', 'â€”');

  const wrap = document.getElementById('stationLatestChips');
  if(!wrap) return;

  const items = makeLatestChipItems(lat);
  wrap.style.setProperty('--chip-count', String(items.length || 0));

  wrap.innerHTML = '';
  if(!items.length){
    wrap.textContent = 'â€”';
    return;
  }

  for(const it of items){
    const chip = document.createElement('div');
    chip.className = 'chip' + (it.v === 'â€”' ? ' empty' : '');

    const el = document.createElement('div');
    el.className = 'el';
    el.textContent = it.el;

    const en = document.createElement('div');
    en.className = 'en';
    en.textContent = it.en;

    const v = document.createElement('div');
    v.className = 'val';
    v.textContent = it.v;

    chip.appendChild(el);
    chip.appendChild(en);
    chip.appendChild(v);
    wrap.appendChild(chip);
  }
}


function parseMeteoPageMinimal(text){
  const out = { rr: null, timestamp: null, timestampIsUTC: false, totals: null, latest: null, latestLine: null };

  // 1) Prefer the visible timestamp near "Latest Values / Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î¤Î¹Î¼Î­Ï‚" (LOCAL time)
  let mTs = text.match(/(?:Latest Values|Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚\s*Î¤Î¹Î¼Î­Ï‚)[\s\S]{0,160}?(\d{1,2}\/\d{1,2}\/\d{4})\s+(\d{1,2}:\d{2})(?::(\d{2}))?/i);
  if(mTs){
    out.timestamp = `${mTs[1]}, ${mTs[2]}:${mTs[3] || '00'}`;
    out.timestampIsUTC = false;
  }

  // 2) "Timestamp:" style (often present in page source; ISO-like is typically UTC)
  if(!out.timestamp){
    const ts1 = text.match(/Timestamp\s*:?\s*([^\n<]{8,80})/i);
    if(ts1){
      out.timestamp = ts1[1].trim();
      out.timestampIsUTC = /\d{4}-\d{2}-\d{2}/.test(out.timestamp);
    }
  }

  // 3) ISO-like fallback anywhere (treat as UTC)
  if(!out.timestamp){
    const ts2 = text.match(/(\d{4}-\d{2}-\d{2}[T\s]\d{2}:\d{2}(?::\d{2})?)/);
    if(ts2){
      out.timestamp = ts2[1].trim();
      out.timestampIsUTC = true;
    }
  }

  // rain rate (mm/h)
  let m = text.match(/Î’ÏÎ¿Ï‡[^\n]{0,40}?([0-9]+(?:\.[0-9]+)?)\s*mm\/h/i);
  if(!m) m = text.match(/([0-9]+(?:\.[0-9]+)?)\s*mm\/h/i);
  if(m) out.rr = Number(m[1]);

  // totals (today/storm) â€” supports Penteli/NOA pages like Chalandri:
  // "Today's Rain / Î£Î·Î¼ÎµÏÎ¹Î½ÏŒÏ‚ Î¥ÎµÏ„ÏŒÏ‚" and "Storm Total / Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎºÎ±ÎºÎ¿ÎºÎ±Î¹ÏÎ¯Î±"
  let today = null, storm = null;

  const mtoday1 = text.match(/Î£ÏÎ½Î¿Î»Î¿\s*Î—Î¼Î­ÏÎ±Ï‚[\s\S]{0,80}?([0-9]+(?:\.[0-9]+)?)\s*mm/i);
  const mtoday2 = text.match(/(?:Today's\s*Rain|Î£Î·Î¼ÎµÏÎ¹Î½ÏŒÏ‚\s*Î¥ÎµÏ„ÏŒÏ‚)[\s\S]{0,80}?([0-9]+(?:\.[0-9]+)?)\s*mm/i);
  if(mtoday1) today = Number(mtoday1[1]);
  else if(mtoday2) today = Number(mtoday2[1]);

  const mstorm1 = text.match(/Î£ÏÎ½Î¿Î»Î¿\s*ÎšÎ±Ï„Î±Î¹Î³Î¯Î´Î±Ï‚[\s\S]{0,80}?([0-9]+(?:\.[0-9]+)?)\s*mm/i);
  const mstorm2 = text.match(/(?:Storm\s*Total|Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ±\s*ÎºÎ±ÎºÎ¿ÎºÎ±Î¹ÏÎ¯Î±)[\s\S]{0,80}?([0-9]+(?:\.[0-9]+)?)\s*mm/i);
  if(mstorm1) storm = Number(mstorm1[1]);
  else if(mstorm2) storm = Number(mstorm2[1]);

  let total = null, totalSrc = null;
  if(storm != null){ total = storm; totalSrc = 'storm'; }
  else if(today != null){ total = today; totalSrc = 'today'; }

  if(total != null) out.totals = { today, storm, total, totalSrc };

    // ---------- Latest Values (full line) ----------
    const latest = {};
    latest.temp = pickNumFromText(text, /(?:Temperature|Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±)[\s\S]{0,80}?(-?\d+(?:\.\d+)?)\s*Â°\s*C/i);
    latest.hum  = pickNumFromText(text, /(?:Humidity|Î¥Î³ÏÎ±ÏƒÎ¯Î±)[\s\S]{0,80}?(\d+(?:\.\d+)?)\s*%/i);
    latest.dew  = pickNumFromText(text, /(?:Dew\s*Point|Î£Î·Î¼ÎµÎ¯Î¿\s*Î”ÏÏŒÏƒÎ¿Ï…)[\s\S]{0,80}?(-?\d+(?:\.\d+)?)\s*Â°\s*C/i);

    // Wind: "4.8 Km/h at W"
    const windSpeed = pickNumFromText(text, /(?:Wind|Î†Î½ÎµÎ¼Î¿Ï‚)[\s\S]{0,80}?(\d+(?:\.\d+)?)\s*(?:Km\/h|km\/h)/i);
    const windDir   = pickMatchFromText(text, /(?:Wind|Î†Î½ÎµÎ¼Î¿Ï‚)[\s\S]{0,80}?\d+(?:\.\d+)?\s*(?:Km\/h|km\/h)\s*(?:at\s*)?([A-Za-z]{1,3})/i);
    if(windSpeed!=null){
      latest.wind = `${Number(windSpeed).toFixed(1)} km/h${windDir ? (' ' + windDir.toUpperCase()) : ''}`;
    }

    latest.baro = pickNumFromText(text, /(?:Barometer|Î’Î±ÏÏŒÎ¼ÎµÏ„ÏÎ¿)[\s\S]{0,80}?(\d+(?:\.\d+)?)\s*hPa/i);

    // Rain fields
    latest.today = (today!=null ? today : null);
    latest.storm = (storm!=null ? storm : null);
    latest.rr    = (out.rr!=null ? out.rr : null);
    latest.month = pickNumFromText(text, /(?:Monthly\s*Rain|ÎœÎ·Î½Î¹Î±Î¯Î¿Ï‚\s*Î¥ÎµÏ„ÏŒÏ‚)[\s\S]{0,80}?(\d+(?:\.\d+)?)\s*mm/i);
    latest.year  = pickNumFromText(text, /(?:Yearly\s*Rain|Î•Ï„Î®ÏƒÎ¹Î¿Ï‚\s*Î¥ÎµÏ„ÏŒÏ‚)[\s\S]{0,80}?(\d+(?:\.\d+)?)\s*mm/i);

    // Derived indices
    latest.chill = pickNumFromText(text, /(?:Wind\s*Chill|Î‘Î¯ÏƒÎ¸Î·ÏƒÎ·\s*ÏˆÏÏ‡Î¿Ï…Ï‚)[\s\S]{0,80}?(-?\d+(?:\.\d+)?)\s*Â°\s*C/i);
    latest.heat  = pickNumFromText(text, /(?:Heat\s*Index|Î”ÎµÎ¯ÎºÏ„Î·Ï‚\s*Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚)[\s\S]{0,80}?(-?\d+(?:\.\d+)?)\s*Â°\s*C/i);

    // Sunrise / Sunset
    latest.sunrise = pickMatchFromText(text, /(?:Sunrise|Î‘Î½Î±Ï„Î¿Î»Î®)[\s\S]{0,80}?(\d{1,2}:\d{2})/i);
    latest.sunset  = pickMatchFromText(text, /(?:Sunset|Î”ÏÏƒÎ·)[\s\S]{0,80}?(\d{1,2}:\d{2})/i);

    out.latest = latest;
    out.latestLine = buildLatestLine(latest);

  return out;
}

function parseMeteoPage(text){
  // very lightweight heuristic (may vary by station page)
  // Try to find a mm/h value near "Rain Rate" or "mm/h"
  const rx = /([0-9]+(?:\.[0-9]+)?)\s*mm\/h/i;
  const m = text.match(rx);
  const rainRate = m ? parseFloat(m[1]) : null;

  // Try to find a timestamp-like pattern
  const tx = /(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})/;
  const t = text.match(tx);
  const timestamp = t ? t[1] : null;

  return { rainRate, timestamp };
}

function updateStationMonitor(rainRate, tsText, totals){
  setTxt('stationTimestamp', tsText ? ts24(tsText) : 'â€”');
  setTxt('stationRainRate', (rainRate!=null && isFiniteNumber(rainRate)) ? rainRate.toFixed(1) : 'â€”');

  // dp/r60 derived from series
  if(totals && totals.total!=null){
    setTxt('stationTotalSrc', totals.totalSrc === 'storm' ? '(Storm)' : (totals.totalSrc === 'today' ? '(Î£Î®Î¼ÎµÏÎ±)' : ''));
  } else {
    setTxt('stationTotalSrc','');
  }
  updateStationReadouts();
}

function storeSampleForKey(seriesKey, sampleKey, tsText, val, label, totals, updateUI, latest) {
  const key = seriesKey || 'open-meteo';
  if(!sampleKey) return;

  const series = stationSeriesByKey[key] || [];
  // allow update-in-place when the same timestamp key arrives again (e.g. hourly Openâ€‘Meteo refresh)
  const existingIdx = series.findIndex(s => s.key === sampleKey);
  const prev = (existingIdx >= 0)
    ? (existingIdx > 0 ? series[existingIdx-1] : null)
    : (series.length ? series[series.length-1] : null);

  const l = (latest && typeof latest === 'object') ? latest : {};
  const dewV = isFiniteNumber(l.dewPoint) ? l.dewPoint : (isFiniteNumber(l.dew) ? l.dew : null);

  let dp = null;
  if(totals && totals.total!=null && prev && prev.total!=null && prev.totalSrc && prev.totalSrc === totals.totalSrc){
    dp = totals.total - prev.total;
    if(dp < 0) dp = totals.total;
  }

  const dParsed = parseAnyDateTime(tsText) || new Date();
  const dateMs = dParsed.getTime();

  const sampleObj = {
    key: sampleKey,
    tsText: tsText || sampleKey,
    tsMs: dateMs,
    val,
    rainRate: (typeof val === 'number') ? val : null,
    label,
    stationName: (typeof label === 'string' && label.trim()) ? label : null,
    total: totals ? totals.total : null,
    totalSrc: totals ? totals.totalSrc : null,
    dp,
    dateMs,

    // extra metrics (match the "cards" UI + DB table)
    temp: isFiniteNumber(l.temp) ? l.temp : null,
    hum:  isFiniteNumber(l.hum) ? l.hum : null,
    dewPoint: dewV,
    wind: (typeof l.wind === 'string' && l.wind.trim()) ? l.wind : null,
    baro: isFiniteNumber(l.baro) ? l.baro : null,

    today: isFiniteNumber(l.today) ? l.today : (totals && isFiniteNumber(totals.today) ? totals.today : null),
    storm: isFiniteNumber(l.storm) ? l.storm : (totals && isFiniteNumber(totals.storm) ? totals.storm : null),
    month: isFiniteNumber(l.month) ? l.month : null,
    year:  isFiniteNumber(l.year)  ? l.year  : null,

    chill: isFiniteNumber(l.chill) ? l.chill : null,
    heat:  isFiniteNumber(l.heat)  ? l.heat  : null,
    sunrise: (typeof l.sunrise === 'string' && l.sunrise.trim()) ? l.sunrise : null,
    sunset:  (typeof l.sunset  === 'string' && l.sunset.trim())  ? l.sunset  : null
  };

  if(existingIdx >= 0){
    series[existingIdx] = Object.assign(series[existingIdx], sampleObj);
  } else {
    series.push(sampleObj);
  }

  const __lim = getSeriesLimit();
  if(series.length > __lim){
    series.splice(0, series.length - __lim);
  }

  stationSeriesByKey[key] = series;
  stationLastKeyByKey[key] = sampleKey;

  // keep an always-fresh snapshot for Scenario mini-panels
  try{
    if(typeof currentStationKey !== 'undefined' && key === currentStationKey){
      window.__PRIMARY_LATEST_SAMPLE = (existingIdx >= 0) ? series[existingIdx] : (series.length ? series[series.length-1] : null);
    }
  }catch(_){ }

  // ---- FIREBASE LOG (non-blocking) ----
  if(existingIdx < 0){
  try{
    const l = (latest && typeof latest === 'object') ? latest : {};

    // attach station meta (for DB table cohesion + map focus)
    let stationUrl = null, stationName = (label || null), lat = null, lon = null, elev = null;
    try{
      const sk = String(key || '');
      let u = sk;
      if(sk.startsWith('url:')) u = sk.slice(4);
      if(sk === 'open-meteo') u = (typeof OPEN_METEO_TOKEN !== 'undefined') ? OPEN_METEO_TOKEN : sk;
      stationUrl = u;
      let meta = null;
      if(typeof getStationMeta === 'function') meta = getStationMeta(u);
      stationName = meta?.name || stationName;
      lat  = (typeof meta?.lat  === 'number') ? meta.lat  : null;
      lon  = (typeof meta?.lon  === 'number') ? meta.lon  : null;
      elev = (typeof meta?.elev === 'number') ? meta.elev : null;
    }catch(_){}

    const payload = {
      tsMs: dateMs,
      tsText: (tsText || sampleKey),
      sampleKey: sampleKey,
      rainRate: (typeof val === 'number') ? val : null,
      label: label || null,
      stationUrl: stationUrl,
      stationName: stationName,
      lat: (typeof lat === "number") ? lat : null,
      lon: (typeof lon === "number") ? lon : null,
      elev: (typeof elev === "number") ? elev : null,
      dp: (typeof dp === 'number') ? dp : null,
      total: (totals && typeof totals.total === 'number') ? totals.total : null,
      totalSrc: totals ? (totals.totalSrc || null) : null,

      // extra metrics (match the "cards" UI)
      temp: isFiniteNumber(l.temp) ? l.temp : null,
      hum: isFiniteNumber(l.hum) ? l.hum : null,
      dewPoint: isFiniteNumber(l.dewPoint) ? l.dewPoint : (isFiniteNumber(l.dew) ? l.dew : null),
      wind: (typeof l.wind === 'string' && l.wind.trim()) ? l.wind : null,
      baro: isFiniteNumber(l.baro) ? l.baro : null,

      today: isFiniteNumber(l.today) ? l.today : (totals && isFiniteNumber(totals.today) ? totals.today : null),
      storm: isFiniteNumber(l.storm) ? l.storm : (totals && isFiniteNumber(totals.storm) ? totals.storm : null),
      month: isFiniteNumber(l.month) ? l.month : (totals && isFiniteNumber(totals.month) ? totals.month : null),
      year: isFiniteNumber(l.year) ? l.year : (totals && isFiniteNumber(totals.year) ? totals.year : null),

      chill: isFiniteNumber(l.chill) ? l.chill : null,
      heat: isFiniteNumber(l.heat) ? l.heat : null,
      sunrise: (typeof l.sunrise === 'string' && l.sunrise.trim()) ? l.sunrise : null,
      sunset: (typeof l.sunset === 'string' && l.sunset.trim()) ? l.sunset : null
    };
    const out = window.fbLogSample?.(key, payload);
    if(out && typeof out.catch === 'function') out.catch(()=>{});
  }catch(e){}
    }
// ---- /FIREBASE LOG ----

  // keep globals in sync if this is the active context
  if(key === currentStationKey){
    stationSeries = series;
    stationLastKey = sampleKey;
    if(updateUI !== false) updateStationReadouts();
  }
}

function onNewStationSample(sampleKey, tsText, val, label, totals, latest) {
  storeSampleForKey(currentStationKey, sampleKey, tsText, val, label, totals, true, latest);
  // Keep scenario mini-panels in sync with the latest PRIMARY sample
  try{ refreshScenarioPanels(); }catch(_){}
}

function updateStationReadouts(){
  const latest = stationSeries.length ? stationSeries[stationSeries.length-1] : null;

  // dp = last dp if available
  const dp = latest?.dp;
  setTxt('stationDP', (dp!=null && isFiniteNumber(dp)) ? dp.toFixed(1) : 'â€”');

  // R60: sum dp over last 60 minutes if dp exists
  if(stationSeries.length && stationSeries.some(s=>s.dp!=null)){
    const now = stationSeries[stationSeries.length-1].dateMs;
    const cutoff = now - 60*60*1000;
    const sum = stationSeries.filter(s=>s.dateMs>=cutoff && s.dp!=null).reduce((a,b)=>a+b.dp,0);
    setTxt('stationR60', isFiniteNumber(sum) ? sum.toFixed(1) : 'â€”');
  } else {
    setTxt('stationR60', 'â€”');
  }
  renderStationSeriesList();
  try{ refreshScenarioPanels(); }catch(_){ }
}

function renderStationSeriesList(){
  // Backward-compatible name: renders the "Monitoring" history table
  try{
    if(typeof __seriesBuildRowsFromBuffer === 'function'){
      const rows = __seriesBuildRowsFromBuffer();
      if(typeof renderSeriesHead === 'function') renderSeriesHead();
      if(typeof renderSeriesRows === 'function') renderSeriesRows(rows);
      if(typeof __seriesSetStatus === 'function'){
        __seriesSetStatus(`Monitoring: ${rows.length} Î´ÎµÎ¯Î³Î¼Î±Ï„Î±`, false);
      }
      return;
    }
  }catch(e){
    console.warn('renderStationSeriesList error', e);
  }
}


/* ===================== STATION BUTTONS UI ===================== */
function updateStationButtons(){
  const autoBtn = document.getElementById('btnAutoStation');
  const liveBtn = document.getElementById('btnLiveStation');

  if(autoBtn){
    // Auto stays blue; Live is independent
    autoBtn.classList.add('btn-auto-default');
    autoBtn.classList.remove('btn-auto-live');
  }
  if(liveBtn){
    liveBtn.classList.toggle('btn-live-on', stationLiveOn);
    liveBtn.classList.toggle('btn-live-off', !stationLiveOn);
    liveBtn.textContent = stationLiveOn ? 'Live ON' : 'Live OFF';
  }

  updateLocalScenarioBtn();
}


/* ===================== MONITOR: SUB TOGGLE (arrow before station name) ===================== */
function toggleMonitorContent(){
  const wrap = document.getElementById('monitorBodyContent');
  const btn  = document.getElementById('btnToggleMonitorContent');
  if(!wrap || !btn) return;
  const isCollapsed = wrap.classList.toggle('collapsed');
  btn.textContent = isCollapsed ? 'â–¶' : 'â–¼';
  btn.title = isCollapsed ? 'Î†Î½Î¿Î¹Î³Î¼Î± Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï…' : 'ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï…';
}

function initMonitorContentToggle(){
  const wrap = document.getElementById('monitorBodyContent');
  const btn  = document.getElementById('btnToggleMonitorContent');
  if(!wrap || !btn) return;
  const isCollapsed = wrap.classList.contains('collapsed');
  btn.textContent = isCollapsed ? 'â–¶' : 'â–¼';
  btn.title = isCollapsed ? 'Î†Î½Î¿Î¹Î³Î¼Î± Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï…' : 'ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ Ï€ÎµÏÎ¹ÎµÏ‡Î¿Î¼Î­Î½Î¿Ï…';
}

function flashTempGreen(btnOrId, ms=3000){
  const btn = (typeof btnOrId === 'string') ? document.getElementById(btnOrId) : btnOrId;
  if(!btn) return;
  btn.classList.add('temp-green');
  setTimeout(()=> btn.classList.remove('temp-green'), ms);
}

function applyAutoI(){
  // Use latest station rain rate if exists
  const latest = stationSeries.length ? stationSeries[stationSeries.length-1] : null;
  if(latest && latest.val!=null){
    setVal('rainI', latest.val.toFixed(1));
    setStationMsg("Load: i ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ Î±Ï€ÏŒ ÏƒÏ„Î±Î¸Î¼ÏŒ.");
    flashTempGreen('btnAutoStation', 3000);
    runMasterCalculation();
  } else if(lastStationPayload){
    const rr = extractRainRate(lastStationPayload);
    if(rr!=null){
      setVal('rainI', rr.toFixed(1));
      setStationMsg("Load: i ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ Î±Ï€ÏŒ payload.");
      flashTempGreen('btnAutoStation', 3000);
      runMasterCalculation();
    } else {
      setStationMsg("Load: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¹Î¼Î® Î²ÏÎ¿Ï‡Î®Ï‚.");
    }
  } else {
    setStationMsg("Load: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï„Î¹Î¼Î® Î²ÏÎ¿Ï‡Î®Ï‚.");
  }
}

function toggleLive(){
  stationLiveOn = !stationLiveOn;
  updateStationButtons();

  const doFetch = ()=> {
    // prefer API fetch if ACTIVE primary OR watchlist monitoring
    const url = getPrimaryStationUrl();
    if(url || watchlist.size) fetchStationData();
    else fetchLiveMeteo();
  };

  if(stationLiveOn){
    setStationMsg("Live: ON (Î±Î½Î¬ 90s)");
    // Î¬Î¼ÎµÏƒÎ· Ï€ÏÏÏ„Î· Î»Î®ÏˆÎ· Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î± Ï‡Ï‰ÏÎ¯Ï‚ Î½Î± Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÎ¹Ï‚ 90s
    doFetch();
    if(stationLiveTimer) clearInterval(stationLiveTimer);
    stationLiveTimer = setInterval(doFetch, 90000);
  } else {
    setStationMsg("Live: OFF");
    if(stationLiveTimer) clearInterval(stationLiveTimer);
    stationLiveTimer = null;
  }
}

function clearStationSeries(){
  const ok = __confirmClear("ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î§ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬Ï‚ Î£Ï„Î±Î¸Î¼Î¿Ï (UI)", [
    "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„ÎµÎ¯ Î· Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬ (buffer) Î³Î¹Î± Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± ÏƒÏ„Î±Î¸Î¼ÏŒ.",
    "â€¢ Î˜Î± Î¼Î·Î´ÎµÎ½Î¹ÏƒÏ„Î¿ÏÎ½ Î¿Î¹ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯ Î”P (storm) ÎºÎ±Î¹ R60 ÏƒÏ„Î·Î½ Î¿Î¸ÏŒÎ½Î·."
  ]);
  if(!ok) return;

  stationSeries = [];
  stationLastKey = null;

  // update store for current station context
  stationSeriesByKey[currentStationKey] = stationSeries;
  stationLastKeyByKey[currentStationKey] = stationLastKey;

  setTxt('stationDP','â€”');
  setTxt('stationR60','â€”');
  setStationMsg("Series ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ.");

  // Î¿Ï€Ï„Î¹ÎºÎ® ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·: Ï€ÏÎ¬ÏƒÎ¹Î½Î¿ Î³Î¹Î± 3s ÎºÎ±Î¹ Î¼ÎµÏ„Î¬ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®
  flashTempGreen('btnClearStation', 3000);
}



/* ===================== AI ANALYSIS (copy + open AI tab) ===================== */
const AI_TARGETS = {
  chatgpt: { name: "ChatGPT", url: "https://chatgpt.com/" },
  gemini:  { name: "Gemini",  url: "https://gemini.google.com/" }
};
let AI_TARGET = "chatgpt";

function initAIAnalysisUI(){
  // Restore last choice
  try{
    const saved = localStorage.getItem("NIREAS_AI_TARGET");
    if(saved && AI_TARGETS[saved]) AI_TARGET = saved;
  }catch(_){}
  // Sync dropdown (or pills in older builds)
  const wrap = document.getElementById("aiTargetGroup");
  const sel = document.getElementById("aiProviderSelect");
  if(sel){
    try{ sel.value = AI_TARGET; }catch(_){}
    sel.classList.remove("ai-chatgpt","ai-gemini");
    sel.classList.add(AI_TARGET === "gemini" ? "ai-gemini" : "ai-chatgpt");
    const t = getAITargetInfo();
    sel.title = `AI: ${t.name} (Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹)`;
  }else if(wrap){
    // Backward compatibility if someone still has pills
    wrap.querySelectorAll(".ai-pill").forEach(btn=>{
      btn.classList.toggle("active", btn.dataset.ai === AI_TARGET);
    });
  }
  // Update AI analysis button tooltip (target shown via dropdown)
  const btn = document.getElementById("btnAIAnalysis");
  if(btn){
    const t = getAITargetInfo();
    btn.title = `Î£Ï…Î»Î»Î¿Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ & Î±Î½Î¬Î»Ï…ÏƒÎ· Î¼Îµ AI (Shift+Click = EXTRA FULL) | Target: ${t.name}`;
  }
}

function setAITarget(key){
  if(!AI_TARGETS[key]) return;
  AI_TARGET = key;
  try{ localStorage.setItem("NIREAS_AI_TARGET", key); }catch(_){}
  initAIAnalysisUI();
}

function getAITargetInfo(){
  return AI_TARGETS[AI_TARGET] || AI_TARGETS.chatgpt;
}

function __aiGetTxt(id){
  const el = document.getElementById(id);
  return (el && (el.innerText!=null)) ? el.innerText.trim() : 'â€”';
}
function __aiGetVal(id){
  const el = document.getElementById(id);
  if(!el) return '';
  const tag = (el.tagName||'').toLowerCase();
  if(tag === 'select'){
    const opt = el.options && el.selectedIndex>=0 ? el.options[el.selectedIndex] : null;
    return (opt && opt.text!=null) ? String(opt.text).trim() : (el.value ?? '');
  }
  const type = (el.type||'').toLowerCase();
  if(type === 'checkbox' || type === 'radio') return el.checked ? 'checked' : 'not-checked';
  return (el.value ?? '');
}
function __aiSafeSlice(s, limit){
  const t = String(s ?? '');
  if(t.length <= limit) return t;
  return t.slice(0, limit) + `\nâ€¦ [TRUNCATED ${t.length-limit} chars]`;
}
function __aiNormalizeText(s){
  return String(s ?? '').replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();
}

function __aiCopySync(text){
  // Works in many contexts, keeps user-gesture so popups are allowed.
  try{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly","");
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return !!ok;
  }catch(_){
    return false;
  }
}

function __aiCopyAsync(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
  }
  return Promise.resolve(false);
}

function __aiShowCopyFallback(text, targetName, targetUrl){
  // Minimal in-page modal for manual copy if Clipboard API fails (e.g. file:// restrictions)
  const prev = document.getElementById('aiCopyOverlay');
  if(prev) prev.remove();

  const overlay = document.createElement('div');
  overlay.id = 'aiCopyOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px;';
  overlay.innerHTML = `
    <div style="background:#fff;border-radius:12px;max-width:980px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.35);overflow:hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#2c3e50;color:#fff;font-weight:900">
        <div>AI analysis â€“ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® prompt</div>
        <button id="aiCopyClose" style="border:none;background:rgba(255,255,255,.18);color:#fff;border-radius:8px;width:34px;height:28px;cursor:pointer;font-weight:900">âœ•</button>
      </div>
      <div style="padding:10px 12px">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-size:12px;color:#4b4b4b">
            Î Î±Ï„Î®ÏƒÏ„Îµ <b>Ctrl+C</b> (Î® âŒ˜C) Î³Î¹Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î®. ÎœÎµÏ„Î¬ Î±Î½Î¿Î¯Î¾Ï„Îµ <b>${targetName}</b> ÎºÎ±Î¹ ÎºÎ¬Î½Ï„Îµ Paste.
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="aiOpenTarget" class="mini-btn btn-on" style="height:28px;line-height:1" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î¿ tab">${targetName}</button>
            <button id="aiSelectAll" class="mini-btn btn-gray" style="height:28px;line-height:1" title="Î•Ï€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½">Select</button>
          </div>
        </div>
        <textarea id="aiCopyText" style="width:100%;height:360px;border:1px solid #d6dde4;border-radius:10px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre;resize:vertical;"></textarea>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  const ta = overlay.querySelector('#aiCopyText');
  ta.value = text;
  ta.focus();
  ta.select();
  overlay.querySelector('#aiCopyClose').onclick = ()=> overlay.remove();
  overlay.onclick = (e)=>{ if(e.target === overlay) overlay.remove(); };
  overlay.querySelector('#aiSelectAll').onclick = ()=>{ ta.focus(); ta.select(); };
  overlay.querySelector('#aiOpenTarget').onclick = ()=>{ window.open(targetUrl, "_blank"); };
}

function __aiShowOpenFallback(targetName, targetUrl){
  // Popup blocked after copy: offer a clear clickable open
  const prev = document.getElementById('aiOpenOverlay');
  if(prev) prev.remove();

  const overlay = document.createElement('div');
  overlay.id = 'aiOpenOverlay';
  overlay.style.cssText = 'position:fixed;left:12px;bottom:12px;z-index:99999;background:#fff;border:1px solid #dfe7ee;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);padding:10px 12px;max-width:420px;';
  overlay.innerHTML = `
    <div style="font-weight:900;margin-bottom:6px">Popup blocker</div>
    <div style="font-size:12px;color:#4b4b4b;margin-bottom:8px">Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ Ï„Î¿ prompt, Î±Î»Î»Î¬ Î´ÎµÎ½ Î¬Î½Î¿Î¹Î¾Îµ Î½Î­Î¿ tab. Î Î¬Ï„Î·ÏƒÎµ ÎµÎ´Ï:</div>
    <button class="mini-btn btn-on" id="aiOpenNow" style="height:28px;line-height:1">${targetName}</button>
    <button class="mini-btn btn-gray" id="aiOpenClose" style="height:28px;line-height:1;margin-left:6px">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
  `;
  document.body.appendChild(overlay);
  overlay.querySelector('#aiOpenNow').onclick = ()=> window.open(targetUrl, "_blank");
  overlay.querySelector('#aiOpenClose').onclick = ()=> overlay.remove();
}

function __aiToast(msg){
  try{
    const id = 'aiToast';
    let el = document.getElementById(id);
    if(!el){
      el = document.createElement('div');
      el.id = id;
      el.style.cssText = 'position:fixed;left:12px;top:12px;z-index:99999;background:rgba(0,0,0,.78);color:#fff;padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900;max-width:520px;box-shadow:0 10px 30px rgba(0,0,0,.25);';
      document.body.appendChild(el);
    }
    el.textContent = msg;
    el.style.display = 'block';
    if(el._t) clearTimeout(el._t);
    el._t = setTimeout(()=>{ el.style.display = 'none'; }, 5200);
  }catch(_){}
}


function runAIAnalysis(ev){
  // Shift+Click => EXTRA FULL (more raw page text). Default already includes the full structured data.
  const extraFull = !!(ev && ev.shiftKey);
  const now = new Date();
  const target = getAITargetInfo();

  const scenarioSel = document.getElementById('modelScenario');
  const scenarioValue = scenarioSel ? scenarioSel.value : '';
  const scenarioLabel = scenarioSel ? (scenarioValue ? (scenarioSel.options[scenarioSel.selectedIndex]?.text || scenarioValue) : 'â€”') : (scenarioValue || 'â€”');

  // Station flags (try globals, fallback to button text)
  const liveOn = (typeof stationLiveOn !== 'undefined') ? !!stationLiveOn : /ON/i.test(document.getElementById('btnLiveStation')?.innerText || '');
  const localOn = (typeof LOCAL_SCENARIO_ON !== 'undefined') ? !!LOCAL_SCENARIO_ON : (document.getElementById('localScenarioToggle')?.checked || false);

  // Layer flags (if exist)
  let meteoLayer = 'â€”';
  try{
    meteoLayer = `ÎšÏÏÎ¹Î¿Ï‚:${METEO_PRIMARY_VISIBLE ? 'ON' : 'OFF'} | Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·:${METEO_WATCH_VISIBLE ? 'ON' : 'OFF'}`;
  }catch(_){ }
  // Visible GeoJSON layers (if exist)
  let visibleLayers = [];
  try{
    if(typeof VISIBLE !== 'undefined' && VISIBLE && typeof VISIBLE[Symbol.iterator] === 'function'){
      visibleLayers = Array.from(VISIBLE);
    }
  }catch(_){}

  // Derived results (hydrology box)
  const calc = {
    slope_S: __aiGetTxt('res-slope'),
    tc_kirpich_min: __aiGetTxt('res-tc'),
    qpeak_m3s: __aiGetTxt('res-qsel'),
    qcap_network_m3s: __aiGetTxt('res-drains'),
    qcap_stream_m3s: __aiGetTxt('res-stream'),
    adequacy_check: __aiGetTxt('res-adequacy')
  };

  // Table preview (first rows)
  let tablePreview = '';
  try{
    const rows = Array.from(document.querySelectorAll('#tableBody tr')).slice(0, 24);
    if(rows.length){
      tablePreview = rows.map(tr => Array.from(tr.children).map(td => td.innerText.trim()).join(' | ')).join('\n');
    }
  }catch(_){}

  // Optional extra station list / watchlist
  const multiList = document.getElementById('stationMultiList');
  let multiText = '';
  if(multiList && multiList.innerText && multiList.innerText.trim()){
    multiText = __aiNormalizeText(multiList.innerText);
  }
  const watchlistEl = document.getElementById('watchlist');
  let watchlistText = '';
  if(watchlistEl && watchlistEl.innerText && watchlistEl.innerText.trim()){
    watchlistText = __aiNormalizeText(watchlistEl.innerText);
  }

  // Station series (last 12)
  const seriesText = __aiNormalizeText(__aiGetTxt('seriesTable'));

  // DB history (loaded from Firestore, if available)
  let dbHistText = '';
  try{
    const rows = (window.__dbLastSamples || []).slice(0, 120);
    if(rows.length){
      dbHistText = rows.map(r => {
        const ts = r.tsText || (typeof r.tsMs==='number' ? new Date(r.tsMs).toLocaleString() : (r.id||''));
        const rain = (typeof r.rainRate==='number') ? r.rainRate.toFixed(1) : 'â€”';
        const dp = (typeof r.dp==='number') ? r.dp.toFixed(1) : 'â€”';
        const total = (typeof r.total==='number') ? r.total.toFixed(1) : 'â€”';
        const temp = (typeof r.temp==='number') ? r.temp.toFixed(1) : 'â€”';
        const hum = (typeof r.hum==='number') ? String(Math.round(r.hum)) : 'â€”';
        return `${ts} | rain=${rain} | dp=${dp} | total=${total} | T=${temp} | RH=${hum}`;
      }).join('\n');
    }
  }catch(_){ dbHistText = ''; }


  // Collect form values (id-based, compact)
  const formLines = [];
  document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
    const id = el.id;
    if(!id) return;
    const tag = el.tagName.toLowerCase();
    const type = (el.type||'').toLowerCase();
    if(tag === 'input' && (type === 'button' || type === 'submit' || type === 'reset')) return;

    let v = '';
    if(type === 'checkbox' || type === 'radio') v = el.checked ? 'checked' : 'not-checked';
    else if(tag === 'select'){
      const opt = el.options && el.selectedIndex>=0 ? el.options[el.selectedIndex] : null;
      v = (opt && opt.text!=null) ? String(opt.text).trim() : (el.value ?? '');
    }else{
      v = (el.value ?? '');
    }
    if(v === '' || v == null) return;
    formLines.push(`${id}: ${String(v).trim()}`);
  });

  // Build compact, structured context (best results, less noise)
  const context = {
    url: location.href,
    title: document.title,
    captured_at_local: now.toLocaleString(),
    captured_at_iso: now.toISOString(),
    ai_target: target.name,
    mode: extraFull ? 'EXTRA_FULL' : 'FULL',
    active: {
      basin: __aiGetTxt('selectedBasinName'),
      scenario: scenarioLabel,
      live: liveOn ? 'ON' : 'OFF',
      local_scenario: localOn ? 'ON' : 'OFF',
      meteo_selected_markers_layer: meteoLayer,
      visible_geojson_layers: visibleLayers
    },
    station: {
      name: __aiGetTxt('stationName'),
      timestamp: __aiGetTxt('stationTimestampInline'),
      lat: __aiGetTxt('stationLat'),
      lon: __aiGetTxt('stationLon'),
      elev_m: __aiGetTxt('stationElev'),
      latest_chips: __aiGetTxt('stationLatestChips'),
      rain_rate: __aiGetTxt('stationRainRate'),
      dp_mm: __aiGetTxt('stationDP'),
      r60_mm: __aiGetTxt('stationR60')
    },
    inputs: {
      i_mm_h: __aiGetVal('rainI'),
      D_min: __aiGetVal('rainD'),
      A_m2: __aiGetVal('area'),
      L_m: __aiGetVal('length'),
      H_m: __aiGetVal('height'),
      C: __aiGetVal('coef')
    },
    calculations: calc
  };

  // Page text snapshot (bounded). EXTRA_FULL adds more.
  const rawText = __aiNormalizeText(document.body.innerText || '');
  const pageText = __aiSafeSlice(rawText, extraFull ? 120000 : 55000);

  const contextJson = __aiSafeSlice(JSON.stringify(context, null, 2), 20000);

  const payloadText =
`URL: ${context.url}
TITLE: ${context.title}
CAPTURED_AT: ${context.captured_at_local}

=== CONTEXT (JSON) ===
${contextJson}

=== ACTIVE / SELECTED ===
Meteo Selected Markers Layer: ${context.active.meteo_selected_markers_layer}
Scenario: ${context.active.scenario}
Live: ${context.active.live}
Local Scenario: ${context.active.local_scenario}
Basin: ${context.active.basin}
Visible GeoJSON Layers: ${context.active.visible_geojson_layers && context.active.visible_geojson_layers.length ? context.active.visible_geojson_layers.join(', ') : 'â€”'}

=== STATION (PRIMARY) ===
Name: ${context.station.name}
Timestamp: ${context.station.timestamp}
LAT: ${context.station.lat}   LON: ${context.station.lon}   ELEV: ${context.station.elev_m}
Latest: ${context.station.latest_chips}
Rain Rate: ${context.station.rain_rate}
Î”P: ${context.station.dp_mm}
R60: ${context.station.r60_mm}

=== STATION SERIES (${getSeriesLimit()} latest, UI buffer) ===
${seriesText}

${dbHistText ? `=== DB HISTORY (loaded) ===
${dbHistText}

` : ''}${multiText ? `=== STATIONS (EXTRA LIST) ===
${multiText}

` : ''}${watchlistText ? `=== WATCHLIST (chips) ===
${watchlistText}

` : ''}=== KEY INPUTS ===
i (mm/h): ${context.inputs.i_mm_h}
D (min): ${context.inputs.D_min}
A (mÂ²): ${context.inputs.A_m2}
L (m): ${context.inputs.L_m}
H (m): ${context.inputs.H_m}
C: ${context.inputs.C}

=== CALC RESULTS (current) ===
S: ${calc.slope_S}
Tc: ${calc.tc_kirpich_min}
Qpeak: ${calc.qpeak_m3s}
Qcap Î”Î¹ÎºÏ„ÏÎ¿Ï…: ${calc.qcap_network_m3s}
Qcap Î¡Î­Î¼Î±Ï„Î¿Ï‚: ${calc.qcap_stream_m3s}
ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚: ${calc.adequacy_check}

${tablePreview ? `=== TABLE PREVIEW (top rows) ===\n(i | D | P | Qpeak | V | Risk | Network | Stream)\n${tablePreview}\n\n` : ''}=== FORM VALUES (ID: value) ===
${formLines.slice(0, 220).join('\n')}${formLines.length>220 ? `\nâ€¦ [TRUNCATED ${formLines.length-220} lines]` : ''}

=== PAGE TEXT SNAPSHOT (${context.mode}) ===
${pageText}
`;

  const prompt =
`Î”ÏÎ¬ÏƒÎµ Ï‰Ï‚ Î¼ÎµÏ„ÎµÏ‰ÏÎ¿Î»ÏŒÎ³Î¿Ï‚/Î±Î½Î±Î»Ï…Ï„Î®Ï‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÎ¿Ï ÎºÎ¹Î½Î´ÏÎ½Î¿Ï…. Î‘Î½Î¬Î»Ï…ÏƒÎµ Î‘Î ÎŸÎšÎ›Î•Î™Î£Î¤Î™ÎšÎ‘ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ½ Î±Ï€ÏŒ Ï„Î¿ ÏƒÏÏƒÏ„Î·Î¼Î± NIREAS ÎºÎ±Î¹ Î´ÏÏƒÎµ Î¼Î¿Ï…:

1) Î£ÏÎ½Ï„Î¿Î¼Î· Ï€ÏÏŒÎ³Î½Ï‰ÏƒÎ· ÎºÎ±Î¹ÏÎ¿Ï (ÎµÏ€ÏŒÎ¼ÎµÎ½ÎµÏ‚ 6/24/48 ÏÏÎµÏ‚) Î³Î¹Î± Î§Î±Î»Î¬Î½Î´ÏÎ¹,
2) Î•ÎºÏ„Î¯Î¼Î·ÏƒÎ· ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Î²ÏÎ¿Ï‡Î®/ÎºÎ±Ï„Î±Î¹Î³Î¯Î´ÎµÏ‚/Ï€Î»Î·Î¼Î¼ÏÏÎ±/Ï€Î±Î³ÎµÏ„ÏŒÏ‚/Ï‡Î¹ÏŒÎ½Î¹ â€“ Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿) Î¼Îµ 3 ÏƒÎµÎ½Î¬ÏÎ¹Î±: Î§Î‘ÎœÎ—Î›ÎŸ â€“ ÎœÎ•Î¤Î¡Î™ÎŸ â€“ Î¥Î¨Î—Î›ÎŸ,
3) 3 Î¬Î¼ÎµÏƒÎµÏ‚ ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÎ­Ï‚ ÏƒÏ…ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î¿Î½ Î”Î®Î¼Î¿.

ÎšÎ±Î½ÏŒÎ½ÎµÏ‚:
- Î‘Î½ ÎºÎ¬Ï„Î¹ Î»ÎµÎ¯Ï€ÎµÎ¹/ÎµÎ¯Î½Î±Î¹ Î¬Î³Î½Ï‰ÏƒÏ„Î¿, Î³ÏÎ¬ÏˆÎµ Â«â€”Â» ÎºÎ±Î¹ ÎœÎ—Î Ï„Î¿ ÎµÎ¹ÎºÎ¬ÏƒÎµÎ¹Ï‚.
- ÎÎ± ÎµÎ¯ÏƒÎ±Î¹ ÏƒÏÎ½Ï„Î¿Î¼Î¿Ï‚, Î¼Îµ bullets, ÎºÎ±Î¹ Î½Î± Ï€Î±Ï„Î¬Ï‚ ÏƒÏ„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± (timestamps/Ï„Î¹Î¼Î­Ï‚) Ï€Î¿Ï… ÏƒÎ¿Ï… Î´Î¯Î½Î¿Î½Ï„Î±Î¹.

` + payloadText;

  const n = prompt.length;
  const modeTxt = extraFull ? "EXTRA_FULL" : "FULL";

  // 1) Copy FIRST (sync if possible)
  const copiedSync = __aiCopySync(prompt);
  if(copiedSync){
    const win = window.open(target.url, "_blank");
    if(!win) __aiShowOpenFallback(target.name, target.url);
    __aiToast(`âœ… Prompt Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ (${n.toLocaleString()} chars) [${modeTxt}] â†’ Î†Î½Î¿Î¹Î³Î¼Î±: ${target.name}. ÎšÎ¬Î½Îµ Paste.`);
    return;
  }

  // 2) Async clipboard fallback
  __aiCopyAsync(prompt).then(ok=>{
    if(ok){
      const win = window.open(target.url, "_blank");
      if(!win) __aiShowOpenFallback(target.name, target.url);
      __aiToast(`âœ… Prompt Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ (${n.toLocaleString()} chars) [${modeTxt}] â†’ Î†Î½Î¿Î¹Î³Î¼Î±: ${target.name}. ÎšÎ¬Î½Îµ Paste.`);
    }else{
      __aiShowCopyFallback(prompt, target.name, target.url);
      __aiToast(`âš ï¸ Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î±Ï€Î­Ï„Ï…Ï‡Îµ. Î†Î½Î¿Î¹Î¾Îµ Ï„Î¿ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ¿ ÎºÎ±Î¹ ÎºÎ¬Î½Îµ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î®. Target: ${target.name} [${modeTxt}]`);
    }
  });
}
/* ===================== /AI ANALYSIS ===================== */


/* ===================== DB READER (Firestore) ===================== */
window.__dbLastSamples = window.__dbLastSamples || [];

function __dbSetStatus(msg, isErr){
  const el = document.getElementById('dbStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isErr ? '#b00020' : '#6b7a86';
}

function __setLoadBtnState(btnOrId, state){
  const btn = (typeof btnOrId === 'string') ? document.getElementById(btnOrId) : btnOrId;
  if(!btn) return;
  btn.classList.remove('btn-gray','btn-on','btn-warn');
  if(state === 'ok') btn.classList.add('btn-on');
  else if(state === 'warn') btn.classList.add('btn-warn');
  else btn.classList.add('btn-gray'); // idle
}

function __setFilterBtnStyle(btnOrId, enabled){
  const btn = (typeof btnOrId === 'string') ? document.getElementById(btnOrId) : btnOrId;
  if(!btn) return;
  btn.textContent = enabled ? 'Î¦Î¯Î»Ï„ÏÎ¿: ON' : 'Î¦Î¯Î»Ï„ÏÎ¿: OFF';
  btn.classList.remove('btn-gray','btn-on','btn-live-off');
  btn.classList.add(enabled ? 'btn-on' : 'btn-live-off');
}

function __dbFmt(x, digits=1){
  if(x==null || x==='' || Number.isNaN(Number(x))) return 'â€”';
  const n = Number(x);
  return Number.isFinite(n) ? n.toFixed(digits) : String(x);
}

function __dbSafeText(x){
  const s = (x==null) ? '' : String(x);
  return s.replace(/\s+/g,' ').trim();
}

function __dbGetViewMode(){
  if(!window.__dbViewMode){
    window.__dbViewMode = localStorage.getItem('nireas_db_view') || 'basic';
  }
  return window.__dbViewMode;
}

function __dbSetViewMode(mode){
  window.__dbViewMode = (mode === 'full') ? 'full' : 'basic';
  localStorage.setItem('nireas_db_view', window.__dbViewMode);

  const btn = document.getElementById('btnDbView');
  if(btn){
    btn.textContent = (window.__dbViewMode === 'full') ? 'Î ÏÎ¿Î²Î¿Î»Î®: FULL' : 'Î ÏÎ¿Î²Î¿Î»Î®: BASIC';
  }
  const btn2 = document.getElementById('btnSeriesView');
  if(btn2){
    btn2.textContent = (window.__dbViewMode === 'full') ? 'Î ÏÎ¿Î²Î¿Î»Î®: FULL' : 'Î ÏÎ¿Î²Î¿Î»Î®: BASIC';
  }

  renderDbHead();
  renderDbRows(window.__dbLastSamples || []);

  // also refresh Monitoring table (same column mode)
  if(typeof renderSeriesHead === 'function') renderSeriesHead();
  if(typeof renderSeriesRows === 'function') renderSeriesRows(window.__seriesLastSamples || []);
}

function __dbResolveMeta(r){
  // Best-effort station meta resolution:
  // 1) fields stored in sample (stationName/url/lat/lon/elev)
  // 2) derive from stationKey (url:..., open-meteo)
  // 3) fallback to in-page STATIONS_META by URL
  const sk = (r && r.stationKey != null) ? String(r.stationKey) : '';
  let url = (r && r.stationUrl) ? String(r.stationUrl) : '';
  if(!url && sk){
    if(sk.startsWith('url:')) url = sk.slice(4);
    else if(sk === 'open-meteo') url = (typeof OPEN_METEO_TOKEN !== 'undefined') ? OPEN_METEO_TOKEN : sk;
    else url = sk;
  }

  let meta = null;
  try{
    if(url && typeof getStationMeta === 'function') meta = getStationMeta(url);
  }catch(_){}

  const name = __dbSafeText(r.stationName || r.label || meta?.name || (sk === 'open-meteo' ? 'Openâ€‘Meteo' : sk) || 'â€”');
  const lat  = (typeof r.lat  === 'number') ? r.lat  : (typeof meta?.lat  === 'number' ? meta.lat  : null);
  const lon  = (typeof r.lon  === 'number') ? r.lon  : (typeof meta?.lon  === 'number' ? meta.lon  : null);
  const elev = (typeof r.elev === 'number') ? r.elev : (typeof meta?.elev === 'number' ? meta.elev : null);

  return { name, url, lat, lon, elev, stationKey: sk };
}

function __dbOpenUrl(url){
  const u = __dbSafeText(url);
  if(!u) return;
  window.open(u, "_blank");
}

function __dbFocusMap(lat, lon, label){
  if(!(typeof lat === 'number') || !(typeof lon === 'number')) return;

  // Ensure map is visible
  try{
    if(typeof openMapModal === 'function') openMapModal();
  }catch(_){}

  // Pan/zoom and drop a temporary marker
  setTimeout(()=>{
    try{
      if(!window.map || !window.L) return;
      window.map.setView([lat, lon], 15, { animate:true });
      try{
        if(window.__dbFocusMarker){
          window.map.removeLayer(window.__dbFocusMarker);
          window.__dbFocusMarker = null;
        }
      }catch(_){}
      try{
        window.__dbFocusMarker = window.L.marker([lat, lon]).addTo(window.map);
        const title = __dbSafeText(label);
        if(title) window.__dbFocusMarker.bindPopup(`<b>${title}</b><br>${lat.toFixed(4)}, ${lon.toFixed(4)}`).openPopup();
      }catch(_){}
    }catch(_){}
  }, 120);
}

function __dbGetFilteredRows(){
  const rows = window.__dbLastSamples || [];
  const cols = __dbCols();
  const filters = window.__dbFilters || {};
  const enabled = (window.__dbFiltersEnabled !== false);

  if(!enabled) return rows;

  // quick check: any filter set?
  const hasAny = Object.values(filters).some(v => __dbSafeText(v));
  if(!hasAny) return rows;

  const norm = (s)=> String(s||'').toLowerCase();

  const parseNumericExpr = (expr)=>{
    const e = __dbSafeText(expr);
    if(!e) return null;
    let m = e.match(/^(-?\d+(?:\.\d+)?)\s*(?:\-|\.\.)\s*(-?\d+(?:\.\d+)?)$/);
    if(m) return {type:'range', a:Number(m[1]), b:Number(m[2])};
    m = e.match(/^(>=|<=|>|<|=)\s*(-?\d+(?:\.\d+)?)$/);
    if(m) return {type:'cmp', op:m[1], n:Number(m[2])};
    const n = Number(e);
    if(Number.isFinite(n)) return {type:'eq', n};
    return {type:'text', s:norm(e)};
  };

  const matchNumeric = (val, exprObj)=>{
    const n = Number(val);
    if(!Number.isFinite(n)) return false;
    if(!exprObj) return true;
    if(exprObj.type === 'range'){
      const lo = Math.min(exprObj.a, exprObj.b);
      const hi = Math.max(exprObj.a, exprObj.b);
      return n >= lo && n <= hi;
    }
    if(exprObj.type === 'cmp'){
      const t = exprObj.n;
      if(!Number.isFinite(t)) return false;
      if(exprObj.op === '>=') return n >= t;
      if(exprObj.op === '<=') return n <= t;
      if(exprObj.op === '>')  return n > t;
      if(exprObj.op === '<')  return n < t;
      if(exprObj.op === '=')  return n === t;
    }
    if(exprObj.type === 'eq') return n === exprObj.n;
    if(exprObj.type === 'text') return norm(n).includes(exprObj.s);
    return true;
  };

  // Pre-parse numeric expressions once
  const parsed = {};
  cols.forEach(c=>{
    const fv = __dbSafeText(filters[c.k]);
    if(!fv) return;
    if(c.filterType === 'num') parsed[c.k] = parseNumericExpr(fv);
  });

  return rows.filter(r=>{
    for(const c of cols){
      const fv = __dbSafeText(filters[c.k]);
      if(!fv) continue;
      if(c.noFilter) continue;

      if(c.filterType === 'station'){
        const meta = __dbResolveMeta(r);
        if(meta.name !== fv) return false;
        continue;
      }

      if(c.filterType === 'num'){
        const raw = (typeof c.getRaw === 'function') ? c.getRaw(r) : r[c.k];
        if(!matchNumeric(raw, parsed[c.k])) return false;
        continue;
      }

      // text
      const txt = (typeof c.getFilterText === 'function')
        ? c.getFilterText(r)
        : ((typeof c.getText === 'function') ? c.getText(r) : '');
      if(!norm(txt).includes(norm(fv))) return false;
    }
    return true;
  });
}

function __dbCols(){
  const mode = __dbGetViewMode();

  const tsGetter = (r)=> __dbSafeText(r.tsText || (r.tsMs ? new Date(r.tsMs).toLocaleString('el-GR') : r.id));
  const stationGetter = (r)=> __dbResolveMeta(r).name;

  const colsBase = [
    {k:'ts', label:'Timestamp', left:true, filterType:'text', getText:tsGetter, getFilterText:tsGetter},
    {k:'station', label:'Station', left:true, filterType:'station', getText:stationGetter, getFilterText:stationGetter},
    {
      k:'link', label:'', cls:'db-col-icon', noFilter:true,
      render:(r)=>{
        const meta = __dbResolveMeta(r);
        const btn = document.createElement('button');
        btn.className = 'db-icon-btn';
        btn.title = 'Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï';
        btn.textContent = 'ğŸ”—';
        btn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); __dbOpenUrl(meta.url); };
        return btn;
      }
    },
    {
      k:'map', label:'', cls:'db-col-icon', noFilter:true,
      render:(r)=>{
        const meta = __dbResolveMeta(r);
        const btn = document.createElement('button');
        btn.className = 'db-icon-btn';
        btn.title = 'Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·';
        btn.textContent = 'ğŸ“';
        btn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); __dbFocusMap(meta.lat, meta.lon, meta.name); };
        return btn;
      }
    },
    {k:'elev', label:'Elev', filterType:'num', getRaw:(r)=> (__dbResolveMeta(r).elev), getText:(r)=> {
      const e = __dbResolveMeta(r).elev;
      return (typeof e === 'number' && Number.isFinite(e)) ? String(Math.round(e)) : 'â€”';
    }}
  ];

  const metricsBasic = [
    {k:'temp',     label:'Temp',     filterType:'num', getRaw:(r)=>r.temp,     getText:(r)=> (typeof r.temp === 'number') ? __dbFmt(r.temp,1) : 'â€”'},
    {k:'hum',      label:'Hum',      filterType:'num', getRaw:(r)=>r.hum,      getText:(r)=> (typeof r.hum === 'number') ? __dbFmt(r.hum,0) : 'â€”'},
    {k:'dewPoint', label:'Dew',      filterType:'num', getRaw:(r)=>r.dewPoint, getText:(r)=> (typeof r.dewPoint === 'number') ? __dbFmt(r.dewPoint,1) : 'â€”'},
    {k:'wind',     label:'Wind', left:true, cls:'col-wind', filterType:'text', getText:(r)=> __dbSafeText(r.wind || 'â€”')},
    {k:'baro',     label:'Baro',     filterType:'num', getRaw:(r)=>r.baro,     getText:(r)=> (typeof r.baro === 'number') ? __dbFmt(r.baro,1) : 'â€”'},
    {k:'today',    label:"Today's",  filterType:'num', getRaw:(r)=>r.today,    getText:(r)=> (typeof r.today === 'number') ? __dbFmt(r.today,1) : 'â€”'},
    {k:'rainRate', label:'RainRate', filterType:'num', getRaw:(r)=>r.rainRate, getText:(r)=> (typeof r.rainRate === 'number') ? __dbFmt(r.rainRate,1) : 'â€”'},
    {k:'storm',    label:'Storm',    filterType:'num', getRaw:(r)=>r.storm,    getText:(r)=> (typeof r.storm === 'number') ? __dbFmt(r.storm,1) : 'â€”'},
    {k:'month',    label:'Month',    filterType:'num', getRaw:(r)=>r.month,    getText:(r)=> (typeof r.month === 'number') ? __dbFmt(r.month,1) : 'â€”'},
    {k:'year',     label:'Year',     filterType:'num', getRaw:(r)=>r.year,     getText:(r)=> (typeof r.year === 'number') ? __dbFmt(r.year,1) : 'â€”'},
    {k:'chill',    label:'Chill',    filterType:'num', getRaw:(r)=>r.chill,    getText:(r)=> (typeof r.chill === 'number') ? __dbFmt(r.chill,1) : 'â€”'},
    {k:'heat',     label:'Heat',     filterType:'num', getRaw:(r)=>r.heat,     getText:(r)=> (typeof r.heat === 'number') ? __dbFmt(r.heat,1) : 'â€”'},
    {k:'dp',       label:'Î”P',       filterType:'num', getRaw:(r)=>r.dp,       getText:(r)=> (typeof r.dp === 'number') ? __dbFmt(r.dp,1) : 'â€”'},
    {k:'total',    label:'Total',    filterType:'num', getRaw:(r)=>r.total,    getText:(r)=> (typeof r.total === 'number') ? __dbFmt(r.total,1) : 'â€”'}
  ];

  const metricsFullExtra = [
    {k:'sunrise', label:'Sunrise', filterType:'text', getText:(r)=> __dbSafeText(r.sunrise || 'â€”')},
    {k:'sunset',  label:'Sunset',  filterType:'text', getText:(r)=> __dbSafeText(r.sunset  || 'â€”')}
  ];

  const cols = colsBase.concat(metricsBasic);
  if(mode === 'full') cols.push(...metricsFullExtra);
  return cols;
}

// Monitoring (Primary History) uses same column set as DB, but WITHOUT link/map icon columns
function __seriesCols(){
  return __dbCols().filter(c => c && c.k !== 'link' && c.k !== 'map');
}

function renderDbHead(){
  const hr = document.getElementById('dbHeadRow');
  const fr = document.getElementById('dbFilterRow');
  if(!hr) return;

  const cols = __dbCols();
  hr.innerHTML = '';
  if(fr) fr.innerHTML = '';

  // Header row
  cols.forEach((c, idx)=>{
    const th = document.createElement('th');
    if(idx === 0 || c.left) th.style.textAlign = 'left';
    if(c.cls) th.className = c.cls;
    th.textContent = c.label || '';
    hr.appendChild(th);
  });

  // Filter row
  if(fr){
    const enabled = (window.__dbFiltersEnabled !== false);
    fr.style.display = enabled ? '' : 'none';

    cols.forEach((c, idx)=>{
      const th = document.createElement('th');
      if(idx === 0 || c.left) th.style.textAlign = 'left';
      if(c.cls) th.className = c.cls;
      if(!enabled || c.noFilter){
        th.innerHTML = '';
      }else if(c.filterType === 'station'){
        const sel = document.createElement('select');
        sel.innerHTML = '<option value="">(ÏŒÎ»Î±)</option>';
        // populate from current data
        const uniq = new Set((window.__dbLastSamples||[]).map(r=>__dbResolveMeta(r).name).filter(Boolean));
        Array.from(uniq).sort((a,b)=>a.localeCompare(b,'el')).forEach(n=>{
          const o = document.createElement('option');
          o.value = n; o.textContent = n;
          sel.appendChild(o);
        });
        sel.value = __dbSafeText((window.__dbFilters||{})[c.k]);
        sel.onchange = ()=>{
          window.__dbFilters = window.__dbFilters || {};
          window.__dbFilters[c.k] = sel.value;
          renderDbRows(window.__dbLastSamples || []);
        };
        th.appendChild(sel);
      }else{
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.placeholder = (c.filterType === 'num') ? 'Ï€.Ï‡. >10 Î® 10-20' : 'filterâ€¦';
        inp.value = __dbSafeText((window.__dbFilters||{})[c.k]);
        inp.oninput = ()=>{
          window.__dbFilters = window.__dbFilters || {};
          window.__dbFilters[c.k] = inp.value;
          renderDbRows(window.__dbLastSamples || []);
        };
        th.appendChild(inp);
      }
      fr.appendChild(th);
    });
  }
}

function renderDbRows(rows){
  const tb = document.getElementById('dbRows');
  if(!tb) return;

  const cols = __dbCols();
  const colspan = cols.length;

  const filtered = __dbGetFilteredRows();

  if(!filtered || !filtered.length){
    tb.innerHTML = `<tr><td colspan="${colspan}" style="color:#6b7a86;font-style:italic">â€”</td></tr>`;
    return;
  }

  tb.innerHTML = '';
  for(const r of filtered){
    const tr = document.createElement('tr');

    cols.forEach((c, idx)=>{
      const td = document.createElement('td');
      if(idx === 0 || c.left) td.style.textAlign = 'left';
      if(c.cls) td.className = c.cls;

      if(typeof c.render === 'function'){
        const node = c.render(r);
        if(node) td.appendChild(node);
        else td.textContent = 'â€”';
      }else{
        td.textContent = (typeof c.getText === 'function') ? c.getText(r) : 'â€”';
      }
      tr.appendChild(td);
    });

    tb.appendChild(tr);
  }
}

/* ===================== PRIMARY HISTORY TABLE (Monitoring) ===================== */
function __seriesSetStatus(msg, isErr){
  const el = document.getElementById('seriesStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.color = isErr ? '#b00020' : '#6b7a86';
}

function __setLoadBtnState(btnOrId, state){
  const btn = (typeof btnOrId === 'string') ? document.getElementById(btnOrId) : btnOrId;
  if(!btn) return;
  btn.classList.remove('btn-gray','btn-on','btn-warn');
  if(state === 'ok') btn.classList.add('btn-on');
  else if(state === 'warn') btn.classList.add('btn-warn');
  else btn.classList.add('btn-gray'); // idle
}

function __setFilterBtnStyle(btnOrId, enabled){
  const btn = (typeof btnOrId === 'string') ? document.getElementById(btnOrId) : btnOrId;
  if(!btn) return;
  btn.textContent = enabled ? 'Î¦Î¯Î»Ï„ÏÎ¿: ON' : 'Î¦Î¯Î»Ï„ÏÎ¿: OFF';
  btn.classList.remove('btn-gray','btn-on','btn-live-off');
  btn.classList.add(enabled ? 'btn-on' : 'btn-live-off');
}

function __seriesBuildRowsFromBuffer(){
  const key = (typeof currentStationKey !== 'undefined' && currentStationKey) ? currentStationKey : 'open-meteo';
  const series = (typeof stationSeriesByKey !== 'undefined' && stationSeriesByKey[key]) ? stationSeriesByKey[key] : (window.stationSeries || []);
  const out = (series || []).map(s=>{
    const tsMs = (typeof s.tsMs === 'number') ? s.tsMs : ((typeof s.dateMs === 'number') ? s.dateMs : null);
    return {
      id: s.key,
      sampleKey: s.key,

      tsMs,
      tsText: s.tsText || (tsMs ? new Date(tsMs).toLocaleString('el-GR') : null),

      stationKey: key,
      stationName: s.stationName || s.label || null,

      rainRate: (typeof s.rainRate === 'number') ? s.rainRate : ((typeof s.val === 'number') ? s.val : null),
      dp: (typeof s.dp === 'number') ? s.dp : null,
      total: (typeof s.total === 'number') ? s.total : null,
      totalSrc: s.totalSrc || null,

      temp: (typeof s.temp === 'number') ? s.temp : null,
      hum: (typeof s.hum === 'number') ? s.hum : null,
      dewPoint: (typeof s.dewPoint === 'number') ? s.dewPoint : null,
      wind: (typeof s.wind === 'string' && s.wind.trim()) ? s.wind : null,
      baro: (typeof s.baro === 'number') ? s.baro : null,

      today: (typeof s.today === 'number') ? s.today : null,
      storm: (typeof s.storm === 'number') ? s.storm : null,
      month: (typeof s.month === 'number') ? s.month : null,
      year:  (typeof s.year  === 'number') ? s.year  : null,

      chill: (typeof s.chill === 'number') ? s.chill : null,
      heat:  (typeof s.heat  === 'number') ? s.heat  : null,
      sunrise: (typeof s.sunrise === 'string' && s.sunrise.trim()) ? s.sunrise : null,
      sunset:  (typeof s.sunset  === 'string' && s.sunset.trim())  ? s.sunset  : null
    };
  });

  out.sort((a,b)=> (b.tsMs||0) - (a.tsMs||0));
  window.__seriesLastSamples = out;
  return out;
}

function __seriesGetFilteredRows(){
  const rows = window.__seriesLastSamples || [];
  const cols = __seriesCols();
  const filters = window.__seriesFilters || {};
  const enabled = (window.__seriesFiltersEnabled !== false);

  if(!enabled) return rows;

  // quick check: any filter set?
  const hasAny = Object.values(filters).some(v => __dbSafeText(v));
  if(!hasAny) return rows;

  const norm = (s)=> String(s||'').toLowerCase();

  const parseNumericExpr = (expr)=>{
    const e = __dbSafeText(expr);
    if(!e) return null;
    const s = e.replace(/\s+/g,'').replace(',', '.');
    // ranges: a-b
    let m = s.match(/^(-?\d+(?:\.\d+)?)-(-?\d+(?:\.\d+)?)$/);
    if(m) return {type:'range', a:parseFloat(m[1]), b:parseFloat(m[2])};
    // >=, <=, >, <, =
    m = s.match(/^(>=|<=|>|<|=)(-?\d+(?:\.\d+)?)$/);
    if(m) return {type:'cmp', op:m[1], x:parseFloat(m[2])};
    // plain number: treat as >=
    m = s.match(/^(-?\d+(?:\.\d+)?)$/);
    if(m) return {type:'cmp', op:'>=', x:parseFloat(m[1])};
    return {type:'text', raw: e};
  };

  const matchNumeric = (val, parsedExpr, rawText)=>{
    if(val==null || val==='' || Number.isNaN(val)) return false;
    const v = Number(val);
    if(!parsedExpr) return false;
    if(parsedExpr.type === 'range'){
      const lo = Math.min(parsedExpr.a, parsedExpr.b);
      const hi = Math.max(parsedExpr.a, parsedExpr.b);
      return v >= lo && v <= hi;
    }
    if(parsedExpr.type === 'cmp'){
      const x = parsedExpr.x;
      switch(parsedExpr.op){
        case '>':  return v > x;
        case '>=': return v >= x;
        case '<':  return v < x;
        case '<=': return v <= x;
        case '=':  return v === x;
      }
    }
    // fallback to substring match
    return norm(String(v)).includes(norm(rawText));
  };

  // Pre-parse numeric expressions once
  const parsed = {};
  cols.forEach(c=>{
    const fv = __dbSafeText(filters[c.k]);
    if(!fv) return;
    if(c.filterType === 'num') parsed[c.k] = parseNumericExpr(fv);
  });

  return rows.filter(r=>{
    for(const c of cols){
      const fv = __dbSafeText(filters[c.k]);
      if(!fv) continue;

      if(c.filterType === 'station'){
        const name = __dbResolveMeta(r).name;
        if(norm(name) !== norm(fv)) return false;
        continue;
      }

      if(c.filterType === 'num'){
        const expr = parsed[c.k];
        const val = (c.k === 'tsMs') ? r.tsMs : r[c.k];
        if(!matchNumeric(val, expr, fv)) return false;
        continue;
      }

      // text filter
      const txt = (typeof c.getFilterText === 'function') ? c.getFilterText(r)
                : (typeof c.getText === 'function') ? c.getText(r)
                : __dbSafeText(r[c.k]);
      if(!norm(txt).includes(norm(fv))) return false;
    }
    return true;
  });
}

function renderSeriesHead(){
  const hr = document.getElementById('seriesHeadRow');
  const fr = document.getElementById('seriesFilterRow');
  if(!hr) return;

  const cols = __seriesCols();
  hr.innerHTML = '';
  if(fr) fr.innerHTML = '';

  // Header row
  cols.forEach((c, idx)=>{
    const th = document.createElement('th');
    if(idx === 0 || c.left) th.style.textAlign = 'left';
    if(c.cls) th.className = c.cls;
    th.textContent = c.label || '';
    hr.appendChild(th);
  });

  // Filter row (Excel-like)
  if(fr){
    const enabled = (window.__seriesFiltersEnabled !== false);
    fr.style.display = enabled ? '' : 'none';

    cols.forEach((c, idx)=>{
      const th = document.createElement('th');
      if(idx === 0 || c.left) th.style.textAlign = 'left';
      if(c.cls) th.className = c.cls;

      if(!enabled || c.noFilter){
        th.innerHTML = '';
      }else if(c.filterType === 'station'){
        const sel = document.createElement('select');
        sel.innerHTML = '<option value="">(ÏŒÎ»Î±)</option>';
        const uniq = new Set((window.__seriesLastSamples||[]).map(r=>__dbResolveMeta(r).name).filter(Boolean));
        Array.from(uniq).sort((a,b)=>a.localeCompare(b,'el-GR')).forEach(n=>{
          const o = document.createElement('option');
          o.value = n; o.textContent = n;
          sel.appendChild(o);
        });
        sel.value = __dbSafeText((window.__seriesFilters||{})[c.k]);
        sel.onchange = ()=>{
          window.__seriesFilters = window.__seriesFilters || {};
          window.__seriesFilters[c.k] = sel.value;
          renderSeriesRows(window.__seriesLastSamples || []);
        };
        th.appendChild(sel);
      }else{
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.placeholder = (c.filterType === 'num') ? 'Ï€.Ï‡. >10 Î® 10-20' : 'filterâ€¦';
        inp.value = __dbSafeText((window.__seriesFilters||{})[c.k]);
        inp.oninput = ()=>{
          window.__seriesFilters = window.__seriesFilters || {};
          window.__seriesFilters[c.k] = inp.value;
          renderSeriesRows(window.__seriesLastSamples || []);
        };
        th.appendChild(inp);
      }

      fr.appendChild(th);
    });
  }
}

function renderSeriesRows(rows){
  const tb = document.getElementById('seriesRows');
  if(!tb) return;

  const cols = __seriesCols();
  const colspan = cols.length;

  const filtered = __seriesGetFilteredRows();

  if(!filtered || !filtered.length){
    tb.innerHTML = `<tr><td colspan="${colspan}" style="color:#6b7a86;font-style:italic">â€”</td></tr>`;
    return;
  }

  tb.innerHTML = '';
  for(const r of filtered){
    const tr = document.createElement('tr');
    cols.forEach((c, idx)=>{
      const td = document.createElement('td');
      if(idx === 0 || c.left) td.style.textAlign = 'left';
      if(c.cls) td.className = c.cls;
      if(typeof c.render === 'function'){
        const node = c.render(r);
        if(node) td.appendChild(node);
        else td.textContent = 'â€”';
      }else{
        td.textContent = (typeof c.getText === 'function') ? c.getText(r) : 'â€”';
      }
      tr.appendChild(td);
    });
    tb.appendChild(tr);
  }
}

function __seriesMergeIncoming(incoming){
  const key = (typeof currentStationKey !== 'undefined' && currentStationKey) ? currentStationKey : 'open-meteo';
  const series = (stationSeriesByKey[key] || []);
  const existing = new Set(series.map(s=>s.key));
  let added = 0;

  (incoming||[]).forEach(s=>{
    if(!s || !s.key) return;
    if(existing.has(s.key)) return;
    existing.add(s.key);
    series.push(s);
    added++;
  });

  series.sort((a,b)=> (a.dateMs||0) - (b.dateMs||0));
  const __lim = getSeriesLimit();
  if(series.length > __lim){
    series.splice(0, series.length - __lim);
  }

  stationSeriesByKey[key] = series;
  stationLastKeyByKey[key] = series.length ? series[series.length-1].key : null;

  // update current pointers (if we are on the same context)
  stationSeries = series;
  stationLastKey = stationLastKeyByKey[key];

  return added;
}

async function loadSeriesHistoryFromDb(){
  __setLoadBtnState('btnSeriesLoad','idle');
  if(typeof window.fbFetchRecentSamples !== 'function'){
    __seriesSetStatus('Monitoring DB: Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î¿ (Firebase ÏŒÏ‡Î¹ Î­Ï„Î¿Î¹Î¼Î¿)', true);
    __setLoadBtnState('btnSeriesLoad','warn');
    return;
  }

  const key = (typeof currentStationKey !== 'undefined' && currentStationKey) ? currentStationKey : 'open-meteo';
  __seriesSetStatus('Monitoring: DB Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦', false);

  try{
    const docs = await window.fbFetchRecentSamples(key, getSeriesLimit());
    const ordered = (docs||[]).slice().sort((a,b)=> (a.tsMs||0) - (b.tsMs||0));

    const incoming = ordered.map(r => ({
      key: r.sampleKey || r.id || ('t_' + (r.tsMs||Date.now())),
      tsText: r.tsText || (r.tsMs ? new Date(r.tsMs).toLocaleString('el-GR') : (r.id||'')),
      tsMs: (typeof r.tsMs === 'number') ? r.tsMs : Date.now(),

      val: (typeof r.rainRate === 'number') ? r.rainRate : null,
      rainRate: (typeof r.rainRate === 'number') ? r.rainRate : null,

      label: (r.stationName || r.label || null),
      stationName: (r.stationName || r.label || null),

      total: (typeof r.total === 'number') ? r.total : null,
      totalSrc: r.totalSrc || null,
      dp: (typeof r.dp === 'number') ? r.dp : null,
      dateMs: (typeof r.tsMs === 'number') ? r.tsMs : Date.now(),

      temp: (typeof r.temp === 'number') ? r.temp : null,
      hum: (typeof r.hum === 'number') ? r.hum : null,
      dewPoint: (typeof r.dewPoint === 'number') ? r.dewPoint : ((typeof r.dew === 'number') ? r.dew : null),
      wind: (typeof r.wind === 'string' && r.wind.trim()) ? r.wind : null,
      baro: (typeof r.baro === 'number') ? r.baro : null,

      today: (typeof r.today === 'number') ? r.today : null,
      storm: (typeof r.storm === 'number') ? r.storm : null,
      month: (typeof r.month === 'number') ? r.month : null,
      year:  (typeof r.year  === 'number') ? r.year  : null,

      chill: (typeof r.chill === 'number') ? r.chill : null,
      heat:  (typeof r.heat  === 'number') ? r.heat  : null,
      sunrise: (typeof r.sunrise === 'string' && r.sunrise.trim()) ? r.sunrise : null,
      sunset:  (typeof r.sunset  === 'string' && r.sunset.trim())  ? r.sunset  : null
    }));

    const added = __seriesMergeIncoming(incoming);
    updateStationReadouts();

    __setLoadBtnState('btnSeriesLoad', (docs && docs.length) ? 'ok' : 'warn');
    __seriesSetStatus(`Monitoring: DB OK â€¢ +${added}`, false);
  }catch(e){
    __setLoadBtnState('btnSeriesLoad','warn');
    __seriesSetStatus('Monitoring DB: ERROR â€¢ ' + (e && e.message ? e.message : String(e)), true);
  }
}

function exportSeriesCsv(){
  const all = window.__seriesLastSamples || [];
  if(!all.length){
    __seriesSetStatus('CSV: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (monitoring)', true);
    return;
  }

  const rows = __seriesGetFilteredRows();

  const cols = [
    'tsMs','tsText','stationKey','stationName','stationUrl','lat','lon','elev',
    'rainRate','dp','total','totalSrc',
    'temp','hum','dewPoint','wind','baro',
    'today','storm','month','year','chill','heat','sunrise','sunset',
    'sampleKey','id'
  ];

  const escapeCsv = (v)=>{
    if(v==null) return '';
    const s = String(v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };

  const lines = [];
  lines.push(cols.join(','));

  rows
    .slice()
    .sort((a,b)=> (a.tsMs||0) - (b.tsMs||0))
    .forEach(r=>{
      const meta = __dbResolveMeta(r);
      const out = {
        ...r,
        stationName: meta.name,
        stationUrl: meta.url,
        lat: meta.lat,
        lon: meta.lon,
        elev: meta.elev
      };
      lines.push(cols.map(c=>escapeCsv(out[c])).join(','));
    });

  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nireas_monitoring_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 1500);

  __seriesSetStatus(`CSV: OK (${rows.length} rows)`, false);
}

function clearSeriesFiltersUI(){
  // Clear filters AND clear the visible table data (for space + clean slate)
  window.__seriesFilters = {};

  // Clear visible inputs/selects
  const fr = document.getElementById('seriesFilterRow');
  if(fr){
    fr.querySelectorAll('input').forEach(i=>{ i.value = ''; });
    fr.querySelectorAll('select').forEach(s=>{ s.value = ''; });
  }

  // Clear in-memory series for the current primary station context
  try{
    if(typeof currentStationKey !== 'undefined'){
      if(typeof stationSeriesByKey !== 'undefined'){
        stationSeriesByKey[currentStationKey] = [];
      }
      if(typeof stationLastKeyByKey !== 'undefined'){
        stationLastKeyByKey[currentStationKey] = null;
      }
      if(typeof stationSeries !== 'undefined'){
        stationSeries = [];
      }
      if(typeof stationLastKey !== 'undefined'){
        stationLastKey = null;
      }
    }
  }catch(_){}

  // Clear any cached last samples used by the renderer
  window.__seriesLastSamples = [];

  // Reset Load button visual state
  if(typeof __setLoadBtnState === 'function') __setLoadBtnState('btnSeriesLoad', 'idle');

  // Re-render as empty
  renderSeriesHead();
  renderSeriesRows([]);

  __seriesSetStatus('Monitoring: cleared', false);
}

function clearDbFiltersUI(){
  // Clear filters AND clear the visible table data
  window.__dbFilters = {};

  const fr = document.getElementById('dbFilterRow');
  if(fr){
    fr.querySelectorAll('input').forEach(i=>{ i.value = ''; });
    fr.querySelectorAll('select').forEach(s=>{ s.value = ''; });
  }

  // Clear cached DB rows currently shown
  window.__dbLastSamples = [];

  // Reset Load button visual state
  if(typeof __setLoadBtnState === 'function') __setLoadBtnState('btnDbLoad', 'idle');

  renderDbHead();
  renderDbRows([]);

  __dbSetStatus('DB: cleared', false);
}

function initSeriesReaderUI(){
  const saved = localStorage.getItem('nireas_series_filters');
  if(saved === 'off') window.__seriesFiltersEnabled = false;
  if(saved === 'on')  window.__seriesFiltersEnabled = true;

  const btnLoad = document.getElementById('btnSeriesLoad');
  const btnCsv  = document.getElementById('btnSeriesExport');
  const btnView = document.getElementById('btnSeriesView');
  const btnFilt = document.getElementById('btnSeriesFilters');
  const btnClr  = document.getElementById('btnSeriesClearFilters');

  if(btnClr){ btnClr.onclick = (e)=>{ e.preventDefault(); confirmAndClearSeriesFiltersUI(); }; }
  const inpLim  = document.getElementById('seriesLimit');

  if(btnLoad && !btnLoad.dataset.bound){
    btnLoad.dataset.bound = '1';
    btnLoad.addEventListener('click', (e)=>{ e.preventDefault(); loadSeriesHistoryFromDb(); });
  }
  if(btnCsv && !btnCsv.dataset.bound){
    btnCsv.dataset.bound = '1';
    btnCsv.addEventListener('click', (e)=>{ e.preventDefault(); exportSeriesCsv(); });
  }
  if(btnView){
    btnView.textContent = (__dbGetViewMode() === 'full') ? 'Î ÏÎ¿Î²Î¿Î»Î®: FULL' : 'Î ÏÎ¿Î²Î¿Î»Î®: BASIC';
    if(!btnView.dataset.bound){
      btnView.dataset.bound = '1';
      btnView.addEventListener('click', (e)=>{
        e.preventDefault();
        const next = (__dbGetViewMode() === 'full') ? 'basic' : 'full';
        __dbSetViewMode(next); // shared view mode across DB + Monitoring
      });
    }
  }
  if(btnFilt){
    __setFilterBtnStyle(btnFilt, (window.__seriesFiltersEnabled !== false));
    if(!btnFilt.dataset.bound){
      btnFilt.dataset.bound = '1';
      btnFilt.addEventListener('click', (e)=>{
        e.preventDefault();
        window.__seriesFiltersEnabled = !(window.__seriesFiltersEnabled !== false);
        localStorage.setItem('nireas_series_filters', (window.__seriesFiltersEnabled !== false) ? 'on' : 'off');
        __setFilterBtnStyle(btnFilt, (window.__seriesFiltersEnabled !== false));
        renderSeriesHead();
        renderSeriesRows(window.__seriesLastSamples || []);
      });
    }
  }
  // Clear handled via btnClr.onclick (single handler)

  // initial render
  try{
    __seriesBuildRowsFromBuffer();
    renderSeriesHead();
    renderSeriesRows(window.__seriesLastSamples || []);
    __seriesSetStatus(`Monitoring: ${(window.__seriesLastSamples||[]).length} Î´ÎµÎ¯Î³Î¼Î±Ï„Î±`, false);
  }catch(_e){}

  if(inpLim && !inpLim.dataset.bound){
    inpLim.dataset.bound = '1';
    const onLimChange = ()=>{
      const lim = getSeriesLimit();
      inpLim.value = lim;
      trimAllStationSeriesToLimit();
      renderStationSeriesList();
      __seriesSetStatus(`Monitoring: ÏŒÏÎ¹Î¿ = ${lim}`, false);
    };
    inpLim.addEventListener('change', (e)=>{ e.preventDefault(); onLimChange(); });
    inpLim.addEventListener('input',  (e)=>{ onLimChange(); });
  }

}

async function loadDbHistory(){
  __setLoadBtnState('btnDbLoad','idle');
  const name = document.getElementById('stationName')?.innerText?.trim() || '';
  const limEl = document.getElementById('dbLimit');
  const lim = Math.max(1, Math.min(500, Number(limEl?.value || 50)));

  __dbSetStatus('DB: Ï†ÏŒÏÏ„Ï‰ÏƒÎ·â€¦', false);

  try{
    let rows = [];
    if(window.fbFetchRecentSamplesAll){
      rows = await window.fbFetchRecentSamplesAll(lim);
      const sumEl = document.getElementById('dbSeriesSummaryName');
      if(sumEl) sumEl.textContent = 'â€¢ ALL STATIONS';
    }else if(window.fbFetchRecentSamples){
      const key = (typeof currentStationKey !== 'undefined' && currentStationKey) ? currentStationKey : 'open-meteo';
      rows = await window.fbFetchRecentSamples(key, lim);
      const sname = name ? `(${name})` : '';
      const sumEl = document.getElementById('dbSeriesSummaryName');
      if(sumEl) sumEl.textContent = sname;
    }else{
      __dbSetStatus('DB: Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î­Ï„Î¿Î¹Î¼Î¿ (Firestore reader missing)', true);
      __setLoadBtnState('btnDbLoad','warn');
      renderDbRows([]);
      return;
    }

    window.__dbLastSamples = rows || [];
    // ensure newest first (table feels like monitoring)
    window.__dbLastSamples.sort((a,b)=> (b.tsMs||0) - (a.tsMs||0));

    // reset station dropdown options by re-rendering head
    renderDbHead();
    renderDbRows(window.__dbLastSamples);

    __setLoadBtnState('btnDbLoad', (window.__dbLastSamples && window.__dbLastSamples.length) ? 'ok' : 'warn');
    __dbSetStatus(`DB: OK â€¢ ${window.__dbLastSamples.length} ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚`, false);
  }catch(e){
    __setLoadBtnState('btnDbLoad','warn');
    const msg = (e && e.message) ? e.message : String(e);
    if(/permission|denied/i.test(msg)){
      __dbSetStatus('DB: permission-denied â€¢ Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Firestore rules Î³Î¹Î± READ', true);
    }else{
      __dbSetStatus('DB: ERROR â€¢ ' + msg, true);
    }
    window.__dbLastSamples = [];
    renderDbHead();
    renderDbRows([]);
  }
}

function importDbToHistory(){
  const rows = window.__dbLastSamples || [];
  if(!rows.length){
    __dbSetStatus('DB: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (Load DB Ï€ÏÏÏ„Î±)', true);
    return;
  }

  const key = (typeof currentStationKey !== 'undefined' && currentStationKey) ? currentStationKey : 'open-meteo';
  const stationRows = rows.filter(r => String(r.stationKey||'') === String(key));

  if(!stationRows.length){
    __dbSetStatus('DB â†’ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ: Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î³Î¹Î± Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± ÏƒÏ„Î±Î¸Î¼ÏŒ', true);
    return;
  }

  const ordered = stationRows.slice().sort((a,b)=> (a.tsMs||0) - (b.tsMs||0));
  const incoming = ordered.map(r => ({
    key: r.sampleKey || r.id || ('t_' + (r.tsMs||Date.now())),
    tsText: r.tsText || (r.tsMs ? new Date(r.tsMs).toLocaleString('el-GR') : (r.id||'')),
    tsMs: (typeof r.tsMs === 'number') ? r.tsMs : Date.now(),

    val: (typeof r.rainRate === 'number') ? r.rainRate : null,
    rainRate: (typeof r.rainRate === 'number') ? r.rainRate : null,

    label: (r.stationName || r.label || null),
    stationName: (r.stationName || r.label || null),

    total: (typeof r.total === 'number') ? r.total : null,
    totalSrc: r.totalSrc || null,
    dp: (typeof r.dp === 'number') ? r.dp : null,

    // extra metrics
    temp: (typeof r.temp === 'number') ? r.temp : null,
    hum: (typeof r.hum === 'number') ? r.hum : null,
    dewPoint: (typeof r.dewPoint === 'number') ? r.dewPoint : ((typeof r.dew === 'number') ? r.dew : null),
    wind: (typeof r.wind === 'string' && r.wind.trim()) ? r.wind : null,
    baro: (typeof r.baro === 'number') ? r.baro : null,

    today: (typeof r.today === 'number') ? r.today : null,
    storm: (typeof r.storm === 'number') ? r.storm : null,
    month: (typeof r.month === 'number') ? r.month : null,
    year:  (typeof r.year  === 'number') ? r.year  : null,

    chill: (typeof r.chill === 'number') ? r.chill : null,
    heat:  (typeof r.heat  === 'number') ? r.heat  : null,
    sunrise: (typeof r.sunrise === 'string' && r.sunrise.trim()) ? r.sunrise : null,
    sunset:  (typeof r.sunset  === 'string' && r.sunset.trim())  ? r.sunset  : null,

    dateMs: (typeof r.tsMs === 'number') ? r.tsMs : Date.now()
  }));

  try{
    const existing = (typeof stationSeriesByKey !== 'undefined' && stationSeriesByKey[key]) ? stationSeriesByKey[key] : [];
    const keySet = new Set(existing.map(s=>s.key));

    for(const it of incoming){
      if(!it || !it.key) continue;
      if(keySet.has(it.key)) continue;
      existing.push(it);
      keySet.add(it.key);
    }
    existing.sort((a,b)=> (a.dateMs||0) - (b.dateMs||0));
    const __lim2 = getSeriesLimit();
    if(existing.length > __lim2){
      existing.splice(0, existing.length - __lim2);
    }

    if(typeof stationSeriesByKey !== 'undefined'){
      stationSeriesByKey[key] = existing;
    }
    if(typeof stationLastKeyByKey !== 'undefined'){
      stationLastKeyByKey[key] = existing.length ? existing[existing.length-1].key : null;
    }
    if(typeof currentStationKey !== 'undefined' && key === currentStationKey){
      stationSeries = existing;
      stationLastKey = existing.length ? existing[existing.length-1].key : null;
      updateStationReadouts();
    }
    if(typeof renderStationSeries === 'function') renderStationSeries();
    __dbSetStatus(`DB â†’ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ: OK â€¢ +${incoming.length} (merge)`, false);
  }catch(e){
    __dbSetStatus('Import ERROR â€¢ ' + ((e&&e.message)?e.message:String(e)), true);
  }
}

function exportDbCsv(){
  const all = window.__dbLastSamples || [];
  if(!all.length){
    __dbSetStatus('CSV: Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± (Load DB Ï€ÏÏÏ„Î±)', true);
    return;
  }

  // Export filtered view (like Excel)
  const rows = __dbGetFilteredRows();

  const cols = [
    'tsMs','tsText','stationKey','stationName','stationUrl','lat','lon','elev',
    'rainRate','dp','total','totalSrc',
    'temp','hum','dewPoint','wind','baro',
    'today','storm','month','year','chill','heat','sunrise','sunset',
    'sampleKey','id'
  ];

  const escapeCsv = (v)=>{
    if(v==null) return '';
    const s = String(v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };

  const lines = [];
  lines.push(cols.join(','));

  rows
    .slice()
    .sort((a,b)=> (a.tsMs||0) - (b.tsMs||0))
    .forEach(r=>{
      const meta = __dbResolveMeta(r);
      const out = {
        ...r,
        stationName: meta.name,
        stationUrl: meta.url,
        lat: meta.lat,
        lon: meta.lon,
        elev: meta.elev
      };
      lines.push(cols.map(c=>escapeCsv(out[c])).join(','));
    });

  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `nireas_db_ALL_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 1500);

  __dbSetStatus(`CSV: OK (${rows.length} rows)`, false);
}

function initDbReaderUI(){
  // Persist filter toggle
  const saved = localStorage.getItem('nireas_db_filters');
  if(saved === 'off') window.__dbFiltersEnabled = false;
  if(saved === 'on')  window.__dbFiltersEnabled = true;

  const btnLoad = document.getElementById('btnDbLoad');
  const btnImp  = document.getElementById('btnDbImport');
  const btnCsv  = document.getElementById('btnDbExport');
  const btnView = document.getElementById('btnDbView');
  const btnFilt = document.getElementById('btnDbFilters');
  const btnClr  = document.getElementById('btnDbClearFilters');

  if(btnClr){ btnClr.onclick = (e)=>{ e.preventDefault(); confirmAndClearDbFiltersUI(); }; }

  if(btnView){ btnView.textContent = (__dbGetViewMode() === 'full') ? 'Î ÏÎ¿Î²Î¿Î»Î®: FULL' : 'Î ÏÎ¿Î²Î¿Î»Î®: BASIC'; }

  if(btnLoad && !btnLoad.dataset.bound){
    btnLoad.dataset.bound = '1';
    btnLoad.addEventListener('click', (e)=>{ e.preventDefault(); loadDbHistory(); });
  }
  if(btnImp && !btnImp.dataset.bound){
    btnImp.dataset.bound = '1';
    btnImp.addEventListener('click', (e)=>{ e.preventDefault(); importDbToHistory(); });
  }
  if(btnCsv && !btnCsv.dataset.bound){
    btnCsv.dataset.bound = '1';
    btnCsv.addEventListener('click', (e)=>{ e.preventDefault(); exportDbCsv(); });
  }
  if(btnView && !btnView.dataset.bound){
    btnView.dataset.bound = '1';
    btnView.addEventListener('click', (e)=>{
      e.preventDefault();
      const next = (__dbGetViewMode() === 'full') ? 'basic' : 'full';
      __dbSetViewMode(next);
    });
  }

  if(btnFilt){
    __setFilterBtnStyle(btnFilt, (window.__dbFiltersEnabled !== false));
    if(!btnFilt.dataset.bound){
      btnFilt.dataset.bound = '1';
      btnFilt.addEventListener('click', (e)=>{
        e.preventDefault();
        window.__dbFiltersEnabled = !(window.__dbFiltersEnabled !== false);
        localStorage.setItem('nireas_db_filters', (window.__dbFiltersEnabled !== false) ? 'on' : 'off');
        __setFilterBtnStyle(btnFilt, (window.__dbFiltersEnabled !== false));
        renderDbHead();
        renderDbRows(window.__dbLastSamples || []);
      });
    }
  }

  // Clear handled via btnClr.onclick (single handler)

  // init view mode button + initial render
  __dbSetViewMode(__dbGetViewMode());
  __dbSetStatus('DB: â€”', false);
}
/* ===================== /DB READER ===================== */





/* ===================== CALCULATIONS (ver14-style) ===================== */
function calculateTc(L, H){
  return (!L || !H) ? 10 : 0.0195 * Math.pow(L, 0.77) * Math.pow((H/L), -0.385);
}

function runMasterCalculation(){
  const area   = getVal('area');
  const length = getVal('length');
  const height = getVal('height');
  const coef   = getVal('coef');

  const rainI  = getVal('rainI');
  const rainD  = getVal('rainD');

  const drains   = getVal('drains');
  const drainCap = getVal('drainCap');

  const strWidth = getVal('strWidth');
  const strZ     = getVal('strZ');
  const strDepth = getVal('strDepth');
  const strDrop  = getVal('strDrop');
  const strLen   = getVal('strLen');
  const strType  = getVal('strType');
  const strYEl   = document.getElementById('strY');

  if(!(area>0)){
    // still draw empty
    setTxt('res-slope','â€”');
    setTxt('res-tc','â€”');
    setTxt('res-qsel','â€”');
    setTxt('res-drains','â€”');
    setTxt('res-stream','â€”');
    setTxt('res-adequacy','â€”');
    document.getElementById('tableBody').innerHTML='';
    drawChannel(0);
    drawBasinPlan();
    return;
  }

  const A_km2 = area / 1e6;
  const S = (length>0 && height>0) ? (height/length) : 0.01;

  const Tc = calculateTc(length, height);
  const Dused = (rainD > 0) ? rainD : Math.max(5.0, Tc);

  const Qsel = 0.278 * coef * rainI * A_km2;

  const CapNet = drains * drainCap;

  // Stream slope
  const sLen = (strLen>0) ? strLen : (length>0 ? length : 0);
  const sDrop = (strDrop>0) ? strDrop : (height>0 ? height : 0);
  const sSlope = (sLen>0) ? (sDrop/sLen) : 0;

  // Manning trapezoid capacity + normal depth by bisection
  let CapStr = 0;
  let yCalc = 0;

  const calcQ = (d) => {
    if(!(strWidth>0) || !(sSlope>0) || !(strType>0) || d<=0) return 0;
    const A = (strWidth + strZ*d) * d;
    const P = strWidth + 2*d*Math.sqrt(1 + Math.pow(strZ,2));
    return (1/strType) * Math.pow(A, 5/3) * Math.pow(P, -2/3) * Math.sqrt(sSlope);
  };

  if(strWidth>0 && strDepth>0 && sSlope>0){
    CapStr = calcQ(strDepth);

    if(Qsel>0){
      let low=0, high=(strDepth*2)||20;
      for(let i=0;i<22;i++){
        const mid=(low+high)/2;
        if(calcQ(mid) < Qsel) low=mid;
        else high=mid;
      }
      yCalc = (low+high)/2;
    }
  }

  // Manual y logic: if user types, treat as manual until resetStrY()
  if(strYEl && strYEl.dataset.boundManual !== '1'){
    strYEl.dataset.boundManual = '1';
    strYEl.addEventListener('input', ()=>{ strYEl.dataset.manual='true'; if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); });
  }
  const isManual = strYEl?.dataset?.manual === 'true';
  const yMan = isManual ? num(strYEl.value) : 0;
  const finalY = isManual ? yMan : yCalc;

  // update y field if auto
  if(!isManual && document.activeElement !== strYEl){
    strYEl.value = (yCalc>0) ? yCalc.toFixed(2) : "";
  }

  // Stats
  setTxt('res-slope', (S*100).toFixed(1) + " %");

  // Tc display with min rule (like ver14 dual)
  const tcEl = document.getElementById('res-tc');
  if((!rainD || rainD<=0) && Tc < 5){
    tcEl.innerHTML = `<span style="color:#d35400;font-weight:900">5.0 min</span>
                      <div style="font-size:10px;color:#6b7a86">(calc: ${Tc.toFixed(2)})</div>`;
  }else{
    tcEl.textContent = Tc.toFixed(1) + " min";
  }

  setTxt('res-qsel', Qsel.toFixed(2) + " mÂ³/s");
  setTxt('res-drains', (CapNet>0 ? CapNet.toFixed(2) : "0.00") + " mÂ³/s");
  setTxt('res-stream', (CapStr>0 ? CapStr.toFixed(2) : "0.00") + " mÂ³/s");

  // adequacy label
  let adq = "<span style='color:#6b7a86'>â€”</span>";
  if(CapNet>0 && CapStr>0) adq = "<span class='status-ok'>Î”Î¹Ï€Î»ÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚</span>";
  else if(CapNet>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ ÏƒÏ…Î»Î»Î¿Î³Î®</span>";
  else if(CapStr>0) adq = "<span class='status-fail'>ÎœÏŒÎ½Î¿ Î´Î¹ÏŒÎ´ÎµÏ…ÏƒÎ·</span>";
  else adq = "<span class='status-warn'>Î§Ï‰ÏÎ¯Ï‚ Qcap</span>";
  document.getElementById('res-adequacy').innerHTML = adq;
  // Rain: ÏƒÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ· (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿ ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Î’ÏÎ¿Ï‡Î®)
  const _rainSumI = document.getElementById('rainSumI');
  if(_rainSumI){
    _rainSumI.textContent = (rainI!=null ? rainI.toFixed(1) : "â€”") + " mm/h";
    const _dEl = document.getElementById('rainSumDused');
    const _pEl = document.getElementById('rainSumP');
    const _qEl = document.getElementById('rainSumQpeak');
    const _rEl = document.getElementById('rainSumRisk');
    if(_dEl) _dEl.textContent = Dused.toFixed(1) + " min";
    if(_pEl) _pEl.textContent = (rainI * (Dused/60)).toFixed(1) + " mm";
    if(_qEl) _qEl.textContent = Qsel.toFixed(2) + " mÂ³/s";

    const capMax = Math.max((CapNet||0), (CapStr||0));
    let rr = "<span style='color:#6b7a86'>â€”</span>";
    if(capMax>0){
      if(Qsel <= capMax*0.85) rr = "<span class='status-ok'>OK</span>";
      else if(Qsel <= capMax) rr = "<span class='status-warn'>ÎŸÏÎ¹Î±ÎºÏŒ</span>";
      else rr = "<span class='status-fail'>Î¥Ï€Î­ÏÎ²Î±ÏƒÎ·</span>";
    }
    if(_rEl) _rEl.innerHTML = rr;
  }


  // Scenario table
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = "";

  const status = (Q, Cap) => {
    if(!(Cap>0)) return "<span class='status-fail' style='font-size:11px'>â€”</span>";
    if(Q <= Cap*0.85) return "<span class='status-ok'>OK</span>";
    if(Q <= Cap) return "<span class='status-warn'>ÎŸÏÎ¹Î±ÎºÏŒ</span>";
    return "<span class='status-fail'>Î¥Ï€Î­ÏÎ²Î±ÏƒÎ·</span>";
  };

  for(let i=5;i<=200;i+=5){
    const P = i*(Dused/60);
    const Q = 0.278*coef*i*A_km2;
    const V = area*(P/1000)*coef;
    const Peq = P*coef;

    let cls="risk-safe", txt="Î§Î±Î¼Î·Î»Î®";
    if(Peq>=60){cls="risk-extreme";txt="Î‘ÎºÏÎ±Î¯Î±";}
    else if(Peq>=40){cls="risk-red";txt="Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î®";}
    else if(Peq>=25){cls="risk-orange";txt="Î¥ÏˆÎ·Î»Î®";}
    else if(Peq>=10){cls="risk-warn";txt="ÎœÎ­Ï„ÏÎ¹Î±";}

    const tr = document.createElement('tr');
    tr.className = cls;
    tr.innerHTML = `
      <td><b>${i}</b></td>
      <td>${Dused.toFixed(1)}</td>
      <td>${P.toFixed(1)}</td>
      <td>${Q.toFixed(2)}</td>
      <td>${Math.round(V).toLocaleString('el-GR')}</td>
      <td>${txt}<br><span style="font-size:11px;color:#6b7a86">Peq=${Peq.toFixed(1)}</span></td>
      <td>${status(Q, CapNet)}</td>
      <td>${status(Q, CapStr)}</td>
    `;
    tbody.appendChild(tr);
  }

  drawChannel(finalY);
  drawBasinPlan();

  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}


function resetStrY(){
  const el = document.getElementById('strY');
  if(!el) return;
  el.value = "";
  delete el.dataset.manual;
  runMasterCalculation();
}

/* ===================== VISUALIZERS ===================== */
function drawBasinPlan(){
  const canvas = document.getElementById('basinCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);

  // If we have GeoJSON rings, draw them; else schematic
  const gj = SELECTED_GEO;
  const rings = gj ? geojsonToRings(gj) : [];
  const style = basinStyleFromInputs();

  if(rings && rings.length && drawGeoRings(ctx, rings, w, h, style)){
    // label
    ctx.fillStyle = "#2c3e50";
    ctx.font = "bold 10px Arial";
    ctx.fillText("Î ÎµÏÎ¯Î³ÏÎ±Î¼Î¼Î± (GeoJSON)", 8, 14);
    drawBasinLegend(ctx, style);
    return;
  }

  // schematic fallback based on A & L
  const A = getVal('area'), L = getVal('length');
  if(!(A>0) || !(L>0)){
    ctx.fillStyle="#9aa6b2";
    ctx.font="12px Arial";
    ctx.textAlign="center";
    ctx.fillText("ÎŸÏÎ¯ÏƒÏ„Îµ A & L Î® Ï†Î¿ÏÏ„ÏÏƒÏ„Îµ Î»ÎµÎºÎ¬Î½Î·", w/2, h/2);
    drawBasinLegend(ctx, style);
    return;
  }
  const W = A / L;
  const pad=14;
  const maxW=w-2*pad, maxH=h-2*pad;
  const scale = Math.min(maxW/(L||1), maxH/((W||1)));
  const Ls=L*scale, Ws=(W||1)*scale;
  const x=(w-Ls)/2, y=(h-Ws)/2;

  roundRect(ctx, x,y,Ls,Ws, Math.min(12, Ws/2, Ls/8));
  ctx.fillStyle = style.fill;
  ctx.fill();
  ctx.strokeStyle = style.stroke;
  ctx.lineWidth = style.lineWidth;
  ctx.stroke();

  ctx.fillStyle="#2c3e50";
  ctx.font="bold 10px Arial";
  ctx.textAlign="center";
  ctx.fillText(`Lâ‰ˆ${Math.round(L)} m`, w/2, h-6);

  ctx.save();
  ctx.translate(10, h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign="center";
  ctx.fillText(`Wâ‰ˆ${Math.round(W)} m`, 0, 0);
  ctx.restore();

  drawBasinLegend(ctx, style);
}

function basinStyleFromInputs(){
  const Qpeak = 0.278 * getVal('coef') * getVal('rainI') * (getVal('area')/1e6);
  const CapNet = getVal('drains') * getVal('drainCap');
  const CapStr = estimateStreamCap();
  // simple coloring: fill by Peq class, stroke by capacity stress
  const Dused = (getVal('rainD')>0) ? getVal('rainD') : Math.max(5, calculateTc(getVal('length'), getVal('height')));
  const P = getVal('rainI')*(Dused/60);
  const Peq = P*getVal('coef');

  let fill="#eafaf1";
  if(Peq>=60) fill="#ffd1d1";
  else if(Peq>=40) fill="#ffe0e0";
  else if(Peq>=25) fill="#ffe9d6";
  else if(Peq>=10) fill="#fff7e6";

  let stroke="#2c3e50";
  let lw=2;
  const netBad = (CapNet>0 && Qpeak>CapNet);
  const strBad = (CapStr>0 && Qpeak>CapStr);
  if(netBad || strBad){ stroke="#c0392b"; lw=3; }
  else if((CapNet>0 && Qpeak>CapNet*0.85) || (CapStr>0 && Qpeak>CapStr*0.85)){ stroke="#d35400"; lw=3; }

  return { fill, stroke, lineWidth: lw };
}

function estimateStreamCap(){
  const strWidth = getVal('strWidth');
  const strZ = getVal('strZ');
  const strDepth = getVal('strDepth');
  const strDrop = getVal('strDrop');
  const strLen = getVal('strLen');
  const strType = getVal('strType');
  const length = getVal('length');
  const height = getVal('height');

  const sLen = (strLen>0)? strLen : length;
  const sDrop = (strDrop>0)? strDrop : height;
  const sSlope = (sLen>0)? (sDrop/sLen) : 0;
  if(!(strWidth>0) || !(strDepth>0) || !(sSlope>0) || !(strType>0)) return 0;
  const A = (strWidth + strZ*strDepth)*strDepth;
  const P = strWidth + 2*strDepth*Math.sqrt(1+strZ*strZ);
  return (1/strType) * Math.pow(A, 5/3) * Math.pow(P, -2/3) * Math.sqrt(sSlope);
}

function drawBasinLegend(ctx, style){
  const x=8, y=ctx.canvas.height-16;
  ctx.fillStyle="#2c3e50";
  ctx.font="bold 10px Arial";
  ctx.textAlign="left";
  ctx.fillText("Fill=Peq, Stroke=Qcap stress", x, y);
  // swatches
  ctx.fillStyle = style.fill;
  ctx.fillRect(ctx.canvas.width-58, ctx.canvas.height-22, 18, 12);
  ctx.strokeStyle = style.stroke;
  ctx.lineWidth = style.lineWidth;
  ctx.strokeRect(ctx.canvas.width-30, ctx.canvas.height-22, 18, 12);
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function geojsonToRings(gj){
  const rings = [];
  try{
    const feat = gj.features ? gj.features[0] : gj;
    const g = feat.geometry || feat;
    if(!g) return rings;

    const pushPoly = (poly) => {
      // poly: [ [ [lon,lat], ... ] , holes... ]
      if(Array.isArray(poly) && poly.length){
        rings.push(poly[0]);
      }
    };

    if(g.type === 'Polygon') pushPoly(g.coordinates);
    if(g.type === 'MultiPolygon'){
      for(const poly of g.coordinates) pushPoly(poly);
    }
  }catch(_){}
  return rings;
}

function drawGeoRings(ctx, rings, w, h, style){
  try{
    // safety limits (avoid UI freeze on huge/corrupted GeoJSON)
    const MAX_RINGS = 120;
    const MAX_POINTS = 15000;

    if(!Array.isArray(rings)) return false;
    if(rings.length > MAX_RINGS) rings = rings.slice(0, MAX_RINGS);

    let totalPoints = 0;
    rings = rings.map(r=>{
      if(!Array.isArray(r)) return null;
      const remain = MAX_POINTS - totalPoints;
      if(remain <= 0) return null;
      const take = Math.min(r.length, remain);
      totalPoints += take;
      return r.slice(0, take);
    }).filter(r=>r && r.length >= 3);

    if(!rings.length) return false;

    // find bounds
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    for(const r of rings){
      for(const [x,y] of r){
        if(x<minX) minX=x;
        if(y<minY) minY=y;
        if(x>maxX) maxX=x;
        if(y>maxY) maxY=y;
      }
    }
    if(!isFinite(minX) || !isFinite(maxX)) return false;

    const pad=14;
    const sx=(w-2*pad)/((maxX-minX)||1);
    const sy=(h-2*pad)/((maxY-minY)||1);
    const s=Math.min(sx,sy);

    const tx = (x)=> pad + (x-minX)*s;
    const ty = (y)=> h-pad - (y-minY)*s; // flip

    ctx.beginPath();
    for(const r of rings){
      for(let i=0;i<r.length;i++){
        const p = r[i];
        const X = tx(p[0]);
        const Y = ty(p[1]);
        if(i===0) ctx.moveTo(X,Y);
        else ctx.lineTo(X,Y);
      }
      ctx.closePath();
    }
    ctx.fillStyle = style.fill;
    ctx.fill();
    ctx.strokeStyle = style.stroke;
    ctx.lineWidth = style.lineWidth;
    ctx.stroke();
    return true;
  }catch(e){
    return false;
  }
}

function drawChannel(y_real){
  const canvas = document.getElementById('channelCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);

  const b = getVal('strWidth');
  const z = getVal('strZ');
  const H = getVal('strDepth');
  const y = y_real;

  if(b<=0 && H<=0){
    ctx.fillStyle="#9aa6b2";
    ctx.font="12px Arial";
    ctx.textAlign="center";
    ctx.fillText("ÎŸÏÎ¯ÏƒÏ„Îµ b & h", w/2, h/2);
    return;
  }

  const maxH = Math.max(H, y);
  const topW = b + 2*(z*maxH);
  const pad=20;
  const scale = Math.min((w-pad)/(topW||1),(h-pad)/(maxH||1));
  const cx=w/2, cy=h-16;

  const gx = (wd)=>(wd*scale)/2;
  const gy = (d)=> cy - (d*scale);

  const drawPoly = (tw, d, fill, stroke, dash=[])=>{
    ctx.beginPath();
    ctx.moveTo(cx-gx(tw), gy(d));
    ctx.lineTo(cx-gx(b), cy);
    ctx.lineTo(cx+gx(b), cy);
    ctx.lineTo(cx+gx(tw), gy(d));
    ctx.closePath();
    if(fill){ ctx.fillStyle=fill; ctx.fill(); }
    if(stroke){
      ctx.strokeStyle=stroke;
      ctx.setLineDash(dash);
      ctx.lineWidth=2;
      ctx.stroke();
      ctx.setLineDash([]);
    }
  };

  // banks outline
  if(H>0){
    drawPoly(b+2*z*H, H, null, "#5D4037");
  }
  // water
  if(y>0){
    const isOver = (H>0 && y>H);
    drawPoly(b+2*z*Math.min(y, H*1.5||y), Math.min(y, H*1.5||y),
      isOver ? "rgba(231,76,60,0.55)" : "rgba(52,152,219,0.55)",
      isOver ? "#c0392b" : "#2980b9",
      []
    );
    // waterline
    ctx.beginPath();
    ctx.moveTo(cx-gx(b+2*z*y), gy(y));
    ctx.lineTo(cx+gx(b+2*z*y), gy(y));
    ctx.strokeStyle="#2c3e50";
    ctx.lineWidth=1;
    ctx.stroke();

    ctx.fillStyle="#2c3e50";
    ctx.font="bold 10px Arial";
    ctx.textAlign="center";
    ctx.fillText(`y=${y.toFixed(2)}m`, cx, gy(y)-6);
  }

  ctx.fillStyle="#2c3e50";
  ctx.font="bold 10px Arial";
  ctx.textAlign="center";
  if(b>0) ctx.fillText(`b=${b}m`, cx, cy+12);
}

/* ===================== Inputs binding ===================== */
function bindInputs(){
  const ids = [
    'rainI','rainD','area','length','height','coef',
    'drains','drainCap',
    'strWidth','strZ','strDepth','strDrop','strLen','strType','strY'
  ];

  // avoid heavy recalcs while typing
  const debouncedCalc = debounce(()=>{ runMasterCalculation(); scheduleSaveUiState(); }, 140);

  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;

    // bind once
    if(el.dataset.boundCalc === '1') return;
    el.dataset.boundCalc = '1';

    el.addEventListener('input', debouncedCalc);
    el.addEventListener('change', ()=>{ runMasterCalculation(); scheduleSaveUiState(); });
  });

  // Make strY manual once user edits it (bind once)
  const strYEl = document.getElementById('strY');
  if(strYEl && strYEl.dataset.boundManual !== '1'){
    strYEl.dataset.boundManual = '1';
    strYEl.addEventListener('input', ()=>{ strYEl.dataset.manual='true'; scheduleSaveUiState(); });
  }
}



</script>
<!-- ===================== FIREBASE LOGGER (FINAL) ===================== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    writeBatch,
    serverTimestamp,
    collection,
    collectionGroup,
    getDocs,
    query,
    orderBy,
    limit
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // Firebase config (project: nireas-logger)
  const firebaseConfig = {
    apiKey: "AIzaSyCLMx9W0Zi91-m4NmMl6UocYHhYBWUh9VI",
    authDomain: "nireas-logger.firebaseapp.com",
    projectId: "nireas-logger",
    storageBucket: "nireas-logger.firebasestorage.app",
    messagingSenderId: "632371274630",
    appId: "1:632371274630:web:f4f50d5c3f7c9bc060c207"
  };

  // Small stable id generator (FNV-1a 32-bit)
  function fnv1a32(str){
    let h = 0x811c9dc5;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h * 0x01000193) >>> 0;
    }
    return h >>> 0;
  }
  function stationIdFromKey(stationKey){
    return "s_" + fnv1a32(String(stationKey)).toString(16);
  }

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Start auth immediately; fbLogSample will wait for it
  const authReady = signInAnonymously(auth)
    .then(()=>console.log("Firebase auth OK âœ…"))
    .catch((e)=>console.error("Firebase auth FAILED âŒ", e));

  // Writes:
  // stations/<stationId>  (merge)  + lastSample
  // stations/<stationId>/samples/t_<tsMs> (merge)  (DEDUP by timestamp)
  window.fbLogSample = async (stationKey, sample) => {
    await authReady;

    const stationId = stationIdFromKey(stationKey);
    const tsMs = (typeof sample?.tsMs === "number") ? sample.tsMs : Date.now();
    const sampleDocId = "t_" + String(tsMs);

    const stationRef = doc(db, "stations", stationId);
    const sampleRef  = doc(db, "stations", stationId, "samples", sampleDocId);

    const payload = {
      stationId,
      stationKey: String(stationKey),
      label: sample?.label ?? null,

      stationName: sample?.stationName ?? null,
      stationUrl: sample?.stationUrl ?? null,
      lat: (typeof sample?.lat === "number") ? sample.lat : null,
      lon: (typeof sample?.lon === "number") ? sample.lon : null,
      elev: (typeof sample?.elev === "number") ? sample.elev : null,

      sampleKey: sample?.sampleKey ?? null,
      tsMs,
      tsText: sample?.tsText ?? null,

      rainRate: (typeof sample?.rainRate === "number") ? sample.rainRate : null,
      dp: (typeof sample?.dp === "number") ? sample.dp : null,
      total: (typeof sample?.total === "number") ? sample.total : null,
      totalSrc: sample?.totalSrc ?? null,

      // extra metrics
      temp: (typeof sample?.temp === "number") ? sample.temp : null,
      hum: (typeof sample?.hum === "number") ? sample.hum : null,
      dewPoint: (typeof sample?.dewPoint === "number") ? sample.dewPoint : null,
      wind: (typeof sample?.wind === "string") ? sample.wind : null,
      baro: (typeof sample?.baro === "number") ? sample.baro : null,

      today: (typeof sample?.today === "number") ? sample.today : null,
      storm: (typeof sample?.storm === "number") ? sample.storm : null,
      month: (typeof sample?.month === "number") ? sample.month : null,
      year: (typeof sample?.year === "number") ? sample.year : null,

      chill: (typeof sample?.chill === "number") ? sample.chill : null,
      heat: (typeof sample?.heat === "number") ? sample.heat : null,
      sunrise: (typeof sample?.sunrise === "string") ? sample.sunrise : null,
      sunset: (typeof sample?.sunset === "string") ? sample.sunset : null,

      fetchedAt: serverTimestamp(),
      clientTsMs: Date.now()
    };

    const batch = writeBatch(db);

    // ensure station doc exists + keep lastSample for dashboard
    batch.set(stationRef, {
      stationId,
      stationKey: String(stationKey),
      label: sample?.label ?? null,

      stationName: sample?.stationName ?? null,
      stationUrl: sample?.stationUrl ?? null,
      lat: (typeof sample?.lat === "number") ? sample.lat : null,
      lon: (typeof sample?.lon === "number") ? sample.lon : null,
      elev: (typeof sample?.elev === "number") ? sample.elev : null,
      lastSeen: serverTimestamp(),
      lastSample: {
        tsMs,
        tsText: payload.tsText,
        stationName: payload.stationName,
        stationUrl: payload.stationUrl,
        lat: payload.lat,
        lon: payload.lon,
        elev: payload.elev,
        rainRate: payload.rainRate,
        dp: payload.dp,
        total: payload.total,
        totalSrc: payload.totalSrc,

        temp: payload.temp,
        hum: payload.hum,
        dewPoint: payload.dewPoint,
        wind: payload.wind,
        baro: payload.baro,

        today: payload.today,
        storm: payload.storm,
        month: payload.month,
        year: payload.year,

        chill: payload.chill,
        heat: payload.heat,
        sunrise: payload.sunrise,
        sunset: payload.sunset
      }
    }, { merge: true });

    // dedup by docId (t_<tsMs>)
    batch.set(sampleRef, payload, { merge: true });

    await batch.commit();
  };


  // Reads:
  // stations/<stationId>/samples (orderBy tsMs desc)
  window.fbFetchRecentSamples = async (stationKey, limitN = 50) => {
    await authReady;

    const stationId = stationIdFromKey(stationKey);
    const lim = Math.max(1, Math.min(500, Number(limitN) || 50));
    const colRef = collection(db, "stations", stationId, "samples");
    const q = query(colRef, orderBy("tsMs", "desc"), limit(lim));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };



  // Reads (ALL stations) via collectionGroup("samples") (orderBy tsMs desc)
  // NOTE: Requires Firestore rules to allow collectionGroup read.
  window.fbFetchRecentSamplesAll = async (limitN = 200) => {
    await authReady;
    const lim = Math.max(1, Math.min(500, Number(limitN) || 200));
    const q = query(collectionGroup(db, "samples"), orderBy("tsMs", "desc"), limit(lim));
    const snap = await getDocs(q);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };


  console.log("Firebase logger ready âœ…");
</script>
<!-- ===================== /FIREBASE LOGGER ===================== -->
<script>
/* ===================== COâ€‘HAZARDS (Primary + Secondary) ===================== */
(function(){
  const LS_COH = 'NIREAS_CO_HAZARDS_V1';

  function hzName(hz){
    const map = { wind:'Î†Î½ÎµÎ¼Î¿Ï‚', rain:'Î’ÏÎ¿Ï‡Î®', heatwave:'ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚', frost_snow:'Î Î±Î³ÎµÏ„ÏŒÏ‚' };
    return map[hz] || hz;
  }

  function getPrimaryScenario(){
    try{
      const sel = document.getElementById('modelScenario');
      return sel ? String(sel.value || '').trim() : (document.body.dataset.modelScenario || 'rain');
    }catch(_){ return (document.body.dataset.modelScenario || 'rain'); }
  }

  function getLatestSample(){
    try{
      if(window.stationSeries && Array.isArray(window.stationSeries) && window.stationSeries.length){
        return window.stationSeries[window.stationSeries.length-1];
      }
      // fallback (in case it's not on window)
      if(typeof stationSeries !== 'undefined' && Array.isArray(stationSeries) && stationSeries.length){
        return stationSeries[stationSeries.length-1];
      }
    }catch(_){}
    return null;
  }

  function numFromText(txt){
    if(txt == null) return null;
    const s = String(txt).replace(',', '.');
    const m = s.match(/-?\d+(?:\.\d+)?/);
    return m ? Number(m[0]) : null;
  }
  function fmt(v, unit=''){
    if(v==null || !Number.isFinite(v)) return 'â€”';
    const n = Math.round(v*10)/10;
    return n.toFixed(1) + unit;
  }

  // coâ€‘hazards state
  const coHaz = new Set();

  function loadCoHazards(){
    try{
      const raw = localStorage.getItem(LS_COH);
      if(!raw) return;
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) arr.forEach(x=>coHaz.add(String(x)));
    }catch(_){}
  }
  function saveCoHazards(){
    try{ localStorage.setItem(LS_COH, JSON.stringify(Array.from(coHaz))); }catch(_){}
  }

  function syncCoHazardButtons(){
    const primary = getPrimaryScenario();
    const btns = document.querySelectorAll('#coHazards .cohz');
    btns.forEach(btn=>{
      const hz = btn.getAttribute('data-hz');
      const isPrimary = (hz === primary);
      if(isPrimary){
        coHaz.delete(hz); // never allow primary as secondary
      }
      btn.disabled = isPrimary;
      btn.classList.toggle('cohz-on', coHaz.has(hz));
    });
  }

  
  function syncCoHazardsContextFromGlobal(){
    const srcBadges = document.getElementById('coHazardsBadges');
    const srcMetrics = document.getElementById('coHazardsMetrics');
    const badgesHTML = srcBadges ? srcBadges.innerHTML : '';
    const metricsHTML = srcMetrics ? srcMetrics.innerHTML : 'â€”';

    ['rain','wind','heatwave','frost_snow'].forEach(k=>{
      const b = document.getElementById(`coHazardsBadges_ctx_${k}`);
      const m = document.getElementById(`coHazardsMetrics_ctx_${k}`);
      if(b) b.innerHTML = badgesHTML;
      if(m) m.innerHTML = metricsHTML;
    });
  }

function renderCoHazardsGlobal(){
    const box = document.getElementById('coHazardsGlobal');
    const badges = document.getElementById('coHazardsBadges');
    const metrics = document.getElementById('coHazardsMetrics');
    if(!box || !badges || !metrics) return;

    const arr = Array.from(coHaz);

    // Keep the panel visible (consistent with other panels)
    box.style.display = '';

    if(!arr.length){
      badges.innerHTML = '';
      metrics.innerHTML = '<span style="color:#6b7a86">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Ï€.Ï‡. +Î†Î½ÎµÎ¼Î¿Ï‚, +Î’ÏÎ¿Ï‡Î®, +ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚, +Î Î±Î³ÎµÏ„ÏŒÏ‚) Î³Î¹Î± Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½ Î´ÎµÎ¯ÎºÏ„ÎµÏ‚.</span>';
      syncCoHazardsContextFromGlobal();
      return;
    }
    badges.innerHTML = arr.map(hz=>`<span class="cohazards-badge cohz-badge-${hz}">+ ${hzName(hz)}</span>`).join('');

    const s = getLatestSample();
    if(!s){
      metrics.innerHTML = '<span style="color:#6b7a86">Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î® ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Live Î³Î¹Î± Î½Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„Î¿ÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±.</span>';
      syncCoHazardsContextFromGlobal();
      return;
    }

    // common fields from sample
    const t = (typeof s.temp === 'number') ? s.temp : ((typeof s.temperature === 'number') ? s.temperature : numFromText(s.temp));
    const hi = (typeof s.heatIndex === 'number') ? s.heatIndex : ((typeof s.hi === 'number') ? s.hi : numFromText(s.heatIndex));
    const chill = (typeof s.chill === 'number') ? s.chill : numFromText(s.chill);
    const rr = (typeof s.rainRate === 'number') ? s.rainRate : ((typeof s.rr === 'number') ? s.rr : numFromText(s.rainRate));
    const storm = (typeof s.storm === 'number') ? s.storm : numFromText(s.storm);
    const windTxt = (s.wind != null) ? String(s.wind) : '';
    const wKmh = (typeof s.windKmh === 'number') ? s.windKmh : ((typeof s.wind_kmh === 'number') ? s.wind_kmh : numFromText(windTxt));

    // derive wind dir (simple parse)
    let wDir = 'â€”';
    try{
      const parts = windTxt.trim().split(/\s+/);
      const last = parts[parts.length-1];
      if(last && /[A-ZÎ‘-Î©]{1,3}/i.test(last)) wDir = last;
    }catch(_){}

    // risk helpers using existing threshold inputs (if present)
    function windRisk(){
      const warnK = Number(document.getElementById('windWarnKmh')?.value);
      const highK = Number(document.getElementById('windHighKmh')?.value);
      if(!Number.isFinite(wKmh)) return 'â€”';
      if(Number.isFinite(highK) && wKmh >= highK) return 'Î¥ÏˆÎ·Î»ÏŒÏ‚';
      if(Number.isFinite(warnK) && wKmh >= warnK) return 'ÎœÎ­Ï„ÏÎ¹Î¿Ï‚';
      return 'Î§Î±Î¼Î·Î»ÏŒÏ‚';
    }
    function heatRisk(){
      const warnHI = Number(document.getElementById('heatWarnHI')?.value);
      const highHI = Number(document.getElementById('heatHighHI')?.value);
      const x = Number.isFinite(hi) ? hi : t;
      if(!Number.isFinite(x)) return 'â€”';
      if(Number.isFinite(highHI) && x >= highHI) return 'Î¥ÏˆÎ·Î»ÏŒÏ‚';
      if(Number.isFinite(warnHI) && x >= warnHI) return 'ÎœÎ­Ï„ÏÎ¹Î¿Ï‚';
      return 'Î§Î±Î¼Î·Î»ÏŒÏ‚';
    }
    function frostRisk(){
      const t0 = Number(document.getElementById('frostTemp0')?.value);
      const tHigh = Number(document.getElementById('frostTempHigh')?.value);
      if(!Number.isFinite(t)) return 'â€”';
      if(Number.isFinite(tHigh) && t <= tHigh) return 'Î¥ÏˆÎ·Î»ÏŒÏ‚';
      if(Number.isFinite(t0) && t <= t0) return 'ÎœÎ­Ï„ÏÎ¹Î¿Ï‚';
      if(t <= 2) return 'Î§Î±Î¼Î·Î»ÏŒÏ‚';
      return 'Î§Î±Î¼Î·Î»ÏŒÏ‚';
    }
    function iceRisk(){
      if(!Number.isFinite(t)) return 'â€”';
      if(t <= 0 && Number.isFinite(rr) && rr > 0) return 'Î¥ÏˆÎ·Î»ÏŒÏ‚';
      if(t <= 1) return 'ÎœÎ­Ï„ÏÎ¹Î¿Ï‚';
      return 'Î§Î±Î¼Î·Î»ÏŒÏ‚';
    }

    const lines = [];
    arr.forEach(hz=>{
      if(hz === 'wind'){
        lines.push(`<li><b>Î†Î½ÎµÎ¼Î¿Ï‚</b>: ${fmt(wKmh,' km/h')} ${wDir !== 'â€”' ? wDir : ''} â€” <span style="color:#6b7a86">ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</span> <b>${windRisk()}</b></li>`);
      }else if(hz === 'rain'){
        lines.push(`<li><b>Î’ÏÎ¿Ï‡Î®</b>: ${Number.isFinite(rr) ? fmt(rr,' mm/h') : 'â€”'} â€” <span style="color:#6b7a86">Storm:</span> ${Number.isFinite(storm) ? fmt(storm,' mm') : 'â€”'}</li>`);
      }else if(hz === 'heatwave'){
        const hiTxt = Number.isFinite(hi) ? fmt(hi,' Â°C') : 'â€”';
        lines.push(`<li><b>ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</b>: T ${fmt(t,' Â°C')} â€” HI ${hiTxt} â€” <span style="color:#6b7a86">ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</span> <b>${heatRisk()}</b></li>`);
      }else if(hz === 'frost_snow'){
        lines.push(`<li><b>Î Î±Î³ÎµÏ„ÏŒÏ‚</b>: T ${fmt(t,' Â°C')} â€” Chill ${Number.isFinite(chill) ? fmt(chill,' Â°C') : 'â€”'} â€” <span style="color:#6b7a86">Î Î±Î³ÎµÏ„ÏŒÏ‚:</span> <b>${frostRisk()}</b>, <span style="color:#6b7a86">Î Î¬Î³Î¿Ï‚:</span> <b>${iceRisk()}</b></li>`);
      }
    });

    metrics.innerHTML = `<ul>${lines.join('')}</ul>`;
  
    syncCoHazardsContextFromGlobal();
}

  // exposed API
  window.toggleCoHazard = function(hz){
    const primary = getPrimaryScenario();
    const x = String(hz || '').trim();
    if(!x || x === primary) return;
    if(coHaz.has(x)) coHaz.delete(x); else coHaz.add(x);
    saveCoHazards();
    syncCoHazardButtons();
    renderCoHazardsGlobal();
  };
// Clear all selected secondary hazards (used by the reset icon)
window.clearCoHazards = function(){
  try{
    coHaz.clear();
    saveCoHazards();
    syncCoHazardButtons();
    renderCoHazardsGlobal();
  }catch(e){
    console.warn('clearCoHazards failed', e);
  }
};


  window.initCoHazardsUI = function(){
    loadCoHazards();
    syncCoHazardButtons();
    renderCoHazardsGlobal();

    // keep UI in sync with primary scenario changes
    const sel = document.getElementById('modelScenario');
    if(sel){
      sel.addEventListener('change', ()=>{
        syncCoHazardButtons();
        renderCoHazardsGlobal();
      });
    }

    // hook into refreshScenarioPanels if available
    try{
      if(typeof window.refreshScenarioPanels === 'function' && !window.__cohazardsWrapped){
        const orig = window.refreshScenarioPanels;
        window.refreshScenarioPanels = function(){
          const r = orig.apply(this, arguments);
          try{ renderCoHazardsGlobal(); }catch(_){}
          return r;
        };
        window.__cohazardsWrapped = true;
      }
    }catch(_){}
  };
})();
</script>
<script type="module">
/* ===================== BOOT ===================== */
/*
  NOTE:
  - The Firebase logger/reader is loaded via <script type="module"> earlier in the document and is deferred.
  - This boot waits until the required global init* functions exist before starting.
*/
(function(){
  const NEED = ['initAIAnalysisUI','initDbReaderUI','initSeriesReaderUI','initCoHazardsUI','init'];
  const MAX_TRIES = 80;      // 80 * 50ms = 4s worst-case
  const INTERVAL_MS = 50;

  function safeCall(fnName){
    try{
      const fn = window[fnName];
      if(typeof fn === 'function') fn();
    }catch(e){
      console.warn('BOOT:', fnName, 'failed:', e);
    }
  }

  function bindScenarioInputs(){
    try{
      ['windWarnKmh','windHighKmh','heatWarnHI','heatHighHI','frostWarnT','frostHighT']
        .forEach(id=>{
          const el = document.getElementById(id);
          if(!el) return;
          el.addEventListener('input', ()=>{
            try{ window.refreshScenarioPanels && window.refreshScenarioPanels(); }catch(_){}
          });
        });
    }catch(e){
      console.warn('BOOT: bindScenarioInputs failed:', e);
    }
  }

  // Global scenario auto-refresh: update mini-panels on ANY meaningful change (capture phase so it can't be blocked).
  let __scenarioRefreshTimer = null;
  function __scheduleScenarioRefresh(){
    try{
      if(__scenarioRefreshTimer) clearTimeout(__scenarioRefreshTimer);
      __scenarioRefreshTimer = setTimeout(()=>{ try{ refreshScenarioPanels(); }catch(_){ } }, 60);
    }catch(_){}
  }

  function bindGlobalScenarioAutoRefresh(){
    try{
      ['input','change'].forEach(ev=>{
        document.addEventListener(ev, __scheduleScenarioRefresh, true); // capture-phase
      });

      // clicks on buttons/selects often trigger state changes (Load, Reset, etc.)
      document.addEventListener('click', (e)=>{
        try{
          const t = e.target;
          if(!t) return;
          if(t.matches('button,select,option') || t.closest('button') || t.closest('select')){
            __scheduleScenarioRefresh();
          }
        }catch(_){}
      }, true);
    }catch(_){}

    // When switching primary station, clear scenario summary until a new fetch arrives
    try{
      const sel = document.getElementById('primaryStation');
      if(sel){
        sel.addEventListener('change', ()=>{
          try{ window.__PRIMARY_LATEST_SAMPLE = null; }catch(_){}
          try{ setScenarioSummaryPlaceholder(true); }catch(_){}
          __scheduleScenarioRefresh();
        }, true);
      }
    }catch(_){}
  }

  function boot(attempt){
    const missing = NEED.filter(n => typeof window[n] !== 'function');
    if(missing.length){
      if(attempt < MAX_TRIES){
        setTimeout(()=>boot(attempt+1), INTERVAL_MS);
      }else{
        console.warn('BOOT: missing functions after waiting:', missing);
      }
      return;
    }

    // init UI modules
    safeCall('initAIAnalysisUI');
    safeCall('initDbReaderUI');
    safeCall('initSeriesReaderUI');
    safeCall('initCoHazardsUI');

    bindScenarioInputs();
    try{ bindGlobalScenarioAutoRefresh(); }catch(e){ console.warn('BOOT: bindGlobalScenarioAutoRefresh failed:', e); }


    // start app
    safeCall('init');
  }

  // run after DOM is ready (module scripts execute before DOMContentLoaded)
  window.addEventListener('DOMContentLoaded', ()=>{
    boot(0);
  });})();

function initCollapsedCards(){
  // Ensure cards that start with a collapsed body also get rounded header corners
  document.querySelectorAll('.section-body.collapsed').forEach(body => {
    const card = body.closest('.panel-card');
    if(card) card.classList.add('is-collapsed');
  });
}

document.addEventListener('DOMContentLoaded', () => {
  initCollapsedCards();
});

</script>
</body>
</html>
