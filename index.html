<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NIREAS â€“ Sheet Sync</title>
  <style>
    :root{--bg:#0b0f14;--panel:#111826;--panel2:#0f1623;--txt:#e7eefb;--muted:#9fb0c7;--ok:#38b000;--bad:#d90429;--warn:#ffb703;--line:#22324a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#070a0f,#0b0f14); color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:10px}
    .badge{font-weight:700;background:#0a2a43;border:1px solid #174a73;padding:6px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(17,24,38,.9);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.35);overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(15,22,35,.6);font-size:14px;letter-spacing:.3px}
    .card .body{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button,textarea{
      width:100%;padding:10px 11px;border-radius:10px;border:1px solid #2a3d5a;
      background:#0a1220;color:var(--txt);outline:none
    }
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:550px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{cursor:pointer;font-weight:700}
    .btn{width:auto;padding:10px 14px}
    .btn.primary{background:#1d4ed8;border-color:#2b67ff}
    .btn.ghost{background:transparent}
    .btn.good{background:#0a3d2a;border-color:#1f7a4a}
    .btn.bad{background:#3a0a16;border-color:#7a1f36}
    .status{display:flex;align-items:center;gap:10px;margin-top:10px;color:var(--muted);font-size:13px}
    .dot{width:10px;height:10px;border-radius:999px;background:#64748b}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;font-size:13px;color:var(--muted)}
    .kv b{color:var(--txt);font-weight:700}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
    .log{background:#070c14;border:1px dashed #2a3d5a;border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .small{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #2a3d5a;background:#0a1220;color:var(--muted);font-size:12px}
    .sep{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="title">
      <div class="badge">ğŸŒŠ NIREAS</div>
      <div>
        <div style="font-weight:800;font-size:18px;letter-spacing:.2px">Sheet Sync â€“ Î’Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½</div>
        <div class="small">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· â€œÏŒ,Ï„Î¹ Î­ÏÏ‡ÎµÏ„Î±Î¹â€ Î±Ï€ÏŒ ÏƒÏ„Î±Î¸Î¼ÏŒ ÏƒÏ„Î¿ Google Sheet Î¼Î­ÏƒÏ‰ Apps Script (token: <span class="mono">123456789</span>).</div>
      </div>
    </div>
    <div class="pill" id="buildInfo">v1</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>ğŸ” Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Apps Script</h3>
      <div class="body">
        <label>Web App URL (exec)</label>
        <input id="gasUrl" class="mono" placeholder="https://script.google.com/macros/s/.../exec"/>
        <div class="row">
          <div>
            <label>Token</label>
            <input id="gasToken" class="mono" placeholder="123456789"/>
          </div>
          <div>
            <label>Î¦ÏÎ»Î»Î¿</label>
            <input id="sheetName" class="mono" value="Î¦ÏÎ»Î»Î¿1" />
          </div>
        </div>

        <div class="btns">
          <button class="btn primary" id="btnSave">ğŸ’¾ Save</button>
          <button class="btn ghost" id="btnPing">ğŸ“¡ Ping</button>
          <button class="btn ghost" id="btnOpenSheet">ğŸ“„ Open Sheet</button>
          <button class="btn bad" id="btnClearCfg">ğŸ§¹ Clear</button>
        </div>

        <div class="status">
          <span class="dot" id="syncDot"></span>
          <span id="syncText">Sheet Sync: ÏŒÏ‡Î¹ ÎµÎ»ÎµÎ³Î¼Î­Î½Î¿</span>
        </div>

        <div class="sep"></div>
        <div class="small">
          Î‘Î½ Î²Î»Î­Ï€ÎµÎ¹Ï‚ <span class="mono">unauthorized</span>:
          (Î±) ÏƒÏ„Î¿ Code.gs Ï„Î¿ TOKEN Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ <b>string</b> (<span class="mono">'123456789'</span>),
          (Î²) ÎºÎ¬Î½Îµ <b>Deploy â†’ New version</b> Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ Î±Î»Î»Î±Î³Î®.
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ“¡ Î£Ï„Î±Î¸Î¼Î¿Î¯ (Openâ€‘Meteo)</h3>
      <div class="body">
        <label>Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï</label>
        <select id="stationSel"></select>

        <div class="row">
          <div>
            <label>Latitude</label>
            <input id="lat" class="mono" />
          </div>
          <div>
            <label>Longitude</label>
            <input id="lon" class="mono" />
          </div>
        </div>

        <div class="btns">
          <button class="btn good" id="btnFetch">â¬‡ï¸ Î›Î®ÏˆÎ· Ï„ÏÏÎ±</button>
          <button class="btn ghost" id="btnRecent">ğŸ•˜ Recent Î±Ï€ÏŒ Sheet</button>
        </div>

        <div class="sep"></div>

        <div class="kv">
          <div>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ timestamp</div><div><b id="lastTs">â€”</b></div>
          <div>Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ (queue)</div><div><b id="queued">0</b></div>
          <div>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±</div><div><b id="lastRes">â€”</b></div>
        </div>

        <div class="sep"></div>
        <div class="small">Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎµÏ‚ Ï„Î¹Î¼Î­Ï‚ (Î±Ï€ÏŒ Openâ€‘Meteo <span class="mono">current</span>):</div>
        <pre class="log mono" id="currentBox">â€”</pre>
      </div>
    </div>

    <div class="card" style="grid-column:1/-1">
      <h3>ğŸ§¾ Log</h3>
      <div class="body">
        <div class="btns">
          <button class="btn ghost" id="btnCopyLog">ğŸ“‹ Copy</button>
          <button class="btn ghost" id="btnClearLog">ğŸ§¹ Clear log</button>
        </div>
        <div class="log mono" id="logBox"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxJZEqWWTETD4IrY5X2ybTHwsKPuOI_MZ8hhbL9pyhzhMgVhQjBq5ZwPRp0Omq4uOj86Q/exec";
const DEFAULT_TOKEN = "123456789";
const LS_GAS_URL = "nireas_gas_url";
const LS_GAS_TOKEN = "nireas_gas_token";
const LS_SHEET_NAME = "nireas_sheet_name";

/* Minimal stations list (Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎµÎ¹Ï‚ ÏŒÏƒÎ¿Ï…Ï‚ Î¸ÎµÏ‚ ÎµÎ´Ï) */
const STATIONS = [
  { key:"open-meteo:chalandri", name:"Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)", lat:38.0237, lon:23.8007 },
  { key:"open-meteo:nomismatokopeio", name:"ÎÎ¿Î¼Î¹ÏƒÎ¼Î±Ï„Î¿ÎºÎ¿Ï€ÎµÎ¯Î¿", lat:38.0199, lon:23.8112 },
  { key:"open-meteo:papagou", name:"Î Î±Ï€Î¬Î³Î¿Ï…", lat:38.0016, lon:23.7931 },
  { key:"open-meteo:psychiko", name:"Î¨Ï…Ï‡Î¹ÎºÏŒ", lat:38.0031, lon:23.7688 }
];

/* =================== UI =================== */
const $ = (id)=>document.getElementById(id);
const gasUrlEl = $("gasUrl");
const gasTokenEl = $("gasToken");
const sheetNameEl = $("sheetName");
const dotEl = $("syncDot");
const syncTextEl = $("syncText");

const stationSel = $("stationSel");
const latEl = $("lat");
const lonEl = $("lon");
const currentBox = $("currentBox");
const lastTsEl = $("lastTs");
const queuedEl = $("queued");
const lastResEl = $("lastRes");
const logBox = $("logBox");

function log(msg){
  const ts = new Date().toLocaleString("el-GR");
  logBox.textContent += `[${ts}] ${msg}\n`;
  logBox.scrollTop = logBox.scrollHeight;
}

function setStatus(kind, text){
  dotEl.className = "dot " + (kind||"");
  syncTextEl.textContent = text;
}

function loadCfg(){
  gasUrlEl.value = localStorage.getItem(LS_GAS_URL) || DEFAULT_GAS_URL;
  gasTokenEl.value = localStorage.getItem(LS_GAS_TOKEN) || DEFAULT_TOKEN;
  sheetNameEl.value = localStorage.getItem(LS_SHEET_NAME) || "Î¦ÏÎ»Î»Î¿1";
}

function saveCfg(){
  localStorage.setItem(LS_GAS_URL, gasUrlEl.value.trim());
  localStorage.setItem(LS_GAS_TOKEN, gasTokenEl.value.trim());
  localStorage.setItem(LS_SHEET_NAME, sheetNameEl.value.trim());
}

function clearCfg(){
  localStorage.removeItem(LS_GAS_URL);
  localStorage.removeItem(LS_GAS_TOKEN);
  localStorage.removeItem(LS_SHEET_NAME);
  loadCfg();
}

function fillStations(){
  stationSel.innerHTML = "";
  STATIONS.forEach((s, i)=>{
    const opt = document.createElement("option");
    opt.value = s.key;
    opt.textContent = s.name;
    stationSel.appendChild(opt);
  });
  stationSel.value = STATIONS[0].key;
  applyStation();
}

function applyStation(){
  const s = STATIONS.find(x=>x.key === stationSel.value) || STATIONS[0];
  latEl.value = s.lat;
  lonEl.value = s.lon;
}

/* =================== JSONP GET (Î³Î¹Î± CORS-free read/ping) =================== */
let __jsonpSeq = 0;
function gasGetJSONP(params){
  return new Promise((resolve, reject)=>{
    const gasUrl = gasUrlEl.value.trim();
    const token = gasTokenEl.value.trim();
    const callbackName = "__nireas_cb_" + (++__jsonpSeq);

    const q = new URLSearchParams(params);
    q.set("token", token);
    q.set("callback", callbackName);

    const url = gasUrl + (gasUrl.includes("?") ? "&" : "?") + q.toString();

    const script = document.createElement("script");
    const timeout = setTimeout(()=>{
      cleanup();
      reject(new Error("JSONP timeout"));
    }, 15000);

    function cleanup(){
      clearTimeout(timeout);
      try{ delete window[callbackName]; }catch(_){}
      script.remove();
    }

    window[callbackName] = (data)=>{
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      cleanup();
      reject(new Error("JSONP load error"));
    };

    script.src = url;
    document.head.appendChild(script);
  });
}

/* =================== POST (write) =================== */
let queue = [];
let queuedCount = 0;

function enqueueRecord(rec){
  queue.push(rec);
  queuedCount += 1;
  queuedEl.textContent = String(queuedCount);
}

async function flushQueue(){
  if (!queue.length) return;

  const gasUrl = gasUrlEl.value.trim();
  const token = gasTokenEl.value.trim();
  const sheetName = sheetNameEl.value.trim();

  const payload = {
    token,
    sheetName,   // optional hint (Ï„Î¿ script Ï„Î¿ Î±Î³Î½Î¿ÎµÎ¯ Î±Î½ Î´ÎµÎ½ Ï„Î¿ Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÎ¹ - harmless)
    records: queue.splice(0, queue.length)
  };

  // Fire-and-forget to avoid CORS blocking on GitHub Pages
  fetch(gasUrl, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  }).catch(()=>{});
}

setInterval(flushQueue, 12000);

/* =================== Openâ€‘Meteo fetch & metrics =================== */
function buildOpenMeteoUrl(lat, lon){
  const params = new URLSearchParams({
    latitude: String(lat),
    longitude: String(lon),
    current: [
      "temperature_2m",
      "relative_humidity_2m",
      "precipitation",
      "rain",
      "showers",
      "snowfall",
      "pressure_msl",
      "cloud_cover",
      "wind_speed_10m",
      "wind_direction_10m",
      "wind_gusts_10m"
    ].join(","),
    timezone: "auto"
  });
  return "https://api.open-meteo.com/v1/forecast?" + params.toString();
}

function pickNumeric(obj){
  const out = {};
  if (!obj || typeof obj !== "object") return out;
  for (const [k,v] of Object.entries(obj)){
    if (typeof v === "number" && Number.isFinite(v)) out[k] = v;
  }
  return out;
}

async function fetchNow(){
  const s = STATIONS.find(x=>x.key === stationSel.value);
  const lat = Number(latEl.value);
  const lon = Number(lonEl.value);
  if(!Number.isFinite(lat) || !Number.isFinite(lon)){
    lastResEl.textContent = "lat/lon Î»Î¬Î¸Î¿Ï‚";
    return;
  }

  const url = buildOpenMeteoUrl(lat, lon);
  log("Fetch: " + url);

  try{
    const r = await fetch(url);
    const j = await r.json();

    const current = j.current || {};
    const current_units = j.current_units || {};
    const dateMs = current.time ? Date.parse(current.time) : Date.now();

    // metrics: ÎŸ,Ï„Î¹ Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÏŒ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿ "current"
    const metrics = pickNumeric(current);

    // meta: name + coords + units (Î¼Î¹ÎºÏÏŒ)
    const meta = {
      stationKey: s ? s.key : stationSel.value,
      name: s ? s.name : stationSel.options[stationSel.selectedIndex].textContent,
      lat, lon,
      source: "open-meteo",
      units: current_units
    };

    // UI
    currentBox.textContent = JSON.stringify({ time: current.time || null, metrics }, null, 2);
    lastTsEl.textContent = current.time ? current.time : new Date(dateMs).toISOString();
    lastResEl.textContent = "OK (" + Object.keys(metrics).length + " metrics)";

    // enqueue for sheet
    enqueueRecord({
      stationKey: meta.stationKey,
      dateMs,
      metrics,
      meta
    });

  } catch(err){
    lastResEl.textContent = "ERROR";
    log("Fetch error: " + err.message);
  }
}

/* =================== Recent from Sheet (doGet recent) =================== */
async function loadRecent(){
  const sKey = stationSel.value;
  const limit = 60; // records (Î³ÏÎ±Î¼Î¼Î­Ï‚)
  try{
    const data = await gasGetJSONP({ action:"recent", stationKey: sKey, limit: String(limit) });
    if(!data || data.ok !== true){
      lastResEl.textContent = (data && data.error) ? data.error : "read failed";
      log("Recent error: " + JSON.stringify(data));
      return;
    }

    // Group last records by metric
    const byMetric = {};
    for (const rec of (data.samples || [])){
      const m = rec.metric || "unknown";
      if(!byMetric[m]) byMetric[m] = [];
      byMetric[m].push({ t: rec.dateMs, v: rec.value });
    }

    // show summary
    const summary = {};
    Object.keys(byMetric).sort().forEach(m=>{
      const arr = byMetric[m];
      const last = arr[arr.length-1];
      summary[m] = { count: arr.length, last: last ? last.v : null };
    });

    currentBox.textContent = JSON.stringify({ stationKey: sKey, metrics: summary }, null, 2);
    lastResEl.textContent = "RECENT OK (" + (data.samples||[]).length + " rows)";
    log("Recent loaded: " + (data.samples||[]).length + " rows");
  } catch(err){
    lastResEl.textContent = "RECENT ERROR";
    log("Recent exception: " + err.message);
  }
}

/* =================== Ping =================== */
async function ping(){
  setStatus("warn", "Sheet Sync: Î­Î»ÎµÎ³Ï‡Î¿Ï‚â€¦");
  try{
    const data = await gasGetJSONP({ action:"ping" });
    if (data && data.ok === true){
      setStatus("ok", "Sheet Sync: OK (authorized)");
      log("Ping OK");
    } else {
      setStatus("bad", "Sheet Sync: " + ((data && data.error) ? data.error : "fail"));
      log("Ping fail: " + JSON.stringify(data));
    }
  } catch(err){
    setStatus("bad", "Sheet Sync: ping error");
    log("Ping error: " + err.message);
  }
}

/* =================== Events =================== */
$("btnSave").addEventListener("click", ()=>{
  saveCfg();
  log("Config saved");
});
$("btnClearCfg").addEventListener("click", ()=>{
  clearCfg();
  setStatus("", "Sheet Sync: ÏŒÏ‡Î¹ ÎµÎ»ÎµÎ³Î¼Î­Î½Î¿");
  log("Config cleared");
});
$("btnPing").addEventListener("click", ping);

$("btnOpenSheet").addEventListener("click", ()=>{
  // Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¸Î± Î­Ï‡ÎµÎ¹ Î®Î´Î· Î±Î½Î¿Î¯Î¾ÎµÎ¹ Ï„Î¿ sheet, Î±Ï€Î»Î¬ Î±Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ Î½Î­Î¿ tab ÏƒÏ„Î¿ drive root Ï‰Ï‚ shortcut
  window.open("https://docs.google.com/spreadsheets/u/0/", "_blank");
});

stationSel.addEventListener("change", applyStation);
$("btnFetch").addEventListener("click", fetchNow);
$("btnRecent").addEventListener("click", loadRecent);

$("btnCopyLog").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText(logBox.textContent || "");
    log("Log copied");
  }catch(_){
    log("Copy failed (clipboard permission)");
  }
});
$("btnClearLog").addEventListener("click", ()=>{ logBox.textContent=""; });

/* =================== Boot =================== */
(function init(){
  loadCfg();
  fillStations();
  setStatus("", "Sheet Sync: ÏŒÏ‡Î¹ ÎµÎ»ÎµÎ³Î¼Î­Î½Î¿");
  log("Ready. (Tip: Ï€Î¬Ï„Î± Ping Ï€ÏÏÏ„Î±)");
})();
</script>
</body>
</html>
