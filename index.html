<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nireas Geo Data Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Ο Χάρτης πιάνει όλη την οθόνη */
        #map { height: 100%; width: 100%; }

        /* Loading Overlay Style */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status-text">Σύνδεση με GitHub & Φόρτωση δεδομένων...</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- ΡΥΘΜΙΣΕΙΣ GITHUB ---
        const CONFIG = {
            username: 'petrsanidas-ui',
            repo: 'nireas',
            branch: 'main'
        };

        // --- ΑΡΧΙΚΟΠΟΙΗΣΗ ΧΑΡΤΗ ---
        // Κεντράρισμα στην Αττική (περίπου στο Χαλάνδρι βάσει των αρχείων)
        const map = L.map('map').setView([38.02, 23.80], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Δημιουργία Layer Groups για να τα ανοιγοκλείνουμε
        const layers = {
            basins: L.layerGroup().addTo(map),
            boundaries: L.layerGroup().addTo(map),
            streams: L.layerGroup().addTo(map)
        };

        // Προσθήκη Layer Control (πάνω δεξιά)
        L.control.layers(null, {
            "Λεκάνες (Basins)": layers.basins,
            "Όρια (Boundaries)": layers.boundaries,
            "Ρέματα (Streams)": layers.streams
        }).addTo(map);

        // --- URLS ---
        const API_TREE_URL = `https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/git/trees/${CONFIG.branch}?recursive=1`;
        const BASE_RAW_URL = `https://raw.githubusercontent.com/${CONFIG.username}/${CONFIG.repo}/${CONFIG.branch}/`;

        // --- MAIN LOGIC ---
        async function init() {
            try {
                // 1. Λήψη λίστας αρχείων από GitHub API
                const response = await fetch(API_TREE_URL);
                const data = await response.json();

                if (data.message) throw new Error(data.message);

                // 2. Φιλτράρισμα και κατηγοριοποίηση αρχείων
                const filesToFetch = {
                    basins: [],
                    boundaries: [],
                    streams: [],
                    meteo: [] // Τα txt αρχεία
                };

                data.tree.forEach(file => {
                    if (file.type !== 'blob') return; // Αγνοούμε φακέλους
                    
                    const p = file.path;

                    if (p.includes('data/basins/') && p.endsWith('.geojson')) {
                        filesToFetch.basins.push(p);
                    } else if (p.includes('data/boundaries/') && p.endsWith('.geojson')) {
                        filesToFetch.boundaries.push(p);
                    } else if (p.includes('data/streams/') && p.endsWith('.geojson')) {
                        filesToFetch.streams.push(p);
                    } else if (p.includes('meteostations') && p.endsWith('.txt')) {
                        filesToFetch.meteo.push(p);
                    }
                });

                updateStatus(`Βρέθηκαν: ${filesToFetch.basins.length} λεκάνες, ${filesToFetch.streams.length} ρέματα...`);

                // 3. Φόρτωση και προσθήκη στον χάρτη
                
                // >> Basins
                await loadCategory(filesToFetch.basins, layers.basins, {
                    style: { color: 'green', weight: 1, fillOpacity: 0.2 },
                    name: 'Basin'
                });

                // >> Boundaries
                await loadCategory(filesToFetch.boundaries, layers.boundaries, {
                    style: { color: 'red', weight: 2, dashArray: '5, 5', fill: false },
                    name: 'Boundary'
                });

                // >> Streams
                await loadCategory(filesToFetch.streams, layers.streams, {
                    style: { color: 'blue', weight: 3 },
                    name: 'Stream'
                });

                // >> Meteo Data (Txt) - Απλά τα τυπώνουμε στην κονσόλα προς το παρόν
                //    καθώς δεν είναι γεωχωρικά δεδομένα (geojson) για να μπουν στον χάρτη άμεσα.
                if (filesToFetch.meteo.length > 0) {
                    console.log("Meteo Text Files found:", filesToFetch.meteo);
                    // Εδώ θα μπορούσες να διαβάσεις τα txt και να τα δείξεις σε ένα sidebar
                }

                // Τέλος
                document.getElementById('loader').style.display = 'none';

            } catch (error) {
                console.error(error);
                document.getElementById('status-text').innerText = `Σφάλμα: ${error.message}`;
                document.querySelector('.spinner').style.borderColor = 'red';
            }
        }

        // Συνάρτηση βοηθός για φόρτωση μιας κατηγορίας αρχείων
        async function loadCategory(filePaths, layerGroup, options) {
            const promises = filePaths.map(path => 
                fetch(BASE_RAW_URL + path)
                    .then(res => res.json())
                    .then(geojsonData => {
                        // Προσθήκη στο GeoJSON layer
                        L.geoJSON(geojsonData, {
                            style: options.style,
                            onEachFeature: (feature, layer) => {
                                // Popup με πληροφορίες αν υπάρχουν
                                let popupContent = `<strong>${options.name}</strong><br>`;
                                if (feature.properties && feature.properties.name) {
                                    popupContent += feature.properties.name;
                                } else {
                                    popupContent += path.split('/').pop(); // Όνομα αρχείου
                                }
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(layerGroup);
                    })
                    .catch(err => console.error(`Error loading ${path}:`, err))
            );
            
            await Promise.all(promises);
        }

        function updateStatus(text) {
            document.getElementById('status-text').innerText = text;
        }

        // Εκκίνηση
        window.onload = init;
    </script>
</body>
</html>
