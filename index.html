
<!doctype html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIREAS</title>

  <link rel="icon" type="image/png" href="nireas_logo.png" />
<!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#eef2f5;
      --panel:#ffffff;
      --ink:#2c3e50;
      --muted:#6b7a86;
      --line:#d6dde4;
      --hdr:#2c3e50;

      --btn-blue:#2980b9;
      --btn-green:#27ae60;
      --btn-gray:#7f8c8d;
      --btn-yellow:#f1c40f;

      --danger:#c0392b;
      --warn:#d35400;
      --ok:#27ae60;

      --shadow:0 10px 24px rgba(0,0,0,.12);
      --radius:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --topbar-h:44px;
      --topbar-pad-x:12px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
    }

    /* ====== Layout (side-by-side, no overlap) ====== */
    .app-shell{
      display:flex;
      gap:14px;
      padding:14px;
      align-items:flex-start;
    }
    @media (max-width: 1100px){
      .app-shell{flex-direction:column}
    }

    .side-panel{
      width:390px;
      max-width:100%;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }
    .main-panel{
      flex:1;
      min-width:380px;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    /* ====== Panel headers & collapsibles ====== */
    .panel-topbar{
      background:var(--hdr);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 var(--topbar-pad-x);
      height:var(--topbar-h);
      box-sizing:border-box;
      font-weight:700;
      font-size:14px;
      border-bottom:1px solid rgba(255,255,255,.14);
    }
    .icon-btn{
      border:none;
      background:rgba(255,255,255,.14);
      color:currentColor; /* inherits from parent (white on dark topbar, dark on light headers) */
      width:30px;height:26px;
      border-radius:6px;
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }
    .icon-btn:hover{background:rgba(255,255,255,.22)} 

    /* Make collapse/minimize buttons visible on light section headers */
    .section-hdr .icon-btn{
      background:rgba(44,62,80,.10);
      border:1px solid rgba(0,0,0,.10);
    }
    .section-hdr .icon-btn:hover{background:rgba(44,62,80,.16)}
    .section{
      border-top:1px solid rgba(255,255,255,.08);
    }
    .section-hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:nowrap;
      padding:10px 12px;
      border-top:1px solid var(--line);
      background:#f7f9fb;
      font-weight:800;
      color:var(--ink);
    }
    .section-hdr .hdr-left{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .section-hdr .hdr-right{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      flex:0 0 auto;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .section-body{
      padding:10px 12px;
    }
    .collapsed{display:none!important}

    /* ====== Buttons ====== */
    .mini-btn{
      border:none;
      border-radius:4px;
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      color:#fff;
      font-weight:800;
      line-height:1.1;
      user-select:none;
    }
    .btn-load{background:var(--btn-blue)}
    .btn-map{background:var(--btn-green)}
    .btn-gray{background:var(--btn-gray)}
    .btn-on{background:var(--btn-green)}
    .btn-off{background:var(--btn-gray)}
    .btn-warn{background:var(--btn-yellow); color:#1f2a33}

    /* Station monitor button states */
    .btn-auto-default{background:var(--btn-blue)}
    .btn-auto-live{background:var(--btn-green)}
    .btn-live-off{background:var(--danger)}
    .btn-live-on{background:var(--btn-green)}
    .temp-green{background:var(--btn-green)!important}

    /* Data panel above Monitor (scenario + live + AI etc.) */
    .data-panel{margin:0}
    .data-box{margin-bottom:10px}
    .data-hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
    }
    .data-panel-body{ margin-top:6px; }

    .data-title{font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .data-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .data-actions::-webkit-scrollbar{height:6px}
    .data-actions::-webkit-scrollbar-thumb{background:rgba(0,0,0,.22);border-radius:6px}

    /* Monitor title row */
    .monitor-head{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin-bottom:8px;
    }
    .monitor-head h3{white-space:nowrap}

    /* ===== Monitor panel (collapse entire Monitor) ===== */
    .monitor-panel-summary{
      font-size:13px;
      font-weight:900;
      color:var(--ink);
      margin:0 0 8px 0;
      list-style-position: inside;
    }
    #monitorPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    /* Keep the Data panel header the exact same height when collapsed */
    #dataPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    .monitor-panel-body{margin-top:0}

/* Parameters (Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹) â€” header row aligned like the other section headers */
.param-summary{
  /* Native disclosure triangle like Monitor; keep marker visible */
  list-style-position: inside;
  position: relative;
  padding-right: 44px; /* space for reset button */
}
.param-summary .param-title{
  display:inline-block;
}
.param-summary .param-reset-btn{
  position:absolute;
  right:0;
  top:50%;
  transform:translateY(-50%);
}
.param-caret{
  width:30px;
  height:26px;
  border-radius:6px;
  background:rgba(44,62,80,.10);
  border:1px solid rgba(0,0,0,.10);
  color:#1f2a33;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  line-height:1;
  flex:0 0 auto;
  transition:transform .15s ease;
}
.param-reset-btn{
  border:1px solid rgba(0,0,0,.10);
  background:rgba(44,62,80,.10);
  color:#1f2a33;
  width:30px;
  height:26px;
  border-radius:6px;
  cursor:pointer;
  font-weight:900;
  line-height:1;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.param-reset-btn:hover{background:rgba(44,62,80,.16)}

    /* Coâ€‘Hazards panel (collapsible like Monitor/Data) */
    #coHazardsPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    /* Admin boundaries panel (collapsible like Monitor/Data) */
    #boundariesPanelDetails:not([open]) .monitor-panel-summary{margin-bottom:0}
    .cohazards-panel-body{margin-top:0}
    .cohazards-panel-inner{
      margin-top:6px;
      padding:8px 10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
    }



    /* Coâ€‘Hazards contextual box inside Scenario panels */
    .cohazards-context-box{margin:10px 0 12px 0}
    /* Scenario contextual Coâ€‘Hazards collapsible (like DB History) */
    
    /* Scenario CoHazards (inside Scenario) â€” match DB collapse look */
    .scenario-cohazards-details > summary{
      cursor:pointer;
      margin-bottom:6px;
      /* keep native â–¶/â–¼ marker; avoid absolute layouts that break alignment */
      padding-right:0;
    }
    .scenario-cohazards-details > summary .cohazards-badges{
      position:static;
      margin-right:6px;
    }

.cohazards-context-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cohazards-context-title{font-weight:900;color:#1f2a33}
/* ===== Coâ€‘Hazards (secondary hazards) ===== */
    /* Standardize Coâ€‘Hazards buttons to match header controls (same size/radius) */
    .cohazards{
      display:flex;
      gap:6px;
      align-items:center;
      margin-left:6px;
      flex:0 0 auto
    }
    .cohazards .cohz{
      background:#ffffff;
      border:1px solid #cfe0ea;
      color:#1f2a33;
      font-weight:800;
      padding:6px 12px;      /* match .hdr-btn */
      border-radius:6px;     /* match .hdr-btn */
      line-height:1;
      font-size:12px;        /* match .hdr-btn */
      white-space:nowrap;
    }
    .cohazards .cohz:hover{filter:brightness(0.98)}
    .cohazards .cohz:disabled{opacity:0.45;cursor:not-allowed}
/* Active (ON) state â€“ green outline + hazardâ€‘coded colors (clear selection) */
.cohazards .cohz.cohz-on{
  color:#1f2a33;
  box-shadow:0 0 0 3px var(--btn-green);  /* green outline */
  position:relative;
  z-index:1;
}
/* Color meaning:
   - Î’ÏÎ¿Ï‡Î®: Î¼Ï€Î»Îµ
   - Î†Î½ÎµÎ¼Î¿Ï‚: Î¿Ï…Î´Î­Ï„ÎµÏÎ¿/Î³ÎºÏÎ¹
   - ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚: Ï€Î¿ÏÏ„Î¿ÎºÎ±Î»Î¯/ÎºÏŒÎºÎºÎ¹Î½Î¿
   - Î Î±Î³ÎµÏ„ÏŒÏ‚/Î§Î¹ÏŒÎ½Î¹: Î³Î±Î»Î¬Î¶Î¹Î¿
*/
.cohazards .cohz-rain.cohz-on{background:#e7f6ff;border-color:#b6e6ff}
.cohazards .cohz-wind.cohz-on{background:#f3f5f7;border-color:#d6dde4}
.cohazards .cohz-heatwave.cohz-on{background:#fff1e6;border-color:#ffd1a6}
.cohazards .cohz-frost_snow.cohz-on{background:#eef6ff;border-color:#cfe3ff}

    /* Global summary box */
    .cohazards-global{margin-top:0;background:transparent;border:0;padding:0}
    .cohazards-global-head{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:6px}
    .cohazards-global-title{font-weight:900;color:#1f2a33}
    .cohazards-badges{display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end}
    .cohazards-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border:1px solid #dfe7ee;
      border-radius:999px;
      background:#f8fbff;
      font-weight:800;
      color:#24323d;
      font-size:12px
    }
    .cohazards-badge.cohz-badge-rain{background:#e7f6ff;border-color:#b6e6ff}
.cohazards-badge.cohz-badge-wind{background:#f3f5f7;border-color:#d6dde4}
.cohazards-badge.cohz-badge-heatwave{background:#fff1e6;border-color:#ffd1a6}
.cohazards-badge.cohz-badge-frost_snow{background:#eef6ff;border-color:#cfe3ff}

    .cohazards-metrics{font-size:13px;color:#1f2a33}
    .cohazards-metrics ul{margin:6px 0 0 18px}
    .cohazards-note{margin-top:6px;font-size:11px;color:#6b7a86}

    /* ===== Monitor section titles & freshness indicator ===== */
    .monitor-section-title{
      font-size:11px;
      font-weight:800;
      color:var(--ink);
      letter-spacing:0.2px;
      list-style-position: inside;
    }

    /* ===== DB History (Firestore) ===== */
    .db-controls{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      margin:8px 0 6px;
    }
    .db-limit{
      width:78px;
      height:28px;
      border:1px solid #d6dde4;
      border-radius:10px;
      padding:0 8px;
      font-weight:900;
      background:#fff;
    }
    .db-status{
      font-size:11px;
      color:#6b7a86;
      font-weight:900;
      margin-left:auto;
    }
    .db-table-wrap{
      border:1px solid #dfe7ee;
      border-radius:12px;
      overflow:auto;
      max-height:240px;
      background:#fff;
    }
    .db-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .db-table th,.db-table td{
      padding:6px 8px;
      border-bottom:1px solid #eef2f6;
      text-align:right;
      white-space:nowrap;
    }
    .db-table th{
      background:#f7f9fb;
      color:#2c3e50;
      font-weight:900;
      position:sticky;
      top:0;
      z-index:1;
    }
    .db-table td:first-child,.db-table th:first-child{ text-align:left; }
    .db-table td.col-wind, .db-table th.col-wind{
      text-align:left;
      white-space:normal;
      min-width:140px;
    }

    /* DB filter row (Excel-like) */
    .db-filter-row th{
      background:#ffffff;
      position:sticky;
      top:28px;
      z-index:1;
      padding:4px 6px;
      border-bottom:1px solid #eef2f6;
      text-align:right;
      white-space:nowrap;
    }
    .db-filter-row th:first-child{ text-align:left; }
    .db-filter-row th.col-wind{ text-align:left; }
    .db-filter-row input,
    .db-filter-row select{
      width:100%;
      min-width:64px;
      height:24px;
      border:1px solid #d6dde4;
      border-radius:8px;
      padding:0 6px;
      font-size:11px;
      font-weight:700;
      background:#fff;
      color:#2c3e50;
      box-sizing:border-box;
    }
    .db-icon-btn{
      border:1px solid #d6dde4;
      background:#fff;
      border-radius:8px;
      width:26px;
      height:24px;
      cursor:pointer;
      font-weight:900;
      line-height:22px;
      padding:0;
    }
    .db-icon-btn:hover{ background:#f7f9fb; }
    .db-col-icon{ text-align:center !important; }


    .latest-ts{
      margin-left:10px;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      white-space:nowrap;
    }
    #stationName.age-fresh{ color:#1b8f3a; font-weight:800; }
    #stationName.age-warn{  color:#b58900; font-weight:800; }
    #stationName.age-stale{ color:#b00020; font-weight:800; }
    #stationName.age-unknown{ color:var(--ink); font-weight:700; }
    .multi-name.age-fresh{ color:#1b8f3a; font-weight:800; }
    .multi-name.age-warn{  color:#b58900; font-weight:800; }
    .multi-name.age-stale{ color:#b00020; font-weight:800; }
    .multi-name.age-unknown{ color:var(--ink); font-weight:700; }

    .monitor-controls{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:nowrap;        /* keep buttons/select in one row */
      flex:0 0 auto
    }
    .hdr-btn{padding:6px 12px;font-size:12px;border-radius:6px; white-space:nowrap}
    /* Make <select> look like button */
    select.mini-btn{
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      padding-right:28px;
      background-image: linear-gradient(45deg, transparent 50%, rgba(255,255,255,.95) 50%),
                        linear-gradient(135deg, rgba(255,255,255,.95) 50%, transparent 50%);
      background-position: calc(100% - 14px) calc(50% - 2px), calc(100% - 9px) calc(50% - 2px);
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }
    
    /* Keep dropdown list neutral (not green) even when the select itself becomes active */
    select.mini-btn option{
      background: var(--btn-gray);
      color:#fff;
    }
.btn-scenario{background:var(--btn-gray); color:#fff}
    .btn-scenario.scenario-active{background:var(--btn-green); color:#fff; border-color:rgba(0,0,0,.12)}
.btn-local-off{background:var(--danger)}
    .btn-local-on{background:var(--btn-green)}
.btn-ai{background:#4b57c2}
#btnAIAnalysis{display:inline-flex;align-items:center}

/* AI provider toggle (ChatGPT / Gemini) */

/* AI provider dropdown (AI: ChatGPT/Gemini) */
.ai-dd{
  display:flex;
  align-items:center;
  flex:0 0 auto;
}
.ai-select{
  flex:0 0 auto;
  min-width:132px;
  padding:5px 10px;
  padding-right:28px; /* keep room for the arrow */
  font-size:11px;
  color:#fff;
  border:1px solid rgba(255,255,255,.35);
  border-radius:10px;
  background-color:#111827; /* default ChatGPT */
}
.ai-select.ai-gemini{
  background-color:#6d28d9;
}
/* keep arrow visible on colored background */
.ai-select{
  background-clip: padding-box;
}
.ai-target{
  display:flex;
  align-items:center;
  flex:0 0 auto;
  border:1px solid rgba(255,255,255,.35);
  border-radius:10px;
  overflow:hidden;
  background:rgba(0,0,0,.10);
}
.ai-label{
  flex:0 0 auto;
  padding:6px 8px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.4px;
  color:#fff;
  background:rgba(0,0,0,.22);
  line-height:1;
  user-select:none;
}
.ai-pill{
  flex:0 0 auto;              /* prevent shrinking/truncation */
  border:none;
  background:rgba(255,255,255,.14);
  color:#fff;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
  line-height:1;
  white-space:nowrap;
}
.ai-pill + .ai-pill{border-left:1px solid rgba(255,255,255,.22)}
.ai-label + .ai-pill{border-left:1px solid rgba(255,255,255,.22)}
.ai-pill[data-ai="chatgpt"].active{background:#111827}
.ai-pill[data-ai="gemini"].active{background:#6d28d9}
.ai-pill.active{box-shadow:inset 0 0 0 1px rgba(255,255,255,.35); opacity:1; border-bottom:2px solid rgba(255,255,255,.75)}
.ai-pill:not(.active){opacity:.82}
.ai-pill:hover{filter:brightness(.97)}
.ai-pill:active{transform:translateY(1px)}
.ai-pill:focus-visible{outline:2px solid rgba(255,255,255,.65); outline-offset:-2px}
/* subtle horizontal scrollbar for monitor header (only if needed) */
.monitor-head::-webkit-scrollbar{height:6px}
.monitor-head::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:10px}
.monitor-head::-webkit-scrollbar-track{background:transparent}

/* Station time-series list */
.series-list{margin-top:6px;border:1px solid #dfe7ee;border-radius:10px;padding:6px;background:#fff;max-height:160px;overflow:auto;font-size:11px}
.series-row{display:flex;align-items:baseline;justify-content:space-between;gap:8px;padding:4px 0;border-bottom:1px dashed #e6eef5}
.series-row:last-child{border-bottom:none}
.series-ts{color:var(--muted);min-width:125px}
.series-val{font-weight:700;white-space:nowrap}
.series-dp{color:var(--muted);white-space:nowrap}

    .mini-btn:hover{filter:brightness(.95)}
    .mini-btn:active{transform:translateY(1px)}

    /* ====== Side table ====== */
    table{border-collapse:collapse;width:100%}
    th,td{padding:6px;border-bottom:1px solid #e9eef3;text-align:center;font-size:12px}
    th{background:#34495e;color:#fff;font-size:12px}
    .cat-row td{
      background:#f3f6f8;
      font-weight:900;
      text-align:left;
      padding:7px 10px;
      border-bottom:1px solid #dfe7ee;
    }
    .type-cell{
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      letter-spacing:.06em;
      font-family:var(--mono);
      white-space:nowrap;
      opacity:.95;
    }

    /* Keep each file row on a single line (Name | Actions) */
    #filesBody{ overflow-x:auto; }  /* fallback on very narrow screens */
    #filesBody{ overflow-x:auto; }  /* fallback on very narrow screens */
    #filesBody table{ table-layout:fixed; }
    #filesBody th:nth-child(1), #filesBody td:nth-child(1){ width:68%; text-align:left; }
    #filesBody th:nth-child(2), #filesBody td:nth-child(2){ width:32%; text-align:right; padding-right:10px; }
    #filesBody td:nth-child(1){ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    #filesBody th, #filesBody td{ vertical-align:middle; }

    #filesBody .actions-row{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:nowrap;
      white-space:nowrap;
    }
    #filesBody .actions-row .mini-btn{ padding:4px 8px; font-size:11px; }

    .hint{
      font-size:10px;
      color:var(--muted);
      padding:10px 12px;
      border-top:1px solid var(--line);
    }

    /* ====== Main tool ====== */
    .tool-wrap{padding:12px 0 0 0}
    .tool-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 var(--topbar-pad-x);
      height:var(--topbar-h);
      box-sizing:border-box;
      border-bottom:1px solid var(--line);
      background:#fbfcfe;
    }
    .tool-header h1{
      margin:0;
      font-size:14px;
      line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .print-btn{
      border:none;
      background:#2c3e50;
      color:#fff;
      border-radius:6px;
      padding:7px 10px;
      font-size:12px;
      cursor:pointer;
      font-weight:800;
    }
    .print-btn:hover{filter:brightness(.95)}

    .sel-basin{
      margin:10px 0 0 0;
      font-size:12px;
      color:#2c3e50;
      font-weight:800;
    }
    .sel-basin span{
      font-weight:900;
      color:#d35400;
    }

    .grid-2{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .grid-2{grid-template-columns:1fr}
    }

    .box{
      border:1px solid #dfe7ee;
      background:#fff;
      border-radius:10px;
      padding:10px;
    }
    .top-panel-box{margin:0 0 10px 0}

    .box h3{
      margin:0 0 8px 0;
      font-size:13px;
      font-weight:900;
    }
    .row{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:8px;
      align-items:center;
      margin:6px 0;
    }
    .row label{
      font-size:12px;
      color:#2c3e50;
      font-weight:800;
    }
    input,select{
      width:100%;
      font-size:12px;
      padding:6px 8px;
      border:1px solid #d6dde4;
      border-radius:6px;
      outline:none;
      background:#fff;
    }

    .panels-row{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 1150px){
      .panels-row{grid-template-columns:1fr}
    }

    canvas{
      width:100%;
      border:1px dashed #cfd8e3;
      border-radius:8px;
      background:#fff;
    }

    .summary-box{
      display:grid;
      grid-template-columns:repeat(6, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 1150px){
      .summary-box{grid-template-columns:repeat(2,1fr)}
    }
    
    /* ===== Scenario-based panels (Rain / Wind / Heatwave / Frost) ===== */
    .scenario-panel{display:none;}
    .scenario-panel.active{display:block;}
    .ro{
      font-weight:800;
      color:var(--ink);
      padding:4px 0;
      user-select:text;
    }
    .ops-list{
      font-size:12px;
      color:#243342;
      line-height:1.35;
    }
    .ops-list ul{margin:6px 0 0 18px; padding:0;}
    .ops-list li{margin:3px 0;}
    .stat{
      border:1px solid #e6edf3;
      background:#fbfdff;
      border-radius:10px;
      padding:8px;
      text-align:center;
    }
    .stat .k{font-size:11px;color:#6b7a86;font-weight:800}
    .stat .v{font-size:14px;font-weight:900;margin-top:4px}

    .status-ok{color:var(--ok);font-weight:900}
    .status-warn{color:var(--warn);font-weight:900}
    .status-fail{color:var(--danger);font-weight:900}

    /* Scenario table + risk colors */
    .table-wrap{
      margin-top:12px;
      border:1px solid #e6edf3;
      border-radius:10px;
      overflow:hidden;
    }
    .table-wrap table{width:100%}
    .table-wrap th{background:#34495e}
    .risk-safe{background:#eafaf1}
    .risk-warn{background:#fff7e6}
    .risk-orange{background:#ffe9d6}
    .risk-red{background:#ffe0e0}
    .risk-extreme{background:#ffd1d1}

    .footer-grid{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .footer-grid{grid-template-columns:1fr}
    }
    .legend{
      border:1px solid #e6edf3;
      border-radius:10px;
      padding:10px;
      background:#fff;
    }
    .legend h4{margin:0 0 8px 0;font-size:12px;font-weight:900}
    .legend .item{
      display:flex;
      align-items:center;
      gap:8px;
      margin:6px 0;
      font-size:12px;
      font-weight:800;
      color:#2c3e50;
    }
    .swatch{
      width:18px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.12);
    }

    .station-mini{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 900px){
      .station-mini{grid-template-columns:1fr}
    }
    .station-card{
      border:1px solid #e6edf3;
      border-radius:10px;
      padding:8px;
      background:#fbfdff;
    }
    .station-card .t{font-size:11px;color:#6b7a86;font-weight:900}
    .station-card .v{font-size:14px;font-weight:900;margin-top:3px}
    .station-actions{
      display:flex;
      gap:8px;
      margin-top:8px;
      flex-wrap:wrap;
    }

    /* ====== Map modal ====== */
    #mapModal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    #mapCard{
      width:min(1100px, 96vw);
      height:min(700px, 88vh);
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
    }
    #mapTop{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#fbfcfe;
      font-weight:900;
    }
    #mapBox{flex:1}

    /* ====== Loader ====== */
    #loader{
      display:none;
      font-size:12px;
      color:var(--muted);
      padding:8px 12px;
      border-top:1px solid var(--line);
    }

    /* ====== Print ====== */
    @media print{
      body{background:#fff}
      .side-panel{display:none!important}
      .app-shell{padding:0}
      .main-panel{box-shadow:none;border:none;border-radius:0}
      #mapModal{display:none!important}
      .no-print{display:none!important}
    }
  
  /* Watchlist chips + multi-station list */
  .chip{ display:inline-flex; align-items:center; gap:3px; padding:4px 8px; border-radius:999px; border:1px solid #cbd5e1; background:#ffffff; font-size:11px; cursor:pointer; }
  .chip b{ font-weight:600; }
  .chip button{ border:0; background:transparent; cursor:pointer; font-size:12px; line-height:1; color:#64748b; padding:0; }

  .chip.watch{ background:#fff7e6; border-color:#f1d27a; }
  .status-pill{ margin-top:8px; font-size:11px; font-weight:900; padding:7px 10px; border-radius:10px; border:1px solid #dfe7ee; background:#f8fafc; color:#475569; }
  .status-pill.status-ok{ background:#eafaf1; border-color:#bfe7cb; color:#1f7a3a; }
  .status-pill.status-warn{ background:#fff7e6; border-color:#f1d27a; color:#b35300; }
  .status-pill.status-neutral{ background:#f8fafc; border-color:#dfe7ee; color:#475569; }

  .meteo-msg{ display:none; font-size:10px; color:var(--muted); margin-top:4px; font-style:italic; }

  #primaryStatusWrap .status-pill, #meteoStatusWrap .status-pill{ margin-top:0; padding:6px 10px; }

  .multi-table{ width:100%; border:1px solid #cbd5e1; border-radius:10px; overflow:hidden; background:#fff; }
  .multi-row{
    padding:6px 8px;
    border-top:1px solid #e2e8f0;
    font-size:11px;
  }
  .multi-row:first-child{ border-top:0; }
  .multi-name{ min-width:0; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;  display:inline-block; max-width:260px; vertical-align:baseline;}
  .multi-ts{ justify-self:center; text-align:center; color:#64748b; font-variant-numeric: tabular-nums; white-space:nowrap; }
  .multi-spacer{ }

    /* Multi-station extra list: include latest values chips */
    .multi-block{ border-top:1px solid #e2e8f0; padding:6px 8px; }
    .multi-block:first-child{ border-top:0; }
    .multi-block .multi-row{ padding:0; border-top:0; }
    .multi-latest{ margin-top:4px; }

    /* Compact chips for extra stations */
    .latest-chips.multi{ gap:2px; padding:0 0 2px 0; }
    .latest-chips.multi .chip{
      height:66px;
      padding:3px 2px;
      border-radius:12px;
    }
    .latest-chips.multi .chip .el{ font-size:8.8px; height:20px; }
    .latest-chips.multi .chip .en{ font-size:8.2px; height:18px; }
    .latest-chips.multi .chip .val{ font-size:10px; height:18px; }

    /* ====== NIREAS brand/logo ====== */
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .nireas-logo{
      height:42px;
      width:auto;
      border-radius:10px;
      background:#fff;
      padding:2px;
      border:1px solid #dfe7ee;
      box-shadow:0 6px 14px rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .brand h1{
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

        /* Latest values chips (station monitor) */

    /* Station meta line (one-line header) */
    .station-meta-line{
      display:inline-flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:baseline;
      font-size:12px;
      margin:0;
    }
    .station-meta-line .meta-item{ white-space:nowrap; }
    .station-meta-line #stationName{ font-weight:800; }

    .station-meta-line .name-item{ display:inline-flex; align-items:center; gap:6px; }

    /* Collapsible: Primary station (triangle like other sections) */
    .station-summary{ font-size:11px; font-weight:400; color:var(--ink);
      list-style-position: inside;}
    #primaryStationDetails > summary::marker{ font-size:11px; }
    #dataPanelDetails > summary::marker{ font-size:13px; }



    /* Small icon buttons for station actions (open URL / refresh) */
    .meta-icon-btn{
      border:1px solid rgba(0,0,0,.08);
      background:rgba(44,62,80,.08);
      color:#1f2a33;
      width:24px;
      height:22px;
      border-radius:8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      vertical-align:middle;
      line-height:1;
      font-size:14px;
      padding:0;
    }
    
    /* Unified summary row with right-aligned actions (keeps native <summary> triangle) */
    .summary-flex{
      display:inline-flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:calc(100% - 1.6em);
      box-sizing:border-box;
    }
    .summary-flex .summary-left{
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .summary-flex .summary-left > *{min-width:0;}
    .summary-flex .summary-right{
      display:inline-flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    /* Reset icon inside summaries (use same visual language as meta-icon-btn) */
    .summary-reset-btn{
      border:1px solid rgba(0,0,0,.08);
      background:rgba(44,62,80,.08);
      color:#1f2a33;
      width:24px;
      height:22px;
      border-radius:8px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      vertical-align:middle;
      line-height:1;
      font-size:14px;
      padding:0;
    }
    .summary-reset-btn:hover{filter:brightness(0.98)}
.meta-icon-btn:hover{ background:rgba(44,62,80,.14); }
    .meta-icon-btn:disabled{ opacity:.6; cursor:default; }
    .meta-icon-btn.spinning{ animation: spin 0.9s linear infinite; }
    @keyframes spin{ from{ transform:rotate(0deg);} to{ transform:rotate(360deg);} }

    /* Extra stations: meta line */
    .multi-meta-line{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;           /* visual alignment with main station line */
      font-size:11px;
      line-height:1.2;
    }
    .multi-meta-line .meta-item{
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .multi-meta-line .meta-label{
      font-weight:800;
    }
    .multi-meta-line .multi-name{ font-weight:700; }
    .multi-meta-line .multi-ts{ color:#64748b; font-variant-numeric: tabular-nums; }
    .multi-meta-line .meta-val{ font-variant-numeric: tabular-nums; }
    .latest-row{
      margin-top:6px;
      font-size:11px;
      line-height:1.2;
      color:#1f2a33;
      display:flex;
      flex-direction:column;   /* label on top, chips below */
      align-items:stretch;
      gap:2px;
    }

    .latest-head{
      display:flex;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
    }
    .latest-head .latest-ts{ margin-left:0; }

    .latest-row > b{
      display:block;
      white-space:nowrap;
      padding-top:0;
      flex:0 0 auto;
    }

/* Fit ALL chips inside the frame (no horizontal scrollbar) */
    .latest-chips{
      width:100%;
      flex:1 1 auto;
      display:grid;
      grid-template-columns: repeat(var(--chip-count, 14), minmax(0, 1fr));
      gap:3px;
      overflow:hidden;          /* no scrollbar */
      padding:1px 0 3px 0;
      max-width:100%;
      align-items:stretch;
    }

    /* Symmetric chip layout: Greek (top) / English (middle) / Value (bottom) */
    .latest-chips .chip{
      min-width:0;
      height:78px;              /* fixed height so values align */
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:4px 3px;
      background:rgba(255,255,255,.92);
      border:1px solid #dfe7ee;
      border-radius:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
      text-align:center;
    }

    .latest-chips .chip .el,
    .latest-chips .chip .en,
    .latest-chips .chip .val{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 2px;
      word-break:break-word;
      hyphens:auto;
    }

    .latest-chips .chip .el{
      font-weight:900;
      font-size:9.6px;
      line-height:1.1;
      height:24px;              /* reserve space: keep symmetry */
    }
    .latest-chips .chip .en{
      font-weight:700;
      font-size:9.2px;
      line-height:1.1;
      height:20px;
      color:#6b7a86;
      margin-top:1px;
    }
    .latest-chips .chip .val{
      font-weight:900;
      font-size:11px;
      line-height:1.1;
      height:20px;
      font-variant-numeric:tabular-nums;
      margin-top:auto;          /* push value to bottom consistently */
      padding-bottom:1px;
    }

    /* De-emphasize empty/missing metrics while preserving alignment */
    .latest-chips .chip.empty{
      opacity:.55;
    }
    .latest-chips .chip.empty .val{
      font-weight:800;
    }

    /* Keep a hidden plain-text version (for copy/debug) */
    .latest-text{ display:none; }
    .nireas-text-logo{
      display:inline-block;
      font-weight:900;
      letter-spacing:.08em;
      font-size:12px;
      padding:4px 10px;
      border-radius:10px;
      background:rgba(255,255,255,.9);
      border:1px solid #dfe7ee;
      color:#0f172a;
    }

.status-stack{display:flex;flex-direction:column;gap:6px;margin-top:8px;}

/* ====== Header alignment fix (side + main top bars) ====== */
:root{
  --appHeaderH: 44px;
  --appHeaderPadY: 8px;
}
.panel-topbar,
.tool-header{
  min-height: var(--appHeaderH);
  padding-top: var(--appHeaderPadY);
  padding-bottom: var(--appHeaderPadY);
  align-items:center;
}
/* Prevent the logo <img> baseline gap from pushing the bar height */
.panel-topbar img.nireas-logo,
.tool-header img.nireas-logo{
  height: 22px !important;
  width: auto !important;
  padding: 1px !important;
  border-radius: 6px !important;
  display: block !important;
  box-shadow: none !important;
}
/* Keep title vertically centered without increasing bar height */
.tool-header h1{
  line-height: 1.15;
  margin: 0;
}

    /* ===== Meteo stations (selected only) markers ===== */
    .station-pin{width:14px;height:14px;border-radius:50%;background:#1e88e5;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.35);}
    .station-pin.primary{width:16px;height:16px;border-radius:2px;background:#e53935;transform:rotate(45deg);}
    .station-pin-wrap{display:flex;align-items:center;justify-content:center;}

    .scenario-area-body{margin-top:6px;}
</style>
</head>

<body>

<!--
===================== NIREAS (Readable copy) =====================
Î£Ï„ÏŒÏ‡Î¿Ï‚: ÎµÏ…ÎºÎ¿Î»ÏŒÏ„ÎµÏÎ· Ï€Î»Î¿Î®Î³Î·ÏƒÎ·/Î²ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚. Î¤Î¿ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Î¯Î´Î¹Î¿ (Î´ÎµÎ½ Î¬Î»Î»Î±Î¾Î±Î½ Î»Î¿Î³Î¹ÎºÎ­Ï‚/Ï„Î¹Î¼Î­Ï‚).

Î“ÏÎ®Î³Î¿ÏÎ· Ï€Î»Î¿Î®Î³Î·ÏƒÎ· (Ctrl+F):
  [LAYOUT/CSS]     :root  | .app-shell | .side-panel | .main-panel | .panel-topbar | .tool-header
  [LEFT PANEL]     id="sideBody" | id="meteoBody" | id="filesBody" | id="fileRows"
  [STATIONS/UI]    meteoStationSelect | monitorStationSelect | watchlist | stationMultiList
  [MAP]            mapModal | mapBox | openMapModal() | Leaflet (L.map)
  [CALC ENGINE]    runMasterCalculation() | kirpich | qpeak | qcap
  [LIVE]           toggleLive() | fetchStationData()
  [AI ANALYSIS]    initAIAnalysisUI() | buildAIPrompt() | btnAIAnalysis
  [FIREBASE LOG]   fbLogSample() | fbFetchRecentSamples() | fbFetchRecentSamplesAll()
  [DB READER]      dbTable | btnDbLoad | btnDbImport | btnDbExport | filters
===============================================================
-->



<div class="app-shell">

  <!-- ================= LEFT: GitHub Data panel ================= -->
  <aside class="side-panel">
    <div class="panel-topbar">
      <div style="display:flex;align-items:center;gap:10px;white-space:nowrap;">
  Î Î·Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ : <img class="nireas-logo" src="nireas_logo.png" alt="ÎÎ—Î¡Î•Î‘Î£" style="height:22px;padding:1px;border-radius:6px;" onerror="this.outerHTML='<span class=nireas-text-logo>NIREAS</span>'" />
</div>
      <button class="icon-btn" onclick="toggleCollapse('sideBody', this)">âˆ’</button>
    </div>

    <div id="sideBody">
      <div class="section">
        <div class="section-hdr">
          <div class="hdr-left">ğŸ“¡ÎœÎ•Î¤Î•Î©Î¡ÎŸÎ›ÎŸÎ“Î™ÎšÎŸÎ™ Î£Î¤Î‘Î˜ÎœÎŸÎ™</div>
          <div class="hdr-right">
            <button class="mini-btn btn-load" onclick="meteoStationsLoad()" title="Î¦ÏŒÏÏ„Ï‰ÏƒÎ· markers ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½ (cache)">Load</button>
            <button class="mini-btn btn-map" onclick="meteoStationsMap()" title="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· (zoom) Ï‡Ï‰ÏÎ¯Ï‚ Î±Î»Î»Î±Î³Î® On/Off">Map</button>
            <button id="btn-onoff-meteoStations" class="mini-btn btn-off" onclick="toggleMeteoStationsLayer()" title="On/Off markers ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Ï‰Î½ ÏƒÏ„Î±Î¸Î¼ÏÎ½">Off</button>
            <button class="icon-btn" style="width:28px;height:24px" onclick="toggleCollapse('meteoBody', this)">âˆ’</button>
          </div>
        </div>
        <div class="section-body" id="meteoBody">
                    <div style="font-size:11px;color:#6b7a86;margin-bottom:4px;">ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="meteoStationSelect" style="flex:1">
              <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>
            </select>
            <button class="mini-btn btn-on" onclick="setPrimaryStation()" title="ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï‰Ï‚ ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚ & Î¬Î¼ÎµÏƒÎ· Î»Î®ÏˆÎ·">â•</button>
            <button class="mini-btn btn-gray" onclick="clearPrimaryStation()" title="Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ§¹</button>
            <button class="mini-btn btn-map" onclick="openPrimaryWeb()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±">ğŸ”— Web</button>
          </div>

          <div id="primaryStatusWrap" class="status-stack" style="margin-top:2px;">
            <div id="primaryStatus" class="status-pill status-neutral">ÎšÏÏÎ¹Î¿Ï‚: Î‘Î½Î±Î¼Î¿Î½Î®â€¦</div>
          </div>

          <div style="font-size:11px;color:#6b7a86;margin:10px 0 4px;">Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· (Ï€Î¿Î»Î»Î±Ï€Î»Î¿Î¯ ÏƒÏ„Î±Î¸Î¼Î¿Î¯)</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="monitorStationSelect" style="flex:1">
              <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚...</option>
            </select>
            <button class="mini-btn btn-on" onclick="addToWatchlistFromMonitor()" title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î¿Ï…Ï‚ Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿ÏÏ‚ & Î¬Î¼ÎµÏƒÎ· Î»Î®ÏˆÎ·">â•</button>
            <button class="mini-btn btn-gray" onclick="clearWatchlist()" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚">ğŸ§¹</button>
            <button class="mini-btn btn-map" onclick="openMonitorWeb()" title="Î†Î½Î¿Î¹Î³Î¼Î± ÏƒÎµ Î½Î­Î± ÎºÎ±ÏÏ„Î­Î»Î±">ğŸ”— Web</button>
          </div>

          <div id="meteoStatusWrap" class="status-stack" style="margin-top:2px;">
            <div id="extrasStatus" class="status-pill status-neutral">Î•Ï€Î¹Ï€Î»Î­Î¿Î½: Î‘Î½Î±Î¼Î¿Î½Î®â€¦</div>
          </div>
          <div id="meteoMsg" class="meteo-msg" style="display:none"></div>

          <details class="no-print" style="margin-top:8px;">
            <summary style="cursor:pointer;font-size:11px;color:#6b7a86;">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· custom ÏƒÏ„Î±Î¸Î¼Î¿Ï (Î¼Îµ URL)</summary>
            <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; align-items:center;">
              <input id="customStationName" placeholder="ÎŒÎ½Î¿Î¼Î± (Ï€.Ï‡. Î§Î‘Î›Î‘ÎÎ”Î¡Î™)" style="flex:1; min-width:220px; padding:8px; border:1px solid #dfe7ee; border-radius:10px; font-size:12px;">
              <input id="customStationUrl" placeholder="URL (Openâ€‘Meteo API Î® penteli link)" style="flex:2; min-width:320px; padding:8px; border:1px solid #dfe7ee; border-radius:10px; font-size:12px;">
              <button class="mini-btn btn-on" onclick="addCustomStation()" title="Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· custom ÏƒÏ„Î±Î¸Î¼Î¿Ï">â•</button>
</div>
            <div id="customStationMsg" style="font-size:10px;color:#6b7a86;margin-top:6px;font-style:italic;">Î‘Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Ï„Î¿Ï€Î¹ÎºÎ¬ ÏƒÏ„Î¿Î½ browser.</div>
          </details>

          <div id="watchlistWrap" style="margin-top:6px;" class="no-print">
            <div id="watchlist" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
          </div>
          
          </div>
      </div>

      <div class="section">
        <div class="section-hdr">
          <div>ğŸ“ Î‘Î¡Î§Î•Î™Î‘ Î•Î¡Î“ÎŸÎ¥ (GEOJSON)</div>
          <button class="icon-btn" style="width:28px;height:24px" onclick="toggleCollapse('filesBody', this)">âˆ’</button>
        </div>

        <div class="section-body" id="filesBody" style="padding:0">
          <div id="loader">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Ï€ÏŒ GitHubâ€¦</div>
          <table>
            <thead>
              <tr>
                <th style="text-align:left;padding-left:10px;">ÎŒÎ½Î¿Î¼Î±</th>
                <th style="text-align:right;padding-right:10px;">Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
              </tr>
            </thead>
            <tbody id="fileRows"></tbody>
          </table>
        <div class="hint" id="filesHint">
        <b>Load</b> = Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÏ„Î¿ ÎºÏÏÎ¹Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ (Ï€.Ï‡. Î»ÎµÎºÎ¬Î½Î·).<br/>
        <b>Map</b> = Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· (zoom) <b>Ï‡Ï‰ÏÎ¯Ï‚</b> Î±Î»Î»Î±Î³Î® On/Off.<br/>
        <b>On/Off</b> = ÎµÎ¼Ï†Î±Î½Î¯Î¶ÎµÎ¹/ÎºÏÏÎ²ÎµÎ¹ layer (Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚).<br/>
      </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- ================= RIGHT: Î£ÏÏƒÏ„Î·Î¼Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎˆÎ³ÎºÎ±Î¹ÏÎ·Ï‚ Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (Monitoring & Early Warning System) ================= -->
  <main class="main-panel">
    <div class="tool-header">
      <div class="brand">
        <img class="nireas-logo" src="nireas_logo.png" alt="ÎÎ—Î¡Î•Î‘Î£" onerror="this.outerHTML='<span class=nireas-text-logo>NIREAS</span>'" />
        <h1>Î£ÏÏƒÏ„Î·Î¼Î± Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎˆÎ³ÎºÎ±Î¹ÏÎ·Ï‚ Î ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (Monitoring & Early Warning System)</h1>
      </div>
      <button class="print-btn no-print" onclick="window.print()">Î•ÎšÎ¤Î¥Î Î©Î£Î—</button>
    </div>

    <div class="tool-wrap">
      <div class="box data-box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
          <details id="dataPanelDetails" open style="margin:0;">
            <summary class="monitor-panel-summary param-summary" style="cursor:pointer;">
  <span class="param-title">Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</span>
  <button type="button" class="param-reset-btn no-print"
          title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÏ‰Î½ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚"
          onclick="event.preventDefault();event.stopPropagation();resetParametersToDefaults();">âŸ²</button>
</summary>
            <div class="data-panel-body">
              <div class="data-hdr">
                <div class="data-actions no-print">
              <select id="modelScenario" class="mini-btn hdr-btn btn-scenario" onchange="onScenarioChange(this)" title="Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…">
                <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…</option>
                <option value="wind">Î†Î½ÎµÎ¼Î¿Ï‚</option>
                <option value="rain">Î’ÏÎ¿Ï‡Î®</option>
                <option value="heatwave">ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</option>
                <option value="frost_snow">Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±</option>
              </select>
              <div id="coHazards" class="cohazards" title="Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Ï†Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Î´ÎµÏ…Ï„ÎµÏÎµÏÎ¿Î½Ï„Î±). Î”ÎµÎ½ Î±Î»Î»Î¬Î¶Î¿Ï…Î½ Ï„Î¿Ï…Ï‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚ Ï„Î¿Ï… ÎºÏÏÎ¹Î¿Ï… ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï….">
                <button type="button" class="mini-btn hdr-btn cohz cohz-wind" data-hz="wind" onclick="toggleCoHazard('wind')">+Î†Î½ÎµÎ¼Î¿Ï‚</button>
                <button type="button" class="mini-btn hdr-btn cohz cohz-rain" data-hz="rain" onclick="toggleCoHazard('rain')">+Î’ÏÎ¿Ï‡Î®</button>
                <button type="button" class="mini-btn hdr-btn cohz cohz-heatwave" data-hz="heatwave" onclick="toggleCoHazard('heatwave')">+ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</button>
                <button type="button" class="mini-btn hdr-btn cohz cohz-frost_snow" data-hz="frost_snow" onclick="toggleCoHazard('frost_snow')">+Î Î±Î³ÎµÏ„ÏŒÏ‚</button>
              </div>

              <button id="btnLiveStation" class="mini-btn hdr-btn btn-live-off" onclick="toggleLive()" title="Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Î±Î½Î­Ï‰ÏƒÎ· Î±Î½Î¬ 90s">Live OFF</button>
              <button id="btnLocalScenario" class="mini-btn hdr-btn btn-local-off" onclick="toggleLocalScenario()" title="Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÎ¿Ï ÏƒÎµÎ½Î±ÏÎ¯Î¿Ï…">Local Scenario OFF</button>
              <div id="aiTargetGroup" class="ai-dd" title="AI Ï€ÏÎ¿Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ (Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹)">
  <select id="aiProviderSelect" class="mini-btn hdr-btn ai-select ai-chatgpt"
          title="AI: ChatGPT/Gemini (Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹)"
          onchange="setAITarget(this.value)">
    <option value="chatgpt">AI: ChatGPT</option>
    <option value="gemini">AI: Gemini</option>
  </select>
</div>
<button id="btnAIAnalysis" class="mini-btn hdr-btn btn-ai" onclick="runAIAnalysis(event)" title="Î£Ï…Î»Î»Î¿Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ &amp; Î±Î½Î¬Î»Ï…ÏƒÎ· Î¼Îµ AI (Shift+Click = EXTRA FULL)">AI analysis</button>
              <input type="checkbox" id="localScenarioToggle" style="display:none" />
            
              </div>
              </div>
            </div>
          </details>
      </div>
</div>

      <div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">


          <details id="monitorPanelDetails" open style="margin:0;">
            <summary class="monitor-panel-summary" style="cursor:pointer;">
              ÎœÎµÏ„ÎµÏ‰ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚ (Monitor)
            </summary>
            <div class="monitor-panel-body">
                    <details id="primaryStationDetails" open style="margin:0;">
            <summary class="station-summary" id="stationSummary" style="cursor:pointer;margin-bottom:6px;">
              <span class="station-meta-line" id="stationMetaLine">
                <span class="meta-item name-item"><span id="stationName">â€”</span><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveUrl()" title="Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”—</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveMap()" title="Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·">ğŸ“</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();refreshPrimaryOnly(this)" title="Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï)">âŸ³</button><button class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetPrimaryStationQuick()" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï">âŸ²</button></span>
            <span class="meta-item"><b>Timestamp:</b> <span id="stationTimestampInline">â€”</span></span>
            <span class="meta-item"><b>LAT:</b> <span id="stationLat">â€”</span></span>
            <span class="meta-item"><b>LON:</b> <span id="stationLon">â€”</span></span>
            <span class="meta-item"><b>ELEV:</b> <span id="stationElev">â€”</span></span>
            <span style="display:none"><b>Timestamp:</b> <span id="stationTimestamp">â€”</span></span>
              </span>
            </summary>

            <div id="primaryStationContent">
<div id="stationLatestRow" class="latest-row">
            <div id="stationLatestChips" class="latest-chips">â€”</div>
            <span id="stationLatestValues" class="latest-text">â€”</span>
          </div>

          <div class="station-mini">
            <div class="station-card">
              <div class="t">Î’ÏÎ¿Ï‡Î® (mm/h)</div>
              <div class="v"><span id="stationRainRate">â€”</span></div>
            </div>
            <div class="station-card">
              <div class="t">Î”P (mm) <span id="stationTotalSrc" style="font-size:10px;color:#6b7a86"></span></div>
              <div class="v"><span id="stationDP">â€”</span></div>
            </div>
            <div class="station-card">
              <div class="t">R60 (mm)</div>
              <div class="v"><span id="stationR60">â€”</span></div>
            </div>
          </div>

          <div class="station-actions no-print">
            <button id="btnAutoStation" class="mini-btn btn-auto-default" onclick="applyAutoI()">Load</button>
            <button id="btnClearStation" class="mini-btn btn-gray" onclick="clearStationSeries()">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
          </div>
          <div id="stationMsg" style="font-size:10px;color:#6b7a86;margin-top:6px;font-style:italic;">â€”</div>
            </div>
          </details>

          <div id="stationMultiList" style="margin-top:10px; display:none;"></div>

          <details id="seriesDetails" open style="margin-top:10px;">
            <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;">
              <span>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï</span>
              <span id="seriesStationName" style="font-weight:800;color:#b03030;margin-left:6px;">â€”</span>
              <button id="btnSeriesOpenPrimary" class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveUrl()" title="Î†Î½Î¿Î¹Î³Î¼Î± URL ÏƒÏ„Î±Î¸Î¼Î¿Ï">ğŸ”—</button>
              <button id="btnSeriesMapPrimary" class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();openPrimaryActiveMap()" title="Î•ÏƒÏ„Î¯Î±ÏƒÎ· ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î·">ğŸ“</button>
              <button id="btnSeriesRefreshPrimary" class="meta-icon-btn no-print" onclick="event.preventDefault();event.stopPropagation();refreshPrimaryOnly(this)" title="Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ (Î¼ÏŒÎ½Î¿ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï)">âŸ³</button>
              <span style="margin-left:6px;"><b>Timestamp:</b> <span id="seriesTimestampInline">â€”</span></span>
              <span style="margin-left:6px;"><b>LAT:</b> <span id="seriesLat">â€”</span></span>
              <span style="margin-left:6px;"><b>LON:</b> <span id="seriesLon">â€”</span></span>
              <span style="margin-left:6px;"><b>ELEV:</b> <span id="seriesElev">â€”</span></span>
            </summary>
            <div class="db-controls no-print" id="seriesControls" style="margin:8px 0 10px">
  <span style="font-weight:700">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚:</span>
  <input id="seriesLimit" class="db-limit" type="number" value="50" min="1" max="500">
  <button id="btnSeriesLoad" class="mini-btn btn-gray" title="Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ N ÎµÎ³Î³ÏÎ±Ï†ÏÎ½ Î±Ï€ÏŒ DB ÎºÎ±Î¹ ÏƒÏ…Î³Ï‡ÏÎ½ÎµÏ…ÏƒÎ· ÏƒÏ„Î¿ monitoring">Load DB</button>
  <button id="btnSeriesExport" class="mini-btn btn-gray" title="Î•Î¾Î±Î³Ï‰Î³Î® CSV (Ï†Î¹Î»Ï„ÏÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î· Ï€ÏÎ¿Î²Î¿Î»Î®)">Export CSV</button>
  <button id="btnSeriesView" class="mini-btn btn-gray" title="Î•Î½Î±Î»Î»Î±Î³Î® Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ ÏƒÏ„Î·Î»ÏÎ½ (ÎºÎ¿Î¹Î½Î® Î¼Îµ DB)">Î ÏÎ¿Î²Î¿Î»Î®: BASIC</button>
  <button id="btnSeriesFilters" class="mini-btn btn-gray" title="Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·/Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï†Î¯Î»Ï„ÏÏ‰Î½">Î¦Î¯Î»Ï„ÏÎ¿: ON</button>
  <button id="btnSeriesClearFilters" type="button" class="mini-btn btn-gray" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï†Î¯Î»Ï„ÏÏ‰Î½">Clear</button>
  <span id="seriesStatus" class="db-status" style="margin-left:auto">â€”</span>
</div>

<div class="db-table-wrap">
  <table class="db-table" id="seriesTable">
    <thead>
      <tr id="seriesHeadRow"></tr>
      <tr id="seriesFilterRow" class="db-filter-row"></tr>
    </thead>
    <tbody id="seriesRows">
      <tr><td colspan="99" style="color:#6b7a86;font-style:italic">â€”</td></tr>
    </tbody>
  </table>
</div>
          </details>


          <details id="dbSeriesDetails" style="margin-top:10px;">
            <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;">
              <span>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Î’Î¬ÏƒÎ· (DB)</span>
              <span id="dbSeriesSummaryName" style="color:#6b7a86;margin-left:6px"></span>
            </summary>

            <div class="db-controls no-print">
              <label style="font-size:11px;color:#6b7a86;font-weight:800">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚:</label>
              <input id="dbLimit" type="number" min="1" max="500" value="50" class="db-limit" />
              <button id="btnDbLoad" class="mini-btn btn-gray" title="Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€ÏŒ Firestore">Load DB</button>
              <button id="btnDbImport" class="mini-btn btn-gray" title="Î“Î­Î¼Î¹ÏƒÎµ Ï„Î¿ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ (buffer) Î±Ï€ÏŒ Ï„Î· Î²Î¬ÏƒÎ·">Import â†’ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</button>
              <button id="btnDbExport" class="mini-btn btn-gray" title="Î•Î¾Î±Î³Ï‰Î³Î® CSV">Export CSV</button>
              <button id="btnDbView" class="mini-btn btn-gray" title="Î•Î½Î±Î»Î»Î±Î³Î® Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ ÏƒÏ„Î·Î»ÏÎ½">Î ÏÎ¿Î²Î¿Î»Î®: BASIC</button>
              <button id="btnDbFilters" class="mini-btn btn-gray" title="Excel-style Ï†Î¯Î»Ï„ÏÎ± Î±Î½Î¬ ÏƒÏ„Î®Î»Î·">Î¦Î¯Î»Ï„ÏÎ¿: ON</button>
              <button id="btnDbClearFilters" type="button" class="mini-btn btn-gray" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï†Î¯Î»Ï„ÏÏ‰Î½">Clear</button>
              <span id="dbStatus" class="db-status">â€”</span>
            </div>

            <div class="db-table-wrap">
              <table class="db-table" id="dbTable">
                <thead>
                  <tr id="dbHeadRow"></tr>
                  <tr id="dbFilterRow" class="db-filter-row"></tr>
                </thead>
                <tbody id="dbRows"><tr><td colspan="8" style="color:#6b7a86;font-style:italic">â€”</td></tr></tbody>
              </table>
            </div>
          </details>
            </div>
          </details>

        </div>

      


  
  
  <div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="coHazardsPanelDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;">
        <span class="summary-flex">
          <span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span>
          <span class="summary-right">
            <span id="coHazardsBadges" class="cohazards-badges"></span>
            <button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½">âŸ²</button>
          </span>
        </span>
      </summary>
      <div class="cohazards-panel-body">
        <div id="coHazardsGlobal" class="cohazards-global">
          <div class="cohazards-panel-inner">
            <div id="coHazardsMetrics" class="cohazards-metrics">â€”</div>
            <div class="cohazards-note">*Î¤Î± ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ ÎµÎ¯Î½Î±Î¹ ÏƒÏ…Î¼Ï€Î»Î·ÏÏ‰Î¼Î±Ï„Î¹ÎºÎ¬. ÎŸÎ¹ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯/Ï€Î¯Î½Î±ÎºÎµÏ‚ ÎºÎ¬Ï„Ï‰ Î±ÎºÎ¿Î»Î¿Ï…Î¸Î¿ÏÎ½ Ï„Î¿ <b>ÎšÏÏÎ¹Î¿ Î£ÎµÎ½Î¬ÏÎ¹Î¿</b>.</div>
          </div>
        </div>
      </div>
    </details>
  </div>


  <div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="boundariesPanelDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±: <span id="selectedBoundaryName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedBoundary()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>
    </details>
  </div>


  <div class="box top-panel-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="streamsPanelDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿: <span id="selectedStreamName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedStream()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>
    </details>
  </div>

<div id="scenarioArea">

  <div id="panel_rain" class="scenario-panel">
  <div class="box top-panel-box scenario-area-panel" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="rainAreaDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·: <span id="selectedBasinName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedZone()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>

    </details>
  </div>

  <div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="rainScenarioDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="Î’ÏÎ¿Ï‡Î®">Î’ÏÎ¿Ï‡Î®</span></span></span></summary>

      <div class="scenario-area-body">
        <details class="scenario-cohazards-details" open>
          <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span id="coHazardsBadges_ctx_rain" class="cohazards-badges"></span><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½">âŸ²</button></span></span></summary>
          <div class="cohazards-context-box">
            <div class="cohazards-panel-inner">
              <div id="coHazardsMetrics_ctx_rain" class="cohazards-metrics">â€”</div>
              <div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
            </div>
          </div>
        </details>

<div class="grid-2">
        <div class="box" style="background:#fff3cd;border-color:#f1d27a">
<div class="row">
            <label>ÎˆÎ½Ï„Î±ÏƒÎ· i (mm/h):</label>
            <input type="number" id="rainI" value="0" step="0.1">
          </div>
          <div class="row">
            <label>Î”Î¹Î¬ÏÎºÎµÎ¹Î± D (min):</label>
            <input type="number" id="rainD" value="0" step="0.1">
          </div>
          <div style="font-size:11px;color:#6b7a86;text-align:right;">
            *Î‘Î½ D=0 â†’ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Tc (ÎµÎ»Î¬Ï‡Î¹ÏƒÏ„Î¿ 5 min)
          </div>
        </div>

              </div>

      <div class="panels-row">

        <div class="box" style="background:#eaf7ff;border-color:#bfe4ff">
          <h3>1. Î“Î•Î©ÎœÎ•Î¤Î¡Î™Î‘</h3>
          <div class="row"><label>Î•Î¼Î²Î±Î´ÏŒÎ½ A (mÂ²):</label><input type="number" id="area" value="0" step="1"></div>
          <div class="row"><label>ÎœÎ®ÎºÎ¿Ï‚ ÏÎ¿Î®Ï‚ L (m):</label><input type="number" id="length" value="0" step="1"></div>
          <div class="row"><label>Î¥ÏˆÎ¿Î¼. Î´Î¹Î±Ï†Î¿ÏÎ¬ H (m):</label><input type="number" id="height" value="0" step="0.1"></div>
          <div class="row"><label>Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ C:</label><input type="number" id="coef" value="0.40" step="0.01"></div>

          <div style="margin-top:10px">
            <canvas id="basinCanvas" width="340" height="180"></canvas>
          </div>
        </div>

        <div class="box" style="background:#eef9f1;border-color:#cfeee0">
          <h3>2. Î£Î¥Î›Î›ÎŸÎ“Î— (Î¦Î¡Î•Î‘Î¤Î™Î‘)</h3>
          <div class="row"><label>Î Î»Î®Î¸Î¿Ï‚:</label><input type="number" id="drains" value="0" step="1"></div>
          <div class="row"><label>Î™ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿ (mÂ³/s):</label><input type="number" id="drainCap" value="0" step="0.01"></div>
          <div style="font-size:11px;color:#6b7a86;margin-top:6px">
            *Qcap_Î´Î¹ÎºÏ„ÏÎ¿Ï… = Ï€Î»Î®Î¸Î¿Ï‚ Ã— Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î±/Ï†ÏÎµÎ¬Ï„Î¹Î¿
          </div>
        </div>

        <div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
          <h3>3. Î”Î™ÎŸÎ”Î•Î¥Î£Î— (Î¡Î•ÎœÎ‘)</h3>
          <div class="row"><label>Î Î»Î¬Ï„Î¿Ï‚ Ï€Ï…Î¸Î¼Î­Î½Î± b (m):</label><input type="number" id="strWidth" value="0" step="0.1"></div>
          <div class="row"><label>Î Î»Î¬Î³Î¹ÎµÏ‚ ÎºÎ»Î¯ÏƒÎµÎ¹Ï‚ z (H:V):</label><input type="number" id="strZ" value="0" step="0.1"></div>
          <div class="row"><label>Î’Î¬Î¸Î¿Ï‚ h (m):</label><input type="number" id="strDepth" value="0" step="0.1"></div>

          <div class="row">
            <label>n (Manning):</label>
            <select id="strType">
              <option value="0.030">0.030 (Î£ÎºÏ…ÏÏŒÎ´ÎµÎ¼Î±)</option>
              <option value="0.035">0.035 (ÎœÎµÎ¹ÎºÏ„ÏŒ/Î¤ÏÎ±Ï‡Ï)</option>
              <option value="0.045">0.045 (Î¦Ï…ÏƒÎ¹ÎºÎ® ÎºÎ¿Î¯Ï„Î·)</option>
              <option value="0.060">0.060 (Î Î¿Î»Ï Ï„ÏÎ±Ï‡Ï)</option>
            </select>
          </div>
          
          <div class="row"><label>ÎœÎ®ÎºÎ¿Ï‚ (m) (0=L):</label><input type="number" id="strLen" value="0" step="1"></div>
          <div class="row"><label>Î Ï„ÏÏƒÎ· (m) (0=H):</label><input type="number" id="strDrop" value="0" step="0.1"></div>
          
          <div class="row">
            <label>ÎÏˆÎ¿Ï‚ Î½ÎµÏÎ¿Ï y (m):</label>
            <input type="number" id="strY" value="" step="0.01" placeholder="Auto">
          </div>
          <div class="station-actions no-print" style="margin-top:6px">
            <button class="mini-btn btn-gray" onclick="resetStrY()">Auto y</button>
            <button class="mini-btn btn-map" onclick="openMapModal()">Î§Î¬ÏÏ„Î·Ï‚</button>
          </div>

          <div style="margin-top:10px">
            <canvas id="channelCanvas" width="340" height="180"></canvas>
          </div>
        </div>

      </div>

      <div class="summary-box">
        <div class="stat"><div class="k">ÎšÎ»Î¯ÏƒÎ· S</div><div class="v" id="res-slope">â€”</div></div>
        <div class="stat"><div class="k">Tc (Kirpich)</div><div class="v" id="res-tc">â€”</div></div>
        <div class="stat"><div class="k" style="color:#d35400">Qpeak</div><div class="v" id="res-qsel">â€”</div></div>
        <div class="stat"><div class="k">Qcap Î”Î¹ÎºÏ„ÏÎ¿Ï…</div><div class="v" id="res-drains">â€”</div></div>
        <div class="stat"><div class="k">Qcap Î¡Î­Î¼Î±Ï„Î¿Ï‚</div><div class="v" id="res-stream">â€”</div></div>
        <div class="stat"><div class="k">ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚</div><div class="v" id="res-adequacy">â€”</div></div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>i (mm/h)</th>
              <th>D (min)</th>
              <th>P (mm)</th>
              <th>Qpeak (mÂ³/s)</th>
              <th>V (mÂ³)</th>
              <th>Î•Ï€Î¹ÎºÎ¹Î½Î´Ï…Î½ÏŒÏ„Î·Ï„Î±</th>
              <th>Î”Î¯ÎºÏ„Ï…Î¿</th>
              <th>Î¡Î­Î¼Î±</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="footer-grid">
        <div class="legend">
          <h4>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</h4>
          <div style="font-size:12px;color:#2c3e50;font-weight:800;line-height:1.35">
            â€¢ Qpeak: ÎœÎ­Î¸Î¿Î´Î¿Ï‚ Rational (0.278Â·CÂ·iÂ·A_kmÂ²)<br/>
            â€¢ Tc: Kirpich (min) â€¢ D: Î±Î½ D=0 â†’ D= max(5, Tc)<br/>
            â€¢ Î¡Î­Î¼Î±: Manning ÏƒÎµ Ï„ÏÎ±Ï€ÎµÎ¶Î¿ÎµÎ¹Î´Î® Î´Î¹Î±Ï„Î¿Î¼Î® (b, z, h)<br/>
          </div>
        </div>

        <div class="legend">
          <h4>Î¥Ï€ÏŒÎ¼Î½Î·Î¼Î± (Peq = PÂ·C)</h4>
          <div class="item"><span class="swatch" style="background:#eafaf1"></span> Î§Î±Î¼Î·Î»Î® (&lt;10 mm)</div>
          <div class="item"><span class="swatch" style="background:#fff7e6"></span> ÎœÎ­Ï„ÏÎ¹Î± (10â€“25 mm)</div>
          <div class="item"><span class="swatch" style="background:#ffe9d6"></span> Î¥ÏˆÎ·Î»Î® (25â€“40 mm)</div>
          <div class="item"><span class="swatch" style="background:#ffe0e0"></span> Î Î¿Î»Ï Î¥ÏˆÎ·Î»Î® (40â€“60 mm)</div>
          <div class="item"><span class="swatch" style="background:#ffd1d1"></span> Î‘ÎºÏÎ±Î¯Î± (â‰¥60 mm)</div>
        </div>
      </div>
      </div>
        </details>
  </div>

</div>
<div id="panel_wind" class="scenario-panel">
  <div class="box top-panel-box scenario-area-panel" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="windAreaDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·: <span id="selectedAreaName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedZone()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>

    </details>
  </div>

  <div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="windScenarioDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="Î†Î½ÎµÎ¼Î¿Ï‚">Î†Î½ÎµÎ¼Î¿Ï‚</span></span></span></summary>

      <div class="scenario-area-body">
        <details class="scenario-cohazards-details" open>
          <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span id="coHazardsBadges_ctx_wind" class="cohazards-badges"></span><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½">âŸ²</button></span></span></summary>
          <div class="cohazards-context-box">
            <div class="cohazards-panel-inner">
              <div id="coHazardsMetrics_ctx_wind" class="cohazards-metrics">â€”</div>
              <div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
            </div>
          </div>
        </details>

<div class="grid-2">
    <div class="box" style="background:#e7f6ff;border-color:#b6e6ff">
<div class="row"><label>ÎŒÏÎ¹Î¿ Ï€ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ (km/h):</label><input type="number" id="windWarnKmh" value="50" step="1"></div>
      <div class="row"><label>ÎŒÏÎ¹Î¿ Ï…ÏˆÎ·Î»Î¿Ï ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (km/h):</label><input type="number" id="windHighKmh" value="70" step="1"></div>
      <div style="font-size:11px;color:#6b7a86;text-align:right;">*Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î· Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î±Ï‡ÏÏ„Î·Ï„Î± (Î®/ÎºÎ±Î¹ ÏÎ¹Ï€Î® Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)</div>
    </div>
    <div class="box" style="background:#f8fbff;border-color:#d6e6ff">
      <h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
      <div class="row"><label>Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î±Ï‡ÏÏ„Î·Ï„Î±:</label><div class="ro" id="windNow">â€”</div></div>
      <div class="row"><label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·:</label><div class="ro" id="windDir">â€”</div></div>
      <div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</label><div class="ro" id="windRisk">â€”</div></div>
    </div>
  </div>

  <div class="panels-row">
    <div class="box" style="background:#f0fff4;border-color:#c9f2d5">
      <h3>1. ÎˆÎºÎ¸ÎµÏƒÎ· / Î•Ï…Ï€Î¬Î¸ÎµÎ¹ÎµÏ‚</h3>
      <div class="ops-list">
        <ul>
          <li>Î”Î­Î½Ï„ÏÎ±/ÎºÎ»Î±Î´Î¹Î¬ â€“ Ï€Î¬ÏÎºÎ±, Î´ÎµÎ½Î´ÏÎ¿ÏƒÏ„Î¿Î¹Ï‡Î¯ÎµÏ‚, ÏƒÏ‡Î¿Î»Î¹ÎºÎ­Ï‚ Î±Ï…Î»Î­Ï‚</li>
          <li>Î Î¹Î½Î±ÎºÎ¯Î´ÎµÏ‚, ÏƒÏ„Î­Î³Î±ÏƒÏ„ÏÎ±, ÎºÎ¬Î´Î¿Î¹, Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î­Ï‚ ÎºÎ±Ï„Î±ÏƒÎºÎµÏ…Î­Ï‚</li>
          <li>Î•ÏÎ³Î¿Ï„Î¬Î¾Î¹Î±/ÏƒÎºÎ±Î»Ï‰ÏƒÎ¹Î­Ï‚, ÎµÎ»Î±Ï†ÏÎ¹Î­Ï‚ ÏƒÏ„Î­Î³ÎµÏ‚, Ï…Î»Î¹ÎºÎ¬ ÏƒÏ„Î¿ ÏÏ€Î±Î¹Î¸ÏÎ¿</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#fff7e6;border-color:#f2d3a0">
      <h3>2. Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÎ­Ï‚ ÎµÎ½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</h3>
      <div class="ops-list">
        <ul>
          <li>Î ÎµÏÎ¹Ï€Î¿Î»Î¯ÎµÏ‚ ÏƒÎµ ÎµÏ…Ï€Î±Î¸Î® ÏƒÎ·Î¼ÎµÎ¯Î± (Î´Î­Î½Ï„ÏÎ±/Ï€Î¹Î½Î±ÎºÎ¯Î´ÎµÏ‚)</li>
          <li>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎµÏÎ³Î¿Ï„Î±Î¾Î¯Ï‰Î½ Î³Î¹Î± Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ· Ï…Î»Î¹ÎºÏÎ½</li>
          <li>Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± ÏƒÏ…Î½ÎµÏÎ³ÎµÎ¯Ï‰Î½ Î³Î¹Î± Ï€Ï„ÏÏƒÎµÎ¹Ï‚ ÎºÎ»Î±Î´Î¹ÏÎ½/Î±Î½Ï„Î¹ÎºÎµÎ¹Î¼Î­Î½Ï‰Î½</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
      <h3>3. Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / Î¤Î¿Ï€Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</h3>
      <div class="row"><label>Hotspot:</label><input id="windHotspot" placeholder="Ï€.Ï‡. Î Î¬ÏÎºÎ¿, ÎºÎµÎ½Ï„ÏÎ¹ÎºÎ­Ï‚ Î»ÎµÏ‰Ï†ÏŒÏÎ¿Î¹, ÎµÏÎ³Î¿Ï„Î¬Î¾Î¹Î¿â€¦"></div>
      <div class="row"><label>Î£Ï‡ÏŒÎ»Î¹Î¿:</label><input id="windNote" placeholder="ÏƒÏÎ½Ï„Î¿Î¼Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·â€¦"></div>
    </div>
  </div>
      </div>
        </details>
  </div>

</div>
<div id="panel_heatwave" class="scenario-panel">
  <div class="box top-panel-box scenario-area-panel" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="heatAreaDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·: <span id="selectedHeatAreaName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedZone()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>

    </details>
  </div>

  <div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="heatwaveScenarioDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚">ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚</span></span></span></summary>

      <div class="scenario-area-body">
        <details class="scenario-cohazards-details" open>
          <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span id="coHazardsBadges_ctx_heatwave" class="cohazards-badges"></span><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½">âŸ²</button></span></span></summary>
          <div class="cohazards-context-box">
            <div class="cohazards-panel-inner">
              <div id="coHazardsMetrics_ctx_heatwave" class="cohazards-metrics">â€”</div>
              <div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
            </div>
          </div>
        </details>

<div class="grid-2">
    <div class="box" style="background:#fff3cd;border-color:#f1d27a">
<div class="row"><label>ÎŒÏÎ¹Î¿ Î¼Î­Ï„ÏÎ¹Î¿Ï… ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Â°C HI):</label><input type="number" id="heatWarnHI" value="37" step="0.1"></div>
      <div class="row"><label>ÎŒÏÎ¹Î¿ Ï…ÏˆÎ·Î»Î¿Ï ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Â°C HI):</label><input type="number" id="heatHighHI" value="41" step="0.1"></div>
      <div style="font-size:11px;color:#6b7a86;text-align:right;">*HI = Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚/Heat Index (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)</div>
    </div>
    <div class="box" style="background:#fff7f7;border-color:#ffd1d1">
      <h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
      <div class="row"><label>Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±:</label><div class="ro" id="heatTempNow">â€”</div></div>
      <div class="row"><label>Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î´Ï…ÏƒÏ†Î¿ÏÎ¯Î±Ï‚ (HI):</label><div class="ro" id="heatIndexNow">â€”</div></div>
      <div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:</label><div class="ro" id="heatRisk">â€”</div></div>
    </div>
  </div>

  <div class="panels-row">
    <div class="box" style="background:#f0fff4;border-color:#c9f2d5">
      <h3>1. Î•Ï…Î¬Î»Ï‰Ï„Î¿Î¹ Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Î¯ / ÏƒÎ·Î¼ÎµÎ¯Î±</h3>
      <div class="ops-list">
        <ul>
          <li>Î—Î»Î¹ÎºÎ¹Ï‰Î¼Î­Î½Î¿Î¹, Ï€Î±Î¹Î´Î¹Î¬, Î¬Ï„Î¿Î¼Î± Î¼Îµ Ï‡ÏÏŒÎ½Î¹Î± Î½Î¿ÏƒÎ®Î¼Î±Ï„Î±</li>
          <li>Î•ÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿Î¹ ÏƒÎµ ÎµÎ¾Ï‰Ï„ÎµÏÎ¹ÎºÎ¿ÏÏ‚ Ï‡ÏÏÎ¿Ï…Ï‚</li>
          <li>Î ÎµÏÎ¹Î¿Ï‡Î­Ï‚ Î¼Îµ Ï‡Î±Î¼Î·Î»Î® ÏƒÎºÎ¯Î±ÏƒÎ·/Ï…ÏˆÎ·Î»Î® Î¸ÎµÏÎ¼Î¹ÎºÎ® Î½Î·ÏƒÎ¯Î´Î±</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#e7f6ff;border-color:#b6e6ff">
      <h3>2. ÎœÎ­Ï„ÏÎ± Î”Î®Î¼Î¿Ï…</h3>
      <div class="ops-list">
        <ul>
          <li>Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±/ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎºÎ»Î¹Î¼Î±Ï„Î¹Î¶ÏŒÎ¼ÎµÎ½Ï‰Î½ Ï‡ÏÏÏ‰Î½ (cooling centers)</li>
          <li>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î´Î·Î¼Î¿Ï„ÏÎ½ (ÎµÎ½Ï…Î´Î¬Ï„Ï‰ÏƒÎ·, Î±Ï€Î¿Ï†Ï…Î³Î® Î­ÎºÎ¸ÎµÏƒÎ·Ï‚ 12:00â€“17:00)</li>
          <li>Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± Î³Î¹Î± ÎµÏ…Ï€Î±Î¸ÎµÎ¯Ï‚ Î´Î¿Î¼Î­Ï‚ (ÎšÎ‘Î Î—, ÏƒÏ‡Î¿Î»ÎµÎ¯Î±, Î´Î¿Î¼Î­Ï‚ Ï†Î¹Î»Î¿Î¾ÎµÎ½Î¯Î±Ï‚)</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
      <h3>3. Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / Î¤Î¿Ï€Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</h3>
      <div class="row"><label>Hotspot:</label><input id="heatHotspot" placeholder="Ï€.Ï‡. Ï€Î»Î±Ï„ÎµÎ¯ÎµÏ‚ Ï‡Ï‰ÏÎ¯Ï‚ ÏƒÎºÎ¹Î¬, Î³ÎµÎ¹Ï„Î¿Î½Î¹Î­Ï‚â€¦"></div>
      <div class="row"><label>Î£Ï‡ÏŒÎ»Î¹Î¿:</label><input id="heatNote" placeholder="ÏƒÏÎ½Ï„Î¿Î¼Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·â€¦"></div>
    </div>
  </div>
      </div>
        </details>
  </div>

</div>
<div id="panel_frost_snow" class="scenario-panel">
  <div class="box top-panel-box scenario-area-panel" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="frostAreaDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·: <span id="selectedFrostAreaName">â€”</span></span><span class="summary-right"><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();resetSelectedZone()" title="Reset">âŸ²</button></span></span></summary>
      <div class="monitor-panel-body" style="margin-top:0">
        <div style="margin-top:6px;padding:8px 10px;background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06);border-radius:12px;font-size:12px;color:#2b3a44;">
          Î¦ÏŒÏÏ„Ï‰ÏƒÎµ (Load) Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± <b>Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</b> Î³Î¹Î± Î½Î± ÎµÎ½Î·Î¼ÎµÏÏ‰Î¸ÎµÎ¯ Î· ÎµÏ€Î¹Î»Î¿Î³Î®.
        </div>
      </div>

    </details>

  <div class="box top-panel-box scenario-box" style="background:#97c9d1;border-color:#dfe7ee">
    <details id="frost_snowScenarioDetails" open style="margin:0;">
      <summary class="monitor-panel-summary" style="cursor:pointer;"><span class="summary-flex"><span class="summary-left">Î£ÎµÎ½Î¬ÏÎ¹Î¿: <span class="scenario-name" data-scn-name="Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±">Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±</span></span></span></summary>

      <div class="scenario-area-body">
        <details class="scenario-cohazards-details" open>
          <summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px;"><span class="summary-flex"><span class="summary-left">Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÎ¬ Î¦Î±Î¹Î½ÏŒÎ¼ÎµÎ½Î± (Coâ€‘Hazards)</span><span class="summary-right"><span id="coHazardsBadges_ctx_frost_snow" class="cohazards-badges"></span><button type="button" class="summary-reset-btn no-print" onclick="event.preventDefault();event.stopPropagation();(window.clearCoHazards?window.clearCoHazards():null)" title="Reset Î£Ï…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½">âŸ²</button></span></span></summary>
          <div class="cohazards-context-box">
            <div class="cohazards-panel-inner">
              <div id="coHazardsMetrics_ctx_frost_snow" class="cohazards-metrics">â€”</div>
              <div class="cohazards-note">*Î£ÏÎ½Î¿ÏˆÎ· ÏƒÏ…Î½Î´Ï…Î±ÏƒÏ„Î¹ÎºÏÎ½ Î³Î¹Î± Ï„Î¿ ÎµÎ½ÎµÏÎ³ÏŒ ÏƒÎµÎ½Î¬ÏÎ¹Î¿.</div>
            </div>
          </div>
        </details>

<div class="grid-2">
    <div class="box" style="background:#e8f4ff;border-color:#bfe4ff">
<div class="row"><label>ÎŒÏÎ¹Î¿ Ï€Î±Î³ÎµÏ„Î¿Ï (Â°C):</label><input type="number" id="frostTemp0" value="0" step="0.1"></div>
      <div class="row"><label>ÎŒÏÎ¹Î¿ Î±Ï…Î¾Î·Î¼Î­Î½Î¿Ï… ÎºÎ¹Î½Î´ÏÎ½Î¿Ï… (Â°C):</label><input type="number" id="frostTempHigh" value="-2" step="0.1"></div>
      <div style="font-size:11px;color:#6b7a86;text-align:right;">*Î‘Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Ï…ÎµÏ„ÏŒÏ‚ Î¼Îµ Tâ‰¤0 â†’ Î±Ï…Î¾Î·Î¼Î­Î½Î¿Ï‚ ÎºÎ¯Î½Î´Ï…Î½Î¿Ï‚ Ï€Î¬Î³Î¿Ï…</div>
    </div>
    <div class="box" style="background:#f8fbff;border-color:#d6e6ff">
      <h3>Î£ÏÎ½Ï„Î¿Î¼Î· ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·</h3>
      <div class="row"><label>Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±:</label><div class="ro" id="frostTempNow">â€”</div></div>
      <div class="row"><label>Wind Chill:</label><div class="ro" id="frostChillNow">â€”</div></div>
      <div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚ Ï€Î±Î³ÎµÏ„Î¿Ï:</label><div class="ro" id="frostRisk">â€”</div></div>
      <div class="row"><label>ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚ Ï€Î¬Î³Î¿Ï…:</label><div class="ro" id="iceRisk">â€”</div></div>
    </div>
  </div>

  <div class="panels-row">
    <div class="box" style="background:#fff3cd;border-color:#f1d27a">
      <h3>1. ÎŸÎ´Î¹ÎºÏŒ Î´Î¯ÎºÏ„Ï…Î¿ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚</h3>
      <div class="ops-list">
        <ul>
          <li>Î‘Î½Î·Ï†ÏŒÏÎµÏ‚/ÎºÎ±Ï„Î·Ï†ÏŒÏÎµÏ‚, Î³Î­Ï†Ï…ÏÎµÏ‚, ÏƒÎ·Î¼ÎµÎ¯Î± ÏƒÎºÎ¹Î¬Ï‚</li>
          <li>Î ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÎµ ÏƒÏ‡Î¿Î»ÎµÎ¯Î±, Î´Î¿Î¼Î­Ï‚ Ï…Î³ÎµÎ¯Î±Ï‚, ÎºÏÎ¯ÏƒÎ¹Î¼ÎµÏ‚ Î±ÏÏ„Î·ÏÎ¯ÎµÏ‚</li>
          <li>ÎšÏŒÎ¼Î²Î¿Î¹/Î´Î¹Î±ÏƒÏ„Î±Ï…ÏÏÏƒÎµÎ¹Ï‚ Î¼Îµ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î¿Î»Î¹ÏƒÎ¸Î·ÏÏŒÏ„Î·Ï„Î±Ï‚</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#f0fff4;border-color:#c9f2d5">
      <h3>2. Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± â€“ Î±Î»Î¬Ï„Î¹ & ÏƒÏ…Î½ÎµÏÎ³ÎµÎ¯Î±</h3>
      <div class="ops-list">
        <ul>
          <li>Î”Î¹Î±Î¸ÎµÏƒÎ¹Î¼ÏŒÏ„Î·Ï„Î± Î±Î»Î±Ï„Î¹Î¿Ï/Î´Î¹Î±Î½Î¿Î¼Î® ÏƒÎµ ÎµÏ…Ï€Î±Î¸ÎµÎ¯Ï‚</li>
          <li>Î•Ï„Î¿Î¹Î¼ÏŒÏ„Î·Ï„Î± ÎµÎºÏ‡Î¹Î¿Î½Î¹ÏƒÏ„Î¹ÎºÏÎ½/Î±Î»Î±Ï„Î¹Î­ÏÏ‰Î½ & Î²Î¬ÏÎ´Î¹ÎµÏ‚</li>
          <li>Î£Ï…Î½Ï„Î¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚ (ÏƒÏ‡Î¿Î»ÎµÎ¯Î±/Î´Î·Î¼ÏŒÏ„ÎµÏ‚)</li>
        </ul>
      </div>
    </div>

    <div class="box" style="background:#f6f0ff;border-color:#e3d5ff">
      <h3>3. Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / Î¤Î¿Ï€Î¹ÎºÎ­Ï‚ Ï€Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹</h3>
      <div class="row"><label>Hotspot:</label><input id="frostHotspot" placeholder="Ï€.Ï‡. Î±Î½Î·Ï†ÏŒÏÎ±, Î³Î­Ï†Ï…ÏÎ±, ÏƒÎºÎ¹Î±ÏƒÎ¼Î­Î½Î· Î¿Î´ÏŒÏ‚â€¦"></div>
      <div class="row"><label>Î£Ï‡ÏŒÎ»Î¹Î¿:</label><input id="frostNote" placeholder="ÏƒÏÎ½Ï„Î¿Î¼Î· ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·â€¦"></div>
    </div>
  </div>
  </div>

</div>

    </div>
  
</main>

</div>

<!-- ================= Map Modal ================= -->
<div id="mapModal" class="no-print">
  <div id="mapCard">
    <div id="mapTop">
      <div>ğŸ—ºï¸ Î ÏÎ¿Î²Î¿Î»Î® Î§Î¬ÏÏ„Î· (Ï€Î¿Î»Î»Î±Ï€Î»Î¬ layers)</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="mini-btn btn-gray" onclick="turnAllOff()">Off ÏŒÎ»Î±</button>
        <button class="mini-btn btn-gray" onclick="closeMapModal()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
    </div>
    <div id="mapBox"></div>
      </div>
        </details>
  </div>


    </div>
  
</main>

</div>

<!-- ================= Map Modal ================= -->
<div id="mapModal" class="no-print">
  <div id="mapCard">
    <div id="mapTop">
      <div>ğŸ—ºï¸ Î ÏÎ¿Î²Î¿Î»Î® Î§Î¬ÏÏ„Î· (Ï€Î¿Î»Î»Î±Ï€Î»Î¬ layers)</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="mini-btn btn-gray" onclick="turnAllOff()">Off ÏŒÎ»Î±</button>
        <button class="mini-btn btn-gray" onclick="closeMapModal()">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
      </div>
    </div>
    <div id="mapBox"></div>
      </div>
    </details>
  </div>
</div>
</div>

<script>
/* ===================== CONFIG ===================== */
const GH_USER   = 'petrsanidas-ui';
const GH_REPO   = 'nireas';
const GH_BRANCH = 'main';
const API_TREE  = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/git/trees/${GH_BRANCH}?recursive=1`;
const RAW_URL   = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/${GH_BRANCH}/`;

let DATA_GROUPS = { boundaries: [], streams: [], basins: [] }; // NOTE ORDER
let SELECTED_GEO = null;
let SELECTED_BASIN_KEY = null;
let SELECTED_ZONE_KEY = null;
let SELECTED_ZONE_NAME = null;
let SELECTED_ZONE_KIND = null; // 'basin' | 'boundary'
let SELECTED_BOUNDARY_KEY = null;
let SELECTED_BOUNDARY_NAME = null;
let SELECTED_BOUNDARY_GEO = null;
let SELECTED_STREAM_KEY = null;
let SELECTED_STREAM_NAME = null;
let SELECTED_STREAM_GEO = null;
let STATION_SELECT_BOUND = false; // bind dropdown change listener once
let MULTI_DETAILS_OPEN = true; // remember collapse state for "Î•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÏ„Î±Î¸Î¼Î¿Î¯"


let MULTI_RESULTS_BY_URL = new Map(); // url -> last fetched result (for per-station refresh)
/* ===== Map state (multi-layer) ===== */
let map = null;
let baseLayer = null;
const GEO_CACHE = new Map();       // path -> geojson
const LAYER_CACHE = new Map();     // path -> leaflet layer
const VISIBLE = new Set();         // paths currently "On"
let PREVIEW_LAYER = null;          // temporary layer for Map button preview

/* ===== Selected Meteo Stations layer (map) ===== */
const STATIONS_META = new Map();   // url -> {name,url,lat,lon,elev}
let METEO_STATIONS_VISIBLE = false;
let METEO_STATIONS_LAYER = null;  // persistent selected markers layer
let METEO_STATIONS_PREVIEW = null;// preview-only layer (Map button)
const METEO_MARKERS = new Map();  // url -> Leaflet marker (persistent)

function getSelectedStationUrls(){
  const out = [];
  const p = getPrimaryStationUrl ? getPrimaryStationUrl() : '';
  if(p) out.push(p);
  try{
    if(typeof watchlist !== 'undefined' && watchlist && watchlist.size){
      for(const u of watchlist.keys()) out.push(u);
    }
  }catch(_){}
  return Array.from(new Set(out));
}

function meteoIcons(){
  // cache once
  if(meteoIcons._cache) return meteoIcons._cache;
  const extra = L.divIcon({
    className:'station-divicon',
    html:'<div class="station-pin-wrap"><div class="station-pin"></div></div>',
    iconSize:[16,16],
    iconAnchor:[8,8]
  });
  const primary = L.divIcon({
    className:'station-divicon',
    html:'<div class="station-pin-wrap"><div class="station-pin primary"></div></div>',
    iconSize:[18,18],
    iconAnchor:[9,9]
  });
  meteoIcons._cache = { extra, primary };
  return meteoIcons._cache;
}

function ensureMeteoStationsLayer(){
  if(!METEO_STATIONS_LAYER) METEO_STATIONS_LAYER = L.layerGroup();
  return METEO_STATIONS_LAYER;
}

function clearMeteoStationsPreview(){
  if(METEO_STATIONS_PREVIEW && map && map.hasLayer(METEO_STATIONS_PREVIEW)){
    map.removeLayer(METEO_STATIONS_PREVIEW);
  }
  METEO_STATIONS_PREVIEW = null;
}

async function refreshSelectedMeteoMarkers(){
  // build persistent markers map based on current selection
  const urls = getSelectedStationUrls();
  const keep = new Set(urls);

  // remove stale
  for(const [u, mk] of Array.from(METEO_MARKERS.entries())){
    if(!keep.has(u)){
      try{ ensureMeteoStationsLayer().removeLayer(mk); }catch(_){}
      METEO_MARKERS.delete(u);
    }
  }

  const icons = meteoIcons();
  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';

  // add missing
  for(const u of urls){
    if(METEO_MARKERS.has(u)) continue;

    // special fallback for Openâ€‘Meteo token (shows approx Chalandri)
    let meta = STATIONS_META.get(u);
    if(!meta && u === OPEN_METEO_TOKEN){
      meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
    }
    if(!meta || meta.lat == null || meta.lon == null) continue;

    const icon = (u === primaryUrl) ? icons.primary : icons.extra;
    const mk = L.marker([meta.lat, meta.lon], { icon });

    const elevTxt = (meta.elev != null && !Number.isNaN(meta.elev)) ? `${meta.elev} m` : 'â€”';
    mk.bindPopup(`<b>${meta.name || 'Î£Ï„Î±Î¸Î¼ÏŒÏ‚'}</b><br/>Î¥ÏˆÏŒÎ¼ÎµÏ„ÏÎ¿: ${elevTxt}<br/><a href="${meta.url === OPEN_METEO_TOKEN ? '#' : meta.url}" target="_blank">Î†Î½Î¿Î¹Î³Î¼Î± link</a>`);

    METEO_MARKERS.set(u, mk);
    try{ ensureMeteoStationsLayer().addLayer(mk); }catch(_){}
  }

  // if map open and layer should be visible, add to map
  if(map){
    if(METEO_STATIONS_VISIBLE){
      const layer = ensureMeteoStationsLayer();
      if(!map.hasLayer(layer)) layer.addTo(map);
    }else{
      const layer = ensureMeteoStationsLayer();
      if(map.hasLayer(layer)) map.removeLayer(layer);
    }
  }
}

function updateMeteoStationsRowButton(){
  const btn = document.getElementById('btn-onoff-meteoStations');
  if(!btn) return;
  btn.textContent = METEO_STATIONS_VISIBLE ? 'On' : 'Off';
  btn.classList.toggle('btn-on', METEO_STATIONS_VISIBLE);
  btn.classList.toggle('btn-off', !METEO_STATIONS_VISIBLE);
}

function toggleMeteoStationsLayer(){
  METEO_STATIONS_VISIBLE = !METEO_STATIONS_VISIBLE;
  updateMeteoStationsRowButton();
  if(map) refreshSelectedMeteoMarkers(); // will add/remove layer
  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}

async function meteoStationsLoad(){
  // Refresh markers cache; do not open map, do not change On/Off
  await refreshSelectedMeteoMarkers();
}

async function meteoStationsMap(){
  // Preview selected stations on map WITHOUT changing On/Off
  openMapModal();
  clearMeteoStationsPreview();

  const urls = getSelectedStationUrls();
  const icons = meteoIcons();
  const primaryUrl = (getPrimaryStationUrl ? getPrimaryStationUrl() : '') || '';

  const grp = L.layerGroup();
  const pts = [];

  for(const u of urls){
    let meta = STATIONS_META.get(u);
    if(!meta && u === OPEN_METEO_TOKEN){
      meta = { name:'Openâ€‘Meteo (Î§Î±Î»Î¬Î½Î´ÏÎ¹)', url:u, lat:38.0237, lon:23.8007, elev:null };
    }
    if(!meta || meta.lat == null || meta.lon == null) continue;

    const icon = (u === primaryUrl) ? icons.primary : icons.extra;
    const mk = L.marker([meta.lat, meta.lon], { icon });
    grp.addLayer(mk);
    pts.push([meta.lat, meta.lon]);
  }

  METEO_STATIONS_PREVIEW = grp;
  if(map && !map.hasLayer(grp)) grp.addTo(map);

  // fit to points if any
  if(map && pts.length){
    try{
      const b = L.latLngBounds(pts.map(p=>L.latLng(p[0], p[1])));
      map.fitBounds(b, { padding:[20,20] });
    }catch(_){}
  }
}

/* ===== End Meteo Stations layer ===== */

/* ===== Station monitor ===== */
const STATION_SERIES_DEFAULT = 50;
function getSeriesLimit(){
  const n = Number(document.getElementById('seriesLimit')?.value);
  const lim = (Number.isFinite(n) && n>0) ? n : STATION_SERIES_DEFAULT;
  return Math.max(1, Math.min(500, Math.floor(lim)));
}

// Per-station series contexts (do not mix histories across different primary stations)
const stationSeriesByKey  = Object.create(null);  // key -> array
const stationLastKeyByKey = Object.create(null);  // key -> last sample key
function trimAllStationSeriesToLimit(){
  const lim = getSeriesLimit();
  for(const k of Object.keys(stationSeriesByKey)){
    const arr = stationSeriesByKey[k];
    if(Array.isArray(arr) && arr.length > lim){
      arr.splice(0, arr.length - lim);
    }
  }
}
let currentStationKey = 'open-meteo';

let stationSeries = [];
let stationLastKey = null;

// initialize default context
stationSeriesByKey[currentStationKey] = stationSeries;
stationLastKeyByKey[currentStationKey] = stationLastKey;

let stationLiveOn = false;
const watchlist = new Map(); // url -> display name
let ACTIVE_PRIMARY_URL = '';
let ACTIVE_PRIMARY_NAME = '';

const LS_WATCHLIST_KEY = 'nireas_watchlist_v1';
const LS_CUSTOM_KEY   = 'nireas_customstations_v1';
const OPEN_METEO_TOKEN = '__OPEN_METEO__';
const ALL_API_TOKEN   = '__ALL_API__';
const ALL_WEB_TOKEN   = '__ALL_WEB__';
const ALL_ALL_TOKEN   = '__ALL_ALL__';

function getSelectGroupPairs(selectEl, groupLabel){
  const out = [];
  if(!selectEl) return out;
  const kids = Array.from(selectEl.children || []);
  for(const node of kids){
    if(node && node.tagName === 'OPTGROUP' && node.label === groupLabel){
      for(const opt of Array.from(node.children || [])){
        if(!opt || opt.tagName !== 'OPTION') continue;
        const url = String(opt.value || '').trim();
        if(!url) continue;
        if(url === ALL_API_TOKEN || url === ALL_WEB_TOKEN || url === ALL_ALL_TOKEN) continue;
        out.push({ url, name: String(opt.textContent || url).trim() });
      }
    }
  }
  return out;
}

/* ===== Model Scenario (for future model switching) ===== */
let MODEL_SCENARIO = 'rain'; // rain | wind | heatwave | frost_snow | storm | dust_smoke | fog

function setModelScenario(val){
  MODEL_SCENARIO = String(val || 'rain');
// reflect on UI (title only â€” calculations remain the same for now)
  const mapName = {
    rain:'Î’ÏÎ¿Ï‡Î®',
    wind:'Î†Î½ÎµÎ¼Î¿Ï‚',
    heatwave:'ÎšÎ±ÏÏƒÏ‰Î½Î±Ï‚',
    frost_snow:'Î Î±Î³ÎµÏ„ÏŒÏ‚ / Î§Î¹ÏŒÎ½Î¹Î±',
    storm:'ÎšÎ±Ï„Î±Î¹Î³Î¯Î´Î± / ÎšÎµÏÎ±Ï…Î½Î¿Î¯',
    dust_smoke:'Î£ÎºÏŒÎ½Î· / ÎšÎ±Ï€Î½ÏŒÏ‚',
    fog:'ÎŸÎ¼Î¯Ï‡Î»Î·'
  };
  const nice = mapName[MODEL_SCENARIO] || 'Î’ÏÎ¿Ï‡Î®';
  const t = document.getElementById('scenarioTitle');
  if(t) t.textContent = `Î£Î•ÎÎ‘Î¡Î™ÎŸ: ${nice}`;
  document.body.dataset.modelScenario = MODEL_SCENARIO;
  try{ applyScenarioUI(MODEL_SCENARIO); }catch(_){}

  try{ scheduleSaveUiState(); }catch(_){}

/* ===== Scenario-based UI: show only relevant panels (from 'Î›ÎµÎºÎ¬Î½Î· ÎºÎ±Î¹ ÎºÎ¬Ï„Ï‰') ===== */
function applyScenarioUI(scn){
  const val = String(scn || 'rain');
  const map = {
    rain: 'panel_rain',
    wind: 'panel_wind',
    heatwave: 'panel_heatwave',
    frost_snow: 'panel_frost_snow'
  };
  const target = map[val] || 'panel_rain';
  const root = document.getElementById('scenarioArea');
  if(!root) return;

  const panels = root.querySelectorAll('.scenario-panel');
  panels.forEach(p=>{
    const on = (p.id === target);
    p.classList.toggle('active', on);
    try{ p.setAttribute('aria-hidden', on ? 'false' : 'true'); }catch(_){}
  });

  // Keep "Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®" in sync with the currently selected basin (until we add dedicated area selection)
  try{
    const basin = document.getElementById('selectedBasinName')?.textContent?.trim() || 'â€”';
    const ids = ['selectedAreaName','selectedHeatAreaName','selectedFrostAreaName'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.textContent = basin;
    });
  }catch(_){}

  refreshScenarioPanels();
}

/* ===== Scenario mini-metrics (read-only) from latest primary sample ===== */
function __numFromText(txt){
  if(txt == null) return null;
  const s = String(txt).replace(',', '.');
  const m = s.match(/-?\d+(?:\.\d+)?/);
  return m ? Number(m[0]) : null;
}
function __fmt(v, unit=''){
  if(v==null || !Number.isFinite(v)) return 'â€”';
  const n = Math.round(v*10)/10;
  return `${n.toFixed(1)}${unit}`;
}
function __riskLabel(level, text){
  const map = {
    low:   "<span class='status-ok'>Î§Î±Î¼Î·Î»ÏŒÏ‚</span>",
    med:   "<span class='status-warn'>ÎœÎ­Ï„ÏÎ¹Î¿Ï‚</span>",
    high:  "<span class='status-fail'>Î¥ÏˆÎ·Î»ÏŒÏ‚</span>",
    ext:   "<span class='status-extreme'>Î‘ÎºÏÎ±Î¯Î¿Ï‚</span>",
    none:  "<span style='color:#6b7a86'>â€”</span>"
  };
  return map[level] ? map[level] + (text ? ` <span style="color:#6b7a86;font-weight:700">${text}</span>` : '') : (text || 'â€”');
}
function getLatestPrimarySample(){
  try{
    if(typeof stationSeries !== 'undefined' && Array.isArray(stationSeries) && stationSeries.length){
      return stationSeries[stationSeries.length-1];
    }
    if(window.stationSeries && Array.isArray(window.stationSeries) && window.stationSeries.length){
      return window.stationSeries[window.stationSeries.length-1];
    }
  }catch(_){}
  return null;
}

function refreshScenarioPanels(){
  const s = getLatestPrimarySample();
  if(!s){
    // keep panels clean if nothing loaded yet
    ['windNow','windDir','windRisk','heatTempNow','heatIndexNow','heatRisk','frostTempNow','frostChillNow','frostRisk','iceRisk']
      .forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML='â€”'; });
    return;
  }

  // ---- WIND ----
  const windTxt = (s.wind != null) ? String(s.wind) : '';
  const wKmh = (typeof s.windKmh === 'number') ? s.windKmh
            : (typeof s.wind_kmh === 'number') ? s.wind_kmh
            : __numFromText(windTxt);
  let wDir = 'â€”';
  try{
    const toks = windTxt.trim().split(/\s+/);
    if(toks.length>=2){
      const last = toks[toks.length-1];
      if(/[NSEWÎ‘-Î©]/i.test(last)) wDir = last;
    }
  }catch(_){}

  const warnK = Number(document.getElementById('windWarnKmh')?.value);
  const highK = Number(document.getElementById('windHighKmh')?.value);

  let wLevel = 'none';
  if(Number.isFinite(wKmh)){
    if(Number.isFinite(highK) && wKmh >= highK) wLevel = 'high';
    else if(Number.isFinite(warnK) && wKmh >= warnK) wLevel = 'med';
    else wLevel = 'low';
  }

  const windNowEl = document.getElementById('windNow');
  if(windNowEl) windNowEl.textContent = Number.isFinite(wKmh) ? __fmt(wKmh, ' km/h') : (windTxt || 'â€”');
  const windDirEl = document.getElementById('windDir');
  if(windDirEl) windDirEl.textContent = wDir;
  const windRiskEl = document.getElementById('windRisk');
  if(windRiskEl) windRiskEl.innerHTML = __riskLabel(wLevel);

  // ---- HEATWAVE ----
  const t = (typeof s.temp === 'number') ? s.temp : ((typeof s.temperature === 'number') ? s.temperature : null);
  const hi = (typeof s.heat === 'number') ? s.heat : null;
  const warnHI = Number(document.getElementById('heatWarnHI')?.value);
  const highHI = Number(document.getElementById('heatHighHI')?.value);

  let hLevel = 'none';
  if(Number.isFinite(hi)){
    if(Number.isFinite(highHI) && hi >= highHI) hLevel = 'high';
    else if(Number.isFinite(warnHI) && hi >= warnHI) hLevel = 'med';
    else hLevel = 'low';
  }else if(Number.isFinite(t)){
    // fallback: use temp thresholds if HI missing
    if(t >= 40) hLevel = 'high';
    else if(t >= 35) hLevel = 'med';
    else hLevel = 'low';
  }

  const heatTempEl = document.getElementById('heatTempNow');
  if(heatTempEl) heatTempEl.textContent = Number.isFinite(t) ? __fmt(t,' Â°C') : 'â€”';
  const heatIdxEl = document.getElementById('heatIndexNow');
  if(heatIdxEl) heatIdxEl.textContent = Number.isFinite(hi) ? __fmt(hi,' Â°C') : 'â€”';
  const heatRiskEl = document.getElementById('heatRisk');
  if(heatRiskEl) heatRiskEl.innerHTML = __riskLabel(hLevel);

  // ---- FROST / SNOW ----
  const chill = (typeof s.chill === 'number') ? s.chill : null;
  const rr = (typeof s.rainRate === 'number') ? s.rainRate : ((typeof s.rr === 'number') ? s.rr : null);

  const t0 = Number(document.getElementById('frostTemp0')?.value);
  const tHigh = Number(document.getElementById('frostTempHigh')?.value);

  let fLevel = 'none';
  if(Number.isFinite(t)){
    if(Number.isFinite(tHigh) && t <= tHigh) fLevel = 'high';
    else if(Number.isFinite(t0) && t <= t0) fLevel = 'med';
    else if(t <= 2) fLevel = 'low';
    else fLevel = 'low';
  }

  let iceLevel = 'none';
  if(Number.isFinite(t) && t <= (Number.isFinite(t0) ? t0 : 0) && Number.isFinite(rr) && rr > 0){
    iceLevel = 'high';
  }else if(Number.isFinite(t) && t <= 1){
    iceLevel = 'med';
  }else{
    iceLevel = 'low';
  }

  const frostTempEl = document.getElementById('frostTempNow');
  if(frostTempEl) frostTempEl.textContent = Number.isFinite(t) ? __fmt(t,' Â°C') : 'â€”';
  const frostChillEl = document.getElementById('frostChillNow');
  if(frostChillEl) frostChillEl.textContent = Number.isFinite(chill) ? __fmt(chill,' Â°C') : 'â€”';
  const frostRiskEl = document.getElementById('frostRisk');
  if(frostRiskEl) frostRiskEl.innerHTML = __riskLabel(fLevel);
  const iceRiskEl = document.getElementById('iceRisk');
  if(iceRiskEl) iceRiskEl.innerHTML = __riskLabel(iceLevel, (Number.isFinite(rr) ? `(Ï…ÎµÏ„ÏŒÏ‚ ${__fmt(rr,' mm/h')})` : ''));
}
}


/* ====== Scenario UI helper: show 'â€”' when no scenario is selected (dropdown on placeholder) ====== */
function setScenarioSummaryPlaceholder(isPlaceholder){
  try{
    const root = document.getElementById('scenarioArea');
    if(!root) return;

    // restore default names
    root.querySelectorAll('.scenario-name[data-scn-name]').forEach(el=>{
      const base = (el.dataset && el.dataset.scnName) ? el.dataset.scnName : null;
      if(base != null) el.textContent = base;
    });

    if(isPlaceholder){
      const active = root.querySelector('.scenario-panel.active .scenario-name[data-scn-name]');
      if(active) active.textContent = 'â€”';
    }
  }catch(_){}
}

// ====== Scenario dropdown: becomes green only after user selection ======
const LS_MODEL_SCENARIO = 'NIREAS_MODEL_SCENARIO';
const LS_MODEL_SCENARIO_TOUCHED = 'NIREAS_MODEL_SCENARIO_TOUCHED';

function loadScenarioState(){
  const sel = document.getElementById('modelScenario');
  if(!sel) return;

  // Always start with the initial (placeholder) indication when NIREAS opens
  sel.value = '';
  sel.classList.remove('scenario-active');

  // Default scenario logic (keeps panels/outputs consistent) until user picks something
  setModelScenario('rain');

  
  try{ setScenarioSummaryPlaceholder(true); }catch(_){ }
// Clear persisted "touched/selected" so the dropdown stays neutral on every fresh open
  try{
    localStorage.removeItem(LS_MODEL_SCENARIO);
    localStorage.removeItem(LS_MODEL_SCENARIO_TOUCHED);
  }catch(e){}
}

function onScenarioChange(sel){
  if(!sel) return;

  const v = String(sel.value || '');

  // Placeholder selected -> keep initial (grey) look and clear persisted selection
  if(!v){
    setModelScenario('rain');
    sel.classList.remove('scenario-active');
    
    try{ setScenarioSummaryPlaceholder(true); }catch(_){ }
try{
      localStorage.removeItem(LS_MODEL_SCENARIO);
      localStorage.removeItem(LS_MODEL_SCENARIO_TOUCHED);
    }catch(e){}
    return;
  }

  setModelScenario(v);


  try{ setScenarioSummaryPlaceholder(false); }catch(_){ }

  // Turn green only after the user actively makes a choice
  sel.classList.add('scenario-active');
  try{
    localStorage.setItem(LS_MODEL_SCENARIO, v);
    localStorage.setItem(LS_MODEL_SCENARIO_TOUCHED, '1');
  }catch(e){}
}


/* ===== Local Scenario toggle (for future local parameters) ===== */
let LOCAL_SCENARIO_ON = false;

function updateLocalScenarioBtn(){
  const btn = document.getElementById('btnLocalScenario');
  const cb  = document.getElementById('localScenarioToggle');
  if(cb) LOCAL_SCENARIO_ON = !!cb.checked;

  if(btn){
    btn.classList.toggle('btn-local-on', LOCAL_SCENARIO_ON);
    btn.classList.toggle('btn-local-off', !LOCAL_SCENARIO_ON);
    btn.textContent = LOCAL_SCENARIO_ON ? 'Local Scenario ON' : 'Local Scenario OFF';
  }
  document.body.dataset.localScenario = LOCAL_SCENARIO_ON ? 'on' : 'off';
}

function toggleLocalScenario(){
  const cb  = document.getElementById('localScenarioToggle');
  if(cb){
    cb.checked = !cb.checked;
    try{ cb.dispatchEvent(new Event('change', {bubbles:true})); }catch(_){}
  }else{
    LOCAL_SCENARIO_ON = !LOCAL_SCENARIO_ON;
  }
  updateLocalScenarioBtn();
  setStationMsg(LOCAL_SCENARIO_ON ? 'Local Scenario: ON' : 'Local Scenario: OFF');
}





/* ===== Reset Parameters (Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹) to defaults ===== */
function resetParametersToDefaults(){
  // 1) Scenario dropdown back to placeholder (keeps internal default scenario as rain)
  try{
    const sel = document.getElementById('modelScenario');
    if(sel){
      sel.value = '';
      onScenarioChange(sel);
    }else{
      try{ setModelScenario('rain'); }catch(_){}
    }
  }catch(_){}

  // 2) Clear Coâ€‘Hazards selections
  try{
    if(typeof window.clearCoHazards === 'function') window.clearCoHazards();
  }catch(_){}

  // 3) Live OFF
  try{
    if(typeof stationLiveOn !== 'undefined' && stationLiveOn) toggleLive();
  }catch(_){}

  // 4) Local Scenario OFF
  try{
    const cb = document.getElementById('localScenarioToggle');
    if(cb) cb.checked = false;
    LOCAL_SCENARIO_ON = false;
    updateLocalScenarioBtn();
  }catch(_){}

  // 5) AI provider back to ChatGPT
  try{ setAITarget('chatgpt'); }catch(_){}

  // Persist UI (if enabled)
  try{ scheduleSaveUiState(); }catch(_){}

  try{ setStationMsg('Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹: ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚.'); }catch(_){}
}


/* ===================== RESET HELPERS (per-line resets) ===================== */
function resetPrimaryStationQuick(){
  try{
    ACTIVE_PRIMARY_URL = '';
    ACTIVE_PRIMARY_NAME = '';
    try{ refreshSelectedMeteoMarkers(); }catch(_){ }
    const sel = document.getElementById('meteoStationSelect');
    if(sel){
      sel.value = '';
      sel.dispatchEvent(new Event('change'));
    }
    // Clear main station display
    setTxt('stationName','â€”');
    setTxt('stationTimestamp','â€”');
    setTxt('stationTimestampInline','â€”');
    try{ updateStationFreshnessUI(); }catch(_){}
    try{ updatePrimaryMetaCoords(); }catch(_){}
    setTxt('stationRainRate','â€”');
    setTxt('stationDP','â€”');
    setTxt('stationR60','â€”');
    try{ setLatestValuesDisplay(null,'â€”'); }catch(_){}
    try{ setStationMsg('â€”'); }catch(_){}
    try{ switchSeriesContext('open-meteo'); }catch(_){}
    try{
      if(typeof watchlist !== 'undefined' && watchlist && watchlist.size){
        updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (ÎºÎ±Î¸Î±ÏÎ¯ÏƒÏ„Î·ÎºÎµ)', 'neutral');
      }else{
        updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
      }
    }catch(_){}
  }catch(e){
    console.warn('resetPrimaryStationQuick failed', e);
  }
}

function resetSelectedBoundary(){
  try{
    SELECTED_BOUNDARY_GEO = null;
    SELECTED_BOUNDARY_KEY = null;
    SELECTED_BOUNDARY_NAME = null;
    try{ setSelectedBoundaryLabel(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedBoundary failed', e); }
}

function resetSelectedStream(){
  try{
    SELECTED_STREAM_GEO = null;
    SELECTED_STREAM_KEY = null;
    SELECTED_STREAM_NAME = null;
    try{ setSelectedStreamLabel(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedStream failed', e); }
}

function resetSelectedZone(){
  try{
    SELECTED_BASIN_KEY = null;
    SELECTED_ZONE_KEY = null;
    SELECTED_ZONE_NAME = null;
    SELECTED_ZONE_KIND = null;
    try{ setSelectedZoneLabels(null); }catch(_){}
    try{ if(typeof scheduleSaveUiState==='function') scheduleSaveUiState(); }catch(_){}
  }catch(e){ console.warn('resetSelectedZone failed', e); }
}

function resetScenarioPanel(panelId){
  try{
    const root = document.getElementById(panelId);
    if(!root) return;

    // Reset standard form controls to their default values
    root.querySelectorAll('input, select, textarea').forEach(el=>{
      try{
        const tag = (el.tagName||'').toUpperCase();
        if(tag === 'SELECT'){
          const opts = Array.from(el.options||[]);
          const di = opts.findIndex(o=>o.defaultSelected);
          el.selectedIndex = (di>=0) ? di : 0;
        }else if(el.type === 'checkbox' || el.type === 'radio'){
          el.checked = el.defaultChecked;
        }else{
          el.value = el.defaultValue;
        }
        el.dispatchEvent(new Event('input', {bubbles:true}));
        el.dispatchEvent(new Event('change', {bubbles:true}));
      }catch(_){}
    });

    // Special: reset manual stream y (if present)
    try{ if(typeof resetStrY === 'function' && root.querySelector('#strY')) resetStrY(); }catch(_){}

    // Recompute / refresh UI
    try{ if(typeof runMasterCalculation==='function') runMasterCalculation(); }catch(_){}
    try{ if(typeof refreshScenarioPanels==='function') refreshScenarioPanels(); }catch(_){}
  }catch(e){
    console.warn('resetScenarioPanel failed', e);
  }
}
/* ===================== /RESET HELPERS ===================== */





/* ===================== UI PERSISTENCE (keep values on refresh) ===================== */
const LS_UI_STATE_KEY = 'nireas_ui_state_v1';

let __uiSaveTimer = null;
function scheduleSaveUiState(){
  if(__uiSaveTimer) clearTimeout(__uiSaveTimer);
  __uiSaveTimer = setTimeout(saveUiStateNow, 250); // debounce
}

function getSavedUiState(){
  try{
    const raw = localStorage.getItem(LS_UI_STATE_KEY);
    if(!raw) return null;
    const st = JSON.parse(raw);
    return (st && typeof st === 'object') ? st : null;
  }catch(_){
    return null;
  }
}

function saveUiStateNow(){
  try{
    const state = {};

    // Save all inputs/selects/textareas that have an id
    document.querySelectorAll('input[id], select[id], textarea[id]').forEach(el => {
      const tag = el.tagName.toLowerCase();
      const type = (el.type || '').toLowerCase();

      // skip buttons
      if(tag === 'input' && (type === 'button' || type === 'submit' || type === 'reset')) return;

      if(type === 'checkbox' || type === 'radio'){
        state[el.id] = { t: type, v: !!el.checked };
      }else{
        state[el.id] = { t: 'value', v: el.value };
      }

      // keep manual flag for strY
      if(el.id === 'strY'){
        state.__strYManual = (el.dataset.manual === 'true');
      }
    });

    // Save selected zone (basin/boundary) + visible layers (GeoJSON project state)
    state.__selectedZoneKey = SELECTED_BASIN_KEY || null;
    state.__selectedZoneName = SELECTED_ZONE_NAME || document.getElementById('selectedBasinName')?.innerText || null;
    state.__selectedZoneKind = (SELECTED_BASIN_KEY ? 'basin' : null);
    state.__selectedBoundaryKey = SELECTED_BOUNDARY_KEY || null;
    state.__selectedBoundaryName = SELECTED_BOUNDARY_NAME || document.getElementById('selectedBoundaryName')?.innerText || null;
    state.__selectedStreamKey = SELECTED_STREAM_KEY || null;
    state.__selectedStreamName = SELECTED_STREAM_NAME || document.getElementById('selectedStreamName')?.innerText || null;

    // backward compatibility (older state keys)
    state.__selectedBasinKey = SELECTED_BASIN_KEY || null;
    state.__selectedBasinName = document.getElementById('selectedBasinName')?.innerText || null;
    state.__visiblePaths = Array.from(VISIBLE || []);
    state.__meteoStationsVisible = !!METEO_STATIONS_VISIBLE;


    localStorage.setItem(LS_UI_STATE_KEY, JSON.stringify(state));
  }catch(_){}
}

function restoreUiStateEarly(){
  // Only things needed BEFORE renderFileList(): VISIBLE (On/Off buttons)
  const st = getSavedUiState();
  if(!st) return;

  if(Array.isArray(st.__visiblePaths)){
    try{
      VISIBLE.clear();
      st.__visiblePaths.forEach(p => { if(p) VISIBLE.add(String(p)); });
    }catch(_){}
  }
  // restore selected meteo stations layer state
  if(typeof st.__meteoStationsVisible === 'boolean'){
    METEO_STATIONS_VISIBLE = !!st.__meteoStationsVisible;
  }

}

function restoreUiFieldsFromState(st){
  const pendingSelects = [];
  const selectsToNotify = [];

  for(const [id, pack] of Object.entries(st)){
    if(id.startsWith('__')) continue;

    const el = document.getElementById(id);
    if(!el) continue;

    const tag = el.tagName.toLowerCase();
    const type = (el.type || '').toLowerCase();

    const t = (pack && typeof pack === 'object' && 't' in pack) ? pack.t : 'value';
    const v = (pack && typeof pack === 'object' && 'v' in pack) ? pack.v : pack;

    if(t === 'checkbox' || t === 'radio'){
      el.checked = !!v;
    }else{
      const val = String(v ?? '');
      if(tag === 'select'){
        const hasOpt = Array.from(el.options).some(o => o.value === val);
        if(!hasOpt) pendingSelects.push({ el, val });
        else el.value = val;
        selectsToNotify.push(el);
      }else{
        el.value = val;
      }
    }

    if(id === 'strY'){
      if(st.__strYManual) el.dataset.manual = 'true';
      else delete el.dataset.manual;
    }
  }

  // apply deferred selects now, and later once options are populated
  window.__NIREAS_PENDING_SELECTS = pendingSelects;
  window.__NIREAS_SELECTS_TO_NOTIFY = selectsToNotify;
  applyPendingRestores();
}

function applyPendingRestores(retries=6){
  const pending = window.__NIREAS_PENDING_SELECTS || [];
  if(pending.length){
    window.__NIREAS_PENDING_SELECTS = pending.filter(({el, val}) => {
      const hasOpt = Array.from(el.options).some(o => o.value === val);
      if(hasOpt) el.value = val;
      return !hasOpt;
    });
  }

  const notify = window.__NIREAS_SELECTS_TO_NOTIFY || [];
  if(notify.length){
    notify.forEach(el => {
      try{ el.dispatchEvent(new Event('change', { bubbles:true })); }catch(_){}
    });
    window.__NIREAS_SELECTS_TO_NOTIFY = [];
  }

  // If selects weren't ready yet, retry a few times (stations/lists load async)
  const remaining = (window.__NIREAS_PENDING_SELECTS || []).length;
  if(remaining && retries > 0){
    setTimeout(()=> applyPendingRestores(retries-1), 350);
  }
}

async function restoreUiStateLate(){
  // Restore last selected basin (GeoJSON) + all fields
  const st = getSavedUiState();
  if(!st) return;

  // 1) Restore last selections:
  //    - "Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·" Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¹Î¼Î® ÎœÎŸÎÎŸ Î±Ï€ÏŒ basins
  //    - "Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±" Ï€Î±Î¯ÏÎ½ÎµÎ¹ Ï„Î¹Î¼Î® ÎœÎŸÎÎŸ Î±Ï€ÏŒ boundaries
  const basinKey = st.__selectedBasinKey
    || (st.__selectedZoneKey && String(st.__selectedZoneKey).includes('data/basins/') ? st.__selectedZoneKey : null);

  const basinName = st.__selectedBasinName || st.__selectedZoneName || null;

  if(basinKey){
    try{
      const key = String(basinKey);
      const name = basinName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedZoneLabels(name); }catch(_){}
        SELECTED_BASIN_KEY = key;
        SELECTED_ZONE_KEY = key;
        SELECTED_ZONE_NAME = name;
        SELECTED_ZONE_KIND = 'basin';
      }
    }catch(_){}
  } else if(basinName){
    try{ setSelectedZoneLabels(basinName); }catch(_){}
  }

  const boundaryKey = st.__selectedBoundaryKey
    || (st.__selectedZoneKey && String(st.__selectedZoneKey).includes('data/boundaries/') ? st.__selectedZoneKey : null);

  const boundaryName = st.__selectedBoundaryName || null;

  if(boundaryKey){
    try{
      const key = String(boundaryKey);
      const name = boundaryName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedBoundaryLabel(name); }catch(_){}
        SELECTED_BOUNDARY_KEY = key;
        SELECTED_BOUNDARY_NAME = name;
      }
    }catch(_){}
  } else if(boundaryName){
    try{ setSelectedBoundaryLabel(boundaryName); }catch(_){}
  }


  const streamKey = st.__selectedStreamKey || null;
  const streamName = st.__selectedStreamName || null;

  if(streamKey){
    try{
      const key = String(streamKey);
      const name = streamName || key.split('/').pop().replace('.geojson','');
      if(typeof loadToTool === 'function'){
        await loadToTool(key, name);
      }else{
        try{ setSelectedStreamLabel(name); }catch(_){}
        SELECTED_STREAM_KEY = key;
        SELECTED_STREAM_NAME = name;
      }
    }catch(_){}
  } else if(streamName){
    try{ setSelectedStreamLabel(streamName); }catch(_){}
  }

  // Restore last selected administrative boundary (independent from the main zone)
  try{
    if(st.__selectedBoundaryKey){
      SELECTED_BOUNDARY_KEY = String(st.__selectedBoundaryKey);
      const nm = st.__selectedBoundaryName || SELECTED_BOUNDARY_KEY.split('/').pop().replace('.geojson','');
      SELECTED_BOUNDARY_NAME = nm;
      setSelectedBoundaryLabel(nm);
    }else if(st.__selectedBoundaryName){
      SELECTED_BOUNDARY_NAME = String(st.__selectedBoundaryName);
      setSelectedBoundaryLabel(SELECTED_BOUNDARY_NAME);
    }
  }catch(_){}




  // Restore last selected hydrographic network (independent)
  try{
    if(st.__selectedStreamKey){
      SELECTED_STREAM_KEY = String(st.__selectedStreamKey);
      const nm = st.__selectedStreamName || SELECTED_STREAM_KEY.split('/').pop().replace('.geojson','');
      SELECTED_STREAM_NAME = nm;
      setSelectedStreamLabel(nm);
    }else if(st.__selectedStreamName){
      SELECTED_STREAM_NAME = String(st.__selectedStreamName);
      setSelectedStreamLabel(SELECTED_STREAM_NAME);
    }
  }catch(_){}

  // 2) Restore all tool fields
  restoreUiFieldsFromState(st);

  // 3) Re-render file list so On/Off buttons match (in case state loaded after first render)
  try{ renderFileList(); }catch(_){}
  try{ updateMeteoStationsRowButton(); }catch(_){}

  // 4) Ensure calculations reflect restored values
  try{ runMasterCalculation(); }catch(_){}
  try{ drawBasinPlan(); }catch(_){}
}

function bindPersistenceOnce(){
  if(window.__NIREAS_PERSIST_BOUND) return;
  window.__NIREAS_PERSIST_BOUND = true;

  // Save on any field change (captures most UI)
  document.addEventListener('input', (ev)=>{ if(ev.target && ev.target.id) scheduleSaveUiState(); }, true);
  document.addEventListener('change', (ev)=>{ if(ev.target && ev.target.id) scheduleSaveUiState(); }, true);

  // Ensure strY becomes manual when user types (bound once)
  const strYEl = document.getElementById('strY');
  if(strYEl && strYEl.dataset.boundManual !== '1'){
    strYEl.dataset.boundManual = '1';
    strYEl.addEventListener('input', ()=>{ strYEl.dataset.manual = 'true'; scheduleSaveUiState(); });
  }
}
/* =================== /UI PERSISTENCE =================== */


function setCustomMsg(msg){
  const el = document.getElementById('customStationMsg');
  if(el) el.textContent = msg;
}

function saveWatchlist(){
  try{
    const arr = Array.from(watchlist.entries()).map(([url,name]) => ({url, name}));
    localStorage.setItem(LS_WATCHLIST_KEY, JSON.stringify(arr));
  }catch(e){}
}

function loadWatchlist(){
  try{
    const raw = localStorage.getItem(LS_WATCHLIST_KEY);
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return;
    watchlist.clear();
    for(const it of arr){
      if(it && it.url){
        watchlist.set(String(it.url), String(it.name || it.url));
      }
    }
  }catch(e){}
}

function getCustomStations(){
  try{
    const raw = localStorage.getItem(LS_CUSTOM_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}

function saveCustomStations(arr){
  try{
    localStorage.setItem(LS_CUSTOM_KEY, JSON.stringify(arr || []));
  }catch(e){}
}

function ensureCustomOptgroup(selectEl){
  if(!selectEl) return null;
  // try to find existing optgroup by label
  const groups = Array.from(selectEl.querySelectorAll('optgroup'));
  let grp = groups.find(g => (g.label || '').toLowerCase().includes('custom'));
  if(!grp){
    grp = document.createElement('optgroup');
    grp.label = 'Custom (Local)';
    selectEl.appendChild(grp);
  }
  return grp;
}

function upsertCustomOption(name, url){
  const normalized = normalizeStationUrl(url);
  if(!normalized) return;

  const ids = ['meteoStationSelect','monitorStationSelect'];
  ids.forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;

    const existing = Array.from(sel.options).find(o => o.value === normalized);
    if(existing){
      if(name && existing.textContent !== name) existing.textContent = name;
      return;
    }

    const grp = ensureCustomOptgroup(sel);
    const opt = document.createElement('option');
    opt.value = normalized;
    opt.textContent = (name || normalized.replace(/^https?:\/\//i,'').slice(0,60));
    opt.dataset.from = 'local';
    grp.appendChild(opt);
  });
}

function loadCustomStationsIntoSelect(){
  const list = getCustomStations();
  if(!list.length) return;
  for(const it of list){
    if(!it || !it.url) continue;
    upsertCustomOption(it.name || '', it.url);
  }
}

function addCustomStation(){
  const nameEl = document.getElementById('customStationName');
  const urlEl  = document.getElementById('customStationUrl');
  const name = (nameEl?.value || '').trim();
  const urlRaw = (urlEl?.value || '').trim();
  if(!urlRaw){
    setCustomMsg('Î”ÏÏƒÎµ URL ÏƒÏ„Î±Î¸Î¼Î¿Ï.');
    return;
  }
  const url = normalizeStationUrl(urlRaw);
  if(!url){
    setCustomMsg('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ URL.');
    return;
  }

  // save to custom list
  const list = getCustomStations();
  const exists = list.some(x => String(x?.url||'') === url);
  if(!exists){
    list.push({name: name || url.replace(/^https?:\/\//i,'').slice(0,60), url});
    saveCustomStations(list);
  }

  // also add to dropdown + watchlist immediately
  upsertCustomOption(name, url);
  watchlist.set(url, name || url.replace(/^https?:\/\//i,'').slice(0,60));
  renderWatchlist();
  saveWatchlist();

  // clear inputs
  if(nameEl) nameEl.value = '';
  if(urlEl) urlEl.value = '';

  setCustomMsg('âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ (Ï„Î¿Ï€Î¹ÎºÎ¬).');

  // immediately fetch to show data (extras only)
  fetchStationData('extras');
}


let stationLiveTimer = null;
let stationFreshnessTimer = null;
let lastStationPayload = null;

// Hardening: clean up timers + catch unhandled async errors
window.addEventListener('pagehide', () => {
  try{ if(stationLiveTimer){ clearInterval(stationLiveTimer); stationLiveTimer = null; }
       if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); stationFreshnessTimer = null; }
  }catch(_){}
});
window.addEventListener('beforeunload', () => {
  try{ if(stationLiveTimer){ clearInterval(stationLiveTimer); stationLiveTimer = null; }
       if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); stationFreshnessTimer = null; }
  }catch(_){}
});
window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  try{
    updateMeteoStatus('Î£Ï†Î¬Î»Î¼Î± (promise). Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ Î¾Î±Î½Î¬.');
    setStationMsg('Î£Ï†Î¬Î»Î¼Î±: ' + (event.reason?.message || String(event.reason || 'unknown')));
  }catch(_){}
  event.preventDefault();
});

/* ===================== UI HELPERS ===================== */
function toggleCollapse(id, btn){
  const el = document.getElementById(id);
  if(!el) return;
  const isHidden = el.classList.toggle('collapsed');
  if(btn) btn.textContent = isHidden ? '+' : 'âˆ’';
}

function setStatusById(id, msg, level='neutral'){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerText = msg;
  el.classList.remove('status-ok','status-warn','status-neutral');
  if(level==='ok') el.classList.add('status-ok');
  else if(level==='warn') el.classList.add('status-warn');
  else el.classList.add('status-neutral');
}
function updatePrimaryStatus(msg, level='neutral'){
  setStatusById('primaryStatus', msg, level);
}
function updateExtrasStatus(msg, level='neutral'){
  setStatusById('extrasStatus', msg, level);
}
// backward compatibility (sets both)
function updateMeteoStatus(msg, level='neutral'){
  // Optional informational message area for the METEO section.
  // HIDDEN by default to avoid a lone "â€”" separator.
  // Shows only for warnings/errors (does NOT touch the two independent status pills).
  const el = document.getElementById('meteoMsg');
  if(!el) return;

  const t = (msg == null) ? '' : String(msg).trim();
  const shouldShow = !!t && t !== 'â€”' && (
    level === 'warn' ||
    /Î£Ï†Î¬Î»Î¼Î±/i.test(t) ||
    /Î”ÎµÎ½\s+Î²ÏÎ­Î¸Î·ÎºÎ±Î½/i.test(t) ||
    /promise/i.test(t)
  );

  if(shouldShow){
    el.textContent = t;
    el.style.display = 'block';
  }else{
    el.textContent = '';
    el.style.display = 'none';
  }
}
function setStationMsg(msg){
  const el = document.getElementById('stationMsg');
  if(el) el.innerText = msg;
}
function setTxt(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; if(id==='stationName'||id==='stationTimestampInline'||id==='stationLat'||id==='stationLon'||id==='stationElev') updateSeriesSummaryName(); }

/* ===== Clear/Reset confirmations (UI vs DB) =====
   Î£Ï„ÏŒÏ‡Î¿Ï‚: Î­Î½Î± "Clear" Î±Î½Î¬ section, Î¼Îµ Î¼Î¯Î½Î¹ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï€Î¿Ï… ÎµÎ¾Î·Î³ÎµÎ¯ Î¤Î™ ÎºÎ±Î¸Î±ÏÎ¯Î¶ÎµÏ„Î±Î¹.
   Î£Î·Î¼.: Î¤Î± Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Î”Î•Î Î´Î¹Î±Î³ÏÎ¬Ï†Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Firestore. ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ UI/buffer/Ï€ÏÎ¿Î²Î¿Î»Î®. */
function __confirmClear(title, lines, note){
  const footer = note || "Î£Î·Î¼.: Î”ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î± Î±Ï€ÏŒ Ï„Î· Î’Î¬ÏƒÎ· (DB). ÎšÎ±Î¸Î±ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î¼ÏŒÎ½Î¿ Î· Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Î¼Î½Î®Î¼Î·/Ï€ÏÎ¿Î²Î¿Î»Î® ÏƒÏ„Î¿Î½ browser.";
  const body = (Array.isArray(lines) ? lines : [String(lines||'')]).join("\n");
  const msg = `${title}\n\n${body}\n\n${footer}`;
  return confirm(msg);
}

function confirmAndClearSeriesFiltersUI(){
  const ok = __confirmClear(
    "Clear â€“ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎšÏÏÎ¹Î¿Ï… Î£Ï„Î±Î¸Î¼Î¿Ï (UI)",
    [
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î® Ï†Î¯Î»Ï„ÏÏ‰Î½.",
      "â€¢ Î˜Î± Î±Î´ÎµÎ¹Î¬ÏƒÎµÎ¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚.",
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„ÎµÎ¯ Î· Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î® Ï‡ÏÎ¿Î½Î¿ÏƒÎµÎ¹ÏÎ¬ (buffer) Ï„Î¿Ï… ÎµÎ½ÎµÏÎ³Î¿Ï ÎºÏÏÎ¹Î¿Ï… ÏƒÏ„Î±Î¸Î¼Î¿Ï."
    ]
  );
  if(!ok) return;
  clearSeriesFiltersUI();
}

function confirmAndClearDbFiltersUI(){
  const ok = __confirmClear(
    "Clear â€“ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î±Ï€ÏŒ Î’Î¬ÏƒÎ· (DB) (Î ÏÎ¿Î²Î¿Î»Î®)",
    [
      "â€¢ Î˜Î± ÎºÎ±Î¸Î±ÏÎ¹ÏƒÏ„Î¿ÏÎ½ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î· Î³ÏÎ±Î¼Î¼Î® Ï†Î¯Î»Ï„ÏÏ‰Î½.",
      "â€¢ Î˜Î± Î±Î´ÎµÎ¹Î¬ÏƒÎµÎ¹ Î¿ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Ï€ÏÎ¿Î²Î¿Î»Î®Ï‚ (cached rows)."
    ],
    "Î£Î·Î¼.: Î”ÎµÎ½ Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÏ„Î±Î¹ Ï„Î¯Ï€Î¿Ï„Î± Î±Ï€ÏŒ Ï„Î· Î’Î¬ÏƒÎ· (DB). Î‘Ï€Î»ÏÏ‚ ÎºÎ±Î¸Î±ÏÎ¯Î¶ÎµÎ¹ Î· Ï€ÏÎ¿Î²Î¿Î»Î®/Ï†Î¯Î»Ï„ÏÎ± ÏƒÏ„Î¿ UI."
  );
  if(!ok) return;
  clearDbFiltersUI();
}



/* ===== Station freshness (timestamp age) ===== */
function parseGreekDateTime(ts){
  if(!ts) return null;
  const s = String(ts).trim();
  if(!s || s==='â€”') return null;
  const parts = s.split(',');
  const dpart = (parts[0]||'').trim();
  const tpart = (parts[1]||'').trim();
  const d = dpart.split('/').map(n=>parseInt(n,10));
  const t = tpart.split(':').map(n=>parseInt(n,10));
  if(d.length<3 || isNaN(d[0]) || isNaN(d[1]) || isNaN(d[2])) return null;
  const dd=d[0], mm=d[1], yy=d[2];
  const HH=t[0]||0, MM=t[1]||0, SS=t[2]||0;
  const dt = new Date(yy, mm-1, dd, HH, MM, SS);
  if(isNaN(dt.getTime())) return null;
  return dt;
}

function ageClassFromTimestamp(tsStr){
  const dt = parseGreekDateTime(tsStr);
  if(!dt) return 'age-unknown';
  let diffMin = (Date.now() - dt.getTime()) / 60000;
  if(diffMin < 0) diffMin = 0;
  if(diffMin < 5) return 'age-fresh';
  if(diffMin < 10) return 'age-warn';
  return 'age-stale';
}

function updateStationFreshnessUI(){
  const nameEl = document.getElementById('stationName');
  if(!nameEl) return;

  nameEl.classList.remove('age-fresh','age-warn','age-stale','age-unknown');

  const tsStr = (document.getElementById('stationTimestamp')?.textContent || '').trim();
  const dt = parseGreekDateTime(tsStr);
  if(!dt){
    nameEl.classList.add('age-unknown');
    return;
  }
  let diffMin = (Date.now() - dt.getTime()) / 60000;
  if(diffMin < 0) diffMin = 0;

  if(diffMin < 5) nameEl.classList.add('age-fresh');
  else if(diffMin < 10) nameEl.classList.add('age-warn');
  else nameEl.classList.add('age-stale')
  try{ refreshScenarioPanels(); }catch(_){}
;
}

function startStationFreshnessTimer(){
  try{
    if(stationFreshnessTimer){ clearInterval(stationFreshnessTimer); }
    updateStationFreshnessUI();
    stationFreshnessTimer = setInterval(updateStationFreshnessUI, 30*1000);
  }catch(_){}
}
function updateSeriesSummaryName(){
  // Keep the Primary History header (monitoring table) in sync with the active PRIMARY station
  const name = (document.getElementById('stationName')?.textContent || '').trim();
  setTxt('seriesStationName', (name && name!=='â€”') ? name : 'â€”');

  const ts = (document.getElementById('stationTimestampInline')?.textContent || '').trim();
  setTxt('seriesTimestampInline', (ts && ts!=='â€”') ? ts : 'â€”');

  const lat = (document.getElementById('stationLat')?.textContent || '').trim();
  const lon = (document.getElementById('stationLon')?.textContent || '').trim();
  const elev = (document.getElementById('stationElev')?.textContent || '').trim();
  setTxt('seriesLat',  (lat  && lat!=='â€”')  ? lat  : 'â€”');
  setTxt('seriesLon',  (lon  && lon!=='â€”')  ? lon  : 'â€”');
  setTxt('seriesElev', (elev && elev!=='â€”') ? elev : 'â€”');
}

// --- Station series context helpers (per *active* primary station) ---
// Active primary station applies ONLY after the user presses â•
function getPrimaryStationUrl(){
  return ACTIVE_PRIMARY_URL || '';
}
function getPrimaryStationName(){
  return ACTIVE_PRIMARY_NAME || '';
}
// Pending (dropdown) selection - not applied until â•
function getPendingPrimaryUrl(){
  return document.getElementById('meteoStationSelect')?.value || '';
}
function getPendingPrimaryName(){
  const sel = document.getElementById('meteoStationSelect');
  const url = sel?.value || '';
  if(!sel || !url) return '';
  return (sel.options[sel.selectedIndex]?.textContent || url).trim();
}
function getPrimaryStationKey(){
  const url = getPrimaryStationUrl();
  if(!url || url === OPEN_METEO_TOKEN) return 'open-meteo';
  return `url:${url}`;
}

function switchSeriesContext(newKey){
  const key = newKey || 'open-meteo';

  // save current context
  stationSeriesByKey[currentStationKey] = stationSeries;
  stationLastKeyByKey[currentStationKey] = stationLastKey;

  // load new context
  currentStationKey = key;
  stationSeries = stationSeriesByKey[currentStationKey] || [];
  stationLastKey = stationLastKeyByKey[currentStationKey]
    || (stationSeries.length ? stationSeries[stationSeries.length-1].key : null);

  // ensure stored
  stationSeriesByKey[currentStationKey] = stationSeries;
  stationLastKeyByKey[currentStationKey] = stationLastKey;

  // refresh readouts + list for the currently selected station
  updateStationReadouts();
}

function switchPrimarySeriesContext(){
  switchSeriesContext(getPrimaryStationKey());
}

function isFiniteNumber(x){ return typeof x === 'number' && isFinite(x); }
function num(val){
  if(val==null) return 0;
  const n = (typeof val === 'number') ? val : parseFloat(String(val).replace(',','.'));
  return isFiniteNumber(n) ? n : 0;
}
function getVal(id){ return num(document.getElementById(id)?.value); }
function setVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  el.value = (v==null) ? "" : v;
}

function debounce(fn, wait=150){
  let t = null;
  return function(...args){
    if(t) clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}


/* ===================== GITHUB LOAD ===================== */
async function init(){
  document.getElementById('loader').style.display = 'block';
  try{
    const resp = await fetch(API_TREE);
    const data = await resp.json();
    if(data.message) throw new Error(data.message);

    const files = data.tree || [];

    // IMPORTANT: paths based on your current repo layout (from previous versions)
    // data/boundaries, data/streams, data/basins
    DATA_GROUPS.boundaries = files.filter(f => f.path.includes('data/boundaries/') && f.path.endsWith('.geojson'));
    DATA_GROUPS.streams    = files.filter(f => (f.path.includes('data/streams/') || f.path.includes('streams/geojson/')) && f.path.endsWith('.geojson'));
    DATA_GROUPS.basins     = files.filter(f => f.path.includes('data/basins/')     && f.path.endsWith('.geojson'));

    restoreUiStateEarly();
    initAIAnalysisUI();
    updateMeteoStationsRowButton();
    renderFileList();

    // Auto-populate stations dropdown from folder structure:
// - data/meteostations/api/*.txt      -> API / JSON
// - data/meteostations/weblinks/*.txt -> Web Links
const loaded = await fetchStationsFromFolders(files);

if(!loaded){
  // Backward-compatible fallback (older layouts)
  const stationFile =
    files.find(f => f.path === 'data/meteostations/weblinks/stations.txt') ||
    files.find(f => f.path.endsWith('/stations.txt') || f.path.endsWith('stations.txt')) ||
    files.find(f => f.path.endsWith('openmeteo.txt')) ||
    files.find(f => f.path.endsWith('ecmwf.txt'));

  if(stationFile) await fetchStations(stationFile.path);
  else {
    updateMeteoStatus("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î±Î¸Î¼ÏÎ½ (.txt) ÏƒÎµ data/meteostations/api Î® data/meteostations/weblinks");
    // safe fallback: keep dropdown empty
  }
}

    // Restore local custom stations + watchlist (no coding required)
    loadCustomStationsIntoSelect();
    loadWatchlist();
    renderWatchlist();

    // Keep values + selected GeoJSON after refresh
    bindPersistenceOnce();
    await restoreUiStateLate();

    bindInputs();
    runMasterCalculation();
    updateStationButtons();
    initMonitorContentToggle();
    loadScenarioState();
    try{ applyScenarioUI(MODEL_SCENARIO || (document.getElementById('modelScenario')?.value) || 'rain'); }catch(_){}
    try{ refreshScenarioPanels(); }catch(_){}

    updateLocalScenarioBtn();
    startStationFreshnessTimer();

    // If dropdown has a pending selection (but no ACTIVE yet), show "Î±Î½Î±Î¼Î¿Î½Î®"
    const sel = document.getElementById('meteoStationSelect');
    if(sel && sel.value && !getPrimaryStationUrl()){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î‘Î½Î±Î¼Î¿Î½Î®â€¦', 'neutral');
    } else if(!getPrimaryStationUrl()){
      updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: (Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î¹Î»ÎµÎ³ÎµÎ¯)', 'warn');
    }

    // If no ACTIVE primary but watchlist exists, fetch extras immediately to show values
    if(!getPrimaryStationUrl() && watchlist.size){
      fetchStationData('extras');
    }

  }catch(e){
    console.error(e);
    updateMeteoStatus("Î£Ï†Î¬Î»Î¼Î± GitHub: " + e.message);
  }finally{
    document.getElementById('loader').style.display = 'none';
  }
}

function renderFileList(){
  const tbody = document.getElementById('fileRows');
  tbody.innerHTML = '';
  const addCategory = (title, list, icon, color) => {
    const trHead = document.createElement('tr');
    trHead.className = 'cat-row';
    trHead.innerHTML = `<td colspan="2" style="color:${color}">${icon} ${title}</td>`;
    tbody.appendChild(trHead);

    list.forEach(f=>{
      const name = f.path.split('/').pop().replace('.geojson','');
      const tr = document.createElement('tr');

      const on = VISIBLE.has(f.path);
      tr.innerHTML = `
        <td style="text-align:left;padding-left:10px;">${name}</td>
        <td><div class="actions-row">
          <button class="mini-btn btn-load" onclick="loadToTool('${f.path}','${name}')">Load</button>
          <button class="mini-btn btn-map" onclick="previewOnMap('${f.path}','${name}')">Map</button>
          <button class="mini-btn ${on ? 'btn-on' : 'btn-off'}" id="btn-onoff-${cssSafe(f.path)}"
                  onclick="toggleLayer('${f.path}','${name}')">${on ? 'On' : 'Off'}</button>
        </div></td>
      `;
      tbody.appendChild(tr);
    });
  };

  // ORDER REQUESTED: boundaries -> streams -> basins
  addCategory("Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±", DATA_GROUPS.boundaries, "ğŸ³ï¸", "#0f0f0f");
  addCategory("ğŸ’§ Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿", DATA_GROUPS.streams, "ğŸ’§", "#0f0f0f");
  addCategory("Î›ÎµÎºÎ¬Î½ÎµÏ‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚", DATA_GROUPS.basins, "ğŸï¸", "#0f0f0f");
}

function cssSafe(s){
  return btoa(unescape(encodeURIComponent(s))).replace(/=+/g,'').replace(/[+/]/g,'_');
}

async function fetchGeoJSON(path){
  if(GEO_CACHE.has(path)) return GEO_CACHE.get(path);
  const resp = await fetch(RAW_URL + path);
  if(!resp.ok) throw new Error("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ: " + path);
  const json = await resp.json();
  GEO_CACHE.set(path, json);
  return json;
}


function setSelectedZoneLabels(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const ids = ['selectedBasinName','selectedAreaName','selectedHeatAreaName','selectedFrostAreaName'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = v;
  });
}


function setSelectedBoundaryLabel(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const el = document.getElementById('selectedBoundaryName');
  if(el) el.textContent = v;
}


function setSelectedStreamLabel(name){
  const v = (name && String(name).trim()) ? String(name).trim() : 'â€”';
  const el = document.getElementById('selectedStreamName');
  if(el) el.textContent = v;
}

/* ===================== LOAD / MAP / ON-OFF LOGIC ===================== */
async function loadToTool(path, name){
  updateMeteoStatus("Î¦ÏŒÏÏ„Ï‰ÏƒÎ·: " + name + "â€¦");
  try{
    const gj = await fetchGeoJSON(path);

    
    const isBasin = path.includes('data/basins/');
    const isBoundary = path.includes('data/boundaries/');
    const isStream = path.includes('data/streams/') || path.includes('streams/geojson/');

    // Î”Î™ÎŸÎ™ÎšÎ—Î¤Î™ÎšÎ‘ ÎŸÎ¡Î™Î‘: ÎµÎ½Î·Î¼ÎµÏÏÎ½Î¿Î½Ï„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ boundaries (Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Ï…Î½ Ï„Î·Î½ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·)
    if(isBoundary){
      SELECTED_BOUNDARY_GEO = gj;
      SELECTED_BOUNDARY_KEY = path;
      SELECTED_BOUNDARY_NAME = name;
      setSelectedBoundaryLabel(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (Î”Î¹Î¿Î¹ÎºÎ·Ï„Î¹ÎºÎ¬ ÎŒÏÎ¹Î±): ${name}`);
      return;
    }


    // Î¥Î”Î¡ÎŸÎ“Î¡Î‘Î¦Î™ÎšÎŸ Î”Î™ÎšÎ¤Î¥ÎŸ: ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ streams (Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î·Î½ Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï€ÎµÏÎ¹Î¿Ï‡Î®/Î¶ÏÎ½Î·)
    if(isStream){
      SELECTED_STREAM_GEO = gj;
      SELECTED_STREAM_KEY = path;
      SELECTED_STREAM_NAME = name;
      setSelectedStreamLabel(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (Î¥Î´ÏÎ¿Î³ÏÎ±Ï†Î¹ÎºÏŒ Î”Î¯ÎºÏ„Ï…Î¿): ${name}`);
      return;
    }

// Î•Î Î™Î›Î•Î“ÎœÎ•ÎÎ— Î Î•Î¡Î™ÎŸÎ§Î—/Î–Î©ÎÎ—: ÎµÎ½Î·Î¼ÎµÏÏÎ½ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Î±Ï€ÏŒ basins
    if(isBasin){
      SELECTED_GEO = gj;
      SELECTED_ZONE_KEY = path;
      SELECTED_ZONE_NAME = name;
      SELECTED_ZONE_KIND = 'basin';
      SELECTED_BASIN_KEY = path;

      setSelectedZoneLabels(name);
      if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();

      // Populate tool inputs ONLY for basins (Ï…Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±)
      const p = getPropsMerged(gj);

      if(p.area!=null)   setVal('area', p.area);
      if(p.length!=null) setVal('length', p.length);
      if(p.height!=null) setVal('height', p.height);
      if(p.coef!=null)   setVal('coef', p.coef);

      if(p.drains!=null)   setVal('drains', p.drains);
      if(p.drainCap!=null) setVal('drainCap', p.drainCap);

      if(p.strWidth!=null) setVal('strWidth', p.strWidth);
      if(p.strZ!=null)     setVal('strZ', p.strZ);
      if(p.strDepth!=null) setVal('strDepth', p.strDepth);

      if(p.strLen!=null)   setVal('strLen', p.strLen);
      if(p.strDrop!=null)  setVal('strDrop', p.strDrop);

      if(p.strType!=null){
        const restoreSel = document.getElementById('strType');
        const val = String(p.strType);
        if(restoreSel && [...restoreSel.options].some(o=>String(o.value)===val)) restoreSel.value = val;
      }

      // IMPORTANT: do NOT auto-open map; do NOT change On/Off here
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ ÏƒÏ„Î¿ ÎµÏÎ³Î±Î»ÎµÎ¯Î¿ (Î»ÎµÎºÎ¬Î½Î·): ${name}`);

      // Recalculate + redraw (safe even if some values are missing)
      try{ runMasterCalculation(); }catch(_){}
      try{ drawBasinPlan(); }catch(_){}
    } else {
      // non-zone (streams etc): just cache + message
      updateMeteoStatus(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ (cache): ${name}`);
    }


  }catch(e){
    alert("Î£Ï†Î¬Î»Î¼Î±: " + e.message);
    updateMeteoStatus("Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚.");
  }
}

// Map preview: opens map, zooms to that layer, WITHOUT changing On/Off
async function previewOnMap(path, name){
  try{
    openMapModal();
    const gj = await fetchGeoJSON(path);

    // remove old preview
    if(PREVIEW_LAYER && map){
      map.removeLayer(PREVIEW_LAYER);
      PREVIEW_LAYER = null;
    }

    const cat = categoryFromPath(path);
    PREVIEW_LAYER = L.geoJSON(gj, {
      style: styleForCategory(cat, true)
    }).addTo(map);

    try{
      map.fitBounds(PREVIEW_LAYER.getBounds(), { padding:[20,20] });
    }catch(_){}

    // ensure visible layers remain visible (do not alter VISIBLE)
    syncVisibleLayersToMap();
  }catch(e){
    console.error(e);
    alert("Map error: " + e.message);
  }
}

// On/Off toggle: NO map open; NO zoom; just state + map update if map is open
async function toggleLayer(path, name){
  const btn = document.getElementById('btn-onoff-' + cssSafe(path));
  const turningOn = !VISIBLE.has(path);

  if(turningOn) VISIBLE.add(path);
  else VISIBLE.delete(path);

  if(btn){
    btn.textContent = turningOn ? 'On' : 'Off';
    btn.classList.toggle('btn-on', turningOn);
    btn.classList.toggle('btn-off', !turningOn);
  }

  // only update map if already open
  if(map) syncVisibleLayersToMap();

  if(typeof scheduleSaveUiState==='function') scheduleSaveUiState();
}

// Turn everything off
function turnAllOff(){
  VISIBLE.clear();
  METEO_STATIONS_VISIBLE = false;
  updateMeteoStationsRowButton();
  clearMeteoStationsPreview();

  // update buttons
  document.querySelectorAll('button[id^="btn-onoff-"]').forEach(b=>{
    b.textContent = 'Off';
    b.classList.remove('btn-on');
    b.classList.add('btn-off');
  });
  if(map) syncVisibleLayersToMap();
}

/* ===================== MAP MODAL ===================== */
function openMapModal(){
  const modal = document.getElementById('mapModal');
  modal.style.display = 'flex';
  if(!map){
    map = L.map('mapBox', { zoomControl:true });
    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    map.setView([38.02, 23.80], 12);
  }
  setTimeout(()=>map.invalidateSize(), 80);
  syncVisibleLayersToMap();
}

function closeMapModal(){
  const modal = document.getElementById('mapModal');
  modal.style.display = 'none';
  // remove preview layer when closing (keeps On/Off layers persistent)
  if(PREVIEW_LAYER && map){
    map.removeLayer(PREVIEW_LAYER);
    PREVIEW_LAYER = null;
  }
  // remove meteo preview markers
  clearMeteoStationsPreview();
}

function categoryFromPath(path){
  if(path.includes('data/boundaries/')) return 'boundaries';
  if(path.includes('data/streams/') || path.includes('streams/geojson/')) return 'streams';
  return 'basins';
}

function styleForCategory(cat, preview=false){
  if(cat==='boundaries'){
    return { color: preview ? '#e74c3c' : '#c0392b', weight: preview ? 3 : 2, fill:false, dashArray: preview ? '6 4' : null };
  }
  if(cat==='streams'){
    return { color: preview ? '#2ecc71' : '#2980b9', weight: preview ? 4 : 3, fill:false, dashArray: preview ? '6 4' : null };
  }
  // basins
  return { color: preview ? '#27ae60' : '#d35400', weight: preview ? 2 : 2, fill:true, fillOpacity: preview ? 0.12 : 0.18, dashArray: preview ? '6 4' : null };
}

// Ensure map shows exactly all "On" layers (plus preview if present)
async function syncVisibleLayersToMap(){
  if(!map) return;

  // remove cached layers not in VISIBLE
  for(const [path, layer] of LAYER_CACHE.entries()){
    if(!VISIBLE.has(path) && map.hasLayer(layer)){
      map.removeLayer(layer);
    }
  }

  // add layers in VISIBLE
  for(const path of VISIBLE){
    let layer = LAYER_CACHE.get(path);
    if(!layer){
      const gj = await fetchGeoJSON(path);
      const cat = categoryFromPath(path);
      layer = L.geoJSON(gj, { style: styleForCategory(cat, false) });
      LAYER_CACHE.set(path, layer);
    }
    if(!map.hasLayer(layer)) layer.addTo(map);
  }

  // ğŸ“¡ Meteo stations (selected only)
  try{
    await refreshSelectedMeteoMarkers();
  }catch(_){ }

}

/* ===================== PROPERTIES EXTRACTION ===================== */
function getPropsMerged(gj){
  // merge props from FeatureCollection[0].properties or root.properties
  let p = {};
  try{
    if(gj && gj.features && gj.features[0] && gj.features[0].properties){
      p = {...gj.features[0].properties};
    } else if(gj && gj.properties){
      p = {...gj.properties};
    }
  }catch(_){}

  // normalize keys commonly used
  // area
  const area = pickNumber(p, ['A','a','area','Area','A_m2','area_m2','AREA_M2']);
  const length = pickNumber(p, ['L','l','length','Length','L_m','length_m','LEN_M']);
  const height = pickNumber(p, ['H','h','height','Height','H_m','height_m','DROP_M']);
  const coef = pickNumber(p, ['C','c','coef','Coef','runoff','runoff_coef']);

  const drains = pickNumber(p, ['drains','DrainCount','n_drains']);
  const drainCap = pickNumber(p, ['drainCap','DrainCap','drain_cap']);

  const strWidth = pickNumber(p, ['strWidth','b','width']);
  const strZ = pickNumber(p, ['strZ','z','side_slope']);
  const strDepth = pickNumber(p, ['strDepth','h_depth','depth']);

  const strLen = pickNumber(p, ['strLen','stream_len','channel_len']);
  const strDrop = pickNumber(p, ['strDrop','stream_drop','channel_drop']);
  const strType = pickNumber(p, ['strType','manning','n']);

  const out = {};
  if(area!=null) out.area = area;
  if(length!=null) out.length = length;
  if(height!=null) out.height = height;
  if(coef!=null) out.coef = coef;

  if(drains!=null) out.drains = drains;
  if(drainCap!=null) out.drainCap = drainCap;

  if(strWidth!=null) out.strWidth = strWidth;
  if(strZ!=null) out.strZ = strZ;
  if(strDepth!=null) out.strDepth = strDepth;

  if(strLen!=null) out.strLen = strLen;
  if(strDrop!=null) out.strDrop = strDrop;
  if(strType!=null) out.strType = strType;

  return out;
}

function pickNumber(obj, keys){
  for(const k of keys){
    if(obj && obj[k]!=null && String(obj[k]).trim()!==''){
      const n = parseFloat(String(obj[k]).replace(',','.'));
      if(isFiniteNumber(n)) return n;
    }
  }
  return null;
}

/* ===================== METEO: Stations list ===================== */

function normalizeStationUrl(u){
  u = (u || '').trim();
  if(!u) return '';
  // allow protocol-relative or missing scheme
  if(/^https?:\/\//i.test(u)) return u;
  if(/^\/\//.test(u)) return 'https:' + u;
  return 'https://' + u;
}

function parseStationsText(text, sourcePath){
  const entries = [];
  const lines = (text || '').split(/\r?\n/);
  for(const raw of lines){
    const line = (raw || '').trim();
    if(!line) continue;
    if(line.startsWith('#') || line.startsWith('//')) continue;

    let name = '';
    let url  = line;

    if(line.includes('|')){
      const parts = line.split('|');
      name = (parts.shift() || '').trim();
      url  = parts.join('|').trim();
    }else{
      name = url.replace(/^https?:\/\//i,'').slice(0, 60);
    }

    url = normalizeStationUrl(url);
    if(!url) continue;
    if(!name) name = url.replace(/^https?:\/\//i,'').slice(0, 60);

    entries.push({ name, url, from: sourcePath || '' });
  }
  return entries;
}

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
}

/* ===================== DATETIME: 24h formatting ===================== */
function pad2(n){ return String(n).padStart(2,'0'); }

function formatDateTime24(d){
  if(!(d instanceof Date) || isNaN(d.getTime())) return 'â€”';
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}, ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}

function parseAnyDateTime(ts, opts){
  if(ts == null) return null;
  if(ts instanceof Date) return ts;
  const assumeUTC = !!(opts && opts.assumeUTC);
  const s0 = String(ts).trim();
  if(!s0) return null;

  // Normalize ISO strings with space separator
  const s = s0.replace(/^(\d{4}-\d{2}-\d{2})\s+(\d{1,2}:\d{2})/, '$1T$2');

  // If ISO includes explicit timezone (Z or +/-hh:mm), let Date parse it.
  if(/^\d{4}-\d{2}-\d{2}T\d{1,2}:\d{2}/.test(s) && /(Z|[+-]\d{2}:?\d{2})$/i.test(s)){
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
  }

  // Greek / EU: dd/mm/yyyy, hh:mm(:ss) with optional Ï€.Î¼./Î¼.Î¼.
  if(s0.includes('/')){
    const m = s0.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:,)?\s*(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(Ï€\.Î¼\.|Î¼\.Î¼\.))?/i);
    if(m){
      const day = parseInt(m[1],10);
      const mon = parseInt(m[2],10) - 1;
      const year = parseInt(m[3],10);
      let hh = parseInt(m[4],10);
      const mi = parseInt(m[5],10);
      const ss = parseInt(m[6] || '0',10);
      const mer = (m[7] || '').toLowerCase();

      if(mer.includes('Î¼.Î¼') && hh < 12) hh += 12;
      if(mer.includes('Ï€.Î¼') && hh === 12) hh = 0;

      return new Date(year, mon, day, hh, mi, ss);
    }
  }

  // ISO-like without timezone: yyyy-mm-ddThh:mm(:ss)
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if(m2){
    const year = parseInt(m2[1],10);
    const mon = parseInt(m2[2],10) - 1;
    const day = parseInt(m2[3],10);
    const hh = parseInt(m2[4],10);
    const mi = parseInt(m2[5],10);
    const ss = parseInt(m2[6] || '0',10);
    return assumeUTC ? new Date(Date.UTC(year, mon, day, hh, mi, ss)) : new Date(year, mon, day, hh, mi, ss);
  }

  // Fallback: let Date try (RFC formats, etc.)
  const d = new Date(s0);
  if(!isNaN(d.getTime())) return d;

  return null;
}

function ts24(ts, opts){
  if(ts == null) return 'â€”';
  const d = parseAnyDateTime(ts, opts);
  return d ? formatDateTime24(d) : String(ts);
}

function nowTs24(){
  return formatDateTime24(new Date());
}



function fmtCoord(v, digits=4){
  if(v == null) return 'â€”';
  const n = Number(v);
  if(!isFinite(n)) return 'â€”';
  return n.toFixed(digits);
}
function fmtElev(v){
  if(v == null) return 'â€”';
  const n = Number(v);
  if(!isFinite(n)) return 'â€”';
  return `${Math.round(n)} m`;
}
function getStationMeta(url){
  if(!url) return null;
  if(url === OPEN_METEO_TOKEN){
    return { lat:38.0237, lon:23.8007, elev:null };
  }
  return STATIONS_META.get(url) || null;
}
function updatePrimaryMetaCoords(){
  const url = getPrimaryStationUrl();
  const meta = getStationMeta(url);
  setTxt('stationLat', (meta && meta.lat != null) ? fmtCoord(meta.lat, 4) : 'â€”');
  setTxt('stationLon', (meta && meta.lon != null) ? fmtCoord(meta.lon, 4) : 'â€”');
  setTxt('stationElev', (meta && meta.elev != null) ? fmtElev(meta.elev) : 'â€”');
}

function renderWatchlist(){
  const box = document.getElementById('watchlist');
  if(!box) return;
  box.innerHTML = '';
  if(!watchlist.size){
    box.innerHTML = '<span style="font-size:11px;color:#94a3b8;">(ÎºÎ±Î½Î­Î½Î±Ï‚ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿Ï‚)</span>';
    return;
  }
  for(const [url,name] of watchlist.entries()){
    const chip = document.createElement('span');
    chip.className = 'chip watch';
    chip.innerHTML = `<b>${escapeHtml(name)}</b><button title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·" aria-label="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·">âœ•</button>`;
    chip.querySelector('button').addEventListener('click', (e)=>{ 
      e.stopPropagation();
      watchlist.delete(url); 
      renderWatchlist(); 
      saveWatchlist();
      try{ refreshSelectedMeteoMarkers(); }catch(_){ }
      fetchStationData('extras');
    });
    chip.addEventListener('click', ()=>{
      const sel = document.getElementById('monitorStationSelect');
      if(!sel) return;
      const opt = Array.from(sel.options).find(o => o.value === url);
      if(opt){ sel.value = url; sel.dispatchEvent(new Event('change')); }
    });
    box.appendChild(chip);
  }
}

function setPrimaryStation(){
  const sel = document.getElementById('meteoStationSelect');
  if(!sel) return;

  const url = sel.value || '';
  if(!url){
    updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î•Ï€Î­Î»ÎµÎ¾Îµ ÎºÏÏÎ¹Î¿ ÏƒÏ„Î±Î¸Î¼ÏŒ.', 'warn');
    return;
  }

  // Apply as ACTIVE primary (only on â•)
  const name = (sel.options[sel.selectedIndex]?.textContent || url).trim();
  ACTIVE_PRIMARY_URL = url;
  ACTIVE_PRIMARY_NAME = name;


  // Update meta line coords
  updatePrimaryMetaCoords();
  // update selected stations markers (if layer is On or map preview is used)
  try{ refreshSelectedMeteoMarkers(); }catch(_){ }

  // Make sure histories do not mix across different primary stations
  switchSeriesContext(url === OPEN_METEO_TOKEN ? 'open-meteo' : `url:${url}`);

  // Immediate fetch for active primary + any extras
  updatePrimaryStatus('ÎšÏÏÎ¹Î¿Ï‚: Î›Î®ÏˆÎ·â€¦', 'neutral');
  fetchStationData('primary');
}

function clearPrimaryStation(){
  const ok = __confi
