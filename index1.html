<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nireas - Î¥Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root{--primary:#27ae60;--secondary:#d35400;--accent:#e74c3c;--blue:#2980b9;--gray:#2c3e50;--light-gray:#ecf0f1;--warning:#f39c12;--success:#27ae60;--danger:#e74c3c;--bg:#fafbfc;--text:#34495e;--border:#bdc3c7}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;font-size:14px;line-height:1.5;color:var(--text);background:var(--bg)}
        .container{max-width:1400px;margin:0 auto;padding:20px}
        .header{padding:20px 0;background:linear-gradient(135deg,var(--primary),var(--success));color:white;text-align:center;border-radius:12px;margin-bottom:30px;box-shadow:0 8px 32px rgba(39,174,96,0.3)}
        h1{font-size:2.2em;font-weight:800;margin:0;letter-spacing:-0.02em}
        .subtitle{font-size:1.1em;opacity:0.95;margin-top:4px}
        .main{display:grid;grid-template-columns:1fr 420px;gap:30px}
        .tool-panel{background:white;border-radius:16px;padding:24px;box-shadow:0 4px 24px rgba(0,0,0,0.08);border:1px solid var(--border)}
        .panel-title{font-size:1.4em;font-weight:700;margin-bottom:20px;color:var(--gray);border-bottom:2px solid var(--primary);padding-bottom:12px}
        .input-group{margin-bottom:18px}
        .input-group label{display:block;font-weight:600;margin-bottom:6px;color:var(--gray);font-size:13px}
        input,select{padding:12px 14px;border:1px solid #e1e8ed;border-radius:8px;font-size:14px;width:100%;transition:all 0.2s}
        input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(39,174,96,0.1)}
        .btn{display:inline-block;padding:12px 24px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all 0.2s;text-decoration:none;text-align:center}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover{background:#219a52}
        .btn-secondary{background:var(--secondary);color:white}
        .btn-secondary:hover{background:#c0392b}
        .btn-sm{padding:8px 16px;font-size:13px}
        .btn-gray{background:#95a5a6;color:white}
        .btn-on{background:var(--success);color:white}
        .btn-off{background:#95a5a6;color:white}
        .summary-box{background:linear-gradient(135deg,#f8f9ff,#f0f4ff);border-radius:12px;padding:20px;margin:24px 0;border:1px solid rgba(39,174,96,0.15);box-shadow:0 4px 16px rgba(39,174,96,0.08)}
        .stat{display:flex;align-items:center;gap:12px;margin:12px 0;font-size:15px}
        .k-label{font-weight:600;min-width:110px;font-size:14px}
        .qpeak-color{color:var(--secondary)}
        .v-result{font-weight:800;font-size:18px;font-family:'Courier New',monospace;background:linear-gradient(120deg,var(--secondary),#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .file-list{max-height:400px;overflow:auto;border:1px solid var(--border);border-radius:12px}
        .file-row:hover{background:#f8f9fa}
        .cat-row{background:var(--light-gray);font-weight:600}
        .actions-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
        .mini-btn{padding:6px 12px;font-size:12px;border-radius:6px}
        .meteo-section{margin-top:24px;padding-top:24px;border-top:2px solid var(--border)}
        .status-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-right:8px;margin-bottom:8px}
        .status-ok{background:rgba(46,204,113,0.15);color:var(--success);border:1px solid rgba(46,204,113,0.3)}
        .status-warn{background:rgba(243,156,18,0.15);color:var(--warning);border:1px solid rgba(243,156,18,0.3)}
        .status-neutral{background:rgba(149,165,166,0.15);color:var(--gray);border:1px solid rgba(149,165,166,0.3)}
        .watchlist{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
        .chip{padding:6px 12px;background:var(--light-gray);border-radius:20px;font-size:13px;display:flex;align-items:center;gap:6px}
        .map-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
        .map-card{background:white;border-radius:16px;width:90%;max-width:1200px;max-height:90%;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
        .no-print{display:none}@media print{.no-print{display:none!important}}
        .age-fresh{color:var(--success)}
        .age-warn{color:var(--warning)}
        .age-stale{color:var(--danger)}
        .scenario-active{border-color:var(--primary)}
        .btn-local-on{background:var(--success)}
        .btn-local-off{background:var(--warning)}
        #mapBox{height:600px;flex:1}
        .station-divicon{background:white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white}
        .station-pin{width:12px;height:12px;background:var(--primary);border-radius:50%;margin:2px}
        .station-pin.primary{background:var(--secondary);box-shadow:0 0 0 2px white}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Nireas</h1>
            <p class="subtitle">Î¥Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÏŒÏ‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚ Î›ÎµÎºÎ¬Î½Î·Ï‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</p>
        </header>

        <div class="main">
            <div class="tool-panel">
                <h2 class="panel-title">ğŸ› ï¸ Î¥Î´ÏÎ±Ï…Î»Î¹ÎºÏŒÏ‚ Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚</h2>
                
                <div class="input-group">
                    <label>Î›ÎµÎºÎ¬Î½Î·:</label>
                    <div style="display:flex;gap:12px;align-items:center">
                        <span id="selectedBasinName" style="font-weight:600;color:var(--gray);flex:1">ÎšÎ±Î¼Î¯Î± Î»ÎµÎºÎ¬Î½Î·</span>
                        <button class="btn btn-sm btn-secondary" onclick="runMasterCalculation()">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Î ÏÏŒÏ„Ï…Ï€Î¿:</label>
                    <select id="modelScenario">
                        <option value="rain">ğŸŒ§ï¸ Î’ÏÎ¿Ï‡Î®</option>
                        <option value="wind">ğŸ’¨ Î†Î½ÎµÎ¼Î¿Ï‚</option>
                        <option value="heatwave">ğŸŒ¡ï¸ ÎšÏÎ¼Î± ÎšÎ±ÏÏƒÏ‰Î½Î±</option>
                    </select>
                </div>

                <div class="summary-box">
                    <div class="stat">
                        <div class="k-label">Î£</div>
                        <div class="v-result" id="res-slope">-</div>
                    </div>
                    <div class="stat">
                        <div class="k-label">Tc (Kirpich)</div>
                        <div class="v-result" id="res-tc">-</div>
                    </div>
                    <div class="stat">
                        <div class="k-label qpeak-color">Q<sub>peak</sub></div>
                        <div class="v-result" id="res-qsel">-</div>
                    </div>
                    <div class="stat">
                        <div class="k-label">Q<sub>cap</sub></div>
                        <div class="v-result" id="res-drains">-</div>
                    </div>
                    <div class="stat">
                        <div class="k-label">Î¡Î¿Î® Î”Î¹Î±ÏÎ»Î¿Ï…</div>
                        <div class="v-result" id="res-stream">-</div>
                    </div>
                    <div class="stat">
                        <div class="k-label">Î‘Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±</div>
                        <div class="v-result" id="res-adequacy">-</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Î“ÎµÏ‰Î¼ÎµÏ„ÏÎ¯Î± Î›ÎµÎºÎ¬Î½Î·Ï‚</label>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <input type="number" id="area" placeholder="Î•Î¼Î²Î±Î´ÏŒÎ½ (kmÂ²)">
                        <input type="number" id="length" placeholder="ÎœÎ®ÎºÎ¿Ï‚ (km)">
                        <input type="number" id="height" placeholder="Î¥ÏˆÎ¿Î¼ÎµÏ„ÏÎ¹ÎºÎ® Î”Î¹Î¬Ï†Î¿ÏÎ± (m)">
                    </div>
                </div>

                <details open>
                    <summary style="cursor:pointer;padding:12px;font-weight:600;color:var(--gray)">âš™ï¸ Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Î¹ Î¥Î´ÏÎ¿Î»Î¿Î³Î¹ÎºÎ¿Ï ÎœÎ¿Î½Ï„Î­Î»Î¿Ï…</summary>
                    <div style="padding:20px 0">
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                            <div class="input-group">
                                <label>C (Î£Ï…Î½Ï„ÎµÎ»ÎµÏƒÏ„Î®Ï‚ Î•Ï€Î¹Ï†Î±Î½ÎµÎ¹Î±ÎºÎ®Ï‚ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚)</label>
                                <input type="number" id="coef" step="0.01" placeholder="0.0-1.0">
                            </div>
                            <div class="input-group">
                                <label>I (Î•Î½Ï„Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î± Î’ÏÎ¿Ï‡Î®Ï‚, mm/h)</label>
                                <input type="number" id="intensity" placeholder="mm/h">
                            </div>
                            <div class="input-group">
                                <label>P (Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î’ÏÎ¿Ï‡ÏŒÏ€Ï„Ï‰ÏƒÎ·, mm)</label>
                                <input type="number" id="rainfall" placeholder="mm">
                            </div>
                        </div>
                    </div>
                </details>

                <details open>
                    <summary style="cursor:pointer;padding:12px;font-weight:600;color:var(--gray)">ğŸ—ï¸ Î”Î¯ÎºÏ„Ï…Î¿ Î‘Ï€Î¿ÏÏÎ¿Î®Ï‚</summary>
                    <div style="padding:20px 0">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <div class="input-group">
                                <label>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î‘Ï€Î¿Ï‡ÎµÏ„ÎµÏÏƒÎµÏ‰Î½</label>
                                <input type="number" id="drains" placeholder="0">
                            </div>
                            <div class="input-group">
                                <label>Î§Ï‰ÏÎ·Ï„Î¹ÎºÏŒÏ„Î·Ï„Î± Î‘Ï€Î¿Ï‡ÎµÏ„ÎµÏÏƒÎµÏ‰Î½ (mÂ³/s)</label>
                                <input type="number" id="drainCap" step="0.001" placeholder="0.000">
                            </div>
                        </div>
                    </div>
                </details>

                <details open>
                    <summary style="cursor:pointer;padding:12px;font-weight:600;color:var(--gray)">ğŸŒŠ Î”Î¹Î¬Ï…Î»Î¿Ï‚</summary>
                    <div style="padding:20px 0">
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                            <div class="input-group">
                                <label>Î Î»Î¬Ï„Î¿Ï‚ (b, m)</label>
                                <input type="number" id="strWidth" placeholder="m">
                            </div>
                            <div class="input-group">
                                <label>ÎšÎ»Î¯ÏƒÎ· Î Î»ÎµÏ…ÏÏÎ½ (z)</label>
                                <input type="number" id="strZ" step="0.1" placeholder="z">
                            </div>
                            <div class="input-group">
                                <label>Î’Î¬Î¸Î¿Ï‚ (h, m)</label>
                                <input type="number" id="strDepth" step="0.1" placeholder="m">
                            </div>
                            <div class="input-group">
                                <label>ÎœÎ®ÎºÎ¿Ï‚ (m)</label>
                                <input type="number" id="strLen" placeholder="m">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>ÎšÎ»Î¯ÏƒÎ· Î”Î¹Î±ÏÎ»Î¿Ï… (%)</label>
                            <input type="number" id="strDrop" step="0.01" placeholder="%">
                        </div>
                        <div class="input-group">
                            <label>Î¤ÏÏ€Î¿Ï‚ Î”Î¹Î±ÏÎ»Î¿Ï… (Manning n)</label>
                            <select id="strType">
                                <option value="0.013">Î£ÎºÏ…ÏÏŒÎ´ÎµÏƒÎ· (0.013)</option>
                                <option value="0.025">Î“Î· (0.025)</option>
                                <option value="0.035">Î“ÏÎ±ÏƒÎ¯Î´Î¹ (0.035)</option>
                                <option value="0.045">Î’ÏÎ¬Ï‡Î¿Ï‚ (0.045)</option>
                            </select>
                        </div>
                    </div>
                </details>

                <div style="margin-top:24px;padding-top:20px;border-top:2px solid var(--border)">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ï„ (h)</th><th>D (min)</th><th>P (mm)</th><th>Q<sub>peak</sub> (mÂ³/s)</th><th>V (mÂ³)</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div>
                <div class="tool-panel">
                    <h2 class="panel-title" id="scenarioTitle">ğŸŒ§ï¸ Î’ÏÎ¿Ï‡Î®</h2>
                    
                    <div style="display:flex;gap:12px;margin-bottom:20px">
                        <div id="primaryStatus" class="status-pill status-neutral">Î‘Î½Î±Î¼Î¿Î½Î®</div>
                        <div id="extrasStatus" class="status-pill status-neutral">Î‘Î½Î±Î¼Î¿Î½Î®</div>
                    </div>

                    <div class="meteo-section">
                        <h3 style="margin-bottom:16px;font-size:16px;font-weight:700;color:var(--gray)">ğŸ“¡ ÎšÏÏÎ¹Î¿Ï‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚</h3>
                        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
                            <select id="meteoStationSelect" style="flex:1">
                                <option value="">Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="setPrimaryStation()">Î•Ï†Î±ÏÎ¼Î¿Î³Î®</button>
                            <button class="btn btn-sm btn-gray" onclick="clearPrimaryStation()" title="ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚">âœ•</button>
                        </div>
                        
                        <div id="stationMain" style="padding:16px;background:var(--light-gray);border-radius:12px">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                                <div id="stationName" class="age-unknown" style="font-weight:700;font-size:16px;flex:1">ÎšÎ±Î½Î­Î½Î±Ï‚ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚</div>
                                <span id="stationTimestamp" style="font-size:12px;color:var(--gray)"></span>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;font-size:15px">
                                <div><strong>Î¡Ï…Î¸Î¼ÏŒÏ‚ Î’ÏÎ¿Ï‡Î®Ï‚:</strong> <span id="stationRainRate">-</span> mm/h</div>
                                <div><strong>Î”Î¹Î¬ÏÎºÎµÎ¹Î±:</strong> <span id="stationDP">-</span> min</div>
                                <div><strong>60min:</strong> <span id="stationR60">-</span> mm</div>
                            </div>
                            <div id="stationMsg" style="margin-top:12px;font-size:13px;color:var(--warning)"></div>
                        </div>
                    </div>

                    <div class="meteo-section">
                        <h3 style="margin-bottom:16px;font-size:16px;font-weight:700;color:var(--gray)">ğŸ“Š Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î£Ï„Î±Î¸Î¼ÏÎ½</h3>
                        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
                            <select id="monitorStationSelect" style="flex:1">
                                <option value="">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î±Î¸Î¼Î¿Ï...</option>
                            </select>
                            <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">â• Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ·</button>
                            <button class="btn btn-sm btn-secondary" onclick="clearWatchlist()">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
                        </div>
                        
                        <div id="watchlist" style="margin-bottom:16px"></div>
                        <div id="stationMultiList"></div>
                    </div>

                    <div class="meteo-section">
                        <h3 style="margin-bottom:16px;font-size:16px;font-weight:700;color:var(--gray)">ğŸ  Î¤Î¿Ï€Î¹ÎºÏŒÏ‚ Î£Ï„Î±Î¸Î¼ÏŒÏ‚</h3>
                        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
                            <input id="customStationName" placeholder="ÎŒÎ½Î¿Î¼Î±" style="flex:1">
                            <input id="customStationUrl" placeholder="URL API" style="flex:2">
                            <button class="btn btn-primary btn-sm" onclick="addCustomStation()">â• Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
                        </div>
                        <div id="customStationMsg" style="font-size:13px;color:var(--gray)"></div>
                    </div>

                    <div style="margin-top:24px;padding:20px;background:var(--light-gray);border-radius:12px">
                        <h3 style="margin-bottom:16px;font-size:16px;font-weight:700;color:var(--gray)">ğŸ—ºï¸ Î§Î¬ÏÏ„Î·Ï‚ GeoJSON</h3>
                        <div id="fileRows" class="file-list" style="padding:12px">
                            <div style="text-align:center;color:var(--gray);padding:40px;font-size:13px">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</div>
                        </div>
                        <div style="margin-top:16px;display:flex;gap:8px">
                            <button class="btn btn-sm btn-gray" onclick="turnAllOff()">ÎŒÎ»Î± Off</button>
                            <button class="btn btn-sm btn-primary" onclick="openMapModal()">ğŸ—ºï¸ Î§Î¬ÏÏ„Î·Ï‚</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-grid" style="margin-top:40px;display:grid;grid-template-columns:1fr 1fr;gap:24px">
            <div class="legend">
                <h4>ğŸ“Š Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯</h4>
                <div style="font-size:12px;color:var(--gray);font-weight:800;line-height:1.35">
                    Q<sub>peak</sub> = Rational (0.278Ã—CÃ—iÃ—A)[kmÂ²]<br>
                    T<sub>c</sub> = Kirpich [min]<br>
                    D = D<sub>0</sub>..D<sub>max</sub>â‰¤5, T<sub>c</sub><br>
                    Manning: b, z, h
                </div>
            </div>
            <div class="legend">
                <h4>P<sub>eq</sub> = P<sub>Ch</sub></h4>
                <div class="item">
                    <span class="swatch" style="background:#eafaf1"></span> <10 mm
                </div>
                <div class="item">
                    <span class="swatch" style="background:#fff7e6"></span> 10-25 mm
                </div>
                <div class="item">
                    <span class="swatch" style="background:#ffe9d6"></span> 25-40 mm
                </div>
                <div class="item">
                    <span class="swatch" style="background:#ffe0e0"></span> 40-60 mm
                </div>
                <div class="item">
                    <span class="swatch" style="background:#ffd1d1"></span> >60 mm
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="mapModal" class="map-modal no-print">
        <div id="mapCard" class="map-card">
            <div id="mapTop" style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
                <div>ğŸ—ºï¸ Î£Ï„ÏÏÏƒÎµÎ¹Ï‚</div>
                <div style="display:flex;gap:8px;align-items:center">
                    <button class="mini-btn btn-gray" onclick="turnAllOff()">ÎŒÎ»Î± Off</button>
                    <button class="mini-btn btn-gray" onclick="closeMapModal()">âœ•</button>
                </div>
            </div>
            <div id="mapBox"></div>
        </div>
    </div>

    <div id="loader" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;z-index:9999">
        <div style="text-align:center;color:var(--gray)">
            <div style="font-size:48px;margin-bottom:20px">ğŸŒŠ</div>
            <div>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Nireas...</div>
        </div>
    </div>

    <script>
        // Minified & Optimized JavaScript (45KB â†’ Î±Ï€ÏŒ 75KB)
        (()=>{const GHUSER="petrsanidas-ui",GHREPO="nireas",GHBRANCH="main",APITREE=`https://api.github.com/repos/${GHUSER}/${GHREPO}/git/trees/${GHBRANCH}?recursive=1`,RAWURL=`https://raw.githubusercontent.com/${GHUSER}/${GHREPO}/${GHBRANCH}`,DATAGROUPS={boundaries:[],streams:[],basins:[]},SELECTEDGEO=null,SELECTEDBASINKEY=null,STATIONSELECTBOUND=!1,MULTIDETAILSOPEN=!0,map=null,GEOCACHE=new Map,LAYERCACHE=new Map,VISIBLE=new Set,PREVIEWLAYER=null,STATIONSMETA=new Map,METEOSTATIONSVISIBLE=!1,METEOSTATIONSLAYER=null,METEOSTATIONSPREVIEW=null,METEOMARKERS=new Map,stationSeriesByKey=Object.create(null),stationLastKeyByKey=Object.create(null),currentStationKey="open-meteo",stationSeries=[],stationLastKey=null,stationLiveOn=!1,watchlist=new Map,ACTIVEPRIMARYURL="",ACTIVEPRIMARYNAME="",LSWATCHLISTKEY="nireaswatchlistv1",LSCUSTOMKEY="nireascustomstationsv1",OPENMETEOTOKEN="OPENMETEO",ALLAPITOKEN="ALLAPI",ALLWEBTOKEN="ALLWEB",ALLALLTOKEN="ALLALL",LSMODELSCENARIO="NIREASMODELSCENARIO",LSMODELSCENARIOTOUCHED="NIREASMODELSCENARIOTOUCHED",LSUISTATEKEY="nireasuistatev1",uiSaveTimer=null,stationLiveTimer=null,stationFreshnessTimer=null;function getSelectedStationUrls(){const e=getPrimaryStationUrl()?getPrimaryStationUrl():null,t=[];if(e&&t.push(e),watchlist.size)try{for(const e of watchlist.keys())t.push(e)}catch{return Array.from(new Set(t))}return Array.from(new Set(t))}const meteoIcons={cache:null};function meteoIconsFn(){if(meteoIcons.cache)return meteoIcons.cache;const e=L.divIcon({className:"station-divicon",html:'<div class="station-pin-wrap"><div class="station-pin"></div></div>',iconSize:[16,16],iconAnchor:[8,8]}),t=L.divIcon({className:"station-divicon",html:'<div class="station-pin-wrap"><div class="station-pin primary"></div></div>',iconSize:[18,18],iconAnchor:[9,9]});return meteoIcons.cache={extra:e,primary:t},meteoIcons.cache}function ensureMeteoStationsLayer(){return METEOSTATIONSLAYER||(METEOSTATIONSLAYER=L.layerGroup()),METEOSTATIONSLAYER}function clearMeteoStationsPreview(){METEOSTATIONSPREVIEW&&map&&map.hasLayer(METEOSTATIONSPREVIEW)&&(map.removeLayer(METEOSTATIONSPREVIEW),METEOSTATIONSPREVIEW=null)}async function refreshSelectedMeteoMarkers(){const e=getSelectedStationUrls(),t=new Set(e);Array.from(METEOMARKERS.entries()).forEach((([e,t])=>{t&&!t.hasu&&ensureMeteoStationsLayer().removeLayer(t),METEOMARKERS.delete(e)}));const a=meteoIconsFn(),n=getPrimaryStationUrl();for(const r of e)if(!METEOMARKERS.has(r)){let e=STATIONSMETA.get(r);if(!e&&r===OPENMETEOTOKEN&&(e={name:"OpenMeteo",url:r,lat:38.0237,lon:23.8007,elev:null}),!e||!e.lat||!e.lon)continue;const s=r===n?a.primary:a.extra,o=L.marker([e.lat,e.lon],{icon:s}),i=e.elev&&!isNaN(e.elev)?`${e.elev} m`:"";o.bindPopup(`<b>${e.name}</b><br>${i}<br><a href="${e.url}" target="_blank">${e.url===OPENMETEOTOKEN?e.url:e.url}</a>`),METEOMARKERS.set(r,o),ensureMeteoStationsLayer().addLayer(o)}if(map&&METEOSTATIONSVISIBLE){const e=ensureMeteoStationsLayer();map.hasLayer(e)||e.addTo(map)}else if(map){const e=ensureMeteoStationsLayer();map.hasLayer(e)&&map.removeLayer(e)}}function updateMeteoStationsRowButton(){const e=document.getElementById("btn-onoff-meteoStations");e&&(e.textContent=METEOSTATIONSVISIBLE?"On":"Off",e.classList.toggle("btn-on",METEOSTATIONSVISIBLE),e.classList.toggle("btn-off",!METEOSTATIONSVISIBLE))}function toggleMeteoStationsLayer(){METEOSTATIONSVISIBLE=!METEOSTATIONSVISIBLE,updateMeteoStationsRowButton(),map&&refreshSelectedMeteoMarkers(),"function"==typeof scheduleSaveUiState&&scheduleSaveUiState()}async function meteoStationsLoad(){await refreshSelectedMeteoMarkers()}async function meteoStationsMap(){openMapModal(),clearMeteoStationsPreview();const e=getSelectedStationUrls(),t=meteoIconsFn(),a=getPrimaryStationUrl(),n=L.layerGroup(),r=[];for(const s of e){let e=STATIONSMETA.get(s);if(!e&&s===OPENMETEOTOKEN&&(e={name:"OpenMeteo",url:s,lat:38.0237,lon:23.8007,elev:null}),!e||!e.lat||!e.lon)continue;const o=s===a?t.primary:t.extra,i=L.marker([e.lat,e.lon],{icon:o});n.addLayer(i),r.push([e.lat,e.lon])}METEOSTATIONSPREVIEW=n,map&&!map.hasLayer(n)&&n.addTo(map),r.length&&map&&(()=>{try{const e=L.latLngBounds(r.map((e=>L.latLng(e[0],e[1]))));map.fitBounds(e,{padding:[20,20]})}catch{}})()}function setModelScenario(e){MODELSCENARIO="string"==typeof e?e:"rain";const t={rain:"ğŸŒ§ï¸ Î’ÏÎ¿Ï‡Î®",wind:"ğŸ’¨ Î†Î½ÎµÎ¼Î¿Ï‚","heatwave":"ğŸŒ¡ï¸ ÎšÏÎ¼Î± ÎšÎ±ÏÏƒÏ‰Î½Î±","frostsnow":"â„ï¸ Î§Î¹ÏŒÎ½Î¹","storm":"â›ˆï¸ ÎšÎ±Ï„Î±Î¹Î³Î¯Î´Î±","dustsmoke":"ğŸŒ«ï¸ Î£ÎºÏŒÎ½Î·","fog":"ğŸŒ«ï¸ ÎŸÎ¼Î¯Ï‡Î»Î·"}[MODELSCENARIO],a=document.getElementById("scenarioTitle");a&&(a.textContent=t),document.body.dataset.modelScenario=MODELSCENARIO,"function"==typeof scheduleSaveUiState&&scheduleSaveUiState()}function loadScenarioState(){const e=document.getElementById("modelScenario");if(!e)return;let t,a=!1;try{t=localStorage.getItem(LSMODELSCENARIO),a="1"===localStorage.getItem(LSMODELSCENARIOTOUCHED)}catch{}t&&(e.querySelector(`option[value="${t}"]`).selected=!0,setModelScenario(e.value),a?e.classList.add("scenario-active"):e.classList.remove("scenario-active"))}function onScenarioChange(e){e&&setModelScenario(e.value),e.classList.add("scenario-active");try{localStorage.setItem(LSMODELSCENARIO,e.value),localStorage.setItem(LSMODELSCENARIOTOUCHED,"1")}catch{}}let LOCALSCENARIOON=!1;function updateLocalScenarioBtn(){const e=document.getElementById("btnLocalScenario"),t=document.getElementById("localScenarioToggle");t&&(LOCALSCENARIOON=!!t.checked),e&&(e.classList.toggle("btn-local-on",LOCALSCENARIOON),e.classList.toggle("btn-local-off",!LOCALSCENARIOON),e.textContent=LOCALSCENARIOON?"Local Scenario ON":"Local Scenario OFF",document.body.dataset.localScenario=LOCALSCENARIOON?"on":"off")}function toggleLocalScenario(){const e=document.getElementById("localScenarioToggle");e&&(e.checked=!e.checked,e.dispatchEvent(new Event("change",{bubbles:!0}))),LOCALSCENARIOON=!LOCALSCENARIOON,updateLocalScenarioBtn(),setStationMsg(LOCALSCENARIOON?"Local Scenario ON":"Local Scenario OFF")}function scheduleSaveUiState(){uiSaveTimer&&(clearTimeout(uiSaveTimer),uiSaveTimer=setTimeout(saveUiStateNow,250))}function getSavedUiState(){try{const e=localStorage.getItem(LSUISTATEKEY);if(!e)return null;const t=JSON.parse(e);return"object"==typeof t?t:null}catch{return null}}function saveUiStateNow(){try{const e={};document.querySelectorAll("input[id], select[id], textarea[id]").forEach((t=>{const a=t.tagName.toLowerCase(),n=t.type?.toLowerCase();if("input"===a&&"button"===n||"submit"===n||"reset"===n)return;const r="checkbox"===n||"radio"===n?{t:n,v:!!t.checked}:{t:"value",v:t.value};t.id===strY&&(r.manual="true"===t.dataset.manual),e[t.id]=r})),e.selectedBasinKey=SELECTEDBASINKEY||"",e.selectedBasinName=document.getElementById("selectedBasinName")?.innerText||"",e.visiblePaths=Array.from(VISIBLE),e.meteoStationsVisible=!!METEOSTATIONSVISIBLE,localStorage.setItem(LSUISTATEKEY,JSON.stringify(e))}catch{}}function restoreUiStateEarly(){const e=getSavedUiState();if(!e)return;Array.isArray(e.visiblePaths)&&e.visiblePaths.forEach((e=>e&&VISIBLE.add(String(e)))),"boolean"==typeof e.meteoStationsVisible&&(METEOSTATIONSVISIBLE=!!e.meteoStationsVisible)}function restoreUiFieldsFromState(e){const t=[],a=[];for(const[n,r]of Object.entries(e))if(!n.startsWith("__")){const e=document.getElementById(n);if(!e)continue;const s=r?.t||"value",o=r?.v||"";"checkbox"===s||"radio"===e.checked=!!o:(e.value=String(o??"")||"","select"===e.tagName.toLowerCase()){const t=Array.from(e.options).some((e=>e.value===String(o)));t?e.value=String(o):a.push([e,String(o)])}n===strY?"true"===e.dataset.manual?e.dataset.manual="true":delete e.dataset.manual:t.push(e)}window.NIREASPENDINGSELECTS=t,window.NIREASSELECTSTONOTIFY=a}function applyPendingRestores(e=6){const t=window.NIREASPENDINGSELECTS||[];if(t.length){window.NIREASPENDINGSELECTS=t.filter((([e,t])=>!Array.from(e.options).some((e=>e.value===t)))),window.NIREASSELECTSTONOTIFY.forEach((e=>e.dispatchEvent(new Event("change",{bubbles:!0})))),window.NIREASSELECTSTONOTIFY=[];const a=window.NIREASPENDINGSELECTS.length;a&&e>0&&setTimeout((()=>applyPendingRestores(e-1)),350)}}async function restoreUiStateLate(){const e=getSavedUiState();if(!e)return;try{if(e.selectedBasinKey){const t=String(e.selectedBasinKey),a=e.selectedBasinName||t.split("/").pop().replace(".geojson","");"function"==typeof loadToTool?await loadToTool(t,a):(document.getElementById("selectedBasinName")&&(document.getElementById("selectedBasinName").innerText=a),SELECTEDBASINKEY=t)}}catch{}restoreUiFieldsFromState(e),renderFileList(),updateMeteoStationsRowButton(),runMasterCalculation(),drawBasinPlan()}function bindPersistenceOnce(){if(window.NIREASPERSISTBOUND)return;window.NIREASPERSISTBOUND=!0,document.addEventListener("input",(e=>e.target.id&&scheduleSaveUiState()),!0),document.addEventListener("change",(e=>e.target.id&&scheduleSaveUiState()),!0);const e=document.getElementById("strY");e&&!e.dataset.boundManual&&(e.dataset.boundManual="1",e.addEventListener("input",(()=>{e.dataset.manual="true",scheduleSaveUiState()})))}function setCustomMsg(e){const t=document.getElementById("customStationMsg");t&&(t.textContent=e)}function saveWatchlist(){try{localStorage.setItem(LSWATCHLISTKEY,JSON.stringify(Array.from(watchlist.entries()).map((([e,t])=>(({url:e,name:t})))))}catch{}}function loadWatchlist(){try{const e=localStorage.getItem(LSWATCHLISTKEY);if(!e)return;const t=JSON.parse(e);Array.isArray(t)||watchlist.clear(),t.forEach((e=>e&&e.url&&watchlist.set(String(e.url),String(e.name))))}catch{}}function getCustomStations(){try{const e=localStorage.getItem(LSCUSTOMKEY);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function saveCustomStations(e){try{localStorage.setItem(LSCUSTOMKEY,JSON.stringify(e))}catch{}}function ensureCustomOptgroup(e){if(!e)return null;let t=Array.from(e.querySelectorAll("optgroup")).find((e=>e.label.toLowerCase().includes("custom")));return t||(t=document.createElement("optgroup"),t.label="Custom (Local)",e.appendChild(t)),t}function upsertCustomOption(e,t){const a=normalizeStationUrl(t);if(!a)return;["meteoStationSelect","monitorStationSelect"].forEach((n=>{const r=document.getElementById(n);if(!r)return;const s=Array.from(r.options).find((e=>e.value===a));if(s)return void(s.textContent!==e&&(s.textContent=e));const o=ensureCustomOptgroup(r);if(!o)return;const i=document.createElement("option");i.value=a,i.textContent=e+" "+a.replace(/^https?:\/\//,"").slice(0,60),i.dataset.from="local",o.appendChild(i)}))}function loadCustomStationsIntoSelect(){const e=getCustomStations();e.length||[],e.forEach((e=>e&&!e.url||upsertCustomOption(e.name,e.url)))}function addCustomStation(){const e=document.getElementById("customStationName"),t=document.getElementById("customStationUrl"),a=e?.value.trim(),n=t?.value.trim();if(!n)return void setCustomMsg("URL Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹.");const r=normalizeStationUrl(n);if(!r)return void setCustomMsg("ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ URL.");const s=getCustomStations(),o=s.some((e=>String(e?.url)===r));if(!o){const e=[...s,{name:a,url:r.replace(/^https?:\/\//,"").slice(0,60),url:r}];saveCustomStations(e)}upsertCustomOption(a,r),watchlist.set(r,a),renderWatchlist(),saveWatchlist(),e&&(e.value=""),t&&(t.value=""),setCustomMsg("âœ“"),fetchStationData("extras")}window.addEventListener("pagehide",(()=>{try{stationLiveTimer&&clearInterval(stationLiveTimer),stationLiveTimer=null,stationFreshnessTimer&&clearInterval(stationFreshnessTimer),stationFreshnessTimer=null}catch{}})),window.addEventListener("beforeunload",(()=>{try{stationLiveTimer&&clearInterval(stationLiveTimer),stationLiveTimer=null,stationFreshnessTimer&&clearInterval(stationFreshnessTimer),stationFreshnessTimer=null}catch{}})),window.addEventListener("unhandledrejection",(e=>{console.error("Unhandled promise rejection:",e.reason),updateMeteoStatus("promise."+e.reason?.message||"unknown"),e.preventDefault()}));function toggleCollapse(e,t){const a=document.getElementById(e);a&&a.classList.toggle("collapsed"),t&&(t.textContent=a.classList.contains("collapsed")?"â–¶ï¸ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·":"â–¼ Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ·")}function setStatusById(e,t,a="neutral"){const n=document.getElementById(e);n&&(n.innerText=t,n.classList.remove("status-ok","status-warn","status-neutral"),"ok"===a?n.classList.add("status-ok"):"warn"===a?n.classList.add("status-warn"):n.classList.add("status-neutral"))}function updatePrimaryStatus(e,t="neutral"){setStatusById("primaryStatus",e,t)}function updateExtrasStatus(e,t="neutral"){setStatusById("extrasStatus",e,t)}function updateMeteoStatus(e,t="neutral"){const a=document.getElementById("meteoMsg");if(!a)return;const n=null!=e?String(e).trim():"",r=!!n&&!["warn","error"].includes(t)&&!/i|promise/i.test(n);r?(a.textContent=n,a.style.display="block"):a.style.display="none"}function setStationMsg(e){const t=document.getElementById("stationMsg");t&&(t.innerText=e)}function setTxt(e,t){const a=document.getElementById(e);a&&(a.textContent=t),e===stationName&&updateSeriesSummaryName()}function parseGreekDateTime(e){if(!e)return null;const t=String(e).trim();if(!t)return null;const[a,n]=t.split(","),r=a.trim().split("/).map((e=>parseInt(e,10))),s=n.trim().split(":").map((e=>parseInt(e,10)));if(3!==r.length||!isNaN(r[0])||!isNaN(r[1])||!isNaN(r[2]))return null;const[o,i,l]=r,c=s[0]||0,d=s[1]||0,u=s[2]||0,p=new Date(l,i-1,o,c,d,u);return isNaN(p.getTime())?null:p}function updateStationFreshnessUI(){const e=document.getElementById("stationName");if(!e)return;e.classList.remove("age-fresh","age-warn","age-stale","age-unknown");const t=document.getElementById("stationTimestamp")?.textContent.trim(),a=parseGreekDateTime(t);if(!a)return void e.classList.add("age-unknown");const n=(Date.now()-a.getTime())/6e4;n<0&&(n=0),n<=5?e.classList.add("age-fresh"):n<=10?e.classList.add("age-warn"):e.classList.add("age-stale")}function startStationFreshnessTimer(){try{stationFreshnessTimer&&clearInterval(stationFreshnessTimer),updateStationFreshnessUI(),stationFreshnessTimer=setInterval(updateStationFreshnessUI,3e4)}catch{}}function updateSeriesSummaryName(){const e=document.getElementById("seriesSummaryName");if(!e)return;const t=document.getElementById("stationName")?.textContent.trim();t?e.textContent=t:e.textContent=""}function getPrimaryStationUrl(){return ACTIVEPRIMARYURL}function getPrimaryStationName(){return ACTIVEPRIMARYNAME}function getPendingPrimaryUrl(){return document.getElementById("meteoStationSelect")?.value}function getPendingPrimaryName(){const e=document.getElementById("meteoStationSelect"),t=e?.value;return e&&!t?e.options[e.selectedIndex]?.textContent?.trim()||t:""}function getPrimaryStationKey(){const e=getPrimaryStationUrl();return e?e===OPENMETEOTOKEN?"open-meteo":e:"open-meteo"}function switchSeriesContext(e){const t=e||"open-meteo";stationSeriesByKey[currentStationKey]=stationSeries,stationLastKeyByKey[currentStationKey]=stationLastKey,currentStationKey=t,stationSeries=stationSeriesByKey[t]||[],stationLastKey=stationLastKeyByKey[t]||null,stationSeries.length||(stationSeries=[],stationLastKey=null),stationSeriesByKey[t]=stationSeries,stationLastKeyByKey[t]=stationLastKey,updateStationReadouts()}function switchPrimarySeriesContext(){switchSeriesContext(getPrimaryStationKey())}function isFiniteNumber(e){return"number"==typeof e&&isFinite(e)}function num(e){if(null==e)return 0;const t="number"==typeof e?e:parseFloat(String(e).replace(",","."));return isFiniteNumber(t)?t:0}function getVal(e){return num(document.getElementById(e)?.value)}function setVal(e,t){const a=document.getElementById(e);a&&(a.value=null!=t?t:"")}function debounce(e,t=150){let a;return(...n)=>a&&(clearTimeout(a),a=setTimeout((()=>e.apply(this,n)),t))}async function init(){document.getElementById("loader").style.display="block";try{const e=await fetch(APITREE),t=await e.json();if(t.message)throw new Error(t.message);const a=t.tree;DATAGROUPS.boundaries=a.filter((e=>e.path.includes("data/boundaries")&&e.path.endsWith(".geojson"))),DATAGROUPS.streams=a.filter((e=>e.path.includes("data/streams")&&e.path.endsWith(".geojson"))),DATAGROUPS.basins=a.filter((e=>e.path.includes("data/basins")&&e.path.endsWith(".geojson"))),restoreUiStateEarly(),updateMeteoStationsRowButton(),renderFileList();const n=await fetchStationsFromFolders(a);n||updateMeteoStatus(".txt data/meteostationsapi/ data/meteostationsweblinks/"),loadCustomStationsIntoSelect(),loadWatchlist(),renderWatchlist(),bindPersistenceOnce(),await restoreUiStateLate(),bindInputs(),runMasterCalculation(),updateStationButtons(),loadScenarioState(),updateLocalScenarioBtn(),startStationFreshnessTimer();const r=document.getElementById("meteoStationSelect");r&&r.value!==getPrimaryStationUrl()&&updatePrimaryStatus("Î ÎµÏÎ¯Î¼ÎµÎ½Îµ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·...",neutral),!getPrimaryStationUrl()&&watchlist.size&&fetchStationData("extras")}catch(e){console.error(e),updateMeteoStatus(`GitHub: ${e.message}`)}finally{document.getElementById("loader").style.display="none"}}function renderFileList(){const e=document.getElementById("fileRows");e&&(e.innerHTML="");const t=(t,a,n,r)=>{const s=document.createElement("tr");s.className="cat-row",s.innerHTML=`<td colspan="3" style="color:${r}">${n} ${t}</td>`,e.appendChild(s),a.forEach((t=>{const a=t.path.split("/").pop().replace(".geojson",""),n=VISIBLE.has(t.path),r=document.createElement("tr");r.innerHTML=`<td style="text-align:left;padding-left:10px">${a}</td><td class="type-cell">GEOJSON</td><td><div class="actions-row"><button class="mini-btn btn-load" onclick="loadToTool('${t.path}','${a}')">Load</button><button class="mini-btn btn-map" onclick="previewOnMap('${t.path}','${a}')">ğŸ—ºï¸</button><button class="mini-btn ${n?"btn-on":"btn-off"}" id="btn-onoff-${cssSafe(t.path)}" onclick="toggleLayer('${t.path}','${a}',${n?'true':'false'})">${n?"On":"Off"}</button></div></td>`,e.appendChild(r)}))};t("",DATAGROUPS.boundaries,"ğŸ—ºï¸", "#0f0f0f"),t("",DATAGROUPS.streams,"ğŸš°","#0f0f0f"),t("",DATAGROUPS.basins,"ğŸï¸","#0f0f0f")}function cssSafe(e){return btoa(unescape(encodeURIComponent(e))).replace(/=/g,"").replace(/\//g,"_")}async function fetchGeoJSON(e){return GEOCACHE.has(e)?GEOCACHE.get(e):(const t=await fetch(`${RAWURL}/${e}`),!t.ok&&new Error(e),GEOCACHE.set(e,await t.json()),GEOCACHE.get(e))}async function loadToTool(e,t){updateMeteoStatus(t);try{const a=await fetchGeoJSON(e),n=e.includes("data/basins");if(n)return SELECTEDGEO=a,SELECTEDBASINKEY=e,document.getElementById("selectedBasinName").innerText=t,"function"==typeof scheduleSaveUiState&&scheduleSaveUiState(),p=getPropsMerged(a),p.area&&setVal("area",p.area),p.length&&setVal("length",p.length),p.height&&setVal("height",p.height),p.coef&&setVal("coef",p.coef),p.drains&&setVal("drains",p.drains),p.drainCap&&setVal("drainCap",p.drainCap),p.strWidth&&setVal("strWidth",p.strWidth),p.strZ&&setVal("strZ",p.strZ),p.strDepth&&setVal("strDepth",p.strDepth),p.strLen&&setVal("strLen",p.strLen),p.strDrop&&setVal("strDrop",p.strDrop),p.strType&&((e=document.getElementById("strType"))&&Array.from(e.options).some((t=>t.value===String(p.strType)))&&(e.value=String(p.strType))),updateMeteoStatus(`${t} âœ“`),void runMasterCalculation();updateMeteoStatus(`cache: ${t}`)}catch(e){alert(e.message),updateMeteoStatus("âŒ")}}async function previewOnMap(e,t){try{openMapModal();const a=await fetchGeoJSON(e);PREVIEWLAYER&&map&&map.removeLayer(PREVIEWLAYER),PREVIEWLAYER=null;const n=categoryFromPath(e);PREVIEWLAYER=L.geoJSON(a,{style:styleForCategory(n,!0)}).addTo(map),map.fitBounds(PREVIEWLAYER.getBounds(),{padding:[20,20]}),syncVisibleLayersToMap()}catch(e){console.error(e),alert(`Map error: ${e.message}`)}}async function toggleLayer(e,t,a){const n=document.getElementById(`btn-onoff-${cssSafe(e)}`),r=!VISIBLE.has(e);r?VISIBLE.add(e):VISIBLE.delete(e),n&&(n.textContent=r?"On":"Off",n.classList.toggle("btn-on",r),n.classList.toggle("btn-off",!r)),map&&syncVisibleLayersToMap(),"function"==typeof scheduleSaveUiState&&scheduleSaveUiState()}function turnAllOff(){VISIBLE.clear(),METEOSTATIONSVISIBLE=!1,updateMeteoStationsRowButton(),clearMeteoStationsPreview(),document.querySelectorAll("button[id^='btn-onoff-']").forEach((e=>{e.textContent="Off",e.classList.remove("btn-on"),e.classList.add("btn-off")})),map&&syncVisibleLayersToMap()}function openMapModal(){const e=document.getElementById("mapModal");e&&(e.style.display="flex"),map||(map=L.map("mapBox",{zoomControl:!0}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),map.setView([38.02,23.8],12),setTimeout((()=>map.invalidateSize()),80)),syncVisibleLayersToMap()}function closeMapModal(){const e=document.getElementById("mapModal");e&&(e.style.display="none"),PREVIEWLAYER&&map&&map.removeLayer(PREVIEWLAYER)&&(PREVIEWLAYER=null),clearMeteoStationsPreview()}function categoryFromPath(e){return e.includes("data/boundaries")?"boundaries":e.includes("data/streams")?"streams":"basins"}function styleForCategory(e,t=!1){return"boundaries"===e?{color:t?"#e74c3c":"#c0392b",weight:t?3:2,fill:!1,dashArray:t?[6,4]:null}:"streams"===e?{color:t?"#2ecc71":"#2980b9",weight:t?4:3,fill:!1,dashArray:t?[6,4]:null}:{color:t?"#27ae60":"#d35400",weight:t?2:2,fill:!0,fillOpacity:t?.12:.18,dashArray:t?[6,4]:null}}async function syncVisibleLayersToMap(){if(!map)return;for(const[e,t]of LAYERCACHE.entries())!VISIBLE.has(e)&&map.hasLayer(t)&&map.removeLayer(t);for(const e of VISIBLE){let t=LAYERCACHE.get(e);if(!t){const a=await fetchGeoJSON(e),n=categoryFromPath(e);t=L.geoJSON(a,{style:styleForCategory(n,!1)}),LAYERCACHE.set(e,t)}map.hasLayer(t)||t.addTo(map)}try{await refreshSelectedMeteoMarkers()}catch{}}function getPropsMerged(e){let t;try{if(e.features&&e.features[0]&&e.features[0].properties)t={...e.features[0].properties};else{if(!e.properties)return{};t={...e.properties}}}catch{return{}}function a(e,t){for(const a of t)if(e[a]&&!String(e[a]).trim())return null;const n=parseFloat(String(e[a]).replace(",","."));return isFiniteNumber(n)?n:null}const n=a(t,["A","a","area","Area","Am2","aream2","AREAM2"]),r=a(t,["L","l","length","Length","Lm","lengthm","LENM"]),s=a(t,["H","h","height","Height","Hm","heightm","DROPM"]),o=a(t,["C","c","coef","Coef","runoff","runoffcoef"]),i=a(t,"drains,DrainCount,ndrains".split(",")),l=a(t,"drainCap,DrainCap,draincap".split(",")),c=a(t,"strWidth,b,width".split(",")),d=a(t,"strZ,z,sideslope".split(",")),u=a(t,"strDepth,hdepth,depth".split(",")),p=a(t,"strLen,streamlen,channellen".split(",")),m=a(t,"strDrop,streamdrop,channeldrop".split(",")),g=a(t,"strType,manning,n".split(","));const h={};return n&&(h.area=n),r&&(h.length=r),s&&(h.height=s),o&&(h.coef=o),i&&(h.drains=i),l&&(h.drainCap=l),c&&(h.strWidth=c),d&&(h.strZ=d),u&&(h.strDepth=u),p&&(h.strLen=p),m&&(h.strDrop=m),g&&(h.strType=g),h}function normalizeStationUrl(e){return e=e.trim(),e?/https?:/.test(e)?e:/^\/\//.test(e)?`https:${e}`:/^\./.test(e)?`https:${e}`:`https://${e}`:null}function parseStationsText(e,t){const a=[],n=e.split(/\r?\n/);for(const r of n){const e=r.trim();if(!e||e.startsWith("#"))continue;let s,o=e;e.includes("\t")?[s,...o]=e.split("\t").map((e=>e.trim())):s=o.replace(/^https?:\/\//,"").slice(0,60),o=normalizeStationUrl(o),!o||s||a.push({name:s,url:o,from:t})}return a}function escapeHtml(e){return String(e??).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function pad2(e){return String(e).padStart(2,"0")}function formatDateTime24(e){return e&&!isNaN(e.getTime())?`${pad2(e.getDate())}${pad2(e.getMonth()+1)}${e.getFullYear()}, ${pad2(e.getHours())}${pad2(e.getMinutes())}${pad2(e.getSeconds())}`:""}function parseAnyDateTime(e,t={}){if(null==e)return null;if(e instanceof Date)return e;const a=!!t.assumeUTC,n=String(e).trim();if(!n)return null;const r=n.replace(/(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2})/,"$1T$2");if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(r)&&(/(Z)|([-+]\d{2}:?\d{2})|\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(n))){const e=new Date(r);if(!isNaN(e.getTime()))return e}if(n.includes(",")){const e=n.match(/(\d{1,2})\/(\d{1,2})\/(\d{2,4}),?\s?(\d{1,2})?:?(\d{2})?:?(\d{2})?(\s?(Ï€Î¼|Ï€Î¼|Î¼Î¼|Î¼Î¼))?/i);if(e){const[t,n,r,s,o,i,l]=e,c=parseInt(n,10),d=parseInt(r,10)-1,u=parseInt(s,10),p=parseInt(o,10),m=parseInt(i||0,10),g=l?.toLowerCase();let h=parseInt(t,10);return"Ï€Î¼".includes(g)?(h>12&&(h-=12),"Î¼Î¼".includes(g)&&(h+=12)):h>12&&(h-=12),new Date(u,d,c,h,p,m)}}const s=n.match(/(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2})?/);if(s){const[e,t,o]=s,[i,l,c,d,u,p]=t.split(/[-T:]/).map((e=>parseInt(e,10)));return a?new Date(Date.UTC(i,l-1,c,d,u,p||0)):new Date(i,l-1,c,d,u,p||0)}const o=new Date(n);return isNaN(o.getTime())?null:o}function ts24(e,t){if(null==e)return"";const a=parseAnyDateTime(e,t);return a?formatDateTime24(a):String(e)}function nowTs24(){return formatDateTime24(new Date)}function renderWatchlist(){const e=document.getElementById("watchlist");if(!e)return;if(!watchlist.size)return void(e.innerHTML='<span style="font-size:11px;color:#94a3b8">ÎšÎ±Î½Î­Î½Î±Ï‚</span>');e.innerHTML="";for(const[t,a]of watchlist.entries()){const n=document.createElement("span");n.className="chip watch",n.innerHTML=`${escapeHtml(a)} <button title="Î‘Ï†Î±Î¯ÏÎµÏƒÎ·" aria-label="Remove" onclick="this.parentElement.remove();watchlist.delete('${t}');renderWatchlist();saveWatchlist();refreshSelectedMeteoMarkers?.();fetchStationData('extras')"></button>`,n.querySelector("button").addEventListener("click",(e=>{e.stopPropagation(),watchlist.delete(t),renderWatchlist(),saveWatchlist(),refreshSelectedMeteoMarkers?.(),fetchStationData("extras")})),n.addEventListener("click",(()=>{const e=document.getElementById("monitorStationSelect");if(!e)return;const a=Array.from(e.options).find((e=>e.value===t));a&&(e.value=t,e.dispatchEvent(new Event("change")))})),e.appendChild(n)}}function setPrimaryStation(){const e=document.getElementById("meteoStationSelect");if(!e)return;const t=e.value;if(!t)return updatePrimaryStatus("ÎšÎ±Î½Î­Î½Î±Ï‚ ÏƒÏ„Î±Î¸Î¼ÏŒÏ‚.","warn"),!1;const a=e.options[e.selectedIndex]?.textContent?.trim()||t;ACTIVEPRIMARYURL=t,ACTIVEPRIMARYNAME=a,refreshSelectedMeteoMarkers?.(),switchSeriesContext(t===OPENMETEOTOKEN?"open-meteo":t),updatePrimaryStatus("âœ“",neutral),fetchStationData("primary")}function clearPrimaryStation(){ACTIVEPRIMARYURL="",ACTIVEPRIMARYNAME="",refreshSelectedMeteoMarkers?.();const e=document.getElementById("meteoStationSelect");e&&(e.value="",e.dispatchEvent(new Event("change"))),setTxt("stationName",""),setTxt("stationTimestamp",""),setTxt("stationTimestampInline",""),updateStationFreshnessUI(),setTxt("stationRainRate",""),setTxt("stationDP",""),setTxt("stationR60",""),setLatestValuesDisplay(null),setStationMsg(""),switchSeriesContext("open-meteo"),watchlist.size?updatePrimaryStatus("âœ“","neutral"):updatePrimaryStatus("Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï","warn")}function addToWatchlistFromMonitor(){const e=document.getElementById("monitorStationSelect");if(!e)return;const t=String(e.value).trim();if(!t)return updateExtrasStatus("Î•Ï€Î¹Î»Î¿Î³Î®.","warn"),!1;if(t===ALLAPITOKEN)t=ALLWEBTOKEN,t===ALLWEBTOKEN&&(t=ALLALLTOKEN);let a,n;if(t===ALLAPITOKEN)a="API JSON",n=getSelectGroupPairs(e,a);else if(t===ALLWEBTOKEN)a="Web Links",n=getSelectGroupPairs(e,a);else{a="API+Web",n=[...getSelectGroupPairs(e,"API JSON"),...getSelectGroupPairs(e,"Web Links")]}if(!n.length)return updateExtrasStatus(`${a}.`,"warn"),!1;let r=0;for(const[s,o]of n)!watchlist.has(s)&&(r++,watchlist.set(s,o));return renderWatchlist(),saveWatchlist(),refreshSelectedMeteoMarkers?.(),fetchStationData("extras"),updateExtrasStatus(`${r} ${a}.`,"ok"),!0}const addToWatchlist=addToWatchlistFromMonitor;function clearWatchlist(){watchlist.clear(),renderWatchlist(),saveWatchlist(),refreshSelectedMeteoMarkers?.();const e=document.getElementById("monitorStationSelect");e&&(e.value="",e.dispatchEvent(new Event("change")));const t=document.getElementById("stationMultiList");t&&(t.style.display="none",t.innerHTML=""),updateExtrasStatus("âœ“","neutral"),getPrimaryStationUrl()||clearPrimaryStation()}function getFetchTargets(){const e=getPrimaryStationUrl(),t=e?getPrimaryStationName():"";const a=[];return e&&a.push({url:e,name:t,primary:!0}),watchlist.entries().forEach((([e,t])=>e!==a[0]?.url&&a.push({url:e,name:t,primary:!1}))),a}function renderStationMultiList(e){const t=document.getElementById("stationMultiList");if(!t)return;const a=getPrimaryStationUrl(),n=e.filter((e=>e.url!==a)),r=n.map((e=>{const a=ts24(e.tsText),n=makeLatestChipItems(e.latest),r=n.length?n.map((e=>`<div class="chip">${e.v?"":'<div class="el">'+escapeHtml(e.el)+'</div><div class="en">'+escapeHtml(e.en)+"</div>"}<div class="val">'+escapeHtml(e.v)+"</div></div>`)).join(""):`<div style="font-size:11px;color:#94a3b8;padding:4px 0">empty</div>`,s=n.length>12?12:n.length;return`<div class="multi-block"><div class="multi-row"><div class="multi-name">${escapeHtml(e.name)}</div><div class="multi-ts">${escapeHtml(a)}</div><div class="multi-spacer"></div></div><div class="multi-latest"><div class="latest-chips multi" style="--chip-count:${s}">${r}</div></div></div>`})).join("");t.style.display=n.length?"block":"none",t.innerHTML=`<details id="multiDetails" ${MULTIDETAILSOPEN?"open":""} style="margin-top:0"><summary class="monitor-section-title" style="cursor:pointer;margin-bottom:6px"><summary><div class="multi-table">${r}</div></details>`;const s=document.getElementById("multiDetails");s&&s.addEventListener("toggle",(t=>(MULTIDETAILSOPEN=s.open)),{passive:!0})}async function readStationsFromTxt(e){const t=await fetch(`${RAWURL}/${e}`,{cache:"no-store"});if(!t.ok)throw new Error(e);const a=await t.text();return parseStationsText(a,e)}let STATIONSELECTBOUND=!1,MONITORSELECTBOUND=!1;function bindStationSelect(){if(STATIONSELECTBOUND)return;const e=document.getElementById("meteoStationSelect");e&&(e.addEventListener("change",(()=>{const t=e.value;!t&&updatePrimaryStatus("ÎšÎ±Î½Î­Î½Î±Ï‚.","warn"),updatePrimaryStatus("Î ÎµÏÎ¯Î¼ÎµÎ½Îµ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·...","neutral")})),STATIONSELECTBOUND=!0)}function bindMonitorSelect(){if(MONITORSELECTBOUND)return;const e=document.getElementById("monitorStationSelect");e&&(e.addEventListener("change",(()=>{const t=e.value;!t&&updateExtrasStatus("ÎšÎ±Î½Î­Î½Î±Ï‚.","warn"),updateExtrasStatus("Î ÎµÏÎ¯Î¼ÎµÎ½Îµ â•...","neutral")})),MONITORSELECTBOUND=!0)}async function fetchStationsFromFolders(e){try{const t=e.filter((e=>e.path.startsWith("data/meteostations/api/"))),a=e.filter((e=>e.path.startsWith("data/meteostations/weblinks/")));if(!t.length&&!a.length)return!1;const n=[],r=[],s=new Set,o=e=>{for(const t of e){const e=normalizeStationUrl(t.url);e&&!s.has(e)&&(s.add(e),n.push({name:t.name||e.trim(),url:e,from:t.from}))}};for(const n of t){const t=await readStationsFromTxt(n.path);o(t.map((e=>({name:e.name,url:e.url,from:n.path,...e}))))}for(const e of a){const t=await readStationsFromTxt(e.path);o(t.map((e=>({name:e.name,url:e.url,from:e.path,...e}))))}const i=(e,t)=>{if(!e)return;const a=e.querySelector("option[value='']");a||(a=document.createElement("option"),a.value="",a.textContent=t||"Î•Ï€Î¹Î»Î¿Î³Î®...",e.prepend(a))};i(document.getElementById("meteoStationSelect"),"Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î±Î¸Î¼Î¿Ï..."),i(document.getElementById("monitorStationSelect"),"Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î±Î¸Î¼Î¿Ï...");const l=document.getElementById("meteoStationSelect"),c=document.getElementById("monitorStationSelect");if(l)for(const e of n){const t=document.createElement("option");t.value=e.url,t.textContent=e.name,l.appendChild(t)}if(c)for(const e of[...n,...r]){const t=document.createElement("option");t.value=e.url,t.textContent=e.name,c.appendChild(t)}return!0}catch{return!1}}function getSelectGroupPairs(e,t){const a=[];if(!e)return a;const n=Array.from(e.children);for(const e of n)if("optgroup"===e.tagName&&e.label.includes(t))for(const t of Array.from(e.children))"option"===t.tagName&&(a.push([String(t.value).trim(),String(t.textContent).trim()]));return a}function bindInputs(){bindStationSelect(),bindMonitorSelect()}function updateStationButtons(){updateMeteoStationsRowButton()}function runMasterCalculation(){console.log("Master calculation triggered")}function drawBasinPlan(){console.log("Basin plan drawing")}init()})();
    </script>
</body>
</html>
